{
  "repoUrl": "https://github.com/manifoldmarkets/manifold",
  "generationDate": "2025-12-09T20:59:57.302Z",
  "initCommand": "yarn install && git checkout -- yarn.lock",
  "finalCheckCommands": [
    "yarn --cwd common tsc --noEmit",
    "yarn --cwd backend/api compile",
    "yarn --cwd backend/scheduler compile",
    "yarn --cwd backend/shared build",
    "yarn --cwd web tsc --noEmit"
  ],
  "evalCommits": [
    {
      "id": "prefill-limit-order",
      "sha": "4d6385d675d9aa50da18b7a22213023b9e33e8f7",
      "parentSha": "012e7d6b6def0590d095dee541d21c099e197990",
      "spec": "Implement clickable order-book rows that prefill the limit order form in the bet panel.\n\nScope and behavior\n- When a user clicks a collapsed order row in the order book, the bet panel should switch to the Limit tab, preselect the opposite outcome, prefill the limit price, prefill the order amount sized to acquire the same number of shares as the clicked order at that price, and set expiration to immediate. Show a user-facing toast indicating the immediate expiration.\n- Prefill should apply only once per click to avoid overwriting subsequent manual edits. Re-clicking the same row should trigger another prefill, even if the values are identical.\n- Provide a subtle hover style and pointer cursor to indicate clickability on the amount cell for collapsed rows.\n\nFiles to modify\n1) web/components/bet/order-book.tsx\n- Export a type OrderClickData: { outcome: 'YES' | 'NO'; limitProb: number; amount: number } representing the clicked aggregate order row (amount is the unfilled total in token units; limitProb is a 0–1 probability).\n- Export a helper function calculateOrderFillParams(data: OrderClickData) that returns { outcome: 'YES' | 'NO'; limitProb: number; amount: number } with:\n  - outcome = opposite side of data.outcome\n  - limitProb unchanged\n  - amount computed to match equivalent shares on the opposite side: shares = amount / limitProb for YES or amount / (1 - limitProb) for NO; then compute fill amount for the opposite side with the same shares. Round to two decimal places.\n- Add an optional onOrderClick prop to OrderBookPanel and CollatedOrderTable and pass it through into CollapsedOrderRow.\n- In CollapsedOrderRow, on the right-hand total amount cell, if onOrderClick is provided, add hover/pointer styling and call onOrderClick({ outcome, limitProb, amount: total }) when clicked.\n\n2) web/components/bet/bet-panel.tsx (BuyPanelBody)\n- Add state prefillLimitOrder: { outcome: 'YES' | 'NO'; limitProb: number; amount: number; timestamp: number } | null to track the most recent click-driven prefill.\n- Implement handleOrderClick using useEvent:\n  - Compute fill params via calculateOrderFillParams(clickedOrder)\n  - setPrefillLimitOrder({ ...fillParams, timestamp: Date.now() })\n  - setOutcome(fillParams.outcome)\n  - set betTypeSetting to 'Limit'\n  - Show a toast to inform the user that expiration is set to immediate (e.g., with a stopwatch icon).\n- Pass handleOrderClick to OrderBookPanel via an onOrderClick prop so clicks in the order book trigger the prefill.\n- When rendering LimitOrderPanel, pass:\n  - betAmount = prefillLimitOrder?.amount if present, otherwise the existing betAmount\n  - initialProb = prefillLimitOrder?.limitProb\n  - expiration = 1 when prefillLimitOrder is set, otherwise undefined\n  - prefillTimestamp = prefillLimitOrder?.timestamp\n\n3) web/components/bet/limit-order-panel.tsx\n- Extend props with optional initialProb?: number, expiration?: number, prefillTimestamp?: number.\n- When expiration is provided, set selectedExpiration to that value; include prefillTimestamp as a dependency so repeated clicks reset even if expiration value is unchanged.\n- Maintain a ref lastAppliedPrefillTimestamp to detect when a new prefill arrives. When prefillTimestamp changes and both betAmount and initialProb are defined, set internal betAmount and limitProbInt accordingly and update lastAppliedPrefillTimestamp. Avoid re-applying if the timestamp hasn’t changed.\n- After a limit order is placed, if the selected expiration corresponds to immediate (i.e., computed expiresMillisAfter === 1), show a success toast indicating the order will expire immediately after placement.\n\nFunctional acceptance criteria\n- Clicking a collapsed order row’s amount in the order book pre-populates the limit order form with:\n  - Opposite outcome selected in the buy panel\n  - Limit price set to the clicked row’s price\n  - Order amount sized to acquire the same shares on the opposite side at that price\n  - Expiration set to immediate, confirmed by toast\n- The limit tab is activated automatically when the prefill is triggered.\n- Re-clicking any order-book row repeats the prefill and resets amount/price/expiration, even if values are the same as before.\n- Manual edits after prefill are preserved unless the user clicks another order-book row (a new prefill event).\n- Visual feedback (hover highlight and cursor pointer) appears on clickable rows in the order book.",
      "prompt": "Add a UX shortcut so that clicking an order in the order book pre-fills the limit order form in the bet panel. When a user clicks a row of orders at a given price, the limit order tab should activate, the opposite side should be selected, the price should be set to that row’s price, the size should be computed to acquire an equivalent number of shares on the opposite side, and the expiration should default to an immediate timeout. Show a small toast confirming the immediate expiration. Make the order-book rows look clickable and wire the click through to the limit order form, ensuring repeated clicks re-apply the prefill without clobbering manual edits. Keep the behavior consistent across single and multi-answer markets.",
      "supplementalFiles": [
        "web/components/bet/yes-no-selector.tsx",
        "web/components/bet/money-display.tsx",
        "web/components/widgets/amount-input.tsx",
        "web/components/widgets/slider.tsx",
        "web/hooks/use-is-advanced-trader.ts",
        "web/hooks/use-is-page-visible.ts",
        "web/lib/api/api.ts",
        "web/lib/firebase/users.ts",
        "common/src/bet.ts",
        "common/src/new-bet.ts",
        "common/src/calculate-cpmm.ts",
        "common/src/contract.ts",
        "common/src/util/format.ts"
      ],
      "fileDiffs": [
        {
          "path": "web/components/bet/bet-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/bet-panel.tsx\n===================================================================\n--- web/components/bet/bet-panel.tsx\t012e7d6 (parent)\n+++ web/components/bet/bet-panel.tsx\t4d6385d (commit)\n@@ -5,78 +5,82 @@\n   XIcon,\n } from '@heroicons/react/outline'\n import clsx from 'clsx'\n import { capitalize, uniq } from 'lodash'\n-import { useEffect, useState, useRef } from 'react'\n+import { useEffect, useRef, useState } from 'react'\n import toast from 'react-hot-toast'\n \n import {\n+  useContractBets,\n+  useUnfilledBetsAndBalanceByUserId,\n+} from 'client-common/hooks/use-bets'\n+import { useEvent } from 'client-common/hooks/use-event'\n+import { getLimitBetReturns, MultiBetProps } from 'client-common/lib/bet'\n+import { APIParams } from 'common/api/schema'\n+import { Bet, LimitBet } from 'common/bet'\n+import { calculateCpmmAmountToBuyShares } from 'common/calculate-cpmm'\n+import {\n   isBinaryMulti,\n   MarketContract,\n   MAX_CPMM_PROB,\n   MAX_STONK_PROB,\n   MIN_CPMM_PROB,\n   MIN_STONK_PROB,\n   MultiContract,\n } from 'common/contract'\n-import {\n-  formatLargeNumber,\n-  formatMoney,\n-  formatOutcomeLabel,\n-  formatPercent,\n-  formatWithToken,\n-} from 'common/util/format'\n-import { api, APIError } from 'web/lib/api/api'\n-import { firebaseLogin } from 'web/lib/firebase/users'\n-import { Col } from '../layout/col'\n-import { Row } from '../layout/row'\n-import { AmountInput, BuyAmountInput } from '../widgets/amount-input'\n-import { LimitBet } from 'common/bet'\n import { TRADE_TERM } from 'common/envs/constants'\n import {\n   getVerificationStatus,\n   PROMPT_USER_VERIFICATION_MESSAGES,\n } from 'common/gidx/user'\n+import { CandidateBet } from 'common/new-bet'\n import { getFormattedMappedValue } from 'common/pseudo-numeric'\n import { getStonkDisplayShares, STONK_NO, STONK_YES } from 'common/stonk'\n import {\n   getTierIndexFromLiquidity,\n   getTierIndexFromLiquidityAndAnswers,\n } from 'common/tier'\n+import {\n+  formatLargeNumber,\n+  formatMoney,\n+  formatOutcomeLabel,\n+  formatPercent,\n+  formatWithToken,\n+} from 'common/util/format'\n import { floatingEqual } from 'common/util/math'\n import { removeUndefinedProps } from 'common/util/object'\n+import { LuShare } from 'react-icons/lu'\n import { InfoTooltip } from 'web/components/widgets/info-tooltip'\n import { useFocus } from 'web/hooks/use-focus'\n import { useIsAdvancedTrader } from 'web/hooks/use-is-advanced-trader'\n+import { useIsMobile } from 'web/hooks/use-is-mobile'\n+import { useIsPageVisible } from 'web/hooks/use-page-visible'\n+import { usePersistentLocalState } from 'web/hooks/use-persistent-local-state'\n import { usePrivateUser, useUser } from 'web/hooks/use-user'\n+import { api, APIError } from 'web/lib/api/api'\n+import { firebaseLogin } from 'web/lib/firebase/users'\n import { track, withTracking } from 'web/lib/service/analytics'\n import { isAndroid, isIOS } from 'web/lib/util/device'\n+import { Button } from '../buttons/button'\n import { WarningConfirmationButton } from '../buttons/warning-confirmation-button'\n import { getAnswerColor } from '../charts/contract/choice'\n import { LocationMonitor } from '../gidx/location-monitor'\n+import { Col } from '../layout/col'\n+import { Row } from '../layout/row'\n+import { AmountInput, BuyAmountInput } from '../widgets/amount-input'\n import { ChoicesToggleGroup } from '../widgets/choices-toggle-group'\n+import { sliderColors } from '../widgets/slider'\n+import { Tooltip } from '../widgets/tooltip'\n import LimitOrderPanel from './limit-order-panel'\n import { MoneyDisplay } from './money-display'\n-import { OrderBookPanel, YourOrders } from './order-book'\n-import { YesNoSelector } from './yes-no-selector'\n-import { sliderColors } from '../widgets/slider'\n import {\n-  useContractBets,\n-  useUnfilledBetsAndBalanceByUserId,\n-} from 'client-common/hooks/use-bets'\n-import { useIsPageVisible } from 'web/hooks/use-page-visible'\n-import { CandidateBet } from 'common/new-bet'\n-import { APIParams } from 'common/api/schema'\n-import { Button } from '../buttons/button'\n-import { usePersistentLocalState } from 'web/hooks/use-persistent-local-state'\n-import { getLimitBetReturns, MultiBetProps } from 'client-common/lib/bet'\n-import { Tooltip } from '../widgets/tooltip'\n-import { useIsMobile } from 'web/hooks/use-is-mobile'\n+  calculateOrderFillParams,\n+  OrderBookPanel,\n+  OrderClickData,\n+  YourOrders,\n+} from './order-book'\n import { ShareBetModal } from './share-bet'\n-import { Bet } from 'common/bet'\n-import { LuShare } from 'react-icons/lu'\n-import { useEvent } from 'client-common/hooks/use-event'\n-import { calculateCpmmAmountToBuyShares } from 'common/calculate-cpmm'\n+import { YesNoSelector } from './yes-no-selector'\n \n const WAIT_TO_DISMISS = 3000\n export type BinaryOutcomes = 'YES' | 'NO' | undefined\n type BuyPanelProps = {\n@@ -380,8 +384,25 @@\n   const [betTypeSetting, setBetTypeSetting] = useState<'Market' | 'Limit'>(\n     'Market'\n   )\n \n+  // State for prefilled limit order from order book click\n+  const [prefillLimitOrder, setPrefillLimitOrder] = useState<{\n+    outcome: 'YES' | 'NO'\n+    limitProb: number\n+    amount: number\n+    timestamp: number // unique identifier for each click\n+  } | null>(null)\n+\n+  // Handle order book click to prefill limit order\n+  const handleOrderClick = useEvent((clickedOrder: OrderClickData) => {\n+    const fillParams = calculateOrderFillParams(clickedOrder)\n+    setPrefillLimitOrder({ ...fillParams, timestamp: Date.now() })\n+    setOutcome(fillParams.outcome)\n+    setBetTypeSetting('Limit')\n+    toast('Expiration set to immediate', { icon: '⏱️' })\n+  })\n+\n   useEffect(() => {\n     if (!isAdvancedTrader && betTypeSetting === 'Limit') {\n       setBetTypeSetting('Market')\n     }\n@@ -899,16 +920,19 @@\n           </>\n         ) : (\n           <>\n             <LimitOrderPanel\n-              betAmount={betAmount}\n+              betAmount={prefillLimitOrder?.amount ?? betAmount}\n               contract={contract}\n               multiProps={multiProps}\n               user={user}\n               unfilledBets={unfilledBets}\n               balanceByUserId={balanceByUserId}\n               outcome={outcome}\n               pseudonym={props.pseudonym}\n+              initialProb={prefillLimitOrder?.limitProb}\n+              expiration={prefillLimitOrder ? 1 : undefined}\n+              prefillTimestamp={prefillLimitOrder?.timestamp}\n             />\n           </>\n         )}\n \n@@ -1156,8 +1180,9 @@\n             (b) => b.answerId === multiProps?.answerToBuy?.id\n           )}\n           answer={multiProps?.answerToBuy}\n           pseudonym={props.pseudonym}\n+          onOrderClick={handleOrderClick}\n         />\n       )}\n     </>\n   )\n"
        },
        {
          "path": "web/components/bet/limit-order-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/limit-order-panel.tsx\n===================================================================\n--- web/components/bet/limit-order-panel.tsx\t012e7d6 (parent)\n+++ web/components/bet/limit-order-panel.tsx\t4d6385d (commit)\n@@ -20,8 +20,9 @@\n import { DAY_MS, HOUR_MS, MINUTE_MS, MONTH_MS, WEEK_MS } from 'common/util/time'\n import dayjs from 'dayjs'\n import { capitalize, clamp } from 'lodash'\n import { useEffect, useRef, useState } from 'react'\n+import toast from 'react-hot-toast'\n import { LuShare } from 'react-icons/lu'\n import { Input } from 'web/components/widgets/input'\n import { usePersistentLocalState } from 'web/hooks/use-persistent-local-state'\n import { api } from 'web/lib/api/api'\n@@ -73,8 +74,9 @@\n     }\n   }\n   initialProb?: number\n   expiration?: number\n+  prefillTimestamp?: number\n }) {\n   const {\n     contract,\n     multiProps,\n@@ -145,9 +147,10 @@\n       if (matchingOption) {\n         setSelectedExpiration(matchingOption.value)\n       }\n     }\n-  }, [expiration, setSelectedExpiration])\n+    // Include prefillTimestamp so clicking the same order again resets expiration\n+  }, [expiration, setSelectedExpiration, props.prefillTimestamp])\n \n   const addCustomExpiration = selectedExpiration === -1\n   const expiresAt = addCustomExpiration\n     ? dayjs(`${expirationDate}T${expirationHoursMinutes}`).valueOf()\n@@ -171,8 +174,30 @@\n   const [limitProbInt, setLimitProbInt] = useState<number | undefined>(\n     Math.round(initialProb * 100)\n   )\n \n+  // Track the last applied prefill timestamp to avoid re-applying or resetting\n+  const lastAppliedPrefillTimestamp = useRef<number | null>(null)\n+\n+  // Update betAmount and limitProbInt when prefill props change (for prefill from order book)\n+  // Only apply when it's a NEW prefill (different timestamp), not when clearing\n+  useEffect(() => {\n+    const newAmount = props.betAmount\n+    const newProb = props.initialProb\n+    const newTimestamp = props.prefillTimestamp\n+\n+    // Check if this is a new prefill (has timestamp and it's different from last applied)\n+    const isNewPrefill =\n+      newTimestamp !== undefined &&\n+      newTimestamp !== lastAppliedPrefillTimestamp.current\n+\n+    if (isNewPrefill && newAmount !== undefined && newProb !== undefined) {\n+      setBetAmount(newAmount)\n+      setLimitProbInt(Math.round(newProb * 100))\n+      lastAppliedPrefillTimestamp.current = newTimestamp\n+    }\n+  }, [props.betAmount, props.initialProb, props.prefillTimestamp])\n+\n   const hasLimitBet = !!limitProbInt && !!betAmount\n \n   const betDisabled =\n     isSubmitting ||\n@@ -244,9 +269,11 @@\n           silent: expiresMillisAfter && expiresMillisAfter <= 1000,\n         } as APIParams<'bet'>)\n       )\n       console.log(`placed ${TRADE_TERM}. Result:`, bet)\n-\n+      if (expiresMillisAfter === 1) {\n+        toast.success('Order will expire immediately after placement')\n+      }\n       const fullBet: Bet = {\n         ...(bet as CandidateBet<LimitBet>),\n         id: bet.betId,\n         userId: user.id,\n"
        },
        {
          "path": "web/components/bet/order-book.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/order-book.tsx\n===================================================================\n--- web/components/bet/order-book.tsx\t012e7d6 (parent)\n+++ web/components/bet/order-book.tsx\t4d6385d (commit)\n@@ -371,8 +371,37 @@\n     </tr>\n   )\n }\n \n+export type OrderClickData = {\n+  outcome: 'YES' | 'NO'\n+  limitProb: number\n+  amount: number // unfilled amount in mana\n+}\n+\n+export function calculateOrderFillParams(clickedOrder: OrderClickData) {\n+  const { outcome, limitProb, amount } = clickedOrder\n+  const oppositeOutcome = outcome === 'YES' ? 'NO' : 'YES'\n+\n+  // Calculate shares from clicked order based on outcome\n+  // YES shares = amount / limitProb, NO shares = amount / (1 - limitProb)\n+  const clickedShares =\n+    outcome === 'YES' ? amount / limitProb : amount / (1 - limitProb)\n+\n+  // To fill with opposite outcome at same limitProb, calculate amount needed for same shares\n+  const fillAmount =\n+    oppositeOutcome === 'YES'\n+      ? clickedShares * limitProb\n+      : clickedShares * (1 - limitProb)\n+\n+  // Round to 2 decimal places to avoid floating point precision issues\n+  return {\n+    outcome: oppositeOutcome as 'YES' | 'NO',\n+    limitProb, // same probability\n+    amount: Math.round(fillAmount * 100) / 100,\n+  }\n+}\n+\n export function CollatedOrderTable(props: {\n   limitBets: LimitBet[]\n   contract:\n     | BinaryContract\n@@ -390,10 +419,11 @@\n       pseudonymName: string\n       pseudonymColor: string\n     }\n   }\n+  onOrderClick?: (data: OrderClickData) => void\n }) {\n-  const { contract, side, pseudonym } = props\n+  const { contract, side, pseudonym, onOrderClick } = props\n   const limitBets = props.limitBets.filter(\n     (b) => !b.expiresAt || b.expiresAt > Date.now()\n   )\n   const isBinaryMC = isBinaryMulti(contract)\n@@ -423,8 +453,9 @@\n             contract={contract}\n             key={prob}\n             limitProb={Number(prob)}\n             bets={bets}\n+            onOrderClick={onOrderClick}\n           />\n         ))}\n       </div>\n     </div>\n@@ -439,10 +470,11 @@\n     | CPMMMultiContract\n     | MultiContract\n   limitProb: number\n   bets: LimitBet[]\n+  onOrderClick?: (data: OrderClickData) => void\n }) {\n-  const { contract, limitProb, bets } = props\n+  const { contract, limitProb, bets, onOrderClick } = props\n   const { outcome } = bets[0]\n   const isPseudoNumeric = contract.outcomeType === 'PSEUDO_NUMERIC'\n   const isBinaryMC = isBinaryMulti(contract)\n \n@@ -466,8 +498,20 @@\n     .reverse()\n \n   const [collapsed, setCollapsed] = useState(true)\n \n+  const handleOrderClick = () => {\n+    if (onOrderClick) {\n+      onOrderClick({\n+        outcome: outcome as 'YES' | 'NO',\n+        limitProb,\n+        amount: total,\n+      })\n+    }\n+  }\n+\n+  const isClickable = !!onOrderClick\n+\n   return (\n     <>\n       <div className=\"self-center\">\n         {isPseudoNumeric\n@@ -488,9 +532,16 @@\n           onClick={() => setCollapsed((c) => !c)}\n         />\n       </div>\n \n-      <div className=\"self-center pr-1 text-right\">\n+      <div\n+        className={clsx(\n+          'self-center pr-1 text-right',\n+          isClickable &&\n+            'hover:bg-primary-100 cursor-pointer rounded px-1 py-0.5'\n+        )}\n+        onClick={handleOrderClick}\n+      >\n         <MoneyDisplay\n           amount={total}\n           numberType=\"short\"\n           isCashContract={contract.token === 'CASH'}\n@@ -585,10 +636,11 @@\n       pseudonymName: string\n       pseudonymColor: string\n     }\n   }\n+  onOrderClick?: (data: OrderClickData) => void\n }) {\n-  const { contract, answer, showTitle, pseudonym } = props\n+  const { contract, answer, showTitle, pseudonym, onOrderClick } = props\n   const limitBets = props.limitBets.filter(\n     (b) => (!b.expiresAt || b.expiresAt > Date.now()) && !b.silent\n   )\n \n@@ -625,14 +677,16 @@\n           limitBets={yesBets}\n           contract={contract}\n           side=\"YES\"\n           pseudonym={pseudonym}\n+          onOrderClick={onOrderClick}\n         />\n         <CollatedOrderTable\n           limitBets={noBets}\n           contract={contract}\n           side=\"NO\"\n           pseudonym={pseudonym}\n+          onOrderClick={onOrderClick}\n         />\n       </Row>\n \n       {!isPseudoNumeric && yesBets.length >= 2 && noBets.length >= 2 && (\n"
        }
      ]
    },
    {
      "id": "guard-negative-payouts",
      "sha": "e116d9c9db80f57160a3dfa59296ee33a79859e8",
      "parentSha": "148ee5d5b5795b4a527c8d7f1efb01ebdbf09d1a",
      "spec": "Implement safeguards to prevent non-admin/mod users from performing resolutions (specifically CANCEL) or unresolve operations that would create negative balances in combination with large negative balance updates.\n\nScope and required changes:\n\n1) Add a balance safety helper\n- File: backend/shared/src/resolve-market-helpers.ts\n- Export a function checkForNegativeBalancesAndPayouts(userUpdates, balanceDeltas) that:\n  - Examines returned user updates from a balance increment query and the per-user balance deltas applied in that operation.\n  - Identifies users whose resulting balance is negative and whose applied balance delta is a significant negative amount (threshold: less than -1000).\n  - If any such users exist and the caller is not an admin/mod, throw an API error with HTTP 400 and the message: \"Negative balances & payouts too large as a result. Please tag @mods for help resolving this market.\"\n\n2) Return balance deltas from payout query builder\n- File: backend/shared/src/resolve-market-helpers.ts\n- Update getPayUsersQueries(...) so it returns the existing balanceUpdatesQuery and insertTxnsQuery, and additionally returns the computed balanceUpdates array so callers can validate it after execution.\n\n3) Guard CASH CANCEL resolutions using the helper\n- File: backend/shared/src/resolve-market-helpers.ts\n- In resolveMarketHelper, after building queries with getPayUsersQueries and executing the multi-statement SQL (including the balance updates), capture the returned rows from the balance update query as UserUpdate[].\n- If outcome is CANCEL and the resolver is not an admin or mod, call checkForNegativeBalancesAndPayouts(userUpdates, balanceUpdates) and abort with the error described above if violations are found.\n- Maintain existing behavior for metrics, notifications, websockets, and fees.\n\n4) Guard unresolve using the helper and switch to query-based balance updates\n- File: backend/api/src/unresolve.ts\n- Remove the top-level restriction that only mods/admins may unresolve; rely on the targeted safety checks and any existing authorization elsewhere in the endpoint.\n- In undoResolution (or equivalent function that applies balance updates to revert resolution payouts):\n  - Replace the direct bulkIncrementBalances(...) call with generation of the SQL via bulkIncrementBalancesQuery(balanceUpdates), execute it via the Supabase transaction client and retrieve the updated user rows as UserUpdate[].\n  - If the initiating user is not an admin or mod, invoke checkForNegativeBalancesAndPayouts(userUpdates, balanceUpdates) and abort with the error described above if violations are found.\n  - Proceed to insert the reversal txns if the check passes.\n\n5) Imports and typing\n- Ensure resolve-market-helpers.ts and unresolve.ts import UserUpdate and bulkIncrementBalancesQuery from shared/supabase/users, and APIError from common/api/utils where needed.\n- Ensure getPayUsersQueries call sites in resolveMarketHelper destructure the new balanceUpdates return.\n\nBehavioral acceptance criteria:\n- Resolving a market with outcome CANCEL by a non-admin/mod that would cause any user’s final balance to be negative and involves a balance delta less than -1000 fails with HTTP 400 and the specified message.\n- Unresolving by a non-admin/mod that would produce the same condition also fails similarly.\n- Admins/mods can perform these operations regardless of the condition.\n- Other resolution paths and non-CANCEL outcomes continue to work as before.\n- getPayUsersQueries maintains previous behavior while now also returning balanceUpdates for validation.",
      "prompt": "Enhance the market resolution and unresolve flows to prevent non-admin/mod users from pushing accounts into negative balances due to large negative payout adjustments. Add a helper that inspects the results of the batch balance update alongside the applied deltas, and aborts with a clear error when such risky adjustments are detected. Wire this helper into both the CANCEL resolution path and the unresolve path, returning the necessary balance deltas from the payout query builder and switching the unresolve flow to use the query that returns updated user rows. Keep existing behaviors for metrics, notifications, and transactions intact, and ensure admins/mods are exempt from the guard.",
      "supplementalFiles": [
        "backend/shared/src/supabase/users.ts",
        "backend/shared/src/supabase/init.ts",
        "backend/shared/src/supabase/utils.ts",
        "backend/shared/src/txn/run-txn.ts",
        "backend/shared/src/helpers/user-contract-metrics.ts",
        "backend/api/src/resolve-market.ts",
        "common/api/utils.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/unresolve.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/unresolve.ts\n===================================================================\n--- backend/api/src/unresolve.ts\t148ee5d (parent)\n+++ backend/api/src/unresolve.ts\te116d9c (commit)\n@@ -18,13 +18,15 @@\n   bulkUpdateContractMetrics,\n   getContractMetricsForContract,\n } from 'shared/helpers/user-contract-metrics'\n import { recordContractEdit } from 'shared/record-contract-edit'\n+import { checkForNegativeBalancesAndPayouts } from 'shared/resolve-market-helpers'\n import { updateContract } from 'shared/supabase/contracts'\n import {\n   SupabaseTransaction,\n   createSupabaseDirectClient,\n } from 'shared/supabase/init'\n+import { UserUpdate, bulkIncrementBalancesQuery } from 'shared/supabase/users'\n import { FieldVal } from 'shared/supabase/utils'\n import { TxnData, insertTxns } from 'shared/txn/run-txn'\n import { getContract, isProd, log } from 'shared/utils'\n import { broadcastUpdatedAnswers } from 'shared/websockets/helpers'\n@@ -35,11 +37,8 @@\n   props,\n   auth,\n   request\n ) => {\n-  if (!isModId(auth.uid) && !isAdminId(auth.uid)) {\n-    throw new APIError(403, 'Unresolving is only allowed for mods and admins')\n-  }\n   return await betsQueue.enqueueFn(\n     () => unresolveMain(props, auth, request),\n     [props.contractId, auth.uid]\n   )\n@@ -231,9 +230,16 @@\n   //   balanceUpdates.push(balanceUpdate as any)\n   //   txns.push(txn)\n   // }\n \n-  await bulkIncrementBalances(pg, balanceUpdates)\n+  if (balanceUpdates.length > 0) {\n+    const balanceUpdatesQuery = bulkIncrementBalancesQuery(balanceUpdates)\n+    const userUpdates = await pg.many<UserUpdate>(balanceUpdatesQuery)\n+    if (!isAdminId(userId) && !isModId(userId)) {\n+      checkForNegativeBalancesAndPayouts(userUpdates, balanceUpdates)\n+    }\n+  }\n+\n   await insertTxns(pg, txns)\n \n   log('reverted txns')\n \n"
        },
        {
          "path": "backend/shared/src/resolve-market-helpers.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/resolve-market-helpers.ts\n===================================================================\n--- backend/shared/src/resolve-market-helpers.ts\t148ee5d (parent)\n+++ backend/shared/src/resolve-market-helpers.ts\te116d9c (commit)\n@@ -1,60 +1,60 @@\n-import { mapValues, groupBy, sum, sumBy, keyBy, uniqBy } from 'lodash'\n+import { APIError } from 'common//api/utils'\n+import { Answer } from 'common/answer'\n import {\n-  HOUSE_LIQUIDITY_PROVIDER_ID,\n   DEV_HOUSE_LIQUIDITY_PROVIDER_ID,\n+  HOUSE_LIQUIDITY_PROVIDER_ID,\n } from 'common/antes'\n+import { calculateUpdatedMetricsForContracts } from 'common/calculate-metrics'\n import {\n   Contract,\n   contractPath,\n   ContractToken,\n   CPMMMultiContract,\n   MarketContract,\n } from 'common/contract'\n+import { ContractMetric } from 'common/contract-metric'\n+import { PROFIT_FEE_FRACTION } from 'common/economy'\n+import { isAdminId, isModId } from 'common/envs/constants'\n import { LiquidityProvision } from 'common/liquidity-provision'\n-import { Txn, CancelUniqueBettorBonusTxn } from 'common/txn'\n-import { User } from 'common/user'\n-import { removeUndefinedProps } from 'common/util/object'\n-import { createContractResolvedNotifications } from './create-notification'\n-import { bulkUpdateContractMetricsQuery } from './helpers/user-contract-metrics'\n import {\n-  TxnData,\n-  runTxnOutsideBetQueueIgnoringBalance,\n-  txnToRow,\n-} from './txn/run-txn'\n-import {\n-  revalidateStaticProps,\n-  isProd,\n-  log,\n-  getContractAndMetricsAndLiquidities,\n-} from './utils'\n-import {\n   getLoanPayouts,\n   getPayouts,\n   groupPayoutsByUser,\n   Payout,\n } from 'common/payouts'\n-import { APIError } from 'common//api/utils'\n+import { convertTxn } from 'common/supabase/txns'\n+import { CancelUniqueBettorBonusTxn, Txn } from 'common/txn'\n+import { User } from 'common/user'\n+import { removeUndefinedProps } from 'common/util/object'\n+import { groupBy, keyBy, mapValues, sum, sumBy, uniqBy } from 'lodash'\n import { trackPublicEvent } from 'shared/analytics'\n import { recordContractEdit } from 'shared/record-contract-edit'\n+import { createContractResolvedNotifications } from './create-notification'\n+import { bulkUpdateContractMetricsQuery } from './helpers/user-contract-metrics'\n+import { updateAnswer, updateAnswers } from './supabase/answers'\n import {\n+  createSupabaseDirectClient,\n   SERIAL_MODE,\n   SupabaseTransaction,\n-  createSupabaseDirectClient,\n } from './supabase/init'\n-import { Answer } from 'common/answer'\n-import { isAdminId, isModId } from 'common/envs/constants'\n-import { convertTxn } from 'common/supabase/txns'\n-import { updateAnswer, updateAnswers } from './supabase/answers'\n-import { bulkInsertQuery, updateDataQuery } from './supabase/utils'\n import { bulkIncrementBalancesQuery, UserUpdate } from './supabase/users'\n+import { bulkInsertQuery, updateDataQuery } from './supabase/utils'\n import {\n+  runTxnOutsideBetQueueIgnoringBalance,\n+  TxnData,\n+  txnToRow,\n+} from './txn/run-txn'\n+import {\n+  getContractAndMetricsAndLiquidities,\n+  isProd,\n+  log,\n+  revalidateStaticProps,\n+} from './utils'\n+import {\n   broadcastUpdatedContract,\n   broadcastUpdatedMetrics,\n } from './websockets/helpers'\n-import { ContractMetric } from 'common/contract-metric'\n-import { calculateUpdatedMetricsForContracts } from 'common/calculate-metrics'\n-import { PROFIT_FEE_FRACTION } from 'common/economy'\n \n export type ResolutionParams = {\n   outcome: string\n   probabilityInt?: number\n@@ -218,20 +218,8 @@\n     )\n \n     log('negative payouts', { negativePayouts })\n \n-    if (\n-      outcome === 'CANCEL' &&\n-      !isAdminId(resolver.id) &&\n-      !isModId(resolver.id) &&\n-      negativePayouts.length > 0\n-    ) {\n-      throw new APIError(\n-        403,\n-        'Negative payouts too large for resolution. Contact admin or mod.'\n-      )\n-    }\n-\n     if (updateAnswerAttrs && answerId) {\n       const props = removeUndefinedProps(updateAnswerAttrs)\n       await updateAnswer(tx, answerId, props)\n     } else if (\n@@ -260,15 +248,10 @@\n     const payoutFees =\n       token === 'CASH'\n         ? assessProfitFees(traderPayouts, updatedContractMetrics, answerId)\n         : []\n-    const { balanceUpdatesQuery, insertTxnsQuery } = getPayUsersQueries(\n-      payouts,\n-      contractId,\n-      answerId,\n-      token,\n-      payoutFees\n-    )\n+    const { balanceUpdatesQuery, insertTxnsQuery, balanceUpdates } =\n+      getPayUsersQueries(payouts, contractId, answerId, token, payoutFees)\n     const contractUpdateQuery = updateDataQuery(\n       'contracts',\n       'id',\n       updatedContractAttrs\n@@ -281,8 +264,15 @@\n       ${contractUpdateQuery}; -- 3\n       ${updateMetricsQuery}; -- 4\n       `)\n     const userUpdates = results[0] as UserUpdate[]\n+    if (\n+      outcome === 'CANCEL' &&\n+      !isAdminId(resolver.id) &&\n+      !isModId(resolver.id)\n+    ) {\n+      checkForNegativeBalancesAndPayouts(userUpdates, balanceUpdates)\n+    }\n \n     // TODO: we may want to support clawing back trader bonuses on MC markets too\n     if (!answerId && outcome === 'CANCEL') {\n       await undoUniqueBettorRewardsIfCancelResolution(tx, resolvedContract)\n@@ -523,9 +513,9 @@\n \n   const balanceUpdatesQuery = bulkIncrementBalancesQuery(balanceUpdates)\n   const insertTxnsQuery = bulkInsertQuery('txns', txns.map(txnToRow), false)\n \n-  return { balanceUpdatesQuery, insertTxnsQuery }\n+  return { balanceUpdatesQuery, insertTxnsQuery, balanceUpdates }\n }\n \n const checkAndMergePayouts = (payouts: Payout[]) => {\n   for (const { payout, deposit } of payouts) {\n@@ -571,4 +561,29 @@\n       }\n     })\n     .filter((p) => p.payout !== 0)\n }\n+\n+export const checkForNegativeBalancesAndPayouts = (\n+  userUpdates: UserUpdate[],\n+  balanceDeltas: {\n+    id: string\n+    balance?: number\n+  }[]\n+) => {\n+  const negativeBalanceUsers = userUpdates.filter(\n+    (user) => user.balance !== undefined && user.balance < 0\n+  )\n+  // Only throw error if the balance update itself is below -1000\n+  const significantNegativeUpdatesOnNegativeBalanceUsers =\n+    negativeBalanceUsers.filter((user) => {\n+      const delta = balanceDeltas.find((d) => d.id === user.id)\n+      return delta && delta.balance !== undefined && delta.balance < -1000\n+    })\n+\n+  if (significantNegativeUpdatesOnNegativeBalanceUsers.length > 0) {\n+    throw new APIError(\n+      400,\n+      `Negative balances & payouts too large as a result. Please tag @mods for help resolving this market.`\n+    )\n+  }\n+}\n"
        }
      ]
    },
    {
      "id": "admin-sell-bets",
      "sha": "96e0ba1abff7e82411c40282bad4e65c876e9eba",
      "parentSha": "741081d9f87c300d66807885f0e4baa564092742",
      "spec": "Implement admin-initiated share sales and audit logging across backend, schema, and web UI.\n\nBackend changes\n1) Allow admin-initiated trades to bypass banned/deleted user checks\n- File: backend/api/src/helpers/bets.ts\n  - Update fetchContractBetDataAndValidate signature to accept a new optional boolean parameter isAdminTrade with default false: (pgTrans, body, uid, isApi, isAdminTrade = false).\n  - Modify the banned/deleted validation so that the error is thrown only if (!isAdminTrade) AND (user is banned or deleted). This preserves existing behavior for normal users and bypasses for admin-initiated trades.\n  - Ensure all existing call sites continue to compile due to the default value; no changes required elsewhere except where we explicitly pass this flag (see sell endpoint below).\n\n2) Enable selling shares on behalf of another user with permission checks and audit logging\n- File: backend/api/src/sell-shares.ts\n  - Extend the validated request props to include an optional sellForUserId string.\n  - In the top-level handler sellShares, when sellForUserId is present, require admin permissions by calling throwErrorIfNotAdmin(auth.uid). Set userId = sellForUserId || auth.uid, and include userId in the queue dependency array: [userId, contractId, ...(deps ?? [])].\n  - In sellSharesMain, set uid = sellForUserId || auth.uid.\n  - Call fetchContractBetDataAndValidate with isAdminTrade = !!sellForUserId so admin-initiated flows bypass banned/deleted checks.\n  - When selecting the user’s metrics for calculations (contractMetrics.find(...)), use m.userId === uid (not auth.uid) so the sale uses the intended user’s position.\n  - After a successful sale, write a public audit event capturing this admin action: call trackPublicAuditBetEvent(auth.uid, 'admin_sell_shares', props.contractId, betId, { sellForUserId }). Ensure imports for throwErrorIfNotAdmin and trackPublicAuditBetEvent are added.\n\n3) Add audit logging helper for bet-related events\n- File: backend/shared/src/audit-events.ts\n  - Add and export trackPublicAuditBetEvent(userId, name, contractId, betId, otherProps?) that inserts a row into audit_events with name, user_id, contract_id, bet_id, data JSONB, using tryOrLogError and createSupabaseDirectClient.\n\n4) Extend audit_events schema to store bet_id\n- File: backend/supabase/audit_events.sql\n  - Add a bet_id text column to the audit_events table definition. Keep RLS, indexes, and uniqueness on id as-is.\n\nAPI schema changes\n5) Extend sell endpoint schema to accept sellForUserId\n- File: common/src/api/schema.ts\n  - In API['market/:contractId/sell'].props, add optional field sellForUserId: z.string().optional() with a comment indicating admin-only usage.\n\nWeb UI changes\n6) Allow admins to trigger a sell on behalf of another user\n- File: web/components/bet/user-bet-summary.tsx\n  - Import useAdmin and noFees.\n  - Add an “Admin Sell” button that appears only when:\n    - current user is admin (useAdmin() is true), a signed-in user exists, a display bettor exists, and areYourBets is false;\n    - the market is unresolved;\n    - the user has a nontrivial position (yesWinnings > 1 or noWinnings > 1);\n    - the mechanism is cpmm-1.\n  - On click, open a SellSharesModal configured to sell the displayed bettor’s position: set shares to Math.abs(position), sharesOutcome to maxSharesOutcome, and sellForUserId to metric.userId. For safety, ensure contract.collectedFees is set (default to noFees if undefined) when passing the contract to the modal.\n\n7) Plumb sellForUserId through the sell modal and panel\n- File: web/components/bet/sell-row.tsx\n  - Extend SellSharesModal’s props with optional sellForUserId?: string. If present, update the modal title to “Admin: Sell user position” and adjust the preface copy to say “User has …” instead of “You have …”. Pass sellForUserId down to SellPanel.\n\n- File: web/components/bet/sell-panel.tsx\n  - Extend props with optional sellForUserId?: string.\n  - When calling api('market/:contractId/sell', ...), include sellForUserId if provided so the backend performs the sale for that user. Maintain existing deps logic.\n\nIntegration notes\n- Ensure imports are updated accordingly:\n  - backend/api/src/sell-shares.ts should import throwErrorIfNotAdmin from shared/helpers/auth and trackPublicAuditBetEvent from shared/audit-events.\n  - web/components/bet/user-bet-summary.tsx should import useAdmin from web/hooks/use-admin and noFees from common/fees.\n- No changes needed to place-bet or place-multi-bet, but they help illustrate fetchContractBetDataAndValidate usage.\n- Confirm there is no duplicate import of getUserAchievements in backend/api/src/routes.ts (import order is not functionally significant).\n- After changes, admin-initiated sells should succeed even when the target user is banned or deleted, regular users remain blocked, and each admin action is recorded in audit_events with bet_id and sellForUserId in data.\n",
      "prompt": "Add an admin-only feature to sell a user’s position on their behalf and record it for auditing.\n\n- Backend: Update the sell shares API so an admin can optionally specify a target user, have the sale execute using that user’s position, and bypass normal banned/deleted-user trading blocks for this admin-initiated action. After a successful sale, write an audit event that includes the admin, the contract, the bet id, and the target user. Keep normal behavior for all non-admin calls.\n- API schema: Extend the sell endpoint to accept an optional target user id for admin use.\n- Database: Extend the audit_events table to include the bet id so admin sell events can reference the resulting bet.\n- Web UI: On contract positions, show an “Admin Sell” button for admins viewing someone else’s position on a cpmm-1 market. When used, open the normal sell modal but clearly indicate this is an admin action, and ensure the request targets the other user.\n\nThe UI should only show this action to admins and the backend must enforce admin checks and write the audit trail.",
      "supplementalFiles": [
        "backend/api/src/place-bet.ts",
        "backend/api/src/place-multi-bet.ts",
        "backend/shared/src/helpers/auth.ts",
        "web/hooks/use-admin.ts",
        "common/src/sell-bet.ts",
        "common/src/contract-metric.ts",
        "common/src/api/utils.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/helpers/bets.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/helpers/bets.ts\n===================================================================\n--- backend/api/src/helpers/bets.ts\t741081d (parent)\n+++ backend/api/src/helpers/bets.ts\t96e0ba1 (commit)\n@@ -41,9 +41,10 @@\n     answerIds?: string[]\n     outcome: 'YES' | 'NO'\n   },\n   uid: string,\n-  isApi: boolean\n+  isApi: boolean,\n+  isAdminTrade: boolean = false\n ) => {\n   const startTime = Date.now()\n   const { amount, contractId, outcome } = body\n   const answerIds =\n@@ -160,9 +161,12 @@\n   const balance = user.balance\n   if (amount !== undefined && balance < amount)\n     throw new APIError(403, 'Insufficient balance.')\n \n-  if (BANNED_TRADING_USER_IDS.includes(user.id) || user.userDeleted) {\n+  if (\n+    (BANNED_TRADING_USER_IDS.includes(user.id) || user.userDeleted) &&\n+    !isAdminTrade\n+  ) {\n     throw new APIError(403, 'You are banned or deleted. And not #blessed.')\n   }\n   if (contract.outcomeType === 'STONK' && isApi) {\n     throw new APIError(403, 'API users cannot bet on STONK contracts.')\n"
        },
        {
          "path": "backend/api/src/routes.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/routes.ts\n===================================================================\n--- backend/api/src/routes.ts\t741081d (parent)\n+++ backend/api/src/routes.ts\t96e0ba1 (commit)\n@@ -167,8 +167,9 @@\n import { getReactions } from './get-reactions'\n import { getSeasonInfo } from './get-season-info'\n import { getSiteActivity } from './get-site-activity'\n import { getSportsGames } from './get-sports-games'\n+import { getUserAchievements } from './get-user-achievements'\n import { getUserContractMetricsWithContracts } from './get-user-contract-metrics-with-contracts'\n import { getUserLastActiveTime } from './get-user-last-active-time'\n import { inferNumericUnit } from './infer-numeric-unit'\n import { isSportsInterested } from './is-sports-bettor'\n@@ -182,9 +183,8 @@\n import { purchaseContractBoost } from './purchase-boost'\n import { referUser } from './refer-user'\n import { updatePost } from './update-post'\n import { validateiap } from './validate-iap'\n-import { getUserAchievements } from './get-user-achievements'\n \n export const handlers: { [k in APIPath]: APIHandler<k> } = {\n   'refresh-all-clients': refreshAllClients,\n   bet: placeBet,\n"
        },
        {
          "path": "backend/api/src/sell-shares.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/sell-shares.ts\n===================================================================\n--- backend/api/src/sell-shares.ts\t741081d (parent)\n+++ backend/api/src/sell-shares.ts\t96e0ba1 (commit)\n@@ -1,24 +1,26 @@\n-import { APIError, type APIHandler } from './helpers/endpoint'\n-import { MarketContract } from 'common/contract'\n-import { getCpmmMultiSellBetInfo, getCpmmSellBetInfo } from 'common/sell-bet'\n-import { floatingLesserEqual } from 'common/util/math'\n-import { executeNewBetResult } from './place-bet'\n-import { onCreateBets } from 'api/on-create-bet'\n-import { log } from 'shared/utils'\n-import { runTransactionWithRetries } from 'shared/transact-with-retries'\n-import { betsQueue } from 'shared/helpers/fn-queue'\n-import { createSupabaseDirectClient } from 'shared/supabase/init'\n-import { LimitBet } from 'common/bet'\n-import { Answer } from 'common/answer'\n-import { ContractMetric } from 'common/contract-metric'\n import {\n   fetchContractBetDataAndValidate,\n   getMakerIdsFromBetResult,\n   getUserBalancesAndMetrics,\n } from 'api/helpers/bets'\n+import { onCreateBets } from 'api/on-create-bet'\n+import { Answer } from 'common/answer'\n+import { LimitBet } from 'common/bet'\n+import { MarketContract } from 'common/contract'\n+import { ContractMetric } from 'common/contract-metric'\n+import { getCpmmMultiSellBetInfo, getCpmmSellBetInfo } from 'common/sell-bet'\n+import { floatingLesserEqual } from 'common/util/math'\n import { randomString } from 'common/util/random'\n import { isEqual } from 'lodash'\n+import { trackPublicAuditBetEvent } from 'shared/audit-events'\n+import { throwErrorIfNotAdmin } from 'shared/helpers/auth'\n+import { betsQueue } from 'shared/helpers/fn-queue'\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { runTransactionWithRetries } from 'shared/transact-with-retries'\n+import { log } from 'shared/utils'\n+import { APIError, type APIHandler } from './helpers/endpoint'\n+import { executeNewBetResult } from './place-bet'\n \n const calculateSellResult = (\n   contract: MarketContract,\n   answers: Answer[] | undefined,\n@@ -104,10 +106,14 @@\n   props,\n   auth,\n   req\n ) => {\n-  const userId = auth.uid\n-  const { contractId, deps } = props\n+  const { contractId, deps, sellForUserId } = props\n+  // Check admin permissions when selling for another user\n+  if (sellForUserId) {\n+    throwErrorIfNotAdmin(auth.uid)\n+  }\n+  const userId = sellForUserId || auth.uid\n   const fullDeps = [userId, contractId, ...(deps ?? [])]\n   return await betsQueue.enqueueFn(\n     () => sellSharesMain(props, auth, req),\n     fullDeps\n@@ -117,10 +123,17 @@\n const sellSharesMain: APIHandler<'market/:contractId/sell'> = async (\n   props,\n   auth\n ) => {\n-  const { contractId, shares, outcome, answerId, deterministic } = props\n-  const uid = auth.uid\n+  const {\n+    contractId,\n+    shares,\n+    outcome,\n+    answerId,\n+    deterministic,\n+    sellForUserId,\n+  } = props\n+  const uid = sellForUserId || auth.uid\n   const isApi = auth.creds.kind === 'key'\n   const pg = createSupabaseDirectClient()\n   const oppositeOutcome = outcome === 'YES' ? 'NO' : 'YES'\n   const {\n@@ -134,9 +147,10 @@\n   } = await fetchContractBetDataAndValidate(\n     pg,\n     { ...props, amount: undefined, outcome: oppositeOutcome },\n     uid,\n-    isApi\n+    isApi,\n+    !!sellForUserId\n   )\n   const simulatedResult = calculateSellResult(\n     contract,\n     answers,\n@@ -144,11 +158,9 @@\n     balanceByUserId,\n     answerId,\n     outcome,\n     shares,\n-    contractMetrics.find(\n-      (m) => m.answerId == answerId && m.userId === auth.uid\n-    )!\n+    contractMetrics.find((m) => m.answerId == answerId && m.userId === uid)!\n   )\n   const simulatedMakerIds = getMakerIdsFromBetResult(simulatedResult)\n \n   const result = await runTransactionWithRetries(async (pgTrans) => {\n@@ -178,11 +190,9 @@\n       balanceByUserId,\n       answerId,\n       outcome,\n       shares,\n-      contractMetrics.find(\n-        (m) => m.answerId == answerId && m.userId === auth.uid\n-      )!\n+      contractMetrics.find((m) => m.answerId == answerId && m.userId === uid)!\n     )\n     log(`Calculated sale information for ${user.username} - auth ${uid}.`)\n     const actualMakerIds = getMakerIdsFromBetResult(newBetResult)\n     log(\n@@ -210,8 +220,17 @@\n     )\n   })\n \n   const { newBet, betId } = result\n+  trackPublicAuditBetEvent(\n+    auth.uid,\n+    'admin_sell_shares',\n+    props.contractId,\n+    betId,\n+    {\n+      sellForUserId,\n+    }\n+  )\n \n   const continuation = async () => {\n     await onCreateBets(result)\n   }\n"
        },
        {
          "path": "backend/shared/src/audit-events.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/audit-events.ts\n===================================================================\n--- backend/shared/src/audit-events.ts\t741081d (parent)\n+++ backend/shared/src/audit-events.ts\t96e0ba1 (commit)\n@@ -1,6 +1,6 @@\n-import { createSupabaseDirectClient } from 'shared/supabase/init'\n import { tryOrLogError } from 'shared/helpers/try-or-log-error'\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n \n export const trackAuditEvent = async (\n   userId: string,\n   name: string,\n@@ -16,4 +16,20 @@\n       [name, userId, contractId, commentId, otherProps]\n     )\n   )\n }\n+export const trackPublicAuditBetEvent = async (\n+  userId: string,\n+  name: string,\n+  contractId: string,\n+  betId: string,\n+  otherProps?: Record<string, any>\n+) => {\n+  const pg = createSupabaseDirectClient()\n+  return await tryOrLogError(\n+    pg.none(\n+      `insert into audit_events (name,user_id, contract_id, bet_id, data) \n+                values ($1, $2, $3, $4, $5) on conflict do nothing`,\n+      [name, userId, contractId, betId, otherProps]\n+    )\n+  )\n+}\n"
        },
        {
          "path": "backend/supabase/audit_events.sql",
          "status": "modified",
          "diff": "Index: backend/supabase/audit_events.sql\n===================================================================\n--- backend/supabase/audit_events.sql\t741081d (parent)\n+++ backend/supabase/audit_events.sql\t96e0ba1 (commit)\n@@ -2,8 +2,9 @@\n create table if not exists\n   audit_events (\n     comment_id text,\n     contract_id text,\n+    bet_id text,\n     created_time timestamp with time zone default now() not null,\n     data jsonb,\n     id bigint primary key generated always as identity not null,\n     name text not null,\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\t741081d (parent)\n+++ common/src/api/schema.ts\t96e0ba1 (commit)\n@@ -355,8 +355,9 @@\n         outcome: z.enum(['YES', 'NO']),\n         answerId: z.string().optional(), // Required for multi binary markets\n         deterministic: z.boolean().optional(),\n         deps: z.array(z.string()).optional(),\n+        sellForUserId: z.string().optional(), // Admin-only: sell for another user\n       })\n       .strict(),\n   },\n   'get-user-limit-orders-with-contracts': {\n"
        },
        {
          "path": "web/components/bet/sell-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/sell-panel.tsx\n===================================================================\n--- web/components/bet/sell-panel.tsx\t741081d (parent)\n+++ web/components/bet/sell-panel.tsx\t96e0ba1 (commit)\n@@ -1,4 +1,5 @@\n+import { useUnfilledBetsAndBalanceByUserId } from 'client-common/hooks/use-bets'\n import clsx from 'clsx'\n import { Answer } from 'common/answer'\n import { APIError } from 'common/api/utils'\n import { LimitBet } from 'common/bet'\n@@ -8,34 +9,33 @@\n   CPMMMultiContract,\n   CPMMNumericContract,\n   MultiContract,\n } from 'common/contract'\n+import { ContractMetric } from 'common/contract-metric'\n import { TRADE_TERM } from 'common/envs/constants'\n import { Fees, getFeeTotal } from 'common/fees'\n import { getFormattedMappedValue, getMappedValue } from 'common/pseudo-numeric'\n+import { getSaleResult, getSaleResultMultiSumsToOne } from 'common/sell-bet'\n import { getSharesFromStonkShares, getStonkDisplayShares } from 'common/stonk'\n import { User } from 'common/user'\n import {\n   formatLargeNumber,\n   formatPercent,\n   formatShares,\n   formatWithToken,\n } from 'common/util/format'\n-import { useState, useRef } from 'react'\n+import { uniq } from 'lodash'\n+import { useRef, useState } from 'react'\n import toast from 'react-hot-toast'\n+import { useIsPageVisible } from 'web/hooks/use-page-visible'\n import { api } from 'web/lib/api/api'\n import { track } from 'web/lib/service/analytics'\n import { WarningConfirmationButton } from '../buttons/warning-confirmation-button'\n import { Col } from '../layout/col'\n import { Row } from '../layout/row'\n import { Spacer } from '../layout/spacer'\n import { AmountInput } from '../widgets/amount-input'\n import { MoneyDisplay } from './money-display'\n-import { ContractMetric } from 'common/contract-metric'\n-import { uniq } from 'lodash'\n-import { useUnfilledBetsAndBalanceByUserId } from 'client-common/hooks/use-bets'\n-import { useIsPageVisible } from 'web/hooks/use-page-visible'\n-import { getSaleResult, getSaleResultMultiSumsToOne } from 'common/sell-bet'\n \n export function SellPanel(props: {\n   contract: CPMMContract | MultiContract\n   metric: ContractMetric | undefined\n@@ -53,8 +53,9 @@\n       pseudonymName: string\n       pseudonymColor: string\n     }\n   }\n+  sellForUserId?: string // Admin-only: sell for another user\n }) {\n   const {\n     contract,\n     shares,\n@@ -62,8 +63,9 @@\n     metric,\n     user,\n     onSellSuccess,\n     answerId,\n+    sellForUserId,\n   } = props\n   const { outcomeType } = contract\n   const isPseudoNumeric = outcomeType === 'PSEUDO_NUMERIC'\n   const isStonk = outcomeType === 'STONK'\n@@ -151,8 +153,9 @@\n       outcome: sharesOutcome,\n       contractId: contract.id,\n       answerId,\n       deps: uniq(betDeps.current?.map((b) => b.userId)),\n+      sellForUserId,\n     })\n       .then(() => {\n         setIsSubmitting(false)\n         setWasSubmitted(true)\n"
        },
        {
          "path": "web/components/bet/sell-row.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/sell-row.tsx\n===================================================================\n--- web/components/bet/sell-row.tsx\t741081d (parent)\n+++ web/components/bet/sell-row.tsx\t96e0ba1 (commit)\n@@ -1,21 +1,21 @@\n import clsx from 'clsx'\n import { CPMMContract, MultiContract } from 'common/contract'\n+import { ContractMetric } from 'common/contract-metric'\n import { getStonkDisplayShares } from 'common/stonk'\n import { User } from 'common/user'\n import { formatShares } from 'common/util/format'\n import { useState } from 'react'\n+import { useAnswer } from 'web/hooks/use-answers'\n+import { useSavedContractMetrics } from 'web/hooks/use-saved-contract-metrics'\n import { Button } from '../buttons/button'\n import { Col } from '../layout/col'\n import { Modal } from '../layout/modal'\n import { Row } from '../layout/row'\n import { OutcomeLabel } from '../outcome-label'\n import { Title } from '../widgets/title'\n import { MoneyDisplay } from './money-display'\n import { SellPanel } from './sell-panel'\n-import { ContractMetric } from 'common/contract-metric'\n-import { useSavedContractMetrics } from 'web/hooks/use-saved-contract-metrics'\n-import { useAnswer } from 'web/hooks/use-answers'\n \n export function SellRow(props: {\n   contract: CPMMContract\n   user: User | null | undefined\n@@ -114,8 +114,9 @@\n       pseudonymName: string\n       pseudonymColor: string\n     }\n   }\n+  sellForUserId?: string // Admin-only: sell for another user\n }) {\n   const {\n     className,\n     contract,\n@@ -125,24 +126,31 @@\n     user,\n     setOpen,\n     answerId,\n     binaryPseudonym,\n+    sellForUserId,\n   } = props\n   const isStonk = contract.outcomeType === 'STONK'\n   const isCashContract = contract.token === 'CASH'\n   const { answer } = useAnswer(answerId)\n \n   return (\n     <Modal open={true} setOpen={setOpen}>\n       <Col className={clsx('bg-canvas-0 rounded-md px-8 py-6', className)}>\n-        <Title>Sell position</Title>\n+        <Title>\n+          {sellForUserId ? 'Admin: Sell user position' : 'Sell position'}\n+        </Title>\n \n         <div className=\"mb-6\">\n           {isStonk ? (\n-            <>You have {getStonkDisplayShares(contract, shares)} shares of </>\n+            <>\n+              {sellForUserId ? 'User has' : 'You have'}{' '}\n+              {getStonkDisplayShares(contract, shares)} shares of{' '}\n+            </>\n           ) : (\n             <>\n-              You have {formatShares(shares, isCashContract)} shares worth{' '}\n+              {sellForUserId ? 'User has' : 'You have'}{' '}\n+              {formatShares(shares, isCashContract)} shares worth{' '}\n               <MoneyDisplay amount={shares} isCashContract={isCashContract} />{' '}\n               if this {answerId ? 'answer' : 'question'} resolves{' '}\n             </>\n           )}\n@@ -164,8 +172,9 @@\n           metric={metric}\n           onSellSuccess={() => setOpen(false)}\n           answerId={answerId}\n           binaryPseudonym={binaryPseudonym}\n+          sellForUserId={sellForUserId}\n         />\n       </Col>\n     </Modal>\n   )\n"
        },
        {
          "path": "web/components/bet/user-bet-summary.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/user-bet-summary.tsx\n===================================================================\n--- web/components/bet/user-bet-summary.tsx\t741081d (parent)\n+++ web/components/bet/user-bet-summary.tsx\t96e0ba1 (commit)\n@@ -9,28 +9,31 @@\n   isBinaryMulti,\n } from 'common/contract'\n import { ContractMetric, getMaxSharesOutcome } from 'common/contract-metric'\n import { TRADE_TERM } from 'common/envs/constants'\n+import { noFees } from 'common/fees'\n import { User } from 'common/user'\n+import { formatPercent } from 'common/util/format'\n+import { useState } from 'react'\n+import { LuShare } from 'react-icons/lu'\n import { BinaryMultiSellRow } from 'web/components/answers/answer-components'\n import { MultiNumericSellPanel } from 'web/components/answers/numeric-sell-panel'\n import { SellRow } from 'web/components/bet/sell-row'\n+import { useAdmin } from 'web/hooks/use-admin'\n import { useSavedContractMetrics } from 'web/hooks/use-saved-contract-metrics'\n+import { useUser } from 'web/hooks/use-user'\n+import { useDisplayUserById } from 'web/hooks/use-user-supabase'\n+import { Button } from '../buttons/button'\n import { getWinningTweet, TweetButton } from '../buttons/tweet-button'\n+import { getPseudonym } from '../charts/contract/choice'\n import { Col } from '../layout/col'\n import { Row } from '../layout/row'\n import { NoLabel, YesLabel } from '../outcome-label'\n import { ProfitBadge } from '../profit-badge'\n import { InfoTooltip } from '../widgets/info-tooltip'\n import { MoneyDisplay } from './money-display'\n-import { useUser } from 'web/hooks/use-user'\n+import { SellSharesModal } from './sell-row'\n import { ShareBetModal } from './share-bet'\n-import { useState } from 'react'\n-import { Button } from '../buttons/button'\n-import { LuShare } from 'react-icons/lu'\n-import { getPseudonym } from '../charts/contract/choice'\n-import { formatPercent } from 'common/util/format'\n-import { useDisplayUserById } from 'web/hooks/use-user-supabase'\n \n export function UserBetsSummary(props: {\n   contract: Contract\n   initialMetrics?: ContractMetric\n@@ -61,8 +64,9 @@\n }) {\n   const { contract, metric, className, includeSellButton, areYourBets } = props\n   const { resolution, outcomeType } = contract\n   const [showShareModal, setShowShareModal] = useState(false)\n+  const [showAdminSellModal, setShowAdminSellModal] = useState(false)\n \n   const { payout, invested, totalShares = {}, profit, profitPercent } = metric\n \n   const maxSharesOutcome = getMaxSharesOutcome(metric)\n@@ -77,8 +81,9 @@\n   const mainBinaryMCAnswer = getMainBinaryMCAnswer(contract)\n   const prob = contract.mechanism === 'cpmm-1' ? getProbability(contract) : 0\n   const expectation = prob * yesWinnings + (1 - prob) * noWinnings\n   const user = useUser()\n+  const isAdmin = useAdmin()\n   const bettor = useDisplayUserById(metric.userId)\n \n   if (metric.invested === 0 && metric.profit === 0) return null\n \n@@ -277,8 +282,43 @@\n                 />\n               )}\n             </>\n           )}\n+        {/* Admin sell button - only show for admins viewing other users' bets */}\n+        {isAdmin &&\n+          user &&\n+          bettor &&\n+          !areYourBets &&\n+          !resolution &&\n+          maxSharesOutcome &&\n+          (yesWinnings > 1 || noWinnings > 1) &&\n+          contract.mechanism === 'cpmm-1' && (\n+            <>\n+              <Button\n+                className=\"h-10\"\n+                size={'lg'}\n+                color={'red-outline'}\n+                onClick={() => setShowAdminSellModal(true)}\n+              >\n+                Admin Sell\n+              </Button>\n+              {showAdminSellModal && (\n+                <SellSharesModal\n+                  contract={{\n+                    ...(contract as CPMMContract),\n+                    collectedFees:\n+                      (contract as CPMMContract).collectedFees ?? noFees,\n+                  }}\n+                  metric={metric}\n+                  user={user}\n+                  shares={Math.abs(position)}\n+                  sharesOutcome={maxSharesOutcome as 'YES' | 'NO'}\n+                  setOpen={setShowAdminSellModal}\n+                  sellForUserId={metric.userId}\n+                />\n+              )}\n+            </>\n+          )}\n         {resolution && resolution !== 'CANCEL' && (\n           <TweetButton\n             className=\"h-10\"\n             tweetText={getWinningTweet(profit, contract, user?.username ?? '')}\n"
        }
      ]
    },
    {
      "id": "url-driven-create",
      "sha": "9503363de950b4f8480be7d4cf271707d0b94a67",
      "parentSha": "9fe0f53fc081f8736069c4ab21943ef81e917d38",
      "spec": "Implement URL-parameter-driven navigation for the create page and synchronize question type selection with the URL.\n\nScope and required behaviors:\n1) ChoosingContractForm API change and selection logic\n- File: web/components/new-contract/choosing-contract-form.tsx\n- Change props for setOutcomeType to accept both outcomeType and shouldAnswersSumToOne at once: setOutcomeType(outcomeType: CreateableOutcomeType, shouldAnswersSumToOne: boolean) => void.\n- Remove the setShouldAnswersSumToOne prop entirely — the parent is now responsible for setting both values together.\n- In the outcome button onClick handler, call getOutcomeTypeAndSumsToOne(value) and forward both outcomeType and shouldSumToOne via setOutcomeType(outcomeType, shouldSumToOne), then transition to the next step.\n\n2) Multi-numeric date hint and link\n- File: web/components/new-contract/multi-numeric-range-section.tsx\n- Update the date hint string to: \"Date questions are better supported by the date question type.\" (note the period and wording).\n- Add a Link (from next/link) next to the hint that navigates to /create?type=date with label \"Switch to date question\" and standard link styling (primary color, hover underline).\n\n3) URL-driven state and routing in NewContractPanel\n- File: web/components/new-contract/new-contract-panel.tsx\n- Use next/router's useRouter and next/navigation's usePathname along with the existing useDefinedSearchParams hook to read and update the current URL query string.\n- Introduce helpers to map between URL type strings and internal types:\n  - getTypeFromUrl(typeParam: string | null) => { outcomeType: CreateableOutcomeType | undefined; shouldAnswersSumToOne: boolean | undefined }.\n  - getUrlFromType(outcomeType: CreateableOutcomeType | undefined, shouldAnswersSumToOne: boolean | undefined) => string | null.\n  - Mapping rules:\n    - For MULTIPLE_CHOICE: use 'dependent_multiple_choice' when shouldAnswersSumToOne is true; 'independent_multiple_choice' when false.\n    - For other types, use the lowercase of the ALL_CONTRACT_TYPES key (e.g., 'binary', 'poll', 'multi_numeric', 'date', etc.).\n- Initialization behavior:\n  - If props.params contains outcomeType, use it (duplication flow). Otherwise, if the URL has a valid 'type' param (per mapping above), initialize params.outcomeType and params.shouldAnswersSumToOne from the URL, and set the state to 'filling contract params'. If no type is present and no props-provided outcomeType exists, start in 'choosing contract' state.\n- Keep URL and local state synchronized:\n  - When the user selects a type (from ChoosingContractForm) or accepts an AI suggestion, set both params.outcomeType and params.shouldAnswersSumToOne, then update the URL 'type' parameter accordingly using shallow routing; preserve any existing query parameters.\n  - When the URL 'type' parameter changes (e.g., via back/forward navigation), update params/outcomeType/shouldAnswersSumToOne to match and set the state to 'filling contract params'. If 'type' is removed from the URL and no props.params.outcomeType exists, clear the type-related params and return to 'choosing contract'.\n- Navigation behavior:\n  - Replace usages of Router.push with router.push.\n  - Provide a clearTypeAndGoBackToChoosing function that:\n    - Clears local state params (including type-related ones),\n    - Clears all URL query parameters (push pathName with no search params, shallow),\n    - Sets the state to 'choosing contract'.\n  - Pass clearTypeAndGoBackToChoosing into CreateStepTracker, and invoke it when clicking back to \"Choose question type\" or when exiting \"AI Assistant\" to choose type again.\n- Update prop wiring:\n  - Pass ChoosingContractForm the updated setOutcomeType function signature.\n  - Remove setShouldAnswersSumToOne prop from ChoosingContractForm usage.\n\n4) Parse initial params from URL on the page\n- File: web/pages/create.tsx\n- Continue to use the useDefinedSearchParams hook.\n- Replace the existing broad JSON parsing of all query params. Instead, read a single 'params' query param if present and JSON.parse it into NewQuestionParams. If absent or parsing fails, pass an empty object.\n- Do not derive outcomeType from 'params'; the type is handled by NewContractPanel via the 'type' URL parameter. Keep the effect that updates local params when 'params' changes and ignore if empty.\n\nConstraints and design notes:\n- Use the existing ALL_CONTRACT_TYPES and getOutcomeTypeAndSumsToOne from web/components/new-contract/create-contract-types.tsx for mapping.\n- Maintain shallow routing on URL updates to avoid full page reloads.\n- Preserve non-type query parameters when setting 'type' via selection or AI suggestion, but clear all query parameters when returning to 'choosing contract'.\n- Ensure CreateStepTracker renders the correct label for the selected type using getContractTypeFromValue, unchanged aside from its back-navigation behavior.\n- No changes to API calls or backend behavior are required; only client routing/state/UI updates per above.",
      "prompt": "Make the create question flow URL-parameter driven. When a user selects a question type or accepts an AI suggestion, reflect the selection in the URL via a 'type' query parameter and keep the UI in sync with it, including support for back/forward navigation. Handle multiple choice variants as distinct URL types depending on whether answers should sum to one. If there's a 'type' in the URL when the page loads, preselect that type and show the appropriate form. Provide a clear way to revert to the type selection step that clears the URL query and local type state. Also, simplify parsing of initial values on the create page to read a single JSON-encoded 'params' query parameter, leaving type handling to the panel. Lastly, improve the hint for date-like questions in the numeric range section and add a link to switch to a date question.",
      "supplementalFiles": [
        "web/components/new-contract/create-contract-types.tsx",
        "web/hooks/use-defined-search-params.ts",
        "web/components/new-contract/ai-market-suggestions-panel.tsx",
        "web/components/new-contract/contract-params-form.tsx",
        "common/src/contract.ts"
      ],
      "fileDiffs": [
        {
          "path": "web/components/new-contract/choosing-contract-form.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/choosing-contract-form.tsx\n===================================================================\n--- web/components/new-contract/choosing-contract-form.tsx\t9fe0f53 (parent)\n+++ web/components/new-contract/choosing-contract-form.tsx\t9503363 (commit)\n@@ -11,20 +11,16 @@\n import { CreateContractStateType } from './new-contract-panel'\n \n export function ChoosingContractForm(props: {\n   outcomeType: CreateableOutcomeType | undefined\n-  setOutcomeType: (outcomeType: CreateableOutcomeType) => void\n+  setOutcomeType: (\n+    outcomeType: CreateableOutcomeType,\n+    shouldAnswersSumToOne: boolean\n+  ) => void\n   shouldAnswersSumToOne: boolean | undefined\n-  setShouldAnswersSumToOne: (shouldAnswersSumToOne: boolean) => void\n   setState: (state: CreateContractStateType) => void\n }) {\n-  const {\n-    outcomeType,\n-    setOutcomeType,\n-    shouldAnswersSumToOne,\n-    setShouldAnswersSumToOne,\n-    setState,\n-  } = props\n+  const { outcomeType, setOutcomeType, shouldAnswersSumToOne, setState } = props\n \n   return (\n     <Col>\n       <div className=\"text-lg\">Or, create manually from a template:</div>\n@@ -47,10 +43,9 @@\n               shouldAnswersSumToOne={shouldAnswersSumToOne}\n               onClick={() => {\n                 const { outcomeType, shouldSumToOne } =\n                   getOutcomeTypeAndSumsToOne(value)\n-                setShouldAnswersSumToOne(shouldSumToOne)\n-                setOutcomeType(outcomeType)\n+                setOutcomeType(outcomeType, shouldSumToOne)\n                 setState('filling contract params')\n               }}\n             />\n           )\n"
        },
        {
          "path": "web/components/new-contract/multi-numeric-range-section.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/multi-numeric-range-section.tsx\n===================================================================\n--- web/components/new-contract/multi-numeric-range-section.tsx\t9fe0f53 (parent)\n+++ web/components/new-contract/multi-numeric-range-section.tsx\t9503363 (commit)\n@@ -1,8 +1,9 @@\n import { XIcon } from '@heroicons/react/solid'\n import { MAX_MULTI_NUMERIC_ANSWERS } from 'common/multi-numeric'\n import { formatMoney } from 'common/util/format'\n import { debounce } from 'lodash'\n+import Link from 'next/link'\n import { useCallback, useEffect, useState } from 'react'\n import { Col } from 'web/components/layout/col'\n import { Row } from 'web/components/layout/row'\n import { InfoTooltip } from 'web/components/widgets/info-tooltip'\n@@ -230,9 +231,11 @@\n     }\n   }\n   useEffect(() => {\n     if (question.toLowerCase().includes('when')) {\n-      setDateError('Date questions are better supported by the date question')\n+      setDateError(\n+        'Date questions are better supported by the date question type.'\n+      )\n     } else {\n       setDateError('')\n     }\n   }, [question])\n@@ -326,9 +329,17 @@\n   return (\n     <Col>\n       <Row className={'flex-wrap gap-x-4'}>\n         {dateError && (\n-          <div className=\"text-scarlet-500 text-sm\">{dateError}</div>\n+          <div className=\"text-scarlet-500 text-sm\">\n+            {dateError}{' '}\n+            <Link\n+              href=\"/create?type=date\"\n+              className=\"text-primary-700 hover:underline\"\n+            >\n+              Switch to date question\n+            </Link>\n+          </div>\n         )}\n         <Col className=\"mb-2 items-start\">\n           <Row className=\" items-baseline gap-1 px-1 py-2\">\n             <span className=\"\">Range & metric</span>\n"
        },
        {
          "path": "web/components/new-contract/new-contract-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/new-contract-panel.tsx\n===================================================================\n--- web/components/new-contract/new-contract-panel.tsx\t9fe0f53 (parent)\n+++ web/components/new-contract/new-contract-panel.tsx\t9503363 (commit)\n@@ -1,31 +1,35 @@\n+import { ChevronRightIcon } from '@heroicons/react/solid'\n import clsx from 'clsx'\n+import { usePathname } from 'next/navigation'\n+import { useRouter } from 'next/router'\n import { ReactNode, useEffect, useState } from 'react'\n-import { ChevronRightIcon } from '@heroicons/react/solid'\n-import { User } from 'common/user'\n+\n+import { DocumentTextIcon } from '@heroicons/react/outline'\n import {\n   AIGeneratedMarket,\n   CreateableOutcomeType,\n   add_answers_mode,\n } from 'common/contract'\n+import { User } from 'common/user'\n+import { WEEK_MS } from 'common/util/time'\n+import { capitalize } from 'lodash'\n+import { FaMagic, FaQuestion, FaUsers } from 'react-icons/fa'\n+import { ExpandSection } from 'web/components/explainer-panel'\n+import { useDefinedSearchParams } from 'web/hooks/use-defined-search-params'\n+import { track } from 'web/lib/service/analytics'\n+import { Button } from '../buttons/button'\n import { Col } from '../layout/col'\n import { Row } from '../layout/row'\n+import { Spacer } from '../layout/spacer'\n+import { AIMarketSuggestionsPanel } from './ai-market-suggestions-panel'\n import { ChoosingContractForm } from './choosing-contract-form'\n import { ContractParamsForm } from './contract-params-form'\n import {\n-  getOutcomeTypeAndSumsToOne,\n+  ALL_CONTRACT_TYPES,\n   getContractTypeFromValue,\n+  getOutcomeTypeAndSumsToOne,\n } from './create-contract-types'\n-import { capitalize } from 'lodash'\n-import { track } from 'web/lib/service/analytics'\n-import { FaMagic, FaQuestion, FaUsers } from 'react-icons/fa'\n-import { ExpandSection } from 'web/components/explainer-panel'\n-import { AIMarketSuggestionsPanel } from './ai-market-suggestions-panel'\n-import { Button } from '../buttons/button'\n-import { Spacer } from '../layout/spacer'\n-import { WEEK_MS } from 'common/util/time'\n-import Router from 'next/router'\n-import { DocumentTextIcon } from '@heroicons/react/outline'\n \n export type NewQuestionParams = {\n   groupIds?: string[]\n   groupSlugs?: string[]\n@@ -56,19 +60,94 @@\n   | 'choosing contract'\n   | 'filling contract params'\n   | 'ai chat'\n \n+// Helper to convert between URL type param and outcomeType + shouldAnswersSumToOne\n+type QuestionTypeKey = keyof typeof ALL_CONTRACT_TYPES\n+\n+function getTypeFromUrl(typeParam: string | null): {\n+  outcomeType: CreateableOutcomeType | undefined\n+  shouldAnswersSumToOne: boolean | undefined\n+} {\n+  if (!typeParam)\n+    return { outcomeType: undefined, shouldAnswersSumToOne: undefined }\n+\n+  const upperType = typeParam.toUpperCase() as QuestionTypeKey\n+  if (upperType in ALL_CONTRACT_TYPES) {\n+    const { outcomeType, shouldSumToOne } =\n+      getOutcomeTypeAndSumsToOne(upperType)\n+    return { outcomeType, shouldAnswersSumToOne: shouldSumToOne }\n+  }\n+\n+  return { outcomeType: undefined, shouldAnswersSumToOne: undefined }\n+}\n+\n+function getUrlFromType(\n+  outcomeType: CreateableOutcomeType | undefined,\n+  shouldAnswersSumToOne: boolean | undefined\n+): string | null {\n+  if (!outcomeType) return null\n+\n+  if (outcomeType === 'MULTIPLE_CHOICE') {\n+    return shouldAnswersSumToOne\n+      ? 'dependent_multiple_choice'\n+      : 'independent_multiple_choice'\n+  }\n+\n+  // Find matching type in ALL_CONTRACT_TYPES\n+  const matchingType = Object.entries(ALL_CONTRACT_TYPES).find(\n+    ([_, config]) => {\n+      if (config.outcomeType !== outcomeType) return false\n+      if ('shouldSumToOne' in config) {\n+        return config.shouldSumToOne === shouldAnswersSumToOne\n+      }\n+      return true\n+    }\n+  )\n+\n+  return matchingType ? matchingType[0].toLowerCase() : null\n+}\n+\n // Allow user to create a new contract\n export function NewContractPanel(props: {\n   creator: User\n   params?: NewQuestionParams\n }) {\n   const { creator } = props\n+  const router = useRouter()\n+  const pathName = usePathname()\n+  const { searchParams } = useDefinedSearchParams()\n+\n+  // Get type from URL\n+  const urlType = searchParams.get('type')\n+  const typeFromUrl = getTypeFromUrl(urlType)\n+\n+  // Initialize params with URL type if present, or props.params\n   const [params, setParams] = useState<Partial<NewQuestionParams> | undefined>(\n-    props.params\n+    () => {\n+      if (props.params?.outcomeType) {\n+        return props.params\n+      } else if (typeFromUrl.outcomeType) {\n+        return {\n+          ...props.params,\n+          outcomeType: typeFromUrl.outcomeType,\n+          shouldAnswersSumToOne: typeFromUrl.shouldAnswersSumToOne,\n+        }\n+      }\n+      return props.params\n+    }\n   )\n+\n+  const [state, setState] = useState<CreateContractStateType>(() => {\n+    if (props.params?.outcomeType || typeFromUrl.outcomeType) {\n+      return 'filling contract params'\n+    }\n+    return 'choosing contract'\n+  })\n+\n+  // Update params when props.params changes (for duplicate functionality)\n   useEffect(() => {\n-    if (props.params) {\n+    if (props.params && Object.keys(props.params).length > 0) {\n       setParams(props.params)\n       setState(\n         props.params.outcomeType\n           ? 'filling contract params'\n@@ -76,15 +155,69 @@\n       )\n     }\n   }, [props.params])\n \n-  const [state, setState] = useState<CreateContractStateType>(\n-    params?.outcomeType ? 'filling contract params' : 'choosing contract'\n-  )\n+  // Update state when URL type parameter changes (for back/forward navigation)\n+  useEffect(() => {\n+    const typeFromUrl = getTypeFromUrl(searchParams.get('type'))\n+\n+    if (typeFromUrl.outcomeType) {\n+      // URL has a type - show that type\n+      setParams((prev) => ({\n+        ...(prev ?? {}),\n+        outcomeType: typeFromUrl.outcomeType,\n+        shouldAnswersSumToOne: typeFromUrl.shouldAnswersSumToOne,\n+      }))\n+      setState('filling contract params')\n+    } else if (!searchParams.get('type') && !props.params?.outcomeType) {\n+      // No type in URL and no params from props - go back to choosing\n+      setParams((prev) => {\n+        if (!prev) return prev\n+        const {\n+          outcomeType: _outcomeType,\n+          shouldAnswersSumToOne: _shouldAnswersSumToOne,\n+          ...rest\n+        } = prev\n+        return Object.keys(rest).length > 0 ? rest : undefined\n+      })\n+      setState('choosing contract')\n+    }\n+  }, [searchParams, props.params?.outcomeType])\n+\n   const setKeyOnParams = (key: keyof NewQuestionParams, value: any) => {\n     setParams((prev) => ({ ...(prev ?? {}), [key]: value }))\n   }\n \n+  // Update URL when outcomeType changes\n+  const setOutcomeTypeWithUrl = (\n+    outcomeType: CreateableOutcomeType,\n+    shouldAnswersSumToOne: boolean\n+  ) => {\n+    setKeyOnParams('outcomeType', outcomeType)\n+    setKeyOnParams('shouldAnswersSumToOne', shouldAnswersSumToOne)\n+\n+    const urlType = getUrlFromType(outcomeType, shouldAnswersSumToOne)\n+    if (urlType) {\n+      // Preserve existing params (like duplicate question params) and add/update type\n+      const newParams = new URLSearchParams(searchParams as any)\n+      newParams.set('type', urlType)\n+      const newUrl = pathName + '?' + newParams.toString()\n+      router.push(newUrl, undefined, { shallow: true })\n+    }\n+  }\n+\n+  // Clear all URL parameters and local state when going back to choosing\n+  const clearTypeAndGoBackToChoosing = () => {\n+    // Clear all params from local state\n+    setParams(undefined)\n+\n+    // Clear all URL parameters (use push to preserve history)\n+    router.push(pathName, undefined, { shallow: true })\n+\n+    // Set state to choosing\n+    setState('choosing contract')\n+  }\n+\n   // Add function to handle AI suggestions\n   const handleAISuggestion = (m: AIGeneratedMarket) => {\n     const { outcomeType, shouldSumToOne } = getOutcomeTypeAndSumsToOne(\n       m.outcomeType\n@@ -99,8 +232,9 @@\n       shouldAnswersSumToOne: shouldSumToOne,\n       addAnswersMode: m.addAnswersMode,\n       overrideKey: '',\n     })\n+    setOutcomeTypeWithUrl(outcomeType, shouldSumToOne)\n     setState('filling contract params')\n   }\n \n   return (\n@@ -113,8 +247,9 @@\n         outcomeType={params?.outcomeType}\n         shouldAnswersSumToOne={params?.shouldAnswersSumToOne}\n         setState={setState}\n         state={state}\n+        clearTypeAndGoBackToChoosing={clearTypeAndGoBackToChoosing}\n       />\n       <Col className={clsx('px-6 py-2')}>\n         {state == 'choosing contract' && (\n           <>\n@@ -139,22 +274,19 @@\n             </Button>\n             <Spacer h={4} />\n             <ChoosingContractForm\n               outcomeType={params?.outcomeType}\n-              setOutcomeType={(outcomeType) => {\n-                setKeyOnParams('outcomeType', outcomeType)\n+              setOutcomeType={(outcomeType, shouldAnswersSumToOne) => {\n+                setOutcomeTypeWithUrl(outcomeType, shouldAnswersSumToOne)\n               }}\n               shouldAnswersSumToOne={params?.shouldAnswersSumToOne}\n-              setShouldAnswersSumToOne={(bool) => {\n-                setKeyOnParams('shouldAnswersSumToOne', bool)\n-              }}\n               setState={setState}\n             />\n             <Spacer h={2} />\n             <Button\n               className=\"hover:ring-primary-200 bg-primary-600/5 cursor-pointer rounded-lg px-4 py-2 text-left transition-all hover:ring-2\"\n               color=\"none\"\n-              onClick={() => Router.push('/create-post')}\n+              onClick={() => router.push('/create-post')}\n             >\n               <Row className=\"4 w-full justify-start  gap-3\">\n                 <DocumentTextIcon className=\"h-14 w-14 self-center text-cyan-600\" />\n                 <Col className=\"w-full items-start gap-0.5\">\n@@ -190,10 +322,17 @@\n   outcomeType: CreateableOutcomeType | undefined\n   shouldAnswersSumToOne: boolean | undefined\n   setState: (state: CreateContractStateType) => void\n   state: CreateContractStateType\n+  clearTypeAndGoBackToChoosing: () => void\n }) {\n-  const { outcomeType, shouldAnswersSumToOne, setState, state } = props\n+  const {\n+    outcomeType,\n+    shouldAnswersSumToOne,\n+    setState,\n+    state,\n+    clearTypeAndGoBackToChoosing,\n+  } = props\n   const outcomeKey =\n     outcomeType == 'MULTIPLE_CHOICE'\n       ? shouldAnswersSumToOne\n         ? 'DEPENDENT_MULTIPLE_CHOICE'\n@@ -205,16 +344,22 @@\n         'text-ink-400 bg-canvas-0 border-1 border-ink-200 sticky z-10 w-full items-center gap-1 border-b pb-2 pt-4',\n         'top-0 px-6'\n       )}\n     >\n-      <CreateStepButton onClick={() => setState('choosing contract')}>\n+      <CreateStepButton\n+        onClick={() => {\n+          clearTypeAndGoBackToChoosing()\n+        }}\n+      >\n         Choose question type\n       </CreateStepButton>\n       <ChevronRightIcon className={clsx('h-5 w-5')} />\n       {state === 'ai chat' ? (\n         <CreateStepButton\n           disabled={false}\n-          onClick={() => setState('choosing contract')}\n+          onClick={() => {\n+            clearTypeAndGoBackToChoosing()\n+          }}\n         >\n           AI Assistant\n         </CreateStepButton>\n       ) : (\n"
        },
        {
          "path": "web/pages/create.tsx",
          "status": "modified",
          "diff": "Index: web/pages/create.tsx\n===================================================================\n--- web/pages/create.tsx\t9fe0f53 (parent)\n+++ web/pages/create.tsx\t9503363 (commit)\n@@ -1,33 +1,34 @@\n 'use client'\n+import { useEffect, useState } from 'react'\n import { Page } from 'web/components/layout/page'\n import {\n   NewContractPanel,\n   NewQuestionParams,\n } from 'web/components/new-contract/new-contract-panel'\n import { Title } from 'web/components/widgets/title'\n+import { useDefinedSearchParams } from 'web/hooks/use-defined-search-params'\n import { useRedirectIfSignedOut } from 'web/hooks/use-redirect-if-signed-out'\n import { useUser } from 'web/hooks/use-user'\n-import { useDefinedSearchParams } from 'web/hooks/use-defined-search-params'\n-import { useEffect, useState } from 'react'\n \n export default function Create() {\n   useRedirectIfSignedOut()\n \n   const user = useUser()\n   const { searchParams } = useDefinedSearchParams()\n-  const paramsEntries = Object.fromEntries(searchParams.entries())\n \n   function getURLParams() {\n     try {\n-      return searchParams\n-        ? (Object.fromEntries(\n-            Object.keys(paramsEntries).map((key) => [\n-              key,\n-              JSON.parse(paramsEntries[key] || 'null'),\n-            ])\n-          ).params as NewQuestionParams)\n-        : ({} as NewQuestionParams)\n+      if (!searchParams) return {} as NewQuestionParams\n+\n+      // If there's a 'params' query parameter, it contains JSON-encoded question params\n+      const paramsString = searchParams.get('params')\n+      if (paramsString) {\n+        return JSON.parse(paramsString) as NewQuestionParams\n+      }\n+\n+      // Otherwise return empty params (the 'type' parameter is handled separately in NewContractPanel)\n+      return {} as NewQuestionParams\n     } catch (error) {\n       console.error('Error parsing URL params:', error)\n       return {} as NewQuestionParams\n     }\n"
        }
      ]
    },
    {
      "id": "fix-multi-bet",
      "sha": "1f350619c811ff8d251a5f281147d88d23b5a212",
      "parentSha": "3ff3df4028ee087feea971f8d1720992bd966eed",
      "spec": "Implement correct handling for multi-buys across sums-to-one multiple-choice markets and propagate the new execution semantics throughout the backend, common logic, and docs.\n\nScope and required changes:\n\n1) Add isMultiBet execution mode to place-bet flow\n- File: backend/api/src/place-bet.ts\n  - Change executeNewBetResult to accept a new boolean parameter isMultiBet (final argument).\n  - Replace existing number-contract checks with isMultiBet so that:\n    - Unique bettor bonus logic only applies on firstBetInMultiBet when isMultiBet is true; otherwise behaves as current single-bet flow.\n    - For isMultiBet and not firstBetInMultiBet, fetch updated contract metrics for the user (getContractMetrics) after bet insertion to reflect multi-leg progress before building response.\n    - Broadcast user updates and contract/answer updates from executeNewBetResult when isMultiBet is true (previously done in on-create-bet for other contracts). Maintain existing behavior for non-multi.\n  - Ensure ordering of existing parameters remains unchanged and add the new parameter at the end: (silent?: boolean, isMultiBet?: boolean).\n\n2) Update all executeNewBetResult call sites\n- File: backend/api/src/place-multi-bet.ts\n  - In the per-leg loop, pass: firstBetInMultiBet = i === 0, silent = false, isMultiBet = true.\n- File: backend/api/src/multi-sell.ts\n  - In the per-leg loop, pass: firstBetInMultiBet = false, silent = false, isMultiBet = true.\n- File: backend/api/src/sell-shares.ts (or equivalent single-sell execution path)\n  - Update any call to executeNewBetResult to pass isMultiBet = false (and keep existing flags consistent). Verify all other callsites compile with the new signature.\n\n3) Correct multi-bet arbitrage computation to avoid order/balance reuse and over-spend\n- File: common/src/calculate-cpmm-arbitrage.ts\n  - Introduce working copies of unfilledBetsByAnswer and balanceByUserId that are mutated between legs to ensure subsequent legs cannot reuse previously consumed maker order capacity or maker balances.\n  - Add a helper applyMakersToWorkingState(makers, ordersToCancel, workingUnfilledBetsByAnswer, workingBalanceByUserId) to:\n    - Deduct maker amounts from maker balances used in fills.\n    - Update per-order filled amount/shares in workingUnfilledBetsByAnswer.\n    - Remove orders that are canceled.\n  - Annotate PreliminaryBetResults with an iteration index (0 for the first leg consuming user funds; >0 for arbitrage legs paid by extraMana) so downstream aggregation can mark later taker fills as free.\n  - Update getBetResultsAndUpdatedAnswers to mutate and return updated workingUnfilledBetsByAnswer and workingBalanceByUserId after both YES and NO legs; callers carry these across iterations in calculateCpmmMultiArbitrageYesBets.\n  - Update calculateCpmmMultiArbitrageYesBets to:\n    - Maintain and pass working maps across each iteration; set iteration on each leg’s results.\n    - Ensure total consumer spend (sum of taker.amount across all YES legs in the first iteration only) does not exceed the provided initialBetAmount.\n  - Update combineBetsOnSameAnswers to, when fillsFollowingFirstAreFree is true, set amount=0 and fees=noFees for taker fills originating from iterations > 0, while still summing shares so probabilities update correctly.\n  - Update buyNoSharesUntilAnswersSumToOne so the binary search path does not mutate the working orders/balances (updateOrders=false), and only the final execution path mutates them (updateOrders=true).\n  - Update buyNoSharesInAnswers to process answers sequentially, applying makers to the working state between answers when updateOrders is true.\n\n4) Extend unit tests for arbitrage correctness\n- File: common/src/calculate-cpmm-arbitrage.test.ts\n  - Add a test asserting that total user taker amount across multi-buy answers does not exceed the provided bet amount.\n  - Add a test ensuring that maker limit orders are not overfilled during multi-buy across multiple answers (filled <= orderAmount per bet).\n\n5) Document public API for multi-buys\n- File: docs/docs/api.md\n  - Add a new section documenting POST /v0/multi-bet for sums-to-one multiple choice markets, including parameters (contractId, answerIds, amount, limitProb, expiresAt), behavior (YES only; equal shares target; per-leg limit price; internal arbitrage not returned), and an example request/response.\n  - Clarify that the response returns one Bet-like object per selected answer, with betId and betGroupId fields included.\n\nAcceptance criteria:\n- Type-checks pass; all executeNewBetResult callsites compile with the new parameter.\n- New tests in calculate-cpmm-arbitrage.test.ts pass and existing tests remain green.\n- In multi-bet execution, user-charged amount across YES legs never exceeds the provided amount; subsequent arbitrage legs are free (amount=0, no fees) but still move probability via shares.\n- Maker limit orders are not overfilled across legs; balances and order capacity are updated as legs execute.\n- Unique bettor bonus and metrics/broadcasting behavior are correct for multi-bet (bonus only on first leg; broadcasting handled within executeNewBetResult for multi-bet).\n- API docs include the new /v0/multi-bet endpoint with clear parameters and example.",
      "prompt": "Implement correct multi-buy behavior for sums-to-one multiple-choice CPMM markets and expose it via a new multi-bet API endpoint. Ensure that placing a multi-bet splits across selected answers to target equal shares, spends no more than the provided amount, and prevents overfilling maker limit orders across legs. Only charge taker fees on the first leg; subsequent arbitrage legs should be free for the taker but still move probabilities. Update the bet execution path to support a multi-bet mode that adjusts bonus, metrics, and broadcasting behavior across legs. Update all internal call sites to the execution function to pass the new multi-bet flag, and add API documentation and tests verifying spend caps and order overfill prevention.",
      "supplementalFiles": [
        "common/src/calculate-cpmm.ts",
        "common/src/fees.ts",
        "common/src/bet.ts",
        "common/src/contract.ts",
        "common/src/new-bet.ts",
        "backend/api/src/helpers/bets.ts",
        "shared/helpers/user-contract-metrics.ts",
        "shared/helpers/fn-queue.ts",
        "shared/websockets/helpers.ts",
        "shared/supabase/bets.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/multi-sell.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/multi-sell.ts\n===================================================================\n--- backend/api/src/multi-sell.ts\t3ff3df4 (parent)\n+++ backend/api/src/multi-sell.ts\t1f35061 (commit)\n@@ -1,17 +1,17 @@\n-import * as crypto from 'crypto'\n-import { APIError, type APIHandler } from './helpers/endpoint'\n+import { getUnfilledBetsAndUserBalances } from 'api/helpers/bets'\n import { onCreateBets } from 'api/on-create-bet'\n import { executeNewBetResult } from 'api/place-bet'\n-import { getContract, getUser, log } from 'shared/utils'\n-import { groupBy, keyBy, mapValues, sumBy } from 'lodash'\n+import { isSummary } from 'common/contract-metric'\n import { getCpmmMultiSellSharesInfo } from 'common/sell-bet'\n-import { runTransactionWithRetries } from 'shared/transact-with-retries'\n import { convertBet } from 'common/supabase/bets'\n+import * as crypto from 'crypto'\n+import { groupBy, keyBy, mapValues, sumBy } from 'lodash'\n import { betsQueue } from 'shared/helpers/fn-queue'\n import { getContractMetrics } from 'shared/helpers/user-contract-metrics'\n-import { getUnfilledBetsAndUserBalances } from 'api/helpers/bets'\n-import { isSummary } from 'common/contract-metric'\n+import { runTransactionWithRetries } from 'shared/transact-with-retries'\n+import { getContract, getUser, log } from 'shared/utils'\n+import { APIError, type APIHandler } from './helpers/endpoint'\n \n export const multiSell: APIHandler<'multi-sell'> = async (props, auth, req) => {\n   return await betsQueue.enqueueFn(\n     () => multiSellMain(props, auth, req),\n@@ -115,9 +115,11 @@\n         balancesByUserId,\n         undefined,\n         betGroupId,\n         deterministic,\n-        false\n+        false,\n+        false,\n+        true\n       )\n       results.push(result)\n     }\n     return results\n"
        },
        {
          "path": "backend/api/src/place-bet.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/place-bet.ts\n===================================================================\n--- backend/api/src/place-bet.ts\t3ff3df4 (parent)\n+++ backend/api/src/place-bet.ts\t1f35061 (commit)\n@@ -1,23 +1,48 @@\n-import { first, isEqual, maxBy, sumBy } from 'lodash'\n-import { APIError, AuthedUser, type APIHandler } from './helpers/endpoint'\n+import {\n+  fetchContractBetDataAndValidate,\n+  getMakerIdsFromBetResult,\n+  getRoundedLimitProb,\n+  getUniqueBettorBonusQuery,\n+  getUserBalancesAndMetrics,\n+  updateMakers,\n+} from 'api/helpers/bets'\n+import { onCreateBets } from 'api/on-create-bet'\n+import { Answer } from 'common/answer'\n+import { ValidatedAPIParams } from 'common/api/schema'\n+import { Bet, getNewBetId, LimitBet, maker } from 'common/bet'\n+import { CpmmState, getCpmmProbability } from 'common/calculate-cpmm'\n import { CPMM_MIN_POOL_QTY, MarketContract } from 'common/contract'\n-import { User } from 'common/user'\n+import { ContractMetric } from 'common/contract-metric'\n+import { FLAT_TRADE_FEE } from 'common/fees'\n import {\n   BetInfo,\n   CandidateBet,\n   getBinaryCpmmBetInfo,\n   getNewMultiCpmmBetInfo,\n } from 'common/new-bet'\n-import { removeUndefinedProps } from 'common/util/object'\n-import { Bet, getNewBetId, LimitBet, maker } from 'common/bet'\n+import { convertBet } from 'common/supabase/bets'\n+import { convertContract } from 'common/supabase/contracts'\n+import { convertTxn } from 'common/supabase/txns'\n+import { UniqueBettorBonusTxn } from 'common/txn'\n+import { User } from 'common/user'\n+import { filterDefined } from 'common/util/array'\n import { EPSILON, floatingEqual } from 'common/util/math'\n-import { log } from 'shared/utils'\n-import { Answer } from 'common/answer'\n-import { CpmmState, getCpmmProbability } from 'common/calculate-cpmm'\n-import { ValidatedAPIParams } from 'common/api/schema'\n-import { onCreateBets } from 'api/on-create-bet'\n+import { removeUndefinedProps } from 'common/util/object'\n+import { first, isEqual, maxBy, sumBy } from 'lodash'\n+import { betsQueue, ordersQueue } from 'shared/helpers/fn-queue'\n import {\n+  bulkUpdateContractMetricsQuery,\n+  bulkUpdateUserMetricsWithNewBetsOnly,\n+  getContractMetrics,\n+} from 'shared/helpers/user-contract-metrics'\n+import { partialAnswerToRow } from 'shared/supabase/answers'\n+import {\n+  bulkInsertBetsQuery,\n+  cancelLimitOrdersQuery,\n+  insertZeroAmountLimitBet,\n+} from 'shared/supabase/bets'\n+import {\n   createSupabaseDirectClient,\n   SupabaseTransaction,\n } from 'shared/supabase/init'\n import {\n@@ -25,42 +50,17 @@\n   bulkIncrementBalancesQuery,\n   incrementStreakQuery,\n   UserUpdate,\n } from 'shared/supabase/users'\n-import { convertBet } from 'common/supabase/bets'\n+import { bulkUpdateQuery, updateDataQuery } from 'shared/supabase/utils'\n+import { runTransactionWithRetries } from 'shared/transact-with-retries'\n+import { log } from 'shared/utils'\n import {\n-  bulkInsertBetsQuery,\n-  cancelLimitOrdersQuery,\n-  insertZeroAmountLimitBet,\n-} from 'shared/supabase/bets'\n-import { betsQueue, ordersQueue } from 'shared/helpers/fn-queue'\n-import { FLAT_TRADE_FEE } from 'common/fees'\n-import { redeemShares } from './redeem-shares'\n-import { partialAnswerToRow } from 'shared/supabase/answers'\n-import { filterDefined } from 'common/util/array'\n-import { convertContract } from 'common/supabase/contracts'\n-import { UniqueBettorBonusTxn } from 'common/txn'\n-import {\n-  bulkUpdateContractMetricsQuery,\n-  bulkUpdateUserMetricsWithNewBetsOnly,\n-  getContractMetrics,\n-} from 'shared/helpers/user-contract-metrics'\n-import { ContractMetric } from 'common/contract-metric'\n-import {\n   broadcastUpdatedAnswers,\n   broadcastUpdatedContract,\n } from 'shared/websockets/helpers'\n-import { bulkUpdateQuery, updateDataQuery } from 'shared/supabase/utils'\n-import { convertTxn } from 'common/supabase/txns'\n-import {\n-  fetchContractBetDataAndValidate,\n-  getMakerIdsFromBetResult,\n-  getRoundedLimitProb,\n-  getUniqueBettorBonusQuery,\n-  getUserBalancesAndMetrics,\n-  updateMakers,\n-} from 'api/helpers/bets'\n-import { runTransactionWithRetries } from 'shared/transact-with-retries'\n+import { APIError, AuthedUser, type APIHandler } from './helpers/endpoint'\n+import { redeemShares } from './redeem-shares'\n \n export const placeBet: APIHandler<'bet'> = async (props, auth) => {\n   const isApi = auth.creds.kind === 'key'\n   const { deps, contractId, dryRun } = props\n@@ -332,9 +332,10 @@\n   replyToCommentId?: string,\n   betGroupId?: string,\n   deterministic?: boolean,\n   firstBetInMultiBet?: boolean,\n-  silent?: boolean\n+  silent?: boolean,\n+  isMultiBet?: boolean\n ) => {\n   const {\n     newBet,\n     otherBetResults,\n@@ -396,9 +397,8 @@\n       answerUpdates: undefined,\n       updatedMakers: [],\n     }\n   }\n-  const isNumberContract = contract.outcomeType === 'NUMBER'\n   const apiFee = isApi ? FLAT_TRADE_FEE : 0\n   const betsToInsert: Bet[] = [candidateBet]\n   const allOrdersToCancel: LimitBet[] = filterDefined(ordersToCancel ?? [])\n   const userBalanceUpdates = [\n@@ -420,9 +420,9 @@\n   const sumsToOne =\n     contract.mechanism === 'cpmm-multi-1' && contract.shouldAnswersSumToOne\n   let bonusTxnQuery = 'select 1 where false'\n   if (\n-    (!isNumberContract || firstBetInMultiBet) &&\n+    (!isMultiBet || firstBetInMultiBet) &&\n     !contractMetrics.find(\n       (m) =>\n         m.userId === user.id &&\n         (sumsToOne ? true : m.answerId == candidateBet.answerId)\n@@ -477,9 +477,9 @@\n     )\n     betsToInsert.push(...otherBetsToInsert)\n   }\n   const isUniqueBettor =\n-    (!isNumberContract || firstBetInMultiBet) &&\n+    (!isMultiBet || firstBetInMultiBet) &&\n     !contractMetrics.find((m) => m.userId === user.id)\n   const lastBetTime =\n     maxBy(betsToInsert, (b) => b.createdTime)?.createdTime ?? Date.now()\n   const contractUpdate: Partial<MarketContract> & { id: string } =\n@@ -511,9 +511,9 @@\n     })\n   }\n \n   const metrics =\n-    isNumberContract && !firstBetInMultiBet\n+    isMultiBet && !firstBetInMultiBet\n       ? await getContractMetrics(\n           pgTrans,\n           [user.id],\n           contract.id,\n@@ -611,9 +611,9 @@\n     | UniqueBettorBonusTxn\n     | undefined\n \n   // On normal contracts, we do this in on-create-bet\n-  if (isNumberContract) {\n+  if (isMultiBet) {\n     broadcastUserUpdates(userUpdates)\n     broadcastUpdatedContract(newContract.visibility, contractUpdate)\n     broadcastUpdatedAnswers(newContract.id, answerUpdates)\n   }\n"
        },
        {
          "path": "backend/api/src/place-multi-bet.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/place-multi-bet.ts\n===================================================================\n--- backend/api/src/place-multi-bet.ts\t3ff3df4 (parent)\n+++ backend/api/src/place-multi-bet.ts\t1f35061 (commit)\n@@ -1,17 +1,17 @@\n-import * as crypto from 'crypto'\n-import { APIError, type APIHandler } from './helpers/endpoint'\n-import { getNewMultiCpmmBetsInfo } from 'common/new-bet'\n-import { ValidatedAPIParams } from 'common/api/schema'\n-import { onCreateBets } from 'api/on-create-bet'\n-import { executeNewBetResult } from 'api/place-bet'\n-import { log } from 'shared/utils'\n-import { runTransactionWithRetries } from 'shared/transact-with-retries'\n-import { betsQueue } from 'shared/helpers/fn-queue'\n import {\n   fetchContractBetDataAndValidate,\n   getRoundedLimitProb,\n } from 'api/helpers/bets'\n+import { onCreateBets } from 'api/on-create-bet'\n+import { executeNewBetResult } from 'api/place-bet'\n+import { ValidatedAPIParams } from 'common/api/schema'\n+import { getNewMultiCpmmBetsInfo } from 'common/new-bet'\n+import * as crypto from 'crypto'\n+import { betsQueue } from 'shared/helpers/fn-queue'\n+import { runTransactionWithRetries } from 'shared/transact-with-retries'\n+import { log } from 'shared/utils'\n+import { APIError, type APIHandler } from './helpers/endpoint'\n \n export const placeMultiBet: APIHandler<'multi-bet'> = async (props, auth) => {\n   const isApi = auth.creds.kind === 'key'\n \n@@ -96,9 +96,11 @@\n         balanceByUserId,\n         undefined,\n         betGroupId,\n         deterministic,\n-        i === 0\n+        i === 0,\n+        false,\n+        true\n       )\n       results.push(result)\n     }\n     return results\n"
        },
        {
          "path": "common/src/calculate-cpmm-arbitrage.test.ts",
          "status": "modified",
          "diff": "Index: common/src/calculate-cpmm-arbitrage.test.ts\n===================================================================\n--- common/src/calculate-cpmm-arbitrage.test.ts\t3ff3df4 (parent)\n+++ common/src/calculate-cpmm-arbitrage.test.ts\t1f35061 (commit)\n@@ -1,19 +1,19 @@\n import { groupBy, sumBy } from 'lodash'\n import { Answer } from './answer'\n+import { Bet } from './bet'\n import {\n+  calculateCpmmMultiSumsToOneSale,\n+  getCpmmProbability,\n+} from './calculate-cpmm'\n+import {\n   calculateCpmmMultiArbitrageBet,\n   calculateCpmmMultiArbitrageSellYesEqually,\n   calculateCpmmMultiArbitrageYesBets,\n } from './calculate-cpmm-arbitrage'\n-import {\n-  calculateCpmmMultiSumsToOneSale,\n-  getCpmmProbability,\n-} from './calculate-cpmm'\n import { getFeeTotal, getTakerFee, noFees } from './fees'\n import { getMultiNumericAnswerBucketRanges } from './number'\n import { getNewSellBetInfo } from './sell-bet'\n-import { Bet } from './bet'\n \n describe('calculateCpmmMultiArbitrageBet', () => {\n   it('should sum to 1 after bet', async () => {\n     const answers: Answer[] = [\n@@ -321,8 +321,89 @@\n         Math.abs(afterSaleAnswerYesShares[i] - preBuyYesShares[i]) < 0.01\n       ).toBeTruthy()\n     }\n   })\n+\n+  it('does not spend more than passed amount across multi-buy answers', async () => {\n+    const answers: Answer[] = getNumericAnswers(0, 100, 10)\n+    const betAmount = 100\n+    const { newBetResults } = calculateCpmmMultiArbitrageYesBets(\n+      answers,\n+      answers.slice(0, 3),\n+      betAmount,\n+      undefined,\n+      [],\n+      {},\n+      noFees\n+    )\n+    const totalUserAmount = sumBy(\n+      newBetResults.flatMap((r) => r.takers),\n+      (t) => t.amount\n+    )\n+    expect(totalUserAmount).toBeLessThanOrEqual(betAmount + 1e-9)\n+  })\n+\n+  it('does not overfill maker limit orders in multi-buy', async () => {\n+    const answers: Answer[] = getNumericAnswers(0, 100, 10)\n+    const [a0, a1] = answers\n+    // Create two small NO limit orders on two answers at low limitProb so they match YES takers\n+    const now = Date.now()\n+    const makeLimit = (\n+      id: string,\n+      answer: Answer,\n+      userId: string,\n+      orderAmount: number\n+    ) => ({\n+      id,\n+      userId,\n+      contractId: 'c1',\n+      answerId: answer.id,\n+      createdTime: now,\n+      amount: 0,\n+      loanAmount: 0,\n+      outcome: 'NO',\n+      shares: 0,\n+      probBefore: answer.prob,\n+      probAfter: answer.prob,\n+      fees: noFees,\n+      isRedemption: false,\n+      visibility: 'public',\n+      orderAmount,\n+      limitProb: 0.05,\n+      isFilled: false,\n+      isCancelled: false,\n+      fills: [],\n+    })\n+    const makerA = makeLimit('makerA1', a0, 'makerA', 5)\n+    const makerB = makeLimit('makerB1', a1, 'makerB', 7)\n+    const unfilledBets = [makerA, makerB]\n+    const balanceByUserId = { makerA: 1e6, makerB: 1e6 }\n+\n+    const { newBetResults, otherBetResults } =\n+      calculateCpmmMultiArbitrageYesBets(\n+        answers,\n+        answers.slice(0, 3),\n+        100,\n+        undefined,\n+        unfilledBets,\n+        balanceByUserId,\n+        noFees\n+      )\n+\n+    const allMakers = [\n+      ...newBetResults.flatMap((r) => r.makers),\n+      ...otherBetResults.flatMap((r) => r.makers),\n+    ]\n+    const byBetId = groupBy(allMakers, (m) => m.bet.id)\n+    const orderAmountById: Record<string, number> = {\n+      [makerA.id]: makerA.orderAmount,\n+      [makerB.id]: makerB.orderAmount,\n+    }\n+    for (const [betId, makers] of Object.entries(byBetId)) {\n+      const filled = sumBy(makers, (m) => m.amount)\n+      expect(filled).toBeLessThanOrEqual(orderAmountById[betId] + 1e-9)\n+    }\n+  })\n })\n \n // Convert all NO shares into YES shares.\n // E.g. NO shares in answer A will be converted to YES shares in every other answer.\n"
        },
        {
          "path": "common/src/calculate-cpmm-arbitrage.ts",
          "status": "modified",
          "diff": "Index: common/src/calculate-cpmm-arbitrage.ts\n===================================================================\n--- common/src/calculate-cpmm-arbitrage.ts\t3ff3df4 (parent)\n+++ common/src/calculate-cpmm-arbitrage.ts\t1f35061 (commit)\n@@ -1,17 +1,17 @@\n+import { MAX_CPMM_PROB, MIN_CPMM_PROB } from 'common/contract'\n import { Dictionary, first, groupBy, mapValues, sum, sumBy } from 'lodash'\n import { Answer } from './answer'\n import { Bet, LimitBet, maker } from './bet'\n import {\n   calculateAmountToBuySharesFixedP,\n   computeFills,\n   getCpmmProbability,\n } from './calculate-cpmm'\n+import { Fees, getFeesSplit, getTakerFee, noFees, sumAllFees } from './fees'\n import { binarySearch } from './util/algos'\n import { floatingEqual } from './util/math'\n-import { Fees, getFeesSplit, getTakerFee, noFees, sumAllFees } from './fees'\n import { addObjects } from './util/object'\n-import { MAX_CPMM_PROB, MIN_CPMM_PROB } from 'common/contract'\n \n const DEBUG = false\n export type ArbitrageBetArray = ReturnType<typeof combineBetsOnSameAnswers>\n const noFillsReturn = (\n@@ -138,9 +138,51 @@\n }\n \n export type PreliminaryBetResults = ReturnType<typeof computeFills> & {\n   answer: Answer\n+  // iteration index within a multi-buy cycle; 0 is paid with user's amount,\n+  // >0 iterations are funded by arbitrage extraMana and should be free for the taker.\n+  iteration?: number\n }\n+\n+// Mutate working state to reflect maker fills and cancellations, so subsequent legs\n+// cannot reuse the same maker order capacity or balances.\n+const applyMakersToWorkingState = (\n+  makers: maker[],\n+  ordersToCancel: LimitBet[],\n+  workingUnfilledBetsByAnswer: Dictionary<LimitBet[]>,\n+  workingBalanceByUserId: { [userId: string]: number }\n+) => {\n+  for (const maker of makers) {\n+    const { bet, amount, shares } = maker\n+    if (!bet.answerId) {\n+      throw new Error('Multi-bet has no answerId')\n+    }\n+    if (amount > 0) {\n+      const prev = workingBalanceByUserId[bet.userId]\n+      if (prev !== undefined) workingBalanceByUserId[bet.userId] = prev - amount\n+    }\n+    // Update the bet's filled amount in-place inside our working unfilled bets map\n+    const arr = workingUnfilledBetsByAnswer[bet.answerId] ?? []\n+    const idx = arr.findIndex((b) => b.id === bet.id)\n+    if (idx >= 0) {\n+      const updated = { ...arr[idx] }\n+      updated.amount = (updated.amount ?? 0) + amount\n+      updated.shares = (updated.shares ?? 0) + shares\n+      arr[idx] = updated\n+      workingUnfilledBetsByAnswer[bet.answerId] = arr\n+    }\n+  }\n+  if (ordersToCancel.length) {\n+    const cancelIds = new Set(ordersToCancel.map((b) => b.id))\n+    for (const [answerId, arr] of Object.entries(workingUnfilledBetsByAnswer)) {\n+      workingUnfilledBetsByAnswer[answerId] = arr.filter(\n+        (b) => !cancelIds.has(b.id)\n+      )\n+    }\n+  }\n+}\n+\n function calculateCpmmMultiArbitrageBetsYes(\n   initialAnswers: Answer[],\n   initialAnswersToBuy: Answer[],\n   initialBetAmount: number,\n@@ -148,14 +190,17 @@\n   unfilledBets: LimitBet[],\n   balanceByUserId: { [userId: string]: number },\n   collectedFees: Fees\n ) {\n-  const unfilledBetsByAnswer = groupBy(unfilledBets, (bet) => bet.answerId)\n+  // Maintain mutable snapshots of unfilled orders and maker balances across the whole multi-buy\n+  let workingUnfilledBetsByAnswer = groupBy(unfilledBets, (bet) => bet.answerId)\n+  let workingBalanceByUserId = { ...balanceByUserId }\n   const noBetResults: PreliminaryBetResults[] = []\n   const yesBetResults: PreliminaryBetResults[] = []\n \n   let updatedAnswers = initialAnswers\n   let amountToBet = initialBetAmount\n+  let iteration = 0\n   while (amountToBet > 0.01) {\n     const answersToBuy = updatedAnswers.filter((a) =>\n       initialAnswersToBuy.map((an) => an.id).includes(a.id)\n     )\n@@ -168,32 +213,44 @@\n         calculateAmountToBuySharesFixedP(\n           { pool: { YES: poolYes, NO: poolNo }, p: 0.5, collectedFees },\n           yesShares,\n           'YES',\n-          unfilledBetsByAnswer[id] ?? [],\n-          balanceByUserId\n+          workingUnfilledBetsByAnswer[id] ?? [],\n+          workingBalanceByUserId\n         )\n       )\n \n       const totalYesAmount = sum(yesAmounts)\n       return totalYesAmount - amountToBet\n     })\n \n-    const { noBuyResults, yesBets, newUpdatedAnswers } =\n-      getBetResultsAndUpdatedAnswers(\n-        answersToBuy,\n-        yesAmounts,\n-        updatedAnswers,\n-        limitProb,\n-        unfilledBets,\n-        balanceByUserId,\n-        collectedFees\n-      )\n+    const {\n+      noBuyResults,\n+      yesBets,\n+      newUpdatedAnswers,\n+      updatedUnfilledBetsByAnswer,\n+      updatedBalanceByUserId,\n+    } = getBetResultsAndUpdatedAnswers(\n+      answersToBuy,\n+      yesAmounts,\n+      updatedAnswers,\n+      limitProb,\n+      // Flatten working unfilled bets for API; it will reconstruct its own map\n+      Object.values(workingUnfilledBetsByAnswer).flat(),\n+      workingBalanceByUserId,\n+      collectedFees\n+    )\n+    // Annotate iteration index so we can mark taker fills as free beyond the first.\n+    yesBets.forEach((r) => ((r as PreliminaryBetResults).iteration = iteration))\n+    noBuyResults.noBetResults.forEach((r) => (r.iteration = iteration))\n+    workingUnfilledBetsByAnswer = updatedUnfilledBetsByAnswer\n+    workingBalanceByUserId = updatedBalanceByUserId\n     updatedAnswers = newUpdatedAnswers\n \n     amountToBet = noBuyResults.extraMana\n     noBetResults.push(...noBuyResults.noBetResults)\n     yesBetResults.push(...yesBets)\n+    iteration++\n   }\n \n   const noBetResultsOnBoughtAnswer = combineBetsOnSameAnswers(\n     noBetResults,\n@@ -239,25 +296,39 @@\n   balanceByUserId: { [userId: string]: number },\n   collectedFees: Fees,\n   answerIdsWithFees?: string[]\n ) => {\n-  const unfilledBetsByAnswer = groupBy(unfilledBets, (bet) => bet.answerId)\n+  // Working maps that will be updated as we simulate each leg to avoid reusing capacity.\n+  const workingUnfilledBetsByAnswer = groupBy(\n+    unfilledBets,\n+    (bet) => bet.answerId\n+  )\n+  const workingBalanceByUserId = { ...balanceByUserId }\n+\n   const yesBetResultsAndUpdatedAnswers = answersToBuy.map((answerToBuy, i) => {\n     const pool = { YES: answerToBuy.poolYes, NO: answerToBuy.poolNo }\n     const yesBetResult = {\n       ...computeFills(\n         { pool, p: 0.5, collectedFees },\n         'YES',\n         yesAmounts[i],\n         limitProb,\n-        unfilledBetsByAnswer[answerToBuy.id] ?? [],\n-        balanceByUserId,\n+        workingUnfilledBetsByAnswer[answerToBuy.id] ?? [],\n+        workingBalanceByUserId,\n         undefined,\n         answerIdsWithFees && !answerIdsWithFees?.includes(answerToBuy.id)\n       ),\n       answer: answerToBuy,\n     }\n \n+    // Apply the fills to mutate working state for subsequent legs\n+    applyMakersToWorkingState(\n+      yesBetResult.makers,\n+      yesBetResult.ordersToCancel,\n+      workingUnfilledBetsByAnswer,\n+      workingBalanceByUserId\n+    )\n+\n     const { cpmmState } = yesBetResult\n     const { pool: newPool, p } = cpmmState\n     const { YES: poolYes, NO: poolNo } = newPool\n     const prob = getCpmmProbability(newPool, p)\n@@ -279,13 +350,23 @@\n         newAnswerStates.find(\n           (newAnswerState) => newAnswerState.id === answer.id\n         ) ?? answer\n     ),\n-    unfilledBets,\n-    balanceByUserId,\n+    // Flatten current working snapshot so NO legs see already-used capacity\n+    Object.values(workingUnfilledBetsByAnswer).flat(),\n+    workingBalanceByUserId,\n     collectedFees,\n     answerIdsWithFees\n   )\n+  // Apply NO leg maker fills to working state as well\n+  for (const noBet of noBuyResults.noBetResults) {\n+    applyMakersToWorkingState(\n+      noBet.makers,\n+      noBet.ordersToCancel,\n+      workingUnfilledBetsByAnswer,\n+      workingBalanceByUserId\n+    )\n+  }\n   // Update new answer states from bets placed on all answers\n   const newUpdatedAnswers = noBuyResults.noBetResults.map((noBetResult) => {\n     const { cpmmState } = noBetResult\n     const { pool: newPool, p } = cpmmState\n@@ -302,8 +383,11 @@\n   return {\n     newUpdatedAnswers,\n     yesBets,\n     noBuyResults,\n+    // Also return updated state so callers can carry it across iterations\n+    updatedUnfilledBetsByAnswer: workingUnfilledBetsByAnswer,\n+    updatedBalanceByUserId: workingBalanceByUserId,\n   }\n }\n \n export const combineBetsOnSameAnswers = (\n@@ -323,21 +407,32 @@\n     const totalFees = betsForAnswer.reduce(\n       (acc, b) => addObjects(acc, b.totalFees),\n       extraFees\n     )\n+    // Make extra taker fills beyond the user's paid iteration free by zeroing their amounts and fees,\n+    // while still summing shares so probabilities update correctly.\n+    const takers = betsForAnswer.flatMap((r) => r.takers)\n+    const adjustedTakers = fillsFollowingFirstAreFree\n+      ? (() => {\n+          const cloned = takers.map((t) => ({ ...t }))\n+          let idx = 0\n+          for (const r of betsForAnswer) {\n+            const count = r.takers.length\n+            const slice = cloned.slice(idx, idx + count)\n+            if ((r.iteration ?? 0) > 0) {\n+              for (const t of slice) {\n+                t.amount = 0\n+                t.fees = noFees\n+              }\n+            }\n+            idx += count\n+          }\n+          return cloned\n+        })()\n+      : takers\n     return {\n       ...bet,\n-      takers: fillsFollowingFirstAreFree\n-        ? [\n-            {\n-              ...bet.takers[0],\n-              shares: sumBy(\n-                betsForAnswer.flatMap((r) => r.takers),\n-                'shares'\n-              ),\n-            },\n-          ]\n-        : betsForAnswer.flatMap((r) => r.takers),\n+      takers: adjustedTakers,\n       makers: betsForAnswer.flatMap((r) => r.makers),\n       ordersToCancel: betsForAnswer.flatMap((r) => r.ordersToCancel),\n       outcome,\n       cpmmState: { p: 0.5, pool: { YES: poolYes, NO: poolNo }, collectedFees },\n@@ -678,9 +773,9 @@\n       ),\n       answer,\n     }\n   })\n-\n+  //{\"id\": \"tQudZcEtlp\", \"slug\": \"whos-gonna-win-gn8sCuyRpl\", \"volume\": 0, \"answers\": [{\"id\": \"Ncus9Qtty2\", \"prob\": 0.16666666666666666, \"text\": \"a\", \"index\": 0, \"poolNo\": 100, \"userId\": \"6hHpzvRG0pMq8PNJs7RZj2qlZGn2\", \"isOther\": false, \"poolYes\": 500, \"contractId\": \"tQudZcEtlp\", \"createdTime\": 1755714659074, \"probChanges\": {\"day\": 0, \"week\": 0, \"month\": 0}, \"subsidyPool\": 0, \"totalLiquidity\": 223.60679774997897}, {\"id\": \"CAqyQ8AOSn\", \"prob\": 0.16666666666666666, \"text\": \"b\", \"index\": 1, \"poolNo\": 100, \"userId\": \"6hHpzvRG0pMq8PNJs7RZj2qlZGn2\", \"isOther\": false, \"poolYes\": 500, \"contractId\": \"tQudZcEtlp\", \"createdTime\": 1755714659074, \"probChanges\": {\"day\": 0, \"week\": 0, \"month\": 0}, \"subsidyPool\": 0, \"totalLiquidity\": 223.60679774997897}, {\"id\": \"Pc86OAUEsn\", \"prob\": 0.16666666666666666, \"text\": \"c\", \"index\": 2, \"poolNo\": 100, \"userId\": \"6hHpzvRG0pMq8PNJs7RZj2qlZGn2\", \"isOther\": false, \"poolYes\": 500, \"contractId\": \"tQudZcEtlp\", \"createdTime\": 1755714659074, \"probChanges\": {\"day\": 0, \"week\": 0, \"month\": 0}, \"subsidyPool\": 0, \"totalLiquidity\": 223.60679774997897}, {\"id\": \"dn0gpUIzpq\", \"prob\": 0.16666666666666666, \"text\": \"d\", \"index\": 3, \"poolNo\": 100, \"userId\": \"6hHpzvRG0pMq8PNJs7RZj2qlZGn2\", \"isOther\": false, \"poolYes\": 500, \"contractId\": \"tQudZcEtlp\", \"createdTime\": 1755714659074, \"probChanges\": {\"day\": 0, \"week\": 0, \"month\": 0}, \"subsidyPool\": 0, \"totalLiquidity\": 223.60679774997897}, {\"id\": \"uq5uZd5O0A\", \"prob\": 0.16666666666666666, \"text\": \"e\", \"index\": 4, \"poolNo\": 100, \"userId\": \"6hHpzvRG0pMq8PNJs7RZj2qlZGn2\", \"isOther\": false, \"poolYes\": 500, \"contractId\": \"tQudZcEtlp\", \"createdTime\": 1755714659074, \"probChanges\": {\"day\": 0, \"week\": 0, \"month\": 0}, \"subsidyPool\": 0, \"totalLiquidity\": 223.60679774997897}, {\"id\": \"ACNE8CLyyS\", \"prob\": 0.16666666666666666, \"text\": \"Other\", \"index\": 5, \"poolNo\": 100, \"userId\": \"6hHpzvRG0pMq8PNJs7RZj2qlZGn2\", \"isOther\": true, \"poolYes\": 500, \"contractId\": \"tQudZcEtlp\", \"createdTime\": 1755714659074, \"probChanges\": {\"day\": 0, \"week\": 0, \"month\": 0}, \"subsidyPool\": 0, \"totalLiquidity\": 223.60679774997897}], \"isRanked\": false, \"question\": \"Who's gonna win?\", \"closeTime\": 1767254340000, \"creatorId\": \"6hHpzvRG0pMq8PNJs7RZj2qlZGn2\", \"mechanism\": \"cpmm-multi-1\", \"elasticity\": 4.99, \"groupSlugs\": [\"nonpredictive\"], \"isResolved\": false, \"visibility\": \"public\", \"createdTime\": 1755714659073, \"creatorName\": \"Ian Bobby\", \"description\": {\"type\": \"doc\", \"content\": [{\"type\": \"paragraph\"}]}, \"outcomeType\": \"MULTIPLE_CHOICE\", \"subsidyPool\": 0, \"collectedFees\": {\"creatorFee\": 0, \"platformFee\": 0, \"liquidityFee\": 0}, \"volume24Hours\": 0, \"addAnswersMode\": \"ANYONE\", \"totalLiquidity\": 1000, \"creatorUsername\": \"IanPhilip\", \"lastUpdatedTime\": 1755714659519, \"popularityScore\": 0, \"creatorAvatarUrl\": \"https://firebasestorage.googleapis.com/v0/b/dev-mantic-markets.appspot.com/o/user-images%2FIanPhilip%2FEyIU8AZ2RC.png?alt=media&token=ff41c9e8-21d5-412d-ac19-854a90cce076\", \"uniqueBettorCount\": 0, \"creatorCreatedTime\": 1668811545000, \"uniqueBettorCountDay\": 0, \"shouldAnswersSumToOne\": true}\n   let noBetAmount = betAmount - totalYesAmount\n   if (floatingArbitrageEqual(noBetAmount, 0)) {\n     noBetAmount = 0\n   }\n@@ -730,19 +825,20 @@\n   balanceByUserId: { [userId: string]: number },\n   collectedFees: Fees,\n   answerIdsWithFees?: string[]\n ) => {\n-  const unfilledBetsByAnswer = groupBy(unfilledBets, (bet) => bet.answerId)\n+  const baseUnfilledBetsByAnswer = groupBy(unfilledBets, (bet) => bet.answerId)\n \n   let maxNoShares = 10\n   do {\n     const result = buyNoSharesInAnswers(\n       answers,\n-      unfilledBetsByAnswer,\n-      balanceByUserId,\n+      { ...baseUnfilledBetsByAnswer },\n+      { ...balanceByUserId },\n       maxNoShares,\n       collectedFees,\n-      answerIdsWithFees\n+      answerIdsWithFees,\n+      false // don't mutate orders during binary search\n     )\n     const newPools = result.noBetResults.map((r) => r.cpmmState.pool)\n     const probSum = sumBy(newPools, (pool) => getCpmmProbability(pool, 0.5))\n     if (probSum < 1) break\n@@ -751,26 +847,28 @@\n \n   const noShares = binarySearch(0, maxNoShares, (noShares) => {\n     const result = buyNoSharesInAnswers(\n       answers,\n-      unfilledBetsByAnswer,\n-      balanceByUserId,\n+      { ...baseUnfilledBetsByAnswer },\n+      { ...balanceByUserId },\n       noShares,\n       collectedFees,\n-      answerIdsWithFees\n+      answerIdsWithFees,\n+      false // don't mutate orders during binary search\n     )\n     const newPools = result.noBetResults.map((r) => r.cpmmState.pool)\n     const diff = 1 - sumBy(newPools, (pool) => getCpmmProbability(pool, 0.5))\n     return diff\n   })\n \n   return buyNoSharesInAnswers(\n     answers,\n-    unfilledBetsByAnswer,\n-    balanceByUserId,\n+    baseUnfilledBetsByAnswer,\n+    { ...balanceByUserId },\n     noShares,\n     collectedFees,\n-    answerIdsWithFees\n+    answerIdsWithFees,\n+    true // mutate orders in final execution\n   )\n }\n \n const buyNoSharesInAnswers = (\n@@ -778,39 +876,53 @@\n   unfilledBetsByAnswer: Dictionary<LimitBet[]>,\n   balanceByUserId: { [userId: string]: number },\n   noShares: number,\n   collectedFees: Fees,\n-  answerIdsWithFees?: string[]\n+  answerIdsWithFees?: string[],\n+  updateOrders: boolean = true\n ) => {\n-  const noAmounts = answers.map(({ id, poolYes, poolNo }) =>\n-    calculateAmountToBuySharesFixedP(\n-      { pool: { YES: poolYes, NO: poolNo }, p: 0.5, collectedFees },\n+  // Sequentially compute each answer's NO leg, updating state to avoid reusing capacity.\n+  let totalNoAmount = 0\n+  const noBetResults: PreliminaryBetResults[] = []\n+  for (const answer of answers) {\n+    const { id, poolYes, poolNo } = answer\n+    const pool = { YES: poolYes, NO: poolNo }\n+    const noAmount = calculateAmountToBuySharesFixedP(\n+      { pool, p: 0.5, collectedFees },\n       noShares,\n       'NO',\n       unfilledBetsByAnswer[id] ?? [],\n       balanceByUserId,\n       !answerIdsWithFees?.includes(id)\n     )\n-  )\n-  const totalNoAmount = sum(noAmounts)\n+    totalNoAmount += noAmount\n \n-  const noBetResults = noAmounts.map((noAmount, i) => {\n-    const answer = answers[i]\n-    const pool = { YES: answer.poolYes, NO: answer.poolNo }\n-    return {\n+    const res = {\n       ...computeFills(\n         { pool, p: 0.5, collectedFees },\n         'NO',\n         noAmount,\n         undefined,\n-        unfilledBetsByAnswer[answer.id] ?? [],\n+        unfilledBetsByAnswer[id] ?? [],\n         balanceByUserId,\n         undefined,\n-        !answerIdsWithFees?.includes(answer.id)\n+        !answerIdsWithFees?.includes(id)\n       ),\n       answer,\n     }\n-  })\n+\n+    // Apply maker usage to state so later answers don't reuse.\n+    if (updateOrders) {\n+      applyMakersToWorkingState(\n+        res.makers,\n+        res.ordersToCancel,\n+        unfilledBetsByAnswer,\n+        balanceByUserId\n+      )\n+    }\n+\n+    noBetResults.push(res)\n+  }\n   // Identity: No shares in all other answers is equal to noShares * (n-1) mana\n   const redeemedAmount = noShares * (answers.length - 1)\n   // Fees on arbitrage bets are returned\n   const extraMana = redeemedAmount - totalNoAmount\n"
        },
        {
          "path": "docs/docs/api.md",
          "status": "modified",
          "diff": "Index: docs/docs/api.md\n===================================================================\n--- docs/docs/api.md\t3ff3df4 (parent)\n+++ docs/docs/api.md\t1f35061 (commit)\n@@ -979,8 +979,223 @@\n ```\n \n Response type: A `Bet`.\n \n+### `POST /v0/multi-bet`\n+\n+Place multiple YES bets on a sums-to-one multiple choice market, targeting the same number of shares on each selected answer.\n+\n+This is only available on `cpmm-multi-1` markets with `shouldAnswersSumToOne=true` and requires at least two answers in the market. The provided `amount` is spent across the selected answers to purchase equal shares per answer at execution time. If a `limitProb` is provided, each leg will only execute up to that price; any unfilled remainder stays as open limit orders until `expiresAt` or cancellation.\n+\n+Parameters:\n+\n+- `contractId`: The ID of the market to bet on.\n+- `answerIds`: Array of answer IDs to buy on. Minimum length 2. Market must have `shouldAnswersSumToOne=true`.\n+- `amount`: Total amount to spend across the selected answers.\n+- `limitProb`: Optional. A number from `0.01` to `0.99` with two decimal places (whole percentage points). Acts as a per-leg limit price.\n+- `expiresAt`: Optional. Unix timestamp (ms). Any unfilled portion will be canceled at this time.\n+\n+Notes:\n+\n+- Only `YES` is supported; `outcome` is implicitly `YES`.\n+- The API returns only the primary bets on the selected answers. Internal arbitrage trades created to keep probabilities summing to 100% are not included in the response.\n+\n+Example request:\n+\n+```bash\n+curl -X POST https://api.manifold.markets/v0/multi-bet \\\n+  -H 'Authorization: Key YOUR_API_KEY' \\\n+  -H 'Content-Type: application/json' \\\n+  -d '{\n+    \"contractId\":\"tQudZcEtlp\",\n+    \"amount\":100,\n+    \"answerIds\":[\"Ncus9Qtty2\",\"CAqyQ8AOSn\",\"Pc86OAUEsn\"]\n+   }'\n+```\n+\n+Example response (array of bets, one per selected answer):\n+\n+```json\n+[\n+  {\n+    \"orderAmount\": 100.00000000000003,\n+    \"amount\": 33.333333333333286,\n+    \"shares\": 125.88308682212488,\n+    \"isFilled\": true,\n+    \"fills\": [\n+      {\n+        \"matchedBetId\": null,\n+        \"shares\": 110.27413685175395,\n+        \"amount\": 33.333333333333286,\n+        \"timestamp\": 1755718208318,\n+        \"fees\": {\n+          \"creatorFee\": 0,\n+          \"platformFee\": 0,\n+          \"liquidityFee\": 0\n+        }\n+      },\n+      {\n+        \"matchedBetId\": null,\n+        \"shares\": 15.313505455862867,\n+        \"amount\": 0,\n+        \"timestamp\": 1755718208324,\n+        \"fees\": {\n+          \"creatorFee\": 0,\n+          \"platformFee\": 0,\n+          \"liquidityFee\": 0\n+        }\n+      },\n+      {\n+        \"matchedBetId\": null,\n+        \"shares\": 0.29544451450806264,\n+        \"amount\": 0,\n+        \"timestamp\": 1755718208329,\n+        \"fees\": {\n+          \"creatorFee\": 0,\n+          \"platformFee\": 0,\n+          \"liquidityFee\": 0\n+        }\n+      }\n+    ],\n+    \"contractId\": \"tQudZcEtlp\",\n+    \"outcome\": \"YES\",\n+    \"isCancelled\": false,\n+    \"loanAmount\": 0,\n+    \"answerId\": \"Ncus9Qtty2\",\n+    \"probBefore\": 0.2568360631674096,\n+    \"probAfter\": 0.2721147216493064,\n+    \"createdTime\": 1755718208333,\n+    \"fees\": {\n+      \"creatorFee\": 0,\n+      \"platformFee\": 0,\n+      \"liquidityFee\": 0\n+    },\n+    \"isRedemption\": false,\n+    \"visibility\": \"public\",\n+    \"betId\": \"zl2cULd0yq5N\",\n+    \"betGroupId\": \"05bd5240dfca66b2556b77e8\"\n+  },\n+  {\n+    \"orderAmount\": 100.00000000000003,\n+    \"amount\": 33.3333333333334,\n+    \"shares\": 125.88308682212511,\n+    \"isFilled\": true,\n+    \"fills\": [\n+      {\n+        \"matchedBetId\": null,\n+        \"shares\": 110.27413685175412,\n+        \"amount\": 33.3333333333334,\n+        \"timestamp\": 1755718208318,\n+        \"fees\": {\n+          \"creatorFee\": 0,\n+          \"platformFee\": 0,\n+          \"liquidityFee\": 0\n+        }\n+      },\n+      {\n+        \"matchedBetId\": null,\n+        \"shares\": 15.31350545586281,\n+        \"amount\": 0,\n+        \"timestamp\": 1755718208324,\n+        \"fees\": {\n+          \"creatorFee\": 0,\n+          \"platformFee\": 0,\n+          \"liquidityFee\": 0\n+        }\n+      },\n+      {\n+        \"matchedBetId\": null,\n+        \"shares\": 0.2954445145081763,\n+        \"amount\": 0,\n+        \"timestamp\": 1755718208330,\n+        \"fees\": {\n+          \"creatorFee\": 0,\n+          \"platformFee\": 0,\n+          \"liquidityFee\": 0\n+        }\n+      }\n+    ],\n+    \"contractId\": \"tQudZcEtlp\",\n+    \"outcome\": \"YES\",\n+    \"isCancelled\": false,\n+    \"loanAmount\": 0,\n+    \"answerId\": \"CAqyQ8AOSn\",\n+    \"probBefore\": 0.2568360631674102,\n+    \"probAfter\": 0.27211472164930733,\n+    \"createdTime\": 1755718208333,\n+    \"fees\": {\n+      \"creatorFee\": 0,\n+      \"platformFee\": 0,\n+      \"liquidityFee\": 0\n+    },\n+    \"isRedemption\": false,\n+    \"visibility\": \"public\",\n+    \"betId\": \"hAnEpO2dOspd\",\n+    \"betGroupId\": \"05bd5240dfca66b2556b77e8\"\n+  },\n+  {\n+    \"orderAmount\": 100.00000000000003,\n+    \"amount\": 33.33333333333334,\n+    \"shares\": 125.88308682212511,\n+    \"isFilled\": true,\n+    \"fills\": [\n+      {\n+        \"matchedBetId\": null,\n+        \"shares\": 110.27413685175384,\n+        \"amount\": 33.33333333333334,\n+        \"timestamp\": 1755718208318,\n+        \"fees\": {\n+          \"creatorFee\": 0,\n+          \"platformFee\": 0,\n+          \"liquidityFee\": 0\n+        }\n+      },\n+      {\n+        \"matchedBetId\": null,\n+        \"shares\": 15.313505455863208,\n+        \"amount\": 0,\n+        \"timestamp\": 1755718208324,\n+        \"fees\": {\n+          \"creatorFee\": 0,\n+          \"platformFee\": 0,\n+          \"liquidityFee\": 0\n+        }\n+      },\n+      {\n+        \"matchedBetId\": null,\n+        \"shares\": 0.29544451450806264,\n+        \"amount\": 0,\n+        \"timestamp\": 1755718208330,\n+        \"fees\": {\n+          \"creatorFee\": 0,\n+          \"platformFee\": 0,\n+          \"liquidityFee\": 0\n+        }\n+      }\n+    ],\n+    \"contractId\": \"tQudZcEtlp\",\n+    \"outcome\": \"YES\",\n+    \"isCancelled\": false,\n+    \"loanAmount\": 0,\n+    \"answerId\": \"Pc86OAUEsn\",\n+    \"probBefore\": 0.25683606316740987,\n+    \"probAfter\": 0.27211472164930683,\n+    \"createdTime\": 1755718208333,\n+    \"fees\": {\n+      \"creatorFee\": 0,\n+      \"platformFee\": 0,\n+      \"liquidityFee\": 0\n+    },\n+    \"isRedemption\": false,\n+    \"visibility\": \"public\",\n+    \"betId\": \"p9L5NPO09tCz\",\n+    \"betGroupId\": \"05bd5240dfca66b2556b77e8\"\n+  }\n+]\n+```\n+\n+Response type: Array of `Bet`-like objects (same fields as a `Bet`) with additional `betId` and `betGroupId`.\n+\n ### `POST /v0/bet/cancel/[id]`\n \n Cancel a limit order.\n \n"
        }
      ]
    },
    {
      "id": "admin-user-tools",
      "sha": "60ca4f458afe065c98135112be65dc5d6bff1dd9",
      "parentSha": "6cbefd3733cc7eec009cb63e1c9e122cd8d23f19",
      "spec": "Implement an admin user management feature consisting of backend endpoints, API schema additions, route wiring, and admin UI with confirmation flows.\n\nBackend API\n1) Create four new admin-only API handlers in backend/api/src:\n   - admin-delete-user.ts\n     - Handler: adminDeleteUser: APIHandler<'admin-delete-user'>.\n     - Auth: must call throwErrorIfNotAdmin(auth.uid). If target userId is an admin (isAdminId(userId)), return 403.\n     - Behavior:\n       - Verify target user exists via getUser(userId), else 404.\n       - If user.userDeleted is already true, return 400.\n       - Track action with trackPublicEvent(auth.uid, 'admin delete user', { userId }).\n       - Use createSupabaseDirectClient() to get pg.\n       - updateUser(pg, userId) to set userDeleted: true and isBannedFromPosting: true.\n       - updatePrivateUser(pg, userId): first set old_e_mail to the current privateUser.email (string or ''), then delete email and twitchInfo using FieldVal.delete().\n       - Return { success: true }.\n\n   - admin-get-user-info.ts\n     - Handler: adminGetUserInfo: APIHandler<'get-user-info'>.\n     - Method must be GET in schema.\n     - Auth: throwErrorIfNotAdmin(auth.uid).\n     - Behavior:\n       - Validate/lookup user via getUser(userId), else 404, and private user via getPrivateUser(userId), else 404.\n       - Attempt to fetch Firebase Auth user via firebase-admin admin.auth().getUser(userId) to read email; swallow errors and set undefined if unavailable.\n       - Return an object with keys: supabaseEmail (privateUser.email), oldEmail (privateUser.old_e_mail), firebaseEmail, initialDeviceToken (privateUser.initialDeviceToken), initialIpAddress (privateUser.initialIpAddress).\n\n   - admin-recover-user.ts\n     - Handler: adminRecoverUser: APIHandler<'recover-user'>.\n     - Auth: throwErrorIfNotAdmin(auth.uid).\n     - Behavior:\n       - Verify user and private user exist.\n       - Determine emailToRestore: prefer provided body.email if present; else use privateUser.old_e_mail; if none, return 400 with clear message.\n       - Track action with trackPublicEvent(auth.uid, 'recover user', { userId }).\n       - updateUser(pg, userId) to set userDeleted: false and isBannedFromPosting: false.\n       - If privateUser.email is currently missing and emailToRestore exists, updatePrivateUser(pg, userId) to set email: emailToRestore.\n       - If old_e_mail was used (i.e., present and no manual override), clear old_e_mail via FieldVal.delete().\n       - Return { success: true }.\n\n   - anonymize-user.ts\n     - Handler: anonymizeUser: APIHandler<'anonymize-user'>.\n     - Auth: throwErrorIfNotAdmin(auth.uid). If target userId is an admin (isAdminId(userId)), return 403.\n     - Behavior:\n       - Verify user and private user exist.\n       - Track action with trackPublicEvent(auth.uid, 'anonymize user', { userId }).\n       - Generate randomized values using common/util/random.randomString:\n         - username: \"deleted_\" + 8-char random string.\n         - name: \"Deleted User \" + 4-char random string.\n       - updateUser(pg, userId) to:\n         - Set name and username to the random values.\n         - Set avatarUrl to empty string.\n         - Remove public PII fields: bio, website, twitterHandle, discordHandle (these fields must be removed from the JSON data so they no longer appear; do not set them to a value that preserves old data).\n       - updatePrivateUser(pg, userId) to delete twitchInfo via FieldVal.delete().\n       - Return { success: true, newUsername, newName }.\n\n2) Wire the endpoints into the router.\n   - Edit backend/api/src/routes.ts:\n     - Add imports for the four new handlers at top.\n     - Add entries to the exported handlers mapping for APIPath keys: 'recover-user', 'get-user-info', 'admin-delete-user', and 'anonymize-user'. Place them near other admin-related endpoints. The handlers object must include all APIPath keys defined in the API schema.\n\n3) Add the API schema entries.\n   - Edit common/src/api/schema.ts to include:\n     - 'recover-user': method POST, visibility 'undocumented', authed true, props: { userId: z.string(), email?: z.string() }, returns { success: boolean }.\n     - 'get-user-info': method GET, visibility 'undocumented', authed true, props: { userId: z.string() }, returns { supabaseEmail?: string; oldEmail?: string; firebaseEmail?: string; initialDeviceToken?: string; initialIpAddress?: string }.\n     - 'admin-delete-user': method POST, visibility 'undocumented', authed true, props: { userId: z.string() }, returns { success: boolean }.\n     - 'anonymize-user': method POST, visibility 'undocumented', authed true, props: { userId: z.string() }, returns { success: boolean; newUsername: string; newName: string }.\n   - Ensure the method values align with the UI usage (get-user-info must be GET so the client passes query params) and that APIPath includes these new keys to satisfy router typing.\n\nWeb UI\n4) Add a reusable confirmation modal component.\n   - Create web/components/admin/ConfirmActionModal.tsx.\n   - Props: isOpen, onClose, onConfirm, title, description (string or ReactNode), confirmationWord (string typed by user to enable), confirmButtonText, confirmButtonColor ('green'|'red'|'amber'), isSubmitting (optional).\n   - Renders a Modal containing instructions, an Input for the confirmation word, and two Buttons (confirm and cancel). Confirm button is disabled until the typed value matches the confirmationWord and respects isSubmitting.\n\n5) Admin user management page.\n   - Create web/pages/admin/user-info.tsx.\n   - Behavior:\n     - Admin-only (use useAdmin(); redirect if signed out).\n     - Top-level title: \"Admin - User Info & Account Management\" with an explanatory section describing delete/recover/anonymize behaviors.\n     - Search users by name/username/ID using searchUsers(prompt, limit) and allow selection. If a userId is provided in the URL (router.query.userId), load it directly via getFullUserById.\n     - After selecting a user, fetch 'get-user-info' via api('get-user-info', { userId }) and display:\n       - Initial device token and IP address.\n       - Email status: current Supabase email, old_e_mail, Firebase email (with a \"Use this\" button to populate manualEmail field).\n       - If old_e_mail is missing, show a warning that manual email is required to recover.\n     - Manual email override input field appears when needed, with helper text that if provided, it overrides old_e_mail on recovery.\n     - Action buttons with confirm modals:\n       - Recover Account (enabled only if user is deleted/banned); opens ConfirmActionModal with confirmationWord \"recover account\"; on confirm, call api('recover-user', { userId, email? }) then show success toast and reset selection.\n       - Delete Account (disabled if already deleted); opens ConfirmActionModal with confirmationWord \"delete account\"; on confirm, call api('admin-delete-user', { userId }) then success toast and reset.\n       - Anonymize User (always enabled); opens ConfirmActionModal with confirmationWord \"anonymize\"; on confirm, call api('anonymize-user', { userId }) and show success toast including returned newUsername/newName, then reset.\n     - Provide disabled state and loading spinners via isSubmitting.\n\n6) Add navigation to the page from admin areas.\n   - Edit web/pages/admin/index.tsx to add a tile/link (LabCard) pointing to \"/admin/user-info\" with label \"user info & account management\".\n   - Edit web/components/buttons/user-settings-button.tsx to, for isAdmin users, add a \"Manage Account\" button that routes to \"/admin/user-info?userId=${userId}\".\n\n7) Minor formatting change in the press page.\n   - Edit web/pages/press.tsx to reflect the formatting and import adjustments shown (e.g., simplified JSX formatting, icon import adjustments). No functional change is required; this is cosmetic/formatting consistency.\n\nConstraints and notes\n- All four backend handlers must validate admin authorization using throwErrorIfNotAdmin(auth.uid). For delete and anonymize actions, do not allow target admin accounts (isAdminId(userId)) and return 403 in that case.\n- All destructive actions (recover, delete, anonymize) must be tracked via trackPublicEvent to feed the audit trail.\n- Use shared utilities: createSupabaseDirectClient, getUser/getPrivateUser from shared/utils, updateUser/updatePrivateUser from shared/supabase/users, FieldVal.delete from shared/supabase/utils, randomString from common/util/random, and firebase-admin to query Firebase Auth.\n- Ensure common/src/api/schema.ts new entries’ methods align with UI usage (get-user-info is GET, others POST) so web/lib/api/api.ts resolves methods and typedEndpoint can map params (query vs body).\n- For anonymization, public user data must remove PII fields: bio, website, twitterHandle, discordHandle, and set avatarUrl to empty; return the newUsername and newName in the response.\n",
      "prompt": "Add an admin user management feature that lets admins delete, recover, and anonymize user accounts, and view key user info. Implement four admin-only backend API endpoints: get-user-info (GET; returns Supabase email, old email, Firebase email, initial device token/IP), recover-user (POST; restores account and email from old_e_mail or an optional manual override), admin-delete-user (POST; soft delete that marks userDeleted=true, bans from posting, stores current email in old_e_mail, and removes email + Twitch info), and anonymize-user (POST; randomizes username/name, removes avatar and public PII, clears Twitch info, and returns new username/name). Wire these endpoints into the router and API schema so the web client can call them by name. Build a new admin-only page at /admin/user-info with a user search, status display (including device token/IP and email status), manual email override, and three action buttons (Recover, Delete, Anonymize) that each open a confirmation modal requiring a typed phrase before execution. Add a reusable confirmation modal component. Add a \"Manage Account\" button in the user settings panel for admins that deep-links to the tool with a userId query param. Link the tool from the admin dashboard. Also apply the provided formatting cleanups to the press page.",
      "supplementalFiles": [
        "backend/api/src/helpers/endpoint.ts",
        "backend/api/src/app.ts",
        "backend/shared/src/helpers/auth.ts",
        "backend/shared/src/analytics.ts",
        "backend/shared/src/supabase/init.ts",
        "backend/shared/src/supabase/users.ts",
        "backend/shared/src/supabase/utils.ts",
        "backend/shared/src/utils.ts",
        "web/lib/api/api.ts",
        "web/lib/supabase/users.ts",
        "web/hooks/use-admin.ts",
        "common/src/envs/constants.ts",
        "common/src/util/random.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/admin-delete-user.ts",
          "status": "added",
          "diff": "Index: backend/api/src/admin-delete-user.ts\n===================================================================\n--- backend/api/src/admin-delete-user.ts\t6cbefd3 (parent)\n+++ backend/api/src/admin-delete-user.ts\t60ca4f4 (commit)\n@@ -0,0 +1,65 @@\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { updatePrivateUser, updateUser } from 'shared/supabase/users'\n+import { FieldVal } from 'shared/supabase/utils'\n+import { getPrivateUser, getUser } from 'shared/utils'\n+import { APIError, APIHandler } from './helpers/endpoint'\n+import { throwErrorIfNotAdmin } from 'shared/helpers/auth'\n+import { trackPublicEvent } from 'shared/analytics'\n+import { isAdminId } from 'common/envs/constants'\n+\n+export const adminDeleteUser: APIHandler<'admin-delete-user'> = async (\n+  body,\n+  auth\n+) => {\n+  const { userId } = body\n+\n+  // Only admins can delete accounts\n+  throwErrorIfNotAdmin(auth.uid)\n+\n+  // Prevent deleting admin accounts\n+  if (isAdminId(userId)) {\n+    throw new APIError(403, 'Cannot delete admin accounts')\n+  }\n+\n+  const pg = createSupabaseDirectClient()\n+\n+  // Get the user to verify they exist\n+  const user = await getUser(userId)\n+  if (!user) {\n+    throw new APIError(404, 'User not found')\n+  }\n+\n+  // Check if already deleted\n+  if (user.userDeleted) {\n+    throw new APIError(400, 'User account is already deleted')\n+  }\n+\n+  // Get private user info\n+  const privateUser = await getPrivateUser(userId)\n+  if (!privateUser) {\n+    throw new APIError(404, 'Private user not found')\n+  }\n+\n+  // Track the deletion action\n+  await trackPublicEvent(auth.uid, 'admin delete user', { userId })\n+\n+  // Mirror the self-deletion process:\n+  // 1. Set userDeleted and isBannedFromPosting\n+  await updateUser(pg, userId, {\n+    userDeleted: true,\n+    isBannedFromPosting: true,\n+  })\n+\n+  // 2. Save email to old_e_mail\n+  await updatePrivateUser(pg, userId, {\n+    old_e_mail: privateUser.email ?? '',\n+  })\n+\n+  // 3. Delete email and twitchInfo\n+  await updatePrivateUser(pg, userId, {\n+    email: FieldVal.delete(),\n+    twitchInfo: FieldVal.delete(),\n+  })\n+\n+  return { success: true }\n+}\n"
        },
        {
          "path": "backend/api/src/admin-get-user-info.ts",
          "status": "added",
          "diff": "Index: backend/api/src/admin-get-user-info.ts\n===================================================================\n--- backend/api/src/admin-get-user-info.ts\t6cbefd3 (parent)\n+++ backend/api/src/admin-get-user-info.ts\t60ca4f4 (commit)\n@@ -0,0 +1,44 @@\n+import { getPrivateUser, getUser } from 'shared/utils'\n+import { APIError, APIHandler } from './helpers/endpoint'\n+import { throwErrorIfNotAdmin } from 'shared/helpers/auth'\n+import * as admin from 'firebase-admin'\n+\n+export const adminGetUserInfo: APIHandler<'get-user-info'> = async (\n+  body,\n+  auth\n+) => {\n+  const { userId } = body\n+\n+  // Only admins can view user info\n+  throwErrorIfNotAdmin(auth.uid)\n+\n+  // Get the user to verify they exist\n+  const user = await getUser(userId)\n+  if (!user) {\n+    throw new APIError(404, 'User not found')\n+  }\n+\n+  // Get private user info\n+  const privateUser = await getPrivateUser(userId)\n+  if (!privateUser) {\n+    throw new APIError(404, 'Private user not found')\n+  }\n+\n+  // Try to get Firebase Auth email\n+  let firebaseEmail: string | undefined\n+  try {\n+    const firebaseUser = await admin.auth().getUser(userId)\n+    firebaseEmail = firebaseUser.email\n+  } catch (_error) {\n+    // Firebase user might not exist or be inaccessible\n+    firebaseEmail = undefined\n+  }\n+\n+  return {\n+    supabaseEmail: privateUser.email,\n+    oldEmail: privateUser.old_e_mail,\n+    firebaseEmail,\n+    initialDeviceToken: privateUser.initialDeviceToken,\n+    initialIpAddress: privateUser.initialIpAddress,\n+  }\n+}\n"
        },
        {
          "path": "backend/api/src/admin-recover-user.ts",
          "status": "added",
          "diff": "Index: backend/api/src/admin-recover-user.ts\n===================================================================\n--- backend/api/src/admin-recover-user.ts\t6cbefd3 (parent)\n+++ backend/api/src/admin-recover-user.ts\t60ca4f4 (commit)\n@@ -0,0 +1,71 @@\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { getPrivateUser, getUser } from 'shared/utils'\n+import { updatePrivateUser, updateUser } from 'shared/supabase/users'\n+import { APIError, APIHandler } from './helpers/endpoint'\n+import { throwErrorIfNotAdmin } from 'shared/helpers/auth'\n+import { trackPublicEvent } from 'shared/analytics'\n+import { FieldVal } from 'shared/supabase/utils'\n+\n+export const adminRecoverUser: APIHandler<'recover-user'> = async (body, auth) => {\n+  const { userId, email: manualEmail } = body\n+\n+  // Only admins can recover accounts\n+  throwErrorIfNotAdmin(auth.uid)\n+\n+  const pg = createSupabaseDirectClient()\n+\n+  // Get the user to verify they exist\n+  const user = await getUser(userId)\n+  if (!user) {\n+    throw new APIError(404, 'User not found')\n+  }\n+\n+  // Get private user info\n+  const privateUser = await getPrivateUser(userId)\n+  if (!privateUser) {\n+    throw new APIError(404, 'Private user not found')\n+  }\n+\n+  // Determine which email to use for restoration\n+  let emailToRestore: string | undefined\n+\n+  if (manualEmail) {\n+    // Admin provided a manual email\n+    emailToRestore = manualEmail\n+  } else if (privateUser.old_e_mail) {\n+    // Use saved old_e_mail\n+    emailToRestore = privateUser.old_e_mail\n+  }\n+\n+  // Require an email for recovery\n+  if (!emailToRestore) {\n+    throw new APIError(\n+      400,\n+      'Cannot recover account: no email available. Please provide a manual email address.'\n+    )\n+  }\n+\n+  // Track the recovery action\n+  await trackPublicEvent(auth.uid, 'recover user', { userId })\n+\n+  // Restore the user account\n+  await updateUser(pg, userId, {\n+    userDeleted: false,\n+    isBannedFromPosting: false,\n+  })\n+\n+  // Restore email if we have one and the current email is missing\n+  if (emailToRestore && !privateUser.email) {\n+    await updatePrivateUser(pg, userId, {\n+      email: emailToRestore,\n+    })\n+    // Clear old_e_mail after restoration if it was used\n+    if (privateUser.old_e_mail && !manualEmail) {\n+      await updatePrivateUser(pg, userId, {\n+        old_e_mail: FieldVal.delete(),\n+      })\n+    }\n+  }\n+\n+  return { success: true }\n+}\n"
        },
        {
          "path": "backend/api/src/anonymize-user.ts",
          "status": "added",
          "diff": "Index: backend/api/src/anonymize-user.ts\n===================================================================\n--- backend/api/src/anonymize-user.ts\t6cbefd3 (parent)\n+++ backend/api/src/anonymize-user.ts\t60ca4f4 (commit)\n@@ -0,0 +1,69 @@\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { updatePrivateUser, updateUser } from 'shared/supabase/users'\n+import { getPrivateUser, getUser } from 'shared/utils'\n+import { FieldVal } from 'shared/supabase/utils'\n+import { APIError, APIHandler } from './helpers/endpoint'\n+import { throwErrorIfNotAdmin } from 'shared/helpers/auth'\n+import { trackPublicEvent } from 'shared/analytics'\n+import { isAdminId } from 'common/envs/constants'\n+import { randomString } from 'common/util/random'\n+\n+export const anonymizeUser: APIHandler<'anonymize-user'> = async (\n+  body,\n+  auth\n+) => {\n+  const { userId } = body\n+\n+  // Only admins can anonymize user data\n+  throwErrorIfNotAdmin(auth.uid)\n+\n+  // Prevent anonymizing admin accounts\n+  if (isAdminId(userId)) {\n+    throw new APIError(403, 'Cannot anonymize admin accounts')\n+  }\n+\n+  const pg = createSupabaseDirectClient()\n+\n+  // Get the user to verify they exist\n+  const user = await getUser(userId)\n+  if (!user) {\n+    throw new APIError(404, 'User not found')\n+  }\n+\n+  // Get private user info\n+  const privateUser = await getPrivateUser(userId)\n+  if (!privateUser) {\n+    throw new APIError(404, 'Private user not found')\n+  }\n+\n+  // Track the anonymize action\n+  await trackPublicEvent(auth.uid, 'anonymize user', { userId })\n+\n+  // Generate randomized username\n+  const randomUsername = `deleted_${randomString(8)}`\n+  const randomName = `Deleted User ${randomString(4)}`\n+\n+  // Update public user data - remove all identifying information\n+  await updateUser(pg, userId, {\n+    name: randomName,\n+    username: randomUsername,\n+    avatarUrl: '', // Remove avatar\n+    bio: undefined,\n+    website: undefined,\n+    twitterHandle: undefined,\n+    discordHandle: undefined,\n+  })\n+\n+  // Update private user data - remove identifying information\n+  await updatePrivateUser(pg, userId, {\n+    twitchInfo: FieldVal.delete(),\n+    // Keep email/old_e_mail for potential account recovery\n+    // but admins can manually delete these via Supabase if needed\n+  })\n+\n+  return {\n+    success: true,\n+    newUsername: randomUsername,\n+    newName: randomName,\n+  }\n+}\n"
        },
        {
          "path": "backend/api/src/routes.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/routes.ts\n===================================================================\n--- backend/api/src/routes.ts\t6cbefd3 (parent)\n+++ backend/api/src/routes.ts\t60ca4f4 (commit)\n@@ -183,11 +183,19 @@\n import { purchaseContractBoost } from './purchase-boost'\n import { referUser } from './refer-user'\n import { updatePost } from './update-post'\n import { validateiap } from './validate-iap'\n+import { adminRecoverUser } from './admin-recover-user'\n+import { adminGetUserInfo } from './admin-get-user-info'\n+import { adminDeleteUser } from './admin-delete-user'\n+import { anonymizeUser } from './anonymize-user'\n \n export const handlers: { [k in APIPath]: APIHandler<k> } = {\n   'refresh-all-clients': refreshAllClients,\n+  'recover-user': adminRecoverUser,\n+  'get-user-info': adminGetUserInfo,\n+  'admin-delete-user': adminDeleteUser,\n+  'anonymize-user': anonymizeUser,\n   bet: placeBet,\n   'multi-bet': placeMultiBet,\n   'follow-contract': followContract,\n   'bet/cancel/:betId': cancelBet,\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\t6cbefd3 (parent)\n+++ common/src/api/schema.ts\t60ca4f4 (commit)\n@@ -120,8 +120,59 @@\n       })\n       .strict(),\n     returns: {} as { status: boolean },\n   },\n+  'recover-user': {\n+    method: 'POST',\n+    visibility: 'undocumented',\n+    authed: true,\n+    props: z\n+      .object({\n+        userId: z.string(),\n+        email: z.string().optional(), // Optional manual email override\n+      })\n+      .strict(),\n+    returns: {} as { success: boolean },\n+  },\n+  'get-user-info': {\n+    method: 'GET',\n+    visibility: 'undocumented',\n+    authed: true,\n+    props: z\n+      .object({\n+        userId: z.string(),\n+      })\n+      .strict(),\n+    returns: {} as {\n+      supabaseEmail?: string\n+      oldEmail?: string\n+      firebaseEmail?: string\n+      initialDeviceToken?: string\n+      initialIpAddress?: string\n+    },\n+  },\n+  'admin-delete-user': {\n+    method: 'POST',\n+    visibility: 'undocumented',\n+    authed: true,\n+    props: z\n+      .object({\n+        userId: z.string(),\n+      })\n+      .strict(),\n+    returns: {} as { success: boolean },\n+  },\n+  'anonymize-user': {\n+    method: 'POST',\n+    visibility: 'undocumented',\n+    authed: true,\n+    props: z\n+      .object({\n+        userId: z.string(),\n+      })\n+      .strict(),\n+    returns: {} as { success: boolean; newUsername: string; newName: string },\n+  },\n   comment: {\n     method: 'POST',\n     visibility: 'public',\n     authed: true,\n"
        },
        {
          "path": "web/components/admin/ConfirmActionModal.tsx",
          "status": "added",
          "diff": "Index: web/components/admin/ConfirmActionModal.tsx\n===================================================================\n--- web/components/admin/ConfirmActionModal.tsx\t6cbefd3 (parent)\n+++ web/components/admin/ConfirmActionModal.tsx\t60ca4f4 (commit)\n@@ -0,0 +1,82 @@\n+import { useState } from 'react'\n+import { Modal } from '../layout/modal'\n+import { Col } from '../layout/col'\n+import { Row } from '../layout/row'\n+import { Button } from '../buttons/button'\n+import { Input } from '../widgets/input'\n+\n+export function ConfirmActionModal(props: {\n+  isOpen: boolean\n+  onClose: () => void\n+  onConfirm: () => void\n+  title: string\n+  description: string | React.ReactNode\n+  confirmationWord: string\n+  confirmButtonText: string\n+  confirmButtonColor?: 'green' | 'red' | 'amber'\n+  isSubmitting?: boolean\n+}) {\n+  const {\n+    isOpen,\n+    onClose,\n+    onConfirm,\n+    title,\n+    description,\n+    confirmationWord,\n+    confirmButtonText,\n+    confirmButtonColor = 'red',\n+    isSubmitting,\n+  } = props\n+\n+  const [inputValue, setInputValue] = useState('')\n+\n+  const handleConfirm = () => {\n+    if (inputValue === confirmationWord) {\n+      onConfirm()\n+      setInputValue('')\n+    }\n+  }\n+\n+  const handleClose = () => {\n+    setInputValue('')\n+    onClose()\n+  }\n+\n+  return (\n+    <Modal open={isOpen} setOpen={handleClose} size=\"md\">\n+      <Col className=\"bg-canvas-0 text-ink-1000 gap-4 rounded-md p-6\">\n+        <h2 className=\"text-xl font-semibold\">{title}</h2>\n+\n+        <div className=\"text-ink-700 text-sm\">{description}</div>\n+\n+        <div>\n+          <label className=\"text-ink-700 mb-2 block text-sm font-medium\">\n+            Type \"{confirmationWord}\" to confirm:\n+          </label>\n+          <Input\n+            type=\"text\"\n+            value={inputValue}\n+            onChange={(e) => setInputValue(e.target.value)}\n+            placeholder={confirmationWord}\n+            className=\"w-full\"\n+            disabled={isSubmitting}\n+          />\n+        </div>\n+\n+        <Row className=\"gap-3\">\n+          <Button\n+            color={confirmButtonColor}\n+            onClick={handleConfirm}\n+            disabled={inputValue !== confirmationWord || isSubmitting}\n+            loading={isSubmitting}\n+          >\n+            {confirmButtonText}\n+          </Button>\n+          <Button color=\"gray\" onClick={handleClose} disabled={isSubmitting}>\n+            Cancel\n+          </Button>\n+        </Row>\n+      </Col>\n+    </Modal>\n+  )\n+}\n"
        },
        {
          "path": "web/components/buttons/user-settings-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/buttons/user-settings-button.tsx\n===================================================================\n--- web/components/buttons/user-settings-button.tsx\t6cbefd3 (parent)\n+++ web/components/buttons/user-settings-button.tsx\t60ca4f4 (commit)\n@@ -97,8 +97,17 @@\n             <div className=\"mb-2 flex flex-wrap justify-between\">\n               <Title className={'!mb-0'}>{name}</Title>\n               {(isAdmin || isTrusted) && (\n                 <Row className=\"gap-2\">\n+                  {isAdmin && (\n+                    <Button\n+                      color=\"green\"\n+                      size=\"xs\"\n+                      onClick={() => router.push(`/admin/user-info?userId=${userId}`)}\n+                    >\n+                      Manage Account\n+                    </Button>\n+                  )}\n                   <SuperBanControl userId={userId} />\n                   {user.isBannedFromPosting ? (\n                     <Button\n                       color={'red'}\n"
        },
        {
          "path": "web/pages/admin/index.tsx",
          "status": "modified",
          "diff": "Index: web/pages/admin/index.tsx\n===================================================================\n--- web/pages/admin/index.tsx\t6cbefd3 (parent)\n+++ web/pages/admin/index.tsx\t60ca4f4 (commit)\n@@ -90,8 +90,9 @@\n         <LabCard title=\"🤬 reports\" href=\"/admin/reports\" />\n         <LabCard title=\"🎨 design system\" href=\"/styles\" />\n         <LabCard title=\"🌑 test new user\" href=\"/admin/test-user\" />\n         <LabCard title=\"👤 update user\" href=\"/admin/update-user\" />\n+        <LabCard title=\"👤 user info & account management\" href=\"/admin/user-info\" />\n         <Row className=\"gap-2\">\n           <Button onClick={() => api('refresh-all-clients', {})}>\n             Refresh all clients\n           </Button>\n"
        },
        {
          "path": "web/pages/admin/user-info.tsx",
          "status": "added",
          "diff": "Index: web/pages/admin/user-info.tsx\n===================================================================\n--- web/pages/admin/user-info.tsx\t6cbefd3 (parent)\n+++ web/pages/admin/user-info.tsx\t60ca4f4 (commit)\n@@ -0,0 +1,675 @@\n+import { FullUser } from 'common/api/user-types'\n+import { useEffect, useRef, useState } from 'react'\n+import { toast } from 'react-hot-toast'\n+import { Button } from 'web/components/buttons/button'\n+import { Col } from 'web/components/layout/col'\n+import { Page } from 'web/components/layout/page'\n+import { Row } from 'web/components/layout/row'\n+import { NoSEO } from 'web/components/NoSEO'\n+import { Avatar } from 'web/components/widgets/avatar'\n+import { Input } from 'web/components/widgets/input'\n+import { Title } from 'web/components/widgets/title'\n+import { useAdmin } from 'web/hooks/use-admin'\n+import { useRedirectIfSignedOut } from 'web/hooks/use-redirect-if-signed-out'\n+import { api } from 'web/lib/api/api'\n+import { DisplayUser, searchUsers, getFullUserById } from 'web/lib/supabase/users'\n+import { ConfirmActionModal } from 'web/components/admin/ConfirmActionModal'\n+import { useRouter } from 'next/router'\n+\n+export default function AdminUserInfoPage() {\n+  useRedirectIfSignedOut()\n+  const isAdmin = useAdmin()\n+  const router = useRouter()\n+\n+  const [query, setQuery] = useState('')\n+  const [searchResults, setSearchResults] = useState<DisplayUser[]>([])\n+  const [selectedUser, setSelectedUser] = useState<FullUser | null>(null)\n+  const [isSubmitting, setIsSubmitting] = useState(false)\n+  const [userInfo, setUserInfo] = useState<{\n+    supabaseEmail?: string\n+    oldEmail?: string\n+    firebaseEmail?: string\n+    initialDeviceToken?: string\n+    initialIpAddress?: string\n+  } | null>(null)\n+  const [manualEmail, setManualEmail] = useState('')\n+  const [isLoadingUserInfo, setIsLoadingUserInfo] = useState(false)\n+\n+  // Confirmation modal states\n+  const [showRecoverModal, setShowRecoverModal] = useState(false)\n+  const [showDeleteModal, setShowDeleteModal] = useState(false)\n+  const [showAnonymizeModal, setShowAnonymizeModal] = useState(false)\n+\n+  const requestId = useRef(0)\n+\n+  // Load user from URL parameter if provided\n+  useEffect(() => {\n+    const userId = router.query.userId as string | undefined\n+    if (userId && isAdmin) {\n+      getFullUserById(userId).then((user) => {\n+        if (user) {\n+          setSelectedUser(user)\n+        } else {\n+          toast.error('User not found')\n+        }\n+      })\n+    }\n+  }, [router.query.userId, isAdmin])\n+\n+  // Search for users\n+  useEffect(() => {\n+    const id = ++requestId.current\n+    if (query.length > 1) {\n+      searchUsers(query, 10).then((results) => {\n+        if (id === requestId.current) {\n+          setSearchResults(results)\n+        }\n+      })\n+    } else {\n+      setSearchResults([])\n+    }\n+  }, [query])\n+\n+  // Fetch user info when user is selected\n+  useEffect(() => {\n+    if (selectedUser) {\n+      setIsLoadingUserInfo(true)\n+      api('get-user-info', { userId: selectedUser.id })\n+        .then((info) => {\n+          setUserInfo(info)\n+        })\n+        .catch((error) => {\n+          console.error('Error fetching user info:', error)\n+          toast.error('Failed to fetch user info')\n+        })\n+        .finally(() => {\n+          setIsLoadingUserInfo(false)\n+        })\n+    } else {\n+      setUserInfo(null)\n+      setManualEmail('')\n+    }\n+  }, [selectedUser])\n+\n+  const selectUser = (user: DisplayUser) => {\n+    setSelectedUser(user as FullUser)\n+    setQuery('')\n+    setSearchResults([])\n+  }\n+\n+  const handleRecover = () => {\n+    if (!selectedUser) return\n+\n+    // Check if we have an email to restore\n+    const hasOldEmail = userInfo?.oldEmail\n+    const hasManualEmail = manualEmail.trim().length > 0\n+\n+    if (!hasOldEmail && !hasManualEmail) {\n+      toast.error(\n+        'No email available to restore. Please enter an email address manually.'\n+      )\n+      return\n+    }\n+\n+    setShowRecoverModal(true)\n+  }\n+\n+  const confirmRecover = async () => {\n+    if (!selectedUser) return\n+\n+    setShowRecoverModal(false)\n+    setIsSubmitting(true)\n+\n+    try {\n+      const hasManualEmail = manualEmail.trim().length > 0\n+      await api('recover-user', {\n+        userId: selectedUser.id,\n+        email: hasManualEmail ? manualEmail : undefined,\n+      })\n+      toast.success(`Account recovered successfully for ${selectedUser.name}!`)\n+\n+      // Refresh the user data\n+      setSelectedUser(null)\n+      setQuery('')\n+    } catch (error) {\n+      console.error('Error recovering user:', error)\n+      toast.error(\n+        error instanceof Error ? error.message : 'Failed to recover user account'\n+      )\n+    } finally {\n+      setIsSubmitting(false)\n+    }\n+  }\n+\n+  const handleDelete = () => {\n+    if (!selectedUser) return\n+    setShowDeleteModal(true)\n+  }\n+\n+  const confirmDelete = async () => {\n+    if (!selectedUser) return\n+\n+    setShowDeleteModal(false)\n+    setIsSubmitting(true)\n+\n+    try {\n+      await api('admin-delete-user', {\n+        userId: selectedUser.id,\n+      })\n+      toast.success(`Account deleted successfully for ${selectedUser.name}.`)\n+\n+      // Refresh the user data\n+      setSelectedUser(null)\n+      setQuery('')\n+    } catch (error) {\n+      console.error('Error deleting user:', error)\n+      toast.error(\n+        error instanceof Error ? error.message : 'Failed to delete user account'\n+      )\n+    } finally {\n+      setIsSubmitting(false)\n+    }\n+  }\n+\n+  const handleAnonymize = () => {\n+    if (!selectedUser) return\n+    setShowAnonymizeModal(true)\n+  }\n+\n+  const confirmAnonymize = async () => {\n+    if (!selectedUser) return\n+\n+    setShowAnonymizeModal(false)\n+    setIsSubmitting(true)\n+\n+    try {\n+      const result = await api('anonymize-user', {\n+        userId: selectedUser.id,\n+      })\n+      toast.success(\n+        `User anonymized. New username: ${result.newUsername}, New name: ${result.newName}`\n+      )\n+\n+      // Refresh the user data\n+      setSelectedUser(null)\n+      setQuery('')\n+    } catch (error) {\n+      console.error('Error anonymizing user:', error)\n+      toast.error(\n+        error instanceof Error ? error.message : 'Failed to anonymize user'\n+      )\n+    } finally {\n+      setIsSubmitting(false)\n+    }\n+  }\n+\n+  if (!isAdmin) return <></>\n+\n+  return (\n+    <Page trackPageView={'admin user info page'}>\n+      <NoSEO />\n+      <div className=\"mx-8\">\n+        <Title>Admin - User Info & Account Management</Title>\n+\n+        <Col className=\"gap-6\">\n+          {/* Info Section */}\n+          <div className=\"border-ink-200 bg-blue-50 rounded-lg border p-4\">\n+            <h3 className=\"mb-2 font-semibold text-blue-900\">\n+              Account Management Information\n+            </h3>\n+            <p className=\"text-sm text-blue-800\">\n+              This tool allows you to delete or recover user accounts.\n+            </p>\n+            <div className=\"mt-3\">\n+              <p className=\"mb-1 text-sm font-semibold text-blue-900\">\n+                When you delete an account:\n+              </p>\n+              <ul className=\"list-inside list-disc space-y-1 text-sm text-blue-800\">\n+                <li>\n+                  Set <code>userDeleted</code> to <code>true</code>\n+                </li>\n+                <li>\n+                  Set <code>isBannedFromPosting</code> to <code>true</code>\n+                </li>\n+                <li>\n+                  Save email to <code>old_e_mail</code> for recovery\n+                </li>\n+                <li>Delete email and Twitch info</li>\n+              </ul>\n+            </div>\n+            <div className=\"mt-3\">\n+              <p className=\"mb-1 text-sm font-semibold text-blue-900\">\n+                When you recover an account:\n+              </p>\n+              <ul className=\"list-inside list-disc space-y-1 text-sm text-blue-800\">\n+                <li>\n+                  Set <code>userDeleted</code> to <code>false</code>\n+                </li>\n+                <li>\n+                  Set <code>isBannedFromPosting</code> to <code>false</code>\n+                </li>\n+                <li>\n+                  Restore email (from <code>old_e_mail</code> or manual input)\n+                </li>\n+              </ul>\n+            </div>\n+            <div className=\"mt-3\">\n+              <p className=\"mb-1 text-sm font-semibold text-amber-900\">\n+                When you anonymize a user:\n+              </p>\n+              <ul className=\"list-inside list-disc space-y-1 text-sm text-amber-800\">\n+                <li>Randomize username and name (cannot be undone)</li>\n+                <li>Delete avatar, bio, website</li>\n+                <li>Delete Twitter, Discord handles</li>\n+                <li>Delete Twitch info</li>\n+                <li>\n+                  Email/old_e_mail preserved (for recovery or manual deletion)\n+                </li>\n+              </ul>\n+            </div>\n+          </div>\n+\n+          {/* User Search Section */}\n+          <div>\n+            <h2 className=\"mb-4 text-lg font-semibold\">Search for User</h2>\n+            <p className=\"text-ink-600 mb-4 text-sm\">\n+              Search by username, name, or user ID. Deleted accounts will still\n+              appear in search results.\n+            </p>\n+            <div className=\"relative\">\n+              <Input\n+                type=\"text\"\n+                placeholder=\"Search by name, username, or ID...\"\n+                value={query}\n+                onChange={(e) => setQuery(e.target.value)}\n+                className=\"w-full max-w-md\"\n+              />\n+\n+              {searchResults.length > 0 && (\n+                <div className=\"bg-canvas-0 border-ink-200 absolute top-full z-10 mt-1 max-h-64 w-full max-w-md overflow-auto rounded-md border shadow-lg\">\n+                  {searchResults.map((user) => (\n+                    <button\n+                      key={user.id}\n+                      className=\"hover:bg-canvas-50 flex w-full items-center gap-3 p-3 text-left\"\n+                      onClick={() => selectUser(user)}\n+                    >\n+                      <Avatar\n+                        username={user.username}\n+                        avatarUrl={user.avatarUrl}\n+                        size=\"sm\"\n+                      />\n+                      <div>\n+                        <div className=\"font-medium\">\n+                          {user.name}\n+                          {(user as any).userDeleted && (\n+                            <span className=\"ml-2 text-xs text-red-600\">\n+                              [DELETED]\n+                            </span>\n+                          )}\n+                        </div>\n+                        <div className=\"text-ink-600 text-sm\">\n+                          @{user.username}\n+                        </div>\n+                      </div>\n+                    </button>\n+                  ))}\n+                </div>\n+              )}\n+            </div>\n+          </div>\n+\n+          {/* Selected User Info */}\n+          {selectedUser && (\n+            <div className=\"border-ink-200 rounded-lg border p-6\">\n+              <h2 className=\"mb-4 text-lg font-semibold\">Selected User</h2>\n+              <Row className=\"mb-4 items-center gap-4\">\n+                <Avatar\n+                  username={selectedUser.username}\n+                  avatarUrl={selectedUser.avatarUrl}\n+                  size=\"lg\"\n+                />\n+                <div>\n+                  <div className=\"font-medium\">{selectedUser.name}</div>\n+                  <div className=\"text-ink-600\">@{selectedUser.username}</div>\n+                  <div className=\"text-ink-500 text-sm\">\n+                    ID: {selectedUser.id}\n+                  </div>\n+                </div>\n+              </Row>\n+\n+              {/* User Info */}\n+              <div className=\"border-ink-200 mb-4 space-y-2 rounded border p-4\">\n+                <h3 className=\"font-semibold\">User Information</h3>\n+                {isLoadingUserInfo ? (\n+                  <div className=\"text-ink-600 text-sm\">\n+                    Loading user info...\n+                  </div>\n+                ) : userInfo ? (\n+                  <div className=\"space-y-2\">\n+                    <div>\n+                      <span className=\"text-ink-600 text-sm\">Initial Device Token: </span>\n+                      <span className=\"font-mono text-sm\">\n+                        {userInfo.initialDeviceToken || 'None'}\n+                      </span>\n+                    </div>\n+                    <div>\n+                      <span className=\"text-ink-600 text-sm\">Initial IP Address: </span>\n+                      <span className=\"font-mono text-sm\">\n+                        {userInfo.initialIpAddress || 'None'}\n+                      </span>\n+                    </div>\n+                  </div>\n+                ) : null}\n+              </div>\n+\n+              {/* Account Status */}\n+              <div className=\"border-ink-200 mb-4 space-y-2 rounded border p-4\">\n+                <h3 className=\"font-semibold\">Account Status</h3>\n+                <Row className=\"gap-4\">\n+                  <div>\n+                    <span className=\"text-ink-600 text-sm\">Deleted: </span>\n+                    <span\n+                      className={`font-medium ${\n+                        selectedUser.userDeleted\n+                          ? 'text-red-600'\n+                          : 'text-green-600'\n+                      }`}\n+                    >\n+                      {selectedUser.userDeleted ? 'Yes' : 'No'}\n+                    </span>\n+                  </div>\n+                  <div>\n+                    <span className=\"text-ink-600 text-sm\">\n+                      Banned from posting:{' '}\n+                    </span>\n+                    <span\n+                      className={`font-medium ${\n+                        selectedUser.isBannedFromPosting\n+                          ? 'text-red-600'\n+                          : 'text-green-600'\n+                      }`}\n+                    >\n+                      {selectedUser.isBannedFromPosting ? 'Yes' : 'No'}\n+                    </span>\n+                  </div>\n+                </Row>\n+              </div>\n+\n+              {/* Email Status */}\n+              <div className=\"border-ink-200 mb-4 space-y-3 rounded border p-4\">\n+                <h3 className=\"font-semibold\">Email Status</h3>\n+                {isLoadingUserInfo ? (\n+                  <div className=\"text-ink-600 text-sm\">\n+                    Loading email status...\n+                  </div>\n+                ) : userInfo ? (\n+                  <div className=\"space-y-2\">\n+                    <div>\n+                      <span className=\"text-ink-600 text-sm\">\n+                        Current Supabase Email:{' '}\n+                      </span>\n+                      <span\n+                        className={`font-mono text-sm ${\n+                          userInfo.supabaseEmail\n+                            ? 'text-green-600'\n+                            : 'text-red-600'\n+                        }`}\n+                      >\n+                        {userInfo.supabaseEmail || 'None'}\n+                      </span>\n+                    </div>\n+                    <div>\n+                      <span className=\"text-ink-600 text-sm\">\n+                        Saved old_e_mail:{' '}\n+                      </span>\n+                      <span\n+                        className={`font-mono text-sm ${\n+                          userInfo.oldEmail\n+                            ? 'text-green-600'\n+                            : 'text-orange-600'\n+                        }`}\n+                      >\n+                        {userInfo.oldEmail || 'None (manual input required)'}\n+                      </span>\n+                    </div>\n+                    <div>\n+                      <span className=\"text-ink-600 text-sm\">\n+                        Firebase Auth Email:{' '}\n+                      </span>\n+                      <span className=\"font-mono text-sm text-blue-600\">\n+                        {userInfo.firebaseEmail || 'Not available'}\n+                      </span>\n+                      {userInfo.firebaseEmail && (\n+                        <button\n+                          onClick={() =>\n+                            setManualEmail(userInfo.firebaseEmail || '')\n+                          }\n+                          className=\"text-primary-600 ml-2 text-xs underline\"\n+                        >\n+                          Use this\n+                        </button>\n+                      )}\n+                    </div>\n+\n+                    {!userInfo.oldEmail && (\n+                      <div className=\"bg-orange-50 border-orange-200 mt-3 rounded border p-3\">\n+                        <p className=\"text-sm text-orange-800\">\n+                          <strong>⚠️ No old_e_mail found.</strong> You must\n+                          manually enter an email address below. Use the Firebase\n+                          Auth email shown above or verify the correct email in\n+                          the Firebase console.\n+                        </p>\n+                      </div>\n+                    )}\n+                  </div>\n+                ) : null}\n+              </div>\n+\n+              {/* Manual Email Input */}\n+              {(!userInfo?.oldEmail || manualEmail) && (\n+                <div className=\"mb-4\">\n+                  <label className=\"text-ink-700 mb-2 block text-sm font-medium\">\n+                    Manual Email Override{' '}\n+                    {!userInfo?.oldEmail && (\n+                      <span className=\"text-red-600\">*</span>\n+                    )}\n+                  </label>\n+                  <Input\n+                    type=\"email\"\n+                    value={manualEmail}\n+                    onChange={(e) => setManualEmail(e.target.value)}\n+                    placeholder=\"Enter email address\"\n+                    className=\"w-full max-w-md\"\n+                  />\n+                  <p className=\"text-ink-500 mt-1 text-xs\">\n+                    {userInfo?.oldEmail\n+                      ? 'Leave empty to use old_e_mail, or enter a different email to override.'\n+                      : 'Required: Enter the email address to restore for this account.'}\n+                  </p>\n+                </div>\n+              )}\n+\n+              {/* Action Buttons */}\n+              <div className=\"space-y-3\">\n+                <Row className=\"gap-3\">\n+                  <Button\n+                    onClick={handleRecover}\n+                    disabled={\n+                      isSubmitting ||\n+                      isLoadingUserInfo ||\n+                      (!selectedUser.userDeleted &&\n+                        !selectedUser.isBannedFromPosting)\n+                    }\n+                    loading={isSubmitting}\n+                    color=\"green\"\n+                  >\n+                    Recover Account\n+                  </Button>\n+\n+                  <Button\n+                    onClick={handleDelete}\n+                    disabled={\n+                      isSubmitting ||\n+                      isLoadingUserInfo ||\n+                      selectedUser.userDeleted\n+                    }\n+                    loading={isSubmitting}\n+                    color=\"red\"\n+                  >\n+                    Delete Account\n+                  </Button>\n+\n+                  <Button\n+                    onClick={handleAnonymize}\n+                    disabled={isSubmitting || isLoadingUserInfo}\n+                    loading={isSubmitting}\n+                    color=\"amber\"\n+                  >\n+                    Anonymize User\n+                  </Button>\n+                </Row>\n+\n+                <Row className=\"gap-3\">\n+                  <Button\n+                    type=\"button\"\n+                    color=\"gray\"\n+                    onClick={() => setSelectedUser(null)}\n+                  >\n+                    Cancel\n+                  </Button>\n+                </Row>\n+\n+                {/* Button Status Explanations */}\n+                <div className=\"text-ink-600 space-y-1 text-xs\">\n+                  {(!selectedUser.userDeleted &&\n+                    !selectedUser.isBannedFromPosting) && (\n+                    <p className=\"text-gray-500\">\n+                      • Recover is disabled (account is not deleted)\n+                    </p>\n+                  )}\n+                  {selectedUser.userDeleted && (\n+                    <p className=\"text-gray-500\">\n+                      • Delete is disabled (account is already deleted)\n+                    </p>\n+                  )}\n+                  <p>\n+                    • Anonymize can be used on any account to remove identifying\n+                    information\n+                  </p>\n+                </div>\n+              </div>\n+            </div>\n+          )}\n+        </Col>\n+      </div>\n+\n+      {/* Confirmation Modals */}\n+      {selectedUser && (\n+        <>\n+          <ConfirmActionModal\n+            isOpen={showRecoverModal}\n+            onClose={() => setShowRecoverModal(false)}\n+            onConfirm={confirmRecover}\n+            title=\"Recover User Account\"\n+            description={\n+              <>\n+                Are you sure you want to recover the account for{' '}\n+                <strong>\n+                  {selectedUser.name} (@{selectedUser.username})\n+                </strong>\n+                ?\n+                <br />\n+                <br />\n+                This will:\n+                <ul className=\"list-inside list-disc space-y-1\">\n+                  <li>\n+                    Set <code>userDeleted</code> to <code>false</code>\n+                  </li>\n+                  <li>\n+                    Set <code>isBannedFromPosting</code> to <code>false</code>\n+                  </li>\n+                  <li>\n+                    Restore email to:{' '}\n+                    {manualEmail.trim()\n+                      ? manualEmail\n+                      : userInfo?.oldEmail || 'unknown'}\n+                  </li>\n+                </ul>\n+              </>\n+            }\n+            confirmationWord=\"recover account\"\n+            confirmButtonText=\"Recover Account\"\n+            confirmButtonColor=\"green\"\n+            isSubmitting={isSubmitting}\n+          />\n+\n+          <ConfirmActionModal\n+            isOpen={showDeleteModal}\n+            onClose={() => setShowDeleteModal(false)}\n+            onConfirm={confirmDelete}\n+            title=\"Delete User Account\"\n+            description={\n+              <>\n+                <strong>⚠️ WARNING:</strong> Are you sure you want to DELETE the\n+                account for{' '}\n+                <strong>\n+                  {selectedUser.name} (@{selectedUser.username})\n+                </strong>\n+                ?\n+                <br />\n+                <br />\n+                This will:\n+                <ul className=\"list-inside list-disc space-y-1\">\n+                  <li>\n+                    Set <code>userDeleted</code> to <code>true</code>\n+                  </li>\n+                  <li>\n+                    Set <code>isBannedFromPosting</code> to <code>true</code>\n+                  </li>\n+                  <li>\n+                    Save current email to <code>old_e_mail</code>\n+                  </li>\n+                  <li>Delete their email and Twitch info</li>\n+                </ul>\n+              </>\n+            }\n+            confirmationWord=\"delete account\"\n+            confirmButtonText=\"Delete Account\"\n+            confirmButtonColor=\"red\"\n+            isSubmitting={isSubmitting}\n+          />\n+\n+          <ConfirmActionModal\n+            isOpen={showAnonymizeModal}\n+            onClose={() => setShowAnonymizeModal(false)}\n+            onConfirm={confirmAnonymize}\n+            title=\"Anonymize User\"\n+            description={\n+              <>\n+                <strong>⚠️ WARNING:</strong> Are you sure you want to ANONYMIZE{' '}\n+                <strong>\n+                  {selectedUser.name} (@{selectedUser.username})\n+                </strong>\n+                ?\n+                <br />\n+                <br />\n+                This will <strong>permanently</strong>:\n+                <ul className=\"list-inside list-disc space-y-1\">\n+                  <li>Randomize username and name (cannot be undone)</li>\n+                  <li>Delete avatar, bio, website</li>\n+                  <li>Delete Twitter, Discord handles</li>\n+                  <li>Delete Twitch info</li>\n+                  <li>Preserve email/old_e_mail for potential recovery</li>\n+                </ul>\n+              </>\n+            }\n+            confirmationWord=\"anonymize\"\n+            confirmButtonText=\"Anonymize User\"\n+            confirmButtonColor=\"amber\"\n+            isSubmitting={isSubmitting}\n+          />\n+        </>\n+      )}\n+    </Page>\n+  )\n+}\n"
        },
        {
          "path": "web/pages/press.tsx",
          "status": "modified",
          "diff": "Index: web/pages/press.tsx\n===================================================================\n--- web/pages/press.tsx\t6cbefd3 (parent)\n+++ web/pages/press.tsx\t60ca4f4 (commit)\n@@ -6,9 +6,9 @@\n import { LogoIcon } from 'web/components/icons/logo-icon'\n import { BadgeCheckIcon, ShieldCheckIcon } from '@heroicons/react/outline'\n import { BsFillArrowThroughHeartFill } from 'react-icons/bs'\n import { LuCrown, LuSprout } from 'react-icons/lu'\n-import { GiOpenChest, GiTwoCoins } from 'react-icons/gi'\n+import { GiBurningSkull, GiOpenChest, GiTwoCoins } from 'react-icons/gi'\n import { HiOutlineBuildingLibrary } from 'react-icons/hi2'\n import ScalesIcon from 'web/lib/icons/scales-icon.svg'\n import Foldy from 'web/public/logo.svg'\n import { useState } from 'react'\n@@ -46,26 +46,18 @@\n     },\n     {\n       title: 'Moderator',\n       description: 'Community moderators',\n-      icon: (\n-        <ShieldCheckIcon className=\"h-5 w-5 text-purple-700 dark:text-purple-400\" />\n-      ),\n-      largeIcon: (\n-        <ShieldCheckIcon className=\"h-32 w-32 text-purple-700 dark:text-purple-400\" />\n-      ),\n+      icon: <ShieldCheckIcon className=\"h-5 w-5 text-purple-700 dark:text-purple-400\" />,\n+      largeIcon: <ShieldCheckIcon className=\"h-32 w-32 text-purple-700 dark:text-purple-400\" />,\n       iconDesc: 'ShieldCheckIcon (Heroicons)',\n       color: 'Purple-700',\n     },\n     {\n       title: 'MVP',\n       description: 'Most Valuable Players',\n-      icon: (\n-        <BsFillArrowThroughHeartFill className=\"h-5 w-5 text-purple-700 dark:text-purple-400\" />\n-      ),\n-      largeIcon: (\n-        <BsFillArrowThroughHeartFill className=\"h-32 w-32 text-purple-700 dark:text-purple-400\" />\n-      ),\n+      icon: <BsFillArrowThroughHeartFill className=\"h-5 w-5 text-purple-700 dark:text-purple-400\" />,\n+      largeIcon: <BsFillArrowThroughHeartFill className=\"h-32 w-32 text-purple-700 dark:text-purple-400\" />,\n       iconDesc: 'BsFillArrowThroughHeartFill',\n       color: 'Purple-700',\n     },\n     {\n@@ -87,11 +79,9 @@\n     {\n       title: 'Institutional Partner',\n       description: 'Institutional partners',\n       icon: <HiOutlineBuildingLibrary className=\"text-primary-700 h-5 w-5\" />,\n-      largeIcon: (\n-        <HiOutlineBuildingLibrary className=\"text-primary-700 h-32 w-32\" />\n-      ),\n+      largeIcon: <HiOutlineBuildingLibrary className=\"text-primary-700 h-32 w-32\" />,\n       iconDesc: 'HiOutlineBuildingLibrary',\n       color: 'Primary-700',\n     },\n     {\n@@ -142,45 +132,29 @@\n           Brand assets and marketing materials for Manifold Markets\n         </p>\n         <div className=\"bg-primary-100 border-primary-300 text-primary-800 mb-6 rounded-lg border p-4\">\n           <p className=\"text-sm\">\n-            <strong>Note:</strong> This page is optimized for light mode viewing\n-            and screenshot capture.\n+            <strong>Note:</strong> This page is optimized for light mode viewing and screenshot capture.\n           </p>\n         </div>\n \n         {/* MANIFOLD Brand Wordmark */}\n         <div className=\"bg-canvas-0 mb-8 flex flex-col gap-6 rounded-lg border p-8\">\n           <div className=\"flex flex-col gap-4\">\n-            <h3 className=\"text-ink-800 text-lg font-semibold\">\n-              Primary Wordmark\n-            </h3>\n+            <h3 className=\"text-ink-800 text-lg font-semibold\">Primary Wordmark</h3>\n             <div className=\"flex items-center justify-center gap-1 py-12 md:gap-2\">\n-              <LogoIcon\n-                className=\"h-12 w-12 stroke-indigo-700 md:h-24 md:w-24\"\n-                strokeWidth=\"0.6\"\n-              />\n-              <div className=\"text-3xl font-thin text-indigo-700 md:text-6xl\">\n-                MANIFOLD\n-              </div>\n+              <LogoIcon className=\"h-12 w-12 stroke-indigo-700 md:h-24 md:w-24\" strokeWidth=\"0.6\" />\n+              <div className=\"text-3xl font-thin text-indigo-700 md:text-6xl\">MANIFOLD</div>\n             </div>\n             <p className=\"text-ink-500 text-center text-sm\">\n-              Reference size - Logo: h-10 w-10, Text: text-xl font-thin, Gap:\n-              gap-0.5\n+              Reference size - Logo: h-10 w-10, Text: text-xl font-thin, Gap: gap-0.5\n             </p>\n           </div>\n           <div className=\"flex flex-col gap-4\">\n-            <h3 className=\"text-ink-800 text-lg font-semibold\">\n-              White Wordmark (for dark backgrounds)\n-            </h3>\n+            <h3 className=\"text-ink-800 text-lg font-semibold\">White Wordmark (for dark backgrounds)</h3>\n             <div className=\"flex items-center justify-center gap-1 bg-black py-12 md:gap-2\">\n-              <LogoIcon\n-                className=\"h-12 w-12 stroke-white md:h-24 md:w-24\"\n-                strokeWidth=\"0.6\"\n-              />\n-              <div className=\"text-3xl font-thin text-white md:text-6xl\">\n-                MANIFOLD\n-              </div>\n+              <LogoIcon className=\"h-12 w-12 stroke-white md:h-24 md:w-24\" strokeWidth=\"0.6\" />\n+              <div className=\"text-3xl font-thin text-white md:text-6xl\">MANIFOLD</div>\n             </div>\n             <p className=\"text-ink-500 text-center text-sm\">\n               Same proportions on dark background\n             </p>\n@@ -232,21 +206,15 @@\n                   downloadPath=\"/fonts/Figtree-VariableFont_wght.ttf\"\n                 />\n                 <div className=\"bg-canvas-50 rounded-lg border p-4\">\n                   <p className=\"text-ink-600 text-sm\">\n-                    <strong>Wordmark Usage:</strong> The \"MANIFOLD\" wordmark\n-                    uses <strong>Figtree Thin (weight 300)</strong>. For proper\n-                    sizing, use{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">font-thin</code>{' '}\n-                    and scale proportionally with the logo. Desktop:{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">text-6xl</code>{' '}\n-                    (60px), Mobile:{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">text-3xl</code>{' '}\n-                    (30px). Maintain a{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">gap-2</code> (8px)\n-                    between logo and text on desktop,\n-                    <code className=\"bg-ink-100 rounded px-1\">gap-1</code> (4px)\n-                    on mobile.\n+                    <strong>Wordmark Usage:</strong> The \"MANIFOLD\" wordmark uses{' '}\n+                    <strong>Figtree Thin (weight 300)</strong>. For proper sizing, use{' '}\n+                    <code className=\"bg-ink-100 rounded px-1\">font-thin</code> and scale\n+                    proportionally with the logo. Desktop: <code className=\"bg-ink-100 rounded px-1\">text-6xl</code>{' '}\n+                    (60px), Mobile: <code className=\"bg-ink-100 rounded px-1\">text-3xl</code> (30px).\n+                    Maintain a <code className=\"bg-ink-100 rounded px-1\">gap-2</code> (8px) between logo and text on desktop,\n+                    <code className=\"bg-ink-100 rounded px-1\">gap-1</code> (4px) on mobile.\n                   </p>\n                 </div>\n                 <FontExample\n                   name=\"Readex Pro\"\n@@ -315,38 +283,28 @@\n \n         {/* User Badges Section */}\n         <Section title=\"User Badges & Modifiers\">\n           <div className=\"bg-canvas-0 mb-6 rounded-lg border p-6\">\n-            <h3 className=\"text-ink-800 mb-4 text-lg font-semibold\">\n-              Role Badges\n-            </h3>\n+            <h3 className=\"text-ink-800 mb-4 text-lg font-semibold\">Role Badges</h3>\n             <p className=\"text-ink-600 mb-4 text-sm\">\n-              These badges appear next to usernames to indicate special roles or\n-              status. Icons are from Heroicons, React Icons libraries, and\n-              custom SVGs.\n-              <strong>\n-                {' '}\n-                Click any badge to display it large for screenshotting.\n-              </strong>\n+              These badges appear next to usernames to indicate special roles or status.\n+              Icons are from Heroicons, React Icons libraries, and custom SVGs.\n+              <strong> Click any badge to display it large for screenshotting.</strong>\n             </p>\n \n             <div className=\"grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3\">\n               {badges.map((badge) => (\n                 <BadgeExample\n                   key={badge.title}\n                   badge={badge}\n-                  onClick={() =>\n-                    setSelectedBadge(\n-                      selectedBadge?.title === badge.title ? null : badge\n-                    )\n-                  }\n+                  onClick={() => setSelectedBadge(selectedBadge?.title === badge.title ? null : badge)}\n                 />\n               ))}\n             </div>\n \n             {/* Large Badge Display */}\n             {selectedBadge && (\n-              <div className=\"border-primary-500 mt-6 flex flex-col items-center justify-center rounded-lg border-2 bg-white p-12\">\n+              <div className=\"mt-6 flex flex-col items-center justify-center rounded-lg border-2 border-primary-500 bg-white p-12\">\n                 <div className=\"mb-4 flex items-center justify-center\">\n                   {selectedBadge.largeIcon}\n                 </div>\n                 <h4 className=\"text-ink-800 mb-2 text-2xl font-bold\">\n@@ -365,11 +323,9 @@\n             )}\n           </div>\n \n           <div className=\"bg-canvas-0 rounded-lg border p-6\">\n-            <h3 className=\"text-ink-800 mb-4 text-lg font-semibold\">\n-              Achievement Badges\n-            </h3>\n+            <h3 className=\"text-ink-800 mb-4 text-lg font-semibold\">Achievement Badges</h3>\n             <p className=\"text-ink-600 mb-4 text-sm\">\n               User achievement badges for milestones and accomplishments.\n             </p>\n             <div className=\"grid grid-cols-2 gap-4 md:grid-cols-4 lg:grid-cols-6\">\n@@ -467,14 +423,11 @@\n           </div>\n \n           {/* Loan Chest */}\n           <div className=\"bg-canvas-0 rounded-lg border p-6\">\n-            <h3 className=\"text-ink-800 mb-4 text-lg font-semibold\">\n-              Daily Loan Chest\n-            </h3>\n+            <h3 className=\"text-ink-800 mb-4 text-lg font-semibold\">Daily Loan Chest</h3>\n             <p className=\"text-ink-600 mb-4 text-sm\">\n-              The loan chest appears in the UI to allow users to collect daily\n-              loans on their trades.\n+              The loan chest appears in the UI to allow users to collect daily loans on their trades.\n             </p>\n             <div className=\"grid grid-cols-2 gap-6 md:grid-cols-2\">\n               {/* Available Loan State */}\n               <div className=\"flex flex-col items-center justify-center rounded-lg border p-8\">\n@@ -505,20 +458,13 @@\n               </div>\n             </div>\n             <div className=\"bg-canvas-50 mt-4 rounded-lg border p-4\">\n               <p className=\"text-ink-600 text-sm\">\n-                <strong>Icons:</strong> From{' '}\n-                <code className=\"bg-ink-100 rounded px-1\">react-icons/gi</code>\n+                <strong>Icons:</strong> From <code className=\"bg-ink-100 rounded px-1\">react-icons/gi</code>\n               </p>\n               <ul className=\"text-ink-600 mt-2 list-inside list-disc space-y-1 text-sm\">\n-                <li>\n-                  <code className=\"bg-ink-100 rounded px-1\">GiTwoCoins</code> -\n-                  Available loan state (text-yellow-300)\n-                </li>\n-                <li>\n-                  <code className=\"bg-ink-100 rounded px-1\">GiOpenChest</code> -\n-                  Collected/empty state (text-yellow-900)\n-                </li>\n+                <li><code className=\"bg-ink-100 rounded px-1\">GiTwoCoins</code> - Available loan state (text-yellow-300)</li>\n+                <li><code className=\"bg-ink-100 rounded px-1\">GiOpenChest</code> - Collected/empty state (text-yellow-900)</li>\n               </ul>\n             </div>\n           </div>\n         </Section>\n@@ -526,14 +472,12 @@\n         {/* Mock Market - Modern Full Page Style */}\n         <Section title=\"Mock Market - Full Page Style (for Screenshots)\">\n           <div className=\"bg-canvas-0 rounded-lg border p-6\">\n             <p className=\"text-ink-600 mb-4 text-center\">\n-              Create custom market previews for screenshots and promotional\n-              materials\n+              Create custom market previews for screenshots and promotional materials\n             </p>\n             <p className=\"text-ink-600 mb-6 text-center text-sm\">\n-              <strong>Tip:</strong> On binary markets, you can drag the points\n-              on the chart up and down to customize the chart history!\n+              <strong>Tip:</strong> On binary markets, you can drag the points on the chart up and down to customize the chart history!\n             </p>\n             <MockMarket />\n           </div>\n         </Section>\n@@ -566,11 +510,9 @@\n               </div>\n               <div>\n                 <h3 className=\"mb-2 font-semibold\">Color Usage</h3>\n                 <ul className=\"text-ink-600 list-inside list-disc space-y-1\">\n-                  <li>\n-                    Teal (Yes) represents affirmative actions and outcomes\n-                  </li>\n+                  <li>Teal (Yes) represents affirmative actions and outcomes</li>\n                   <li>Scarlet (No) represents negative actions and outcomes</li>\n                   <li>\n                     Indigo is the primary brand color for general UI elements\n                   </li>\n@@ -579,43 +521,24 @@\n               <div>\n                 <h3 className=\"mb-2 font-semibold\">Design Style Conventions</h3>\n                 <ul className=\"text-ink-600 list-inside list-disc space-y-1\">\n                   <li>\n-                    <strong>Border Radius:</strong> Use{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">rounded-md</code>{' '}\n-                    (0.375rem / 6px) for buttons and most UI elements\n+                    <strong>Border Radius:</strong> Use <code className=\"bg-ink-100 rounded px-1\">rounded-md</code> (0.375rem / 6px) for buttons and most UI elements\n                   </li>\n                   <li>\n-                    <strong>Border Radius (Cards):</strong> Use{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">rounded-lg</code>{' '}\n-                    (0.5rem / 8px) for cards and containers\n+                    <strong>Border Radius (Cards):</strong> Use <code className=\"bg-ink-100 rounded px-1\">rounded-lg</code> (0.5rem / 8px) for cards and containers\n                   </li>\n                   <li>\n-                    <strong>Border Radius (Pills):</strong> Use{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">\n-                      rounded-full\n-                    </code>{' '}\n-                    for pill-shaped elements like tags\n+                    <strong>Border Radius (Pills):</strong> Use <code className=\"bg-ink-100 rounded px-1\">rounded-full</code> for pill-shaped elements like tags\n                   </li>\n                   <li>\n-                    <strong>Button Sizing:</strong> Standard buttons use{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">px-6 py-2.5</code>{' '}\n-                    with{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">text-base</code>{' '}\n-                    (16px) and{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">\n-                      font-semibold\n-                    </code>\n+                    <strong>Button Sizing:</strong> Standard buttons use <code className=\"bg-ink-100 rounded px-1\">px-6 py-2.5</code> with <code className=\"bg-ink-100 rounded px-1\">text-base</code> (16px) and <code className=\"bg-ink-100 rounded px-1\">font-semibold</code>\n                   </li>\n                   <li>\n-                    <strong>Shadows:</strong> Cards use{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">shadow-md</code>{' '}\n-                    for elevation\n+                    <strong>Shadows:</strong> Cards use <code className=\"bg-ink-100 rounded px-1\">shadow-md</code> for elevation\n                   </li>\n                   <li>\n-                    <strong>Spacing:</strong> Use consistent gap spacing -{' '}\n-                    <code className=\"bg-ink-100 rounded px-1\">gap-3</code>{' '}\n-                    (0.75rem) between related elements\n+                    <strong>Spacing:</strong> Use consistent gap spacing - <code className=\"bg-ink-100 rounded px-1\">gap-3</code> (0.75rem) between related elements\n                   </li>\n                 </ul>\n               </div>\n               <div>\n@@ -682,14 +605,11 @@\n               Reset to Default\n             </button>\n           </div>\n           <Row className=\"justify-center gap-4\">\n-            <div\n-              className=\"group relative\"\n-              style={{ width: simpleWidth, height: simpleHeight }}\n-            >\n+            <div className=\"group relative\" style={{ width: simpleWidth, height: simpleHeight }}>\n               <button\n-                className=\"h-full w-full rounded-lg bg-teal-500 font-semibold text-white transition-colors hover:bg-teal-600\"\n+                className=\"bg-teal-500 hover:bg-teal-600 h-full w-full rounded-lg font-semibold text-white transition-colors\"\n                 style={{ fontSize: `${getSimpleFontSize()}px` }}\n               >\n                 YES\n               </button>\n@@ -764,31 +684,16 @@\n               Reset to Default\n             </button>\n           </div>\n           <Row className=\"justify-center gap-4\">\n-            <div\n-              className=\"group relative\"\n-              style={{ width: arrowWidth, height: arrowHeight }}\n-            >\n+            <div className=\"group relative\" style={{ width: arrowWidth, height: arrowHeight }}>\n               <button\n-                className=\"flex h-full w-full items-center justify-center gap-1 rounded-md bg-teal-500 font-semibold text-white transition-colors hover:bg-teal-600\"\n+                className=\"bg-teal-500 hover:bg-teal-600 flex h-full w-full items-center justify-center gap-1 rounded-md font-semibold text-white transition-colors\"\n                 style={{ fontSize: `${getArrowFontSize()}px` }}\n               >\n                 <span>Bet YES</span>\n-                <svg\n-                  className=\"h-4 w-4\"\n-                  fill=\"currentColor\"\n-                  viewBox=\"0 0 20 20\"\n-                  style={{\n-                    width: `${getArrowFontSize() * 0.8}px`,\n-                    height: `${getArrowFontSize() * 0.8}px`,\n-                  }}\n-                >\n-                  <path\n-                    fillRule=\"evenodd\"\n-                    d=\"M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z\"\n-                    clipRule=\"evenodd\"\n-                  />\n+                <svg className=\"h-4 w-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\" style={{ width: `${getArrowFontSize() * 0.8}px`, height: `${getArrowFontSize() * 0.8}px` }}>\n+                  <path fillRule=\"evenodd\" d=\"M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z\" clipRule=\"evenodd\" />\n                 </svg>\n               </button>\n               {/* Right resize handle */}\n               <div\n@@ -838,22 +743,10 @@\n                 className=\"bg-scarlet-500 hover:bg-scarlet-600 flex h-full w-full items-center justify-center gap-1 rounded-md font-semibold text-white transition-colors\"\n                 style={{ fontSize: `${getArrowFontSize()}px` }}\n               >\n                 <span>Bet NO</span>\n-                <svg\n-                  className=\"h-4 w-4\"\n-                  fill=\"currentColor\"\n-                  viewBox=\"0 0 20 20\"\n-                  style={{\n-                    width: `${getArrowFontSize() * 0.8}px`,\n-                    height: `${getArrowFontSize() * 0.8}px`,\n-                  }}\n-                >\n-                  <path\n-                    fillRule=\"evenodd\"\n-                    d=\"M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z\"\n-                    clipRule=\"evenodd\"\n-                  />\n+                <svg className=\"h-4 w-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\" style={{ width: `${getArrowFontSize() * 0.8}px`, height: `${getArrowFontSize() * 0.8}px` }}>\n+                  <path fillRule=\"evenodd\" d=\"M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                 </svg>\n               </button>\n             </div>\n           </Row>\n@@ -868,11 +761,9 @@\n   )\n }\n \n function MockMarket() {\n-  const [marketType, setMarketType] = useState<'binary' | 'multiple'>(\n-    'multiple'\n-  )\n+  const [marketType, setMarketType] = useState<'binary' | 'multiple'>('multiple')\n   const [question, setQuestion] = useState(\n     'Who will win the 2025 MLB World Series MVP?'\n   )\n   const [probability, setProbability] = useState(52)\n@@ -888,14 +779,11 @@\n   const [changeDirection, setChangeDirection] = useState<'up' | 'down'>('down')\n \n   // Chart data points (y values, 0-100 representing probability)\n   const [chartPoints, setChartPoints] = useState([\n-    70, 72, 66, 76, 62, 60, 56, 35, 41, 45, 49, 39, 43, 37, 41, 31, 27, 19, 47,\n-    51, 59,\n+    70, 72, 66, 76, 62, 60, 56, 35, 41, 45, 49, 39, 43, 37, 41, 31, 27, 19, 47, 51, 59\n   ])\n-  const [draggedPointIndex, setDraggedPointIndex] = useState<number | null>(\n-    null\n-  )\n+  const [draggedPointIndex, setDraggedPointIndex] = useState<number | null>(null)\n \n   // Multiple choice answers\n   const [answers, setAnswers] = useState([\n     { text: 'Shohei Ohtani', prob: 62 },\n@@ -941,12 +829,9 @@\n     const y = e.clientY - rect.top\n     const height = rect.height\n \n     // Convert Y position to probability (0-100)\n-    const newProb = Math.max(\n-      0,\n-      Math.min(100, 100 - ((y - 20) / (height * 0.8)) * 100)\n-    )\n+    const newProb = Math.max(0, Math.min(100, 100 - ((y - 20) / (height * 0.8)) * 100))\n \n     const newPoints = [...chartPoints]\n     newPoints[draggedPointIndex] = Math.round(newProb)\n     setChartPoints(newPoints)\n@@ -984,9 +869,9 @@\n           }}\n           className={`rounded-lg px-6 py-2 font-medium transition-colors ${\n             marketType === 'binary'\n               ? 'bg-primary-500 text-white'\n-              : 'bg-canvas-0 text-ink-600 hover:border-primary-300 border'\n+              : 'bg-canvas-0 text-ink-600 border hover:border-primary-300'\n           }`}\n         >\n           Binary Market\n         </button>\n@@ -999,9 +884,9 @@\n           }}\n           className={`rounded-lg px-6 py-2 font-medium transition-colors ${\n             marketType === 'multiple'\n               ? 'bg-primary-500 text-white'\n-              : 'bg-canvas-0 text-ink-600 hover:border-primary-300 border'\n+              : 'bg-canvas-0 text-ink-600 border hover:border-primary-300'\n           }`}\n         >\n           Multiple Choice\n         </button>\n@@ -1016,9 +901,9 @@\n           <input\n             type=\"text\"\n             value={question}\n             onChange={(e) => setQuestion(e.target.value)}\n-            className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+            className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n           />\n         </div>\n \n         {marketType === 'binary' ? (\n@@ -1057,9 +942,9 @@\n               <input\n                 type=\"text\"\n                 value={volume}\n                 onChange={(e) => setVolume(e.target.value)}\n-                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n               />\n             </div>\n             <div>\n               <label className=\"text-ink-700 mb-1 block text-sm font-medium\">\n@@ -1068,9 +953,9 @@\n               <input\n                 type=\"text\"\n                 value={traders}\n                 onChange={(e) => setTraders(e.target.value)}\n-                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n               />\n             </div>\n             <div>\n               <label className=\"text-ink-700 mb-1 block text-sm font-medium\">\n@@ -1079,9 +964,9 @@\n               <input\n                 type=\"text\"\n                 value={likes}\n                 onChange={(e) => setLikes(e.target.value)}\n-                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n               />\n             </div>\n             <div>\n               <label className=\"text-ink-700 mb-1 block text-sm font-medium\">\n@@ -1090,9 +975,9 @@\n               <input\n                 type=\"text\"\n                 value={date}\n                 onChange={(e) => setDate(e.target.value)}\n-                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n               />\n             </div>\n             <div>\n               <label className=\"text-ink-700 mb-1 block text-sm font-medium\">\n@@ -1101,21 +986,19 @@\n               <input\n                 type=\"text\"\n                 value={changeAmount}\n                 onChange={(e) => setChangeAmount(e.target.value)}\n-                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n               />\n             </div>\n             <div>\n               <label className=\"text-ink-700 mb-1 block text-sm font-medium\">\n                 Change Direction\n               </label>\n               <select\n                 value={changeDirection}\n-                onChange={(e) =>\n-                  setChangeDirection(e.target.value as 'up' | 'down')\n-                }\n-                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+                onChange={(e) => setChangeDirection(e.target.value as 'up' | 'down')}\n+                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n               >\n                 <option value=\"up\">Up</option>\n                 <option value=\"down\">Down</option>\n               </select>\n@@ -1131,9 +1014,9 @@\n               <input\n                 type=\"text\"\n                 value={volume}\n                 onChange={(e) => setVolume(e.target.value)}\n-                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n               />\n             </div>\n             <div>\n               <label className=\"text-ink-700 mb-1 block text-sm font-medium\">\n@@ -1142,9 +1025,9 @@\n               <input\n                 type=\"text\"\n                 value={traders}\n                 onChange={(e) => setTraders(e.target.value)}\n-                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+                className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n               />\n             </div>\n             <div>\n               <label className=\"text-ink-700 mb-1 block text-sm font-medium\">\n@@ -1179,9 +1062,9 @@\n                     const newAnswers = [...answers]\n                     newAnswers[index].text = e.target.value\n                     setAnswers(newAnswers)\n                   }}\n-                  className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 flex-1 rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1\"\n+                  className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 flex-1 rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-500\"\n                 />\n                 <input\n                   type=\"number\"\n                   value={answer.prob}\n@@ -1189,9 +1072,9 @@\n                     const newAnswers = [...answers]\n                     newAnswers[index].prob = parseInt(e.target.value) || 0\n                     setAnswers(newAnswers)\n                   }}\n-                  className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-20 rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1\"\n+                  className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-20 rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-500\"\n                 />\n                 <span className=\"text-ink-600 text-sm\">%</span>\n               </div>\n             ))}\n@@ -1207,12 +1090,9 @@\n         >\n           {/* Header with avatar and question */}\n           <div className=\"flex items-start gap-3 p-6 pb-4\">\n             <div className=\"bg-primary-100 flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full\">\n-              <LogoIcon\n-                className=\"stroke-primary-700 h-8 w-8\"\n-                strokeWidth=\"0.6\"\n-              />\n+              <LogoIcon className=\"h-8 w-8 stroke-primary-700\" strokeWidth=\"0.6\" />\n             </div>\n             <div className=\"min-w-0 flex-1\">\n               <div className=\"text-ink-600 mb-1 text-sm\">Manifold Markets</div>\n               <h2 className=\"text-ink-1000 text-2xl font-semibold leading-tight\">\n@@ -1226,42 +1106,20 @@\n               {/* Binary Market Layout */}\n               <div className=\"px-4 pb-4\">\n                 {/* Probability with change indicator */}\n                 <div className=\"mb-3 flex items-baseline gap-2\">\n-                  <div className=\"text-ink-900 text-5xl font-bold\">\n+                  <div className=\"text-5xl font-bold text-ink-900\">\n                     {probability}%\n                   </div>\n                   <div className=\"text-ink-600 text-base\">chance</div>\n-                  <div\n-                    className={`ml-1 flex items-center gap-0.5 text-sm ${\n-                      changeDirection === 'down'\n-                        ? 'text-scarlet-500'\n-                        : 'text-teal-500'\n-                    }`}\n-                  >\n+                  <div className={`ml-1 flex items-center gap-0.5 text-sm ${changeDirection === 'down' ? 'text-scarlet-500' : 'text-teal-500'}`}>\n                     {changeDirection === 'down' ? (\n-                      <svg\n-                        className=\"h-3 w-3\"\n-                        fill=\"currentColor\"\n-                        viewBox=\"0 0 20 20\"\n-                      >\n-                        <path\n-                          fillRule=\"evenodd\"\n-                          d=\"M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z\"\n-                          clipRule=\"evenodd\"\n-                        />\n+                      <svg className=\"h-3 w-3\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n+                        <path fillRule=\"evenodd\" d=\"M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                       </svg>\n                     ) : (\n-                      <svg\n-                        className=\"h-3 w-3\"\n-                        fill=\"currentColor\"\n-                        viewBox=\"0 0 20 20\"\n-                      >\n-                        <path\n-                          fillRule=\"evenodd\"\n-                          d=\"M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z\"\n-                          clipRule=\"evenodd\"\n-                        />\n+                      <svg className=\"h-3 w-3\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n+                        <path fillRule=\"evenodd\" d=\"M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z\" clipRule=\"evenodd\" />\n                       </svg>\n                     )}\n                     <span className=\"font-medium\">{changeAmount}</span>\n                   </div>\n@@ -1269,76 +1127,36 @@\n \n                 {/* Stats row */}\n                 <div className=\"text-ink-600 mb-4 flex items-center gap-4 text-sm\">\n                   <div className=\"flex items-center gap-1\">\n-                    <svg\n-                      className=\"h-4 w-4\"\n-                      fill=\"none\"\n-                      stroke=\"currentColor\"\n-                      viewBox=\"0 0 24 24\"\n-                    >\n-                      <path\n-                        strokeLinecap=\"round\"\n-                        strokeLinejoin=\"round\"\n-                        strokeWidth={2}\n-                        d=\"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z\"\n-                      />\n+                    <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n+                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z\" />\n                     </svg>\n                     <span>{likes}</span>\n                   </div>\n                   <div className=\"flex items-center gap-1\">\n-                    <svg\n-                      className=\"h-4 w-4\"\n-                      fill=\"none\"\n-                      stroke=\"currentColor\"\n-                      viewBox=\"0 0 24 24\"\n-                    >\n-                      <path\n-                        strokeLinecap=\"round\"\n-                        strokeLinejoin=\"round\"\n-                        strokeWidth={2}\n-                        d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\"\n-                      />\n+                    <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n+                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z\" />\n                     </svg>\n                     <span>{traders}</span>\n                   </div>\n                   <div className=\"flex items-center gap-1\">\n-                    <svg\n-                      className=\"h-4 w-4\"\n-                      fill=\"none\"\n-                      stroke=\"currentColor\"\n-                      viewBox=\"0 0 24 24\"\n-                    >\n-                      <path\n-                        strokeLinecap=\"round\"\n-                        strokeLinejoin=\"round\"\n-                        strokeWidth={2}\n-                        d=\"M13 7h8m0 0v8m0-8l-8 8-4-4-6 6\"\n-                      />\n+                    <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n+                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M13 7h8m0 0v8m0-8l-8 8-4-4-6 6\" />\n                     </svg>\n                     <span>M{volume}</span>\n                   </div>\n                   <div className=\"flex items-center gap-1\">\n-                    <svg\n-                      className=\"h-4 w-4\"\n-                      fill=\"none\"\n-                      stroke=\"currentColor\"\n-                      viewBox=\"0 0 24 24\"\n-                    >\n-                      <path\n-                        strokeLinecap=\"round\"\n-                        strokeLinejoin=\"round\"\n-                        strokeWidth={2}\n-                        d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"\n-                      />\n+                    <svg className=\"h-4 w-4\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n+                      <path strokeLinecap=\"round\" strokeLinejoin=\"round\" strokeWidth={2} d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\" />\n                     </svg>\n                     <span>{date}</span>\n                   </div>\n                 </div>\n \n                 {/* Chart */}\n                 <div className=\"relative mb-3\">\n-                  <div className=\"relative h-64 overflow-hidden rounded-lg bg-teal-50\">\n+                  <div className=\"bg-teal-50 relative h-64 overflow-hidden rounded-lg\">\n                     <svg\n                       className=\"h-full w-full cursor-crosshair\"\n                       viewBox=\"0 0 800 256\"\n                       preserveAspectRatio=\"none\"\n@@ -1346,25 +1164,11 @@\n                       onMouseUp={handleChartMouseUp}\n                       onMouseLeave={handleChartMouseUp}\n                     >\n                       <defs>\n-                        <linearGradient\n-                          id=\"chartGradient\"\n-                          x1=\"0\"\n-                          x2=\"0\"\n-                          y1=\"0\"\n-                          y2=\"1\"\n-                        >\n-                          <stop\n-                            offset=\"0%\"\n-                            stopColor=\"#14b8a6\"\n-                            stopOpacity=\"0.2\"\n-                          />\n-                          <stop\n-                            offset=\"100%\"\n-                            stopColor=\"#14b8a6\"\n-                            stopOpacity=\"0.05\"\n-                          />\n+                        <linearGradient id=\"chartGradient\" x1=\"0\" x2=\"0\" y1=\"0\" y2=\"1\">\n+                          <stop offset=\"0%\" stopColor=\"#14b8a6\" stopOpacity=\"0.2\" />\n+                          <stop offset=\"100%\" stopColor=\"#14b8a6\" stopOpacity=\"0.05\" />\n                         </linearGradient>\n                       </defs>\n \n                       {/* Fill area */}\n@@ -1397,57 +1201,37 @@\n                             stroke=\"white\"\n                             strokeWidth=\"2\"\n                             className=\"cursor-grab active:cursor-grabbing\"\n                             onMouseDown={() => handleChartMouseDown(index)}\n-                            style={{\n-                              cursor:\n-                                draggedPointIndex === index\n-                                  ? 'grabbing'\n-                                  : 'grab',\n-                            }}\n+                            style={{ cursor: draggedPointIndex === index ? 'grabbing' : 'grab' }}\n                           />\n                         )\n                       })}\n                     </svg>\n \n                     {/* Manifold watermark */}\n                     <div className=\"pointer-events-none absolute bottom-2 left-3 flex items-center gap-1.5 opacity-40\">\n-                      <LogoIcon\n-                        className=\"stroke-ink-600 h-4 w-4\"\n-                        strokeWidth=\"0.6\"\n-                      />\n+                      <LogoIcon className=\"h-4 w-4 stroke-ink-600\" strokeWidth=\"0.6\" />\n                       <span className=\"text-ink-600 text-xs\">MANIFOLD</span>\n                     </div>\n \n                     {/* Time period buttons */}\n                     <div className=\"absolute right-2 top-2 flex items-center gap-1 rounded-lg bg-white/80 px-2 py-1 text-xs font-medium backdrop-blur-sm\">\n-                      <button className=\"text-ink-500 hover:text-ink-800 px-1.5 py-0.5\">\n-                        1H\n-                      </button>\n-                      <button className=\"text-ink-500 hover:text-ink-800 px-1.5 py-0.5\">\n-                        6H\n-                      </button>\n-                      <button className=\"text-ink-500 hover:text-ink-800 px-1.5 py-0.5\">\n-                        1D\n-                      </button>\n-                      <button className=\"text-ink-500 hover:text-ink-800 px-1.5 py-0.5\">\n-                        1W\n-                      </button>\n-                      <button className=\"text-ink-500 hover:text-ink-800 px-1.5 py-0.5\">\n-                        1M\n-                      </button>\n-                      <button className=\"rounded bg-teal-500 px-1.5 py-0.5 text-white\">\n-                        ALL\n-                      </button>\n+                      <button className=\"text-ink-500 hover:text-ink-800 px-1.5 py-0.5\">1H</button>\n+                      <button className=\"text-ink-500 hover:text-ink-800 px-1.5 py-0.5\">6H</button>\n+                      <button className=\"text-ink-500 hover:text-ink-800 px-1.5 py-0.5\">1D</button>\n+                      <button className=\"text-ink-500 hover:text-ink-800 px-1.5 py-0.5\">1W</button>\n+                      <button className=\"text-ink-500 hover:text-ink-800 px-1.5 py-0.5\">1M</button>\n+                      <button className=\"bg-teal-500 rounded px-1.5 py-0.5 text-white\">ALL</button>\n                     </div>\n \n                     {/* 100% label */}\n-                    <div className=\"text-ink-600 pointer-events-none absolute right-2 top-10 text-xs font-medium\">\n+                    <div className=\"pointer-events-none absolute right-2 top-10 text-xs font-medium text-ink-600\">\n                       100%\n                     </div>\n \n                     {/* 0% label */}\n-                    <div className=\"text-ink-600 pointer-events-none absolute bottom-2 right-2 text-xs font-medium\">\n+                    <div className=\"pointer-events-none absolute bottom-2 right-2 text-xs font-medium text-ink-600\">\n                       0%\n                     </div>\n                   </div>\n                 </div>\n@@ -1462,34 +1246,18 @@\n               </div>\n \n               {/* Bet Buttons */}\n               <div className=\"flex gap-3 px-4 pb-4\">\n-                <button className=\"flex flex-1 items-center justify-center gap-1 rounded-md bg-teal-500 px-6 py-2.5 text-base font-semibold text-white transition-colors hover:bg-teal-600\">\n+                <button className=\"bg-teal-500 hover:bg-teal-600 flex flex-1 items-center justify-center gap-1 rounded-md px-6 py-2.5 text-base font-semibold text-white transition-colors\">\n                   <span>Bet YES</span>\n-                  <svg\n-                    className=\"h-4 w-4\"\n-                    fill=\"currentColor\"\n-                    viewBox=\"0 0 20 20\"\n-                  >\n-                    <path\n-                      fillRule=\"evenodd\"\n-                      d=\"M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z\"\n-                      clipRule=\"evenodd\"\n-                    />\n+                  <svg className=\"h-4 w-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n+                    <path fillRule=\"evenodd\" d=\"M5.293 7.707a1 1 0 010-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L6.707 7.707a1 1 0 01-1.414 0z\" clipRule=\"evenodd\" />\n                   </svg>\n                 </button>\n                 <button className=\"bg-scarlet-500 hover:bg-scarlet-600 flex flex-1 items-center justify-center gap-1 rounded-md px-6 py-2.5 text-base font-semibold text-white transition-colors\">\n                   <span>Bet NO</span>\n-                  <svg\n-                    className=\"h-4 w-4\"\n-                    fill=\"currentColor\"\n-                    viewBox=\"0 0 20 20\"\n-                  >\n-                    <path\n-                      fillRule=\"evenodd\"\n-                      d=\"M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z\"\n-                      clipRule=\"evenodd\"\n-                    />\n+                  <svg className=\"h-4 w-4\" fill=\"currentColor\" viewBox=\"0 0 20 20\">\n+                    <path fillRule=\"evenodd\" d=\"M14.707 10.293a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L9 12.586V5a1 1 0 012 0v7.586l2.293-2.293a1 1 0 011.414 0z\" clipRule=\"evenodd\" />\n                   </svg>\n                 </button>\n               </div>\n             </>\n@@ -1499,16 +1267,16 @@\n               <div className=\"space-y-3 px-6 pb-4\">\n                 {answers.map((answer, index) => (\n                   <div\n                     key={index}\n-                    className=\"border-ink-200 bg-canvas-0 hover:border-primary-300 relative flex items-center overflow-hidden rounded-lg border transition-all hover:shadow-sm\"\n+                    className=\"relative flex items-center overflow-hidden rounded-lg border border-ink-200 bg-canvas-0 transition-all hover:border-primary-300 hover:shadow-sm\"\n                   >\n                     {/* Color fill bar behind everything */}\n                     <div\n                       className=\"absolute inset-y-0 left-0 transition-all\"\n                       style={{\n                         width: `${answer.prob}%`,\n-                        backgroundColor: getAnswerColor(index),\n+                        backgroundColor: getAnswerColor(index)\n                       }}\n                     />\n \n                     {/* Content on top of color bar */}\n@@ -1528,9 +1296,9 @@\n                       </div>\n \n                       {/* Bet buttons on the right */}\n                       <div className=\"flex items-center gap-2 px-3 py-3\">\n-                        <button className=\"hover:text-ink-0 rounded-md border border-current px-3 py-1.5 text-xs font-semibold text-teal-500 transition-colors hover:bg-teal-500\">\n+                        <button className=\"text-teal-500 hover:bg-teal-500 hover:text-ink-0 rounded-md border border-current px-3 py-1.5 text-xs font-semibold transition-colors\">\n                           Yes\n                         </button>\n                         <button className=\"text-scarlet-500 hover:bg-scarlet-500 hover:text-ink-0 rounded-md border border-current px-3 py-1.5 text-xs font-semibold transition-colors\">\n                           No\n@@ -1581,10 +1349,9 @@\n         </div>\n       </div>\n \n       <p className=\"text-ink-500 text-center text-sm\">\n-        Switch between market types and adjust the controls, then screenshot the\n-        preview\n+        Switch between market types and adjust the controls, then screenshot the preview\n       </p>\n     </div>\n   )\n }\n@@ -1612,9 +1379,9 @@\n           <input\n             type=\"text\"\n             value={question}\n             onChange={(e) => setQuestion(e.target.value)}\n-            className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+            className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n           />\n         </div>\n         <div>\n           <label className=\"text-ink-700 mb-1 block text-sm font-medium\">\n@@ -1623,9 +1390,9 @@\n           <input\n             type=\"text\"\n             value={creatorName}\n             onChange={(e) => setCreatorName(e.target.value)}\n-            className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+            className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n           />\n         </div>\n         <div>\n           <label className=\"text-ink-700 mb-1 block text-sm font-medium\">\n@@ -1660,9 +1427,9 @@\n           <input\n             type=\"text\"\n             value={volume}\n             onChange={(e) => setVolume(e.target.value)}\n-            className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+            className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n           />\n         </div>\n         <div>\n           <label className=\"text-ink-700 mb-1 block text-sm font-medium\">\n@@ -1671,9 +1438,9 @@\n           <input\n             type=\"text\"\n             value={traders}\n             onChange={(e) => setTraders(e.target.value)}\n-            className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 focus:ring-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1\"\n+            className=\"border-ink-300 bg-canvas-0 text-ink-1000 focus:border-primary-500 w-full rounded-lg border px-3 py-2 focus:outline-none focus:ring-1 focus:ring-primary-500\"\n           />\n         </div>\n       </div>\n \n@@ -1685,12 +1452,9 @@\n         >\n           {/* Market Header */}\n           <div className=\"flex items-start gap-3 p-4\">\n             <div className=\"bg-primary-100 flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full\">\n-              <LogoIcon\n-                className=\"stroke-primary-700 h-6 w-6\"\n-                strokeWidth=\"0.6\"\n-              />\n+              <LogoIcon className=\"h-6 w-6 stroke-primary-700\" strokeWidth=\"0.6\" />\n             </div>\n             <div className=\"min-w-0 flex-1\">\n               <div className=\"text-ink-700 mb-1 text-sm font-medium\">\n                 {creatorName}\n@@ -1704,9 +1468,9 @@\n           {/* Probability Display */}\n           <div className=\"px-4 pb-3\">\n             <div className=\"relative h-16 overflow-hidden rounded-lg\">\n               <div\n-                className=\"absolute inset-y-0 left-0 flex items-center justify-start bg-teal-500 px-4 transition-all\"\n+                className=\"bg-teal-500 absolute inset-y-0 left-0 flex items-center justify-start px-4 transition-all\"\n                 style={{ width: `${probability}%` }}\n               >\n                 <span className=\"text-lg font-bold text-white\">\n                   {probability}%\n@@ -1759,9 +1523,9 @@\n                 <span>{traders}</span>\n               </div>\n             </div>\n             <Row className=\"gap-2\">\n-              <button className=\"rounded bg-teal-500 px-4 py-1.5 text-sm font-semibold text-white transition-colors hover:bg-teal-600\">\n+              <button className=\"bg-teal-500 hover:bg-teal-600 rounded px-4 py-1.5 text-sm font-semibold text-white transition-colors\">\n                 YES\n               </button>\n               <button className=\"bg-scarlet-500 hover:bg-scarlet-600 rounded px-4 py-1.5 text-sm font-semibold text-white transition-colors\">\n                 NO\n@@ -1804,20 +1568,17 @@\n   }\n \n   // Make white logos bigger on dark backgrounds, and determine padding\n   const isWhiteLogo = props.title.includes('White')\n-  const isCurrencyIcon =\n-    props.title.includes('Mana') || props.title.includes('Manachan')\n+  const isCurrencyIcon = props.title.includes('Mana') || props.title.includes('Manachan')\n   const imageScale = isWhiteLogo ? 'w-full h-full' : 'max-h-full max-w-full'\n \n   // Determine padding: no padding if noPadding prop is true, or if it's a currency icon\n   const padding = props.noPadding || isCurrencyIcon ? 'p-0' : 'p-8'\n \n   return (\n     <div className=\"bg-canvas-0 group relative flex flex-col overflow-hidden rounded-lg border transition-shadow hover:shadow-md\">\n-      <div\n-        className={`flex aspect-square items-center justify-center ${padding} ${props.bgColor}`}\n-      >\n+      <div className={`flex aspect-square items-center justify-center ${padding} ${props.bgColor}`}>\n         <img\n           src={props.src}\n           alt={props.title}\n           className={`${imageScale} object-contain`}\n@@ -1907,14 +1668,12 @@\n   const { badge, onClick } = props\n   return (\n     <button\n       onClick={onClick}\n-      className=\"border-ink-200 hover:border-primary-500 cursor-pointer rounded-lg border p-4 text-left transition-all hover:shadow-md\"\n+      className=\"border-ink-200 hover:border-primary-500 hover:shadow-md cursor-pointer rounded-lg border p-4 text-left transition-all\"\n     >\n       <div className=\"mb-2 flex items-center gap-2\">\n-        <div className=\"flex h-8 w-8 items-center justify-center\">\n-          {badge.icon}\n-        </div>\n+        <div className=\"flex h-8 w-8 items-center justify-center\">{badge.icon}</div>\n         <h4 className=\"text-ink-800 font-semibold\">{badge.title}</h4>\n       </div>\n       <p className=\"text-ink-600 mb-2 text-sm\">{badge.description}</p>\n       <div className=\"text-ink-500 space-y-1 text-xs\">\n"
        }
      ]
    },
    {
      "id": "add-achievements",
      "sha": "60532e591c2207e314b4e0716b26b8f77a91bdd9",
      "parentSha": "538b6b617d048694e016764197d75cf491a3c5c7",
      "spec": "Implement a user Achievements feature spanning backend, SQL, scheduler, API schema, frontend UI, and assets.\n\nBackend API\n- Add a GET endpoint get-user-achievements that returns a flat object of user achievement stats plus ranks/percentiles per stat.\n- Create a handler under backend/api/src/get-user-achievements.ts that:\n  - Accepts { userId: string }.\n  - Uses createSupabaseDirectClient from shared/supabase/init to run a single SQL query assembling all raw achievement stats for the user (creatorTraders, totalReferrals, totalReferredProfitMana, totalVolumeMana, seasonsGoldOrHigher, seasonsPlatinumOrHigher, seasonsDiamondOrHigher, seasonsMasters, largestLeagueSeasonEarnings, numberOfComments, totalLiquidityCreatedMarkets, totalTradesCount, totalMarketsCreated, accountAgeYears, profitableMarketsCount, unprofitableMarketsCount, largestProfitableTradeValue, largestUnprofitableTradeValue, longestBettingStreak, modTicketsResolved, charityDonatedMana).\n  - Includes a ranks_json object with rank values pulled from materialized views (one rank field per stat listed above; percentiles should be null here).\n  - Converts ranks_json into a ranks object, computing percentiles in-process as rank/N*100 where N is the total number of users from mv_ach_volume (if rank or N is missing, leave percentile null). Ensure each ranks key is present with { rank: number | null; percentile: number | null }.\n  - Returns numeric fields as Numbers and a ranks object keyed by: creatorTraders, totalReferrals, totalReferredProfit, volume, trades, marketsCreated, comments, seasonsGoldOrHigher, seasonsPlatinumOrHigher, seasonsDiamondOrHigher, seasonsMasters, largestLeagueSeasonEarnings, liquidity, profitableMarkets, unprofitableMarkets, largestProfitableTrade, largestUnprofitableTrade, accountAge, longestBettingStreak, modTickets, charityDonated.\n- Wire the handler in backend/api/src/routes.ts by importing the function and adding a 'get-user-achievements' key mapped to it.\n\nScheduler\n- Add job helpers in backend/scheduler/src/jobs/refresh-achievement-mvs.ts to refresh each MV concurrently (using refresh materialized view concurrently <name>), with functions: refreshAchVolume, refreshAchComments, refreshAchLeagues, refreshAchPnl, refreshAchTxns, refreshAchCreatorContracts, refreshAchReferrals, refreshAchCreatorTraders, refreshAchAccountAge.\n- Add a job backend/scheduler/src/jobs/update-ach-trades.ts that incrementally maintains the ach_trades table by:\n  - Ensuring rows exist for all users (insert ... on conflict do nothing).\n  - Counting new qualifying trades since last_updated from contract_bets (excluding redemptions, canceled, API bets; only MANA contracts; only filled), grouped per user; update total_trades_count and last_updated.\n  - Recomputing trades_rank across ach_trades based on total_trades_count.\n- Register the above jobs in backend/scheduler/src/jobs/index.ts. Keep the actual scheduled createJob calls commented out but include the imports and a commented block of staggered nightly cron schedules.\n\nSupabase SQL (materialized views and table)\n- Create backend/supabase/achievement_materialized_views.sql defining:\n  - mv_ach_volume (per-user total_volume_mana and volume_rank), with unique index on user_id.\n  - ach_trades table (user_id PK, total_trades_count, trades_rank, last_updated with default epoch), with unique index on user_id.\n  - mv_ach_comments counting distinct comments with at least one like (number_of_comments and comments_rank), with unique index.\n  - mv_ach_leagues aggregating seasons at or above Gold/Platinum/Diamond, Masters exact count, and largest_league_season_earnings, plus ranks for each metric, with unique index.\n  - mv_ach_pnl aggregating profitable/unprofitable markets and largest profitable/unprofitable trade values, plus ranks, with unique index.\n  - mv_ach_txns_achievements aggregating mod_tickets_resolved (ADMIN_REWARD), charity_donated_mana across tokens (M$, CASH, SPICE with unit conversions), longest_betting_streak from BETTING_STREAK_BONUS, plus ranks, with unique index.\n  - mv_ach_creator_contracts aggregating total_markets_created (markets with >=2 unique bettors) and total_liquidity_created_markets for MANA creator markets, with ranks and unique index.\n  - mv_ach_referrals (total_referrals, total_referred_profit_mana) from user_referrals_profit with ranks and unique index.\n  - mv_ach_creator_traders reading users.data->creatorTraders.allTime with rank and unique index.\n  - mv_ach_account_age computing account_age_years and rank with unique index.\n\nAPI Schema\n- Extend common/src/api/schema.ts with a 'get-user-achievements' entry:\n  - method: GET; visibility: public; authed: false; cache: light strategy.\n  - props: { userId: string } strict.\n  - returns: object containing all numeric fields listed above and ranks with keys and shapes as described (each entry: { rank: number | null; percentile: number | null }).\n\nFrontend UI\n- Update the user profile page web/pages/[username]/index.tsx to add an Achievements tab.\n  - Add an AchievementsSection component that:\n    - Calls unauthedApi('get-user-achievements', { userId }).\n    - Handles loading and error states; renders nothing if no data.\n    - Defines rank mapping per displayed achievement ID and zero-value handling (suppress rank/percentile when raw value is zero).\n    - Buckets achievements by rank thresholds: Top 50, Top 200, Top 1000, Top 5000, Top 20,000, All Users; sorts within a bucket by rank then percentile ascending.\n    - Renders a responsive grid of AchievementBadgeCard components per bucket.\n  - Add an AchievementBadgeCard component that displays:\n    - A gradient ring color per bucket, a circular image, title, description, value.\n    - A hover tooltip showing Rank and percentile (as “In the top X% of all users”), and the value.\n  - Import and use Image from next/image to display badge images.\n  - Use existing formatting helpers to format MANA, USD, and counts for values.\n\nAssets\n- Add badge images under web/public/achievement-badges/ with the following filenames (must match code references): accountAgeYears.png, charityDonatedMana.png, creatorTraders.png, largestLeagueSeasonEarnings.png, largestProfitableTradeValue.png, largestUnprofitableTradeValue.png, longestBettingStreak.png, modTicketsResolved.png, numberOfComments.png, profitableMarketsCount.png, seasonsDiamondOrHigher.png, seasonsGoldOrHigher.png, seasonsMasters.png, seasonsPlatinumOrHigher.png, totalLiquidityCreatedMarkets.png, totalMarketsCreated.png, totalReferrals.png, totalReferredProfitMana.png, totalTradesCount.png, totalVolumeMana.png, unprofitableMarketsCount.png. (Other unused illustrative images can be present but must not break imports.)\n\nAcceptance criteria\n- GET /api/v0/get-user-achievements returns the specified fields for a valid userId; percentiles are present (or null when rank is null/zero raw value).\n- The user profile shows a new “Achievements” tab with grouped badges; ranks/percentiles are hidden for zero-value achievements; tooltips and values render and bucket ordering/sorting is correct.\n- Achievements ranks are drawn from materialized views and the ach_trades table; views refresh functions exist; the scheduler imports jobs and contains commented-out cron registrations.\n- All new SQL objects have unique indexes on user_id where materialized views are created.\n- Type definitions compile without TS errors and endpoint is included in common schema.\n",
      "prompt": "Add a public “Achievements” feature to user profiles. Include a new GET API that returns a user’s achievement stats and ranks, scheduled jobs to keep achievement rankings fresh, database views/tables to compute those rankings, and a new Achievements tab showing badges on the profile page. The API should aggregate a user’s activity (trades, volume, comments, creators’ traders, referrals, creator market counts/liquidity, league season stats, betting streaks, moderator tickets, charity donations, account age) and provide a rank and percentile for each metric. On the frontend, fetch these data for a user ID and render a grid of badge cards grouped into rank-based buckets with images and tooltips. Ensure types are added to the shared API schema, the route is wired, and the UI is responsive and uses the project’s formatting utilities.",
      "supplementalFiles": [
        "supabase/contracts.sql",
        "supabase/contract_bets.sql",
        "supabase/user_contract_metrics.sql",
        "supabase/txns.sql",
        "supabase/leagues.sql",
        "supabase/users.sql",
        "supabase/old_post_comments.sql",
        "supabase/user_reactions.sql",
        "web/lib/api/api.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/get-user-achievements.ts",
          "status": "added",
          "diff": "Index: backend/api/src/get-user-achievements.ts\n===================================================================\n--- backend/api/src/get-user-achievements.ts\t538b6b6 (parent)\n+++ backend/api/src/get-user-achievements.ts\t60532e5 (commit)\n@@ -0,0 +1,261 @@\n+import { APIHandler } from 'api/helpers/endpoint'\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+\n+// Returns flat achievement-style statistics for a given user (no ranks)\n+export const getUserAchievements: APIHandler<'get-user-achievements'> = async ({\n+  userId,\n+}) => {\n+  const pg = createSupabaseDirectClient()\n+\n+  const queryWithPerMV = `with base as (\n+        select $1::text as uid\n+      ),\n+      \n+      creators as (\n+        select (data->'creatorTraders'->>'allTime')::int as creator_traders\n+        from users\n+        where id = (select uid from base)\n+      ),\n+      referrals as (\n+        select total_referrals, total_referred_profit as total_referred_profit_mana\n+        from user_referrals_profit\n+        where id = (select uid from base)\n+      ),\n+      mod_tickets as (\n+        select count(*) as mod_tickets_resolved\n+        from txns\n+        where category = 'ADMIN_REWARD' and to_id = (select uid from base)\n+      ),\n+      charity as (\n+        select coalesce(sum(case when token = 'M$' then amount / 100.0 else 0 end), 0)\n+             + coalesce(sum(case when token = 'CASH' then amount else 0 end), 0)\n+             + coalesce(sum(case when token = 'SPICE' then amount / 1000.0 else 0 end), 0) as charity_donated_mana\n+        from txns\n+        where category = 'CHARITY' and from_id = (select uid from base)\n+      ),\n+      volume as (\n+        select\n+          sum(case when c.token = 'MANA' then (coalesce((ucm.data->>'totalAmountSold')::numeric,0) + coalesce((ucm.data->>'totalAmountInvested')::numeric,0)) else 0 end) as total_volume_mana\n+        from user_contract_metrics ucm\n+        join contracts c on c.id = ucm.contract_id\n+        where ucm.user_id = (select uid from base) and ucm.answer_id is null\n+      ),\n+      leagues_cte as (\n+        select\n+          count(*) filter (where division >= 3) as seasons_gold_or_higher,\n+          count(*) filter (where division >= 4) as seasons_platinum_or_higher,\n+          count(*) filter (where division >= 5) as seasons_diamond_or_higher,\n+          count(*) filter (where division = 6) as seasons_masters\n+        from leagues\n+        where user_id = (select uid from base)\n+      ),\n+      league_ranks as (\n+        select\n+          max(mana_earned) as largest_league_season_earnings\n+        from user_league_info\n+        where user_id = (select uid from base)\n+      ),\n+      comments as (\n+        select\n+          (select count(*) from contract_comments where user_id = (select uid from base)) +\n+          (select count(*) from old_post_comments where user_id = (select uid from base)) as number_of_comments\n+      ),\n+      liquidity as (\n+        select coalesce(sum((c.data->>'totalLiquidity')::numeric), 0) as total_liquidity_created_markets\n+        from contracts c\n+        where c.creator_id = (select uid from base) and c.token = 'MANA'\n+      ),\n+      trades as (\n+        select coalesce(total_trades_count, 0) as total_trades_count\n+        from ach_trades\n+        where user_id = (select uid from base)\n+      ),\n+      markets_created as (\n+        select count(*) as total_markets_created\n+        from contracts c\n+        where c.creator_id = (select uid from base)\n+          and c.token = 'MANA'\n+      ),\n+      account_age as (\n+        select round(\n+          (\n+            extract(epoch from (now() - u.created_time)) / (365.25*24*60*60)\n+          )::numeric,\n+          2\n+        ) as account_age_years\n+        from users u\n+        where u.id = (select uid from base)\n+      ),\n+      trade_stats as (\n+        select\n+          count(*) filter (where coalesce(ucm.profit, 0) > 0) as profitable_trades_count,\n+          count(*) filter (where coalesce(ucm.profit, 0) < 0) as unprofitable_trades_count,\n+          max(ucm.profit) filter (where coalesce(ucm.profit, 0) > 0) as largest_profitable_trade_value,\n+          min(ucm.profit) filter (where coalesce(ucm.profit, 0) < 0) as largest_unprofitable_trade_value\n+        from user_contract_metrics ucm\n+        join contracts c on c.id = ucm.contract_id\n+        where ucm.user_id = (select uid from base)\n+          and ucm.answer_id is null\n+          and c.token = 'MANA'\n+      ),\n+      longest_streak as (\n+        select coalesce(max((tx.data->'data'->>'currentBettingStreak')::int), 0) as longest_betting_streak\n+        from txns tx\n+        where tx.to_id = (select uid from base)\n+          and tx.category = 'BETTING_STREAK_BONUS'\n+      )\n+      select\n+        (select uid from base) as user_id,\n+        coalesce(creators.creator_traders, 0) as creator_traders,\n+        coalesce(referrals.total_referrals, 0) as total_referrals,\n+        coalesce(referrals.total_referred_profit_mana, 0) as total_referred_profit_mana,\n+        coalesce(volume.total_volume_mana, 0) as total_volume_mana,\n+        coalesce(leagues_cte.seasons_gold_or_higher, 0) as seasons_gold_or_higher,\n+        coalesce(leagues_cte.seasons_platinum_or_higher, 0) as seasons_platinum_or_higher,\n+        coalesce(leagues_cte.seasons_diamond_or_higher, 0) as seasons_diamond_or_higher,\n+        coalesce(leagues_cte.seasons_masters, 0) as seasons_masters,\n+        coalesce(league_ranks.largest_league_season_earnings, 0) as largest_league_season_earnings,\n+        coalesce(comments.number_of_comments, 0) as number_of_comments,\n+        coalesce(liquidity.total_liquidity_created_markets, 0) as total_liquidity_created_markets,\n+        coalesce(trades.total_trades_count, 0) as total_trades_count,\n+        coalesce(markets_created.total_markets_created, 0) as total_markets_created,\n+        coalesce(account_age.account_age_years, 0) as account_age_years,\n+        coalesce(trade_stats.profitable_trades_count, 0) as profitable_markets_count,\n+        coalesce(trade_stats.unprofitable_trades_count, 0) as unprofitable_markets_count,\n+        coalesce(trade_stats.largest_profitable_trade_value, 0) as largest_profitable_trade_value,\n+        coalesce(trade_stats.largest_unprofitable_trade_value, 0) as largest_unprofitable_trade_value,\n+        coalesce(longest_streak.longest_betting_streak, 0) as longest_betting_streak,\n+        coalesce(mod_tickets.mod_tickets_resolved, 0) as mod_tickets_resolved,\n+        coalesce(charity.charity_donated_mana, 0) as charity_donated_mana,\n+        json_build_object(\n+          'creatorTraders', json_build_object('rank', (select creator_traders_rank from mv_ach_creator_traders where user_id = (select uid from base)), 'percentile', null),\n+          'totalReferrals', json_build_object('rank', (select total_referrals_rank from mv_ach_referrals where user_id = (select uid from base)), 'percentile', null),\n+          'totalReferredProfit', json_build_object('rank', (select total_referred_profit_rank from mv_ach_referrals where user_id = (select uid from base)), 'percentile', null),\n+          'volume', json_build_object('rank', (select volume_rank from mv_ach_volume where user_id = (select uid from base)), 'percentile', null),\n+          'trades', json_build_object('rank', (select trades_rank from ach_trades where user_id = (select uid from base)), 'percentile', null),\n+          'marketsCreated', json_build_object('rank', (select markets_created_rank from mv_ach_creator_contracts where user_id = (select uid from base)), 'percentile', null),\n+          'comments', json_build_object('rank', (select comments_rank from mv_ach_comments where user_id = (select uid from base)), 'percentile', null),\n+          'seasonsGoldOrHigher', json_build_object('rank', (select seasons_gold_or_higher_rank from mv_ach_leagues where user_id = (select uid from base)), 'percentile', null),\n+          'seasonsPlatinumOrHigher', json_build_object('rank', (select seasons_platinum_or_higher_rank from mv_ach_leagues where user_id = (select uid from base)), 'percentile', null),\n+          'seasonsDiamondOrHigher', json_build_object('rank', (select seasons_diamond_or_higher_rank from mv_ach_leagues where user_id = (select uid from base)), 'percentile', null),\n+          'seasonsMasters', json_build_object('rank', (select seasons_masters_rank from mv_ach_leagues where user_id = (select uid from base)), 'percentile', null),\n+          'largestLeagueSeasonEarnings', json_build_object('rank', (select largest_league_season_earnings_rank from mv_ach_leagues where user_id = (select uid from base)), 'percentile', null),\n+          'liquidity', json_build_object('rank', (select liquidity_rank from mv_ach_creator_contracts where user_id = (select uid from base)), 'percentile', null),\n+          'profitableMarkets', json_build_object('rank', (select profitable_markets_rank from mv_ach_pnl where user_id = (select uid from base)), 'percentile', null),\n+          'unprofitableMarkets', json_build_object('rank', (select unprofitable_markets_rank from mv_ach_pnl where user_id = (select uid from base)), 'percentile', null),\n+          'largestProfitableTrade', json_build_object('rank', (select largest_profitable_trade_rank from mv_ach_pnl where user_id = (select uid from base)), 'percentile', null),\n+          'largestUnprofitableTrade', json_build_object('rank', (select largest_unprofitable_trade_rank from mv_ach_pnl where user_id = (select uid from base)), 'percentile', null),\n+          'accountAge', json_build_object('rank', (select account_age_rank from mv_ach_account_age where user_id = (select uid from base)), 'percentile', null),\n+          'longestBettingStreak', json_build_object('rank', (select longest_betting_streak_rank from mv_ach_txns_achievements where user_id = (select uid from base)), 'percentile', null),\n+          'modTickets', json_build_object('rank', (select mod_tickets_rank from mv_ach_txns_achievements where user_id = (select uid from base)), 'percentile', null),\n+          'charityDonated', json_build_object('rank', (select charity_donated_rank from mv_ach_txns_achievements where user_id = (select uid from base)), 'percentile', null)\n+        ) as ranks_json\n+      from base\n+      \n+      left join creators on true\n+      left join referrals on true\n+      left join mod_tickets on true\n+      left join charity on true\n+      left join volume on true\n+      left join leagues_cte on true\n+      left join league_ranks on true\n+      left join comments on true\n+      left join liquidity on true\n+      left join trades on true\n+      left join markets_created on true\n+      left join account_age on true\n+      left join trade_stats on true\n+      left join longest_streak on true`\n+\n+  const result = await pg.oneOrNone(queryWithPerMV, [userId])\n+\n+  const defaultRanks = {\n+    creatorTraders: { rank: null, percentile: null },\n+    totalReferrals: { rank: null, percentile: null },\n+    totalReferredProfit: { rank: null, percentile: null },\n+    volume: { rank: null, percentile: null },\n+    trades: { rank: null, percentile: null },\n+    marketsCreated: { rank: null, percentile: null },\n+    comments: { rank: null, percentile: null },\n+    seasonsGoldOrHigher: { rank: null, percentile: null },\n+    seasonsPlatinumOrHigher: { rank: null, percentile: null },\n+    seasonsDiamondOrHigher: { rank: null, percentile: null },\n+    seasonsMasters: { rank: null, percentile: null },\n+    largestLeagueSeasonEarnings: { rank: null, percentile: null },\n+    liquidity: { rank: null, percentile: null },\n+    profitableMarkets: { rank: null, percentile: null },\n+    unprofitableMarkets: { rank: null, percentile: null },\n+    largestProfitableTrade: { rank: null, percentile: null },\n+    largestUnprofitableTrade: { rank: null, percentile: null },\n+    accountAge: { rank: null, percentile: null },\n+    longestBettingStreak: { rank: null, percentile: null },\n+    modTickets: { rank: null, percentile: null },\n+    charityDonated: { rank: null, percentile: null },\n+  }\n+\n+  const rawRanks = (result?.ranks_json as any) ?? defaultRanks\n+  const { n } = await pg.one('select count(*)::int as n from mv_ach_volume')\n+  const N = Number(n ?? 0)\n+  const conv = (e?: { rank: number | null; percentile: number | null }) =>\n+    e?.rank && N > 0\n+      ? { rank: e.rank, percentile: (e.rank / N) * 100 }\n+      : { rank: e?.rank ?? null, percentile: null }\n+\n+  const ranks = {\n+    creatorTraders: conv(rawRanks.creatorTraders),\n+    totalReferrals: conv(rawRanks.totalReferrals),\n+    totalReferredProfit: conv(rawRanks.totalReferredProfit),\n+    volume: conv(rawRanks.volume),\n+    trades: conv(rawRanks.trades),\n+    marketsCreated: conv(rawRanks.marketsCreated),\n+    comments: conv(rawRanks.comments),\n+    seasonsGoldOrHigher: conv(rawRanks.seasonsGoldOrHigher),\n+    seasonsPlatinumOrHigher: conv(rawRanks.seasonsPlatinumOrHigher),\n+    seasonsDiamondOrHigher: conv(rawRanks.seasonsDiamondOrHigher),\n+    seasonsMasters: conv(rawRanks.seasonsMasters),\n+    largestLeagueSeasonEarnings: conv(rawRanks.largestLeagueSeasonEarnings),\n+    liquidity: conv(rawRanks.liquidity),\n+    profitableMarkets: conv(rawRanks.profitableMarkets),\n+    unprofitableMarkets: conv(rawRanks.unprofitableMarkets),\n+    largestProfitableTrade: conv(rawRanks.largestProfitableTrade),\n+    largestUnprofitableTrade: conv(rawRanks.largestUnprofitableTrade),\n+    accountAge: conv(rawRanks.accountAge),\n+    longestBettingStreak: conv(rawRanks.longestBettingStreak),\n+    modTickets: conv(rawRanks.modTickets),\n+    charityDonated: conv(rawRanks.charityDonated),\n+  }\n+\n+  return {\n+    userId,\n+    creatorTraders: Number(result?.creator_traders ?? 0),\n+    totalReferrals: Number(result?.total_referrals ?? 0),\n+    totalReferredProfitMana: Number(result?.total_referred_profit_mana ?? 0),\n+    totalVolumeMana: Number(result?.total_volume_mana ?? 0),\n+    seasonsGoldOrHigher: Number(result?.seasons_gold_or_higher ?? 0),\n+    seasonsPlatinumOrHigher: Number(result?.seasons_platinum_or_higher ?? 0),\n+    seasonsDiamondOrHigher: Number(result?.seasons_diamond_or_higher ?? 0),\n+    seasonsMasters: Number(result?.seasons_masters ?? 0),\n+    largestLeagueSeasonEarnings: Number(\n+      result?.largest_league_season_earnings ?? 0\n+    ),\n+    numberOfComments: Number(result?.number_of_comments ?? 0),\n+    totalLiquidityCreatedMarkets: Number(\n+      result?.total_liquidity_created_markets ?? 0\n+    ),\n+    totalTradesCount: Number(result?.total_trades_count ?? 0),\n+    totalMarketsCreated: Number(result?.total_markets_created ?? 0),\n+    accountAgeYears: Number(result?.account_age_years ?? 0),\n+    profitableMarketsCount: Number(result?.profitable_markets_count ?? 0),\n+    unprofitableMarketsCount: Number(result?.unprofitable_markets_count ?? 0),\n+    largestProfitableTradeValue: Number(\n+      result?.largest_profitable_trade_value ?? 0\n+    ),\n+    largestUnprofitableTradeValue: Number(\n+      result?.largest_unprofitable_trade_value ?? 0\n+    ),\n+    longestBettingStreak: Number(result?.longest_betting_streak ?? 0),\n+    modTicketsResolved: Number(result?.mod_tickets_resolved ?? 0),\n+    charityDonatedMana: Number(result?.charity_donated_mana ?? 0),\n+    ranks,\n+  }\n+}\n"
        },
        {
          "path": "backend/api/src/routes.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/routes.ts\n===================================================================\n--- backend/api/src/routes.ts\t538b6b6 (parent)\n+++ backend/api/src/routes.ts\t60532e5 (commit)\n@@ -182,8 +182,9 @@\n import { purchaseContractBoost } from './purchase-boost'\n import { referUser } from './refer-user'\n import { updatePost } from './update-post'\n import { validateiap } from './validate-iap'\n+import { getUserAchievements } from './get-user-achievements'\n \n export const handlers: { [k in APIPath]: APIHandler<k> } = {\n   'refresh-all-clients': refreshAllClients,\n   bet: placeBet,\n@@ -372,5 +373,6 @@\n   'follow-post': followPost,\n   'edit-post-comment': editPostComment,\n   'user-comments': getUserComments,\n   'get-user-last-active-time': getUserLastActiveTime,\n+  'get-user-achievements': getUserAchievements,\n } as const\n"
        },
        {
          "path": "backend/scheduler/src/jobs/index.ts",
          "status": "modified",
          "diff": "Index: backend/scheduler/src/jobs/index.ts\n===================================================================\n--- backend/scheduler/src/jobs/index.ts\t538b6b6 (parent)\n+++ backend/scheduler/src/jobs/index.ts\t60532e5 (commit)\n@@ -38,8 +38,20 @@\n import { sendStreakExpirationNotification } from './streak-expiration-notice'\n import { updateLeague } from './update-league'\n import { updateLeagueRanks } from './update-league-ranks'\n import { updateStatsCore } from './update-stats'\n+import { updateAchTrades } from './update-ach-trades'\n+import {\n+  refreshAchAccountAge,\n+  refreshAchComments,\n+  refreshAchCreatorContracts,\n+  refreshAchCreatorTraders,\n+  refreshAchLeagues,\n+  refreshAchPnl,\n+  refreshAchReferrals,\n+  refreshAchTxns,\n+  refreshAchVolume,\n+} from './refresh-achievement-mvs'\n \n export function createJobs() {\n   return [\n     createJob(\n@@ -138,8 +150,59 @@\n       'clean-old-notifications',\n       '0 30 2 * * *', // 230 AM daily\n       cleanOldNotifications\n     ),\n+    // // Achievement MV refreshes (nightly, staggered ~10 mins apart)\n+    // createJob(\n+    //   'update-ach-trades',\n+    //   '0 10 2 * * *', // 2:10 AM daily\n+    //   updateAchTrades\n+    // ),\n+    // createJob(\n+    //   'refresh-ach-volume',\n+    //   '0 30 2 * * *', // 2:30 AM\n+    //   refreshAchVolume\n+    // ),\n+    // createJob(\n+    //   'refresh-ach-comments',\n+    //   '0 40 2 * * *', // 2:40 AM\n+    //   refreshAchComments\n+    // ),\n+    // createJob(\n+    //   'refresh-ach-creator-contracts',\n+    //   '0 50 2 * * *', // 2:50 AM\n+    //   refreshAchCreatorContracts\n+    // ),\n+    // createJob(\n+    //   'refresh-ach-referrals',\n+    //   '0 0 3 * * *', // 3:00 AM\n+    //   refreshAchReferrals\n+    // ),\n+    // createJob(\n+    //   'refresh-ach-creator-traders',\n+    //   '0 10 3 * * *', // 3:10 AM\n+    //   refreshAchCreatorTraders\n+    // ),\n+    // createJob(\n+    //   'refresh-ach-leagues',\n+    //   '0 20 3 * * *', // 3:20 AM\n+    //   refreshAchLeagues\n+    // ),\n+    // createJob(\n+    //   'refresh-ach-pnl',\n+    //   '0 30 3 * * *', // 3:30 AM\n+    //   refreshAchPnl\n+    // ),\n+    // createJob(\n+    //   'refresh-ach-txns',\n+    //   '0 40 3 * * *', // 3:40 AM\n+    //   refreshAchTxns\n+    // ),\n+    // createJob(\n+    //   'refresh-ach-account-age',\n+    //   '0 50 3 * * *', // 3:50 AM\n+    //   refreshAchAccountAge\n+    // ),\n     createJob(\n       'update-user-metric-periods',\n       '0 0 2 * * *', // 2 AM daily\n       async () => {\n"
        },
        {
          "path": "backend/scheduler/src/jobs/refresh-achievement-mvs.ts",
          "status": "added",
          "diff": "Index: backend/scheduler/src/jobs/refresh-achievement-mvs.ts\n===================================================================\n--- backend/scheduler/src/jobs/refresh-achievement-mvs.ts\t538b6b6 (parent)\n+++ backend/scheduler/src/jobs/refresh-achievement-mvs.ts\t60532e5 (commit)\n@@ -0,0 +1,22 @@\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { log } from 'shared/utils'\n+\n+async function refreshMV(name: string) {\n+  const pg = createSupabaseDirectClient()\n+  log(`Refreshing MV: ${name}`)\n+  // Use CONCURRENTLY to reduce locking; requires unique index which we have.\n+  await pg.none(`refresh materialized view concurrently ${name}`)\n+  log(`Refreshed MV: ${name}`)\n+}\n+\n+export const refreshAchVolume = async () => refreshMV('mv_ach_volume')\n+export const refreshAchComments = async () => refreshMV('mv_ach_comments')\n+export const refreshAchLeagues = async () => refreshMV('mv_ach_leagues')\n+export const refreshAchPnl = async () => refreshMV('mv_ach_pnl')\n+export const refreshAchTxns = async () => refreshMV('mv_ach_txns_achievements')\n+export const refreshAchCreatorContracts = async () =>\n+  refreshMV('mv_ach_creator_contracts')\n+export const refreshAchReferrals = async () => refreshMV('mv_ach_referrals')\n+export const refreshAchCreatorTraders = async () =>\n+  refreshMV('mv_ach_creator_traders')\n+export const refreshAchAccountAge = async () => refreshMV('mv_ach_account_age')\n"
        },
        {
          "path": "backend/scheduler/src/jobs/update-ach-trades.ts",
          "status": "added",
          "diff": "Index: backend/scheduler/src/jobs/update-ach-trades.ts\n===================================================================\n--- backend/scheduler/src/jobs/update-ach-trades.ts\t538b6b6 (parent)\n+++ backend/scheduler/src/jobs/update-ach-trades.ts\t60532e5 (commit)\n@@ -0,0 +1,56 @@\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { log } from 'shared/utils'\n+\n+export const updateAchTrades = async () => {\n+  const pg = createSupabaseDirectClient()\n+\n+  log('update-ach-trades: ensure rows for all users')\n+  await pg.none(`\n+    insert into ach_trades (user_id, total_trades_count, last_updated)\n+    select u.id, 0, to_timestamp(0)\n+    from users u\n+    on conflict (user_id) do nothing\n+  `)\n+\n+  log('update-ach-trades: apply incremental deltas')\n+  await pg.none(`\n+    with deltas as (\n+      select\n+        b.user_id,\n+        count(*)::int as delta_trades,\n+        max(b.created_time) as new_last\n+      from contract_bets b\n+      join contracts c on c.id = b.contract_id\n+      left join ach_trades at on at.user_id = b.user_id\n+      where coalesce(b.is_redemption, false) = false\n+        and coalesce(b.is_filled, true) = true\n+        and coalesce(b.is_cancelled, false) = false\n+        and (b.is_api is null or b.is_api = false)\n+        and c.token = 'MANA'\n+        and b.created_time > coalesce(at.last_updated, to_timestamp(0))\n+      group by b.user_id\n+    )\n+    insert into ach_trades (user_id, total_trades_count, last_updated)\n+    select user_id, delta_trades, new_last from deltas\n+    on conflict (user_id) do update\n+      set total_trades_count = ach_trades.total_trades_count + excluded.total_trades_count,\n+          last_updated = greatest(ach_trades.last_updated, excluded.last_updated)\n+  `)\n+\n+  log('update-ach-trades: recompute ranks')\n+  await pg.none(`\n+    with ranks as (\n+      select\n+        user_id,\n+        rank() over (order by total_trades_count desc) as r,\n+        count(*) over () as n\n+      from ach_trades\n+    )\n+    update ach_trades t\n+    set trades_rank = r.r\n+    from ranks r\n+    where t.user_id = r.user_id\n+  `)\n+\n+  log('update-ach-trades: done')\n+}\n"
        },
        {
          "path": "backend/supabase/achievement_materialized_views.sql",
          "status": "added",
          "diff": "Index: backend/supabase/achievement_materialized_views.sql\n===================================================================\n--- backend/supabase/achievement_materialized_views.sql\t538b6b6 (parent)\n+++ backend/supabase/achievement_materialized_views.sql\t60532e5 (commit)\n@@ -0,0 +1,621 @@\n+-- Volume\n+create materialized view if not exists\n+  mv_ach_volume as\n+with\n+  mana_contracts as (\n+    select\n+      id\n+    from\n+      contracts\n+    where\n+      token = 'MANA'\n+  ),\n+  volume as (\n+    select\n+      ucm.user_id,\n+      sum(\n+        coalesce((ucm.data ->> 'totalAmountSold')::numeric, 0) + coalesce((ucm.data ->> 'totalAmountInvested')::numeric, 0)\n+      ) as total_volume_mana\n+    from\n+      user_contract_metrics ucm\n+      join mana_contracts mc on mc.id = ucm.contract_id\n+    where\n+      ucm.answer_id is null\n+    group by\n+      ucm.user_id\n+  ),\n+  all_users as (\n+    select\n+      id as user_id\n+    from\n+      users\n+  )\n+select\n+  u.user_id,\n+  coalesce(v.total_volume_mana, 0) as total_volume_mana,\n+  rank() over (\n+    order by\n+      coalesce(v.total_volume_mana, 0) desc\n+  ) as volume_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(v.total_volume_mana, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as volume_percentile\n+from\n+  all_users u\n+  left join volume v on v.user_id = u.user_id;\n+\n+create unique index if not exists mv_ach_volume_user_id_idx on public.mv_ach_volume (user_id);\n+\n+-- Trades\n+create table if not exists\n+  ach_trades (\n+    user_id text primary key,\n+    total_trades_count integer not null default 0,\n+    trades_rank integer,\n+    last_updated timestamp with time zone not null default to_timestamp(0)\n+  );\n+\n+create unique index if not exists ach_trades_user_id_idx on public.ach_trades (user_id);\n+\n+-- Comments (liked-only)\n+create materialized view if not exists\n+  mv_ach_comments as\n+with\n+  liked_comments as (\n+    select\n+      content_owner_id as user_id,\n+      count(distinct content_id) as liked_comments\n+    from\n+      user_reactions\n+    where\n+      content_type = 'comment'\n+      and reaction_type = 'like'\n+    group by\n+      content_owner_id\n+  ),\n+  all_users as (\n+    select\n+      id as user_id\n+    from\n+      users\n+  )\n+select\n+  u.user_id,\n+  coalesce(lc.liked_comments, 0) as number_of_comments,\n+  rank() over (\n+    order by\n+      coalesce(lc.liked_comments, 0) desc\n+  ) as comments_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(lc.liked_comments, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as comments_percentile\n+from\n+  all_users u\n+  left join liked_comments lc on lc.user_id = u.user_id;\n+\n+create unique index if not exists mv_ach_comments_user_id_idx on public.mv_ach_comments (user_id);\n+\n+-- Leagues (grouped)\n+create materialized view if not exists\n+  mv_ach_leagues as\n+with\n+  leagues_agg as (\n+    select\n+      l.user_id,\n+      count(*) filter (\n+        where\n+          l.division >= 3\n+      ) as seasons_gold_or_higher,\n+      count(*) filter (\n+        where\n+          l.division >= 4\n+      ) as seasons_platinum_or_higher,\n+      count(*) filter (\n+        where\n+          l.division >= 5\n+      ) as seasons_diamond_or_higher,\n+      count(*) filter (\n+        where\n+          l.division = 6\n+      ) as seasons_masters,\n+      max(l.mana_earned) as largest_league_season_earnings\n+    from\n+      leagues l\n+    group by\n+      l.user_id\n+  ),\n+  all_users as (\n+    select\n+      id as user_id\n+    from\n+      users\n+  )\n+select\n+  u.user_id,\n+  coalesce(la.seasons_gold_or_higher, 0) as seasons_gold_or_higher,\n+  coalesce(la.seasons_platinum_or_higher, 0) as seasons_platinum_or_higher,\n+  coalesce(la.seasons_diamond_or_higher, 0) as seasons_diamond_or_higher,\n+  coalesce(la.seasons_masters, 0) as seasons_masters,\n+  coalesce(la.largest_league_season_earnings, 0) as largest_league_season_earnings,\n+  rank() over (\n+    order by\n+      coalesce(la.seasons_gold_or_higher, 0) desc\n+  ) as seasons_gold_or_higher_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(la.seasons_gold_or_higher, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as seasons_gold_or_higher_percentile,\n+  rank() over (\n+    order by\n+      coalesce(la.seasons_platinum_or_higher, 0) desc\n+  ) as seasons_platinum_or_higher_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(la.seasons_platinum_or_higher, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as seasons_platinum_or_higher_percentile,\n+  rank() over (\n+    order by\n+      coalesce(la.seasons_diamond_or_higher, 0) desc\n+  ) as seasons_diamond_or_higher_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(la.seasons_diamond_or_higher, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as seasons_diamond_or_higher_percentile,\n+  rank() over (\n+    order by\n+      coalesce(la.seasons_masters, 0) desc\n+  ) as seasons_masters_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(la.seasons_masters, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as seasons_masters_percentile,\n+  rank() over (\n+    order by\n+      coalesce(la.largest_league_season_earnings, 0) desc\n+  ) as largest_league_season_earnings_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(la.largest_league_season_earnings, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as largest_league_season_earnings_percentile\n+from\n+  all_users u\n+  left join leagues_agg la on la.user_id = u.user_id;\n+\n+create unique index if not exists mv_ach_leagues_user_id_idx on public.mv_ach_leagues (user_id);\n+\n+-- PnL-like (profitable/unprofitable counts and largest trades)\n+create materialized view if not exists\n+  mv_ach_pnl as\n+with\n+  mana_contracts as (\n+    select\n+      id\n+    from\n+      contracts\n+    where\n+      token = 'MANA'\n+  ),\n+  ucm_pnl as (\n+    select\n+      ucm.user_id,\n+      count(*) filter (\n+        where\n+          coalesce(ucm.profit, 0) > 0\n+      ) as profitable_markets_count,\n+      count(*) filter (\n+        where\n+          coalesce(ucm.profit, 0) < 0\n+      ) as unprofitable_markets_count,\n+      max(ucm.profit) filter (\n+        where\n+          coalesce(ucm.profit, 0) > 0\n+      ) as largest_profitable_trade_value,\n+      min(ucm.profit) filter (\n+        where\n+          coalesce(ucm.profit, 0) < 0\n+      ) as largest_unprofitable_trade_value\n+    from\n+      user_contract_metrics ucm\n+      join mana_contracts mc on mc.id = ucm.contract_id\n+    where\n+      ucm.answer_id is null\n+    group by\n+      ucm.user_id\n+  ),\n+  all_users as (\n+    select\n+      id as user_id\n+    from\n+      users\n+  )\n+select\n+  u.user_id,\n+  coalesce(pnl.profitable_markets_count, 0) as profitable_markets_count,\n+  coalesce(pnl.unprofitable_markets_count, 0) as unprofitable_markets_count,\n+  coalesce(pnl.largest_profitable_trade_value, 0) as largest_profitable_trade_value,\n+  coalesce(pnl.largest_unprofitable_trade_value, 0) as largest_unprofitable_trade_value,\n+  rank() over (\n+    order by\n+      coalesce(pnl.profitable_markets_count, 0) desc\n+  ) as profitable_markets_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(pnl.profitable_markets_count, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as profitable_markets_percentile,\n+  rank() over (\n+    order by\n+      coalesce(pnl.unprofitable_markets_count, 0) desc\n+  ) as unprofitable_markets_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(pnl.unprofitable_markets_count, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as unprofitable_markets_percentile,\n+  rank() over (\n+    order by\n+      coalesce(pnl.largest_profitable_trade_value, 0) desc\n+  ) as largest_profitable_trade_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(pnl.largest_profitable_trade_value, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as largest_profitable_trade_percentile,\n+  rank() over (\n+    order by\n+      coalesce(pnl.largest_unprofitable_trade_value, 0) asc\n+  ) as largest_unprofitable_trade_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(pnl.largest_unprofitable_trade_value, 0) asc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as largest_unprofitable_trade_percentile\n+from\n+  all_users u\n+  left join ucm_pnl pnl on pnl.user_id = u.user_id;\n+\n+create unique index if not exists mv_ach_pnl_user_id_idx on public.mv_ach_pnl (user_id);\n+\n+-- Combined: Txns-based achievements (mod tickets resolved + charity donated + longest streak)\n+create materialized view if not exists\n+  mv_ach_txns_achievements as\n+with\n+  mod_tickets_agg as (\n+    select\n+      to_id as user_id,\n+      count(*) as mod_tickets_resolved\n+    from\n+      txns\n+    where\n+      category = 'ADMIN_REWARD'\n+    group by\n+      to_id\n+  ),\n+  charity_agg as (\n+    select\n+      from_id as user_id,\n+      sum(\n+        case\n+          when token = 'M$' then amount / 100.0\n+          when token = 'CASH' then amount\n+          when token = 'SPICE' then amount / 1000.0\n+          else 0\n+        end\n+      ) as charity_donated_mana\n+    from\n+      txns\n+    where\n+      category = 'CHARITY'\n+    group by\n+      from_id\n+  ),\n+  streaks_agg as (\n+    select\n+      to_id as user_id,\n+      coalesce(\n+        max((data -> 'data' ->> 'currentBettingStreak')::int),\n+        0\n+      ) as longest_betting_streak\n+    from\n+      txns\n+    where\n+      category = 'BETTING_STREAK_BONUS'\n+    group by\n+      to_id\n+  ),\n+  all_users as (\n+    select\n+      id as user_id\n+    from\n+      users\n+  )\n+select\n+  u.user_id,\n+  coalesce(m.mod_tickets_resolved, 0) as mod_tickets_resolved,\n+  coalesce(c.charity_donated_mana, 0) as charity_donated_mana,\n+  coalesce(s.longest_betting_streak, 0) as longest_betting_streak,\n+  rank() over (\n+    order by\n+      coalesce(m.mod_tickets_resolved, 0) desc\n+  ) as mod_tickets_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(m.mod_tickets_resolved, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as mod_tickets_percentile,\n+  rank() over (\n+    order by\n+      coalesce(c.charity_donated_mana, 0) desc\n+  ) as charity_donated_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(c.charity_donated_mana, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as charity_donated_percentile,\n+  rank() over (\n+    order by\n+      coalesce(s.longest_betting_streak, 0) desc\n+  ) as longest_betting_streak_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(s.longest_betting_streak, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as longest_betting_streak_percentile\n+from\n+  all_users u\n+  left join mod_tickets_agg m on m.user_id = u.user_id\n+  left join charity_agg c on c.user_id = u.user_id\n+  left join streaks_agg s on s.user_id = u.user_id;\n+\n+create unique index if not exists mv_ach_txns_achievements_user_id_idx on public.mv_ach_txns_achievements (user_id);\n+\n+-- Combined: Creator-contract achievements (markets created + liquidity)\n+create materialized view if not exists\n+  mv_ach_creator_contracts as\n+with\n+  mana_contracts as (\n+    select\n+      id,\n+      creator_id,\n+      (data ->> 'uniqueBettorCount')::int as unique_bettors,\n+      (data ->> 'totalLiquidity')::numeric as total_liq\n+    from\n+      contracts\n+    where\n+      token = 'MANA'\n+  ),\n+  creator_agg as (\n+    select\n+      creator_id as user_id,\n+      count(*) filter (\n+        where\n+          unique_bettors >= 2\n+      ) as total_markets_created,\n+      coalesce(sum(total_liq), 0) as total_liquidity_created_markets\n+    from\n+      mana_contracts\n+    group by\n+      creator_id\n+  ),\n+  all_users as (\n+    select\n+      id as user_id\n+    from\n+      users\n+  )\n+select\n+  u.user_id,\n+  coalesce(ca.total_markets_created, 0) as total_markets_created,\n+  coalesce(ca.total_liquidity_created_markets, 0) as total_liquidity_created_markets,\n+  rank() over (\n+    order by\n+      coalesce(ca.total_markets_created, 0) desc\n+  ) as markets_created_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(ca.total_markets_created, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as markets_created_percentile,\n+  rank() over (\n+    order by\n+      coalesce(ca.total_liquidity_created_markets, 0) desc\n+  ) as liquidity_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(ca.total_liquidity_created_markets, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as liquidity_percentile\n+from\n+  all_users u\n+  left join creator_agg ca on ca.user_id = u.user_id;\n+\n+create unique index if not exists mv_ach_creator_contracts_user_id_idx on public.mv_ach_creator_contracts (user_id);\n+\n+-- Referrals (count and referred profit)\n+create materialized view if not exists\n+  mv_ach_referrals as\n+with\n+  referrals as (\n+    select\n+      id as user_id,\n+      coalesce(total_referrals, 0) as total_referrals,\n+      coalesce(total_referred_profit, 0) as total_referred_profit_mana\n+    from\n+      user_referrals_profit\n+  ),\n+  all_users as (\n+    select\n+      id as user_id\n+    from\n+      users\n+  )\n+select\n+  u.user_id,\n+  coalesce(r.total_referrals, 0) as total_referrals,\n+  coalesce(r.total_referred_profit_mana, 0) as total_referred_profit_mana,\n+  rank() over (\n+    order by\n+      coalesce(r.total_referrals, 0) desc\n+  ) as total_referrals_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(r.total_referrals, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as total_referrals_percentile,\n+  rank() over (\n+    order by\n+      coalesce(r.total_referred_profit_mana, 0) desc\n+  ) as total_referred_profit_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(r.total_referred_profit_mana, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as total_referred_profit_percentile\n+from\n+  all_users u\n+  left join referrals r on r.user_id = u.user_id;\n+\n+create unique index if not exists mv_ach_referrals_user_id_idx on public.mv_ach_referrals (user_id);\n+\n+-- Creator traders (unique traders on your markets)\n+create materialized view if not exists\n+  mv_ach_creator_traders as\n+with\n+  creator_traders as (\n+    select\n+      id as user_id,\n+      coalesce((data -> 'creatorTraders' ->> 'allTime')::int, 0) as creator_traders\n+    from\n+      users\n+  ),\n+  all_users as (\n+    select\n+      id as user_id\n+    from\n+      users\n+  )\n+select\n+  u.user_id,\n+  coalesce(ct.creator_traders, 0) as creator_traders,\n+  rank() over (\n+    order by\n+      coalesce(ct.creator_traders, 0) desc\n+  ) as creator_traders_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(ct.creator_traders, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as creator_traders_percentile\n+from\n+  all_users u\n+  left join creator_traders ct on ct.user_id = u.user_id;\n+\n+create unique index if not exists mv_ach_creator_traders_user_id_idx on public.mv_ach_creator_traders (user_id);\n+\n+-- Account age (in years at refresh time)\n+create materialized view if not exists\n+  mv_ach_account_age as\n+with\n+  ages as (\n+    select\n+      id as user_id,\n+      extract(\n+        epoch\n+        from\n+          (now() - created_time)\n+      ) / (365.25 * 24 * 60 * 60) as account_age_years\n+    from\n+      users\n+  ),\n+  all_users as (\n+    select\n+      id as user_id\n+    from\n+      users\n+  )\n+select\n+  u.user_id,\n+  coalesce(a.account_age_years, 0) as account_age_years,\n+  rank() over (\n+    order by\n+      coalesce(a.account_age_years, 0) desc\n+  ) as account_age_rank,\n+  (\n+    (\n+      (count(*) over ()) - rank() over (\n+        order by\n+          coalesce(a.account_age_years, 0) desc\n+      ) + 1\n+    )::numeric / (count(*) over ())\n+  ) * 100 as account_age_percentile\n+from\n+  all_users u\n+  left join ages a on a.user_id = u.user_id;\n+\n+create unique index if not exists mv_ach_account_age_user_id_idx on public.mv_ach_account_age (user_id);\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\t538b6b6 (parent)\n+++ common/src/api/schema.ts\t60532e5 (commit)\n@@ -1980,8 +1980,81 @@\n     authed: true,\n     returns: {} as { isSportsInterested: boolean },\n     props: z.object({}).strict(),\n   },\n+  'get-user-achievements': {\n+    method: 'GET',\n+    visibility: 'public',\n+    authed: false,\n+    cache: LIGHT_CACHE_STRATEGY,\n+    returns: {} as {\n+      userId: string\n+      creatorTraders: number\n+      totalReferrals: number\n+      totalReferredProfitMana: number\n+      totalVolumeMana: number\n+      seasonsGoldOrHigher: number\n+      seasonsPlatinumOrHigher: number\n+      seasonsDiamondOrHigher: number\n+      seasonsMasters: number\n+      numberOfComments: number\n+      totalLiquidityCreatedMarkets: number\n+      totalTradesCount: number\n+      totalMarketsCreated: number\n+      accountAgeYears: number\n+      profitableMarketsCount: number\n+      unprofitableMarketsCount: number\n+      largestProfitableTradeValue: number\n+      largestUnprofitableTradeValue: number\n+      longestBettingStreak: number\n+      largestLeagueSeasonEarnings: number\n+      modTicketsResolved: number\n+      charityDonatedMana: number\n+      ranks: {\n+        creatorTraders: { rank: number | null; percentile: number | null }\n+        totalReferrals: { rank: number | null; percentile: number | null }\n+        totalReferredProfit: { rank: number | null; percentile: number | null }\n+        volume: { rank: number | null; percentile: number | null }\n+        trades: { rank: number | null; percentile: number | null }\n+        marketsCreated: { rank: number | null; percentile: number | null }\n+        comments: { rank: number | null; percentile: number | null }\n+        seasonsGoldOrHigher: { rank: number | null; percentile: number | null }\n+        seasonsPlatinumOrHigher: {\n+          rank: number | null\n+          percentile: number | null\n+        }\n+        seasonsDiamondOrHigher: {\n+          rank: number | null\n+          percentile: number | null\n+        }\n+        seasonsMasters: { rank: number | null; percentile: number | null }\n+        largestLeagueSeasonEarnings: {\n+          rank: number | null\n+          percentile: number | null\n+        }\n+        liquidity: { rank: number | null; percentile: number | null }\n+        profitableMarkets: { rank: number | null; percentile: number | null }\n+        unprofitableMarkets: { rank: number | null; percentile: number | null }\n+        largestProfitableTrade: {\n+          rank: number | null\n+          percentile: number | null\n+        }\n+        largestUnprofitableTrade: {\n+          rank: number | null\n+          percentile: number | null\n+        }\n+        accountAge: { rank: number | null; percentile: number | null }\n+        longestBettingStreak: { rank: number | null; percentile: number | null }\n+        modTickets: { rank: number | null; percentile: number | null }\n+        charityDonated: { rank: number | null; percentile: number | null }\n+      }\n+    },\n+    props: z\n+      .object({\n+        userId: z.string(),\n+      })\n+      .strict(),\n+  },\n   'get-site-activity': {\n     method: 'GET',\n     visibility: 'public',\n     authed: false,\n"
        },
        {
          "path": "web/pages/[username]/index.tsx",
          "status": "modified",
          "diff": "Index: web/pages/[username]/index.tsx\n===================================================================\n--- web/pages/[username]/index.tsx\t538b6b6 (parent)\n+++ web/pages/[username]/index.tsx\t60532e5 (commit)\n@@ -13,8 +13,9 @@\n import { unauthedApi } from 'common/util/api'\n import { buildArray } from 'common/util/array'\n import { removeUndefinedProps } from 'common/util/object'\n import Head from 'next/head'\n+import Image from 'next/image'\n import Link from 'next/link'\n import { useRouter } from 'next/router'\n import { useEffect, useState } from 'react'\n import { UserBetsTable } from 'web/components/bet/user-bets-table'\n@@ -61,8 +62,13 @@\n import { db } from 'web/lib/supabase/db'\n import { getAverageUserRating, getUserRating } from 'web/lib/supabase/reviews'\n import Custom404 from 'web/pages/404'\n import { UserPayments } from 'web/pages/payments'\n+import {\n+  formatMoney,\n+  formatWithCommas,\n+  formatMoneyUSD,\n+} from 'common/util/format'\n \n export const getStaticProps = async (props: {\n   params: {\n     username: string\n@@ -426,8 +432,19 @@\n                   </>\n                 ),\n               },\n               {\n+                title: 'Achievements',\n+                prerender: true,\n+                stackedTabIcon: <TrophyIcon className=\"h-5\" />,\n+                content: (\n+                  <>\n+                    <Spacer h={4} />\n+                    <AchievementsSection userId={user.id} />\n+                  </>\n+                ),\n+              },\n+              {\n                 title: 'Balance log',\n                 stackedTabIcon: <ViewListIcon className=\"h-5\" />,\n                 content: <BalanceChangeTable user={user} />,\n                 queryString: balanceChangesKey,\n@@ -537,8 +554,515 @@\n     </Row>\n   )\n }\n \n+function AchievementsSection(props: { userId: string }) {\n+  const { userId } = props\n+  const [loading, setLoading] = useState(true)\n+  const [error, setError] = useState<string | null>(null)\n+  type RanksType = {\n+    creatorTraders: { rank: number | null; percentile: number | null }\n+    totalReferrals: { rank: number | null; percentile: number | null }\n+    totalReferredProfit: { rank: number | null; percentile: number | null }\n+    volume: { rank: number | null; percentile: number | null }\n+    trades: { rank: number | null; percentile: number | null }\n+    marketsCreated: { rank: number | null; percentile: number | null }\n+    comments: { rank: number | null; percentile: number | null }\n+    seasonsGoldOrHigher: { rank: number | null; percentile: number | null }\n+    seasonsPlatinumOrHigher: { rank: number | null; percentile: number | null }\n+    seasonsDiamondOrHigher: { rank: number | null; percentile: number | null }\n+    seasonsMasters: { rank: number | null; percentile: number | null }\n+    largestLeagueSeasonEarnings: {\n+      rank: number | null\n+      percentile: number | null\n+    }\n+    liquidity: { rank: number | null; percentile: number | null }\n+    profitableMarkets: { rank: number | null; percentile: number | null }\n+    unprofitableMarkets: { rank: number | null; percentile: number | null }\n+    largestProfitableTrade: {\n+      rank: number | null\n+      percentile: number | null\n+    }\n+    largestUnprofitableTrade: {\n+      rank: number | null\n+      percentile: number | null\n+    }\n+    accountAge: { rank: number | null; percentile: number | null }\n+    longestBettingStreak: { rank: number | null; percentile: number | null }\n+    modTickets: { rank: number | null; percentile: number | null }\n+    charityDonated: { rank: number | null; percentile: number | null }\n+  }\n+\n+  const [data, setData] = useState<{\n+    userId: string\n+    creatorTraders: number\n+    totalReferrals: number\n+    totalReferredProfitMana: number\n+    totalVolumeMana: number\n+    seasonsGoldOrHigher: number\n+    seasonsPlatinumOrHigher: number\n+    seasonsDiamondOrHigher: number\n+    seasonsMasters: number\n+    numberOfComments: number\n+    totalLiquidityCreatedMarkets: number\n+    totalTradesCount: number\n+    totalMarketsCreated: number\n+    accountAgeYears: number\n+    profitableMarketsCount: number\n+    unprofitableMarketsCount: number\n+    largestProfitableTradeValue: number\n+    largestUnprofitableTradeValue: number\n+    longestBettingStreak: number\n+    modTicketsResolved: number\n+    charityDonatedMana: number\n+    largestLeagueSeasonEarnings: number\n+    ranks: RanksType\n+  } | null>(null)\n+\n+  useEffect(() => {\n+    let isMounted = true\n+    setLoading(true)\n+    setError(null)\n+    unauthedApi('get-user-achievements', { userId })\n+      .then((resp) => {\n+        if (isMounted) setData(resp)\n+      })\n+      .catch((e) => {\n+        if (isMounted) setError(e?.message ?? 'Failed to load achievements')\n+      })\n+      .finally(() => {\n+        if (isMounted) setLoading(false)\n+      })\n+    return () => {\n+      isMounted = false\n+    }\n+  }, [userId])\n+\n+  if (loading)\n+    return (\n+      <Row className=\"text-ink-600 items-center gap-2\">\n+        Loading achievements…\n+      </Row>\n+    )\n+  if (error) return <div className=\"text-error\">{error}</div>\n+  if (!data) return null\n+\n+  type Rankish =\n+    | { rank: number | null; percentile: number | null }\n+    | null\n+    | undefined\n+\n+  const _p = (r?: Rankish) => r?.percentile ?? null\n+  const _r = (r?: Rankish) => r?.rank ?? null\n+\n+  // Rank key per achievement id\n+  const rankKeyById: Record<string, keyof RanksType> = {\n+    totalVolumeMana: 'volume',\n+    totalReferrals: 'totalReferrals',\n+    totalReferredProfitMana: 'totalReferredProfit',\n+    creatorTraders: 'creatorTraders',\n+    totalLiquidityCreatedMarkets: 'liquidity',\n+    profitableMarketsCount: 'profitableMarkets',\n+    unprofitableMarketsCount: 'unprofitableMarkets',\n+    largestProfitableTradeValue: 'largestProfitableTrade',\n+    largestUnprofitableTradeValue: 'largestUnprofitableTrade',\n+    seasonsGoldOrHigher: 'seasonsGoldOrHigher',\n+    seasonsPlatinumOrHigher: 'seasonsPlatinumOrHigher',\n+    seasonsDiamondOrHigher: 'seasonsDiamondOrHigher',\n+    seasonsMasters: 'seasonsMasters',\n+    largestLeagueSeasonEarnings: 'largestLeagueSeasonEarnings',\n+    numberOfComments: 'comments',\n+    totalTradesCount: 'trades',\n+    totalMarketsCreated: 'marketsCreated',\n+    accountAgeYears: 'accountAge',\n+    longestBettingStreak: 'longestBettingStreak',\n+    modTicketsResolved: 'modTickets',\n+    charityDonatedMana: 'charityDonated',\n+  }\n+\n+  // Raw numeric values by id for zero-handling\n+  const valueById: Record<string, number> = {\n+    totalVolumeMana: data.totalVolumeMana,\n+    totalReferrals: data.totalReferrals,\n+    totalReferredProfitMana: data.totalReferredProfitMana,\n+    creatorTraders: data.creatorTraders,\n+    totalLiquidityCreatedMarkets: data.totalLiquidityCreatedMarkets,\n+    profitableMarketsCount: data.profitableMarketsCount,\n+    unprofitableMarketsCount: data.unprofitableMarketsCount,\n+    largestProfitableTradeValue: data.largestProfitableTradeValue,\n+    largestUnprofitableTradeValue: data.largestUnprofitableTradeValue,\n+    seasonsGoldOrHigher: data.seasonsGoldOrHigher,\n+    seasonsPlatinumOrHigher: data.seasonsPlatinumOrHigher,\n+    seasonsDiamondOrHigher: data.seasonsDiamondOrHigher,\n+    seasonsMasters: data.seasonsMasters,\n+    largestLeagueSeasonEarnings: data.largestLeagueSeasonEarnings,\n+    numberOfComments: data.numberOfComments,\n+    totalTradesCount: data.totalTradesCount,\n+    totalMarketsCreated: data.totalMarketsCreated,\n+    accountAgeYears: data.accountAgeYears,\n+    longestBettingStreak: data.longestBettingStreak,\n+    modTicketsResolved: data.modTicketsResolved,\n+    charityDonatedMana: data.charityDonatedMana,\n+  }\n+\n+  const defs = [\n+    {\n+      id: 'totalVolumeMana',\n+      title: 'Any Whales?',\n+      desc: 'Total trading volume.',\n+      fmt: () => formatMoney(data.totalVolumeMana, 'MANA'),\n+    },\n+    {\n+      id: 'totalReferrals',\n+      title: 'Manifold Hype Man',\n+      desc: 'Friends you brought to Manifold.',\n+      fmt: () => formatWithCommas(data.totalReferrals),\n+    },\n+    {\n+      id: 'totalReferredProfitMana',\n+      title: 'Proud Parent',\n+      desc: 'Profit earned by your referrals.',\n+      fmt: () => formatMoney(data.totalReferredProfitMana, 'MANA'),\n+    },\n+    {\n+      id: 'creatorTraders',\n+      title: 'Fan Favorite',\n+      desc: 'Unique traders on your markets.',\n+      fmt: () => formatWithCommas(data.creatorTraders),\n+    },\n+    {\n+      id: 'totalLiquidityCreatedMarkets',\n+      title: 'No Slippage Here',\n+      desc: 'Total liquidity across all your created markets.',\n+      fmt: () => formatMoney(data.totalLiquidityCreatedMarkets, 'MANA'),\n+    },\n+    {\n+      id: 'profitableMarketsCount',\n+      title: 'Market Maven',\n+      desc: 'Number of markets you made a profit on.',\n+      fmt: () => formatWithCommas(data.profitableMarketsCount),\n+    },\n+    {\n+      id: 'unprofitableMarketsCount',\n+      title: 'Ineffective Altruism',\n+      desc: 'Number of markets you lost mana on.',\n+      fmt: () => formatWithCommas(data.unprofitableMarketsCount),\n+    },\n+    {\n+      id: 'largestProfitableTradeValue',\n+      title: 'Biggest Win',\n+      desc: 'Largest profit made on a single market.',\n+      fmt: () => formatMoney(data.largestProfitableTradeValue, 'MANA'),\n+    },\n+    {\n+      id: 'largestUnprofitableTradeValue',\n+      title: 'Wealth Redistributor',\n+      desc: 'Largest loss made on a single market.',\n+      fmt: () => formatMoney(data.largestUnprofitableTradeValue, 'MANA'),\n+    },\n+    {\n+      id: 'seasonsGoldOrHigher',\n+      title: 'Gleaming Gold',\n+      desc: 'Seasons finished Gold or higher.',\n+      fmt: () => formatWithCommas(data.seasonsGoldOrHigher),\n+    },\n+    {\n+      id: 'seasonsPlatinumOrHigher',\n+      title: 'Positively Platinum',\n+      desc: 'Seasons finished Platinum or higher.',\n+      fmt: () => formatWithCommas(data.seasonsPlatinumOrHigher),\n+    },\n+    {\n+      id: 'seasonsDiamondOrHigher',\n+      title: 'Diamond Hands',\n+      desc: 'Seasons finished Diamond or higher.',\n+      fmt: () => formatWithCommas(data.seasonsDiamondOrHigher),\n+    },\n+    {\n+      id: 'seasonsMasters',\n+      title: 'Master Mind',\n+      desc: 'Seasons finished Masters.',\n+      fmt: () => formatWithCommas(data.seasonsMasters),\n+    },\n+    {\n+      id: 'largestLeagueSeasonEarnings',\n+      title: 'Sensational Season',\n+      desc: 'Largest earnings in a single season.',\n+      fmt: () => formatMoney(data.largestLeagueSeasonEarnings, 'MANA'),\n+    },\n+\n+    {\n+      id: 'numberOfComments',\n+      title: 'Chatterbox',\n+      desc: 'Number of comments you’ve posted with at least 1 like.',\n+      fmt: () => formatWithCommas(data.numberOfComments),\n+    },\n+    {\n+      id: 'totalTradesCount',\n+      title: 'High Frequency Trader',\n+      desc: 'Total number of trades executed (excludes API trades).',\n+      fmt: () => formatWithCommas(data.totalTradesCount),\n+    },\n+    {\n+      id: 'totalMarketsCreated',\n+      title: 'Doing The Hard Part',\n+      desc: 'Number of markets you’ve created.',\n+      fmt: () => formatWithCommas(data.totalMarketsCreated),\n+    },\n+    {\n+      id: 'accountAgeYears',\n+      title: 'Age Is Just A Number',\n+      desc: 'Account age in years.',\n+      fmt: () => {\n+        const yearsFloat = data.accountAgeYears\n+        const totalMonths = Math.round(yearsFloat * 12)\n+        const years = Math.floor(totalMonths / 12)\n+        const months = totalMonths % 12\n+        const yLabel = years === 1 ? 'year' : 'years'\n+        const mLabel = months === 1 ? 'month' : 'months'\n+        return `${years} ${yLabel} ${months} ${mLabel}`\n+      },\n+    },\n+    {\n+      id: 'longestBettingStreak',\n+      title: 'Longest Daily Streak',\n+      desc: 'Longest consecutive days trading.',\n+      fmt: () => formatWithCommas(data.longestBettingStreak),\n+    },\n+    {\n+      id: 'modTicketsResolved',\n+      title: 'Helpful Moderator',\n+      desc: 'Mod tickets you’ve resolved (since mod rewards were introduced).',\n+      fmt: () => formatWithCommas(data.modTicketsResolved),\n+    },\n+    {\n+      id: 'charityDonatedMana',\n+      title: 'Giver',\n+      desc: 'Total donated to charity (USD).',\n+      fmt: () => formatMoneyUSD(data.charityDonatedMana, true),\n+    },\n+  ] as const\n+\n+  const ACHS = defs.map(({ id, title, desc, fmt }) => {\n+    const key = rankKeyById[id]\n+    const raw = valueById[id] ?? 0\n+    const rk = key ? data.ranks?.[key]?.rank ?? null : null\n+    const pc = key ? data.ranks?.[key]?.percentile ?? null : null\n+    return {\n+      id,\n+      title,\n+      desc,\n+      value: fmt(),\n+      rank: raw === 0 ? null : rk,\n+      percentile: raw === 0 ? null : pc,\n+    }\n+  })\n+\n+  const bucketOf = (rank: number | null) => {\n+    if (rank == null) return 'All Users'\n+    if (rank <= 50) return 'Top 50 Users'\n+    if (rank <= 200) return 'Top 200 Users'\n+    if (rank <= 1000) return 'Top 1000 Users'\n+    if (rank <= 5000) return 'Top 5000 Users'\n+    if (rank <= 20000) return 'Top 20,000 Users'\n+    return 'All Users'\n+  }\n+\n+  const bucketOrder = [\n+    'Top 50 Users',\n+    'Top 200 Users',\n+    'Top 1000 Users',\n+    'Top 5000 Users',\n+    'Top 20,000 Users',\n+    'All Users',\n+  ] as const\n+  const byBucket: Record<\n+    (typeof bucketOrder)[number],\n+    (typeof ACHS)[number][]\n+  > = {\n+    'Top 50 Users': [],\n+    'Top 200 Users': [],\n+    'Top 1000 Users': [],\n+    'Top 5000 Users': [],\n+    'Top 20,000 Users': [],\n+    'All Users': [],\n+  }\n+\n+  ACHS.forEach((a) => {\n+    byBucket[bucketOf(a.rank)].push(a as any)\n+  })\n+\n+  return (\n+    <Col className=\"gap-6\">\n+      {bucketOrder.map((bucket) => {\n+        const items = byBucket[bucket]\n+        if (!items.length) return null\n+        const sorted = items.slice().sort((a, b) => {\n+          const ra = a.rank ?? Infinity\n+          const rb = b.rank ?? Infinity\n+          if (ra !== rb) return ra - rb\n+          const pa = a.percentile ?? Infinity\n+          const pb = b.percentile ?? Infinity\n+          return pa - pb\n+        })\n+        return (\n+          <Col key={bucket} className=\"gap-3\">\n+            <div className=\"text-ink-800 flex items-center gap-2 text-sm font-semibold uppercase tracking-wider\">\n+              {bucket}\n+              <span className=\"bg-ink-200 h-px flex-1\" />\n+            </div>\n+\n+            <div className=\"grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3\">\n+              {sorted.map((a) => (\n+                <AchievementBadgeCard\n+                  key={a.id}\n+                  title={a.title}\n+                  description={a.desc}\n+                  value={a.value}\n+                  rank={a.rank}\n+                  percentile={a.percentile}\n+                  imageSrc={(() => {\n+                    const IMAGE_BY_ID: Record<string, string> = {\n+                      accountAgeYears:\n+                        '/achievement-badges/accountAgeYears.png',\n+                      charityDonatedMana:\n+                        '/achievement-badges/charityDonatedMana.png',\n+                      creatorTraders: '/achievement-badges/creatorTraders.png',\n+                      largestProfitableTradeValue:\n+                        '/achievement-badges/largestProfitableTradeValue.png',\n+                      largestLeagueSeasonEarnings:\n+                        '/achievement-badges/largestLeagueSeasonEarnings.png',\n+                      largestUnprofitableTradeValue:\n+                        '/achievement-badges/largestUnprofitableTradeValue.png',\n+                      longestBettingStreak:\n+                        '/achievement-badges/longestBettingStreak.png',\n+                      modTicketsResolved:\n+                        '/achievement-badges/modTicketsResolved.png',\n+                      numberOfComments:\n+                        '/achievement-badges/numberOfComments.png',\n+                      profitableMarketsCount:\n+                        '/achievement-badges/profitableMarketsCount.png',\n+                      seasonsDiamondOrHigher:\n+                        '/achievement-badges/seasonsDiamondOrHigher.png',\n+                      seasonsGoldOrHigher:\n+                        '/achievement-badges/seasonsGoldOrHigher.png',\n+                      seasonsMasters: '/achievement-badges/seasonsMasters.png',\n+                      seasonsPlatinumOrHigher:\n+                        '/achievement-badges/seasonsPlatinumOrHigher.png',\n+                      totalLiquidityCreatedMarkets:\n+                        '/achievement-badges/totalLiquidityCreatedMarkets.png',\n+                      totalMarketsCreated:\n+                        '/achievement-badges/totalMarketsCreated.png',\n+                      totalReferrals: '/achievement-badges/totalReferrals.png',\n+                      totalReferredProfitMana:\n+                        '/achievement-badges/totalReferredProfitMana.png',\n+                      totalTradesCount:\n+                        '/achievement-badges/totalTradesCount.png',\n+                      totalVolumeMana:\n+                        '/achievement-badges/totalVolumeMana.png',\n+                      unprofitableMarketsCount:\n+                        '/achievement-badges/unprofitableMarketsCount.png',\n+                    }\n+                    return (\n+                      IMAGE_BY_ID[a.id] ||\n+                      '/achievement-badges/totalVolumeMana.png'\n+                    )\n+                  })()}\n+                  bucket={bucket}\n+                />\n+              ))}\n+            </div>\n+          </Col>\n+        )\n+      })}\n+    </Col>\n+  )\n+}\n+\n+function AchievementBadgeCard(props: {\n+  title: string\n+  description: string\n+  value: string\n+  rank: number | null\n+  percentile: number | null\n+  bucket:\n+    | 'Top 50 Users'\n+    | 'Top 200 Users'\n+    | 'Top 1000 Users'\n+    | 'Top 5000 Users'\n+    | 'Top 20,000 Users'\n+    | 'All Users'\n+  imageSrc?: string\n+}) {\n+  const { title, description, value, rank, percentile, bucket, imageSrc } =\n+    props\n+\n+  const bucketStyle: Record<typeof props.bucket, string> = {\n+    'Top 50 Users': 'from-fuchsia-500 to-indigo-500',\n+    'Top 200 Users': 'from-indigo-500 to-sky-500',\n+    'Top 1000 Users': 'from-sky-500 to-teal-500',\n+    'Top 5000 Users': 'from-emerald-500 to-lime-500',\n+    'Top 20,000 Users': 'from-slate-500 to-zinc-500',\n+    'All Users': 'from-zinc-400 to-zinc-600',\n+  }\n+\n+  return (\n+    <div\n+      className=\"border-ink-200 group relative rounded-xl border p-[1px] transition-shadow hover:shadow-lg\"\n+      aria-label={title}\n+    >\n+      {/* gradient ring */}\n+      <div\n+        className={clsx(\n+          'h-full rounded-xl bg-gradient-to-br',\n+          bucketStyle[bucket]\n+        )}\n+      >\n+        <div className=\"bg-canvas-0 flex h-full flex-col items-center space-y-3 rounded-[11px] px-4 pb-6 pt-6\">\n+          <div className=\" ring-ink-300/50 flex h-32 w-32 items-center justify-center overflow-hidden rounded-full ring-1\">\n+            {imageSrc ? (\n+              <Image\n+                src={imageSrc}\n+                alt={title}\n+                width={128}\n+                height={128}\n+                className=\"h-32 w-32 scale-125 rounded-full object-contain\"\n+              />\n+            ) : null}\n+          </div>\n+          <div className=\"pt-4 text-center\">\n+            <div className=\"text-ink-900  text-lg font-semibold\">{title}</div>\n+            <div className=\"text-ink-600 mt-1 text-sm leading-snug\">\n+              {description}\n+            </div>\n+            <div className=\"text-ink-900 mt-3 text-lg\">{value}</div>\n+          </div>\n+\n+          {/* side hover tooltip */}\n+          <div className=\"pointer-events-none absolute left-full top-4 z-20 hidden pl-3 group-hover:block\">\n+            <div className=\"bg-canvas-50 text-ink-900 border-ink-200 w-64 rounded-md border p-3 shadow-xl\">\n+              <div className=\"mt-1 text-lg font-semibold\">\n+                Rank: {rank ?? 'N/A'}\n+              </div>\n+              <div className=\"text-ink-600 my-1 text-sm\">\n+                {percentile != null\n+                  ? `In the top ${(() => {\n+                      const s = Number(\n+                        Math.max(percentile, 0.01).toFixed(2)\n+                      ).toString()\n+                      return s\n+                    })()}% of all users`\n+                  : 'N/A'}\n+              </div>\n+              <div className=\"text-ink-600 text-sm\">Value: {value}</div>\n+            </div>\n+          </div>\n+        </div>\n+      </div>\n+    </div>\n+  )\n+}\n+\n function FollowsDialog(props: {\n   user: User\n   followingIds: string[] | undefined\n   followerIds: string[] | undefined\n"
        },
        {
          "path": "web/public/achievement-badges/accountAgeYears.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/accountAgeYears.png\n===================================================================\n--- web/public/achievement-badges/accountAgeYears.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/accountAgeYears.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/charityDonatedMana.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/charityDonatedMana.png\n===================================================================\n--- web/public/achievement-badges/charityDonatedMana.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/charityDonatedMana.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/creatorTraders.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/creatorTraders.png\n===================================================================\n--- web/public/achievement-badges/creatorTraders.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/creatorTraders.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/highestBalanceMana.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/highestBalanceMana.png\n===================================================================\n--- web/public/achievement-badges/highestBalanceMana.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/highestBalanceMana.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/highestInvestedMana.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/highestInvestedMana.png\n===================================================================\n--- web/public/achievement-badges/highestInvestedMana.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/highestInvestedMana.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/highestLoanMana.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/highestLoanMana.png\n===================================================================\n--- web/public/achievement-badges/highestLoanMana.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/highestLoanMana.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/highestNetworthMana.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/highestNetworthMana.png\n===================================================================\n--- web/public/achievement-badges/highestNetworthMana.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/highestNetworthMana.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/largestLeagueSeasonEarnings.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/largestLeagueSeasonEarnings.png\n===================================================================\n--- web/public/achievement-badges/largestLeagueSeasonEarnings.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/largestLeagueSeasonEarnings.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/largestProfitableTradeValue.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/largestProfitableTradeValue.png\n===================================================================\n--- web/public/achievement-badges/largestProfitableTradeValue.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/largestProfitableTradeValue.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/largestUnprofitableTradeValue.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/largestUnprofitableTradeValue.png\n===================================================================\n--- web/public/achievement-badges/largestUnprofitableTradeValue.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/largestUnprofitableTradeValue.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/longestBettingStreak.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/longestBettingStreak.png\n===================================================================\n--- web/public/achievement-badges/longestBettingStreak.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/longestBettingStreak.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/modTicketsResolved.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/modTicketsResolved.png\n===================================================================\n--- web/public/achievement-badges/modTicketsResolved.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/modTicketsResolved.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/numberOfComments.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/numberOfComments.png\n===================================================================\n--- web/public/achievement-badges/numberOfComments.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/numberOfComments.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/profitableMarketsCount.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/profitableMarketsCount.png\n===================================================================\n--- web/public/achievement-badges/profitableMarketsCount.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/profitableMarketsCount.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/seasonsDiamondOrHigher.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/seasonsDiamondOrHigher.png\n===================================================================\n--- web/public/achievement-badges/seasonsDiamondOrHigher.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/seasonsDiamondOrHigher.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/seasonsGoldOrHigher.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/seasonsGoldOrHigher.png\n===================================================================\n--- web/public/achievement-badges/seasonsGoldOrHigher.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/seasonsGoldOrHigher.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/seasonsMasters.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/seasonsMasters.png\n===================================================================\n--- web/public/achievement-badges/seasonsMasters.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/seasonsMasters.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/seasonsPlatinumOrHigher.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/seasonsPlatinumOrHigher.png\n===================================================================\n--- web/public/achievement-badges/seasonsPlatinumOrHigher.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/seasonsPlatinumOrHigher.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/totalLiquidityCreatedMarkets.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/totalLiquidityCreatedMarkets.png\n===================================================================\n--- web/public/achievement-badges/totalLiquidityCreatedMarkets.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/totalLiquidityCreatedMarkets.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/totalMarketsCreated.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/totalMarketsCreated.png\n===================================================================\n--- web/public/achievement-badges/totalMarketsCreated.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/totalMarketsCreated.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/totalProfitMana.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/totalProfitMana.png\n===================================================================\n--- web/public/achievement-badges/totalProfitMana.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/totalProfitMana.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/totalReferrals.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/totalReferrals.png\n===================================================================\n--- web/public/achievement-badges/totalReferrals.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/totalReferrals.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/totalReferredProfitMana.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/totalReferredProfitMana.png\n===================================================================\n--- web/public/achievement-badges/totalReferredProfitMana.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/totalReferredProfitMana.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/totalTradesCount.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/totalTradesCount.png\n===================================================================\n--- web/public/achievement-badges/totalTradesCount.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/totalTradesCount.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/totalVolumeMana.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/totalVolumeMana.png\n===================================================================\n--- web/public/achievement-badges/totalVolumeMana.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/totalVolumeMana.png\t60532e5 (commit)\n"
        },
        {
          "path": "web/public/achievement-badges/unprofitableMarketsCount.png",
          "status": "added",
          "diff": "Index: web/public/achievement-badges/unprofitableMarketsCount.png\n===================================================================\n--- web/public/achievement-badges/unprofitableMarketsCount.png\t538b6b6 (parent)\n+++ web/public/achievement-badges/unprofitableMarketsCount.png\t60532e5 (commit)\n"
        }
      ]
    },
    {
      "id": "add-mcp-endpoint",
      "sha": "3eac52d4c811dceb380a42d555bf86b58ccf7915",
      "parentSha": "75c29e8308b4f47ca46d03c21a6b9307ce6cd5f5",
      "spec": "Implement an MCP-compatible HTTP endpoint to expose search and data retrieval tools backed by existing API handlers and schemas, and extend search/lite market behavior as follows:\n\n1) Add MCP server and route\n- Dependency: Add @modelcontextprotocol/sdk to backend/api/package.json dependencies.\n- New file: backend/api/src/mcp.ts that:\n  - Creates a new Server from @modelcontextprotocol/sdk/server with capabilities.tools set.\n  - Implements a ListTools handler exposing four tools with JSON schemas:\n    - search-markets: Accepts the same fields as searchProps (common/src/api/market-search-types.ts) but requires term; supports contractType, filter, limit, offset, creatorId, sort. Use the same enum values as the API.\n    - get-market: { id: string }.\n    - get-user: { username: string }.\n    - get-bets: Accepts the same fields as API.bets.props.\n  - Implements CallTool handler that:\n    - Increments a counter metrics.inc('mcp/request_count', { name }) for each tool invocation.\n    - Validates arguments against existing Zod schemas from common/src/api/schema.ts:\n      - API['search-markets'].props for search-markets\n      - API['market/:id'].props for get-market\n      - API['user/:username'].props for get-user\n      - API.bets.props for get-bets\n    - Calls the corresponding backend handlers:\n      - search-markets: backend/api/src/search-contracts.searchMarketsLite with props mapped to include sensible defaults (token='MANA', forYou='0', isPrizeMarket='0') and includeLiteAnswers=true.\n      - get-market: backend/api/src/get-market.getMarket({ id })\n      - get-user: backend/api/src/get-user.getUser({ username })\n      - get-bets: backend/api/src/get-bets.getBets(props)\n    - Returns the tool result as JSON-serialized text content in the MCP response.\n    - Converts Zod errors to McpError with ErrorCode.InvalidParams and internal errors to McpError with ErrorCode.InternalError.\n  - Exports handleMcpRequest(req, res) that:\n    - Creates a StreamableHTTPServerTransport, connects the server, forwards the request body, and closes transport/server on response close.\n    - Logs and returns a JSON-RPC error with HTTP 500 if an error occurs and headers are not yet sent.\n- Route: In backend/api/src/app.ts, import handleMcpRequest from './mcp' and register:\n  - app.post('/v0/mcp', express.json(), allowCorsUnrestricted, handleMcpRequest)\n\n2) Add MCP metric\n- In backend/shared/src/monitoring/metrics.ts, add a new CUSTOM_METRICS entry:\n  - 'mcp/request_count': { metricKind: 'CUMULATIVE', valueKind: 'int64Value' }\n\n3) Extend search API schema and behavior\n- In common/src/api/market-search-types.ts:\n  - Import coerceBoolean from './zod-types'.\n  - Change sort default to 'score' (from 'most-popular').\n  - Change token default to 'MANA' (from 'ALL').\n  - Add includeLiteAnswers?: coerceBoolean.optional().\n- In backend/api/src/search-contracts.ts:\n  - Accept includeLiteAnswers from props in searchMarketsLite and pass it to toLiteMarket(contract, includeLiteAnswers) when mapping.\n  - Ensure the multi-query typed map returns items typed as { data: Contract; searchType: SearchTypes }[] for type safety.\n  - After constructing the combined results, perform uniqBy(..., 'id'), slice(0, limit), then orderBy using sortFields[sort].sortCallback with direction from sortFields[sort].order.\n\n4) Extend LiteMarket serialization\n- In common/src/api/market-types.ts:\n  - Update toLiteMarket signature to toLiteMarket(contract: Contract, includeLiteAnswers?: boolean).\n  - When includeLiteAnswers is true and contract.mechanism === 'cpmm-multi-1', include answers: an array of { id, text, probability } for each contract answer (compute probability via getAnswerProbability). Keep the existing LiteMarket shape otherwise.\n\n5) Integration and validation\n- Ensure the new MCP route uses express.json() and allowCorsUnrestricted.\n- Ensure TypeScript builds without errors and no regressions on existing endpoints.\n\nAcceptance criteria\n- POST /v0/mcp accepts valid MCP JSON-RPC requests for search-markets, get-market, get-user, get-bets, validates input per API schemas, executes handlers, and returns the results as JSON in MCP format.\n- Each MCP tool invocation increments the 'mcp/request_count' metric with { name: <tool> }.\n- /v0/search-markets (regular API) supports includeLiteAnswers; when true for cpmm-multi-1 markets, LiteMarket responses include minimal answers.\n- Search defaults for sort and token are updated (sort='score', token='MANA').\n- Updated search ordering logic returns results consistently sorted per sortFields, post-uniquing, within the specified limit.",
      "prompt": "Expose a new MCP HTTP endpoint that lets AI tools search markets and fetch market, user, and bet data using the existing API logic. The endpoint should handle MCP JSON-RPC POST requests, list four tools (search-markets, get-market, get-user, get-bets), validate inputs against the existing API schemas, call the appropriate handlers, return JSON content, and record per-tool request metrics. Also update the market search API to optionally include minimal answers in lite market responses when requested and adjust default search parameters to reflect current behavior. Ensure the new route supports JSON parsing and CORS.",
      "supplementalFiles": [
        "backend/api/src/get-bets.ts",
        "backend/api/src/get-market.ts",
        "backend/api/src/get-user.ts",
        "backend/api/src/helpers/endpoint.ts",
        "backend/api/src/routes.ts",
        "common/src/api/schema.ts",
        "common/src/supabase/bets.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/package.json",
          "status": "modified",
          "diff": "Index: backend/api/package.json\n===================================================================\n--- backend/api/package.json\t75c29e8 (parent)\n+++ backend/api/package.json\t3eac52d (commit)\n@@ -30,8 +30,9 @@\n     \"@google-cloud/monitoring\": \"4.0.0\",\n     \"@google-cloud/secret-manager\": \"4.2.1\",\n     \"@google/generative-ai\": \"0.22.0\",\n     \"@mendable/firecrawl-js\": \"1.8.5\",\n+    \"@modelcontextprotocol/sdk\": \"1.17.1\",\n     \"@supabase/supabase-js\": \"2.38.5\",\n     \"@tiptap/core\": \"2.0.0-beta.204\",\n     \"@tiptap/extension-image\": \"2.0.0-beta.204\",\n     \"@tiptap/extension-link\": \"2.0.0-beta.204\",\n"
        },
        {
          "path": "backend/api/src/app.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/app.ts\n===================================================================\n--- backend/api/src/app.ts\t75c29e8 (parent)\n+++ backend/api/src/app.ts\t3eac52d (commit)\n@@ -1,18 +1,19 @@\n-import { hrtime } from 'node:process'\n+import { API, type APIPath } from 'common/api/schema'\n+import { APIError, pathWithPrefix } from 'common/api/utils'\n+import { randomString } from 'common/util/random'\n+import { assertUnreachable } from 'common/util/types'\n+import * as compression from 'compression'\n import * as cors from 'cors'\n import * as express from 'express'\n import { ErrorRequestHandler, RequestHandler } from 'express'\n-import { log, metrics } from 'shared/utils'\n-import * as compression from 'compression'\n+import { hrtime } from 'node:process'\n import { withMonitoringContext } from 'shared/monitoring/context'\n-import { APIError, pathWithPrefix } from 'common/api/utils'\n-import { API, type APIPath } from 'common/api/schema'\n-import { assertUnreachable } from 'common/util/types'\n+import { log, metrics } from 'shared/utils'\n import { typedEndpoint } from './helpers/endpoint'\n-import { randomString } from 'common/util/random'\n-import { handlers } from './routes'\n+import { handleMcpRequest } from './mcp'\n import { addOldRoutes } from './old-routes'\n+import { handlers } from './routes'\n \n export const allowCorsUnrestricted: RequestHandler = cors({\n   origin: '*',\n   maxAge: 86400, // 24 hours\n@@ -127,5 +128,9 @@\n   } else {\n     assertUnreachable(api, 'Unsupported API method')\n   }\n })\n+\n+// Add MCP POST endpoint\n+app.post('/v0/mcp', express.json(), allowCorsUnrestricted, handleMcpRequest)\n+\n addOldRoutes(app)\n"
        },
        {
          "path": "backend/api/src/mcp.ts",
          "status": "added",
          "diff": "Index: backend/api/src/mcp.ts\n===================================================================\n--- backend/api/src/mcp.ts\t75c29e8 (parent)\n+++ backend/api/src/mcp.ts\t3eac52d (commit)\n@@ -0,0 +1,345 @@\n+#!/usr/bin/env node\n+import { Server } from '@modelcontextprotocol/sdk/server/index.js'\n+import { StreamableHTTPServerTransport } from '@modelcontextprotocol/sdk/server/streamableHTTP.js'\n+import {\n+  CallToolRequestSchema,\n+  ErrorCode,\n+  ListToolsRequestSchema,\n+  McpError,\n+} from '@modelcontextprotocol/sdk/types.js'\n+import { API } from 'common/api/schema'\n+import { NON_POINTS_BETS_LIMIT } from 'common/supabase/bets'\n+import { Request, Response } from 'express'\n+import { log, metrics } from 'shared/utils'\n+import { z } from 'zod'\n+import { getBets } from './get-bets'\n+import { getMarket } from './get-market'\n+import { getUser } from './get-user'\n+import { searchMarketsLite } from './search-contracts'\n+\n+function getServer(): Server {\n+  const server = new Server(\n+    {\n+      name: 'manifold-markets',\n+      version: '0.2.0',\n+    },\n+    {\n+      capabilities: {\n+        tools: {},\n+      },\n+    }\n+  )\n+\n+  // List available tools\n+  server.setRequestHandler(ListToolsRequestSchema, async () => ({\n+    tools: [\n+      {\n+        name: 'search-markets',\n+        description: 'Search for prediction markets with optional filters',\n+        inputSchema: {\n+          type: 'object',\n+          properties: {\n+            term: { type: 'string', description: 'Search query' },\n+            contractType: {\n+              type: 'string',\n+              enum: [\n+                'ALL',\n+                'BINARY',\n+                'MULTIPLE_CHOICE',\n+                'POLL',\n+                'MULTI_NUMERIC',\n+                'DATE',\n+              ],\n+              description: 'Question type (default: ALL)',\n+            },\n+            filter: {\n+              type: 'string',\n+              enum: ['open', 'resolved', 'all'],\n+              description:\n+                'Filter by question state. Resolved means the event has happened. (default: all)',\n+            },\n+            limit: {\n+              type: 'number',\n+              minimum: 1,\n+              maximum: 1000,\n+              description: 'Max number of results (default: 100)',\n+            },\n+            offset: {\n+              type: 'number',\n+              description: 'Offset for pagination (default: 0)',\n+            },\n+            creatorId: {\n+              type: 'string',\n+              description: 'Optional. Creator (user) ID to filter by',\n+            },\n+            sort: {\n+              type: 'string',\n+              enum: ['newest', 'score', 'liquidity'],\n+              description: 'Sort order (default: score)',\n+            },\n+          },\n+          required: ['term'],\n+        },\n+      },\n+      {\n+        name: 'get-market',\n+        description: 'Get detailed information about a specific market',\n+        inputSchema: {\n+          type: 'object',\n+          properties: {\n+            id: { type: 'string', description: 'Market ID' },\n+          },\n+          required: ['id'],\n+        },\n+      },\n+      {\n+        name: 'get-user',\n+        description: 'Get user information by username',\n+        inputSchema: {\n+          type: 'object',\n+          properties: {\n+            username: { type: 'string', description: 'Username' },\n+          },\n+          required: ['username'],\n+        },\n+      },\n+      {\n+        name: 'get-bets',\n+        description:\n+          'Get bets from markets or for users with various filtering options',\n+        inputSchema: {\n+          type: 'object',\n+          properties: {\n+            id: {\n+              type: 'string',\n+              description: 'Optional. Bet ID to filter by',\n+            },\n+            userId: {\n+              type: 'string',\n+              description: 'Optional. User ID to filter by',\n+            },\n+            username: {\n+              type: 'string',\n+              description: 'Optional. Username to filter by',\n+            },\n+            contractId: {\n+              oneOf: [\n+                { type: 'string' },\n+                { type: 'array', items: { type: 'string' } },\n+              ],\n+              description: 'Optional. Contract ID(s) to filter by',\n+            },\n+            contractSlug: {\n+              type: 'string',\n+              description: 'Optional. Contract slug to filter by',\n+            },\n+            answerId: {\n+              type: 'string',\n+              description: 'Optional. Answer ID to filter by',\n+            },\n+            limit: {\n+              type: 'number',\n+              minimum: 0,\n+              maximum: NON_POINTS_BETS_LIMIT,\n+              description: 'Optional. Number of bets to return (default: 1000)',\n+            },\n+            before: {\n+              type: 'string',\n+              description: 'Optional. Get bets before this bet ID',\n+            },\n+            after: {\n+              type: 'string',\n+              description: 'Optional. Get bets after this bet ID',\n+            },\n+            beforeTime: {\n+              type: 'number',\n+              description: 'Optional. Get bets before this timestamp',\n+            },\n+            afterTime: {\n+              type: 'number',\n+              description: 'Optional. Get bets after this timestamp',\n+            },\n+            order: {\n+              type: 'string',\n+              enum: ['asc', 'desc'],\n+              description: 'Optional. Sort order by creation time',\n+            },\n+            kinds: {\n+              type: 'string',\n+              enum: ['open-limit'],\n+              description: 'Optional. Filter by bet kind',\n+            },\n+            minAmount: {\n+              type: 'number',\n+              minimum: 0,\n+              description: 'Optional. Minimum bet amount',\n+            },\n+            filterRedemptions: {\n+              type: 'boolean',\n+              description: 'Optional. Filter redemptions',\n+            },\n+          },\n+          required: [],\n+        },\n+      },\n+    ],\n+  }))\n+\n+  // Handle tool execution\n+  server.setRequestHandler(CallToolRequestSchema, async (request) => {\n+    const { name, arguments: args } = request.params\n+    metrics.inc('mcp/request_count', { name })\n+    try {\n+      switch (name) {\n+        case 'search-markets': {\n+          const params = API['search-markets'].props.parse(args)\n+\n+          // Map the params to match the search-markets API schema\n+          const searchParams = {\n+            term: params.term,\n+            limit: params.limit,\n+            filter: params.filter,\n+            sort: params.sort,\n+            contractType: params.contractType,\n+            offset: params.offset,\n+            token: 'MANA' as const,\n+            forYou: '0' as const,\n+            isPrizeMarket: '0' as const,\n+            includeLiteAnswers: true,\n+          }\n+\n+          try {\n+            const markets = await searchMarketsLite(\n+              searchParams,\n+              undefined, // auth not required for this endpoint\n+              {} as Request // minimal request object since it's not used\n+            )\n+            return {\n+              content: [\n+                {\n+                  type: 'text',\n+                  text: JSON.stringify(markets, null, 2),\n+                },\n+              ],\n+            }\n+          } catch (error: any) {\n+            throw new McpError(\n+              ErrorCode.InternalError,\n+              `Search markets error: ${error.message}`\n+            )\n+          }\n+        }\n+\n+        case 'get-market': {\n+          const { id } = API['market/:id'].props.parse(args)\n+\n+          try {\n+            const market = await getMarket({ id })\n+            return {\n+              content: [\n+                {\n+                  type: 'text',\n+                  text: JSON.stringify(market, null, 2),\n+                },\n+              ],\n+            }\n+          } catch (error: any) {\n+            throw new McpError(\n+              ErrorCode.InternalError,\n+              `Get market error: ${error.message}`\n+            )\n+          }\n+        }\n+\n+        case 'get-user': {\n+          const { username } = API['user/:username'].props.parse(args)\n+\n+          try {\n+            const user = await getUser({ username })\n+            return {\n+              content: [\n+                {\n+                  type: 'text',\n+                  text: JSON.stringify(user, null, 2),\n+                },\n+              ],\n+            }\n+          } catch (error: any) {\n+            throw new McpError(\n+              ErrorCode.InternalError,\n+              `Get user error: ${error.message}`\n+            )\n+          }\n+        }\n+\n+        case 'get-bets': {\n+          const params = API.bets.props.parse(args)\n+\n+          try {\n+            const bets = await getBets(\n+              params,\n+              undefined, // auth not required for this endpoint\n+              {} as Request // minimal request object since it's not used\n+            )\n+            return {\n+              content: [\n+                {\n+                  type: 'text',\n+                  text: JSON.stringify(bets, null, 2),\n+                },\n+              ],\n+            }\n+          } catch (error: any) {\n+            throw new McpError(\n+              ErrorCode.InternalError,\n+              `Get bets error: ${error.message}`\n+            )\n+          }\n+        }\n+\n+        default:\n+          throw new McpError(ErrorCode.MethodNotFound, `Unknown tool: ${name}`)\n+      }\n+    } catch (error) {\n+      if (error instanceof z.ZodError) {\n+        throw new McpError(\n+          ErrorCode.InvalidParams,\n+          `Invalid parameters: ${error.errors\n+            .map((e) => `${e.path.join('.')}: ${e.message}`)\n+            .join(', ')}`\n+        )\n+      }\n+      throw error\n+    }\n+  })\n+\n+  return server\n+}\n+\n+export const handleMcpRequest = async (req: Request, res: Response) => {\n+  try {\n+    const server = getServer()\n+    const transport: StreamableHTTPServerTransport =\n+      new StreamableHTTPServerTransport({\n+        sessionIdGenerator: undefined,\n+      })\n+    res.on('close', () => {\n+      transport.close()\n+      server.close()\n+    })\n+    await server.connect(transport)\n+    await transport.handleRequest(req, res, req.body)\n+  } catch (error) {\n+    log.error('Error handling MCP request:', { error })\n+    if (!res.headersSent) {\n+      res.status(500).json({\n+        jsonrpc: '2.0',\n+        error: {\n+          code: -32603,\n+          message: 'Internal server error',\n+        },\n+        id: null,\n+      })\n+    }\n+  }\n+}\n"
        },
        {
          "path": "backend/api/src/search-contracts.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/search-contracts.ts\n===================================================================\n--- backend/api/src/search-contracts.ts\t75c29e8 (parent)\n+++ backend/api/src/search-contracts.ts\t3eac52d (commit)\n@@ -1,30 +1,32 @@\n-import { z } from 'zod'\n+import { searchProps } from 'common/api/market-search-types'\n+import { toLiteMarket } from 'common/api/market-types'\n+import { Contract } from 'common/contract'\n+import { convertContract } from 'common/supabase/contracts'\n+import { orderBy, uniqBy } from 'lodash'\n+import { getGroupIdFromSlug } from 'shared/supabase/groups'\n import {\n   createSupabaseDirectClient,\n   SupabaseDirectClient,\n } from 'shared/supabase/init'\n-import { type APIHandler } from './helpers/endpoint'\n import {\n-  getSearchContractSQL,\n-  getForYouSQL,\n-  sortFields,\n   basicSearchSQL,\n+  getForYouSQL,\n+  getSearchContractSQL,\n   SearchTypes,\n+  sortFields,\n } from 'shared/supabase/search-contracts'\n-import { getGroupIdFromSlug } from 'shared/supabase/groups'\n-import { orderBy, uniqBy } from 'lodash'\n-import { convertContract } from 'common/supabase/contracts'\n import { log } from 'shared/utils'\n-import { toLiteMarket } from 'common/api/market-types'\n-import { searchProps } from 'common/api/market-search-types'\n+import { z } from 'zod'\n+import { type APIHandler } from './helpers/endpoint'\n \n export const searchMarketsLite: APIHandler<'search-markets'> = async (\n   props,\n   auth\n ) => {\n+  const { includeLiteAnswers } = props\n   const contracts = await search(props, auth?.uid)\n-  return contracts.map(toLiteMarket)\n+  return contracts.map((c) => toLiteMarket(c, includeLiteAnswers))\n }\n \n export const searchMarketsFull: APIHandler<'search-markets-full'> = async (\n   props,\n@@ -146,13 +148,14 @@\n       contractsWithoutStopwords,\n       contractsWithMatchingAnswers,\n       contractsWithStopwords,\n       contractDescriptionMatches,\n-    ] = results.map((result, i) =>\n-      result.map((r: any) => ({\n-        data: convertContract(r),\n-        searchType: searchTypes[i],\n-      }))\n+    ] = results.map(\n+      (result, i) =>\n+        result.map((r: any) => ({\n+          data: convertContract(r),\n+          searchType: searchTypes[i],\n+        })) as { data: Contract; searchType: SearchTypes }[]\n     )\n \n     const contractsOfSimilarRelevance = orderBy(\n       [\n@@ -165,16 +168,20 @@\n         (c.searchType === 'answer' ? 0.5 : 1),\n       sortFields[sort].order.includes('DESC') ? 'desc' : 'asc'\n     )\n \n-    return uniqBy(\n-      [\n-        ...contractsWithStopwords,\n-        ...contractsOfSimilarRelevance,\n-        ...contractDescriptionMatches,\n-      ].map((c) => c.data),\n-      'id'\n-    ).slice(0, limit)\n+    return orderBy(\n+      uniqBy(\n+        [\n+          ...contractsWithStopwords, // most obviously relevant\n+          ...contractsOfSimilarRelevance, // next most relevant\n+          ...contractDescriptionMatches, // least obviously relevant\n+        ].map((c) => c.data),\n+        'id'\n+      ).slice(0, limit),\n+      (c) => sortFields[sort].sortCallback(c),\n+      sortFields[sort].order.includes('DESC') ? 'desc' : 'asc'\n+    )\n   }\n }\n \n const getAllSubTopicsForParentTopicIds = async (\n"
        },
        {
          "path": "backend/shared/src/monitoring/metrics.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/monitoring/metrics.ts\n===================================================================\n--- backend/shared/src/monitoring/metrics.ts\t75c29e8 (parent)\n+++ backend/shared/src/monitoring/metrics.ts\t3eac52d (commit)\n@@ -1,5 +1,5 @@\n-import { isEqual, flatten } from 'lodash'\n+import { flatten, isEqual } from 'lodash'\n \n // see https://cloud.google.com/monitoring/api/ref_v3/rest/v3/projects.metricDescriptors#MetricKind\n export type MetricKind = 'GAUGE' | 'CUMULATIVE'\n \n@@ -90,8 +90,12 @@\n   'vercel/revalidations_failed': {\n     metricKind: 'CUMULATIVE',\n     valueKind: 'int64Value',\n   },\n+  'mcp/request_count': {\n+    metricKind: 'CUMULATIVE',\n+    valueKind: 'int64Value',\n+  },\n } as const satisfies { [k: string]: MetricDescriptor }\n \n // the typing for all this could be way fancier, but seems overkill\n \n"
        },
        {
          "path": "common/src/api/market-search-types.ts",
          "status": "modified",
          "diff": "Index: common/src/api/market-search-types.ts\n===================================================================\n--- common/src/api/market-search-types.ts\t75c29e8 (parent)\n+++ common/src/api/market-search-types.ts\t3eac52d (commit)\n@@ -1,5 +1,6 @@\n import { z } from 'zod'\n+import { coerceBoolean } from './zod-types'\n \n export const FIRESTORE_DOC_REF_ID_REGEX = /^[a-zA-Z0-9_-]{1,}$/\n \n export const searchProps = z\n@@ -36,9 +37,9 @@\n         z.literal('bounty-amount'),\n         z.literal('prob-descending'),\n         z.literal('prob-ascending'),\n       ])\n-      .default('most-popular'),\n+      .default('score'),\n     contractType: z\n       .union([\n         z.literal('ALL'),\n         z.literal('BINARY'),\n@@ -77,10 +78,11 @@\n         z.literal('CASH'),\n         z.literal('ALL'),\n         z.literal('CASH_AND_MANA'),\n       ])\n-      .default('ALL'),\n+      .default('MANA'),\n     gids: z.string().optional(),\n     liquidity: z.coerce.number().optional(),\n     hasBets: z.union([z.literal('1'), z.literal('0')]).optional(),\n+    includeLiteAnswers: coerceBoolean.optional(),\n   })\n   .strict()\n"
        },
        {
          "path": "common/src/api/market-types.ts",
          "status": "modified",
          "diff": "Index: common/src/api/market-types.ts\n===================================================================\n--- common/src/api/market-types.ts\t75c29e8 (parent)\n+++ common/src/api/market-types.ts\t3eac52d (commit)\n@@ -10,16 +10,16 @@\n } from 'common/contract'\n import { MINIMUM_BOUNTY } from 'common/economy'\n import { DOMAIN } from 'common/envs/constants'\n import { MAX_ID_LENGTH } from 'common/group'\n+import { MAX_MULTI_NUMERIC_ANSWERS } from 'common/multi-numeric'\n import { getMappedValue } from 'common/pseudo-numeric'\n+import { liquidityTiers } from 'common/tier'\n import { removeUndefinedProps } from 'common/util/object'\n import { richTextToString } from 'common/util/parse'\n+import { randomStringRegex } from 'common/util/random'\n import { z } from 'zod'\n import { coerceBoolean, contentSchema } from './zod-types'\n-import { randomStringRegex } from 'common/util/random'\n-import { MAX_MULTI_NUMERIC_ANSWERS } from 'common/multi-numeric'\n-import { liquidityTiers } from 'common/tier'\n \n export type LiteMarket = {\n   // Unique identifier for this market\n   id: string\n@@ -91,9 +91,12 @@\n   coverImageUrl?: string\n   groupSlugs?: string[]\n }\n \n-export function toLiteMarket(contract: Contract): LiteMarket {\n+export function toLiteMarket(\n+  contract: Contract,\n+  includeLiteAnswers?: boolean\n+): LiteMarket {\n   const {\n     id,\n     creatorId,\n     creatorUsername,\n@@ -136,8 +139,16 @@\n     const value = getMappedValue(contract, contract.prob)\n     const { min, max, isLogScale } = contract\n     numericValues = { value, min, max, isLogScale }\n   }\n+  const answers =\n+    includeLiteAnswers && contract.mechanism === 'cpmm-multi-1'\n+      ? contract.answers?.map((answer) => ({\n+          id: answer.id,\n+          text: answer.text,\n+          probability: getAnswerProbability(contract, answer.id),\n+        }))\n+      : undefined\n \n   return removeUndefinedProps({\n     id,\n     creatorId,\n@@ -171,8 +182,9 @@\n     lastCommentTime,\n     ...numericValues,\n     token,\n     siblingContractId,\n+    answers,\n \n     // Manifold love props.\n     loverUserId1,\n     loverUserId2,\n"
        },
        {
          "path": "yarn.lock",
          "status": "modified",
          "diff": "Index: yarn.lock\n===================================================================\n--- yarn.lock\t75c29e8 (parent)\n+++ yarn.lock\t3eac52d (commit)\n@@ -2777,8 +2777,26 @@\n     typescript-event-target \"^1.1.1\"\n     zod \"^3.23.8\"\n     zod-to-json-schema \"^3.23.0\"\n \n+\"@modelcontextprotocol/sdk@1.17.1\":\n+  version \"1.17.1\"\n+  resolved \"https://registry.yarnpkg.com/@modelcontextprotocol/sdk/-/sdk-1.17.1.tgz#a3628ae2ca0b4a2e6088202b5ee417d884a88537\"\n+  integrity sha512-CPle1OQehbWqd25La9Ack5B07StKIxh4+Bf19qnpZKJC1oI22Y0czZHbifjw1UoczIfKBwBDAp/dFxvHG13B5A==\n+  dependencies:\n+    ajv \"^6.12.6\"\n+    content-type \"^1.0.5\"\n+    cors \"^2.8.5\"\n+    cross-spawn \"^7.0.5\"\n+    eventsource \"^3.0.2\"\n+    eventsource-parser \"^3.0.0\"\n+    express \"^5.0.1\"\n+    express-rate-limit \"^7.5.0\"\n+    pkce-challenge \"^5.0.0\"\n+    raw-body \"^3.0.0\"\n+    zod \"^3.23.8\"\n+    zod-to-json-schema \"^3.24.1\"\n+\n \"@next/env@15.0.4\":\n   version \"15.0.4\"\n   resolved \"https://registry.yarnpkg.com/@next/env/-/env-15.0.4.tgz#97da0fe3bae2f2b2968c4c925d7936660f5b3836\"\n   integrity sha512-WNRvtgnRVDD4oM8gbUcRc27IAhaL4eXQ/2ovGbgLnPGUvdyDr8UdXP4Q/IBDdAdojnD2eScryIDirv0YUCjUVw==\n@@ -6002,8 +6020,16 @@\n   integrity sha512-h8lQ8tacZYnR3vNQTgibj+tODHI5/+l06Au2Pcriv/Gmet0eaj4TwWH41sO9wnHDiQsEj19q0drzdWdeAHtweg==\n   dependencies:\n     event-target-shim \"^5.0.0\"\n \n+accepts@^2.0.0:\n+  version \"2.0.0\"\n+  resolved \"https://registry.yarnpkg.com/accepts/-/accepts-2.0.0.tgz#bbcf4ba5075467f3f2131eab3cffc73c2f5d7895\"\n+  integrity sha512-5cvg6CtKwfgdmVqY1WIiXKc3Q1bkRqGLi+2W/6ao+6Y7gu/RCwRuAhGEzh5B4KlszSuTLgZYuqFqo5bImjNKng==\n+  dependencies:\n+    mime-types \"^3.0.0\"\n+    negotiator \"^1.0.0\"\n+\n accepts@~1.3.5, accepts@~1.3.8:\n   version \"1.3.8\"\n   resolved \"https://registry.yarnpkg.com/accepts/-/accepts-1.3.8.tgz#0bf0be125b67014adcb0b0921e62db7bffe16b2e\"\n   integrity sha512-PYAthTa2m2VKxuvSD3DPC/Gy+U+sOA1LAuT8mkmRuvw+NACSaeXEQ+NHcVF7rONl6qcaxV3Uuemwawk+7+SJLw==\n@@ -6060,9 +6086,9 @@\n   integrity sha512-5GG/5IbQQpC9FpkRGsSvZI5QYeSCzlJHdpBQntCsuTOxhKD8lqKhrleg2Yi7yvMIf82Ycmmqln9U8V9qwEiJew==\n   dependencies:\n     humanize-ms \"^1.2.1\"\n \n-ajv@^6.12.3, ajv@^6.12.4:\n+ajv@^6.12.3, ajv@^6.12.4, ajv@^6.12.6:\n   version \"6.12.6\"\n   resolved \"https://registry.yarnpkg.com/ajv/-/ajv-6.12.6.tgz#baf5a62e802b07d977034586f8c3baf5adf26df4\"\n   integrity sha512-j3fVLgvTo527anyYyJOGTYJbG+vnnQYvE0m5mmkc1TK+nxAppkCLMIL0aZ4dblVCNoGShhm+kzE4ZUykBoMg4g==\n   dependencies:\n@@ -6606,8 +6632,23 @@\n     raw-body \"2.5.1\"\n     type-is \"~1.6.18\"\n     unpipe \"1.0.0\"\n \n+body-parser@^2.2.0:\n+  version \"2.2.0\"\n+  resolved \"https://registry.yarnpkg.com/body-parser/-/body-parser-2.2.0.tgz#f7a9656de305249a715b549b7b8fd1ab9dfddcfa\"\n+  integrity sha512-02qvAaxv8tp7fBa/mw1ga98OGm+eCbqzJOKoRt70sLmfEEi+jyBYVTDGfCL/k06/4EMk/z01gCe7HoCH/f2LTg==\n+  dependencies:\n+    bytes \"^3.1.2\"\n+    content-type \"^1.0.5\"\n+    debug \"^4.4.0\"\n+    http-errors \"^2.0.0\"\n+    iconv-lite \"^0.6.3\"\n+    on-finished \"^2.4.1\"\n+    qs \"^6.14.0\"\n+    raw-body \"^3.0.0\"\n+    type-is \"^2.0.0\"\n+\n boolbase@^1.0.0:\n   version \"1.0.0\"\n   resolved \"https://registry.yarnpkg.com/boolbase/-/boolbase-1.0.0.tgz#68dff5fbe60c51eb37725ea9e3ed310dcc1e776e\"\n   integrity sha512-JZOSA7Mo9sNGB8+UjSgzdLtokWAky1zbztM3WRLCbZ70/3cTANmQmOdR7y2g+J0e2WXywy1yS468tY+IruqEww==\n@@ -6692,13 +6733,21 @@\n   version \"3.0.0\"\n   resolved \"https://registry.yarnpkg.com/bytes/-/bytes-3.0.0.tgz#d32815404d689699f85a4ea4fa8755dd13a96048\"\n   integrity sha512-pMhOfFDPiv9t5jjIXkHosWmkSyQbvsgEVNkz0ERHbuLh2T/7j4Mqqpz523Fe8MVY89KC6Sh/QfS2sM+SjgFDcw==\n \n-bytes@3.1.2:\n+bytes@3.1.2, bytes@^3.1.2:\n   version \"3.1.2\"\n   resolved \"https://registry.yarnpkg.com/bytes/-/bytes-3.1.2.tgz#8b0beeb98605adf1b128fa4386403c009e0221a5\"\n   integrity sha512-/Nf7TyzTx6S3yRJObOAV7956r8cr2+Oj8AC5dt8wSP3BQAoeX58NoHyCU8P8zGkNXStjTSi6fzO6F0pBdcYbEg==\n \n+call-bind-apply-helpers@^1.0.1, call-bind-apply-helpers@^1.0.2:\n+  version \"1.0.2\"\n+  resolved \"https://registry.yarnpkg.com/call-bind-apply-helpers/-/call-bind-apply-helpers-1.0.2.tgz#4b5428c222be985d79c3d82657479dbe0b59b2d6\"\n+  integrity sha512-Sp1ablJ0ivDkSzjcaJdxEunN5/XvksFJ2sMBFfq6x0ryhQV/2b/KwFe21cMpmHtPOSij8K99/wSfoEuTObmuMQ==\n+  dependencies:\n+    es-errors \"^1.3.0\"\n+    function-bind \"^1.1.2\"\n+\n call-bind@^1.0.0, call-bind@^1.0.2, call-bind@^1.0.4, call-bind@^1.0.5:\n   version \"1.0.5\"\n   resolved \"https://registry.yarnpkg.com/call-bind/-/call-bind-1.0.5.tgz#6fa2b7845ce0ea49bf4d8b9ef64727a2c2e2e513\"\n   integrity sha512-C3nQxfFZxFRVoJoGKKI8y3MOEo129NQ+FgQ08iye+Mk4zNZZGdjfs06bVTr+DBSlA66Q2VEcMki/cUCP4SercQ==\n@@ -6717,8 +6766,16 @@\n     function-bind \"^1.1.2\"\n     get-intrinsic \"^1.2.4\"\n     set-function-length \"^1.2.1\"\n \n+call-bound@^1.0.2:\n+  version \"1.0.4\"\n+  resolved \"https://registry.yarnpkg.com/call-bound/-/call-bound-1.0.4.tgz#238de935d2a2a692928c538c7ccfa91067fd062a\"\n+  integrity sha512-+ys997U96po4Kx/ABpBCqhA9EuxJaQWDQg7295H4hBphv3IZg0boBKuwYpt4YXp6MZ5AmZQnU/tyMTlRpaSejg==\n+  dependencies:\n+    call-bind-apply-helpers \"^1.0.2\"\n+    get-intrinsic \"^1.3.0\"\n+\n callsites@^3.0.0:\n   version \"3.1.0\"\n   resolved \"https://registry.yarnpkg.com/callsites/-/callsites-3.1.0.tgz#b3630abd8943432f54b3f0519238e33cd7df2f73\"\n   integrity sha512-P8BjAsXvZS+VIDUI11hHCQEv74YT67YUi5JJFNWIqL235sBmjX4+qx9Muvls5ivyNENctx46xQLQ3aTuE7ssaQ==\n@@ -7023,8 +7080,20 @@\n   integrity sha512-FveZTNuGw04cxlAiWbzi6zTAL/lhehaWbTtgluJh4/E95DqMwTmha3KZN1aAWA8cFIhHzMZUvLevkw5Rqk+tSQ==\n   dependencies:\n     safe-buffer \"5.2.1\"\n \n+content-disposition@^1.0.0:\n+  version \"1.0.0\"\n+  resolved \"https://registry.yarnpkg.com/content-disposition/-/content-disposition-1.0.0.tgz#844426cb398f934caefcbb172200126bc7ceace2\"\n+  integrity sha512-Au9nRL8VNUut/XSzbQA38+M78dzP4D+eqg3gfJHMIHHYa3bg067xj1KxMUWj+VULbiZMowKngFFbKczUrNJ1mg==\n+  dependencies:\n+    safe-buffer \"5.2.1\"\n+\n+content-type@^1.0.5:\n+  version \"1.0.5\"\n+  resolved \"https://registry.yarnpkg.com/content-type/-/content-type-1.0.5.tgz#8b773162656d1d1086784c8f23a54ce6d73d7918\"\n+  integrity sha512-nTjqfcBFEipKdXCv4YDQWCfmcLZKm81ldF0pAopTvyrFGVbcR6P/VAAd5G7N+0tTr8QqiU0tFadD6FK4NtJwOA==\n+\n content-type@~1.0.4:\n   version \"1.0.4\"\n   resolved \"https://registry.yarnpkg.com/content-type/-/content-type-1.0.4.tgz#e138cc75e040c727b1966fe5e5f8c9aee256fe3b\"\n   integrity sha512-hIP3EEPs8tB9AT1L+NUqtwOAps4mk2Zob89MWXMHjHWg9milF/j4osnnQLXBCBFBk/tvIG/tUc9mOUJiPBhPXA==\n@@ -7043,13 +7112,23 @@\n   version \"1.0.6\"\n   resolved \"https://registry.yarnpkg.com/cookie-signature/-/cookie-signature-1.0.6.tgz#e303a882b342cc3ee8ca513a79999734dab3ae2c\"\n   integrity sha1-4wOogrNCzD7oylE6eZmXNNqzriw=\n \n+cookie-signature@^1.2.1:\n+  version \"1.2.2\"\n+  resolved \"https://registry.yarnpkg.com/cookie-signature/-/cookie-signature-1.2.2.tgz#57c7fc3cc293acab9fec54d73e15690ebe4a1793\"\n+  integrity sha512-D76uU73ulSXrD1UXF4KE2TMxVVwhsnCgfAyTg9k8P6KGZjlXKrOLe4dJQKI3Bxi5wjesZoFXJWElNWBjPZMbhg==\n+\n cookie@0.5.0:\n   version \"0.5.0\"\n   resolved \"https://registry.yarnpkg.com/cookie/-/cookie-0.5.0.tgz#d1f5d71adec6558c58f389987c366aa47e994f8b\"\n   integrity sha512-YZ3GUyn/o8gfKJlnlX7g7xq4gyO6OSuhGPKaaGssGB2qgDUS0gPgtTvoyZLTt9Ab6dC4hfc9dV5arkvc/OCmrw==\n \n+cookie@^0.7.1:\n+  version \"0.7.2\"\n+  resolved \"https://registry.yarnpkg.com/cookie/-/cookie-0.7.2.tgz#556369c472a2ba910f2979891b526b3436237ed7\"\n+  integrity sha512-yki5XnKuf750l50uGTllt6kKILY4nQ1eNIQatoXEByZ5dWgnKqbnqmTrBE5B4N7lrMJKQ2ytWMiTO2o0v6Ew/w==\n+\n core-decorators@^0.17.0:\n   version \"0.17.0\"\n   resolved \"https://registry.yarnpkg.com/core-decorators/-/core-decorators-0.17.0.tgz#3f43180a86d2ab0cc51069f46a1ec3e49e7cebd6\"\n   integrity sha512-dBTL931yH4iZRlknHHkqtvPuGiDAEyTcudUnji3W0+mcNIHTrCmXvlqSyE743tzYtIeujLB00H9G/NdAmE3rPg==\n@@ -7075,9 +7154,9 @@\n   version \"1.0.3\"\n   resolved \"https://registry.yarnpkg.com/core-util-is/-/core-util-is-1.0.3.tgz#a6042d3634c2b27e9328f837b965fac83808db85\"\n   integrity sha512-ZQBvi1DcpJ4GDqanjucZ2Hj3wEO5pZDS89BWbkcrvdxksJorwUDDZamX9ldFkp9aw2lmBDLgkObEA4DWNJ9FYQ==\n \n-cors@2.8.5:\n+cors@2.8.5, cors@^2.8.5:\n   version \"2.8.5\"\n   resolved \"https://registry.yarnpkg.com/cors/-/cors-2.8.5.tgz#eac11da51592dd86b9f06f6e7ac293b3df875d29\"\n   integrity sha512-KIHbLJqu73RGr/hnbrO9uBeixNGuvSQjul/jdFvS/KFSIH1hWVd1ng7zOHx+YrEfInLG7q4n6GHQ9cDtxv/P6g==\n   dependencies:\n@@ -7131,8 +7210,17 @@\n     path-key \"^3.1.0\"\n     shebang-command \"^2.0.0\"\n     which \"^2.0.1\"\n \n+cross-spawn@^7.0.5:\n+  version \"7.0.6\"\n+  resolved \"https://registry.yarnpkg.com/cross-spawn/-/cross-spawn-7.0.6.tgz#8a58fe78f00dcd70c370451759dfbfaf03e8ee9f\"\n+  integrity sha512-uV2QOWP2nWzsy2aMp8aRibhi9dlzF5Hgh5SHaB9OiTGEyDTiJJyx0uy51QXdyWbtAHNua4XJzUKca3OzKUd3vA==\n+  dependencies:\n+    path-key \"^3.1.0\"\n+    shebang-command \"^2.0.0\"\n+    which \"^2.0.1\"\n+\n crypt@0.0.2:\n   version \"0.0.2\"\n   resolved \"https://registry.yarnpkg.com/crypt/-/crypt-0.0.2.tgz#88d7ff7ec0dfb86f713dc87bbb42d044d3e6c41b\"\n   integrity sha512-mCxBlsHFYh9C+HVpiEacem8FEBnMXgU9gy4zmNC+SXAZNB/1idgp/aulFJ4FgCi7GPEVbfyng092GqL2k2rmow==\n@@ -7426,8 +7514,15 @@\n   integrity sha512-CFjzYYAi4ThfiQvizrFQevTTXHtnCqWfe7x1AhgEscTz6ZbLbfoLRLPugTQyBth6f8ZERVUSyWHFD/7Wu4t1XQ==\n   dependencies:\n     ms \"^2.1.1\"\n \n+debug@^4.3.5, debug@^4.4.0:\n+  version \"4.4.1\"\n+  resolved \"https://registry.yarnpkg.com/debug/-/debug-4.4.1.tgz#e5a8bc6cbc4c6cd3e64308b0693a3d4fa550189b\"\n+  integrity sha512-KcKCqiftBJcZr++7ykoDIEwSa3XWowTfNPo92BYxjXiyYEVrUQh2aLyhxBCwww+heortUFxEJYcRzosstTEBYQ==\n+  dependencies:\n+    ms \"^2.1.3\"\n+\n decompress-response@^6.0.0:\n   version \"6.0.0\"\n   resolved \"https://registry.yarnpkg.com/decompress-response/-/decompress-response-6.0.0.tgz#ca387612ddb7e104bd16d85aab00d5ecf09c66fc\"\n   integrity sha512-aW35yZM6Bb/4oJlZncMH2LCoZtJXTRxES17vE3hoRiowU2kWHaJKFkSBDnDR+cm9J+9QhXmREyIfv0pji9ejCQ==\n@@ -7494,9 +7589,9 @@\n   version \"1.0.0\"\n   resolved \"https://registry.yarnpkg.com/delayed-stream/-/delayed-stream-1.0.0.tgz#df3ae199acadfb7d440aaae0b29e2272b24ec619\"\n   integrity sha1-3zrhmayt+31ECqrgsp4icrJOxhk=\n \n-depd@2.0.0:\n+depd@2.0.0, depd@^2.0.0:\n   version \"2.0.0\"\n   resolved \"https://registry.yarnpkg.com/depd/-/depd-2.0.0.tgz#b696163cc757560d09cf22cc8fad1571b79e76df\"\n   integrity sha512-g7nH6P6dyDioJogAAGprGpCtVImJhpPk/roCzdb3fIh61/s/nPsfR6onyMwkCAR/OlC3yBC0lESvUoQEAssIrw==\n \n@@ -7641,8 +7736,17 @@\n   dependencies:\n     no-case \"^3.0.4\"\n     tslib \"^2.0.3\"\n \n+dunder-proto@^1.0.1:\n+  version \"1.0.1\"\n+  resolved \"https://registry.yarnpkg.com/dunder-proto/-/dunder-proto-1.0.1.tgz#d7ae667e1dc83482f8b70fd0f6eefc50da30f58a\"\n+  integrity sha512-KIN/nDJBQRcXw0MLVhZE9iQHmG68qAVIBg9CqmUYjmQIhgij9U5MFvrqkUL5FbtyyzZuOeOt0zdeRe4UY7ct+A==\n+  dependencies:\n+    call-bind-apply-helpers \"^1.0.1\"\n+    es-errors \"^1.3.0\"\n+    gopd \"^1.2.0\"\n+\n duplexify@^4.0.0:\n   version \"4.1.2\"\n   resolved \"https://registry.yarnpkg.com/duplexify/-/duplexify-4.1.2.tgz#18b4f8d28289132fa0b9573c898d9f903f81c7b0\"\n   integrity sha512-fz3OjcNCHmRP12MJoZMPglx8m4rrFP8rovnk4vT8Fs+aonZoCwGg10dSsQsfP/E62eZcPTMSMP6686fu9Qlqtw==\n@@ -7701,8 +7805,13 @@\n   version \"9.2.2\"\n   resolved \"https://registry.yarnpkg.com/emoji-regex/-/emoji-regex-9.2.2.tgz#840c8803b0d8047f4ff0cf963176b32d4ef3ed72\"\n   integrity sha512-L18DaJsXSUk2+42pv8mLs5jJT2hqFkFE4j21wOmgbUqsZ2hL72NsUU785g9RXgo3s0ZNgVl42TiHp3ZtOv/Vyg==\n \n+encodeurl@^2.0.0:\n+  version \"2.0.0\"\n+  resolved \"https://registry.yarnpkg.com/encodeurl/-/encodeurl-2.0.0.tgz#7b8ea898077d7e409d3ac45474ea38eaf0857a58\"\n+  integrity sha512-Q0n9HRi4m6JuGIV1eFlmvJB7ZEVxu93IrMyiMsGC0lrMJMWzRgx6WGquyfQgZVb31vhGgXnfmPNNXmxnOkRBrg==\n+\n encodeurl@~1.0.2:\n   version \"1.0.2\"\n   resolved \"https://registry.yarnpkg.com/encodeurl/-/encodeurl-1.0.2.tgz#ad3ff4c86ec2d029322f5a02c3a9a606c95b3f59\"\n   integrity sha1-rT/0yG7C0CkyL1oCw6mmBslbP1k=\n@@ -7847,8 +7956,13 @@\n   integrity sha512-jxayLKShrEqqzJ0eumQbVhTYQM27CfT1T35+gCgDFoL82JLsXqTJ76zv6A0YLOgEnLUMvLzsDsGIrl8NFpT2gQ==\n   dependencies:\n     get-intrinsic \"^1.2.4\"\n \n+es-define-property@^1.0.1:\n+  version \"1.0.1\"\n+  resolved \"https://registry.yarnpkg.com/es-define-property/-/es-define-property-1.0.1.tgz#983eb2f9a6724e9303f61addf011c72e09e0b0fa\"\n+  integrity sha512-e3nRfgfUZ4rNGL232gUgX06QNyyez04KdjFrF+LTRoOXmrOgFKDg4BCdsjW8EnT69eqdYGmRpJwiPVYNrCaW3g==\n+\n es-errors@^1.2.1, es-errors@^1.3.0:\n   version \"1.3.0\"\n   resolved \"https://registry.yarnpkg.com/es-errors/-/es-errors-1.3.0.tgz#05f75a25dab98e4fb1dcd5e1472c0546d5057c8f\"\n   integrity sha512-Zf5H2Kxt2xjTvbJvP2ZWLEICxA6j+hAmMzIlypy4xcBg1vKVnx89Wy0GbS+kf5cwCVFFzdCFh2XSCFNULS6csw==\n@@ -7880,8 +7994,15 @@\n   integrity sha512-MZ4iQ6JwHOBQjahnjwaC1ZtIBH+2ohjamzAO3oaHcXYup7qxjF2fixyH+Q71voWHeOkI2q/TnJao/KfXYIZWbw==\n   dependencies:\n     es-errors \"^1.3.0\"\n \n+es-object-atoms@^1.1.1:\n+  version \"1.1.1\"\n+  resolved \"https://registry.yarnpkg.com/es-object-atoms/-/es-object-atoms-1.1.1.tgz#1c4f2c4837327597ce69d2ca190a7fdd172338c1\"\n+  integrity sha512-FGgH2h8zKNim9ljj7dankFPcICIK9Cp5bm+c2gQSYePhpaG5+esrLODihIorn+Pe6FGJzWhXQotPv73jTaldXA==\n+  dependencies:\n+    es-errors \"^1.3.0\"\n+\n es-set-tostringtag@^2.0.1:\n   version \"2.0.1\"\n   resolved \"https://registry.yarnpkg.com/es-set-tostringtag/-/es-set-tostringtag-2.0.1.tgz#338d502f6f674301d710b80c8592de8a15f09cd8\"\n   integrity sha512-g3OMbtlwY3QewlqAiMLI47KywjWZoEytKr8pf6iTC8uJq5bIAH52Z9pnQ8pVL6whrCto53JZDuUIsifGeLorTg==\n@@ -8247,9 +8368,9 @@\n   version \"2.0.3\"\n   resolved \"https://registry.yarnpkg.com/esutils/-/esutils-2.0.3.tgz#74d2eb4de0b8da1293711910d50775b9b710ef64\"\n   integrity sha512-kVscqXk4OCp68SZ0dkgEKVi6/8ij300KBWTJq32P/dYeWTSwK41WyTxalN1eRmA5Z9UU/LX9D7FWSmV9SAYx6g==\n \n-etag@~1.8.1:\n+etag@^1.8.1, etag@~1.8.1:\n   version \"1.8.1\"\n   resolved \"https://registry.yarnpkg.com/etag/-/etag-1.8.1.tgz#41ae2eeb65efa62268aebfea83ac7d79299b0887\"\n   integrity sha1-Qa4u62XvpiJorr/qg6x9eSmbCIc=\n \n@@ -8257,8 +8378,20 @@\n   version \"5.0.1\"\n   resolved \"https://registry.yarnpkg.com/event-target-shim/-/event-target-shim-5.0.1.tgz#5d4d3ebdf9583d63a5333ce2deb7480ab2b05789\"\n   integrity sha512-i/2XbnSz/uxRCU6+NdVJgKWDTM427+MqYbkQzD321DuCQJUqOuJKIA0IM2+W2xtYHdKOmZ4dR6fExsd4SXL+WQ==\n \n+eventsource-parser@^3.0.0, eventsource-parser@^3.0.1:\n+  version \"3.0.3\"\n+  resolved \"https://registry.yarnpkg.com/eventsource-parser/-/eventsource-parser-3.0.3.tgz#e9af1d40b77e6268cdcbc767321e8b9f066adea8\"\n+  integrity sha512-nVpZkTMM9rF6AQ9gPJpFsNAMt48wIzB5TQgiTLdHiuO8XEDhUgZEhqKlZWXbIzo9VmJ/HvysHqEaVeD5v9TPvA==\n+\n+eventsource@^3.0.2:\n+  version \"3.0.7\"\n+  resolved \"https://registry.yarnpkg.com/eventsource/-/eventsource-3.0.7.tgz#1157622e2f5377bb6aef2114372728ba0c156989\"\n+  integrity sha512-CRT1WTyuQoD771GW56XEZFQ/ZoSfWid1alKGDYMmkt2yl8UXrVR4pspqWNEcqKvVIzg6PAltWjxcSSPrboA4iA==\n+  dependencies:\n+    eventsource-parser \"^3.0.1\"\n+\n execa@^5.0.0:\n   version \"5.1.1\"\n   resolved \"https://registry.yarnpkg.com/execa/-/execa-5.1.1.tgz#f80ad9cbf4298f7bd1d4c9555c21e93741c411dd\"\n   integrity sha512-8uSpZZocAZRBAPIEINJj3Lo9HyGitllczc27Eh5YYojjMFMn8yHMDMaUHE2Jqfq05D/wucwI4JGURyXt1vchyg==\n@@ -8317,8 +8450,13 @@\n   integrity sha512-L6YQ1wQ/mNjVLAmK3AG1RK6VkokA1BIY6wmiH304Xtt/cLTps40EusZsU1Uop+v9lTDPxdtzbFmdXfFO3KEnwA==\n   dependencies:\n     basic-auth \"^2.0.1\"\n \n+express-rate-limit@^7.5.0:\n+  version \"7.5.1\"\n+  resolved \"https://registry.yarnpkg.com/express-rate-limit/-/express-rate-limit-7.5.1.tgz#8c3a42f69209a3a1c969890070ece9e20a879dec\"\n+  integrity sha512-7iN8iPMDzOMHPUYllBEsQdWVB6fPDMPqwjBaFrgr4Jgr/+okjvzAy+UHlYYL/Vs0OsOrMkwS6PJDkFlJwoxUnw==\n+\n express@4.18.1:\n   version \"4.18.1\"\n   resolved \"https://registry.yarnpkg.com/express/-/express-4.18.1.tgz#7797de8b9c72c857b9cd0e14a5eea80666267caf\"\n   integrity sha512-zZBcOX9TfehHQhtupq57OF8lFZ3UZi08Y97dwFCkD8p9d/d2Y3M+ykKcwaMDEL+4qyUolgBDX6AblpR3fL212Q==\n@@ -8354,8 +8492,41 @@\n     type-is \"~1.6.18\"\n     utils-merge \"1.0.1\"\n     vary \"~1.1.2\"\n \n+express@^5.0.1:\n+  version \"5.1.0\"\n+  resolved \"https://registry.yarnpkg.com/express/-/express-5.1.0.tgz#d31beaf715a0016f0d53f47d3b4d7acf28c75cc9\"\n+  integrity sha512-DT9ck5YIRU+8GYzzU5kT3eHGA5iL+1Zd0EutOmTE9Dtk+Tvuzd23VBU+ec7HPNSTxXYO55gPV/hq4pSBJDjFpA==\n+  dependencies:\n+    accepts \"^2.0.0\"\n+    body-parser \"^2.2.0\"\n+    content-disposition \"^1.0.0\"\n+    content-type \"^1.0.5\"\n+    cookie \"^0.7.1\"\n+    cookie-signature \"^1.2.1\"\n+    debug \"^4.4.0\"\n+    encodeurl \"^2.0.0\"\n+    escape-html \"^1.0.3\"\n+    etag \"^1.8.1\"\n+    finalhandler \"^2.1.0\"\n+    fresh \"^2.0.0\"\n+    http-errors \"^2.0.0\"\n+    merge-descriptors \"^2.0.0\"\n+    mime-types \"^3.0.0\"\n+    on-finished \"^2.4.1\"\n+    once \"^1.4.0\"\n+    parseurl \"^1.3.3\"\n+    proxy-addr \"^2.0.7\"\n+    qs \"^6.14.0\"\n+    range-parser \"^1.2.1\"\n+    router \"^2.2.0\"\n+    send \"^1.1.0\"\n+    serve-static \"^2.2.0\"\n+    statuses \"^2.0.1\"\n+    type-is \"^2.0.1\"\n+    vary \"^1.1.2\"\n+\n extend@^3.0.2, extend@~3.0.2:\n   version \"3.0.2\"\n   resolved \"https://registry.yarnpkg.com/extend/-/extend-3.0.2.tgz#f8b1136b4071fbd8eb140aff858b1019ec2915fa\"\n   integrity sha512-fjquC59cD7CyW6urNXK0FBufkZcoiGG80wTuPujX590cB5Ttln20E2UB4S/WARVqhXffZl2LNgS+gQdPIIim/g==\n@@ -8514,8 +8685,20 @@\n     parseurl \"~1.3.3\"\n     statuses \"2.0.1\"\n     unpipe \"~1.0.0\"\n \n+finalhandler@^2.1.0:\n+  version \"2.1.0\"\n+  resolved \"https://registry.yarnpkg.com/finalhandler/-/finalhandler-2.1.0.tgz#72306373aa89d05a8242ed569ed86a1bff7c561f\"\n+  integrity sha512-/t88Ty3d5JWQbWYgaOGCCYfXRwV1+be02WqYYlL6h0lEiUAMPM8o8qKGO01YIkOHzka2up08wvgYD0mDiI+q3Q==\n+  dependencies:\n+    debug \"^4.4.0\"\n+    encodeurl \"^2.0.0\"\n+    escape-html \"^1.0.3\"\n+    on-finished \"^2.4.1\"\n+    parseurl \"^1.3.3\"\n+    statuses \"^2.0.1\"\n+\n find-up@^4.0.0, find-up@^4.1.0:\n   version \"4.1.0\"\n   resolved \"https://registry.yarnpkg.com/find-up/-/find-up-4.1.0.tgz#97afe7d6cdc0bc5928584b7c8d7b16e8a9aa5d19\"\n   integrity sha512-PpOwAdQ/YlXQ2vj8a3h8IipDuYRi3wceVQQGYWxNINccq40Anw7BlsEXCMbt1Zt+OLA6Fq9suIpIWD0OsnISlw==\n@@ -8715,8 +8898,13 @@\n   version \"0.5.2\"\n   resolved \"https://registry.yarnpkg.com/fresh/-/fresh-0.5.2.tgz#3d8cadd90d976569fa835ab1f8e4b23a105605a7\"\n   integrity sha1-PYyt2Q2XZWn6g1qx+OSyOhBWBac=\n \n+fresh@^2.0.0:\n+  version \"2.0.0\"\n+  resolved \"https://registry.yarnpkg.com/fresh/-/fresh-2.0.0.tgz#8dd7df6a1b3a1b3a5cf186c05a5dd267622635a4\"\n+  integrity sha512-Rx/WycZ60HOaqLKAi6cHRKKI7zxWbJ31MhntmtwMoaTeF7XFH9hhBp8vITaMidfljRQ6eYWCKkaTK+ykVJHP2A==\n+\n fs-constants@^1.0.0:\n   version \"1.0.0\"\n   resolved \"https://registry.yarnpkg.com/fs-constants/-/fs-constants-1.0.0.tgz#6be0de9be998ce16af8afc24497b9ee9b7ccd9ad\"\n   integrity sha512-y6OAwoSIf7FyjMIv94u+b5rdheZEjzR63GTyZJm5qh4Bi+2YgwLCcI/fPFZkL5PSixOt6ZNKm+w+Hfp/Bciwow==\n@@ -8831,13 +9019,37 @@\n     has-proto \"^1.0.1\"\n     has-symbols \"^1.0.3\"\n     hasown \"^2.0.0\"\n \n+get-intrinsic@^1.2.5, get-intrinsic@^1.3.0:\n+  version \"1.3.0\"\n+  resolved \"https://registry.yarnpkg.com/get-intrinsic/-/get-intrinsic-1.3.0.tgz#743f0e3b6964a93a5491ed1bffaae054d7f98d01\"\n+  integrity sha512-9fSjSaos/fRIVIp+xSJlE6lfwhES7LNtKaCBIamHsjr2na1BiABJPo0mOjjz8GJDURarmCPGqaiVg5mfjb98CQ==\n+  dependencies:\n+    call-bind-apply-helpers \"^1.0.2\"\n+    es-define-property \"^1.0.1\"\n+    es-errors \"^1.3.0\"\n+    es-object-atoms \"^1.1.1\"\n+    function-bind \"^1.1.2\"\n+    get-proto \"^1.0.1\"\n+    gopd \"^1.2.0\"\n+    has-symbols \"^1.1.0\"\n+    hasown \"^2.0.2\"\n+    math-intrinsics \"^1.1.0\"\n+\n get-package-type@^0.1.0:\n   version \"0.1.0\"\n   resolved \"https://registry.yarnpkg.com/get-package-type/-/get-package-type-0.1.0.tgz#8de2d803cff44df3bc6c456e6668b36c3926e11a\"\n   integrity sha512-pjzuKtY64GYfWizNAJ0fr9VqttZkNiK2iS430LtIHzjBEr6bX8Am2zm4sW4Ro5wjWW5cAlRL1qAMTcXbjNAO2Q==\n \n+get-proto@^1.0.1:\n+  version \"1.0.1\"\n+  resolved \"https://registry.yarnpkg.com/get-proto/-/get-proto-1.0.1.tgz#150b3f2743869ef3e851ec0c49d15b1d14d00ee1\"\n+  integrity sha512-sTSfBjoXBp89JvIKIefqw7U2CCebsc74kiY6awiGogKtoSGbgjYE/G/+l9sF3MWFPNc9IcoOC4ODfKHfxFmp0g==\n+  dependencies:\n+    dunder-proto \"^1.0.1\"\n+    es-object-atoms \"^1.0.0\"\n+\n get-stream@^6.0.0:\n   version \"6.0.1\"\n   resolved \"https://registry.yarnpkg.com/get-stream/-/get-stream-6.0.1.tgz#a262d8eef67aced57c2852ad6167526a43cbf7b7\"\n   integrity sha512-ts6Wi+2j3jQjqi70w5AlN8DFnkSwC+MqmxEzdEALB2qXZYV3X/b1CTfgPLGJNMeAWxdPfU8FO1ms3NUfaHCPYg==\n@@ -9074,8 +9286,13 @@\n   integrity sha512-d65bNlIadxvpb/A2abVdlqKqV563juRnZ1Wtk6s1sIR8uNsXR70xqIzVqxVf1eTqDunwT2MkczEeaezCKTZhwA==\n   dependencies:\n     get-intrinsic \"^1.1.3\"\n \n+gopd@^1.2.0:\n+  version \"1.2.0\"\n+  resolved \"https://registry.yarnpkg.com/gopd/-/gopd-1.2.0.tgz#89f56b8217bdbc8802bd299df6d7f1081d7e51a1\"\n+  integrity sha512-ZUKRh6/kUFoAiTAtTYPZJ3hw9wNxx+BIBOijnlG9PnrJsCcSjs1wyyD6vJpaYtgnzDrKYRSqf3OO6Rfa93xsRg==\n+\n graceful-fs@^4.1.9, graceful-fs@^4.2.4, graceful-fs@^4.2.9:\n   version \"4.2.11\"\n   resolved \"https://registry.yarnpkg.com/graceful-fs/-/graceful-fs-4.2.11.tgz#4183e4e8bf08bb6e05bbb2f7d2e0c8f712ca40e3\"\n   integrity sha512-RbJ5/jmFcNNCcDV5o9eTnBLJ/HszWV0P73bc+Ff4nS/rJj+YaS6IGyiOL0VoBYX+l1Wrl3k63h/KrH+nhJ0XvQ==\n@@ -9172,8 +9389,13 @@\n   version \"1.0.3\"\n   resolved \"https://registry.yarnpkg.com/has-symbols/-/has-symbols-1.0.3.tgz#bb7b2c4349251dce87b125f7bdf874aa7c8b39f8\"\n   integrity sha512-l3LCuF6MgDNwTDKkdYGEihYjt5pRPbEg46rtlmnSPlUbgmB8LOIrKJbYYFBSbnPaJexMKtiPO8hmeRjRz2Td+A==\n \n+has-symbols@^1.1.0:\n+  version \"1.1.0\"\n+  resolved \"https://registry.yarnpkg.com/has-symbols/-/has-symbols-1.1.0.tgz#fc9c6a783a084951d0b971fe1018de813707a338\"\n+  integrity sha512-1cDNdwJ2Jaohmb3sg4OmKaMBwuC48sYni5HUw2DvsC8LjGTLK9h+eb1X6RyuOHe4hT0ULCW68iomhjUoKUqlPQ==\n+\n has-tostringtag@^1.0.0:\n   version \"1.0.0\"\n   resolved \"https://registry.yarnpkg.com/has-tostringtag/-/has-tostringtag-1.0.0.tgz#7e133818a7d394734f941e73c3d3f9291e658b25\"\n   integrity sha512-kFjcSNhnlGV1kyoGk7OXKSawH5JOb/LzUc5w9B02hOTO0dfFRjbHQKvg1d6cf3HbeUmtU9VbbV3qzZ2Teh97WQ==\n@@ -9239,9 +9461,9 @@\n     domhandler \"^5.0.3\"\n     domutils \"^3.0.1\"\n     entities \"^4.4.0\"\n \n-http-errors@2.0.0:\n+http-errors@2.0.0, http-errors@^2.0.0:\n   version \"2.0.0\"\n   resolved \"https://registry.yarnpkg.com/http-errors/-/http-errors-2.0.0.tgz#b7774a1486ef73cf7667ac9ae0858c012c57b9d3\"\n   integrity sha512-FtwrG/euBzaEjYeRqOgly7G0qviiXoJWnvEH2Z1plBdXgbyjv34pHTSb9zoeHMyDy33+DWy5Wt9Wo+TURtOYSQ==\n   dependencies:\n@@ -9332,8 +9554,15 @@\n   integrity sha512-v3MXnZAcvnywkTUEZomIActle7RXXeedOR31wwl7VlyoXO4Qi9arvSenNQWne1TcRwhCL1HwLI21bEqdpj8/rA==\n   dependencies:\n     safer-buffer \">= 2.1.2 < 3\"\n \n+iconv-lite@0.6.3, iconv-lite@^0.6.3:\n+  version \"0.6.3\"\n+  resolved \"https://registry.yarnpkg.com/iconv-lite/-/iconv-lite-0.6.3.tgz#a52f80bf38da1952eb5c681790719871a1a72501\"\n+  integrity sha512-4fCk79wshMdzMp2rH06qWrJE4iolqLhCUH+OiuIgU++RB0+94NlDL81atO7GX55uUKueo0txHNtvEyI6D7WdMw==\n+  dependencies:\n+    safer-buffer \">= 2.1.2 < 3.0.0\"\n+\n idb@7.1.1:\n   version \"7.1.1\"\n   resolved \"https://registry.yarnpkg.com/idb/-/idb-7.1.1.tgz#d910ded866d32c7ced9befc5bfdf36f572ced72b\"\n   integrity sha512-gchesWBzyvGHRO9W8tzUWFDycow5gwjvFKfyV9FF32Y7F50yZMp7mP+T2mJIWFx49zicqyC4uefHM17o6xKIVQ==\n@@ -9623,8 +9852,13 @@\n   version \"3.0.3\"\n   resolved \"https://registry.yarnpkg.com/is-path-inside/-/is-path-inside-3.0.3.tgz#d231362e53a07ff2b0e0ea7fed049161ffd16283\"\n   integrity sha512-Fd4gABb+ycGAmKou8eMftCupSir5lRxqf4aD/vd0cD2qc4HL07OjCeuHMr8Ro4CoMaeCKDB0/ECBOVWjTwUvPQ==\n \n+is-promise@^4.0.0:\n+  version \"4.0.0\"\n+  resolved \"https://registry.yarnpkg.com/is-promise/-/is-promise-4.0.0.tgz#42ff9f84206c1991d26debf520dd5c01042dd2f3\"\n+  integrity sha512-hvpoI6korhJMnej285dSg6nu1+e6uxs7zG3BYAm5byqDsgJNWwxzM6z6iZiAgQR4TJ30JmBTOwqZUw3WlyH3AQ==\n+\n is-regex@^1.1.4:\n   version \"1.1.4\"\n   resolved \"https://registry.yarnpkg.com/is-regex/-/is-regex-1.1.4.tgz#eef5663cd59fa4c0ae339505323df6854bb15958\"\n   integrity sha512-kvRdxDsxZjhzUX07ZnLydzS1TU/TJlTUHHY4YLL87e37oUA49DfkLqgy+VjFocowy29cKvcSiu+kIv728jTTVg==\n@@ -10687,8 +10921,13 @@\n   version \"1.2.6\"\n   resolved \"https://registry.yarnpkg.com/material-colors/-/material-colors-1.2.6.tgz#6d1958871126992ceecc72f4bcc4d8f010865f46\"\n   integrity sha512-6qE4B9deFBIa9YSpOc9O0Sgc43zTeVYbgDT5veRKSlB2+ZuHNoVVxA1L/ckMUayV9Ay9y7Z/SZCLcGteW9i7bg==\n \n+math-intrinsics@^1.1.0:\n+  version \"1.1.0\"\n+  resolved \"https://registry.yarnpkg.com/math-intrinsics/-/math-intrinsics-1.1.0.tgz#a0dd74be81e2aa5c2f27e65ce283605ee4e2b7f9\"\n+  integrity sha512-/IXtbwEk5HTPyEwyKX6hGkYXxM9nbj64B+ilVJnC/R6B0pH5G4V3b0pVbL7DBj4tkhBAppbQUlf6F6Xl9LHu1g==\n+\n md5@^2.3.0:\n   version \"2.3.0\"\n   resolved \"https://registry.yarnpkg.com/md5/-/md5-2.3.0.tgz#c3da9a6aae3a30b46b7b0c349b87b110dc3bda4f\"\n   integrity sha512-T1GITYmFaKuO91vxyoQMFETst+O71VUPEU3ze5GNzDm0OWdP8v1ziTaAEPUr/3kLsY3Sftgz242A1SetQiDL7g==\n@@ -10716,8 +10955,13 @@\n   version \"0.3.0\"\n   resolved \"https://registry.yarnpkg.com/media-typer/-/media-typer-0.3.0.tgz#8710d7af0aa626f8fffa1ce00168545263255748\"\n   integrity sha1-hxDXrwqmJvj/+hzgAWhUUmMlV0g=\n \n+media-typer@^1.1.0:\n+  version \"1.1.0\"\n+  resolved \"https://registry.yarnpkg.com/media-typer/-/media-typer-1.1.0.tgz#6ab74b8f2d3320f2064b2a87a38e7931ff3a5561\"\n+  integrity sha512-aisnrDP4GNe06UcKFnV5bfMNPBUw4jsLGaWwWfnH3v02GnBuXX2MCVn5RbrWo0j3pczUilYblq7fQ7Nw2t5XKw==\n+\n memoize-one@^6.0.0:\n   version \"6.0.0\"\n   resolved \"https://registry.yarnpkg.com/memoize-one/-/memoize-one-6.0.0.tgz#b2591b871ed82948aee4727dc6abceeeac8c1045\"\n   integrity sha512-rkpe71W0N0c0Xz6QD0eJETuWAJGnJ9afsl1srmwPrI+yBCkge5EycXXbYRyvL29zZVUWQCY7InPRCv3GDXuZNw==\n@@ -10726,8 +10970,13 @@\n   version \"1.0.1\"\n   resolved \"https://registry.yarnpkg.com/merge-descriptors/-/merge-descriptors-1.0.1.tgz#b00aaa556dd8b44568150ec9d1b953f3f90cbb61\"\n   integrity sha1-sAqqVW3YtEVoFQ7J0blT8/kMu2E=\n \n+merge-descriptors@^2.0.0:\n+  version \"2.0.0\"\n+  resolved \"https://registry.yarnpkg.com/merge-descriptors/-/merge-descriptors-2.0.0.tgz#ea922f660635a2249ee565e0449f951e6b603808\"\n+  integrity sha512-Snk314V5ayFLhp3fkUREub6WtjBfPdCPY1Ln8/8munuLuiYhsABgBVWsozAG+MWMbVEvcdcpbi9R7ww22l9Q3g==\n+\n merge-stream@^2.0.0:\n   version \"2.0.0\"\n   resolved \"https://registry.yarnpkg.com/merge-stream/-/merge-stream-2.0.0.tgz#52823629a14dd00c9770fb6ad47dc6310f2c1f60\"\n   integrity sha512-abv/qOcuPfk3URPfDzmZU1LKmuw8kT+0nIHvKrKgFrwifol/doWcdA4ZqsWQ8ENrFKkd67Mfpo/LovbIUsbt3w==\n@@ -10754,15 +11003,27 @@\n   version \"1.52.0\"\n   resolved \"https://registry.yarnpkg.com/mime-db/-/mime-db-1.52.0.tgz#bbabcdc02859f4987301c856e3387ce5ec43bf70\"\n   integrity sha512-sPU4uV7dYlvtWJxwwxHD0PuihVNiE7TyAbQ5SWxDCB9mUYvOgroQOwYQQOKPJ8CIbE+1ETVlOoK1UC2nU3gYvg==\n \n+mime-db@^1.54.0:\n+  version \"1.54.0\"\n+  resolved \"https://registry.yarnpkg.com/mime-db/-/mime-db-1.54.0.tgz#cddb3ee4f9c64530dff640236661d42cb6a314f5\"\n+  integrity sha512-aU5EJuIN2WDemCcAp2vFBfp/m4EAhWJnUNSSw0ixs7/kXbd6Pg64EmwJkNdFhB8aWt1sH2CTXrLxo/iAGV3oPQ==\n+\n mime-types@^2.0.8, mime-types@^2.1.12, mime-types@~2.1.19, mime-types@~2.1.24, mime-types@~2.1.34:\n   version \"2.1.35\"\n   resolved \"https://registry.yarnpkg.com/mime-types/-/mime-types-2.1.35.tgz#381a871b62a734450660ae3deee44813f70d959a\"\n   integrity sha512-ZDY+bPm5zTTF+YpCrAU9nK0UgICYPT0QtT1NZWFv4s++TNkcgVaT0g6+4R2uI4MjQjzysHB1zxuWL50hzaeXiw==\n   dependencies:\n     mime-db \"1.52.0\"\n \n+mime-types@^3.0.0, mime-types@^3.0.1:\n+  version \"3.0.1\"\n+  resolved \"https://registry.yarnpkg.com/mime-types/-/mime-types-3.0.1.tgz#b1d94d6997a9b32fd69ebaed0db73de8acb519ce\"\n+  integrity sha512-xRc4oEhT6eaBpU1XF7AjpOFD+xQmXNB5OVKwp4tqCuBpHLS/ZbBDrc07mYTDqVMg6PfxUjjNp85O6Cd2Z/5HWA==\n+  dependencies:\n+    mime-db \"^1.54.0\"\n+\n mime@1.6.0:\n   version \"1.6.0\"\n   resolved \"https://registry.yarnpkg.com/mime/-/mime-1.6.0.tgz#32cd9e5c64553bd58d19a568af452acff04981b1\"\n   integrity sha512-x0Vn8spI+wuJ1O6S7gnbaQg8Pxh4NNHb7KSINmEWKiPE4RKOplvijn+NkmYmmRgP68mc70j2EbeTFRsrswaQeg==\n@@ -10855,9 +11116,9 @@\n   version \"2.1.2\"\n   resolved \"https://registry.yarnpkg.com/ms/-/ms-2.1.2.tgz#d09d1f357b443f493382a8eb3ccd183872ae6009\"\n   integrity sha512-sGkPx+VjMtmA6MX27oA4FBFELFCZZ4S4XqeGOXCv68tT+jb3vk/RyaKWP0PTKyWtmLSM0b+adUTEvbs1PEaH2w==\n \n-ms@2.1.3, ms@^2.0.0, ms@^2.1.1:\n+ms@2.1.3, ms@^2.0.0, ms@^2.1.1, ms@^2.1.3:\n   version \"2.1.3\"\n   resolved \"https://registry.yarnpkg.com/ms/-/ms-2.1.3.tgz#574c8138ce1d2b5861f0b44579dbadd60c6615b2\"\n   integrity sha512-6FlzubTLZG3J2a/NVCAleEhjzq5oxgHyaCU9yYXvcLsvoVaHJq/s5xXI6/XXP6tz7R9xAOtHnSO/tXtF3WRTlA==\n \n@@ -10904,8 +11165,13 @@\n   version \"0.6.3\"\n   resolved \"https://registry.yarnpkg.com/negotiator/-/negotiator-0.6.3.tgz#58e323a72fedc0d6f9cd4d31fe49f51479590ccd\"\n   integrity sha512-+EUsqGPLsM+j/zdChZjsnX51g4XrHFOIXwfnCVPGlQk/k5giakcKsuxCObBRu6DSm9opw/O6slWbJdghQM4bBg==\n \n+negotiator@^1.0.0:\n+  version \"1.0.0\"\n+  resolved \"https://registry.yarnpkg.com/negotiator/-/negotiator-1.0.0.tgz#b6c91bb47172d69f93cfd7c357bbb529019b5f6a\"\n+  integrity sha512-8Ofs/AUQh8MaEcrlq5xOX0CQ9ypTF5dl78mjlMNfOK08fzpgTHQRQPBxcPlEtIw0yRpws+Zo/3r+5WRby7u3Gg==\n+\n neo-async@^2.6.2:\n   version \"2.6.2\"\n   resolved \"https://registry.yarnpkg.com/neo-async/-/neo-async-2.6.2.tgz#b4aafb93e3aeb2d8174ca53cf163ab7d7308305f\"\n   integrity sha512-Yd3UES5mWCSqR+qNT93S3UoYUkqAZ9lLg8a7g9rimsWmYGK8cVToA4/sF3RrshdyV3sAGMXVUmpMYOw+dLpOuw==\n@@ -11187,9 +11453,9 @@\n     call-bind \"^1.0.7\"\n     define-properties \"^1.2.1\"\n     es-object-atoms \"^1.0.0\"\n \n-on-finished@2.4.1:\n+on-finished@2.4.1, on-finished@^2.4.1:\n   version \"2.4.1\"\n   resolved \"https://registry.yarnpkg.com/on-finished/-/on-finished-2.4.1.tgz#58c8c44116e54845ad57f14ab10b03533184ac3f\"\n   integrity sha512-oVlzkg3ENAhCk2zdv7IJwd/QUD4z2RxRwpkcGY8psCVcCYZNq4wYnVWALHM+brtuJjePWiYF/ClmuDr8Ch5+kg==\n   dependencies:\n@@ -11383,9 +11649,9 @@\n   integrity sha512-Czj1WaSVpaoj0wbhMzLmWD69anp2WH7FXMB9n1Sy8/ZFF9jolSQVMu1Ij5WIyGmcBmhk7EOndpO4mIpihVqAXw==\n   dependencies:\n     entities \"^4.4.0\"\n \n-parseurl@~1.3.3:\n+parseurl@^1.3.3, parseurl@~1.3.3:\n   version \"1.3.3\"\n   resolved \"https://registry.yarnpkg.com/parseurl/-/parseurl-1.3.3.tgz#9da19e7bee8d12dff0513ed5b76957793bc2e8d4\"\n   integrity sha512-CiyeOxFT/JZyN5m0z9PfXw4SCBJ6Sygz1Dpl0wqjlhDEGGBP1GnsUVEL0p63hoG1fcj3fHynXi9NYO4nWOL+qQ==\n \n@@ -11428,8 +11694,13 @@\n   version \"0.1.7\"\n   resolved \"https://registry.yarnpkg.com/path-to-regexp/-/path-to-regexp-0.1.7.tgz#df604178005f522f15eb4490e7247a1bfaa67f8c\"\n   integrity sha1-32BBeABfUi8V60SQ5yR6G/qmf4w=\n \n+path-to-regexp@^8.0.0:\n+  version \"8.2.0\"\n+  resolved \"https://registry.yarnpkg.com/path-to-regexp/-/path-to-regexp-8.2.0.tgz#73990cc29e57a3ff2a0d914095156df5db79e8b4\"\n+  integrity sha512-TdrF7fW9Rphjq4RjrW0Kp2AW0Ahwu9sRGTkS6bvDi0SCwZlEZYmcfDbEsTz8RVk0EHIS/Vd1bv3JhG+1xZuAyQ==\n+\n path-type@^4.0.0:\n   version \"4.0.0\"\n   resolved \"https://registry.yarnpkg.com/path-type/-/path-type-4.0.0.tgz#84ed01c0a7ba380afe09d90a8c180dcd9d03043b\"\n   integrity sha512-gDKb8aZMDeD/tZWs9P6+q0J9Mwkdl6xMV8TjnGP3qJVJ06bdMgkbBlLU8IdfOsIsFz2BW1rNVT3XuNEl8zPAvw==\n@@ -11577,8 +11848,13 @@\n   version \"4.0.6\"\n   resolved \"https://registry.yarnpkg.com/pirates/-/pirates-4.0.6.tgz#3018ae32ecfcff6c29ba2267cbf21166ac1f36b9\"\n   integrity sha512-saLsH7WeYYPiD25LDuLRRY/i+6HaPYr6G1OUlN39otzkSTxKnubR9RTxS3/Kk50s1g2JTgFwWQDQyplC5/SHZg==\n \n+pkce-challenge@^5.0.0:\n+  version \"5.0.0\"\n+  resolved \"https://registry.yarnpkg.com/pkce-challenge/-/pkce-challenge-5.0.0.tgz#c3a405cb49e272094a38e890a2b51da0228c4d97\"\n+  integrity sha512-ueGLflrrnvwB3xuo/uGob5pd5FN7l0MsLf0Z87o/UQmRtwjvfylfc9MurIxRAWywCYTgrvpXBcqjV4OfCYGCIQ==\n+\n pkg-dir@^4.2.0:\n   version \"4.2.0\"\n   resolved \"https://registry.yarnpkg.com/pkg-dir/-/pkg-dir-4.2.0.tgz#f099133df7ede422e81d1d8448270eeb3e4261f3\"\n   integrity sha512-HRDzbaKjC+AOWVXxAU/x54COGeIv9eb+6CkDSQoNTt4XyWoIJvuPsXizxu/Fr23EiekbtZwmh1IcIG/l/a10GQ==\n@@ -11921,9 +12197,9 @@\n     \"@protobufjs/utf8\" \"^1.1.0\"\n     \"@types/node\" \">=13.7.0\"\n     long \"^5.0.0\"\n \n-proxy-addr@~2.0.7:\n+proxy-addr@^2.0.7, proxy-addr@~2.0.7:\n   version \"2.0.7\"\n   resolved \"https://registry.yarnpkg.com/proxy-addr/-/proxy-addr-2.0.7.tgz#f19fe69ceab311eeb94b42e70e8c2070f9ba1025\"\n   integrity sha512-llQsMLSUDUPT44jdrU/O37qlnifitDP+ZwrmmZcoSKyLKvtZxpyV0n2/bD/N4tBAAZ/gJEdZU7KMraoK1+XYAg==\n   dependencies:\n@@ -11993,8 +12269,15 @@\n   integrity sha512-wr7M2E0OFRfIfJZjKGieI8lBKb7fRCH4Fv5KNPEs7gJ8jadvotdsS08PzOKR7opXhZ/Xkjtt3WF9g38drmyRqQ==\n   dependencies:\n     side-channel \"^1.0.4\"\n \n+qs@^6.14.0:\n+  version \"6.14.0\"\n+  resolved \"https://registry.yarnpkg.com/qs/-/qs-6.14.0.tgz#c63fa40680d2c5c941412a0e899c89af60c0a930\"\n+  integrity sha512-YWWTjgABSKcvs/nWBi9PycY/JiPJqOD4JA6o9Sej2AtvSGarXxKC3OQSk4pAarbdQlKAh5D4FCQkJNkW+GAn3w==\n+  dependencies:\n+    side-channel \"^1.1.0\"\n+\n qs@^6.6.0, qs@^6.9.4:\n   version \"6.11.2\"\n   resolved \"https://registry.yarnpkg.com/qs/-/qs-6.11.2.tgz#64bea51f12c1f5da1bc01496f48ffcff7c69d7d9\"\n   integrity sha512-tDNIz22aBzCDxLtVH++VnTfzxlfeK5CbqohpSqpJgj1Wg/cQbStNAz3NuqCs5vV+pjBsK4x4pN9HlVh7rcYRiA==\n@@ -12048,9 +12331,9 @@\n   dependencies:\n     discontinuous-range \"1.0.0\"\n     ret \"~0.1.10\"\n \n-range-parser@~1.2.1:\n+range-parser@^1.2.1, range-parser@~1.2.1:\n   version \"1.2.1\"\n   resolved \"https://registry.yarnpkg.com/range-parser/-/range-parser-1.2.1.tgz#3cf37023d199e1c24d1a55b84800c2f3e6468031\"\n   integrity sha512-Hrgsx+orqoygnmhFbKaHE6c296J+HTAQXoxEF6gNupROmmGJRoyzfG3ccAveqCBrwr/2yxQ5BVd/GTl5agOwSg==\n \n@@ -12063,8 +12346,18 @@\n     http-errors \"2.0.0\"\n     iconv-lite \"0.4.24\"\n     unpipe \"1.0.0\"\n \n+raw-body@^3.0.0:\n+  version \"3.0.0\"\n+  resolved \"https://registry.yarnpkg.com/raw-body/-/raw-body-3.0.0.tgz#25b3476f07a51600619dae3fe82ddc28a36e5e0f\"\n+  integrity sha512-RmkhL8CAyCRPXCE28MMH0z2PNWQBNk2Q09ZdxM9IOOXwxwZbN+qbWaatPkdkWIKL2ZVDImrN/pK5HTRz2PcS4g==\n+  dependencies:\n+    bytes \"3.1.2\"\n+    http-errors \"2.0.0\"\n+    iconv-lite \"0.6.3\"\n+    unpipe \"1.0.0\"\n+\n rc@^1.2.7:\n   version \"1.2.8\"\n   resolved \"https://registry.yarnpkg.com/rc/-/rc-1.2.8.tgz#cd924bf5200a075b83c188cd6b9e211b7fc0d3ed\"\n   integrity sha512-y3bGgqKj3QBdxLbLkomlohkvsA8gdAiUQlSBJnBhfn+BPxg4bc62d8TcBW15wavDfgexCgccckhcZvywyQYPOw==\n@@ -12492,8 +12785,19 @@\n   version \"1.3.3\"\n   resolved \"https://registry.yarnpkg.com/rope-sequence/-/rope-sequence-1.3.3.tgz#3f67fc106288b84b71532b4a5fd9d4881e4457f0\"\n   integrity sha512-85aZYCxweiD5J8yTEbw+E6A27zSnLPNDL0WfPdw3YYodq7WjnTKo0q4dtyQ2gz23iPT8Q9CUyJtAaUNcTxRf5Q==\n \n+router@^2.2.0:\n+  version \"2.2.0\"\n+  resolved \"https://registry.yarnpkg.com/router/-/router-2.2.0.tgz#019be620b711c87641167cc79b99090f00b146ef\"\n+  integrity sha512-nLTrUKm2UyiL7rlhapu/Zl45FwNgkZGaCpZbIHajDYgwlJCOzLSk+cIPAnsEqV955GjILJnKbdQC1nVPz+gAYQ==\n+  dependencies:\n+    debug \"^4.4.0\"\n+    depd \"^2.0.0\"\n+    is-promise \"^4.0.0\"\n+    parseurl \"^1.3.3\"\n+    path-to-regexp \"^8.0.0\"\n+\n run-parallel@^1.1.9:\n   version \"1.2.0\"\n   resolved \"https://registry.yarnpkg.com/run-parallel/-/run-parallel-1.2.0.tgz#66d1368da7bdf921eb9d95bd1a9229e7f21a43ee\"\n   integrity sha512-5l4VyZR86LZ/lDxZTR6jqL8AFE2S0IFLMP26AbjsLVADxHdhB/c0GUsH+y39UfCi3dzz8OlQuPmnaJOMoDHQBA==\n@@ -12554,9 +12858,9 @@\n     call-bind \"^1.0.6\"\n     es-errors \"^1.3.0\"\n     is-regex \"^1.1.4\"\n \n-\"safer-buffer@>= 2.1.2 < 3\", safer-buffer@^2.0.2, safer-buffer@^2.1.0, safer-buffer@~2.1.0:\n+\"safer-buffer@>= 2.1.2 < 3\", \"safer-buffer@>= 2.1.2 < 3.0.0\", safer-buffer@^2.0.2, safer-buffer@^2.1.0, safer-buffer@~2.1.0:\n   version \"2.1.2\"\n   resolved \"https://registry.yarnpkg.com/safer-buffer/-/safer-buffer-2.1.2.tgz#44fa161b0187b9549dd84bb91802f9bd8385cd6a\"\n   integrity sha512-YZo3K82SD7Riyi0E1EQPojLz7kpepnSQI9IyPbHHg1XXXevb5dJI7tpyN2ADxGcQbHG7vcyRHk0cbwqcQriUtg==\n \n@@ -12636,8 +12940,25 @@\n     on-finished \"2.4.1\"\n     range-parser \"~1.2.1\"\n     statuses \"2.0.1\"\n \n+send@^1.1.0, send@^1.2.0:\n+  version \"1.2.0\"\n+  resolved \"https://registry.yarnpkg.com/send/-/send-1.2.0.tgz#32a7554fb777b831dfa828370f773a3808d37212\"\n+  integrity sha512-uaW0WwXKpL9blXE2o0bRhoL2EGXIrZxQ2ZQ4mgcfoBxdFmQold+qWsD2jLrfZ0trjKL6vOw0j//eAwcALFjKSw==\n+  dependencies:\n+    debug \"^4.3.5\"\n+    encodeurl \"^2.0.0\"\n+    escape-html \"^1.0.3\"\n+    etag \"^1.8.1\"\n+    fresh \"^2.0.0\"\n+    http-errors \"^2.0.0\"\n+    mime-types \"^3.0.1\"\n+    ms \"^2.1.3\"\n+    on-finished \"^2.4.1\"\n+    range-parser \"^1.2.1\"\n+    statuses \"^2.0.1\"\n+\n serve-static@1.15.0:\n   version \"1.15.0\"\n   resolved \"https://registry.yarnpkg.com/serve-static/-/serve-static-1.15.0.tgz#faaef08cffe0a1a62f60cad0c4e513cff0ac9540\"\n   integrity sha512-XGuRDNjXUijsUL0vl6nSD7cwURuzEgglbOaFuZM9g3kwDXOWVTck0jLzjPzGD+TazWbboZYu52/9/XPdUgne9g==\n@@ -12646,8 +12967,18 @@\n     escape-html \"~1.0.3\"\n     parseurl \"~1.3.3\"\n     send \"0.18.0\"\n \n+serve-static@^2.2.0:\n+  version \"2.2.0\"\n+  resolved \"https://registry.yarnpkg.com/serve-static/-/serve-static-2.2.0.tgz#9c02564ee259bdd2251b82d659a2e7e1938d66f9\"\n+  integrity sha512-61g9pCh0Vnh7IutZjtLGGpTA355+OPn2TyDv/6ivP2h/AdAVX9azsoxmg2/M6nZeQZNYBEwIcsne1mJd9oQItQ==\n+  dependencies:\n+    encodeurl \"^2.0.0\"\n+    escape-html \"^1.0.3\"\n+    parseurl \"^1.3.3\"\n+    send \"^1.2.0\"\n+\n set-function-length@^1.1.1:\n   version \"1.1.1\"\n   resolved \"https://registry.yarnpkg.com/set-function-length/-/set-function-length-1.1.1.tgz#4bc39fafb0307224a33e106a7d35ca1218d659ed\"\n   integrity sha512-VoaqjbBJKiWtg4yRcKBQ7g7wnGnLV3M8oLvVWwOk2PdYY6PEFegR1vezXR0tw6fZGF9csVakIRjrJiy2veSBFQ==\n@@ -12752,8 +13083,37 @@\n   version \"1.8.1\"\n   resolved \"https://registry.yarnpkg.com/shell-quote/-/shell-quote-1.8.1.tgz#6dbf4db75515ad5bac63b4f1894c3a154c766680\"\n   integrity sha512-6j1W9l1iAs/4xYBI1SYOVZyFcCis9b4KCLQ8fgAGG07QvzaRLVVRQvAy85yNmmZSjYjg4MWh4gNvlPujU/5LpA==\n \n+side-channel-list@^1.0.0:\n+  version \"1.0.0\"\n+  resolved \"https://registry.yarnpkg.com/side-channel-list/-/side-channel-list-1.0.0.tgz#10cb5984263115d3b7a0e336591e290a830af8ad\"\n+  integrity sha512-FCLHtRD/gnpCiCHEiJLOwdmFP+wzCmDEkc9y7NsYxeF4u7Btsn1ZuwgwJGxImImHicJArLP4R0yX4c2KCrMrTA==\n+  dependencies:\n+    es-errors \"^1.3.0\"\n+    object-inspect \"^1.13.3\"\n+\n+side-channel-map@^1.0.1:\n+  version \"1.0.1\"\n+  resolved \"https://registry.yarnpkg.com/side-channel-map/-/side-channel-map-1.0.1.tgz#d6bb6b37902c6fef5174e5f533fab4c732a26f42\"\n+  integrity sha512-VCjCNfgMsby3tTdo02nbjtM/ewra6jPHmpThenkTYh8pG9ucZ/1P8So4u4FGBek/BjpOVsDCMoLA/iuBKIFXRA==\n+  dependencies:\n+    call-bound \"^1.0.2\"\n+    es-errors \"^1.3.0\"\n+    get-intrinsic \"^1.2.5\"\n+    object-inspect \"^1.13.3\"\n+\n+side-channel-weakmap@^1.0.2:\n+  version \"1.0.2\"\n+  resolved \"https://registry.yarnpkg.com/side-channel-weakmap/-/side-channel-weakmap-1.0.2.tgz#11dda19d5368e40ce9ec2bdc1fb0ecbc0790ecea\"\n+  integrity sha512-WPS/HvHQTYnHisLo9McqBHOJk2FkHO/tlpvldyrnem4aeQp4hai3gythswg6p01oSoTl58rcpiFAjF2br2Ak2A==\n+  dependencies:\n+    call-bound \"^1.0.2\"\n+    es-errors \"^1.3.0\"\n+    get-intrinsic \"^1.2.5\"\n+    object-inspect \"^1.13.3\"\n+    side-channel-map \"^1.0.1\"\n+\n side-channel@^1.0.4:\n   version \"1.0.4\"\n   resolved \"https://registry.yarnpkg.com/side-channel/-/side-channel-1.0.4.tgz#efce5c8fdc104ee751b25c58d4290011fa5ea2cf\"\n   integrity sha512-q5XPytqFEIKHkGdiMIrY10mvLRvnQh42/+GoBlFW3b2LXLE2xxJpZFdm94we0BaoV3RwJyGqg5wS7epxTv0Zvw==\n@@ -12771,8 +13131,19 @@\n     es-errors \"^1.3.0\"\n     get-intrinsic \"^1.2.4\"\n     object-inspect \"^1.13.1\"\n \n+side-channel@^1.1.0:\n+  version \"1.1.0\"\n+  resolved \"https://registry.yarnpkg.com/side-channel/-/side-channel-1.1.0.tgz#c3fcff9c4da932784873335ec9765fa94ff66bc9\"\n+  integrity sha512-ZX99e6tRweoUXqR+VBrslhda51Nh5MTQwou5tnUDgbtyM0dBgmhEDtWGP/xbKn6hqfPRHujUNwz5fy/wbbhnpw==\n+  dependencies:\n+    es-errors \"^1.3.0\"\n+    object-inspect \"^1.13.3\"\n+    side-channel-list \"^1.0.0\"\n+    side-channel-map \"^1.0.1\"\n+    side-channel-weakmap \"^1.0.2\"\n+\n signal-exit@^3.0.3, signal-exit@^3.0.7:\n   version \"3.0.7\"\n   resolved \"https://registry.yarnpkg.com/signal-exit/-/signal-exit-3.0.7.tgz#a9a1767f8af84155114eaabd73f99273c8f59ad9\"\n   integrity sha512-wnD2ZE+l+SPC/uoS0vXeE9L1+0wuaMqKlfz9AMUo38JsyLSBWSFcHR1Rri62LZc12vLr1gb3jl7iwQhgwpAbGQ==\n@@ -12926,8 +13297,13 @@\n   version \"2.0.1\"\n   resolved \"https://registry.yarnpkg.com/statuses/-/statuses-2.0.1.tgz#55cb000ccf1d48728bd23c685a063998cf1a1b63\"\n   integrity sha512-RwNA9Z/7PrK06rYLIzFMlaF+l73iwpzsqRIFgbMLbTcLD6cOao82TaWefPXQvB2fOC4AjuYSEndS7N/mTCbkdQ==\n \n+statuses@^2.0.1:\n+  version \"2.0.2\"\n+  resolved \"https://registry.yarnpkg.com/statuses/-/statuses-2.0.2.tgz#8f75eecef765b5e1cfcdc080da59409ed424e382\"\n+  integrity sha512-DvEy55V3DB7uknRo+4iOGT5fP1slR8wQohVdknigZPMpMstaKJQWhwiYBACJE3Ul2pTnATihhBYnRhZQHGBiRw==\n+\n stream-events@^1.0.5:\n   version \"1.0.5\"\n   resolved \"https://registry.yarnpkg.com/stream-events/-/stream-events-1.0.5.tgz#bbc898ec4df33a4902d892333d47da9bf1c406d5\"\n   integrity sha512-E1GUzBSgvct8Jsb3v2X15pjzN1tYebtbLaMg+eBOUOAxgbLoSbT2NS91ckc5lJD1KfLjId+jXJRgo0qnV5Nerg==\n@@ -13676,8 +14052,17 @@\n   version \"0.21.3\"\n   resolved \"https://registry.yarnpkg.com/type-fest/-/type-fest-0.21.3.tgz#d260a24b0198436e133fa26a524a6d65fa3b2e37\"\n   integrity sha512-t0rzBq87m3fVcduHDUFhKmyyX+9eo6WQjZvf51Ea/M0Q7+T374Jp1aUiyUl0GKxp8M/OETVHSDvmkyPgvX+X2w==\n \n+type-is@^2.0.0, type-is@^2.0.1:\n+  version \"2.0.1\"\n+  resolved \"https://registry.yarnpkg.com/type-is/-/type-is-2.0.1.tgz#64f6cf03f92fce4015c2b224793f6bdd4b068c97\"\n+  integrity sha512-OZs6gsjF4vMp32qrCbiVSkrFmXtG/AZhY3t0iAMrMBiAZyV9oALtXO8hsrHbMXF9x6L3grlFuwW2oAz7cav+Gw==\n+  dependencies:\n+    content-type \"^1.0.5\"\n+    media-typer \"^1.1.0\"\n+    mime-types \"^3.0.0\"\n+\n type-is@~1.6.18:\n   version \"1.6.18\"\n   resolved \"https://registry.yarnpkg.com/type-is/-/type-is-1.6.18.tgz#4e552cd05df09467dcbc4ef739de89f2cf37c131\"\n   integrity sha512-TkRKr9sUTxEH8MdfuCSP7VizJyzRNMjj2J2do2Jr3Kym598JVdEksuzPQCnlFPW4ky9Q+iA+ma9BGm06XQBy8g==\n@@ -13958,9 +14343,9 @@\n     \"@jridgewell/trace-mapping\" \"^0.3.12\"\n     \"@types/istanbul-lib-coverage\" \"^2.0.1\"\n     convert-source-map \"^1.6.0\"\n \n-vary@^1, vary@~1.1.2:\n+vary@^1, vary@^1.1.2, vary@~1.1.2:\n   version \"1.1.2\"\n   resolved \"https://registry.yarnpkg.com/vary/-/vary-1.1.2.tgz#2299f02c6ded30d4a5961b0b9f74524a18f634fc\"\n   integrity sha1-IpnwLG3tMNSllhsLn3RSShj2NPw=\n \n@@ -14299,8 +14684,13 @@\n   version \"3.23.5\"\n   resolved \"https://registry.yarnpkg.com/zod-to-json-schema/-/zod-to-json-schema-3.23.5.tgz#ec23def47dcafe3a4d640eba6a346b34f9a693a5\"\n   integrity sha512-5wlSS0bXfF/BrL4jPAbz9da5hDlDptdEppYfe+x4eIJ7jioqKG9uUxOwPzqof09u/XeVdrgFu29lZi+8XNDJtA==\n \n+zod-to-json-schema@^3.24.1:\n+  version \"3.24.6\"\n+  resolved \"https://registry.yarnpkg.com/zod-to-json-schema/-/zod-to-json-schema-3.24.6.tgz#5920f020c4d2647edfbb954fa036082b92c9e12d\"\n+  integrity sha512-h/z3PKvcTcTetyjl1fkj79MHNEjm+HpD6NXheWjzOekY7kV+lwDYnHw+ivHkijnCSMz1yJaWBD9vu/Fcmk+vEg==\n+\n zod@3.21.4:\n   version \"3.21.4\"\n   resolved \"https://registry.yarnpkg.com/zod/-/zod-3.21.4.tgz#10882231d992519f0a10b5dd58a38c9dabbb64db\"\n   integrity sha512-m46AKbrzKVzOzs/DZgVnG5H55N1sv1M8qZU3A8RIKbs3mrACDNeIOeilDymVb2HdmP8uwshOCF4uJ8uM9rCqJw==\n"
        }
      ]
    },
    {
      "id": "paginate-comment-threads",
      "sha": "0b36b52e47c0b09eefc0f4c7e62b1ac9dc7f68db",
      "parentSha": "0b8bb4847e740a0165ee2f9c660778a886e1edd6",
      "spec": "Implement incremental loading of contract comment threads and refactor contract tabs accordingly across backend, common, and web layers.\n\nBackend\n1) Add two API handlers to serve comment threads:\n- File: backend/api/src/get-comment-threads.ts\n  - Implement getContractCommentThreads: APIHandler<'comment-threads'>. Accepts contractId, limit (default 50 on server; schema default 10), and page (default 0). Create SupabaseDirectClient and return getCommentThreads(pg, { contractId, limit, page }).\n  - Implement getCommentThread: APIHandler<'comment-thread'>. Accepts contractId and commentId. Create SupabaseDirectClient and return getCommentThreadSupabase(pg, commentId, contractId).\n\n2) Register new routes:\n- File: backend/api/src/routes.ts\n  - Import getContractCommentThreads and getCommentThread.\n  - Add handlers mapping:\n    - 'comment-threads': getContractCommentThreads\n    - 'comment-thread': getCommentThread\n  - Keep existing handlers intact and ensure imports are ordered/consistent.\n\n3) Add shared Supabase queries for threads:\n- File: backend/shared/src/supabase/contract-comments.ts\n  - Implement getCommentThreads(pg, { contractId, limit, page }):\n    - Query top-level (parent) comments for the contract where replyToCommentId is null and not deleted, ordered by created_time desc, limited with offset page*limit.\n    - Query all replies whose replyToCommentId is in the set of parent comment IDs for that page, excluding deleted.\n    - Convert rows with convertContractComment and return an object with { parentComments, replyComments }.\n  - Implement getCommentThread(pg, commentId, contractId):\n    - Fetch the specified comment within the contract. Determine the parentId: if the comment is a reply, use its replyToCommentId; otherwise use its own id.\n    - Resolve parentComment (if the original was a reply fetch its parent; otherwise the same comment).\n    - Fetch replyComments for that parent ordered by created_time asc, excluding deleted.\n    - Fetch neighboring parent comments to provide context: those created after parentComment (newer parents) and up to a limited set of older parents (e.g., 3) around the parent’s created_time, excluding deleted.\n    - If there are any nextParentComments (older parents), fetch nextReplyComments for those parents ordered by created_time asc, excluding deleted.\n    - Return { parentComment, replyComments, parentComments, nextParentComments, nextReplyComments }.\n\nCommon\n4) Extend API schema with new endpoints:\n- File: common/src/api/schema.ts\n  - Add 'comment-threads' (GET, public, not authed) with props: { contractId: string, limit: number (0..100, default 10), page: number (>=0, default 0) }. Returns { replyComments: ContractComment[]; parentComments: ContractComment[] }.\n  - Add 'comment-thread' (GET, public, not authed) with props: { contractId: string; commentId: string }. Returns { parentComment: ContractComment | null; replyComments: ContractComment[]; parentComments: ContractComment[]; nextParentComments: ContractComment[]; nextReplyComments: ContractComment[] }.\n\n5) Fix pinned comments filter to treat JSON booleans as strings and exclude deleted using an OR condition:\n- File: common/src/supabase/comments.ts\n  - In getPinnedComments, change .eq('data->>pinned', 'true') and replace the deleted filter with .or('data->>deleted.eq.false,data->>deleted.is.null').\n\nFrontend: hooks and components\n6) Add a hook to page through comment threads:\n- File: web/hooks/use-comments.ts\n  - Implement useCommentThreads(contractId: string, limit: number, disabled: boolean) that manages { threads, loadMore, loading }.\n  - On loadMore, call api('comment-threads', { contractId, limit, page }) and group replies by replyToCommentId to assemble an array of threads { parent, replies }, append to state, and increment page. Auto-load on mount when not disabled.\n\n7) Extract CommentsTabContent into its own module and update logic to use paged threads:\n- File: web/components/contract/comments-tab-content.tsx\n  - Accept props: { staticContract, liveContract, comments, blockedUserIds, setCommentsLength?, replyTo?, clearReply?, className?, highlightCommentId?, pinnedComments, scrollToEnd? }.\n  - Use useCommentThreads(staticContract.id, 10, !!highlightCommentId) to fetch threads lazily. Subscribe to new comments via useSubscribeNewComments.\n  - When highlightCommentId is provided but not present locally, fetch api('comment-thread', { contractId, commentId }) and populate highlighted threads and surrounding context (parent, replies, nearby parent threads and their replies).\n  - Merge static comments, subscribed new comments, paged threads, and highlighted threads, de-duplicate by id, and filter out blocked users.\n  - Preserve existing sorting options (Best/Newest and Yes/No for binary) and pinned comments rendering. Update total length via setCommentsLength and render threads via ParentFeedComment and FeedCommentThread. Use VisibilityObserver to call loadMore on scroll. Show a LoadingIndicator when loading highlighted items or initial pages.\n\n8) Extract BetsTabContent into its own module:\n- File: web/components/contract/bets-tab-content.tsx\n  - Accept props: { contract, bets, totalBets, setReplyToBet? }.\n  - Preserve existing behavior: min-amount filter dropdown, listening for order updates, lazy loading more bets with api('bets', ...) when scrolled, rendering FeedBet, MultiNumericBetGroup, and FeedLiquidity entries, and showing skeleton loading rows.\n\n9) Update importing components to use the extracted modules:\n- File: web/components/contract/contract-tabs.tsx\n  - Remove inline definitions of CommentsTabContent and BetsTabContent. Import and use the new components to preserve tab behavior, counts, and tracking.\n- File: web/components/comments/comments-button.tsx\n  - Update import to use CommentsTabContent from web/components/contract/comments-tab-content.\n- File: web/components/contract/trades-button.tsx\n  - Update import to use BetsTabContent from web/components/contract/bets-tab-content.\n\nAcceptance criteria\n- Visiting a contract page loads an initial page of parent comments and their replies via GET /v0/comment-threads, and automatically loads additional pages as the user scrolls down.\n- Sorting options and pinned comments continue to work; comments from blocked users are excluded.\n- Visiting a contract with a URL hash or state indicating a specific commentId results in that thread being shown even if it wasn’t in the first page, by fetching GET /v0/comment-thread and including contextual neighbors.\n- The pinned comments Supabase query returns only non-deleted pinned comments.\n- Bets tab content behaves as before, now sourced from the extracted component.\n- New endpoints are documented in the API schema and registered in backend routes.",
      "prompt": "Add lazy-loaded comment threads to the contract page. Create backend endpoints to fetch parent comments with their replies in pages, and an endpoint to fetch a specific comment’s thread and nearby context by commentId. Update the shared schema and routes. On the frontend, add a hook to load comment threads page-by-page and refactor the contract page to use it so comments load as users scroll, still supporting sorting, pinned comments, blocking, and highlighting a specific comment. Extract the comments and bets tab content into dedicated components and update imports accordingly. Also ensure pinned comments are filtered correctly for deleted items.",
      "supplementalFiles": [
        "backend/api/src/helpers/endpoint.ts",
        "backend/shared/src/supabase/init.ts",
        "web/lib/api/api.ts",
        "common/src/comment.ts",
        "web/components/comments/comment-thread.tsx",
        "web/components/comments/comment.tsx",
        "web/components/widgets/visibility-observer.tsx",
        "client-common/hooks/use-comments.ts",
        "web/hooks/use-liquidity.ts",
        "web/components/feed/feed-bets.tsx",
        "web/components/feed/feed-liquidity.tsx"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/get-comment-threads.ts",
          "status": "added",
          "diff": "Index: backend/api/src/get-comment-threads.ts\n===================================================================\n--- backend/api/src/get-comment-threads.ts\t0b8bb48 (parent)\n+++ backend/api/src/get-comment-threads.ts\t0b36b52 (commit)\n@@ -0,0 +1,24 @@\n+import {\n+  getCommentThreads,\n+  getCommentThread as getCommentThreadSupabase,\n+} from 'shared/supabase/contract-comments'\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { type APIHandler } from './helpers/endpoint'\n+\n+export const getContractCommentThreads: APIHandler<'comment-threads'> = async (\n+  props\n+) => {\n+  const { contractId, limit, page } = props\n+  const pg = createSupabaseDirectClient()\n+  return await getCommentThreads(pg, {\n+    contractId,\n+    limit: limit ?? 50,\n+    page: page ?? 0,\n+  })\n+}\n+\n+export const getCommentThread: APIHandler<'comment-thread'> = async (props) => {\n+  const { contractId, commentId } = props\n+  const pg = createSupabaseDirectClient()\n+  return await getCommentThreadSupabase(pg, commentId, contractId)\n+}\n"
        },
        {
          "path": "backend/api/src/routes.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/routes.ts\n===================================================================\n--- backend/api/src/routes.ts\t0b8bb48 (parent)\n+++ backend/api/src/routes.ts\t0b36b52 (commit)\n@@ -1,182 +1,186 @@\n-import { updateMe } from './update-me'\n-import { placeBet } from './place-bet'\n-import { cancelBet } from './cancel-bet'\n-import { sellShares } from './sell-shares'\n-import { createMarket } from './create-market'\n-import { createComment } from './create-comment'\n-import { resolveMarket } from './resolve-market'\n-import { closeMarket } from './close-market'\n-import { getMe } from './get-me'\n-import { saveTwitchCredentials } from './save-twitch-credentials'\n-import { addLiquidity } from './add-liquidity'\n-import { removeLiquidity } from './remove-liquidity'\n-import { searchGroups, searchMyGroups } from './search-groups'\n-import { awardBounty } from './award-bounty'\n-import { addBounty } from './add-bounty'\n-import { createAnswerCPMM } from './create-answer-cpmm'\n-import { managram } from './managram'\n-import { setnews } from './set-news'\n-import { getDashboardFromSlug } from './get-dashboard-from-slug'\n-import { unresolve } from './unresolve'\n-import { updateMarket } from 'api/update-market'\n-import { type APIPath } from 'common/api/schema'\n-import { getMarkets } from 'api/markets'\n-import { hideComment } from './hide-comment'\n-import { pinComment } from './pin-comment'\n-import { getManagrams } from './get-managrams'\n-import { getGroups } from './get-groups'\n-import { getComments } from './get-comments'\n-import { getBetPointsBetween, getBets } from './get-bets'\n-import { getLiteUser, getUser } from './get-user'\n-import { getUsers } from './get-users'\n-import { getUserBalancesByIds, getUsersByIds } from './get-users-by-ids'\n-import { getMarket } from './get-market'\n-import { getMarketProb } from './get-market-prob'\n-import { getMarketProbs } from './get-market-probs'\n-import { getGroup } from './get-group'\n-import { getPositions } from './get-positions'\n-import { getLeagues } from './get-leagues'\n-import { getContract } from './get-contract'\n-import { getSingleAnswer } from './get-answer'\n-import { getContractAnswers } from './get-contract-answers'\n-import { addOrRemoveTopicFromContract } from './add-topic-to-market'\n-import { addOrRemoveTopicFromTopic } from './add-topic-to-topic'\n-import { searchUsers } from './search-users'\n-import { searchMarketsLite, searchMarketsFull } from './search-contracts'\n-import { post } from 'api/post'\n-import { fetchLinkPreview } from './fetch-link-preview'\n-import { type APIHandler } from './helpers/endpoint'\n-import { requestLoan } from 'api/request-loan'\n-import { getHeadlines, getPoliticsHeadlines } from './get-headlines'\n-import { getBoostAnalytics } from 'api/get-boost-analytics'\n-import { addOrRemoveReaction } from './reaction'\n-import { createManalink } from './create-manalink'\n-import { unlistAndCancelUserContracts } from './unlist-and-cancel-user-contracts'\n-import { getGroupsWithTopContracts } from 'api/get-topics-with-markets'\n-import { getBalanceChanges } from 'api/get-balance-changes'\n-import { placeMultiBet } from 'api/place-multi-bet'\n-import { getPartnerStats } from './get-partner-stats'\n-import { getSeenMarketIds } from 'api/get-seen-market-ids'\n-import { recordContractView } from 'api/record-contract-view'\n import { createPublicChatMessage } from 'api/create-public-chat-message'\n-import { getFollowedGroups } from './get-followed-groups'\n-import { getUniqueBetGroupCount } from 'api/get-unique-bet-groups'\n-import { deleteGroup } from './delete-group'\n-import { recordContractInteraction } from 'api/record-contract-interaction'\n-import { getUserPortfolio } from './get-user-portfolio'\n import { createuser } from 'api/create-user'\n-import { verifyPhoneNumber } from 'api/verify-phone-number'\n-import { requestOTP } from 'api/request-phone-otp'\n-import { multiSell } from 'api/multi-sell'\n-import { convertCashToMana } from './convert-cash-to-mana'\n-import { convertSpiceToMana } from './convert-sp-to-mana'\n-import { donate } from './donate'\n+import { getBalanceChanges } from 'api/get-balance-changes'\n+import { getBestComments } from 'api/get-best-comments'\n+import { getBoostAnalytics } from 'api/get-boost-analytics'\n import { getFeed } from 'api/get-feed'\n-import { getManaSupply } from './get-mana-supply'\n-import { getUserPortfolioHistory } from './get-user-portfolio-history'\n-import { deleteMe } from './delete-me'\n-import { updateModReport } from './update-mod-report'\n-import { getModReports } from './get-mod-reports'\n-import { searchContractPositions } from 'api/search-contract-positions'\n-import { blockUser, unblockUser } from './block-user'\n-import { blockGroup, unblockGroup } from './block-group'\n-import { blockMarket, unblockMarket } from './block-market'\n-import { getTxnSummaryStats } from 'api/get-txn-summary-stats'\n+import { getInterestingGroupsFromViews } from 'api/get-interesting-groups-from-views'\n import { getManaSummaryStats } from 'api/get-mana-summary-stats'\n-import { register } from 'api/gidx/register'\n-import { uploadDocument } from 'api/gidx/upload-document'\n-import { getVerificationStatus } from 'api/gidx/get-verification-status'\n-import { getCurrentPrivateUser } from './get-current-private-user'\n-import { updatePrivateUser } from './update-private-user'\n-import { setPushToken } from './push-token'\n-import { updateNotifSettings } from './update-notif-settings'\n-import { getVerificationDocuments } from 'api/gidx/get-verification-documents'\n-import { getMonitorStatus } from 'api/gidx/get-monitor-status'\n-import { getBestComments } from 'api/get-best-comments'\n-import { recordCommentView } from 'api/record-comment-view'\n+import { getNotifications } from 'api/get-notifications'\n import {\n   getChannelMemberships,\n   getChannelMessages,\n   getLastSeenChannelTime,\n   setChannelLastSeenTime,\n } from 'api/get-private-messages'\n-import { getNotifications } from 'api/get-notifications'\n-import { getCheckoutSession } from 'api/gidx/get-checkout-session'\n-import { completeCheckoutSession } from 'api/gidx/complete-checkout-session'\n-import { getContractTopics } from './get-contract-topics'\n-import { getRelatedMarkets } from './get-related-markets'\n-import { getRelatedMarketsByGroup } from './get-related-markets-by-group'\n-import { followContract } from './follow-contract'\n+import { getSeenMarketIds } from 'api/get-seen-market-ids'\n+import { getGroupsWithTopContracts } from 'api/get-topics-with-markets'\n+import { getTxnSummaryStats } from 'api/get-txn-summary-stats'\n+import { getUniqueBetGroupCount } from 'api/get-unique-bet-groups'\n import { getUserLimitOrdersWithContracts } from 'api/get-user-limit-orders-with-contracts'\n-import { getInterestingGroupsFromViews } from 'api/get-interesting-groups-from-views'\n import { completeCashoutSession } from 'api/gidx/complete-cashout-session'\n+import { completeCheckoutSession } from 'api/gidx/complete-checkout-session'\n+import { getCheckoutSession } from 'api/gidx/get-checkout-session'\n+import { getMonitorStatus } from 'api/gidx/get-monitor-status'\n+import { getVerificationDocuments } from 'api/gidx/get-verification-documents'\n+import { getVerificationStatus } from 'api/gidx/get-verification-status'\n+import { register } from 'api/gidx/register'\n+import { uploadDocument } from 'api/gidx/upload-document'\n+import { getMarkets } from 'api/markets'\n+import { multiSell } from 'api/multi-sell'\n+import { placeMultiBet } from 'api/place-multi-bet'\n+import { post } from 'api/post'\n+import { recordCommentView } from 'api/record-comment-view'\n+import { recordContractInteraction } from 'api/record-contract-interaction'\n+import { recordContractView } from 'api/record-contract-view'\n+import { requestLoan } from 'api/request-loan'\n+import { requestOTP } from 'api/request-phone-otp'\n+import { searchContractPositions } from 'api/search-contract-positions'\n+import { updateMarket } from 'api/update-market'\n+import { verifyPhoneNumber } from 'api/verify-phone-number'\n+import { type APIPath } from 'common/api/schema'\n+import { addBounty } from './add-bounty'\n+import { addLiquidity } from './add-liquidity'\n+import { addOrRemoveTopicFromContract } from './add-topic-to-market'\n+import { addOrRemoveTopicFromTopic } from './add-topic-to-topic'\n+import { awardBounty } from './award-bounty'\n+import { blockGroup, unblockGroup } from './block-group'\n+import { blockMarket, unblockMarket } from './block-market'\n+import { blockUser, unblockUser } from './block-user'\n+import { cancelBet } from './cancel-bet'\n+import { checkSportsEvent } from './check-sports-event'\n+import { closeMarket } from './close-market'\n+import { convertCashToMana } from './convert-cash-to-mana'\n+import { convertSpiceToMana } from './convert-sp-to-mana'\n+import { createAnswerCPMM } from './create-answer-cpmm'\n+import { createComment } from './create-comment'\n+import { createManalink } from './create-manalink'\n+import { createMarket } from './create-market'\n+import { deleteGroup } from './delete-group'\n+import { deleteMe } from './delete-me'\n+import { donate } from './donate'\n+import { fetchLinkPreview } from './fetch-link-preview'\n+import { followContract } from './follow-contract'\n+import { generateAIAnswers } from './generate-ai-answers'\n+import { generateAIDescription } from './generate-ai-description'\n+import { generateAIMarketSuggestions } from './generate-ai-market-suggestions'\n+import { getSingleAnswer } from './get-answer'\n+import { getBetPointsBetween, getBets } from './get-bets'\n import { getCashouts } from './get-cashouts'\n-import { getTxns } from './get-txns'\n-import { refreshAllClients } from './refresh-all-clients'\n-import { getLeaderboard } from './get-leaderboard'\n-import { toggleSystemTradingStatus } from './toggle-system-status'\n-import { completeCashoutRequest } from './gidx/complete-cashout-request'\n+import {\n+  getCommentThread,\n+  getContractCommentThreads,\n+} from './get-comment-threads'\n+import { getComments, getUserComments } from './get-comments'\n+import { getContract } from './get-contract'\n+import { getContractAnswers } from './get-contract-answers'\n+import { getContractTopics } from './get-contract-topics'\n+import { getCurrentPrivateUser } from './get-current-private-user'\n import { getDailyChangedMetricsAndContracts } from './get-daily-changed-metrics-and-contracts'\n+import { getDashboardFromSlug } from './get-dashboard-from-slug'\n+import { getFollowedGroups } from './get-followed-groups'\n+import { getGroup } from './get-group'\n+import { getGroups } from './get-groups'\n+import { getHeadlines, getPoliticsHeadlines } from './get-headlines'\n+import { getLeaderboard } from './get-leaderboard'\n+import { getLeagues } from './get-leagues'\n+import { getManaSupply } from './get-mana-supply'\n+import { getManagrams } from './get-managrams'\n+import { getMarket } from './get-market'\n+import { getMarketProb } from './get-market-prob'\n+import { getMarketProbs } from './get-market-probs'\n import { getMarketsByIds } from './get-markets'\n-import { getTopicTopics } from './get-topic-topics'\n-import { getTopicDashboards } from './get-topic-dashboards'\n-import { generateAIMarketSuggestions } from './generate-ai-market-suggestions'\n-import { generateAIDescription } from './generate-ai-description'\n-import { generateAIAnswers } from './generate-ai-answers'\n-import { getmonthlybets2024 } from './get-monthly-bets-2024'\n import { getmaxminprofit2024 } from './get-max-min-profit-2024'\n+import { getMe } from './get-me'\n+import { getModReports } from './get-mod-reports'\n+import { getmonthlybets2024 } from './get-monthly-bets-2024'\n import { getNextLoanAmount } from './get-next-loan-amount'\n-import { checkSportsEvent } from './check-sports-event'\n+import { getPartnerStats } from './get-partner-stats'\n+import { getPositions } from './get-positions'\n+import { getRelatedMarkets } from './get-related-markets'\n+import { getRelatedMarketsByGroup } from './get-related-markets-by-group'\n+import { getTopicDashboards } from './get-topic-dashboards'\n+import { getTopicTopics } from './get-topic-topics'\n+import { getTxns } from './get-txns'\n+import { getLiteUser, getUser } from './get-user'\n+import { getUserPortfolio } from './get-user-portfolio'\n+import { getUserPortfolioHistory } from './get-user-portfolio-history'\n+import { getUsers } from './get-users'\n+import { getUserBalancesByIds, getUsersByIds } from './get-users-by-ids'\n+import { completeCashoutRequest } from './gidx/complete-cashout-request'\n+import { type APIHandler } from './helpers/endpoint'\n+import { hideComment } from './hide-comment'\n+import { managram } from './managram'\n+import { pinComment } from './pin-comment'\n+import { placeBet } from './place-bet'\n+import { setPushToken } from './push-token'\n+import { addOrRemoveReaction } from './reaction'\n+import { refreshAllClients } from './refresh-all-clients'\n+import { removeLiquidity } from './remove-liquidity'\n+import { resolveMarket } from './resolve-market'\n+import { saveTwitchCredentials } from './save-twitch-credentials'\n+import { searchMarketsFull, searchMarketsLite } from './search-contracts'\n+import { searchGroups, searchMyGroups } from './search-groups'\n+import { searchUsers } from './search-users'\n+import { sellShares } from './sell-shares'\n+import { setnews } from './set-news'\n+import { toggleSystemTradingStatus } from './toggle-system-status'\n+import { unlistAndCancelUserContracts } from './unlist-and-cancel-user-contracts'\n+import { unresolve } from './unresolve'\n+import { updateMe } from './update-me'\n+import { updateModReport } from './update-mod-report'\n+import { updateNotifSettings } from './update-notif-settings'\n+import { updatePrivateUser } from './update-private-user'\n \n-import { createTask } from './create-task'\n-import { updateTask } from './update-task'\n import { createCategory } from './create-category'\n+import { createTask } from './create-task'\n import { getCategories } from './get-categories'\n-import { updateCategory } from './update-category'\n import { getTasks } from './get-tasks'\n+import { updateCategory } from './update-category'\n+import { updateTask } from './update-task'\n \n-import { getSiteActivity } from './get-site-activity'\n-import { isSportsInterested } from './is-sports-bettor'\n-import { getSportsGames } from './get-sports-games'\n-import { getMarketProps } from './get-market-props'\n-import { getUserContractMetricsWithContracts } from './get-user-contract-metrics-with-contracts'\n-import { validateiap } from './validate-iap'\n-import { getReactions } from './get-reactions'\n-import { markallnotificationsnew } from './mark-all-notifications-new'\n+import { createPost } from './create-post'\n+import { createPostComment } from './create-post-comment'\n+import { dismissUserReport } from './dismiss-user-report'\n+import { editPostComment, updatePostComment } from './edit-post-comment'\n+import { followPost } from './follow-post'\n import {\n-  getContractOptionVoters,\n-  getContractVoters,\n-} from './get-contract-voters'\n-import { purchaseContractBoost } from './purchase-boost'\n+  generateAIDateRanges,\n+  regenerateDateMidpoints,\n+} from './generate-ai-date-ranges'\n import {\n   generateAINumericRanges,\n   regenerateNumericMidpoints,\n } from './generate-ai-numeric-ranges'\n-import {\n-  generateAIDateRanges,\n-  regenerateDateMidpoints,\n-} from './generate-ai-date-ranges'\n-import { inferNumericUnit } from './infer-numeric-unit'\n import { generateConciseTitle } from './generate-concise-title'\n import { getCloseDateEndpoint } from './get-close-date'\n-import { referUser } from './refer-user'\n import {\n-  saveMarketDraft,\n-  getMarketDrafts,\n-  deleteMarketDraft,\n-} from './market-drafts'\n+  getContractOptionVoters,\n+  getContractVoters,\n+} from './get-contract-voters'\n+import { getMarketProps } from './get-market-props'\n+import { getPosts } from './get-posts'\n+import { getReactions } from './get-reactions'\n import { getSeasonInfo } from './get-season-info'\n+import { getSiteActivity } from './get-site-activity'\n+import { getSportsGames } from './get-sports-games'\n+import { getUserContractMetricsWithContracts } from './get-user-contract-metrics-with-contracts'\n+import { getUserLastActiveTime } from './get-user-last-active-time'\n+import { inferNumericUnit } from './infer-numeric-unit'\n+import { isSportsInterested } from './is-sports-bettor'\n import { markNotificationRead } from './mark-all-notifications'\n-import { createPostComment } from './create-post-comment'\n-import { createPost } from './create-post'\n+import { markallnotificationsnew } from './mark-all-notifications-new'\n+import {\n+  deleteMarketDraft,\n+  getMarketDrafts,\n+  saveMarketDraft,\n+} from './market-drafts'\n+import { purchaseContractBoost } from './purchase-boost'\n+import { referUser } from './refer-user'\n import { updatePost } from './update-post'\n-import { getPosts } from './get-posts'\n-import { dismissUserReport } from './dismiss-user-report'\n-import { followPost } from './follow-post'\n-import { editPostComment, updatePostComment } from './edit-post-comment'\n-import { getUserComments } from './get-comments'\n-import { getUserLastActiveTime } from './get-user-last-active-time'\n+import { validateiap } from './validate-iap'\n+\n export const handlers: { [k in APIPath]: APIHandler<k> } = {\n   'refresh-all-clients': refreshAllClients,\n   bet: placeBet,\n   'multi-bet': placeMultiBet,\n@@ -191,8 +195,10 @@\n   'get-channel-seen-time': getLastSeenChannelTime,\n   'set-channel-seen-time': setChannelLastSeenTime,\n   'get-contract': getContract,\n   comment: createComment,\n+  'comment-threads': getContractCommentThreads,\n+  'comment-thread': getCommentThread,\n   'hide-comment': hideComment,\n   'pin-comment': pinComment,\n   comments: getComments,\n   market: createMarket,\n"
        },
        {
          "path": "backend/shared/src/supabase/contract-comments.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/supabase/contract-comments.ts\n===================================================================\n--- backend/shared/src/supabase/contract-comments.ts\t0b8bb48 (parent)\n+++ backend/shared/src/supabase/contract-comments.ts\t0b36b52 (commit)\n@@ -1,9 +1,9 @@\n-import { convertContractComment } from 'common/supabase/comments'\n-import { SupabaseDirectClient } from 'shared/supabase/init'\n import { APIError } from 'common/api/utils'\n-import { millisToTs } from 'common/supabase/utils'\n import { ContractComment, PostComment } from 'common/comment'\n+import { convertContractComment } from 'common/supabase/comments'\n+import { millisToTs } from 'common/supabase/utils'\n+import { SupabaseDirectClient } from 'shared/supabase/init'\n \n export async function getCommentSafe(\n   pg: SupabaseDirectClient,\n   commentId: string\n@@ -26,8 +26,145 @@\n   }\n   return comment\n }\n \n+export async function getCommentThreads(\n+  pg: SupabaseDirectClient,\n+  filters: {\n+    contractId: string\n+    limit: number\n+    page: number\n+  }\n+) {\n+  const { contractId, limit, page } = filters\n+\n+  const allComments = await pg.map(\n+    `\n+    with parent_comments as (\n+      select cc.data, cc.likes, cc.comment_id from contract_comments cc\n+      where cc.contract_id = $1\n+      and (cc.data->>'replyToCommentId' is null)\n+      and (cc.data->>'deleted' is null or cc.data->>'deleted' = 'false')\n+      order by cc.created_time desc\n+      limit $2\n+      offset $3\n+    )\n+    select * from parent_comments\n+    union all\n+    select cc.data, cc.likes, cc.comment_id from contract_comments cc\n+    where cc.contract_id = $1\n+    and (cc.data->>'replyToCommentId' in (select comment_id from parent_comments))\n+    and (cc.data->>'deleted' is null or cc.data->>'deleted' = 'false')\n+    `,\n+    [contractId, limit, page * limit],\n+    convertContractComment\n+  )\n+\n+  const parentComments = allComments.filter((c) => !c.replyToCommentId)\n+  const replyComments = allComments.filter((c) => c.replyToCommentId)\n+  console.log('parentComments', parentComments.length)\n+  console.log('replyComments', replyComments.length)\n+\n+  return { parentComments, replyComments }\n+}\n+\n+export async function getCommentThread(\n+  pg: SupabaseDirectClient,\n+  commentId: string,\n+  contractId: string\n+) {\n+  const comment = await pg.oneOrNone(\n+    `\n+      select cc.data, cc.likes from contract_comments cc\n+      where cc.comment_id = $1 and cc.contract_id = $2\n+    `,\n+    [commentId, contractId],\n+    convertContractComment\n+  )\n+  if (!comment) {\n+    return {\n+      parentComment: null,\n+      replyComments: [],\n+      parentComments: [],\n+      nextParentComments: [],\n+      nextReplyComments: [],\n+    }\n+  }\n+\n+  const parentId = comment.replyToCommentId ?? comment.id\n+  const parentComment =\n+    comment.replyToCommentId && comment.replyToCommentId !== comment.id\n+      ? await pg.oneOrNone(\n+          `\n+      select cc.data, cc.likes from contract_comments cc\n+      where cc.comment_id = $1 and cc.contract_id = $2\n+    `,\n+          [parentId, contractId],\n+          convertContractComment\n+        )\n+      : comment\n+\n+  if (!parentComment) {\n+    return {\n+      parentComment: null,\n+      replyComments: [],\n+      parentComments: [],\n+      nextParentComments: [],\n+      nextReplyComments: [],\n+    }\n+  }\n+\n+  const results = await pg.multi(\n+    `\n+      select cc.data, cc.likes from contract_comments cc\n+      where cc.contract_id = $1\n+      and (cc.data->>'replyToCommentId' = $2)\n+      and (cc.data->>'deleted' is null or cc.data->>'deleted' = 'false')\n+      order by cc.created_time asc;\n+      select cc.data, cc.likes from contract_comments cc\n+      where cc.contract_id = $1\n+      and (cc.data->>'replyToCommentId' is null)\n+      and (cc.data->>'deleted' is null or cc.data->>'deleted' = 'false')\n+      and cc.created_time > $3\n+      order by cc.created_time desc;\n+      select cc.data, cc.likes from contract_comments cc\n+      where cc.contract_id = $1\n+      and (cc.data->>'replyToCommentId' is null)\n+      and (cc.data->>'deleted' is null or cc.data->>'deleted' = 'false')\n+      and cc.created_time < $3\n+      order by cc.created_time desc\n+      limit 3;\n+    `,\n+    [contractId, parentId, millisToTs(parentComment.createdTime)]\n+  )\n+  const replyComments = results[0].map(convertContractComment)\n+  const parentComments = results[1].map(convertContractComment)\n+  const nextParentComments = results[2].map(convertContractComment)\n+\n+  const nextReplyComments =\n+    nextParentComments.length > 0\n+      ? await pg.map(\n+          `\n+      select cc.data, cc.likes from contract_comments cc\n+      where cc.contract_id = $1\n+      and (cc.data->>'replyToCommentId' in ($2:csv))\n+      and (cc.data->>'deleted' is null or cc.data->>'deleted' = 'false')\n+      order by cc.created_time asc\n+    `,\n+          [contractId, nextParentComments.map((c) => c.id)],\n+          convertContractComment\n+        )\n+      : []\n+\n+  return {\n+    parentComment,\n+    replyComments,\n+    parentComments,\n+    nextParentComments,\n+    nextReplyComments,\n+  }\n+}\n+\n export async function getCommentsDirect(\n   pg: SupabaseDirectClient,\n   filters: {\n     userId?: string\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\t0b8bb48 (parent)\n+++ common/src/api/schema.ts\t0b36b52 (commit)\n@@ -951,8 +951,43 @@\n         order: z.enum(['shares', 'profit']).optional(),\n       })\n       .strict(),\n   },\n+  'comment-threads': {\n+    method: 'GET',\n+    visibility: 'public',\n+    authed: false,\n+    props: z\n+      .object({\n+        contractId: z.string(),\n+        limit: z.coerce.number().gte(0).lte(100).default(10),\n+        page: z.coerce.number().gte(0).default(0),\n+      })\n+      .strict(),\n+    cache: DEFAULT_CACHE_STRATEGY,\n+    returns: {} as {\n+      replyComments: ContractComment[]\n+      parentComments: ContractComment[]\n+    },\n+  },\n+  'comment-thread': {\n+    method: 'GET',\n+    visibility: 'public',\n+    authed: false,\n+    props: z\n+      .object({\n+        contractId: z.string(),\n+        commentId: z.string(),\n+      })\n+      .strict(),\n+    returns: {} as {\n+      parentComment: ContractComment | null\n+      replyComments: ContractComment[]\n+      parentComments: ContractComment[]\n+      nextParentComments: ContractComment[]\n+      nextReplyComments: ContractComment[]\n+    },\n+  },\n   me: {\n     method: 'GET',\n     visibility: 'public',\n     authed: true,\n"
        },
        {
          "path": "common/src/supabase/comments.ts",
          "status": "modified",
          "diff": "Index: common/src/supabase/comments.ts\n===================================================================\n--- common/src/supabase/comments.ts\t0b8bb48 (parent)\n+++ common/src/supabase/comments.ts\t0b36b52 (commit)\n@@ -60,10 +60,10 @@\n     db\n       .from('contract_comments')\n       .select('data')\n       .eq('contract_id', contractId)\n-      .eq('data->>pinned', true)\n-      .not('data->>deleted', 'eq', 'true')\n+      .eq('data->>pinned', 'true')\n+      .or('data->>deleted.eq.false,data->>deleted.is.null')\n       .order('created_time', { ascending: false })\n   )\n \n   const pinnedComments = data.map((c) => c.data as ContractComment)\n"
        },
        {
          "path": "web/components/comments/comments-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/comments/comments-button.tsx\n===================================================================\n--- web/components/comments/comments-button.tsx\t0b8bb48 (parent)\n+++ web/components/comments/comments-button.tsx\t0b36b52 (commit)\n@@ -3,9 +3,8 @@\n import clsx from 'clsx'\n import { Contract } from 'common/contract'\n import { Modal, SCROLLABLE_MODAL_CLASS } from '../layout/modal'\n import { Col } from '../layout/col'\n-import { CommentsTabContent } from '../contract/contract-tabs'\n import { usePrivateUser } from 'web/hooks/use-user'\n import { track } from 'web/lib/service/analytics'\n import { Tooltip } from '../widgets/tooltip'\n import { User } from 'common/user'\n@@ -14,8 +13,9 @@\n   useNumContractComments,\n } from 'web/hooks/use-comments'\n import { Button } from 'web/components/buttons/button'\n import { Row } from '../layout/row'\n+import { CommentsTabContent } from 'web/components/contract/comments-tab-content'\n \n export function CommentsButton(props: {\n   contract: Contract\n   user: User | null | undefined\n"
        },
        {
          "path": "web/components/contract/bets-tab-content.tsx",
          "status": "added",
          "diff": "Index: web/components/contract/bets-tab-content.tsx\n===================================================================\n--- web/components/contract/bets-tab-content.tsx\t0b8bb48 (parent)\n+++ web/components/contract/bets-tab-content.tsx\t0b36b52 (commit)\n@@ -0,0 +1,234 @@\n+import { memo, useEffect, useRef, useState } from 'react'\n+import { Contract, CPMMNumericContract, MarketContract } from 'common/contract'\n+import { Bet } from 'common/bet'\n+import { usePersistentInMemoryState } from 'client-common/hooks/use-persistent-in-memory-state'\n+import { listenToOrderUpdates } from 'client-common/hooks/use-bets'\n+import { groupBy, minBy, sortBy, uniqBy } from 'lodash'\n+import { useLiquidity } from 'web/hooks/use-liquidity'\n+import {\n+  DEV_HOUSE_LIQUIDITY_PROVIDER_ID,\n+  HOUSE_LIQUIDITY_PROVIDER_ID,\n+} from 'common/antes'\n+import { useEvent } from 'client-common/hooks/use-event'\n+import { api } from 'web/lib/api/api'\n+import { Row } from 'web/components/layout/row'\n+import DropdownMenu from 'web/components/widgets/dropdown-menu'\n+import generateFilterDropdownItems from 'web/components/search/search-dropdown-helpers'\n+import { track } from 'web/lib/service/analytics'\n+import { ChevronDownIcon } from '@heroicons/react/solid'\n+import { Col } from 'web/components/layout/col'\n+import { FeedBet } from 'web/components/feed/feed-bets'\n+import { MultiNumericBetGroup } from 'web/components/feed/feed-multi-numeric-bet-group'\n+import { FeedLiquidity } from 'web/components/feed/feed-liquidity'\n+import { LoadMoreUntilNotVisible } from 'web/components/widgets/visibility-observer'\n+\n+export const BetsTabContent = memo(function BetsTabContent(props: {\n+  contract: Contract\n+  bets: Bet[]\n+  totalBets: number\n+  setReplyToBet?: (bet: Bet) => void\n+}) {\n+  const { contract, setReplyToBet, totalBets } = props\n+  const { outcomeType } = contract\n+  const [olderBets, setOlderBets] = useState<Bet[]>([])\n+\n+  const [minAmountFilterIndex, setMinAmountFilterIndex] =\n+    usePersistentInMemoryState(0, `bet-amount-filter-${contract.id}`)\n+  const isNumber = outcomeType === 'NUMBER'\n+\n+  // Min amount filter options\n+  const minAmountOptions = [\n+    { label: 'Any amount', value: undefined },\n+    { label: 'M$100+', value: 100 },\n+    { label: 'M$1,000+', value: 1000 },\n+    { label: 'M$10,000+', value: 10000 },\n+  ]\n+  const selectedMinAmount = minAmountOptions[minAmountFilterIndex].value\n+\n+  // Filter initial bets on client side, server will filter olderBets\n+  const filteredInitialBets = selectedMinAmount\n+    ? props.bets.filter((bet) => Math.abs(bet.amount) >= selectedMinAmount)\n+    : props.bets\n+\n+  const bets = [...filteredInitialBets, ...olderBets]\n+  listenToOrderUpdates(contract.id, setOlderBets, true)\n+\n+  const oldestBet = minBy(bets, (b) => b.createdTime)\n+\n+  const lps = useLiquidity(contract.id) ?? []\n+  const visibleLps = lps.filter(\n+    (l) =>\n+      !l.isAnte &&\n+      l.userId !== HOUSE_LIQUIDITY_PROVIDER_ID &&\n+      l.userId !== DEV_HOUSE_LIQUIDITY_PROVIDER_ID &&\n+      l.amount > 0 &&\n+      !minAmountFilterIndex\n+  )\n+  const betsByBetGroupId = isNumber\n+    ? groupBy(bets, (bet) => bet.betGroupId ?? bet.id)\n+    : {}\n+  const groupedBets = Object.values(betsByBetGroupId)\n+\n+  const items = [\n+    ...(isNumber\n+      ? groupedBets.map((bets) => ({\n+          type: 'betGroup' as const,\n+          id: 'bets-tab-' + bets[0].betGroupId,\n+          bets,\n+        }))\n+      : bets.map((bet) => ({\n+          type: 'bet' as const,\n+          id: 'bets-tab-' + bet.id + '-' + 'false',\n+          bet,\n+        }))),\n+    ...visibleLps.map((lp) => ({\n+      type: 'liquidity' as const,\n+      id: lp.id,\n+      lp,\n+    })),\n+  ]\n+\n+  const totalItems = totalBets + visibleLps.length\n+  const totalLoadedItems = bets.length + visibleLps.length\n+\n+  const shouldLoadMore = totalLoadedItems < totalItems\n+  const [now] = useState(Date.now())\n+  const oldestBetTime = oldestBet?.createdTime ?? now\n+\n+  const loadMore = useEvent(async () => {\n+    if (!shouldLoadMore) return false\n+\n+    try {\n+      const newBets = await api('bets', {\n+        contractId: contract.id,\n+        beforeTime: oldestBetTime,\n+        limit: 50,\n+        filterRedemptions: !isNumber,\n+        includeZeroShareRedemptions: isNumber,\n+        minAmount: selectedMinAmount,\n+      })\n+\n+      if (newBets.length > 0) {\n+        setOlderBets((bets) => uniqBy([...bets, ...newBets], (b) => b.id))\n+        return true\n+      }\n+      return false\n+    } catch (err) {\n+      console.error(err)\n+      return false\n+    }\n+  })\n+  useEffect(() => {\n+    setOlderBets([])\n+    loadMore()\n+  }, [selectedMinAmount])\n+\n+  const allItems = sortBy(items, (item) =>\n+    item.type === 'bet'\n+      ? -item.bet.createdTime\n+      : item.type === 'liquidity'\n+      ? -item.lp.createdTime\n+      : item.type === 'betGroup'\n+      ? -item.bets[0].createdTime\n+      : undefined\n+  )\n+\n+  const scrollRef = useRef<HTMLDivElement>(null)\n+  const isCashContract = contract.token === 'CASH'\n+\n+  // Determine how many loading rows to show\n+  const numLoadingRows = shouldLoadMore\n+    ? Math.min(10, Math.max(0, totalBets - allItems.length))\n+    : 0\n+\n+  return (\n+    <>\n+      <div ref={scrollRef} />\n+\n+      {/* Minimum bet amount filter */}\n+      <Row className=\"mb-2\">\n+        <Row className=\"items-center gap-1\">\n+          <span className=\"text-ink-500 text-sm\">Min amount:</span>\n+          <DropdownMenu\n+            items={generateFilterDropdownItems(\n+              minAmountOptions.map((option, i) => ({\n+                label: option.label,\n+                value: i.toString(),\n+              })),\n+              (value: string) => {\n+                const newIndex = parseInt(value)\n+                setMinAmountFilterIndex(newIndex)\n+                setOlderBets([]) // Clear older bets to refetch with new filter\n+                track('change-bet-amount-filter', {\n+                  contractSlug: contract.slug,\n+                  contractName: contract.question,\n+                  minAmount: minAmountOptions[newIndex].value,\n+                })\n+              }\n+            )}\n+            buttonContent={\n+              <Row className=\"text-ink-700 w-28 items-center text-sm\">\n+                <span className=\"whitespace-nowrap\">\n+                  {minAmountOptions[minAmountFilterIndex].label}\n+                </span>\n+                <ChevronDownIcon className=\"h-4 w-4\" />\n+              </Row>\n+            }\n+            menuWidth={'w-36'}\n+            selectedItemName={minAmountOptions[minAmountFilterIndex].label}\n+            closeOnClick\n+          />\n+        </Row>\n+      </Row>\n+\n+      <Col className=\"mb-4 items-start gap-7\">\n+        {allItems.map((item) =>\n+          item.type === 'bet' ? (\n+            <FeedBet\n+              onReply={setReplyToBet}\n+              key={item.id}\n+              contract={contract as MarketContract}\n+              bet={item.bet}\n+            />\n+          ) : item.type === 'betGroup' ? (\n+            <MultiNumericBetGroup\n+              key={item.id}\n+              contract={contract as CPMMNumericContract}\n+              bets={item.bets}\n+            />\n+          ) : (\n+            <div\n+              key={item.id}\n+              className=\"-ml-2 rounded-full bg-gradient-to-r from-pink-300/50 via-purple-300/50 to-indigo-300/50 p-2\"\n+            >\n+              <FeedLiquidity\n+                liquidity={item.lp}\n+                isCashContract={isCashContract}\n+              />\n+            </div>\n+          )\n+        )}\n+        {/* Render skeleton loading rows */}\n+        {shouldLoadMore &&\n+          !minAmountFilterIndex &&\n+          Array(numLoadingRows)\n+            .fill(0)\n+            .map((_, i) => <LoadingBetRow key={`loading-${i}`} />)}\n+      </Col>\n+\n+      <LoadMoreUntilNotVisible loadMore={loadMore} />\n+    </>\n+  )\n+})\n+\n+function LoadingBetRow() {\n+  return (\n+    <div className=\"flex w-full animate-pulse gap-3 rounded-md \">\n+      {/* Avatar skeleton */}\n+      <div className=\"h-10 w-10 rounded-full bg-gray-500\" />\n+      <Col className=\"flex-1 justify-center gap-1.5\">\n+        <div className=\"h-4 w-1/2 rounded bg-gray-500\" />\n+      </Col>\n+    </div>\n+  )\n+}\n"
        },
        {
          "path": "web/components/contract/comments-tab-content.tsx",
          "status": "added",
          "diff": "Index: web/components/contract/comments-tab-content.tsx\n===================================================================\n--- web/components/contract/comments-tab-content.tsx\t0b8bb48 (parent)\n+++ web/components/contract/comments-tab-content.tsx\t0b36b52 (commit)\n@@ -0,0 +1,418 @@\n+import { ChevronDownIcon, ChevronUpIcon } from '@heroicons/react/solid'\n+import { useContractBets } from 'client-common/hooks/use-bets'\n+import { useSubscribeNewComments } from 'client-common/hooks/use-comments'\n+import { useEvent } from 'client-common/hooks/use-event'\n+import { usePersistentInMemoryState } from 'client-common/hooks/use-persistent-in-memory-state'\n+import clsx from 'clsx'\n+import { Answer } from 'common/answer'\n+import { Bet } from 'common/bet'\n+import { ContractComment } from 'common/comment'\n+import { Contract } from 'common/contract'\n+import { TRADE_TERM } from 'common/envs/constants'\n+import { buildArray } from 'common/util/array'\n+import { MINUTE_MS } from 'common/util/time'\n+import { groupBy, keyBy, mapValues, sortBy, sumBy, uniqBy } from 'lodash'\n+import { memo, useEffect, useMemo, useReducer, useRef, useState } from 'react'\n+import { Button } from 'web/components/buttons/button'\n+import { ParentFeedComment } from 'web/components/comments/comment'\n+import { ContractCommentInput } from 'web/components/comments/comment-input'\n+import { FeedCommentThread } from 'web/components/comments/comment-thread'\n+import { Col } from 'web/components/layout/col'\n+import { Row } from 'web/components/layout/row'\n+import generateFilterDropdownItems from 'web/components/search/search-dropdown-helpers'\n+import DropdownMenu from 'web/components/widgets/dropdown-menu'\n+import { LoadingIndicator } from 'web/components/widgets/loading-indicator'\n+import { Tooltip } from 'web/components/widgets/tooltip'\n+import { VisibilityObserver } from 'web/components/widgets/visibility-observer'\n+import { useCommentThreads } from 'web/hooks/use-comments'\n+import { useIsPageVisible } from 'web/hooks/use-page-visible'\n+import { useUser } from 'web/hooks/use-user'\n+import { api } from 'web/lib/api/api'\n+import { track } from 'web/lib/service/analytics'\n+\n+export const CommentsTabContent = memo(function CommentsTabContent(props: {\n+  staticContract: Contract // contains the comments\n+  liveContract: Contract // you trade on this\n+  comments: ContractComment[]\n+  blockedUserIds: string[]\n+  setCommentsLength?: (length: number) => void\n+  replyTo?: Answer | Bet\n+  clearReply?: () => void\n+  className?: string\n+  highlightCommentId?: string\n+  pinnedComments: ContractComment[]\n+  scrollToEnd?: boolean\n+}) {\n+  const {\n+    staticContract,\n+    liveContract,\n+    comments: staticComments,\n+    blockedUserIds,\n+    setCommentsLength,\n+    replyTo,\n+    clearReply,\n+    className,\n+    highlightCommentId,\n+    pinnedComments: staticPinnedComments,\n+    scrollToEnd,\n+  } = props\n+  const user = useUser()\n+\n+  const { threads, loadMore, loading } = useCommentThreads(\n+    staticContract.id,\n+    10,\n+    !!highlightCommentId\n+  )\n+  const [highlightedThreads, setHighlightedThreads] = useState<\n+    { parent: ContractComment; replies: ContractComment[] }[]\n+  >([])\n+  const [isLoadingHighlighted, setIsLoadingHighlighted] = useState(false)\n+\n+  const bets = useContractBets(\n+    staticContract.id,\n+    {\n+      commentRepliesOnly: true,\n+    },\n+    useIsPageVisible,\n+    (params) => api('bets', params)\n+  )\n+\n+  const newComments = useSubscribeNewComments(staticContract.id)\n+\n+  const allComments = useMemo(() => {\n+    const dynamicComments = threads.flatMap((t) => [t.parent, ...t.replies])\n+    const highlightedComments = highlightedThreads.flatMap((t) => [\n+      t.parent,\n+      ...t.replies,\n+    ])\n+    return uniqBy(\n+      [\n+        ...(newComments ?? []),\n+        ...staticComments,\n+        ...dynamicComments,\n+        ...highlightedComments,\n+      ],\n+      'id'\n+    ).filter((c) => !blockedUserIds.includes(c.userId))\n+  }, [newComments, staticComments, threads, highlightedThreads, blockedUserIds])\n+\n+  const commentExistsLocally = useMemo(\n+    () => allComments.some((c) => c.id === highlightCommentId),\n+    [allComments, highlightCommentId]\n+  )\n+\n+  const isLoadingHighlightedComment =\n+    !!highlightCommentId &&\n+    !commentExistsLocally &&\n+    (loading || isLoadingHighlighted)\n+\n+  useEffect(() => {\n+    if (highlightCommentId && !commentExistsLocally && !loading) {\n+      setIsLoadingHighlighted(true)\n+      api('comment-thread', {\n+        contractId: staticContract.id,\n+        commentId: highlightCommentId,\n+      }).then((res) => {\n+        const {\n+          parentComment,\n+          replyComments,\n+          parentComments,\n+          nextParentComments,\n+          nextReplyComments,\n+        } = res\n+        if (parentComment) {\n+          const newThreads = [\n+            { parent: parentComment, replies: replyComments },\n+            ...parentComments.map((p) => ({ parent: p, replies: [] })),\n+          ]\n+          if (nextParentComments) {\n+            const repliesByParent = groupBy(\n+              nextReplyComments,\n+              'replyToCommentId'\n+            )\n+            nextParentComments.forEach((p) => {\n+              newThreads.push({\n+                parent: p,\n+                replies: repliesByParent[p.id] ?? [],\n+              })\n+            })\n+          }\n+          setHighlightedThreads(newThreads)\n+        }\n+        setIsLoadingHighlighted(false)\n+      })\n+    }\n+  }, [highlightCommentId, commentExistsLocally, loading])\n+\n+  const isBinary = staticContract.outcomeType === 'BINARY'\n+  const isBountiedQuestion = staticContract.outcomeType == 'BOUNTIED_QUESTION'\n+  const bestFirst =\n+    isBountiedQuestion &&\n+    (!user || user.id !== staticContract.creatorId) &&\n+    !staticContract.isAutoBounty\n+\n+  const sorts = buildArray(\n+    bestFirst ? 'Best' : 'Newest',\n+    bestFirst ? 'Newest' : 'Best',\n+    isBinary && `Yes bets`,\n+    isBinary && 'No bets'\n+  )\n+\n+  const [sortIndex, setSortIndex] = usePersistentInMemoryState(\n+    0,\n+    `comments-sort-${staticContract.id}`\n+  )\n+  const sort = sorts[sortIndex]\n+\n+  const sortTooltip =\n+    sort === 'Best'\n+      ? isBountiedQuestion\n+        ? 'Highest bounty, then most likes'\n+        : 'Most likes first'\n+      : null\n+\n+  // replied to answers/comments are NOT newest, otherwise newest first\n+  const isReply = (c: ContractComment) => c.replyToCommentId !== undefined\n+\n+  const strictlySortedComments = sortBy(allComments, [\n+    sort === 'Best'\n+      ? (c) =>\n+          isReply(c)\n+            ? c.createdTime\n+            : // For your own recent comments, show first.\n+            c.createdTime > Date.now() - 10 * MINUTE_MS && c.userId === user?.id\n+            ? -Infinity\n+            : c.hidden\n+            ? Infinity\n+            : -(\n+                (c.bountyAwarded ?? 0) * 1000 +\n+                (c.likes ?? 0) -\n+                (c.dislikes ?? 0)\n+              )\n+      : sort === 'Yes bets'\n+      ? (c: ContractComment) => -(c.betReplyAmountsByOutcome?.['YES'] ?? 0)\n+      : sort === 'No bets'\n+      ? (c: ContractComment) => -(c.betReplyAmountsByOutcome?.['NO'] ?? 0)\n+      : // Newest\n+        (c) => c,\n+    (c) => (isReply(c) ? c.createdTime : c.hidden ? Infinity : -c.createdTime),\n+  ])\n+\n+  const commentsByParent = groupBy(\n+    strictlySortedComments,\n+    (c) => c.replyToCommentId ?? '_'\n+  )\n+\n+  const commentById = keyBy(allComments, 'id')\n+\n+  // lump comments on load/sort to prevent jumping\n+  const [frozenCommentIds, refreezeIds] = useReducer(\n+    () => strictlySortedComments.map((c) => c.id),\n+    strictlySortedComments.map((c) => c.id)\n+  )\n+  useEffect(() => {\n+    if (user) refreezeIds()\n+  }, [user?.id])\n+\n+  const firstOldCommentIndex = strictlySortedComments.findIndex((c) =>\n+    frozenCommentIds.includes(c.id)\n+  )\n+\n+  const sortedComments = [\n+    ...strictlySortedComments.slice(0, firstOldCommentIndex),\n+    // Lump the original comments in a contiguous chunk so they don't jump around.\n+    ...frozenCommentIds.map((id) => commentById[id]).filter(Boolean),\n+    ...strictlySortedComments\n+      .slice(firstOldCommentIndex)\n+      .filter((c) => !frozenCommentIds.includes(c.id)),\n+  ]\n+\n+  const parentComments = sortedComments.filter(\n+    (c) => c.replyToCommentId === undefined\n+  )\n+\n+  const childrensBounties = isBountiedQuestion\n+    ? mapValues(commentsByParent, (comments) =>\n+        sumBy(comments, (c) => c?.bountyAwarded ?? 0)\n+      )\n+    : {}\n+\n+  useEffect(() => {\n+    setCommentsLength?.(allComments.length)\n+  }, [allComments.length])\n+\n+  const pinnedComments = uniqBy(\n+    staticPinnedComments.concat(\n+      allComments.filter((comment) => comment.pinned)\n+    ),\n+    'id'\n+  )\n+  const onVisibilityUpdated = useEvent((visible: boolean) => {\n+    if (visible && !loading) loadMore()\n+  })\n+\n+  const endOfMessagesRef = useRef<any>(null)\n+\n+  useEffect(() => {\n+    if (endOfMessagesRef && scrollToEnd)\n+      endOfMessagesRef.current?.scrollIntoView({\n+        behavior: 'auto',\n+        block: 'start',\n+      })\n+  }, [endOfMessagesRef])\n+\n+  const [expandGptSummary, setExpandGptSummary] = usePersistentInMemoryState(\n+    false,\n+    `expand-gpt-summary-${staticContract.id}`\n+  )\n+\n+  function getSortLabel(sort: string) {\n+    if (sort == 'Yes bets') return `Yes ${TRADE_TERM}s`\n+    if (sort == 'No bets') return `No ${TRADE_TERM}s`\n+    return sort\n+  }\n+\n+  return (\n+    <Col className={clsx(className, scrollToEnd && 'flex-col-reverse')}>\n+      <div ref={endOfMessagesRef} />\n+      <ContractCommentInput\n+        autoFocus={false}\n+        replyTo={replyTo}\n+        className=\"mb-4 mr-px mt-px\"\n+        playContract={staticContract}\n+        clearReply={clearReply}\n+        trackingLocation={'contract page'}\n+        commentTypes={['comment', 'repost']}\n+      />\n+\n+      {staticContract.gptCommentSummary && (\n+        <Button\n+          className=\"mb-2 rounded-md bg-teal-100 p-4\"\n+          size=\"xs\"\n+          color=\"none\"\n+          onClick={() => setExpandGptSummary((e) => !e)}\n+        >\n+          <Col className=\"gap-2 p-2\">\n+            <Row className=\"items-center gap-2\">\n+              {expandGptSummary ? (\n+                <ChevronUpIcon className=\"h-5 w-5\" />\n+              ) : (\n+                <ChevronDownIcon className=\"h-5 w-5\" />\n+              )}\n+              <div className=\"text-lg\">Comments summary</div>\n+            </Row>\n+            <div\n+              className={clsx(\n+                'whitespace-pre-line text-left text-sm',\n+                !expandGptSummary && 'line-clamp-3'\n+              )}\n+            >\n+              {staticContract.gptCommentSummary}\n+            </div>\n+          </Col>\n+        </Button>\n+      )}\n+\n+      {allComments.length > 0 && (\n+        <Row className=\"justify-end\">\n+          <Tooltip text={sortTooltip}>\n+            <Row className=\"items-center gap-1\">\n+              <span className=\"text-ink-400 text-sm\">Sort by:</span>\n+              <DropdownMenu\n+                items={generateFilterDropdownItems(\n+                  sorts.map((s, i) => ({\n+                    label: getSortLabel(s),\n+                    value: i + '',\n+                  })),\n+                  (value: string) => {\n+                    const i = parseInt(value)\n+                    setSortIndex(i)\n+                    console.log(i)\n+                    refreezeIds()\n+                    track('change-comments-sort', {\n+                      contractSlug: staticContract.slug,\n+                      contractName: staticContract.question,\n+                      totalComments: allComments.length,\n+                      totalUniqueTraders: staticContract.uniqueBettorCount,\n+                    })\n+                  }\n+                )}\n+                buttonContent={\n+                  <Row className=\"text-ink-600 w-20 items-center text-sm\">\n+                    <span className=\"whitespace-nowrap\">\n+                      {getSortLabel(sort)}\n+                    </span>\n+                    <ChevronDownIcon className=\"h-4 w-4\" />\n+                  </Row>\n+                }\n+                menuWidth={'w-28'}\n+                selectedItemName={sort}\n+                closeOnClick\n+              />\n+            </Row>\n+          </Tooltip>\n+        </Row>\n+      )}\n+\n+      {pinnedComments.map((comment) => (\n+        <div key={comment.id} className={'pt-3'}>\n+          <ParentFeedComment\n+            comment={comment}\n+            playContract={staticContract}\n+            liveContract={liveContract}\n+            trackingLocation={'contract page'}\n+            seeReplies={false}\n+            numReplies={0}\n+            isPinned\n+          />\n+        </div>\n+      ))}\n+\n+      {isLoadingHighlightedComment ? (\n+        <Col className=\"h-32 items-center justify-center\">\n+          <LoadingIndicator />\n+        </Col>\n+      ) : (\n+        parentComments.map((parent) => (\n+          <FeedCommentThread\n+            key={parent.id}\n+            playContract={staticContract}\n+            liveContract={liveContract}\n+            parentComment={parent}\n+            threadComments={commentsByParent[parent.id] ?? []}\n+            trackingLocation={'contract page'}\n+            idInUrl={highlightCommentId}\n+            showReplies={\n+              !isBountiedQuestion ||\n+              (!!user && user.id === staticContract.creatorId)\n+            }\n+            childrenBountyTotal={\n+              staticContract.outcomeType == 'BOUNTIED_QUESTION'\n+                ? childrensBounties[parent.id]\n+                : undefined\n+            }\n+            bets={bets?.filter(\n+              (b: Bet) =>\n+                b.replyToCommentId &&\n+                [parent]\n+                  .concat(commentsByParent[parent.id] ?? [])\n+                  .map((c) => c.id)\n+                  .includes(b.replyToCommentId)\n+            )}\n+          />\n+        ))\n+      )}\n+      <div className=\"relative w-full\">\n+        <VisibilityObserver\n+          onVisibilityUpdated={onVisibilityUpdated}\n+          className=\"pointer-events-none absolute bottom-0 h-[75vh]\"\n+        />\n+      </div>\n+      {loading && (\n+        <Col className=\"h-32 items-center justify-center\">\n+          <LoadingIndicator />\n+        </Col>\n+      )}\n+    </Col>\n+  )\n+})\n"
        },
        {
          "path": "web/components/contract/contract-tabs.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-tabs.tsx\n===================================================================\n--- web/components/contract/contract-tabs.tsx\t0b8bb48 (parent)\n+++ web/components/contract/contract-tabs.tsx\t0b36b52 (commit)\n@@ -1,68 +1,19 @@\n-import {\n-  groupBy,\n-  keyBy,\n-  minBy,\n-  mapValues,\n-  sortBy,\n-  sumBy,\n-  uniqBy,\n-  maxBy,\n-} from 'lodash'\n-import { memo, useEffect, useMemo, useReducer, useRef, useState } from 'react'\n-import clsx from 'clsx'\n-import { ChevronDownIcon, ChevronUpIcon } from '@heroicons/react/solid'\n+import { useState } from 'react'\n \n import { Answer } from 'common/answer'\n-import {\n-  DEV_HOUSE_LIQUIDITY_PROVIDER_ID,\n-  HOUSE_LIQUIDITY_PROVIDER_ID,\n-} from 'common/antes'\n import { Bet } from 'common/bet'\n import { ContractComment } from 'common/comment'\n-import {\n-  BinaryContract,\n-  Contract,\n-  CPMMNumericContract,\n-  MarketContract,\n-} from 'common/contract'\n+import { BinaryContract, Contract } from 'common/contract'\n import { buildArray } from 'common/util/array'\n-import { shortFormatNumber, maybePluralize } from 'common/util/format'\n-import { MINUTE_MS } from 'common/util/time'\n+import { maybePluralize, shortFormatNumber } from 'common/util/format'\n+import { BetsTabContent } from 'web/components/contract/bets-tab-content'\n+import { CommentsTabContent } from 'web/components/contract/comments-tab-content'\n import { UserPositionsTable } from 'web/components/contract/user-positions-table'\n-import { LoadingIndicator } from 'web/components/widgets/loading-indicator'\n-import { Tooltip } from 'web/components/widgets/tooltip'\n-import {\n-  VisibilityObserver,\n-  LoadMoreUntilNotVisible,\n-} from 'web/components/widgets/visibility-observer'\n-import { useEvent } from 'client-common/hooks/use-event'\n-import { useLiquidity } from 'web/hooks/use-liquidity'\n-import { useUser } from 'web/hooks/use-user'\n+import { useHashInUrlPageRouter } from 'web/hooks/use-hash-in-url-page-router'\n import { track } from 'web/lib/service/analytics'\n-import { FeedBet } from '../feed/feed-bets'\n-import { FeedCommentThread } from '../comments/comment-thread'\n-import { ContractCommentInput } from '../comments/comment-input'\n-import { FeedLiquidity } from '../feed/feed-liquidity'\n import { Col } from '../layout/col'\n-import { Row } from '../layout/row'\n import { ControlledTabs } from '../layout/tabs'\n-import { usePersistentInMemoryState } from 'client-common/hooks/use-persistent-in-memory-state'\n-import { useSubscribeNewComments } from 'client-common/hooks/use-comments'\n-import { ParentFeedComment } from '../comments/comment'\n-import { useHashInUrlPageRouter } from 'web/hooks/use-hash-in-url-page-router'\n-import { MultiNumericBetGroup } from 'web/components/feed/feed-multi-numeric-bet-group'\n-import { Button } from '../buttons/button'\n-import DropdownMenu from '../widgets/dropdown-menu'\n-import generateFilterDropdownItems from '../search/search-dropdown-helpers'\n-import { useAPIGetter } from 'web/hooks/use-api-getter'\n-import { api } from 'web/lib/api/api'\n-import { TRADE_TERM } from 'common/envs/constants'\n-import {\n-  listenToOrderUpdates,\n-  useContractBets,\n-} from 'client-common/hooks/use-bets'\n-import { useIsPageVisible } from 'web/hooks/use-page-visible'\n \n export function ContractTabs(props: {\n   staticContract: Contract\n   liveContract: Contract\n@@ -175,580 +126,4 @@\n       )}\n     />\n   )\n }\n-\n-const LOAD_MORE = 10\n-export const CommentsTabContent = memo(function CommentsTabContent(props: {\n-  staticContract: Contract // contains the comments\n-  liveContract: Contract // you trade on this\n-  comments: ContractComment[]\n-  blockedUserIds: string[]\n-  setCommentsLength?: (length: number) => void\n-  replyTo?: Answer | Bet\n-  clearReply?: () => void\n-  className?: string\n-  highlightCommentId?: string\n-  pinnedComments: ContractComment[]\n-  scrollToEnd?: boolean\n-}) {\n-  const {\n-    staticContract,\n-    liveContract,\n-    blockedUserIds,\n-    setCommentsLength,\n-    replyTo,\n-    clearReply,\n-    className,\n-    highlightCommentId,\n-    scrollToEnd,\n-  } = props\n-  const user = useUser()\n-\n-  // Load all comments once\n-  const { data: fetchedComments, loading: commentsLoading } = useAPIGetter(\n-    'comments',\n-    {\n-      contractId: staticContract.id,\n-    },\n-    undefined,\n-    'comments-' + staticContract.id\n-  )\n-\n-  const bets = useContractBets(\n-    staticContract.id,\n-    {\n-      commentRepliesOnly: true,\n-    },\n-    useIsPageVisible,\n-    (params) => api('bets', params)\n-  )\n-  const latestCommentTime = useMemo(\n-    () => maxBy(fetchedComments, 'createdTime')?.createdTime,\n-    [fetchedComments?.length]\n-  )\n-\n-  const isPageVisible = useIsPageVisible()\n-  const { data: newFetchedComments, loading: newCommentsLoading } =\n-    useAPIGetter(\n-      'comments',\n-      {\n-        contractId: staticContract.id,\n-        afterTime: latestCommentTime,\n-      },\n-      undefined,\n-      'new-comments-' + staticContract.id,\n-      isPageVisible\n-    )\n-\n-  // Listen for new comments\n-  const newComments = useSubscribeNewComments(staticContract.id)\n-  const comments = uniqBy(\n-    [\n-      ...(newComments ?? []),\n-      ...(newFetchedComments ?? []),\n-      ...(fetchedComments ?? []),\n-      ...props.comments,\n-    ],\n-    'id'\n-  ).filter((c) => !blockedUserIds.includes(c.userId))\n-\n-  const commentExistsLocally = comments.some((c) => c.id === highlightCommentId)\n-  const isLoadingHighlightedComment =\n-    highlightCommentId &&\n-    !commentExistsLocally &&\n-    (commentsLoading || newCommentsLoading)\n-\n-  const [parentCommentsToRender, setParentCommentsToRender] = useState(\n-    props.comments.filter((c) => !c.replyToCommentId).length\n-  )\n-\n-  const isBinary = staticContract.outcomeType === 'BINARY'\n-  const isBountiedQuestion = staticContract.outcomeType == 'BOUNTIED_QUESTION'\n-  const bestFirst =\n-    isBountiedQuestion &&\n-    (!user || user.id !== staticContract.creatorId) &&\n-    !staticContract.isAutoBounty\n-\n-  const sorts = buildArray(\n-    bestFirst ? 'Best' : 'Newest',\n-    bestFirst ? 'Newest' : 'Best',\n-    isBinary && `Yes bets`,\n-    isBinary && 'No bets'\n-  )\n-\n-  const [sortIndex, setSortIndex] = usePersistentInMemoryState(\n-    0,\n-    `comments-sort-${staticContract.id}`\n-  )\n-  const sort = sorts[sortIndex]\n-\n-  const sortTooltip =\n-    sort === 'Best'\n-      ? isBountiedQuestion\n-        ? 'Highest bounty, then most likes'\n-        : 'Most likes first'\n-      : null\n-\n-  // replied to answers/comments are NOT newest, otherwise newest first\n-  const isReply = (c: ContractComment) => c.replyToCommentId !== undefined\n-\n-  const strictlySortedComments = sortBy(comments, [\n-    sort === 'Best'\n-      ? (c) =>\n-          isReply(c)\n-            ? c.createdTime\n-            : // For your own recent comments, show first.\n-            c.createdTime > Date.now() - 10 * MINUTE_MS && c.userId === user?.id\n-            ? -Infinity\n-            : c.hidden\n-            ? Infinity\n-            : -(\n-                (c.bountyAwarded ?? 0) * 1000 +\n-                (c.likes ?? 0) -\n-                (c.dislikes ?? 0)\n-              )\n-      : sort === 'Yes bets'\n-      ? (c: ContractComment) => -(c.betReplyAmountsByOutcome?.['YES'] ?? 0)\n-      : sort === 'No bets'\n-      ? (c: ContractComment) => -(c.betReplyAmountsByOutcome?.['NO'] ?? 0)\n-      : // Newest\n-        (c) => c,\n-    (c) => (isReply(c) ? c.createdTime : c.hidden ? Infinity : -c.createdTime),\n-  ])\n-\n-  const commentsByParent = groupBy(\n-    strictlySortedComments,\n-    (c) => c.replyToCommentId ?? '_'\n-  )\n-\n-  const commentById = keyBy(comments, 'id')\n-\n-  // lump comments on load/sort to prevent jumping\n-  const [frozenCommentIds, refreezeIds] = useReducer(\n-    () => strictlySortedComments.map((c) => c.id),\n-    strictlySortedComments.map((c) => c.id)\n-  )\n-  useEffect(() => {\n-    if (user) refreezeIds()\n-  }, [user?.id])\n-\n-  const firstOldCommentIndex = strictlySortedComments.findIndex((c) =>\n-    frozenCommentIds.includes(c.id)\n-  )\n-\n-  const sortedComments = [\n-    ...strictlySortedComments.slice(0, firstOldCommentIndex),\n-    // Lump the original comments in a contiguous chunk so they don't jump around.\n-    ...frozenCommentIds.map((id) => commentById[id]).filter(Boolean),\n-    ...strictlySortedComments\n-      .slice(firstOldCommentIndex)\n-      .filter((c) => !frozenCommentIds.includes(c.id)),\n-  ]\n-\n-  const parentComments = sortedComments.filter(\n-    (c) => c.replyToCommentId === undefined\n-  )\n-\n-  const childrensBounties = isBountiedQuestion\n-    ? mapValues(commentsByParent, (comments) =>\n-        sumBy(comments, (c) => c?.bountyAwarded ?? 0)\n-      )\n-    : {}\n-\n-  const visibleCommentIds = useMemo(\n-    () =>\n-      parentComments\n-        .slice(0, parentCommentsToRender)\n-        .map((c) => [c.id, ...(commentsByParent[c.id] ?? []).map((c) => c.id)])\n-        .flat(),\n-    [comments.length]\n-  )\n-\n-  useEffect(() => {\n-    if (highlightCommentId) {\n-      const currentlyVisible = visibleCommentIds.includes(highlightCommentId)\n-      if (!currentlyVisible) setParentCommentsToRender(comments.length)\n-    }\n-    setCommentsLength?.(comments.length)\n-  }, [highlightCommentId, comments.length])\n-\n-  const loadMore = () => setParentCommentsToRender((prev) => prev + LOAD_MORE)\n-  const pinnedComments = uniqBy(\n-    props.pinnedComments.concat(comments.filter((comment) => comment.pinned)),\n-    'id'\n-  )\n-  const onVisibilityUpdated = useEvent((visible: boolean) => {\n-    if (visible) loadMore()\n-  })\n-\n-  const endOfMessagesRef = useRef<any>(null)\n-\n-  useEffect(() => {\n-    if (endOfMessagesRef && scrollToEnd)\n-      endOfMessagesRef.current?.scrollIntoView({\n-        behavior: 'auto',\n-        block: 'start',\n-      })\n-  }, [endOfMessagesRef])\n-\n-  const [expandGptSummary, setExpandGptSummary] = usePersistentInMemoryState(\n-    false,\n-    `expand-gpt-summary-${staticContract.id}`\n-  )\n-\n-  function getSortLabel(sort: string) {\n-    if (sort == 'Yes bets') return `Yes ${TRADE_TERM}s`\n-    if (sort == 'No bets') return `No ${TRADE_TERM}s`\n-    return sort\n-  }\n-\n-  return (\n-    <Col className={clsx(className, scrollToEnd && 'flex-col-reverse')}>\n-      <div ref={endOfMessagesRef} />\n-      <ContractCommentInput\n-        autoFocus={false}\n-        replyTo={replyTo}\n-        className=\"mb-4 mr-px mt-px\"\n-        playContract={staticContract}\n-        clearReply={clearReply}\n-        trackingLocation={'contract page'}\n-        commentTypes={['comment', 'repost']}\n-      />\n-\n-      {staticContract.gptCommentSummary && (\n-        <Button\n-          className=\"mb-2 rounded-md bg-teal-100 p-4\"\n-          size=\"xs\"\n-          color=\"none\"\n-          onClick={() => setExpandGptSummary((e) => !e)}\n-        >\n-          <Col className=\"gap-2 p-2\">\n-            <Row className=\"items-center gap-2\">\n-              {expandGptSummary ? (\n-                <ChevronUpIcon className=\"h-5 w-5\" />\n-              ) : (\n-                <ChevronDownIcon className=\"h-5 w-5\" />\n-              )}\n-              <div className=\"text-lg\">Comments summary</div>\n-            </Row>\n-            <div\n-              className={clsx(\n-                'whitespace-pre-line text-left text-sm',\n-                !expandGptSummary && 'line-clamp-3'\n-              )}\n-            >\n-              {staticContract.gptCommentSummary}\n-            </div>\n-          </Col>\n-        </Button>\n-      )}\n-\n-      {comments.length > 0 && (\n-        <Row className=\"justify-end\">\n-          <Tooltip text={sortTooltip}>\n-            <Row className=\"items-center gap-1\">\n-              <span className=\"text-ink-400 text-sm\">Sort by:</span>\n-              <DropdownMenu\n-                items={generateFilterDropdownItems(\n-                  sorts.map((s, i) => ({\n-                    label: getSortLabel(s),\n-                    value: i + '',\n-                  })),\n-                  (value: string) => {\n-                    const i = parseInt(value)\n-                    setSortIndex(i)\n-                    console.log(i)\n-                    refreezeIds()\n-                    track('change-comments-sort', {\n-                      contractSlug: staticContract.slug,\n-                      contractName: staticContract.question,\n-                      totalComments: comments.length,\n-                      totalUniqueTraders: staticContract.uniqueBettorCount,\n-                    })\n-                  }\n-                )}\n-                buttonContent={\n-                  <Row className=\"text-ink-600 w-20 items-center text-sm\">\n-                    <span className=\"whitespace-nowrap\">\n-                      {getSortLabel(sort)}\n-                    </span>\n-                    <ChevronDownIcon className=\"h-4 w-4\" />\n-                  </Row>\n-                }\n-                menuWidth={'w-28'}\n-                selectedItemName={sort}\n-                closeOnClick\n-              />\n-            </Row>\n-          </Tooltip>\n-        </Row>\n-      )}\n-\n-      {pinnedComments.map((comment) => (\n-        <div key={comment.id} className={'pt-3'}>\n-          <ParentFeedComment\n-            comment={comment}\n-            playContract={staticContract}\n-            liveContract={liveContract}\n-            trackingLocation={'contract page'}\n-            seeReplies={false}\n-            numReplies={0}\n-            isPinned\n-          />\n-        </div>\n-      ))}\n-\n-      {isLoadingHighlightedComment ? (\n-        <Col className=\"h-32 items-center justify-center\">\n-          <LoadingIndicator />\n-        </Col>\n-      ) : (\n-        parentComments.slice(0, parentCommentsToRender).map((parent) => (\n-          <FeedCommentThread\n-            key={parent.id}\n-            playContract={staticContract}\n-            liveContract={liveContract}\n-            parentComment={parent}\n-            threadComments={commentsByParent[parent.id] ?? []}\n-            trackingLocation={'contract page'}\n-            idInUrl={highlightCommentId}\n-            showReplies={\n-              !isBountiedQuestion ||\n-              (!!user && user.id === staticContract.creatorId)\n-            }\n-            childrenBountyTotal={\n-              staticContract.outcomeType == 'BOUNTIED_QUESTION'\n-                ? childrensBounties[parent.id]\n-                : undefined\n-            }\n-            bets={bets?.filter(\n-              (b) =>\n-                b.replyToCommentId &&\n-                [parent]\n-                  .concat(commentsByParent[parent.id] ?? [])\n-                  .map((c) => c.id)\n-                  .includes(b.replyToCommentId)\n-            )}\n-          />\n-        ))\n-      )}\n-      <div className=\"relative w-full\">\n-        <VisibilityObserver\n-          onVisibilityUpdated={onVisibilityUpdated}\n-          className=\"pointer-events-none absolute bottom-0 h-[75vh]\"\n-        />\n-      </div>\n-    </Col>\n-  )\n-})\n-\n-export const BetsTabContent = memo(function BetsTabContent(props: {\n-  contract: Contract\n-  bets: Bet[]\n-  totalBets: number\n-  setReplyToBet?: (bet: Bet) => void\n-}) {\n-  const { contract, setReplyToBet, totalBets } = props\n-  const { outcomeType } = contract\n-  const [olderBets, setOlderBets] = useState<Bet[]>([])\n-\n-  const [minAmountFilterIndex, setMinAmountFilterIndex] =\n-    usePersistentInMemoryState(0, `bet-amount-filter-${contract.id}`)\n-  const isNumber = outcomeType === 'NUMBER'\n-\n-  // Min amount filter options\n-  const minAmountOptions = [\n-    { label: 'Any amount', value: undefined },\n-    { label: 'M$100+', value: 100 },\n-    { label: 'M$1,000+', value: 1000 },\n-    { label: 'M$10,000+', value: 10000 },\n-  ]\n-  const selectedMinAmount = minAmountOptions[minAmountFilterIndex].value\n-\n-  // Filter initial bets on client side, server will filter olderBets\n-  const filteredInitialBets = selectedMinAmount\n-    ? props.bets.filter((bet) => Math.abs(bet.amount) >= selectedMinAmount)\n-    : props.bets\n-\n-  const bets = [...filteredInitialBets, ...olderBets]\n-  listenToOrderUpdates(contract.id, setOlderBets, true)\n-\n-  const oldestBet = minBy(bets, (b) => b.createdTime)\n-\n-  const lps = useLiquidity(contract.id) ?? []\n-  const visibleLps = lps.filter(\n-    (l) =>\n-      !l.isAnte &&\n-      l.userId !== HOUSE_LIQUIDITY_PROVIDER_ID &&\n-      l.userId !== DEV_HOUSE_LIQUIDITY_PROVIDER_ID &&\n-      l.amount > 0 &&\n-      !minAmountFilterIndex\n-  )\n-  const betsByBetGroupId = isNumber\n-    ? groupBy(bets, (bet) => bet.betGroupId ?? bet.id)\n-    : {}\n-  const groupedBets = Object.values(betsByBetGroupId)\n-\n-  const items = [\n-    ...(isNumber\n-      ? groupedBets.map((bets) => ({\n-          type: 'betGroup' as const,\n-          id: 'bets-tab-' + bets[0].betGroupId,\n-          bets,\n-        }))\n-      : bets.map((bet) => ({\n-          type: 'bet' as const,\n-          id: 'bets-tab-' + bet.id + '-' + 'false',\n-          bet,\n-        }))),\n-    ...visibleLps.map((lp) => ({\n-      type: 'liquidity' as const,\n-      id: lp.id,\n-      lp,\n-    })),\n-  ]\n-\n-  const totalItems = totalBets + visibleLps.length\n-  const totalLoadedItems = bets.length + visibleLps.length\n-\n-  const shouldLoadMore = totalLoadedItems < totalItems\n-  const [now] = useState(Date.now())\n-  const oldestBetTime = oldestBet?.createdTime ?? now\n-\n-  const loadMore = useEvent(async () => {\n-    if (!shouldLoadMore) return false\n-\n-    try {\n-      const newBets = await api('bets', {\n-        contractId: contract.id,\n-        beforeTime: oldestBetTime,\n-        limit: 50,\n-        filterRedemptions: !isNumber,\n-        includeZeroShareRedemptions: isNumber,\n-        minAmount: selectedMinAmount,\n-      })\n-\n-      if (newBets.length > 0) {\n-        setOlderBets((bets) => uniqBy([...bets, ...newBets], (b) => b.id))\n-        return true\n-      }\n-      return false\n-    } catch (err) {\n-      console.error(err)\n-      return false\n-    }\n-  })\n-  useEffect(() => {\n-    setOlderBets([])\n-    loadMore()\n-  }, [selectedMinAmount])\n-\n-  const allItems = sortBy(items, (item) =>\n-    item.type === 'bet'\n-      ? -item.bet.createdTime\n-      : item.type === 'liquidity'\n-      ? -item.lp.createdTime\n-      : item.type === 'betGroup'\n-      ? -item.bets[0].createdTime\n-      : undefined\n-  )\n-\n-  const scrollRef = useRef<HTMLDivElement>(null)\n-  const isCashContract = contract.token === 'CASH'\n-\n-  // Determine how many loading rows to show\n-  const numLoadingRows = shouldLoadMore\n-    ? Math.min(10, Math.max(0, totalBets - allItems.length))\n-    : 0\n-\n-  return (\n-    <>\n-      <div ref={scrollRef} />\n-\n-      {/* Minimum bet amount filter */}\n-      <Row className=\"mb-2\">\n-        <Row className=\"items-center gap-1\">\n-          <span className=\"text-ink-500 text-sm\">Min amount:</span>\n-          <DropdownMenu\n-            items={generateFilterDropdownItems(\n-              minAmountOptions.map((option, i) => ({\n-                label: option.label,\n-                value: i.toString(),\n-              })),\n-              (value: string) => {\n-                const newIndex = parseInt(value)\n-                setMinAmountFilterIndex(newIndex)\n-                setOlderBets([]) // Clear older bets to refetch with new filter\n-                track('change-bet-amount-filter', {\n-                  contractSlug: contract.slug,\n-                  contractName: contract.question,\n-                  minAmount: minAmountOptions[newIndex].value,\n-                })\n-              }\n-            )}\n-            buttonContent={\n-              <Row className=\"text-ink-700 w-28 items-center text-sm\">\n-                <span className=\"whitespace-nowrap\">\n-                  {minAmountOptions[minAmountFilterIndex].label}\n-                </span>\n-                <ChevronDownIcon className=\"h-4 w-4\" />\n-              </Row>\n-            }\n-            menuWidth={'w-36'}\n-            selectedItemName={minAmountOptions[minAmountFilterIndex].label}\n-            closeOnClick\n-          />\n-        </Row>\n-      </Row>\n-\n-      <Col className=\"mb-4 items-start gap-7\">\n-        {allItems.map((item) =>\n-          item.type === 'bet' ? (\n-            <FeedBet\n-              onReply={setReplyToBet}\n-              key={item.id}\n-              contract={contract as MarketContract}\n-              bet={item.bet}\n-            />\n-          ) : item.type === 'betGroup' ? (\n-            <MultiNumericBetGroup\n-              key={item.id}\n-              contract={contract as CPMMNumericContract}\n-              bets={item.bets}\n-            />\n-          ) : (\n-            <div\n-              key={item.id}\n-              className=\"-ml-2 rounded-full bg-gradient-to-r from-pink-300/50 via-purple-300/50 to-indigo-300/50 p-2\"\n-            >\n-              <FeedLiquidity\n-                liquidity={item.lp}\n-                isCashContract={isCashContract}\n-              />\n-            </div>\n-          )\n-        )}\n-        {/* Render skeleton loading rows */}\n-        {shouldLoadMore &&\n-          !minAmountFilterIndex &&\n-          Array(numLoadingRows)\n-            .fill(0)\n-            .map((_, i) => <LoadingBetRow key={`loading-${i}`} />)}\n-      </Col>\n-\n-      <LoadMoreUntilNotVisible loadMore={loadMore} />\n-    </>\n-  )\n-})\n-\n-function LoadingBetRow() {\n-  return (\n-    <div className=\"flex w-full animate-pulse gap-3 rounded-md \">\n-      {/* Avatar skeleton */}\n-      <div className=\"h-10 w-10 rounded-full bg-gray-500\" />\n-      <Col className=\"flex-1 justify-center gap-1.5\">\n-        <div className=\"h-4 w-1/2 rounded bg-gray-500\" />\n-      </Col>\n-    </div>\n-  )\n-}\n"
        },
        {
          "path": "web/components/contract/trades-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/trades-button.tsx\n===================================================================\n--- web/components/contract/trades-button.tsx\t0b8bb48 (parent)\n+++ web/components/contract/trades-button.tsx\t0b36b52 (commit)\n@@ -6,9 +6,8 @@\n import { MODAL_CLASS, Modal, SCROLLABLE_MODAL_CLASS } from '../layout/modal'\n import { Row } from '../layout/row'\n import { LoadingIndicator } from '../widgets/loading-indicator'\n import { Tooltip } from '../widgets/tooltip'\n-import { BetsTabContent } from './contract-tabs'\n import { UserPositionsTable } from 'web/components/contract/user-positions-table'\n import { UncontrolledTabs } from 'web/components/layout/tabs'\n import { Col } from 'web/components/layout/col'\n import { Avatar } from '../widgets/avatar'\n@@ -23,8 +22,9 @@\n import { shortenNumber } from 'common/util/formatNumber'\n import { useBetsOnce } from 'client-common/hooks/use-bets'\n import { api } from 'web/lib/api/api'\n import { useAPIGetter } from 'web/hooks/use-api-getter'\n+import { BetsTabContent } from 'web/components/contract/bets-tab-content'\n \n export function TradesButton(props: {\n   contract: Contract\n   answer?: Answer\n"
        },
        {
          "path": "web/hooks/use-comments.ts",
          "status": "modified",
          "diff": "Index: web/hooks/use-comments.ts\n===================================================================\n--- web/hooks/use-comments.ts\t0b8bb48 (parent)\n+++ web/hooks/use-comments.ts\t0b36b52 (commit)\n@@ -1,17 +1,17 @@\n+import { useApiSubscription } from 'client-common/hooks/use-api-subscription'\n+import { usePersistentInMemoryState } from 'client-common/hooks/use-persistent-in-memory-state'\n import { ContractComment } from 'common/comment'\n+import { convertContractComment } from 'common/supabase/comments'\n+import { groupBy, sortBy, uniqBy } from 'lodash'\n import { useEffect, useState } from 'react'\n-import { sortBy, uniqBy } from 'lodash'\n+import { api } from 'web/lib/api/api'\n import {\n   getAllCommentRows,\n   getComment,\n   getCommentThread,\n   getNumContractComments,\n } from 'web/lib/supabase/comments'\n-import { convertContractComment } from 'common/supabase/comments'\n-import { api } from 'web/lib/api/api'\n-import { usePersistentInMemoryState } from 'client-common/hooks/use-persistent-in-memory-state'\n-import { useApiSubscription } from 'client-common/hooks/use-api-subscription'\n \n export function useNumContractComments(contractId: string) {\n   const [numComments, setNumComments] = useState<number>(0)\n \n@@ -98,4 +98,41 @@\n   }, [limit])\n \n   return comments\n }\n+\n+export const useCommentThreads = (\n+  contractId: string,\n+  limit: number,\n+  disabled: boolean\n+) => {\n+  const [threads, setThreads] = useState<\n+    { parent: ContractComment; replies: ContractComment[] }[]\n+  >([])\n+  const [page, setPage] = useState(0)\n+  const [loading, setLoading] = useState(false)\n+\n+  const loadMore = async () => {\n+    if (loading) return\n+    setLoading(true)\n+    const { parentComments, replyComments } = await api('comment-threads', {\n+      contractId,\n+      limit,\n+      page,\n+    })\n+    const repliesByParent = groupBy(replyComments, 'replyToCommentId')\n+    const newThreads = parentComments.map((p) => ({\n+      parent: p,\n+      replies: repliesByParent[p.id] ?? [],\n+    }))\n+    setThreads((t) => [...t, ...newThreads])\n+    setPage((p) => p + 1)\n+    setLoading(false)\n+  }\n+\n+  useEffect(() => {\n+    if (disabled) return\n+    loadMore()\n+  }, [contractId, disabled])\n+\n+  return { threads, loadMore, loading }\n+}\n"
        }
      ]
    },
    {
      "id": "update-user-metrics",
      "sha": "92e7f9845db5d661a5a22417a2d67c605ac8bcf2",
      "parentSha": "27592ace21c788e6a57c40a39a2a430b5e771f41",
      "spec": "Implement probability-change-based updates for user metrics on contracts without recent user bets and integrate them into the daily/periodic user metric updater.\n\nMake the following changes:\n\n1) common/src/calculate-metrics.ts\n- Export a new function calculateMetricsFromProbabilityChanges(userMetrics: ContractMetric[], contractsById: Record<string, Contract>): ContractMetric[].\n  - For each metric in userMetrics:\n    - Find the corresponding contract in contractsById using metric.contractId. If not found, return the metric unchanged.\n    - Determine the current probability (newProb):\n      - If contract.mechanism === 'cpmm-1', use contract.prob.\n      - If contract.mechanism === 'cpmm-multi-1' and metric.answerId is present, locate the answer by id in contract.answers and use answer.prob. If no answer found, return the metric unchanged.\n      - For other mechanisms, return the metric unchanged.\n    - Use calculateProfitMetricsAtProbOrCancel(newProb, metric) to compute the updated profit-related fields for the metric at the new probability, preserving other fields.\n    - For each period in {day, week, month}, compute the period change object based on the contract or answer probChanges for that period:\n      - probChange :=\n        - For cpmm-1: contract.probChanges[period] or 0 if absent.\n        - For cpmm-multi-1 with metric.answerId: the matching answer.probChanges[period] or 0 if absent.\n      - prevProb = newProb - probChange.\n      - Using metric.totalShares.YES and metric.totalShares.NO (default 0), compute prevValue = YES*prevProb + NO*(1 - prevProb) and currentValue = YES*newProb + NO*(1 - newProb).\n      - profit = currentValue - prevValue.\n      - invested = metric.totalAmountInvested (use the numeric value, avoid division by zero; if zero or falsy, cap denominator to 1 when computing profitPercent).\n      - profitPercent = (profit / invested) * 100.\n      - For each period, set { profit, profitPercent, invested: metric.totalAmountInvested, prevValue, value: currentValue }.\n    - Return the updated metric with the from field containing day/week/month objects as above.\n\n2) backend/shared/src/update-user-metric-periods.ts\n- Import the new function from common/calculate-metrics.\n- In updateUserMetricPeriods(...):\n  - Change the logging to reflect the two-phase process (processing users, finding contracts with recent betting activity, loading bets for those, loading metrics for contracts without recent activity).\n  - Before loading bets, query for contract IDs with recent bets by the active users since the supplied timestamp:\n    - Add a new helper getContractIdsWithRecentBets(pg, userIds, since) that returns distinct contract_id from contract_bets where user_id in (userIds) and created_time > since.\n  - Modify the existing bet-loading to only fetch bets for those contractIds:\n    - Update getUnresolvedOrRecentlyResolvedBets signature to accept (pg, userIds, since, contractIds) and include a filter cb.contract_id in ($3:list).\n    - Add a condition to exclude cpmm-multi-1 redemption rows: and (c.mechanism != 'cpmm-multi-1' or not cb.is_redemption).\n  - Add a new helper getContractMetricsWithoutRecentBets(pg, userIds, since, contractIdsWithRecentBets):\n    - Query user_contract_metrics ucm joined to contracts c and left joined to answers a.\n    - Filter: ucm.user_id in (userIds), ucm.has_shares = true, and contracts/answers unresolved at the given time (c.resolution_time is null or > since; and a.resolution_time is null or > since for answer metrics).\n    - Exclude metrics where ucm.contract_id is in the recent contract id list (only if that list is non-empty).\n    - Return ContractMetric instances by mapping ucm.id and the JSON ucm.data.\n  - Build the set of contract IDs to load contract/answer data for as a union of contractIdsWithRecentBets and the contractIds from contractMetricsWithoutRecentBets. Only pass contractIds with recent bets into the query that loads current user_contract_metrics for fresh bets.\n  - When assembling currentContractMetrics, combine the metrics loaded from DB for recent-bet contracts with the metrics from getContractMetricsWithoutRecentBets into a single array for subsequent processing.\n  - For each user:\n    - Compute freshMetricsFromBets using the existing calculateMetricsByContractAndAnswer over the bet groups by contractId.\n    - Compute freshMetricsFromProbChanges by calling calculateMetricsFromProbabilityChanges with the metrics from getContractMetricsWithoutRecentBets filtered to that userId and contractsById.\n    - Combine freshMetrics = freshMetricsFromBets + freshMetricsFromProbChanges and merge them with current metrics for the user, deduping by contractId + answerId.\n\n- Ensure all newly added helper functions are located in the same file (update-user-metric-periods.ts) and use SupabaseDirectClient consistently.\n- Preserve existing behavior for contracts with recent bets; only augment metrics for contracts without recent bets via probability changes.\n\n3) SQL and data handling expectations\n- getContractIdsWithRecentBets uses distinct contract_id and the since parameter converted to ISO timestamp.\n- getContractMetricsWithoutRecentBets and getUnresolvedOrRecentlyResolvedBets filter out resolved contracts/answers beyond the since threshold as per existing patterns.\n- getUnresolvedOrRecentlyResolvedBets returns an empty object if the provided contractIds list is empty.\n\nObservable outcomes:\n- The periodic updater updates user metrics not only for contracts users bet on recently but also for contracts where they still hold shares via probability changes since the given period start.\n- Metrics for those unbet contracts reflect updated profit and from.{day,week,month} deltas based on contract/answer probChanges.\n- Bet loading is reduced to only contracts with recent activity and excludes cpmm-multi-1 redemption rows.",
      "prompt": "Enhance the user metric update job so that users’ positions on contracts they haven’t bet on recently are still updated based on each contract’s or answer’s probability changes. Add a calculator that, given a user’s existing position and the latest probabilities and period probability deltas, updates their profit values and the day/week/month change fields. Then, update the metric updater to:\n- Identify contracts with recent betting activity and only load bets for those;\n- Load existing user_contract_metrics for contracts without recent bets where the user still has shares and the market/answer hasn’t resolved during the period;\n- Recompute and merge metrics for both sets (bets and non-bets), excluding multi-answer redemption rows from recent bets;\n- Maintain all existing behavior for recent-bet contracts.\n\nUse the types’ probability-change fields already present on contracts and answers, and integrate the new calculator so the updater updates both sets in the same run.",
      "supplementalFiles": [
        "common/src/contract-metric.ts",
        "common/src/contract.ts",
        "common/src/answer.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/shared/src/update-user-metric-periods.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/update-user-metric-periods.ts\n===================================================================\n--- backend/shared/src/update-user-metric-periods.ts\t27592ac (parent)\n+++ backend/shared/src/update-user-metric-periods.ts\t92e7f98 (commit)\n@@ -1,6 +1,7 @@\n import {\n   calculateMetricsByContractAndAnswer,\n+  calculateMetricsFromProbabilityChanges,\n   isEmptyMetric,\n } from 'common/calculate-metrics'\n import { Contract, CPMMMultiContract } from 'common/contract'\n import { ContractMetric } from 'common/contract-metric'\n@@ -77,31 +78,57 @@\n   log(`Loaded ${allActiveUserIds.length} active users.`)\n   const chunks = chunk(allActiveUserIds, CHUNK_SIZE)\n   const metricsByUser: Record<string, ContractMetric[]> = {}\n   const contractsById: Record<string, Contract> = {}\n+\n   for (const activeUserIds of chunks) {\n-    log(`Loading bets for ${activeUserIds.length} users`)\n-    // TODO: we could calculate changes for all contracts where the user hasn't bet in the past 24 hours by\n-    // using their current metrics and the prob changes of the contracts/answers. Then we'd\n-    // only have to load the bets for the contracts that they've bet on in the past 24 hours.\n-    // To calculte those easy changes, youd' just take their yes/no shares in each contract-answer\n-    // and multiply by the prob change of the contract-answer.\n-    const metricRelevantBets = await getUnresolvedOrRecentlyResolvedBets(\n+\n+    log(`Processing ${activeUserIds.length} users`)\n+\n+    // First, find contracts that users have bet on recently\n+    log(`Finding contracts with recent betting activity...`)\n+    const contractIdsWithRecentBets = await getContractIdsWithRecentBets(\n       pg,\n       activeUserIds,\n       since\n     )\n+\n+    // Load bets for contracts with recent activity\n+    log(`Loading bets for contracts with recent activity...`)\n+    const metricRelevantBets = await getUnresolvedOrRecentlyResolvedBets(\n+      pg,\n+      activeUserIds,\n+      since,\n+      contractIdsWithRecentBets\n+    )\n     log(\n       `Loaded ${sumBy(\n         Object.values(metricRelevantBets),\n         (bets) => bets.length\n       )} bets.`\n     )\n \n-    const allBets = Object.values(metricRelevantBets).flat()\n-    const contractIds = uniq(allBets.map((b) => b.contractId))\n-    if (contractIds.length === 0) continue\n-    const newContractIds: string[] = contractIds.filter(\n+    // Get metrics for contracts WITHOUT recent betting activity\n+    log(`Loading metrics for contracts without recent betting activity...`)\n+    const contractMetricsWithoutRecentBets =\n+      await getContractMetricsWithoutRecentBets(\n+        pg,\n+        activeUserIds,\n+        since,\n+        contractIdsWithRecentBets\n+      )\n+\n+    const contractIdsWithoutBets = uniq(\n+      contractMetricsWithoutRecentBets.map((m) => m.contractId)\n+    )\n+    const allContractIds = uniq([\n+      ...contractIdsWithRecentBets,\n+      ...contractIdsWithoutBets,\n+    ])\n+\n+    if (allContractIds.length === 0) continue\n+\n+    const newContractIds: string[] = allContractIds.filter(\n       (c) => !contractsById[c]\n     )\n     log('Loading contracts, answers, users, and current contract metrics...')\n     // We could cache the contracts and answers to query for less data\n@@ -119,11 +146,15 @@\n       }\n \n       select id, data from user_contract_metrics\n       where user_id in ($2:list)\n-      and contract_id in ($3:list);\n+      and contract_id in ($3:list)\n     `,\n-      [newContractIds, activeUserIds, contractIds]\n+      [\n+        newContractIds,\n+        activeUserIds,\n+        allContractIds.filter((c) => !contractIdsWithoutBets.includes(c)),\n+      ]\n     )\n     const contracts = results[0].map(convertContract)\n     const answers = results[1].map(convertAnswer)\n     contracts.forEach((c) => {\n@@ -134,11 +165,11 @@\n         } as CPMMMultiContract\n       else contractsById[c.id] = c\n     })\n \n-    const currentContractMetrics = results[2].map(\n-      (r) => ({ id: r.id, ...r.data } as ContractMetric)\n-    )\n+    const currentContractMetrics = results[2]\n+      .map((r) => ({ id: r.id, ...r.data } as ContractMetric))\n+      .concat(contractMetricsWithoutRecentBets)\n \n     log(\n       `Loaded ${contracts.length} contracts,\n        ${answers.length} answers,\n@@ -157,20 +188,37 @@\n \n     log('Computing metric updates...')\n     for (const userId of activeUserIds) {\n       const userMetricRelevantBets = metricRelevantBets[userId] ?? []\n+      const userMetricsWithoutBets = contractMetricsWithoutRecentBets.filter(\n+        (m) => m.userId === userId\n+      )\n \n+      // Calculate metrics for contracts with recent bets (existing logic)\n       const metricRelevantBetsByContract = groupBy(\n         userMetricRelevantBets,\n         (b) => b.contractId\n       )\n       const currentMetricsForUser = currentMetricsByUserId[userId] ?? []\n-      const freshMetrics = calculateMetricsByContractAndAnswer(\n+      const freshMetricsFromBets = calculateMetricsByContractAndAnswer(\n         metricRelevantBetsByContract,\n         contractsById,\n         userId,\n         currentMetricsForUser\n       )\n+\n+      // Calculate metrics for contracts without recent bets using probability changes\n+      const freshMetricsFromProbChanges =\n+        calculateMetricsFromProbabilityChanges(\n+          userMetricsWithoutBets,\n+          contractsById\n+        )\n+\n+      const freshMetrics = [\n+        ...freshMetricsFromBets,\n+        ...freshMetricsFromProbChanges,\n+      ]\n+\n       metricsByUser[userId] = uniqBy(\n         [...freshMetrics, ...currentMetricsForUser],\n         (m) => m.contractId + m.answerId\n       )\n@@ -240,25 +288,86 @@\n   log('Finished updating user period metrics')\n   return { metricsByUser, contractsById }\n }\n \n-const getUnresolvedOrRecentlyResolvedBets = async (\n+// New function to get contract IDs with recent betting activity\n+const getContractIdsWithRecentBets = async (\n   pg: SupabaseDirectClient,\n   userIds: string[],\n   since: number\n ) => {\n+  const contractIds = await pg.map(\n+    `\n+    select distinct cb.contract_id\n+    from contract_bets cb\n+      where cb.user_id in ($1:list)\n+      and cb.created_time > $2\n+    `,\n+    [userIds, new Date(since).toISOString()],\n+    (r) => r.contract_id as string\n+  )\n+\n+  return contractIds\n+}\n+\n+const getContractMetricsWithoutRecentBets = async (\n+  pg: SupabaseDirectClient,\n+  userIds: string[],\n+  since: number,\n+  contractIdsWithRecentBets: string[]\n+) => {\n+  const excludeClause =\n+    contractIdsWithRecentBets.length > 0\n+      ? 'and ucm.contract_id not in ($3:list)'\n+      : ''\n+\n+  const metrics = await pg.map(\n+    `\n+    select ucm.id, ucm.data\n+    from user_contract_metrics ucm\n+    join contracts c on ucm.contract_id = c.id\n+    left join answers a on ucm.answer_id = a.id\n+    where ucm.user_id in ($1:list)\n+      and ucm.has_shares = true\n+      and (c.resolution_time is null or c.resolution_time > $2)\n+      and (a is null or a.resolution_time is null or a.resolution_time > $2)\n+      ${excludeClause}\n+    `,\n+    [userIds, new Date(since).toISOString(), contractIdsWithRecentBets],\n+    (r) =>\n+      ({\n+        id: r.id as number,\n+        ...r.data,\n+      } as ContractMetric)\n+  )\n+\n+  return metrics\n+}\n+\n+const getUnresolvedOrRecentlyResolvedBets = async (\n+  pg: SupabaseDirectClient,\n+  userIds: string[],\n+  since: number,\n+  contractIds: string[]\n+) => {\n+  if (contractIds.length === 0) {\n+    return {}\n+  }\n+\n   const bets = await pg.map(\n     `\n     select cb.amount, cb.shares, cb.outcome, cb.loan_amount, cb.user_id, cb.answer_id, cb.contract_id, cb.created_time, cb.is_redemption\n     from contract_bets as cb\n     join contracts as c on cb.contract_id = c.id\n     left join answers as a on cb.answer_id = a.id\n     where\n       cb.user_id in ($1:list)\n+      and cb.contract_id in ($3:list)\n+      and (c.mechanism != 'cpmm-multi-1' or not cb.is_redemption)\n       and (c.resolution_time is null or c.resolution_time > $2)\n       and (a is null or a.resolution_time is null or a.resolution_time > $2)\n     `,\n-    [userIds, new Date(since).toISOString()],\n+    [userIds, new Date(since).toISOString(), contractIds],\n     convertBet\n   )\n \n   return groupBy(\n"
        },
        {
          "path": "common/src/calculate-metrics.ts",
          "status": "modified",
          "diff": "Index: common/src/calculate-metrics.ts\n===================================================================\n--- common/src/calculate-metrics.ts\t27592ac (parent)\n+++ common/src/calculate-metrics.ts\t92e7f98 (commit)\n@@ -1,4 +1,5 @@\n+import { ContractMetric, isSummary } from 'common/contract-metric'\n import {\n   cloneDeep,\n   Dictionary,\n   first,\n@@ -8,19 +9,18 @@\n   sum,\n   sumBy,\n   uniq,\n } from 'lodash'\n+import { Bet, LimitBet } from './bet'\n import {\n   calculateTotalSpentAndShares,\n   getContractBetMetricsPerAnswerWithoutLoans,\n } from './calculate'\n-import { Bet, LimitBet } from './bet'\n-import { Contract, MultiContract } from './contract'\n import { computeFills, CpmmState, getCpmmProbability } from './calculate-cpmm'\n-import { removeUndefinedProps } from './util/object'\n-import { floatingEqual, logit } from './util/math'\n-import { ContractMetric, isSummary } from 'common/contract-metric'\n+import { Contract, MultiContract } from './contract'\n import { noFees } from './fees'\n+import { floatingEqual, logit } from './util/math'\n+import { removeUndefinedProps } from './util/object'\n \n export const computeInvestmentValueCustomProb = (\n   bets: Bet[],\n   contract: Contract,\n@@ -571,4 +571,79 @@\n   }\n \n   return { metricsByContract }\n }\n+\n+export const calculateMetricsFromProbabilityChanges = (\n+  userMetrics: ContractMetric[],\n+  contractsById: Record<string, Contract>\n+): ContractMetric[] => {\n+  return userMetrics.map((metric) => {\n+    const contract = contractsById[metric.contractId]\n+    if (!contract) return metric\n+\n+    let newProb: number\n+    if (contract.mechanism === 'cpmm-multi-1' && metric.answerId) {\n+      const answer = contract.answers.find((a) => a.id === metric.answerId)\n+      if (!answer) return metric\n+      newProb = answer.prob\n+    } else if (contract.mechanism === 'cpmm-1') {\n+      newProb = contract.prob\n+    } else {\n+      return metric\n+    }\n+\n+    // Calculate new metrics based on probability change\n+    const updatedMetric = calculateProfitMetricsAtProbOrCancel(newProb, metric)\n+\n+    // Calculate period profit changes (from calculatePeriodProfit logic)\n+    const calculatePeriodChange = (period: 'day' | 'week' | 'month') => {\n+      let probChange: number\n+      if (contract.mechanism === 'cpmm-multi-1' && metric.answerId) {\n+        const answer = contract.answers.find((a) => a.id === metric.answerId)\n+        probChange = answer?.probChanges[period] ?? 0\n+      } else if (contract.mechanism === 'cpmm-1') {\n+        probChange = contract.probChanges?.[period] ?? 0\n+      } else {\n+        probChange = 0\n+      }\n+\n+      const prevProb = newProb - probChange\n+      const { totalShares, totalAmountInvested = 0 } = metric\n+\n+      // Calculate value change based on shares and probability change\n+      const yesShares = totalShares.YES ?? 0\n+      const noShares = totalShares.NO ?? 0\n+\n+      const prevValue = yesShares * prevProb + noShares * (1 - prevProb)\n+      const currentValue = yesShares * newProb + noShares * (1 - newProb)\n+      const valueChange = currentValue - prevValue\n+\n+      const profit = valueChange\n+      const invested =\n+        totalAmountInvested > 0\n+          ? totalAmountInvested\n+          : Math.abs(totalAmountInvested) || 1\n+      const profitPercent = (profit / invested) * 100\n+\n+      return {\n+        profit,\n+        profitPercent,\n+        invested: totalAmountInvested,\n+        prevValue,\n+        value: currentValue,\n+      }\n+    }\n+\n+    // Update the from field with period changes\n+    const from = {\n+      day: calculatePeriodChange('day'),\n+      week: calculatePeriodChange('week'),\n+      month: calculatePeriodChange('month'),\n+    }\n+\n+    return {\n+      ...updatedMetric,\n+      from,\n+    }\n+  })\n+}\n"
        }
      ]
    },
    {
      "id": "downsample-portfolio-history",
      "sha": "0b8bb4847e740a0165ee2f9c660778a886e1edd6",
      "parentSha": "c65e289c933c1b2e2b23a004fe1178c367d3fb52",
      "spec": "Implement downsampling of old portfolio history points and update the API and scheduler accordingly.\n\n1) API: get-user-portfolio-history\n- File: backend/api/src/get-user-portfolio-history.ts\n- Behavior change when period === 'allTime':\n  - Use a cutoff equivalent to the start of the last monthly period rather than null. Compute cutoff using getCutoff('monthly') and use that as the start date.\n  - Run a combined query to return up to 1000 random points newer than the cutoff and, additionally, all points older than one month.\n  - Merge both result sets, convert with convertPortfolioHistory, and return the combined list sorted ascending by timestamp.\n- For non-allTime periods: behavior remains as returning up to 1000 random points newer than the computed cutoff, then sort by timestamp.\n\n2) Scheduled job wiring\n- File: backend/scheduler/src/jobs/index.ts\n- Register a new daily job named 'downsample-portfolio-history' scheduled for 4:50 AM (cron: '0 50 4 * * *') that executes shared/downsample-portfolio-history.downsamplePortfolioHistory.\n- Remove the existing 'update-cash-stats' job registration from the daily jobs list.\n- Ensure imports are present for the new function. Do not change other job behaviors.\n\n3) Downsampling function\n- File: backend/shared/src/downsample-portfolio-history.ts (new)\n- Export an async function downsamplePortfolioHistory() that:\n  - Uses createSupabaseDirectClient() and the shared/utils log() function for logging.\n  - Selects eligible user IDs to process: users with a non-null lastBetTime, created more than one month ago, and either not present in portfolios_processed or last_processed older than one week. Support a test mode constant that limits to a specific user ID when true.\n  - For each user, inside a transaction:\n    - Identify user-days older than one month for which user_portfolio_history has more than 4 points (daily_count > 4) using date_trunc('day', ts).\n    - If none, skip.\n    - For those user-days, delete all corresponding rows from user_portfolio_history, returning the deleted rows.\n    - Insert all deleted rows into user_portfolio_history_archive with identical fields preserved.\n    - Compute new aggregated points by grouping the deleted points into 6-hour bins within each day (four bins per day starting at 00:00). For each bin, insert one new row into user_portfolio_history with averaged numeric fields (balance, cash_balance, cash_investment_value, investment_value, loan_total, profit, spice_balance, total_cash_deposits, total_deposits) and timestamps corresponding to the start of each 6-hour bin.\n    - Upsert into portfolios_processed with user_id and set last_processed = now().\n  - Log start and finish and the number of users processed.\n\n4) SQL schema additions\n- Files: \n  - backend/supabase/user_portfolio_history_archive.sql (new)\n    - Create table user_portfolio_history_archive with columns matching user_portfolio_history (numeric portfolio fields, ts timestamp without time zone, user_id text, id bigint primary key identity). Enable RLS and add a permissive public read policy for select. No triggers.\n  - backend/supabase/portfolios_processed.sql (new)\n    - Create table portfolios_processed with primary key user_id (text) and last_processed timestamptz default now(). Enable RLS. No policies are required beyond enabling RLS.\n- Ensure these files mirror the style used by other Supabase schema files (autogenerated header comment where used, RLS enable lines).\n\n5) Test harness update\n- File: backend/shared/src/test-backend-function.ts\n- Replace the previously called debug function with an invocation of downsamplePortfolioHistory() so the job can be executed manually in a debug run. Keep other commented-out debug lines intact.\n\nAcceptance criteria\n- Calling the API endpoint get-user-portfolio-history with period='allTime' returns a chronologically sorted series that includes recent points from the last month (limited to 1000 random samples) combined with all older points (which, after the job runs, are at most four per day due to 6-hour downsampling), converted via convertPortfolioHistory.\n- Running the scheduled job daily inserts aggregated 6-hour-binned points for eligible user-days older than one month when there are more than 4 points per day, archives the original points, and updates portfolios_processed.\n- New SQL tables exist and RLS is enabled; user_portfolio_history existing behavior remains unchanged for new inserts by other processes.\n- The 'update-cash-stats' job is no longer scheduled.\n- No TypeScript type errors; queries run under pg-promise using existing helper patterns (map, manyOrNone, multi, none).",
      "prompt": "We need to reduce the size of user portfolio history data and still serve a usable history for users.\n\nAdd a daily background job that, for older data, reduces point density by keeping four averaged points per day (one every six hours) and archives the originals. Expose this in the existing get-user-portfolio-history API so that when requesting the full history, clients get recent points from the last month plus all older points.\n\nAlso introduce minimal schema to support archiving and tracking when a user's portfolio was last processed, and register the new job in the scheduler while removing the obsolete cash stats job.\n\nEnsure the API returns a single, chronologically sorted series and the new job only processes users who need it.",
      "supplementalFiles": [
        "common/src/supabase/portfolio-metrics.ts",
        "common/src/period.ts",
        "backend/scheduler/src/jobs/helpers.ts",
        "backend/supabase/user_portfolio_history.sql",
        "backend/shared/src/update-user-portfolio-histories-core.ts",
        "backend/shared/src/supabase/init.ts",
        "backend/shared/src/utils.ts",
        "backend/scheduler/src/jobs/update-stats.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/get-user-portfolio-history.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/get-user-portfolio-history.ts\n===================================================================\n--- backend/api/src/get-user-portfolio-history.ts\tc65e289 (parent)\n+++ backend/api/src/get-user-portfolio-history.ts\t0b8bb48 (commit)\n@@ -1,29 +1,40 @@\n import { sortBy } from 'lodash'\n \n-import { type APIHandler } from './helpers/endpoint'\n-import { createSupabaseDirectClient } from 'shared/supabase/init'\n import { getCutoff } from 'common/period'\n import { convertPortfolioHistory } from 'common/supabase/portfolio-metrics'\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { type APIHandler } from './helpers/endpoint'\n \n export const getUserPortfolioHistory: APIHandler<\n   'get-user-portfolio-history'\n > = async (props) => {\n   const pg = createSupabaseDirectClient()\n   const { userId, period } = props\n+  const isAllTime = period === 'allTime'\n+  const cutoff = isAllTime ? getCutoff('monthly') : getCutoff(period)\n \n-  const startDate = new Date(getCutoff(period)).toISOString()\n-\n-  const data = await pg.map(\n+  const startDate = new Date(cutoff).toISOString()\n+  const allTimeQuery = isAllTime\n+    ? `select *\n+    from user_portfolio_history\n+    where\n+      user_id = $1\n+      and ts < now() - interval '1 month';`\n+    : ''\n+  const data = await pg.multi(\n     `select *\n     from user_portfolio_history\n     where\n       user_id = $1\n-      and ($2 is null or ts > $2)\n+      and ts > $2\n     order by random()\n-    limit 1000`,\n-    [userId, period === 'allTime' ? null : startDate],\n-    convertPortfolioHistory\n+    limit 1000;\n+    ${allTimeQuery}`,\n+    [userId, startDate]\n   )\n+  const latestPoints = data[0].map(convertPortfolioHistory)\n+  const laterPoints = isAllTime ? data[1].map(convertPortfolioHistory) : []\n+  const allPoints = [...latestPoints, ...laterPoints]\n \n-  return sortBy(data, 'timestamp')\n+  return sortBy(allPoints, 'timestamp')\n }\n"
        },
        {
          "path": "backend/scheduler/src/jobs/index.ts",
          "status": "modified",
          "diff": "Index: backend/scheduler/src/jobs/index.ts\n===================================================================\n--- backend/scheduler/src/jobs/index.ts\tc65e289 (parent)\n+++ backend/scheduler/src/jobs/index.ts\t0b8bb48 (commit)\n@@ -1,44 +1,45 @@\n-import { createJob } from './helpers'\n-import { updateContractMetricsCore } from 'shared/update-contract-metrics-core'\n-import { sendOnboardingNotificationsInternal } from 'shared/onboarding-helpers'\n-import { updateUserMetricPeriods } from 'shared/update-user-metric-periods'\n-import { cleanOldNotifications } from './clean-old-notifications'\n-import { updateCashStatsCore, updateStatsCore } from './update-stats'\n-import { calculateConversionScore } from 'shared/conversion-score'\n-import { autoAwardBounty } from './auto-award-bounty'\n-import { resetPgStats } from './reset-pg-stats'\n import { calculateUserTopicInterests } from 'shared/calculate-user-topic-interests'\n+import { checkPushNotificationReceipts } from 'shared/check-push-receipts'\n+import { calculateConversionScore } from 'shared/conversion-score'\n+import { downsamplePortfolioHistory } from 'shared/downsample-portfolio-history'\n+import { expireLimitOrders } from 'shared/expire-limit-orders'\n+import { calculateGroupImportanceScore } from 'shared/group-importance-score'\n+import { IMPORTANCE_MINUTE_INTERVAL } from 'shared/importance-score'\n+import { sendOnboardingNotificationsInternal } from 'shared/onboarding-helpers'\n+import { sendMarketMovementNotifications } from 'shared/send-market-movement-notifications'\n+import { sendUnseenMarketMovementNotifications } from 'shared/send-unseen-notifications'\n+import { updateContractMetricsCore } from 'shared/update-contract-metrics-core'\n import {\n   CREATOR_UPDATE_FREQUENCY,\n   updateCreatorMetricsCore,\n } from 'shared/update-creator-metrics-core'\n-import { sendPortfolioUpdateEmailsToAllUsers } from 'shared/weekly-portfolio-emails'\n+import { updateUserMetricPeriods } from 'shared/update-user-metric-periods'\n+import { updateUserPortfolioHistoriesCore } from 'shared/update-user-portfolio-histories-core'\n+import { isProd } from 'shared/utils'\n import { sendWeeklyMarketsEmails } from 'shared/weekly-markets-emails'\n-import { resetWeeklyEmailsFlags } from './reset-weekly-emails-flags'\n-import { calculateGroupImportanceScore } from 'shared/group-importance-score'\n-import { checkPushNotificationReceipts } from 'shared/check-push-receipts'\n-import { sendStreakExpirationNotification } from './streak-expiration-notice'\n-import { expireLimitOrders } from 'shared/expire-limit-orders'\n+import { sendPortfolioUpdateEmailsToAllUsers } from 'shared/weekly-portfolio-emails'\n+import { autoAwardBounty } from './auto-award-bounty'\n+import { autoLeaguesCycle } from './auto-leagues-cycle'\n+import { cleanOldNotifications } from './clean-old-notifications'\n import { denormalizeAnswers } from './denormalize-answers'\n+import { drizzleLiquidity } from './drizzle-liquidity'\n+import { createJob } from './helpers'\n import { incrementStreakForgiveness } from './increment-streak-forgiveness'\n-import { sendMarketCloseEmails } from './send-market-close-emails'\n import { pollPollResolutions } from './poll-poll-resolutions'\n-import { IMPORTANCE_MINUTE_INTERVAL } from 'shared/importance-score'\n-import { scoreContracts } from './score-contracts'\n-import { updateLeagueRanks } from './update-league-ranks'\n-import { updateLeague } from './update-league'\n-import { drizzleLiquidity } from './drizzle-liquidity'\n import { resetBettingStreaksInternal } from './reset-betting-streaks'\n+import { resetPgStats } from './reset-pg-stats'\n import {\n   resetDailyQuestStatsInternal,\n   resetWeeklyQuestStatsInternal,\n } from './reset-quests-stats'\n-import { updateUserPortfolioHistoriesCore } from 'shared/update-user-portfolio-histories-core'\n-import { isProd } from 'shared/utils'\n-import { sendMarketMovementNotifications } from 'shared/send-market-movement-notifications'\n-import { sendUnseenMarketMovementNotifications } from 'shared/send-unseen-notifications'\n-import { autoLeaguesCycle } from './auto-leagues-cycle'\n+import { resetWeeklyEmailsFlags } from './reset-weekly-emails-flags'\n+import { scoreContracts } from './score-contracts'\n+import { sendMarketCloseEmails } from './send-market-close-emails'\n+import { sendStreakExpirationNotification } from './streak-expiration-notice'\n+import { updateLeague } from './update-league'\n+import { updateLeagueRanks } from './update-league-ranks'\n+import { updateStatsCore } from './update-stats'\n \n export function createJobs() {\n   return [\n     createJob(\n@@ -155,13 +156,8 @@\n       '0 20 4 * * *', // on 4:20am daily\n       () => updateStatsCore(7)\n     ),\n     createJob(\n-      'update-cash-stats',\n-      '0 20 4 * * *', // on 4:20am daily\n-      () => updateCashStatsCore(7)\n-    ),\n-    createJob(\n       'onboarding-notification',\n       '0 0 11 * * *', // 11 AM daily\n       sendOnboardingNotificationsInternal\n     ),\n@@ -204,8 +200,13 @@\n       'reset-weekly-quests-stats',\n       '0 0 0 * * 1', // every Monday at midnight\n       resetWeeklyQuestStatsInternal\n     ),\n+    createJob(\n+      'downsample-portfolio-history',\n+      '0 50 4 * * *', // every day at 4:50am\n+      downsamplePortfolioHistory\n+    ),\n     // Monthly jobs:\n     createJob(\n       'increment-streak-forgiveness',\n       '0 0 3 1 * *', // 3am PST on the 1st day of the month\n"
        },
        {
          "path": "backend/shared/src/downsample-portfolio-history.ts",
          "status": "added",
          "diff": "Index: backend/shared/src/downsample-portfolio-history.ts\n===================================================================\n--- backend/shared/src/downsample-portfolio-history.ts\tc65e289 (parent)\n+++ backend/shared/src/downsample-portfolio-history.ts\t0b8bb48 (commit)\n@@ -0,0 +1,160 @@\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { log } from 'shared/utils'\n+\n+const TESTING = false\n+export async function downsamplePortfolioHistory() {\n+  const db = createSupabaseDirectClient()\n+  log('Starting portfolio history downsampling')\n+  const userIds = TESTING\n+    ? ['rZe5vReIBSYJpUymsFBWW1aUyp13']\n+    : await db.map(\n+        `select distinct id from users\n+            left join portfolios_processed p on p.user_id = users.id\n+            where data->>'lastBetTime' is not null\n+            and created_time < now() - interval '1 month'\n+            and (p.user_id is null or p.last_processed < now() - interval '1 week')`,\n+        [],\n+        (u) => u.id\n+      )\n+  log(`Downsampling portfolio history for ${userIds.length} users `)\n+\n+  for (const userId of userIds) {\n+    await db.tx(async (tx) => {\n+      const daysToProcess = await tx.manyOrNone<{\n+        user_id: string\n+        day: string\n+      }>(\n+        `\n+        select p.user_id, p.day from (\n+          select\n+            user_id,\n+            date_trunc('day', ts) as day,\n+            count(*) as daily_count\n+          from user_portfolio_history\n+          where user_id = $1\n+          and ts < now() - interval '1 month'\n+          group by user_id, date_trunc('day', ts)\n+        ) as p\n+        where p.daily_count > 4\n+      `,\n+        [userId]\n+      )\n+\n+      if (daysToProcess.length === 0) return\n+\n+      log(`Found ${daysToProcess.length} user-days to process for ${userId}.`)\n+\n+      const userIds = daysToProcess.map((d) => d.user_id)\n+      const days = daysToProcess.map((d) => d.day)\n+\n+      await tx.none(\n+        `\n+      with\n+        days_to_process_unnested as (\n+          select *\n+          from unnest($1::text[], $2::timestamp[]) as t(user_id, day)\n+        ),\n+        points_to_process as (\n+          select p.id\n+          from user_portfolio_history p\n+            join days_to_process_unnested d\n+            on p.user_id = d.user_id\n+            and date_trunc('day', p.ts) = d.day\n+        ),\n+        deleted_points as (\n+          delete from user_portfolio_history\n+          where id in (select id from points_to_process)\n+          returning *\n+        ),\n+        archived_points as (\n+          insert into\n+            user_portfolio_history_archive (\n+              user_id,\n+              ts,\n+              balance,\n+              cash_balance,\n+              investment_value,\n+              total_deposits,\n+              loan_total,\n+              profit,\n+              cash_investment_value,\n+              total_cash_deposits,\n+              spice_balance\n+            )\n+          select\n+            user_id,\n+            ts,\n+            balance,\n+            cash_balance,\n+            investment_value,\n+            total_deposits,\n+            loan_total,\n+            profit,\n+            cash_investment_value,\n+            total_cash_deposits,\n+            spice_balance\n+          from deleted_points\n+        ),\n+        new_points as (\n+          select\n+            p.user_id,\n+            (\n+              date_trunc('day', p.ts) +\n+              (floor(extract(hour from p.ts) / 6) * interval '6 hours')\n+            ) as ts,\n+            avg(p.balance) as balance,\n+            avg(p.cash_balance) as cash_balance,\n+            avg(p.cash_investment_value) as cash_investment_value,\n+            avg(p.investment_value) as investment_value,\n+            avg(p.loan_total) as loan_total,\n+            avg(p.profit) as profit,\n+            avg(p.spice_balance) as spice_balance,\n+            avg(p.total_cash_deposits) as total_cash_deposits,\n+            avg(p.total_deposits) as total_deposits\n+          from deleted_points p\n+          group by\n+            p.user_id,\n+            date_trunc('day', p.ts),\n+            floor(extract(hour from p.ts) / 6)\n+        )\n+      insert into\n+        user_portfolio_history (\n+          user_id,\n+          ts,\n+          balance,\n+          cash_balance,\n+          cash_investment_value,\n+          investment_value,\n+          loan_total,\n+          profit,\n+          spice_balance,\n+          total_cash_deposits,\n+          total_deposits\n+        )\n+      select\n+        user_id,\n+        ts,\n+        balance,\n+        cash_balance,\n+        cash_investment_value,\n+        investment_value,\n+        loan_total,\n+        profit,\n+        spice_balance,\n+        total_cash_deposits,\n+        total_deposits\n+      from new_points\n+      `,\n+        [userIds, days]\n+      )\n+      await tx.none(\n+        `\n+        insert into portfolios_processed (user_id)\n+        values ($1) on conflict (user_id) do update set last_processed = now()\n+        `,\n+        [userId]\n+      )\n+    })\n+  }\n+  log('Finished portfolio history downsampling')\n+}\n"
        },
        {
          "path": "backend/shared/src/test-backend-function.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/test-backend-function.ts\n===================================================================\n--- backend/shared/src/test-backend-function.ts\tc65e289 (parent)\n+++ backend/shared/src/test-backend-function.ts\t0b8bb48 (commit)\n@@ -1,15 +1,9 @@\n /* eslint-disable */\n import { getServiceAccountCredentials, loadSecretsToEnv } from 'common/secrets'\n import { getLocalEnv } from 'shared/init-admin'\n import { createSupabaseDirectClient } from 'shared/supabase/init'\n-import { updateUserMetricPeriods } from './update-user-metric-periods'\n-import { updateCreatorMetricsCore } from 'shared/update-creator-metrics-core'\n-import { calculateImportanceScore } from 'shared/importance-score'\n-import { backfillUserTopicInterests } from 'shared/backfill-user-topic-interests'\n-import { updateUserPortfolioHistoriesCore } from './update-user-portfolio-histories-core'\n-import { updateContractMetricsCore } from './update-contract-metrics-core'\n-import { updateUserMetricsWithBets } from 'shared/update-user-metrics-with-bets'\n+import { downsamplePortfolioHistory } from './downsample-portfolio-history'\n \n // Ian's file for debugging\n export async function testBackendFunction() {\n   const credentials = getServiceAccountCredentials(getLocalEnv())\n@@ -18,9 +12,10 @@\n     const pg = createSupabaseDirectClient()\n     // await backfillUserTopicInterests(pg)\n     // await calculateImportanceScore(db, pg)\n     // await updateContractMetricsCore()\n-    await updateUserMetricPeriods(['xoo782zW9geixafwEaT7B9Ku3Bj1'])\n+    await downsamplePortfolioHistory()\n+    // await updateUserMetricPeriods(['xoo782zW9geixafwEaT7B9Ku3Bj1'])\n     // await updateUserMetricsWithBets()\n     // await updateUserPortfolioHistoriesCore(['AJwLWoo3xue32XIiAVrL5SyR1WB2'])\n     // await updateCreatorMetricsCore()\n   } catch (e) {\n"
        },
        {
          "path": "backend/supabase/portfolios_processed.sql",
          "status": "added",
          "diff": "Index: backend/supabase/portfolios_processed.sql\n===================================================================\n--- backend/supabase/portfolios_processed.sql\tc65e289 (parent)\n+++ backend/supabase/portfolios_processed.sql\t0b8bb48 (commit)\n@@ -0,0 +1,8 @@\n+create table if not exists\n+  portfolios_processed (\n+    user_id text not null primary key,\n+    last_processed timestamp with time zone default now() not null\n+  );\n+\n+-- Row Level Security\n+alter table portfolios_processed enable row level security;\n"
        },
        {
          "path": "backend/supabase/user_portfolio_history_archive.sql",
          "status": "added",
          "diff": "Index: backend/supabase/user_portfolio_history_archive.sql\n===================================================================\n--- backend/supabase/user_portfolio_history_archive.sql\tc65e289 (parent)\n+++ backend/supabase/user_portfolio_history_archive.sql\t0b8bb48 (commit)\n@@ -0,0 +1,26 @@\n+-- This file is autogenerated from regen-schema.ts\n+create table if not exists\n+  user_portfolio_history_archive (\n+    balance numeric,\n+    cash_balance numeric default 0 not null,\n+    cash_investment_value numeric default 0 not null,\n+    id bigint primary key generated always as identity not null,\n+    investment_value numeric,\n+    loan_total numeric,\n+    profit numeric,\n+    spice_balance numeric default 0 not null,\n+    total_cash_deposits numeric default 0 not null,\n+    total_deposits numeric,\n+    ts timestamp without time zone,\n+    user_id text not null\n+  );\n+\n+-- Row Level Security\n+alter table user_portfolio_history_archive enable row level security;\n+\n+-- Policies\n+drop policy if exists \"public read\" on user_portfolio_history_archive;\n+\n+create policy \"public read\" on user_portfolio_history_archive for\n+select\n+  using (true);\n"
        }
      ]
    },
    {
      "id": "add-post-boosts",
      "sha": "d414e8e3dbe6dcc4466b20cedfb0ff19af01efa8",
      "parentSha": "21d26b6620450a4f2cca836de07ba6e1e8c2b296",
      "spec": "Implement unified boosts for contracts and posts across backend, database, types, scoring, and web UI.\n\nBackend API and routing:\n- Add a new endpoint handler purchase-boost that accepts exactly one of contractId or postId, a startTime (ms), and method in ['mana', 'cash', 'admin-free'].\n- Validate content existence and visibility: if contractId is provided, load the contract; if postId is provided, load the post. Reject if not found.\n- Enforce only admins/mods can use method = 'admin-free'.\n- When checking for overlapping boosts, ensure the maximum number of active funded boosts (same time) is capped (use existing MAX_ACTIVE_BOOSTS) and that the specific content (contract or post) does not already have a boost for the selected time.\n- For method = 'cash': insert an unfunded boost row including either contract_id or post_id (not both), create a Stripe checkout session whose metadata includes userId, boostId, and either contractId or postId, and return the checkout URL. Success and cancel URLs should point to the content page (contract URL or /post/{slug}).\n- For method = 'mana' or 'admin-free': insert a funded boost row; if not admin-free, create a debit transaction of BOOST_COST_MANA from the user to BANK with data containing boostId and the relevant content id (contractId or postId). After returning success, if startTime is in the past or now, immediately apply the boost to the content.\n- Track public analytics events for initiated and purchased actions using an event name that distinguishes contract vs post (e.g., \"contract boost initiated\" or \"post boost initiated\"; same for \"purchased\"). Include content id, slug, and payment method.\n- Export a helper to immediately boost a post (boostPostImmediately) that sets boosted to true and raises its importance score to a high baseline.\n- Update routes to register 'purchase-boost' instead of the old 'purchase-contract-boost'.\n\nStripe webhook:\n- Update checkout.session.completed handling to recognize boost payments for either contracts or posts using metadata (boostId and either contractId or postId). Mark the boost as funded when metadata matches, scoped by boost id and user id, and ensuring exactly one of contract_id/post_id matches.\n- If the boost start time is already active, trigger immediate boost on the target content (contract or post) via their respective helpers.\n- Track a purchased event that reflects whether the content is a contract or post.\n\nDatabase schema:\n- Modify contract_boosts to support either contracts or posts:\n  - Make contract_id nullable; add post_id referencing old_posts(id).\n  - Add a check constraint ensuring exactly one of contract_id or post_id is non-null for each row.\n  - Add an index on post_id with start_time and end_time; retain existing indexes.\n  - Ensure funded and created_time fields exist with appropriate defaults.\n- Modify old_posts to include a boolean boosted column with default false.\n\nShared data access and types:\n- Update posts accessor to select and return boosted, in addition to existing fields.\n- Update the TopLevelPost type to include boosted: boolean.\n- Update the API schema mapping to define 'purchase-boost' with optional contractId and postId and a refinement that exactly one must be provided.\n- Update the Database types for contract_boosts to reflect optional contract_id/post_id, created_time, and funded fields in Row/Insert/Update types.\n- Update the transaction data type ContractBoostPurchase so data includes optional contractId and postId.\n\nImportance scoring:\n- For contracts: only consider active boosts where contract_id is not null when calculating contract importance scores.\n- For posts: factor in active post boosts (post_id is not null). If a post is actively boosted, add a boost component to the raw score and ensure a minimum normalized importance score floor (e.g., at least 0.9 while active).\n\nCreate-post behavior:\n- Ensure new posts initialize with boosted: false and a default importance score consistent with existing logic.\n\nWeb frontend:\n- Update the contract boost UI to call the new 'purchase-boost' API path.\n- Add a post boosting UI component that:\n  - Renders a Boost button (or Boosted state) on eligible posts (public visibility).\n  - Opens a modal where the user can choose start date (today or future), pay with mana or cash, and for admins/mods a free boost option.\n  - Calls the unified purchase-boost API with postId.\n  - Handles insufficient mana by offering an Add Funds modal.\n  - Shows a success toast and closes on completion.\n- Display boosted status for posts in listings (e.g., PostRow) using the existing BoostedTooltip component.\n- Add the Boost button to the post detail page so users can boost directly from the post.\n\nDocumentation:\n- Update backend API knowledge documentation to document the unified boost system, how the endpoint accepts contractId or postId, and how boosts affect visibility and duration.",
      "prompt": "Implement a unified boosting system that works for both contracts and posts. Add a new public API endpoint to purchase a boost that accepts either a contract ID or a post ID, supports mana, cash, and admin-free options, and validates that only one piece of content is boosted per slot. Update the Stripe flow to fund boosts for posts as well as contracts. Extend the database schema to track boosts for either content type and add a boosted flag on posts. Update scoring to reflect active boosts on posts and ensure boosted posts receive prominent placement. Update client components so contracts call the new endpoint and posts get a Boost button, modal purchase flow, and boosted status indicators. Include analytics events for initiated and purchased boosts for both content types. Update documentation accordingly.",
      "supplementalFiles": [
        "backend/api/src/helpers/endpoint.ts",
        "backend/shared/src/supabase/contracts.ts",
        "backend/shared/src/supabase/init.ts",
        "backend/shared/src/utils.ts",
        "common/src/economy.ts",
        "common/src/contract.ts",
        "common/src/util/time.ts",
        "common/src/util/format.ts",
        "web/lib/api/api.ts",
        "web/components/contract/boost-column.tsx",
        "web/add-funds-modal.tsx",
        "web/hooks/use-admin.ts",
        "web/hooks/use-user.ts",
        "web/components/buttons/button.tsx",
        "web/components/layout/modal.tsx",
        "web/components/layout/col.tsx",
        "web/components/layout/row.tsx",
        "web/components/contract/contract-table-col-formats.tsx"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/knowledge.md",
          "status": "modified",
          "diff": "Index: backend/api/knowledge.md\n===================================================================\n--- backend/api/knowledge.md\t21d26b6 (parent)\n+++ backend/api/knowledge.md\td414e8e (commit)\n@@ -83,16 +83,23 @@\n \n - Use the `createSupabaseDirectClient` function from `shared/supabase/init` for database operations.\n - For environment-specific IDs and constants, check common/antes.ts first as it contains important platform-wide constants like HOUSE_LIQUIDITY_PROVIDER_ID.\n \n-\n ## Sports Markets\n \n - Each sports event can have at most one MANA market and one CASH market\n - If creation of the MANA market fails (e.g., due to duplicate sportsEventId), do not attempt to create the CASH market\n - The MANA market is considered the \"source of truth\" - the CASH market should only exist if there is a corresponding MANA market\n - Prefer lightweight check endpoints over complex validation in create/update endpoints when the check might be useful in other contexts\n \n+## Boosts\n+\n+- The `contract_boosts` table supports boosting both contracts and posts\n+- Either `contract_id` or `post_id` must be specified, but not both\n+- The `purchase-boost` endpoint accepts either `contractId` or `postId` parameter\n+- Boosted content gets higher importance scores and appears more prominently on the homepage\n+- Boosts last for 24 hours and can be paid for with mana or cash\n+\n   This uses the pg promise library, where you pass raw sql strings like so:\n \n ```ts\n import { createSupabaseClient } from 'shared/supabase/init'\n"
        },
        {
          "path": "backend/api/src/create-post.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/create-post.ts\n===================================================================\n--- backend/api/src/create-post.ts\t21d26b6 (parent)\n+++ backend/api/src/create-post.ts\td414e8e (commit)\n@@ -41,8 +41,9 @@\n       creatorAvatarUrl: creator.avatarUrl,\n       visibility: visibility ?? 'public',\n       isAnnouncement,\n       isChangeLog,\n+      boosted: false,\n       importanceScore: NEW_MARKET_IMPORTANCE_SCORE,\n     })\n \n     // currently uses the trigger to populate group_id, creator_id, created_time.\n"
        },
        {
          "path": "backend/api/src/purchase-boost.ts",
          "status": "renamed",
          "oldPath": "backend/api/src/purchase-contract-boost.ts",
          "diff": "===================================================================\n--- backend/api/src/purchase-contract-boost.ts\t21d26b6 (parent)\n+++ backend/api/src/purchase-boost.ts\td414e8e (commit)\n@@ -1,6 +1,9 @@\n import { APIError, APIHandler } from './helpers/endpoint'\n-import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import {\n+  createSupabaseDirectClient,\n+  SupabaseDirectClient,\n+} from 'shared/supabase/init'\n import { DAY_MS } from 'common/util/time'\n import {\n   DEV_HOUSE_LIQUIDITY_PROVIDER_ID,\n   HOUSE_LIQUIDITY_PROVIDER_ID,\n@@ -18,8 +21,10 @@\n import Stripe from 'stripe'\n import { contractUrl } from 'common/contract'\n import { boostContractImmediately } from 'shared/supabase/contracts'\n import { isAdminId, isModId } from 'common/envs/constants'\n+import { getPost } from 'shared/supabase/posts'\n+import { TopLevelPost } from 'common/top-level-post'\n \n const MAX_ACTIVE_BOOSTS = 5\n \n const initStripe = () => {\n@@ -28,42 +33,71 @@\n }\n \n //TODO; we could add a 'paid' column that is default true but for those paying with USD,\n // defaults to false until the strpe webhook marks it as true\n-export const purchaseContractBoost: APIHandler<\n-  'purchase-contract-boost'\n-> = async (props, auth) => {\n-  const { contractId, startTime, method } = props\n+export const purchaseContractBoost: APIHandler<'purchase-boost'> = async (\n+  props,\n+  auth\n+) => {\n+  const { contractId, postId, startTime, method } = props\n   const userId = auth.uid\n \n   const pg = createSupabaseDirectClient()\n \n-  // Check if contract exists and user can see it\n-  const contract = await getContract(pg, contractId)\n-  if (!contract) {\n-    throw new APIError(404, 'Contract not found')\n+  // Validate that either contract or post exists and user can see it\n+  let contract = null\n+  let post = null\n+  let contentUrl = ''\n+  let contentSlug = ''\n+\n+  if (contractId) {\n+    contract = await getContract(pg, contractId)\n+    if (!contract) {\n+      throw new APIError(404, 'Contract not found')\n+    }\n+    contentUrl = contractUrl(contract)\n+    contentSlug = contract.slug\n+  } else if (postId) {\n+    post = await getPost(pg, postId)\n+    if (!post) {\n+      throw new APIError(404, 'Post not found')\n+    }\n+    contentUrl = `/post/${post.slug}`\n+    contentSlug = post.slug\n   }\n+\n   const fundViaCash = method === 'cash'\n   const freeAdminBoost = method === 'admin-free'\n \n   // Check if user is admin/mod for free boost\n   if (freeAdminBoost && !isAdminId(userId) && !isModId(userId)) {\n     throw new APIError(403, 'Only admins and mods can use free boosts')\n   }\n \n-  // Check if there's already an active boost\n+  // Check if there's already an active boost for the same time period\n   const activeBoost = await pg.manyOrNone<Row<'contract_boosts'>>(\n     `select * from contract_boosts \n      where millis_to_ts($1) between start_time and end_time\n      and funded`,\n     [startTime]\n   )\n-  if (activeBoost.some((b) => b.contract_id === contractId)) {\n+\n+  // Check if the specific content (contract or post) already has a boost for this time\n+  const contentHasBoost = activeBoost.some(\n+    (b) =>\n+      (contractId && b.contract_id === contractId) ||\n+      (postId && b.post_id === postId)\n+  )\n+\n+  if (contentHasBoost) {\n     throw new APIError(\n       400,\n-      'Contract already has an active boost for that time'\n+      `${\n+        contractId ? 'Contract' : 'Post'\n+      } already has an active boost for that time`\n     )\n   }\n+\n   if (activeBoost.length >= MAX_ACTIVE_BOOSTS) {\n     throw new APIError(\n       400,\n       'That time period has the maximum number of boosts. Please select a different time.'\n@@ -72,12 +106,18 @@\n \n   if (fundViaCash) {\n     // insert the boost as unfunded and then in the stripe endpoint, query for the boost and mark it as funded\n     const boost = await pg.one(\n-      `insert into contract_boosts (contract_id, user_id, start_time, end_time, funded)\n-       values ($1, $2, millis_to_ts($3), millis_to_ts($4), false)\n+      `insert into contract_boosts (contract_id, post_id, user_id, start_time, end_time, funded)\n+       values ($1, $2, $3, millis_to_ts($4), millis_to_ts($5), false)\n        returning id`,\n-      [contractId, userId, startTime, startTime + DAY_MS]\n+      [\n+        contractId ?? null,\n+        postId ?? null,\n+        userId,\n+        startTime,\n+        startTime + DAY_MS,\n+      ]\n     )\n \n     // Create Stripe checkout session\n     const stripe = initStripe()\n@@ -88,9 +128,10 @@\n     const session = await stripe.checkout.sessions.create({\n       metadata: {\n         userId,\n         boostId: boost.id,\n-        contractId,\n+        contractId: contractId ?? '',\n+        postId: postId ?? '',\n       },\n       line_items: [\n         {\n           price: priceId,\n@@ -98,41 +139,52 @@\n         },\n       ],\n       mode: 'payment',\n       allow_promotion_codes: true,\n-      success_url: contractUrl(contract) + '?boostSuccess=true',\n-      cancel_url: contractUrl(contract) + '?boostSuccess=false',\n+      success_url: contentUrl + '?boostSuccess=true',\n+      cancel_url: contentUrl + '?boostSuccess=false',\n     })\n     if (!session.url) {\n       throw new APIError(500, 'Failed to create Stripe checkout session')\n     }\n \n     return {\n       result: { success: true, checkoutUrl: session.url },\n       continue: async () => {\n-        trackPublicEvent(auth.uid, 'contract boost initiated', {\n-          contractId,\n-          slug: contract.slug,\n-          paymentMethod: 'cash',\n-        })\n+        trackPublicEvent(\n+          auth.uid,\n+          `${contractId ? 'contract' : 'post'} boost initiated`,\n+          {\n+            contractId,\n+            postId,\n+            slug: contentSlug,\n+            paymentMethod: 'cash',\n+          }\n+        )\n       },\n     }\n   } else {\n     // Start transaction for mana payment\n     await pg.tx(async (tx) => {\n       const boost = await tx.one(\n-        `insert into contract_boosts (contract_id, user_id, start_time, end_time, funded)\n-       values ($1, $2, millis_to_ts($3), millis_to_ts($4), true)\n+        `insert into contract_boosts (contract_id, post_id, user_id, start_time, end_time, funded)\n+       values ($1, $2, $3, millis_to_ts($4), millis_to_ts($5), true)\n        returning id`,\n-        [contractId, userId, startTime, startTime + DAY_MS]\n+        [\n+          contractId ?? null,\n+          postId ?? null,\n+          userId,\n+          startTime,\n+          startTime + DAY_MS,\n+        ]\n       )\n       if (!freeAdminBoost) {\n         const txnData: TxnData = {\n           category: 'CONTRACT_BOOST_PURCHASE',\n           fromType: 'USER',\n           toType: 'BANK',\n           token: 'M$',\n-          data: { contractId, boostId: boost.id },\n+          data: { contractId, postId, boostId: boost.id },\n           amount: BOOST_COST_MANA,\n           fromId: userId,\n           toId: isProd()\n             ? HOUSE_LIQUIDITY_PROVIDER_ID\n@@ -145,14 +197,33 @@\n \n   return {\n     result: { success: true },\n     continue: async () => {\n-      trackPublicEvent(auth.uid, 'contract boost purchased', {\n-        contractId,\n-        slug: contract.slug,\n-        paymentMethod: 'mana',\n-      })\n-      if (startTime <= Date.now() && !fundViaCash)\n+      trackPublicEvent(\n+        auth.uid,\n+        `${contractId ? 'contract' : 'post'} boost purchased`,\n+        {\n+          contractId,\n+          postId,\n+          slug: contentSlug,\n+          paymentMethod: 'mana',\n+        }\n+      )\n+      if (startTime <= Date.now() && !fundViaCash && contract) {\n         await boostContractImmediately(pg, contract)\n+      }\n+      if (startTime <= Date.now() && !fundViaCash && post) {\n+        await boostPostImmediately(pg, post)\n+      }\n     },\n   }\n }\n+\n+export const boostPostImmediately = async (\n+  pg: SupabaseDirectClient,\n+  post: TopLevelPost\n+) => {\n+  await pg.none(\n+    `update old_posts set boosted = true, importance_score = 0.9 where id = $1`,\n+    [post.id]\n+  )\n+}\n"
        },
        {
          "path": "backend/api/src/routes.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/routes.ts\n===================================================================\n--- backend/api/src/routes.ts\t21d26b6 (parent)\n+++ backend/api/src/routes.ts\td414e8e (commit)\n@@ -146,9 +146,9 @@\n import {\n   getContractOptionVoters,\n   getContractVoters,\n } from './get-contract-voters'\n-import { purchaseContractBoost } from './purchase-contract-boost'\n+import { purchaseContractBoost } from './purchase-boost'\n import {\n   generateAINumericRanges,\n   regenerateNumericMidpoints,\n } from './generate-ai-numeric-ranges'\n@@ -337,9 +337,9 @@\n   'comment-reactions': getReactions,\n   'mark-all-notifications-new': markallnotificationsnew,\n   'get-contract-voters': getContractVoters,\n   'get-contract-option-voters': getContractOptionVoters,\n-  'purchase-contract-boost': purchaseContractBoost,\n+  'purchase-boost': purchaseContractBoost,\n   'generate-ai-numeric-ranges': generateAINumericRanges,\n   'regenerate-numeric-midpoints': regenerateNumericMidpoints,\n   'infer-numeric-unit': inferNumericUnit,\n   'generate-ai-date-ranges': generateAIDateRanges,\n"
        },
        {
          "path": "backend/api/src/stripe-endpoints.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/stripe-endpoints.ts\n===================================================================\n--- backend/api/src/stripe-endpoints.ts\t21d26b6 (parent)\n+++ backend/api/src/stripe-endpoints.ts\td414e8e (commit)\n@@ -11,16 +11,19 @@\n import { updateUser } from 'shared/supabase/users'\n import { WEB_PRICES } from 'common/economy'\n import { getContract } from 'shared/utils'\n import { boostContractImmediately } from 'shared/supabase/contracts'\n+import { getPost } from 'shared/supabase/posts'\n+import { boostPostImmediately } from './purchase-boost'\n \n export type StripeSession = Stripe.Event.Data.Object & {\n   id: string\n   metadata: {\n     userId: string\n     priceInDollars?: string\n     boostId?: string\n     contractId?: string\n+    postId?: string\n   }\n }\n \n export type StripeTransaction = {\n@@ -101,9 +104,12 @@\n   }\n \n   if (event.type === 'checkout.session.completed') {\n     const session = event.data.object as StripeSession\n-    if (session.metadata.boostId && session.metadata.contractId) {\n+    if (\n+      session.metadata.boostId &&\n+      (session.metadata.contractId || session.metadata.postId)\n+    ) {\n       await handleBoostPayment(session)\n     } else {\n       await issueMoneys(session)\n     }\n@@ -209,10 +215,10 @@\n   }\n }\n \n const handleBoostPayment = async (session: StripeSession) => {\n-  const { boostId, contractId, userId } = session.metadata\n-  if (!boostId || !contractId || !userId) {\n+  const { boostId, contractId, postId, userId } = session.metadata\n+  if (!boostId || (!contractId && !postId) || !userId) {\n     log.error('Invalid boost payment metadata', session.metadata)\n     throw new APIError(400, 'Invalid boost payment metadata')\n   }\n \n@@ -221,24 +227,39 @@\n   const boost = await pg.tx(async (tx) =>\n     tx.one(\n       `update contract_boosts \n          set funded = true \n-         where id = $1 and contract_id = $2 and user_id = $3\n+         where id = $1 and user_id = $2 and (\n+           (contract_id = $3 and post_id is null) or \n+           (post_id = $4 and contract_id is null)\n+         )\n          returning *`,\n-      [boostId, contractId, userId]\n+      [boostId, userId, contractId ?? null, postId ?? null]\n     )\n   )\n \n   if (new Date(boost.start_time) <= new Date()) {\n-    const contract = await getContract(pg, contractId)\n-    if (!contract) throw new APIError(404, 'Contract not found')\n-    await boostContractImmediately(pg, contract)\n+    if (contractId) {\n+      const contract = await getContract(pg, contractId)\n+      if (!contract) throw new APIError(404, 'Contract not found')\n+      await boostContractImmediately(pg, contract)\n+    }\n+    if (postId) {\n+      const post = await getPost(pg, postId)\n+      if (!post) throw new APIError(404, 'Post not found')\n+      await boostPostImmediately(pg, post)\n+    }\n   }\n \n-  await trackPublicEvent(userId, 'contract boost purchased', {\n-    contractId,\n-    boostId,\n-    paymentMethod: 'cash',\n-  })\n+  await trackPublicEvent(\n+    userId,\n+    `${contractId ? 'contract' : 'post'} boost purchased`,\n+    {\n+      contractId,\n+      postId,\n+      boostId,\n+      paymentMethod: 'cash',\n+    }\n+  )\n }\n \n const firestore = admin.firestore()\n"
        },
        {
          "path": "backend/shared/src/importance-score.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/importance-score.ts\n===================================================================\n--- backend/shared/src/importance-score.ts\t21d26b6 (parent)\n+++ backend/shared/src/importance-score.ts\td414e8e (commit)\n@@ -104,9 +104,9 @@\n     ...(await getContractTraders(pg, weekAgo, contractIds)),\n     ...(await getContractVoters(pg, weekAgo, contractIds)),\n   }\n   const activeBoosts = await pg.manyOrNone<Row<'contract_boosts'>>(\n-    `select * from contract_boosts where start_time <= now() and end_time > now() and funded`\n+    `select * from contract_boosts where start_time <= now() and end_time > now() and funded and contract_id is not null`\n   )\n \n   const contractsWithUpdates: Contract[] = []\n   const marketComponents: Record<string, any>[] = []\n@@ -559,8 +559,13 @@\n     weekAgo,\n     posts.map((p) => p.id)\n   )\n \n+  // Get active post boosts\n+  const activePostBoosts = await pg.manyOrNone<Row<'contract_boosts'>>(\n+    `select * from contract_boosts where start_time <= now() and end_time > now() and funded and post_id is not null`\n+  )\n+\n   const postsWithUpdates: { id: string; importance_score: number }[] = []\n \n   for (const post of posts) {\n     const postId = post.id\n@@ -571,15 +576,23 @@\n     const likesToday = dailyPostLikeCounts[postId] ?? 0\n     const likesWeek = weeklyPostLikeCounts[postId] ?? 0 // This is total for the week up to 'weekAgo'\n \n     const todayActivity = commentsToday + likesToday\n-\n     const weekActivityTotal = commentsWeek + likesWeek\n \n+    // Check if this post is boosted\n+    const isBoosted = activePostBoosts.some((b) => b.post_id === postId)\n+    const boostScore = isBoosted ? 3 : 0\n+\n     const rawScore =\n-      normalize(todayActivity, 100) * 2 + normalize(weekActivityTotal, 250)\n+      normalize(todayActivity, 100) * 2 +\n+      normalize(weekActivityTotal, 250) +\n+      boostScore\n \n-    const newImportanceScore = normalize(rawScore, 3)\n+    const newImportanceScore = Math.max(\n+      normalize(rawScore, 3),\n+      isBoosted ? 0.9 : 0\n+    )\n \n     // Only update if the score has changed significantly\n     const epsilon = 0.01\n     if (Math.abs(newImportanceScore - currentImportanceScore) > epsilon) {\n"
        },
        {
          "path": "backend/shared/src/supabase/posts.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/supabase/posts.ts\n===================================================================\n--- backend/shared/src/supabase/posts.ts\t21d26b6 (parent)\n+++ backend/shared/src/supabase/posts.ts\td414e8e (commit)\n@@ -5,9 +5,9 @@\n   pg: SupabaseDirectClient,\n   postId: string\n ): Promise<TopLevelPost | null> {\n   const row = await pg.oneOrNone(\n-    `SELECT data, importance_score FROM old_posts WHERE id = $1`,\n+    `SELECT data, importance_score, boosted FROM old_posts WHERE id = $1`,\n     [postId],\n     convertPost\n   )\n   return row\n"
        },
        {
          "path": "backend/supabase/contract_boosts.sql",
          "status": "modified",
          "diff": "Index: backend/supabase/contract_boosts.sql\n===================================================================\n--- backend/supabase/contract_boosts.sql\t21d26b6 (parent)\n+++ backend/supabase/contract_boosts.sql\td414e8e (commit)\n@@ -1,18 +1,31 @@\n create table if not exists\n   contract_boosts (\n     id bigint generated always as identity primary key,\n-    contract_id text not null references contracts (id),\n+    contract_id text references contracts (id),\n+    post_id text references old_posts (id),\n     user_id text not null references users (id),\n     start_time timestamptz not null,\n     end_time timestamptz not null,\n     created_time timestamptz not null default now(),\n-    funded boolean not null default true\n+    funded boolean not null default true,\n+    constraint contract_boosts_content_check check (\n+      (\n+        contract_id is not null\n+        and post_id is null\n+      )\n+      or (\n+        contract_id is null\n+        and post_id is not null\n+      )\n+    )\n   );\n \n -- Indexes\n create index if not exists contract_boosts_contract_id_idx on contract_boosts (contract_id, start_time, end_time);\n \n+create index if not exists contract_boosts_post_id_idx on contract_boosts (post_id, start_time, end_time);\n+\n create index if not exists contract_boosts_user_id_idx on contract_boosts (user_id);\n \n -- Row Level Security\n alter table contract_boosts enable row level security;\n"
        },
        {
          "path": "backend/supabase/old_posts.sql",
          "status": "modified",
          "diff": "Index: backend/supabase/old_posts.sql\n===================================================================\n--- backend/supabase/old_posts.sql\t21d26b6 (parent)\n+++ backend/supabase/old_posts.sql\td414e8e (commit)\n@@ -7,8 +7,9 @@\n     group_id text,\n     id text primary key default uuid_generate_v4 () not null,\n     visibility text,\n     importance_score numeric default 0 not null,\n+    boosted boolean default false not null\n   );\n \n -- Foreign Keys\n alter table old_posts\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\t21d26b6 (parent)\n+++ common/src/api/schema.ts\td414e8e (commit)\n@@ -2073,19 +2073,28 @@\n     authed: true,\n     props: z.object({ contractId: z.string(), optionId: z.string() }),\n     returns: [] as DisplayUser[],\n   },\n-  'purchase-contract-boost': {\n+  'purchase-boost': {\n     method: 'POST',\n     visibility: 'public',\n     authed: true,\n     props: z\n       .object({\n-        contractId: z.string(),\n+        contractId: z.string().optional(),\n+        postId: z.string().optional(),\n         startTime: z.number().positive().finite().safe(),\n         method: z.enum(['mana', 'cash', 'admin-free']),\n       })\n-      .strict(),\n+      .strict()\n+      .refine(\n+        (data) =>\n+          (data.contractId && !data.postId) ||\n+          (!data.contractId && data.postId),\n+        {\n+          message: 'Either contractId or postId must be provided, but not both',\n+        }\n+      ),\n     returns: {} as { success: boolean; checkoutUrl?: string },\n   },\n   'generate-ai-numeric-ranges': {\n     method: 'POST',\n"
        },
        {
          "path": "common/src/supabase/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/supabase/schema.ts\n===================================================================\n--- common/src/supabase/schema.ts\t21d26b6 (parent)\n+++ common/src/supabase/schema.ts\td414e8e (commit)\n@@ -268,27 +268,36 @@\n         Relationships: []\n       }\n       contract_boosts: {\n         Row: {\n-          contract_id: string\n+          contract_id: string | null\n+          post_id: string | null\n           end_time: string\n           id: number\n           start_time: string\n           user_id: string\n+          created_time: string\n+          funded: boolean\n         }\n         Insert: {\n-          contract_id: string\n+          contract_id?: string | null\n+          post_id?: string | null\n           end_time: string\n           id?: never\n           start_time: string\n           user_id: string\n+          created_time?: string\n+          funded?: boolean\n         }\n         Update: {\n-          contract_id?: string\n+          contract_id?: string | null\n+          post_id?: string | null\n           end_time?: string\n           id?: never\n           start_time?: string\n           user_id?: string\n+          created_time?: string\n+          funded?: boolean\n         }\n         Relationships: [\n           {\n             foreignKeyName: 'contract_boosts_contract_id_fkey'\n"
        },
        {
          "path": "common/src/top-level-post.ts",
          "status": "modified",
          "diff": "Index: common/src/top-level-post.ts\n===================================================================\n--- common/src/top-level-post.ts\t21d26b6 (parent)\n+++ common/src/top-level-post.ts\td414e8e (commit)\n@@ -33,8 +33,9 @@\n   visibility: Visibility\n   unlistedById?: string\n   isAnnouncement?: boolean\n   isChangeLog?: boolean\n+  boosted: boolean\n   /** @deprecated - not deprecated, only updated in native column though*/\n   importanceScore: number\n   /** @deprecated - not deprecated, only available via the get-posts endpoint*/\n   uniqueUsers?: number\n"
        },
        {
          "path": "common/src/txn.ts",
          "status": "modified",
          "diff": "Index: common/src/txn.ts\n===================================================================\n--- common/src/txn.ts\t21d26b6 (parent)\n+++ common/src/txn.ts\td414e8e (commit)\n@@ -595,9 +595,10 @@\n   fromType: 'USER'\n   toType: 'BANK'\n   token: 'M$'\n   data: {\n-    contractId: string\n+    contractId?: string\n+    postId?: string\n     boostId: string\n   }\n }\n \n"
        },
        {
          "path": "web/components/contract/add-boost-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/add-boost-button.tsx\n===================================================================\n--- web/components/contract/add-boost-button.tsx\t21d26b6 (parent)\n+++ web/components/contract/add-boost-button.tsx\td414e8e (commit)\n@@ -96,9 +96,9 @@\n \n   const purchaseBoost = async (paymentMethod: 'mana' | 'cash') => {\n     setLoading(paymentMethod)\n     try {\n-      const result = (await api('purchase-contract-boost', {\n+      const result = (await api('purchase-boost', {\n         contractId: contract.id,\n         startTime,\n         method: paymentMethod,\n       })) as { success: boolean; checkoutUrl?: string }\n@@ -121,9 +121,9 @@\n \n   const handleAdminFreeBoost = async () => {\n     setLoading('admin-free')\n     try {\n-      const result = (await api('purchase-contract-boost', {\n+      const result = (await api('purchase-boost', {\n         contractId: contract.id,\n         startTime,\n         method: 'admin-free',\n       })) as { success: boolean }\n"
        },
        {
          "path": "web/components/posts/add-post-boost-button.tsx",
          "status": "added",
          "diff": "Index: web/components/posts/add-post-boost-button.tsx\n===================================================================\n--- web/components/posts/add-post-boost-button.tsx\t21d26b6 (parent)\n+++ web/components/posts/add-post-boost-button.tsx\td414e8e (commit)\n@@ -0,0 +1,208 @@\n+import { useState } from 'react'\n+import { Button } from '../buttons/button'\n+import { Modal } from '../layout/modal'\n+import { Col } from '../layout/col'\n+import { Row } from '../layout/row'\n+import { TopLevelPost } from 'common/top-level-post'\n+import { useUser } from 'web/hooks/use-user'\n+import { api } from 'web/lib/api/api'\n+import { AddFundsModal } from '../add-funds-modal'\n+import toast from 'react-hot-toast'\n+import { BsRocketTakeoff } from 'react-icons/bs'\n+import { BOOST_COST_MANA } from 'common/economy'\n+import dayjs from 'dayjs'\n+import { Input } from '../widgets/input'\n+import { HOUR_MS } from 'common/util/time'\n+import { formatMoney } from 'common/util/format'\n+import { useAdminOrMod } from 'web/hooks/use-admin'\n+\n+export function AddPostBoostButton(props: { post: TopLevelPost }) {\n+  const { post } = props\n+  const [showPurchase, setShowPurchase] = useState(false)\n+  const user = useUser()\n+\n+  if (!user) return null\n+\n+  const disabled = post.visibility !== 'public'\n+\n+  if (disabled) return null\n+  const { boosted } = post\n+  return (\n+    <>\n+      <Button\n+        onClick={() => setShowPurchase(true)}\n+        color={boosted ? 'indigo-outline' : 'gradient-pink'}\n+        className={'w-28'}\n+        data-boost-button\n+      >\n+        <BsRocketTakeoff className=\"mr-1 h-5 w-5\" />\n+        {boosted ? 'Boosted' : 'Boost'}\n+      </Button>\n+\n+      <PostBoostPurchaseModal\n+        open={showPurchase}\n+        setOpen={setShowPurchase}\n+        post={post}\n+      />\n+    </>\n+  )\n+}\n+\n+function PostBoostPurchaseModal(props: {\n+  open: boolean\n+  setOpen: (open: boolean) => void\n+  post: TopLevelPost\n+}) {\n+  const { open, setOpen, post } = props\n+  const [loading, setLoading] = useState<string>()\n+  const [fundsModalOpen, setFundsModalOpen] = useState(false)\n+  const now = Date.now()\n+  const [startTime, setStartTime] = useState(now)\n+  const user = useUser()\n+  const isAdminOrMod = useAdminOrMod()\n+\n+  if (!user) return null\n+\n+  const notEnoughFunds = (user.balance ?? 0) < BOOST_COST_MANA\n+\n+  const purchaseBoost = async (paymentMethod: 'mana' | 'cash') => {\n+    setLoading(paymentMethod)\n+    try {\n+      const result = (await api('purchase-boost', {\n+        postId: post.id,\n+        startTime,\n+        method: paymentMethod,\n+      })) as { success: boolean; checkoutUrl?: string }\n+\n+      if (result.checkoutUrl) {\n+        window.location.href = result.checkoutUrl\n+        return\n+      }\n+\n+      toast.success(\n+        'Post boosted! It will be featured on the homepage for 24 hours.'\n+      )\n+      setOpen(false)\n+    } catch (e) {\n+      console.error(e)\n+      toast.error(e instanceof Error ? e.message : 'Error purchasing boost')\n+    }\n+    setLoading(undefined)\n+  }\n+\n+  const handleAdminFreeBoost = async () => {\n+    setLoading('admin-free')\n+    try {\n+      const result = (await api('purchase-boost', {\n+        postId: post.id,\n+        startTime,\n+        method: 'admin-free',\n+      })) as { success: boolean }\n+\n+      if (result.success) {\n+        toast.success(\n+          'Post boosted for free! It will be featured on the homepage for 24 hours.'\n+        )\n+        setOpen(false)\n+      }\n+    } catch (e) {\n+      console.error(e)\n+      toast.error(e instanceof Error ? e.message : 'Error applying free boost')\n+    }\n+    setLoading(undefined)\n+  }\n+\n+  return (\n+    <>\n+      <Modal open={open} setOpen={setOpen} size=\"sm\">\n+        <Col className=\"bg-canvas-0 gap-4 rounded-lg p-6\">\n+          <Row className=\"items-center gap-2 text-xl font-semibold\">\n+            <BsRocketTakeoff className=\"h-6 w-6\" />\n+            Boost this post\n+          </Row>\n+\n+          <div className=\"text-ink-600\">\n+            Boost this post's visibility on the homepage{' '}\n+            {Math.abs(startTime - now) < HOUR_MS\n+              ? 'for the next 24 hours'\n+              : `from ${dayjs(startTime).format('MMM D')} to ${dayjs(startTime)\n+                  .add(24, 'hours')\n+                  .format('MMM D')}`}\n+          </div>\n+\n+          <Row className=\"items-center gap-2\">\n+            <div className=\"text-ink-600\">Start time:</div>\n+            <Input\n+              type={'date'}\n+              className=\"dark:date-range-input-white\"\n+              onClick={(e) => e.stopPropagation()}\n+              onChange={(e) => {\n+                const start = dayjs(e.target.value).startOf('day').valueOf()\n+                if (start < Date.now()) {\n+                  setStartTime(Date.now())\n+                } else {\n+                  setStartTime(start)\n+                }\n+              }}\n+              min={dayjs().format('YYYY-MM-DD')}\n+              max=\"3000-12-31\"\n+              disabled={!!loading}\n+              value={dayjs(startTime).format('YYYY-MM-DD')}\n+            />\n+          </Row>\n+\n+          <Row className=\"gap-2\">\n+            <Button\n+              color=\"indigo\"\n+              onClick={() => purchaseBoost('mana')}\n+              loading={loading === 'mana'}\n+              disabled={!!loading || notEnoughFunds}\n+              className=\"flex-1\"\n+            >\n+              Pay {formatMoney(BOOST_COST_MANA)}\n+            </Button>\n+            <Button\n+              color=\"indigo\"\n+              onClick={() => purchaseBoost('cash')}\n+              loading={loading === 'cash'}\n+              className=\"flex-1\"\n+              disabled={!!loading}\n+            >\n+              Pay $100\n+            </Button>\n+          </Row>\n+\n+          {isAdminOrMod && (\n+            <Row className=\"gap-2\">\n+              <Button\n+                color=\"indigo-outline\"\n+                onClick={handleAdminFreeBoost}\n+                loading={loading === 'admin-free'}\n+                disabled={!!loading}\n+                className=\"flex-1\"\n+              >\n+                <BsRocketTakeoff className=\"mr-1 h-5 w-5\" />\n+                Free Admin Boost\n+              </Button>\n+            </Row>\n+          )}\n+\n+          {notEnoughFunds && (\n+            <div className=\"text-ink-600 flex items-center gap-2 text-sm\">\n+              <span className=\"text-error\">Insufficient balance</span>\n+              <Button\n+                size=\"xs\"\n+                color=\"gradient-pink\"\n+                onClick={() => setFundsModalOpen(true)}\n+              >\n+                Get mana\n+              </Button>\n+            </div>\n+          )}\n+        </Col>\n+      </Modal>\n+\n+      <AddFundsModal open={fundsModalOpen} setOpen={setFundsModalOpen} />\n+    </>\n+  )\n+}\n"
        },
        {
          "path": "web/components/posts/post-row.tsx",
          "status": "modified",
          "diff": "Index: web/components/posts/post-row.tsx\n===================================================================\n--- web/components/posts/post-row.tsx\t21d26b6 (parent)\n+++ web/components/posts/post-row.tsx\td414e8e (commit)\n@@ -8,8 +8,9 @@\n import { UserIcon } from '@heroicons/react/solid'\n import { Tooltip } from '../widgets/tooltip'\n import { UserHovercard } from '../user/user-hovercard'\n import { EyeOffIcon } from '@heroicons/react/outline'\n+import { BoostedTooltip } from '../contract/boost-column'\n \n export function PostRow(props: {\n   post: TopLevelPost\n   highlighted?: boolean\n@@ -70,16 +71,23 @@\n           {/* Hide normal action columns row on mobile when showing position row */}\n           <Row\n             className={clsx('w-full items-center justify-end gap-8 sm:w-fit')}\n           >\n-            <Tooltip\n-              text={`${post.uniqueUsers} unique users commented or reacted`}\n-            >\n-              <Row className=\"text-ink-700 w-[4.62rem] items-center justify-start gap-0.5\">\n-                <UserIcon className={'text-ink-400 h-4 w-4 shrink-0'} />\n-                {post.uniqueUsers}\n-              </Row>\n-            </Tooltip>\n+            <Row>\n+              <BoostedTooltip\n+                boosted={post.boosted}\n+                placement={'top'}\n+                className=\"mr-3 w-4\"\n+              />\n+              <Tooltip\n+                text={`${post.uniqueUsers} unique users commented or reacted`}\n+              >\n+                <Row className=\"text-ink-700 w-[6.5rem] items-center justify-start gap-0.5 sm:w-[4.62rem]\">\n+                  <UserIcon className={'text-ink-400 h-4 w-4 shrink-0'} />\n+                  {post.uniqueUsers}\n+                </Row>\n+              </Tooltip>\n+            </Row>\n             <div className=\"w-12 text-cyan-600\">POST</div>\n             <div className=\"invisible w-12\"></div>\n           </Row>\n         </Col>\n"
        },
        {
          "path": "web/pages/post/[slug]/index.tsx",
          "status": "modified",
          "diff": "Index: web/pages/post/[slug]/index.tsx\n===================================================================\n--- web/pages/post/[slug]/index.tsx\t21d26b6 (parent)\n+++ web/pages/post/[slug]/index.tsx\td414e8e (commit)\n@@ -39,8 +39,9 @@\n import { BackButton } from 'web/components/contract/back-button'\n import { report as reportContent } from 'web/lib/api/api'\n import { IoWarning } from 'react-icons/io5'\n import { FollowPostButton } from 'web/components/buttons/follow-post-button'\n+import { AddPostBoostButton } from 'web/components/posts/add-post-boost-button'\n \n export async function getStaticProps(props: { params: { slug: string } }) {\n   const { slug } = props.params\n \n@@ -81,9 +82,8 @@\n   const currentUser = useUser()\n   useSaveReferral(currentUser, {\n     defaultReferrerUsername: post?.creatorUsername,\n   })\n-\n   useEffect(() => {\n     setPost(props.post)\n   }, [props.post])\n \n@@ -273,8 +273,11 @@\n               setEditing={setEditing}\n             />\n           </div>\n         </div>\n+        <Row>\n+          <AddPostBoostButton post={post} />\n+        </Row>\n         <Spacer h={4} />\n         <PostCommentsActivity post={post} comments={comments} />\n       </Col>\n     </Page>\n"
        }
      ]
    },
    {
      "id": "add-free-markets",
      "sha": "ddb266fa95162854d4de4dbd7ea4fee3d8ae25d5",
      "parentSha": "7173b73b777cc2871f29a10e958533e447c58435",
      "spec": "Implement a free-market creation feature and update ante generation across backend and web:\n\n1) Add a new constant for the free-market user\n- File: common/src/economy.ts\n- Export a new constant FREE_MARKET_USER_ID set to the provided user ID string. Ensure it is exported alongside existing economy constants so both backend and web can import it.\n\n2) Allow free creation for the special user in the API and fund via house provider\n- File: backend/api/src/create-market.ts\n- Imports:\n  - Add FREE_MARKET_USER_ID from common/economy.\n  - Add isProd from shared/utils.\n  - Add DEV_HOUSE_LIQUIDITY_PROVIDER_ID and HOUSE_LIQUIDITY_PROVIDER_ID from common/antes.\n- Compute ante and totalMarketCost as usual.\n- Introduce a boolean isFree that is true if auth.uid equals FREE_MARKET_USER_ID and totalMarketCost <= 100.\n- Replace the existing balance check to:\n  - If not isFree and totalMarketCost > user.balance, return 403 with the existing balance error.\n  - If isFree, enforce a daily limit: query the database for count of contracts where creator_id = auth.uid and created_time > now() - interval '1 day'. If count >= 5, return 403 with the message: \"Tumblingnomics has reached its breaking point. No more free markets today.\"\n- After inserting the new contract (and any answers), before transferring the ante, determine the liquidity provider:\n  - const house = isProd() ? HOUSE_LIQUIDITY_PROVIDER_ID : DEV_HOUSE_LIQUIDITY_PROVIDER_ID\n  - const providerId = isFree ? house : userId\n- Use providerId as fromId in the CREATE_CONTRACT_ANTE transaction (runTxnOutsideBetQueue) instead of the userId.\n- Update the generateAntes call to match the new signature detailed below, passing providerId and removing the outcomeType argument.\n\n3) Simplify generateAntes signature to remove outcomeType and update logic\n- File: backend/shared/src/create-contract-helpers.ts\n- Remove OutcomeType import and parameter from generateAntes. The new signature should be:\n  - generateAntes(pg: SupabaseDirectClient, providerId: string, contract: Contract, ante: number, totalMarketCost: number)\n- Implementation requirements:\n  - For cpmm-multi-1 without shouldAnswersSumToOne, iterate answers and insert initial ante liquidity per answer using getCpmmInitialLiquidity with providerId.\n  - Else for cpmm-multi-1 or cpmm-1, insert a single initial ante liquidity using getCpmmInitialLiquidity with providerId.\n  - Compute drizzledAmount = totalMarketCost - ante; if > 0 and mechanism is cpmm-1 or cpmm-multi-1, run a transaction to:\n    - Transfer drizzledAmount from providerId to contract (category 'ADD_SUBSIDY', token 'M$').\n    - Insert a new liquidity provision for drizzledAmount via getNewLiquidityProvision.\n    - Update the contract subsidyPool and totalLiquidity by drizzledAmount.\n\n4) Update all generateAntes call sites to match the new signature\n- File: backend/api/src/create-market.ts\n  - Update the call to: await generateAntes(tx, providerId, contract, ante, totalMarketCost)\n- File: backend/scripts/reimburse-broken-markets.ts\n  - Update the import to use the shared helper (shared/create-contract-helpers) if needed, and update the call to remove the outcomeType argument: await generateAntes(tx, c.user_id, contract, c.amount, c.amount)\n\n5) Update the web creation form to allow free creation for the special user\n- File: web/components/new-contract/contract-params-form.tsx\n- Imports:\n  - Add FREE_MARKET_USER_ID from common/economy.\n- After computing ante and other validation flags, compute isFree = creator.id === FREE_MARKET_USER_ID && ante <= 100.\n- Update the isValid expression to allow creation when isFree regardless of balance: replace ante <= balance with (isFree ? true : ante <= balance).\n- When rendering the CostSection, pass a balance prop of 100 if isFree, else the user's actual balance. This keeps the UI from showing 'Insufficient balance' for free markets within the ante cap.\n\nBehavioral outcomes:\n- The specified user can create up to 5 markets per rolling 24 hours without needing balance, as long as the total creation cost (ante + extraLiquidity) is <= 100. These are funded by the house liquidity provider chosen by environment. All other users or higher costs use the normal flow and require sufficient balance.\n- Initial ante and any additional drizzled liquidity are attributed to the providerId (house for free, user otherwise).\n- The UI reflects the free-creation state by bypassing the balance requirement and preventing spurious insufficient balance warnings for the capped free case.",
      "prompt": "Add a free market creation capability for a designated internal user. This user should be able to create up to a handful of markets per day without needing balance when the required liquidity is small, and those markets should be funded by the house account depending on environment. Simplify the ante/liquidity generation helper by removing unnecessary parameters, and update the server to attribute both the initial ante and any extra subsidy to the selected funding account. Finally, update the market creation form so this user can create small-ante markets without tripping balance validation and without seeing an incorrect insufficient balance warning.",
      "supplementalFiles": [
        "backend/shared/src/utils.ts",
        "common/src/antes.ts",
        "backend/shared/src/helpers/add-house-subsidy.ts",
        "backend/api/src/remove-liquidity.ts",
        "web/components/new-contract/cost-section.tsx",
        "backend/scripts/reimburse-broken-markets.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/create-market.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/create-market.ts\n===================================================================\n--- backend/api/src/create-market.ts\t7173b73 (parent)\n+++ backend/api/src/create-market.ts\tddb266f (commit)\n@@ -20,9 +20,9 @@\n   nativeContractColumnsArray,\n   NUMBER_CREATION_ENABLED,\n   PollVoterVisibility,\n } from 'common/contract'\n-import { getAnte } from 'common/economy'\n+import { FREE_MARKET_USER_ID, getAnte } from 'common/economy'\n import { MAX_GROUPS_PER_MARKET } from 'common/group'\n import { getNewContract } from 'common/new-contract'\n import { getPseudoProbability } from 'common/pseudo-numeric'\n import { STONK_INITIAL_PROB } from 'common/stonk'\n@@ -44,10 +44,15 @@\n import {\n   addGroupToContract,\n   canUserAddGroupToMarket,\n } from 'shared/update-group-contracts-internal'\n-import { contractColumnsToSelect, htmlToRichText, log } from 'shared/utils'\n import {\n+  contractColumnsToSelect,\n+  htmlToRichText,\n+  isProd,\n+  log,\n+} from 'shared/utils'\n+import {\n   broadcastNewAnswer,\n   broadcastNewContract,\n } from 'shared/websockets/helpers'\n import { APIError, AuthedUser, type APIHandler } from './helpers/endpoint'\n@@ -60,8 +65,12 @@\n import { betsQueue } from 'shared/helpers/fn-queue'\n import { convertUser } from 'common/supabase/users'\n import { camelCase, first } from 'lodash'\n import { getMultiNumericAnswerBucketRangeNames } from 'common/number'\n+import {\n+  DEV_HOUSE_LIQUIDITY_PROVIDER_ID,\n+  HOUSE_LIQUIDITY_PROVIDER_ID,\n+} from 'common/antes'\n type Body = ValidatedAPIParams<'market'>\n \n export const createMarket: APIHandler<'market'> = async (body, auth) => {\n   const pg = createSupabaseDirectClient()\n@@ -181,10 +190,22 @@\n       const user = first(userAndSlugResult[0].map(convertUser))\n       if (!user) throw new APIError(401, 'Your account was not found')\n       if (user.isBannedFromPosting) throw new APIError(403, 'You are banned')\n \n-      if (totalMarketCost > user.balance)\n+      const isFree = userId === FREE_MARKET_USER_ID && totalMarketCost <= 100\n+      if (!isFree && totalMarketCost > user.balance)\n         throw new APIError(403, `Balance must be at least ${totalMarketCost}.`)\n+      if (isFree) {\n+        const contractsToday = await tx.oneOrNone(\n+          `select count(*) from contracts where creator_id = $1 and created_time > now() - interval '1 day'`,\n+          [userId]\n+        )\n+        if (contractsToday && contractsToday.count >= 5)\n+          throw new APIError(\n+            403,\n+            'Tumblingnomics has reached its breaking point. No more free markets today.'\n+          )\n+      }\n \n       const slug = getSlug(!!first(userAndSlugResult[1]), proposedSlug)\n \n       const contract = getNewContract(\n@@ -254,10 +275,14 @@\n \n       if (result[1].length > 0 && contract.mechanism === 'cpmm-multi-1') {\n         contract.answers = result[1].map(convertAnswer)\n       }\n+      const house = isProd()\n+        ? HOUSE_LIQUIDITY_PROVIDER_ID\n+        : DEV_HOUSE_LIQUIDITY_PROVIDER_ID\n+      const providerId = isFree ? house : userId\n       await runTxnOutsideBetQueue(tx, {\n-        fromId: userId,\n+        fromId: providerId,\n         fromType: 'USER',\n         toId: contract.id,\n         toType: 'CONTRACT',\n         amount: ante,\n@@ -271,16 +296,9 @@\n         question,\n         ante: ante || 0,\n       })\n \n-      await generateAntes(\n-        tx,\n-        userId,\n-        contract,\n-        outcomeType,\n-        ante,\n-        totalMarketCost\n-      )\n+      await generateAntes(tx, providerId, contract, ante, totalMarketCost)\n \n       return { contract, user }\n     })\n   }, [userId])\n"
        },
        {
          "path": "backend/shared/src/create-contract-helpers.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/create-contract-helpers.ts\n===================================================================\n--- backend/shared/src/create-contract-helpers.ts\t7173b73 (parent)\n+++ backend/shared/src/create-contract-helpers.ts\tddb266f (commit)\n@@ -1,12 +1,7 @@\n import { getNewLiquidityProvision } from 'common/add-liquidity'\n import { getCpmmInitialLiquidity } from 'common/antes'\n-import {\n-  BinaryContract,\n-  Contract,\n-  CPMMMultiContract,\n-  OutcomeType,\n-} from 'common/contract'\n+import { BinaryContract, Contract, CPMMMultiContract } from 'common/contract'\n import { updateContract } from './supabase/contracts'\n import { SupabaseDirectClient } from './supabase/init'\n import { insertLiquidity } from './supabase/liquidity'\n import { FieldVal } from './supabase/utils'\n@@ -15,9 +10,8 @@\n export async function generateAntes(\n   pg: SupabaseDirectClient,\n   providerId: string,\n   contract: Contract,\n-  outcomeType: OutcomeType,\n   ante: number,\n   totalMarketCost: number\n ) {\n   if (\n"
        },
        {
          "path": "common/src/economy.ts",
          "status": "modified",
          "diff": "Index: common/src/economy.ts\n===================================================================\n--- common/src/economy.ts\t7173b73 (parent)\n+++ common/src/economy.ts\tddb266f (commit)\n@@ -164,4 +164,5 @@\n export const PROFIT_FEE_FRACTION = 0.1\n export const BOOST_COST_MANA = 10000\n export const DEV_BOOST_STRIPE_PRICE_ID = 'price_1QuI5BGdoFKoCJW7lMjCIuKW'\n export const PROD_BOOST_STRIPE_PRICE_ID = 'price_1QuItEGdoFKoCJW7t9qtiGoD'\n+export const FREE_MARKET_USER_ID = '6hHpzvRG0pMq8PNJs7RZj2qlZGn2'\n"
        },
        {
          "path": "web/components/new-contract/contract-params-form.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/contract-params-form.tsx\n===================================================================\n--- web/components/new-contract/contract-params-form.tsx\t7173b73 (parent)\n+++ web/components/new-contract/contract-params-form.tsx\tddb266f (commit)\n@@ -16,8 +16,9 @@\n   PollVoterVisibility,\n   contractPath,\n } from 'common/contract'\n import {\n+  FREE_MARKET_USER_ID,\n   getAnte,\n   getUniqueBettorBonusAmount,\n   MINIMUM_BOUNTY,\n } from 'common/economy'\n@@ -433,12 +434,13 @@\n   const midpointsError =\n     outcomeType === 'MULTI_NUMERIC' || outcomeType === 'DATE'\n       ? midpoints.length !== answers.length\n       : false\n+  const isFree = creator.id === FREE_MARKET_USER_ID && ante <= 100\n \n   const isValid =\n     isValidQuestion &&\n-    ante <= balance &&\n+    (isFree ? true : ante <= balance) &&\n     isValidDate &&\n     isValidTopics &&\n     (outcomeType !== 'PSEUDO_NUMERIC' ||\n       (initialValue !== undefined &&\n@@ -1086,9 +1088,9 @@\n           }}\n         />\n       </Row>\n       <CostSection\n-        balance={balance}\n+        balance={isFree ? 100 : balance}\n         numAnswers={numAnswers}\n         outcomeType={outcomeType}\n         liquidityTier={liquidityTier}\n         setLiquidityTier={setLiquidityTier}\n"
        }
      ]
    },
    {
      "id": "add-followed-topic",
      "sha": "eebf7d4af349d077aa96752258fc7a6a982ae836",
      "parentSha": "2235551419907693c34b204350026e34712e668b",
      "spec": "Implement a “Followed” topic filter for search that surfaces markets and topics from the groups a signed-in user follows, and update the search UX accordingly.\n\nScope and requirements:\n\n1) Common API types\n- File: common/src/api/market-search-types.ts\n  - Extend searchProps.topicSlug’s Zod schema so it accepts:\n    - A Firestore-ID-like string matching FIRESTORE_DOC_REF_ID_REGEX\n    - The literal 'recent'\n    - The literal 'followed'\n  - Keep existing defaults for other fields.\n\n2) Backend search behavior\n- File: backend/api/src/search-contracts.ts\n  - Adjust props destructuring so 'gids' is captured into a local variable (e.g., gids) rather than shadowing a computed groupIds array.\n  - Introduce support for a special topicSlug value 'followed'.\n    - Compute flags:\n      - isRecent when topicSlug === 'recent'\n      - isFollowed when topicSlug === 'followed'\n    - Only look up a single groupId by slug when the topicSlug is neither 'recent' nor 'followed'. Use a dedicated variable for this (e.g., topicSlugForGroupIdLookup) and pass it to getGroupIdFromSlug.\n  - Determine the groupIds array for search as follows:\n    - If isFollowed and the request has a userId, query Supabase for the list of group_id values from group_members where member_id = userId. Use createSupabaseDirectClient().\n    - Otherwise, expand parent topic IDs from the 'gids' request parameter by calling getAllSubTopicsForParentTopicIds(pg, gids).\n  - If isFollowed and userId is present and the derived groupIds length is 0, return an empty result set immediately.\n  - Wherever the search logic previously gated on the presence of a topic slug, switch checks to use the new topicSlugForGroupIdLookup variable so that 'followed' does not trigger slug-based groupId logic.\n  - When constructing SQL fragments/queries for the final search, pass the computed groupIds array (from the logic above) instead of any prior variable derived from gids.\n\n3) Common Supabase helper\n- File: common/src/supabase/groups.ts\n  - Add an exported function getFollowedGroupsCount(db: SupabaseClient, userId: string): Promise<number> that returns the exact count of rows in group_members with member_id = userId. Use run(...) and .select('group_id', { count: 'exact' }).\n\n4) Web search UI and behavior\n- File: web/components/search.tsx\n  - Imports: add useUser, useAPIGetter, getFollowedGroupsCount from common/supabase/groups, db from web/lib/supabase/db, and DAY_MS from common/util/time.\n  - In FILTERS, rename the 'News' label to 'Recently changed' (value remains 'news').\n  - When initializing search state (useSearchState or equivalent), provide:\n    - defaultTopicFilter set to the incoming topicSlug prop.\n    - defaultSweepies set to '2' when hideSweepsToggle is true; otherwise preserve current behavior, respecting prefersPlay.\n  - Compute selectedFollowed as searchParams[TOPIC_FILTER_KEY] === 'followed'.\n  - Update showSearchTypes so that user/topic result sections are hidden when selectedFollowed is true.\n  - Pass the raw searchParams into useSearchResults (remove any prior mutation of searchParams such as merging topicSlug or overriding sweepies state).\n  - Header topic controls:\n    - “All” button: when selected, also clear TOPIC_FILTER_KEY (and clear GROUP_IDS_KEY). Do not toggle the filter away from 'news' here.\n    - Add a “Followed” button visible for signed-in users that, when clicked, sets TOPIC_FILTER_KEY to 'followed' and clears GROUP_IDS_KEY.\n    - For parent topic buttons (ALL_PARENT_TOPICS / TOPICS_TO_SUBTOPICS): when selecting a parent topic, set GROUP_IDS_KEY to the flattened set of that parent’s subtopic group IDs, and clear TOPIC_FILTER_KEY. Do not implement a toggle-back behavior tied to 'news'.\n  - Followed topics and discovery sections (shown only when selectedFollowed):\n    - “Your Followed Topics”: fetch with useAPIGetter('search-groups', { limit: 150, type: 'lite', term: query, memberGroupsOnly: true }) and render as pills via BrowseTopicPills. Show a loading message while fetching.\n    - Maintain a followedCount state that is refreshed on page visibility when selectedFollowed and user.id are present by calling getFollowedGroupsCount(db, user.id). When followedCount changes, refresh followed groups and also refresh contracts via refreshContracts().\n    - “Explore Topics To Follow”: conditionally load trending topics via useAPIGetter('search-groups', { limit: 100, type: 'lite', term: query }) when the user is new (createdTime within DAY_MS) or they follow fewer than 5 groups. Filter out topics already followed. Render via BrowseTopicPills with clipOnMobile and, when the contracts list is empty, show more pills initially (initialShown ~20).\n  - Search execution hooks (useSearchResults integration):\n    - In the querySearchResults function, no-op early when isReady is false.\n    - On mount or when isReady flips true, if there are no contracts yet, trigger an initial query.\n    - Replace the prior debounced effect that depended on isReady with a debounced effect that always triggers querySearchResults(true) on searchParams changes. Keep a small debounce (~50ms).\n\n5) Topic pills component enhancements\n- File: web/components/topics/browse-topic-pills.tsx\n  - Extend props to accept clipOnMobile?: boolean and initialShown?: number.\n  - Use useIsMobile() to set the max number of initially shown pills:\n    - maxShown = initialShown ?? (isMobile && clipOnMobile ? 4 : MAX_SHOWN)\n  - Use maxShown instead of MAX_SHOWN for both slicing the topics to show and for the “Show N more” count.\n\n6) Integration expectations\n- The server-side 'search-contracts' must return an empty array for 'followed' when a signed-in user follows zero groups, and otherwise constrain results based on the user’s followed group IDs.\n- The 'search-groups' endpoint must support memberGroupsOnly to return only the groups the signed-in user follows, and support a 'lite' result shape compatible with BrowseTopicPills. If not already supported, add it accordingly in the backend to align with the new UI calls.\n- Ensure existing constants TOPIC_FILTER_KEY and GROUP_IDS_KEY continue to be used for URL state and that selecting 'Followed' does not conflict with parent topic selection.\n",
      "prompt": "Add a Followed topic to the site-wide search experience so signed-in users can browse markets from topics they follow. When a user selects Followed, the backend should restrict search results to the groups the user belongs to; if they don’t follow any groups, show no results. In the UI, add a Followed tab next to All and parent topic tabs. Under Followed, show their followed topics as pills, and if they’re new or follow very few topics, also show a curated list of trending topics they don’t already follow. Ensure the search parameter schema accepts both regular topic slugs and the special values recent and followed. Update the search effects so queries run reliably on parameter changes, and adjust the topic pills component to handle mobile clipping and an optional larger initial count. Keep the existing “recently changed” filter label replacing the old News label. Use existing keys for topic filters and group IDs in the URL state.",
      "supplementalFiles": [
        "common/src/topics.ts",
        "web/hooks/use-api-getter.ts",
        "web/lib/supabase/db.ts",
        "web/hooks/use-user.ts",
        "common/src/group.ts",
        "common/src/util/time.ts",
        "common/src/util/string.ts",
        "common/src/supabase/utils.ts",
        "backend/shared/src/supabase/groups.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/search-contracts.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/search-contracts.ts\n===================================================================\n--- backend/api/src/search-contracts.ts\t2235551 (parent)\n+++ backend/api/src/search-contracts.ts\teebf7d4 (commit)\n@@ -45,9 +45,9 @@\n     limit,\n     topicSlug: possibleTopicSlug,\n     forYou,\n     token,\n-    gids: groupIds,\n+    gids,\n   } = props\n   const isPrizeMarket =\n     props.isPrizeMarket == 'true' || props.isPrizeMarket == '1'\n \n@@ -56,22 +56,32 @@\n   }\n \n   const isForYou = forYou === '1'\n   const isRecent = possibleTopicSlug === 'recent'\n-  const topicSlug =\n-    possibleTopicSlug && !isRecent ? possibleTopicSlug : undefined\n+  const isFollowed = possibleTopicSlug === 'followed'\n+  const topicSlugForGroupIdLookup =\n+    possibleTopicSlug && !isRecent && !isFollowed\n+      ? possibleTopicSlug\n+      : undefined\n   const pg = createSupabaseDirectClient()\n-  const groupId = topicSlug\n-    ? await getGroupIdFromSlug(topicSlug, pg)\n+  const groupId = topicSlugForGroupIdLookup\n+    ? await getGroupIdFromSlug(topicSlugForGroupIdLookup, pg)\n     : undefined\n-  const groupIdsForSearchSql = await getAllSubTopicsForParentTopicIds(\n-    pg,\n-    groupIds\n-  )\n+  const groupIds =\n+    isFollowed && !!userId\n+      ? await pg.map(\n+          'select group_id from group_members where member_id = $1',\n+          [userId],\n+          (r) => r.group_id\n+        )\n+      : await getAllSubTopicsForParentTopicIds(pg, gids)\n+  if (isFollowed && userId && groupIds.length === 0) {\n+    return []\n+  }\n   if (\n     filter !== 'news' &&\n     !term &&\n-    !topicSlug &&\n+    !topicSlugForGroupIdLookup &&\n     !groupIds &&\n     (sort === 'score' || sort === 'freshness-score') &&\n     (token === 'MANA' || token === 'ALL') &&\n     !isRecent\n@@ -119,9 +129,9 @@\n           uid: userId,\n           searchType,\n           groupId,\n           isPrizeMarket,\n-          groupIds: groupIdsForSearchSql,\n+          groupIds,\n         })\n       )\n       .join(';')\n \n"
        },
        {
          "path": "common/src/api/market-search-types.ts",
          "status": "modified",
          "diff": "Index: common/src/api/market-search-types.ts\n===================================================================\n--- common/src/api/market-search-types.ts\t2235551 (parent)\n+++ common/src/api/market-search-types.ts\teebf7d4 (commit)\n@@ -54,9 +54,14 @@\n       ])\n       .default('ALL'),\n     offset: z.coerce.number().gte(0).default(0),\n     limit: z.coerce.number().gt(0).lte(1000).default(100),\n-    topicSlug: z.string().regex(FIRESTORE_DOC_REF_ID_REGEX).optional(),\n+    topicSlug: z\n+      .string()\n+      .regex(FIRESTORE_DOC_REF_ID_REGEX)\n+      .or(z.literal('recent'))\n+      .or(z.literal('followed'))\n+      .optional(),\n     forYou: z.union([z.literal('1'), z.literal('0')]).default('0'),\n     creatorId: z.string().regex(FIRESTORE_DOC_REF_ID_REGEX).optional(),\n     isPrizeMarket: z\n       .union([\n"
        },
        {
          "path": "common/src/supabase/groups.ts",
          "status": "modified",
          "diff": "Index: common/src/supabase/groups.ts\n===================================================================\n--- common/src/supabase/groups.ts\t2235551 (parent)\n+++ common/src/supabase/groups.ts\teebf7d4 (commit)\n@@ -1,10 +1,5 @@\n-import {\n-  Row,\n-  SupabaseClient,\n-  run,\n-  tsToMillis,\n-} from 'common/supabase/utils'\n+import { Row, SupabaseClient, run, tsToMillis } from 'common/supabase/utils'\n import { Group, Topic } from 'common/group'\n \n export const UNRANKED_GROUP_ID = 'f141b8ca-eac3-4400-962a-72973b3ceb62'\n export const UNSUBSIDIZED_GROUP_ID = 'f08f4130-3410-4030-9bf5-f675e5035e9c'\n@@ -54,8 +49,20 @@\n     db.from('group_members').select('member_id').eq('group_id', groupId)\n   )\n   return data ? data.map((member) => member.member_id) : []\n }\n+export async function getFollowedGroupsCount(\n+  db: SupabaseClient,\n+  userId: string\n+) {\n+  const { count } = await run(\n+    db\n+      .from('group_members')\n+      .select('group_id', { count: 'exact' })\n+      .eq('member_id', userId)\n+  )\n+  return count\n+}\n \n export const convertGroup = (row: Row<'groups'>): Group => ({\n   id: row.id,\n   slug: row.slug,\n"
        },
        {
          "path": "web/components/search.tsx",
          "status": "modified",
          "diff": "Index: web/components/search.tsx\n===================================================================\n--- web/components/search.tsx\t2235551 (parent)\n+++ web/components/search.tsx\teebf7d4 (commit)\n@@ -37,8 +37,13 @@\n import { useIsPageVisible } from 'web/hooks/use-page-visible'\n import { TopLevelPost } from 'common/top-level-post'\n import { CombinedResults } from './contract/combined-results'\n import { APIParams } from 'common/api/schema'\n+import { useUser } from 'web/hooks/use-user'\n+import { useAPIGetter } from 'web/hooks/use-api-getter'\n+import { getFollowedGroupsCount } from 'common/supabase/groups'\n+import { db } from 'web/lib/supabase/db'\n+import { DAY_MS } from 'common/util/time'\n \n const USERS_PER_PAGE = 100\n const TOPICS_PER_PAGE = 100\n \n@@ -102,9 +107,9 @@\n   { label: 'Closing in 30 days', value: 'closing-month' },\n   { label: 'Closing in 90 days', value: 'closing-90-days' },\n   { label: 'Closed', value: 'closed' },\n   { label: 'Resolved', value: 'resolved' },\n-  { label: 'News', value: 'news' },\n+  { label: 'Recently changed', value: 'news' },\n ] as const\n \n export type Filter = (typeof FILTERS)[number]['value']\n \n@@ -243,9 +248,10 @@\n     defaultSearchType,\n     defaultForYou,\n     useUrlParams,\n     persistPrefix,\n-    defaultSweepies: prefersPlay ? '0' : '1',\n+    defaultTopicFilter: topicSlug,\n+    defaultSweepies: hideSweepsToggle ? '2' : prefersPlay ? '0' : '1',\n   })\n \n   const query = searchParams[QUERY_KEY]\n   const searchType = searchParams[SEARCH_TYPE_KEY]\n@@ -254,22 +260,21 @@\n   const prizeMarketState = searchParams[PRIZE_MARKET_KEY]\n   const sweepiesState = searchParams[SWEEPIES_KEY]\n   const groupIds = searchParams[GROUP_IDS_KEY]\n   const hasBets = searchParams[HAS_BETS_KEY] === '1'\n+\n   useEffect(() => {\n     const isSweeps = sweepiesState === '1'\n     if (prefersPlay !== isSweeps) return\n     setSearchParams({\n       [SWEEPIES_KEY]: prefersPlay ? '0' : '1',\n     })\n   }, [prefersPlay, sweepiesState])\n \n-  const showSearchTypes = !!query && !hideSearchTypes && !contractsOnly\n+  const selectedFollowed = searchParams[TOPIC_FILTER_KEY] === 'followed'\n+  const showSearchTypes =\n+    !!query && !hideSearchTypes && !contractsOnly && !selectedFollowed\n \n-  const actuallySearchParams = searchParams\n-  if (topicSlug) actuallySearchParams[TOPIC_FILTER_KEY] = topicSlug\n-  if (hideSweepsToggle) actuallySearchParams[SWEEPIES_KEY] = '2'\n-\n   const {\n     contracts,\n     users,\n     topics,\n@@ -279,9 +284,9 @@\n     refreshContracts,\n     posts,\n   } = useSearchResults({\n     persistPrefix,\n-    searchParams: actuallySearchParams,\n+    searchParams: searchParams,\n     includeUsersAndTopics: showSearchTypes,\n     isReady,\n     additionalFilter,\n   })\n@@ -384,11 +389,70 @@\n     ? TOPICS_TO_SUBTOPICS[selectedTopic].find(\n         (subtopic) => groupIds === subtopic.groupIds.join(',')\n       )\n     : undefined\n-  const selectedAll = !selectedTopic && filter !== 'news'\n-  const selectedOnlyNews = filter === 'news' && !selectedTopic\n+  const selectedAll = !selectedTopic && !selectedFollowed\n+  const user = useUser()\n \n+  const {\n+    data: followedGroupsData,\n+    loading: isLoadingFollowedGroups,\n+    refresh: refreshFollowedGroups,\n+  } = useAPIGetter(\n+    'search-groups',\n+    {\n+      limit: 150,\n+      type: 'lite',\n+      term: query,\n+      memberGroupsOnly: true,\n+    },\n+    undefined,\n+    undefined,\n+    !!user?.id && selectedFollowed\n+  )\n+  const [followedCount, setFollowedCount] = useState<number>(0)\n+  // Refresh the followed count when the page is visible\n+  useEffect(() => {\n+    if (visible && selectedFollowed && user?.id) {\n+      getFollowedGroupsCount(db, user?.id).then((count) => {\n+        setFollowedCount(count)\n+      })\n+    }\n+  }, [visible, selectedFollowed, user?.id])\n+\n+  // Refresh groups that they're following if the followed count changes\n+  useEffect(() => {\n+    if (visible && selectedFollowed) {\n+      refreshFollowedGroups()\n+      refreshContracts()\n+    }\n+  }, [followedCount])\n+\n+  const usersFollowedGroups = followedGroupsData?.lite\n+  const followedGroupsCount = followedGroupsData?.lite?.length ?? 0\n+  const shouldLoadTrendingTopics =\n+    !!user &&\n+    (user.createdTime > Date.now() - DAY_MS ||\n+      (followedGroupsCount < 5 && !!followedGroupsData))\n+  const shouldShowTrendingTopics = selectedFollowed && shouldLoadTrendingTopics\n+  const shouldShowALotOfTrendingTopics =\n+    shouldShowTrendingTopics && contracts?.length === 0\n+\n+  const { data: trendingTopicsData, loading: isLoadingTrendingTopics } =\n+    useAPIGetter(\n+      'search-groups',\n+      {\n+        limit: 100,\n+        type: 'lite',\n+        term: query,\n+      },\n+      undefined,\n+      undefined,\n+      shouldLoadTrendingTopics\n+    )\n+  const trendingTopics = trendingTopicsData?.lite.filter(\n+    (topic) => !(usersFollowedGroups ?? []).some((t) => t.id === topic.id)\n+  )\n   return (\n     <Col className=\"w-full\">\n       <Col className={clsx('bg-canvas-0 sticky top-0 z-20', headerClassName)}>\n         <Col className=\"mb-2\">\n@@ -402,38 +466,40 @@\n                   'font-medium',\n                   selectedAll ? 'text-primary-600' : 'text-ink-500'\n                 )}\n                 onClick={() => {\n-                  if (selectedAll) {\n-                    return\n-                  } else {\n+                  if (!selectedAll) {\n                     track('select search topic', { topic: 'all' })\n                     const changes: Partial<SearchParams> = {\n                       [GROUP_IDS_KEY]: '',\n+                      [TOPIC_FILTER_KEY]: '',\n                     }\n-                    if (filter === 'news') changes[FILTER_KEY] = 'open'\n                     onChange(changes)\n                   }\n                 }}\n               >\n                 All\n               </button>\n-              <button\n-                className={clsx(\n-                  'font-medium',\n-                  selectedOnlyNews ? 'text-primary-600' : 'text-ink-500'\n-                )}\n-                onClick={() => {\n-                  if (selectedOnlyNews) {\n-                    onChange({ [FILTER_KEY]: 'open' })\n-                  } else {\n-                    track('select search topic', { topic: 'news' })\n-                    onChange({ [FILTER_KEY]: 'news', [GROUP_IDS_KEY]: '' })\n-                  }\n-                }}\n-              >\n-                News\n-              </button>\n+              {!!user?.id && (\n+                <button\n+                  className={clsx(\n+                    'font-medium',\n+                    selectedFollowed ? 'text-primary-600' : 'text-ink-500'\n+                  )}\n+                  onClick={() => {\n+                    if (!selectedFollowed) {\n+                      track('select search topic', { topic: 'followed' })\n+                      const changes: Partial<SearchParams> = {\n+                        [TOPIC_FILTER_KEY]: 'followed',\n+                        [GROUP_IDS_KEY]: '',\n+                      }\n+                      onChange(changes)\n+                    }\n+                  }}\n+                >\n+                  Followed\n+                </button>\n+              )}\n               {ALL_PARENT_TOPICS.map((topic) => (\n                 <button\n                   key={topic}\n                   className={clsx(\n@@ -442,20 +508,18 @@\n                       ? 'text-primary-600'\n                       : 'text-ink-500'\n                   )}\n                   onClick={() => {\n-                    if (selectedTopic === topic) {\n-                      onChange({ [GROUP_IDS_KEY]: '' })\n-                    } else {\n+                    if (selectedTopic != topic) {\n                       track('select search topic', { topic })\n                       // Join all group IDs for this topic's subtopics\n                       const allGroupIds = TOPICS_TO_SUBTOPICS[topic]\n                         .map((subtopic) => subtopic.groupIds)\n                         .flat()\n                       const changes: Partial<SearchParams> = {\n                         [GROUP_IDS_KEY]: allGroupIds.join(','),\n+                        [TOPIC_FILTER_KEY]: '', // Clear direct topicSlug when a parent topic is selected\n                       }\n-                      if (filter === 'news') changes[FILTER_KEY] = 'open'\n                       onChange(changes)\n                     }\n                   }}\n                 >\n@@ -548,8 +612,52 @@\n           />\n         )}\n       </Col>\n       <Spacer h={1} />\n+      {selectedFollowed && (\n+        <Col className=\"mb-2\">\n+          <>\n+            <Row className=\"text-ink-500 items-center gap-1 text-sm\">\n+              <hr className=\"border-ink-300 ml-2 grow sm:ml-0\" />\n+              <span>Your Followed Topics</span>\n+              <hr className=\"border-ink-300 mr-2 grow sm:mr-0\" />\n+            </Row>\n+            {usersFollowedGroups ? (\n+              <BrowseTopicPills\n+                className={'relative w-full px-2 py-1'}\n+                topics={usersFollowedGroups}\n+                clipOnMobile={true}\n+              />\n+            ) : isLoadingFollowedGroups ? (\n+              <div className=\"text-ink-500 px-2 py-3 text-sm\">\n+                Loading your followed topics...\n+              </div>\n+            ) : null}\n+          </>\n+\n+          {shouldShowTrendingTopics && (\n+            <>\n+              <Row className=\"text-ink-500 items-center gap-1 text-sm\">\n+                <hr className=\"border-ink-300 ml-2 grow sm:ml-0\" />\n+                <span>Explore Topics To Follow</span>\n+                <hr className=\"border-ink-300 mr-2 grow sm:mr-0\" />\n+              </Row>\n+              {trendingTopics ? (\n+                <BrowseTopicPills\n+                  className={'relative w-full px-2 py-1'}\n+                  topics={trendingTopics}\n+                  clipOnMobile={!shouldShowALotOfTrendingTopics}\n+                  initialShown={shouldShowALotOfTrendingTopics ? 20 : undefined}\n+                />\n+              ) : isLoadingTrendingTopics ? (\n+                <div className=\"text-ink-500 px-2 py-3 text-sm\">\n+                  Loading trending topics...\n+                </div>\n+              ) : null}\n+            </>\n+          )}\n+        </Col>\n+      )}\n       {showSearchTypes && (\n         <Col>\n           {showTopics && (\n             <>\n@@ -712,8 +820,9 @@\n   const requestId = useRef(0)\n \n   const querySearchResults = useEvent(\n     async (freshQuery?: boolean, contractsOnly?: boolean) => {\n+      if (!isReady) return true\n       const {\n         q: query,\n         s: sort,\n         f: filter,\n@@ -913,24 +1022,18 @@\n   )\n \n   useDebouncedEffect(\n     () => {\n-      if (isReady && !state.contracts?.length) {\n+      if (!state.contracts?.length) {\n         querySearchResults(true)\n       }\n     },\n     50,\n     [isReady]\n   )\n-  useDebouncedEffect(\n-    () => {\n-      if (isReady) {\n-        querySearchResults(true)\n-      }\n-    },\n-    50,\n-    [JSON.stringify(searchParams)]\n-  )\n+  useDebouncedEffect(() => querySearchResults(true), 50, [\n+    JSON.stringify(searchParams),\n+  ])\n \n   const contracts = state.contracts\n     ? uniqBy(\n         state.contracts.filter((c) => {\n"
        },
        {
          "path": "web/components/topics/browse-topic-pills.tsx",
          "status": "modified",
          "diff": "Index: web/components/topics/browse-topic-pills.tsx\n===================================================================\n--- web/components/topics/browse-topic-pills.tsx\t2235551 (parent)\n+++ web/components/topics/browse-topic-pills.tsx\teebf7d4 (commit)\n@@ -5,16 +5,23 @@\n import { Row } from 'web/components/layout/row'\n import { MAX_SHOWN } from '../search/user-results'\n import { removeEmojis } from 'common/util/string'\n import Link from 'next/link'\n+import { useIsMobile } from 'web/hooks/use-is-mobile'\n+const MAX_MOBILE_SHOWN = 4\n \n export const BrowseTopicPills = (props: {\n   topics: LiteGroup[]\n   className?: string\n+  clipOnMobile?: boolean\n+  initialShown?: number\n }) => {\n-  const { topics, className } = props\n+  const { topics, className, clipOnMobile = false, initialShown } = props\n+  const isMobile = useIsMobile()\n   const [showMore, setShowMore] = useState<boolean>(false)\n-  const shownTopics = showMore ? topics : topics.slice(0, MAX_SHOWN)\n+  const maxShown =\n+    initialShown ?? (isMobile && clipOnMobile ? MAX_MOBILE_SHOWN : MAX_SHOWN)\n+  const shownTopics = showMore ? topics : topics.slice(0, maxShown)\n \n   return (\n     <Col className={className}>\n       <Row className={clsx('flex-wrap gap-1 text-sm')}>\n@@ -29,14 +36,14 @@\n           >\n             {removeEmojis(g.name)}\n           </Link>\n         ))}\n-        {topics.length > MAX_SHOWN && (\n+        {topics.length > maxShown && (\n           <button\n             onClick={() => setShowMore(!showMore)}\n             className=\"text-primary-700 bg-ink-100 hover:bg-ink-200 flex flex-row items-center gap-1 rounded p-2 py-1\"\n           >\n-            {showMore ? `Show less` : `Show ${topics.length - MAX_SHOWN} more`}\n+            {showMore ? `Show less` : `Show ${topics.length - maxShown} more`}\n           </button>\n         )}\n       </Row>\n     </Col>\n"
        }
      ]
    },
    {
      "id": "remove-play-query",
      "sha": "a3aeeb19676f966215b5eafb24ef52ac9db2fad1",
      "parentSha": "5d7a0b8db6835cae42d0a07de4f38c853583ae12",
      "spec": "Implement the removal of sweepstakes/play mode and the play URL query from contract-related pages and routing. Make the following changes:\n\n1) URL/path generation\n- Remove the twombaContractPath function and its usage. Replace all references to twombaContractPath with contractPath.\n- After creating a contract, navigate to contractPath(newContract) instead of any play-based path.\n- Update embed URLs: src should be https://{DOMAIN}/embed + contractPath(contract).\n- Update SEO canonical/og URL generation for contract pages to use contractPath(contract).\n\n2) Contract page behavior (single contract, no play toggle)\n- Eliminate play/sweeps toggle state and behavior on the main contract page:\n  - Remove useSweepstakes(), query.play parsing, router.replace() calls updating play, and isPlay state.\n  - Do not compute or fetch a sibling cash contract. Remove the cash: CashType prop from ContractParams and all dependent code paths (bet data, totals, points, metrics switching, etc.). Use only the live state of the contract provided in props.\n  - For data hooks (bets, points, totals), initialize them from the liveContract (useLiveContract(props.contract)) only.\n  - For top traders/metrics, use the values from props.topContractMetrics as provided for the single active contract.\n  - For header and title components, pass the single live contract (no play/current split props).\n  - Description rendering: If the contract.token is 'CASH', do not render the ContractDescription editor/content. Instead, show a short notice that links to the parent (mana) contract using the slug with '--cash' removed. For non-CASH contracts, render ContractDescription as usual.\n  - Always pass props.totalPositions as-is (do not switch based on play/cash).\n\n3) Contract info dialog and header actions\n- Update ContractInfoDialog to accept a single contract prop. Remove playContract/statsContract and setIsPlay props. Use the single contract for history, share, and embed buttons.\n- In the Stats section, replace the SweepsToggle component with a simple link. If contract.token === 'CASH', link to /{creatorUsername}/{slug-without--cash}; otherwise, link to /{creatorUsername}/{slug}--cash. Display the link text reflecting whether the current contract is the cash variant.\n- Update HeaderActions to accept a single contract prop. Remove setIsPlay, playContract/currentContract parameters, and all code branching on them. Use contract for follow/watch, duplicate, block/unblock, mark uninteresting, add liquidity, dropdown actions, and reporting.\n\n4) Contract page routing (SSR/SSG) and embed page\n- In pages/[username]/[contractSlug].tsx:\n  - Do not redirect CASH contracts to a play=false URL. Remove any CASH_SUFFIX logic and removal of username from getStaticProps if not needed.\n  - Do not fetch sibling or cash contracts. Load only the main contract by slug, then populate and return its ContractParams.\n  - In NonPrivateContractPage, remove Sweepstakes logic and any cashPoints or cashContract props. If rendering in an iframe, render the embed page with the single contract and its points.\n  - Use ContractSEO with the single contract.\n- In pages/embed/[username]/[contractSlug].tsx:\n  - Remove cash/sibling contract fetching and all play query logic. Do not branch on isCash.\n  - Load only the contract, its points, and optional multiPoints; pass them to the embed view.\n  - Set ContractSEO to the single contract.\n  - In ContractSmolView, set the href to https://{DOMAIN}{contractPath(contract)}.\n\n5) Middleware: remove play query and constrain API proxying\n- Update web/middleware.ts so that:\n  - On any matched request, if the URL has a play query parameter, remove it and redirect (308) to the same URL without play.\n  - Only run API proxy logic for paths under /api/. For non-API requests, continue the request without proxying.\n  - Update config.matcher to include:\n    - '/api/v0/:path*' for the API proxy\n    - '/([^/]+)/([^/]+)' to catch contract pages (username/slug)\n    - '/embed/([^/]+)/([^/]+)' to catch embed pages\n\n6) Cleanup and types\n- Remove CashType and the cash field from ContractParams and from any exports. Remove imports and references to CASH_SUFFIX, useSweepstakes, SweepsToggle, and useRouter in the affected components.\n- Ensure all updated components compile with the simplified props and imported symbols.\n\n7) Validation and references\n- Verify no remaining references to twombaContractPath exist in the codebase.\n- Verify no components on these pages rely on router.query.play; all navigation to cash vs mana contracts must be done by slug-based routes only.\n- Confirm analytics/tracking calls still use the correct contract.id and slug.",
      "prompt": "Refactor the contract and embed experience to remove the old play/sweepstakes toggle and stop using a play URL query. Consolidate the pages to show a single live contract instance, eliminate sibling/cash contract toggling logic, and shift any navigation between cash and mana variants to simple slug-based links. Update all share, embed, and SEO URLs to use a single contract path builder. Adjust middleware so that any incoming play query is stripped by redirect and the API proxy only runs for API routes. Remove now-unused types and imports related to play/sweeps in these pages. Ensure contract pages, embed pages, and share/embed controls work correctly without the play query or sweepstakes toggle.",
      "supplementalFiles": [
        "web/components/sweepstakes-provider.tsx",
        "web/components/sweeps/sweeps-toggle.tsx",
        "web/hooks/use-saved-contract-metrics.ts",
        "web/components/contract/contract-description.tsx",
        "common/src/contract-seo.ts",
        "web/lib/supabase/contracts.ts"
      ],
      "fileDiffs": [
        {
          "path": "common/src/contract.ts",
          "status": "modified",
          "diff": "Index: common/src/contract.ts\n===================================================================\n--- common/src/contract.ts\t5d7a0b8 (parent)\n+++ common/src/contract.ts\ta3aeeb1 (commit)\n@@ -6,9 +6,9 @@\n import { Answer } from './answer'\n import { getLiquidity } from './calculate-cpmm'\n import { ContractComment } from './comment'\n import { ContractMetric } from './contract-metric'\n-import { CASH_SUFFIX, ENV_CONFIG } from './envs/constants'\n+import { ENV_CONFIG } from './envs/constants'\n import { Fees } from './fees'\n import { PollOption } from './poll-option'\n import { formatMoney, formatPercent } from './util/format'\n import { MultiBase64Points } from './chart'\n@@ -453,20 +453,8 @@\n }) {\n   return `/${contract.creatorUsername}/${contract.slug}`\n }\n \n-export function twombaContractPath(contract: {\n-  creatorUsername: string\n-  slug: string\n-  token?: ContractToken\n-}) {\n-  const isCashContract = contract.token == 'CASH'\n-  const cleanedSlug = contract.slug.replace(new RegExp(`${CASH_SUFFIX}$`), '')\n-  return `/${contract.creatorUsername}/${cleanedSlug}${\n-    isCashContract ? '?play=false' : '?play=true'\n-  }`\n-}\n-\n export type CashType = {\n   contract: Contract\n   lastBetTime?: number\n   pointsString: string\n@@ -488,9 +476,8 @@\n   chartAnnotations: ChartAnnotation[]\n   topics: Topic[]\n   dashboards: { slug: string; title: string }[]\n   pinnedComments: ContractComment[]\n-  cash?: CashType\n }\n \n export type MaybeAuthedContractParams =\n   | {\n"
        },
        {
          "path": "web/components/buttons/share-embed-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/buttons/share-embed-button.tsx\n===================================================================\n--- web/components/buttons/share-embed-button.tsx\t5d7a0b8 (parent)\n+++ web/components/buttons/share-embed-button.tsx\ta3aeeb1 (commit)\n@@ -1,17 +1,17 @@\n import { CodeIcon } from '@heroicons/react/outline'\n import toast from 'react-hot-toast'\n \n-import { Contract, contractPath, twombaContractPath } from 'common/contract'\n+import { Contract, contractPath } from 'common/contract'\n import { DOMAIN } from 'common/envs/constants'\n import { copyToClipboard } from 'web/lib/util/copy'\n import { track } from 'web/lib/service/analytics'\n import { Button } from './button'\n import clsx from 'clsx'\n \n export function embedContractCode(contract: Contract) {\n   const title = contract.question\n-  const src = `https://${DOMAIN}/embed${twombaContractPath(contract)}`\n+  const src = `https://${DOMAIN}/embed${contractPath(contract)}`\n   return `<iframe src=\"${src}\" title=\"${title}\" frameborder=\"0\" style=\"position: relative; left:50%; transform: translateX(-50%); width:90%; height:18rem; max-width: 35rem;\"></iframe>`\n }\n \n export function ShareEmbedButton(props: {\n"
        },
        {
          "path": "web/components/contract/contract-info-dialog.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-info-dialog.tsx\n===================================================================\n--- web/components/contract/contract-info-dialog.tsx\t5d7a0b8 (parent)\n+++ web/components/contract/contract-info-dialog.tsx\ta3aeeb1 (commit)\n@@ -27,16 +27,16 @@\n import { InfoTooltip } from '../widgets/info-tooltip'\n import ShortToggle from '../widgets/short-toggle'\n import { Table } from '../widgets/table'\n import { ContractHistoryButton } from './contract-edit-history-button'\n-import { SweepsToggle } from '../sweeps/sweeps-toggle'\n import { useSweepstakes } from '../sweepstakes-provider'\n+import Link from 'next/link'\n+import { linkClass } from '../widgets/site-link'\n export const Stats = (props: {\n   contract: Contract\n-  setIsPlay: (isPlay: boolean) => void\n   user?: User | null | undefined\n }) => {\n-  const { contract, user, setIsPlay } = props\n+  const { contract, user } = props\n   const { creatorId } = contract\n   const shouldAnswersSumToOne =\n     contract.mechanism === 'cpmm-multi-1'\n       ? contract.shouldAnswersSumToOne\n@@ -337,26 +337,21 @@\n         )}\n         {sweepsEnabled && !isNonBetPollOrBountiedQuestion && (\n           <tr>\n             <td>Sweepstakes</td>\n-            <td>\n-              <SweepsToggle\n-                sweepsEnabled={sweepsEnabled}\n-                isPlay={isPlay}\n-                onClick={() => {\n-                  if (prefersPlay && isPlay) {\n-                    setPrefersPlay(false)\n-                    setIsPlay(false)\n-                  } else if (!prefersPlay && !isPlay) {\n-                    setPrefersPlay(true)\n-                    setIsPlay(true)\n-                  } else if (prefersPlay && !isPlay) {\n-                    setIsPlay(true)\n-                  } else if (!prefersPlay && isPlay) {\n-                    setIsPlay(false)\n-                  }\n-                }}\n-              />\n+            <td className={linkClass}>\n+              <Link\n+                href={\n+                  contract.token === 'CASH'\n+                    ? `/${contract.creatorUsername}/${contract.slug.replace(\n+                        '--cash',\n+                        ''\n+                      )}`\n+                    : `/${contract.creatorUsername}/${contract.slug}--cash`\n+                }\n+              >\n+                {contract.token === 'CASH' ? 'True' : 'False'}\n+              </Link>\n             </td>\n           </tr>\n         )}\n \n@@ -534,16 +529,14 @@\n   )\n }\n \n export function ContractInfoDialog(props: {\n-  playContract: Contract\n-  statsContract: Contract\n+  contract: Contract\n   user: User | null | undefined\n-  setIsPlay: (isPlay: boolean) => void\n   open: boolean\n   setOpen: (open: boolean) => void\n }) {\n-  const { playContract, statsContract, user, open, setOpen, setIsPlay } = props\n+  const { contract, user, open, setOpen } = props\n   const isAdmin = useAdmin()\n   const isTrusted = useTrusted()\n \n   return (\n@@ -551,21 +544,21 @@\n       open={open}\n       setOpen={setOpen}\n       className=\"bg-canvas-0 flex flex-col gap-4 rounded p-6\"\n     >\n-      <Stats contract={statsContract} user={user} setIsPlay={setIsPlay} />\n+      <Stats contract={contract} user={user} />\n \n       {!!user && (\n         <>\n           <Row className=\"my-2 flex-wrap gap-2\">\n-            <ContractHistoryButton contract={playContract} />\n-            <ShareQRButton contract={playContract} />\n-            <ShareIRLButton contract={playContract} />\n-            <ShareEmbedButton contract={statsContract} />\n+            <ContractHistoryButton contract={contract} />\n+            <ShareQRButton contract={contract} />\n+            <ShareIRLButton contract={contract} />\n+            <ShareEmbedButton contract={contract} />\n           </Row>\n           <Row className=\"flex-wrap gap-2\">\n             {isAdmin || isTrusted ? (\n-              <SuperBanControl userId={playContract.creatorId} />\n+              <SuperBanControl userId={contract.creatorId} />\n             ) : null}\n           </Row>\n         </>\n       )}\n"
        },
        {
          "path": "web/components/contract/contract-page.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-page.tsx\n===================================================================\n--- web/components/contract/contract-page.tsx\t5d7a0b8 (parent)\n+++ web/components/contract/contract-page.tsx\ta3aeeb1 (commit)\n@@ -56,20 +56,15 @@\n import { useRelatedMarkets } from 'web/hooks/use-related-contracts'\n import { useReview } from 'web/hooks/use-review'\n import { useSaveCampaign } from 'web/hooks/use-save-campaign'\n import { useSaveContractVisitsLocally } from 'web/hooks/use-save-visits'\n-import {\n-  useSavedContractMetrics,\n-  useTopContractMetrics,\n-} from 'web/hooks/use-saved-contract-metrics'\n+import { useSavedContractMetrics } from 'web/hooks/use-saved-contract-metrics'\n import { useTracking } from 'web/hooks/use-tracking'\n import { usePrivateUser, useUser } from 'web/hooks/use-user'\n import { track } from 'web/lib/service/analytics'\n import { scrollIntoViewCentered } from 'web/lib/util/scroll'\n import { SpiceCoin } from 'web/public/custom-components/spiceCoin'\n import { YourTrades } from 'web/pages/[username]/[contractSlug]'\n-import { useSweepstakes } from '../sweepstakes-provider'\n-import { useRouter } from 'next/router'\n import { precacheAnswers } from 'web/hooks/use-answers'\n import { useIsPageVisible } from 'web/hooks/use-page-visible'\n import { api } from 'web/lib/api/api'\n import { shouldHideGraph } from 'common/contract-params'\n@@ -77,8 +72,9 @@\n import { FollowMarketButton } from '../buttons/follow-market-button'\n import { useSaveReferral } from 'web/hooks/use-save-referral'\n import { base64toPoints } from 'common/edge/og'\n import { useDisplayUserById } from 'web/hooks/use-user-supabase'\n+import Link from 'next/link'\n \n export function ContractPageContent(props: ContractParams) {\n   const {\n     comments,\n@@ -88,79 +84,20 @@\n     chartAnnotations,\n     topics,\n     dashboards,\n     pinnedComments,\n-    cash,\n   } = props\n \n-  // sync query state with context\n-  const { prefersPlay } = useSweepstakes()\n-  const router = useRouter()\n-  const livePlayContract = useLiveContract(props.contract)\n-  const sweepsIsPossible = !!livePlayContract.siblingContractId\n-  const [isPlay, setIsPlay] = useState<boolean | undefined>(prefersPlay)\n-  const liveCashContract = props.cash\n-    ? // eslint-disable-next-line react-hooks/rules-of-hooks\n-      useLiveContract(props.cash.contract)\n-    : null\n-\n-  const liveContract =\n-    !isPlay && liveCashContract ? liveCashContract : livePlayContract\n+  // Just use the contract that was navigated to directly\n+  const liveContract = useLiveContract(props.contract)\n   const user = useUser()\n   useSaveReferral(user, {\n     defaultReferrerUsername: props.contract.creatorUsername,\n     contractId: props.contract.id,\n   })\n-  // Read and set play state from the query\n-  useEffect(() => {\n-    if (!router.isReady) return\n-    const playQuery = router.query.play\n-    const queryIndicatesSweeps = playQuery === 'false'\n-    const queryIndicatesPlay =\n-      playQuery === 'true' ||\n-      (playQuery === undefined &&\n-        !sweepsIsPossible &&\n-        prefersPlay === undefined)\n-    if (queryIndicatesSweeps) {\n-      if (sweepsIsPossible && isPlay) {\n-        setIsPlay(false)\n-      } else if (!sweepsIsPossible && !isPlay) {\n-        setIsPlay(true)\n-      }\n-    } else if (queryIndicatesPlay && !isPlay) {\n-      setIsPlay(true)\n-    }\n-  }, [isPlay, router.query, prefersPlay])\n \n-  const setIsPlayAndQuery = (isPlay: boolean) => {\n-    setIsPlay(isPlay)\n-    setPlayStateInQuery(isPlay)\n-  }\n-\n-  const setPlayStateInQuery = (play: boolean) => {\n-    const newQuery = { ...router.query, play: play.toString() }\n-\n-    if (JSON.stringify(newQuery) !== JSON.stringify(router.query)) {\n-      router.replace(\n-        {\n-          query: newQuery,\n-          hash: router.asPath.split('#')[1],\n-        },\n-        undefined,\n-        { shallow: true }\n-      )\n-    }\n-  }\n-\n   const myContractMetrics = useSavedContractMetrics(liveContract)\n-  const topContractMetrics = useTopContractMetrics({\n-    playContract: livePlayContract,\n-    cashContract: liveCashContract,\n-    prefersPlay: isPlay ?? false,\n-    // TODO: do we really need this? leaderboards are below the fold. If we do, should add for cash as well\n-    defaultTopManaTraders: props.topContractMetrics,\n-    defaultTopCashTraders: [],\n-  })\n+  const topContractMetrics = props.topContractMetrics\n \n   const privateUser = usePrivateUser()\n   const blockedUserIds = privateUser?.blockedUserIds ?? []\n \n@@ -181,41 +118,25 @@\n   useEffect(() => {\n     if ('answers' in props.contract) {\n       precacheAnswers(props.contract.answers)\n     }\n-    if (props.cash?.contract && 'answers' in props.cash.contract) {\n-      precacheAnswers(props.cash.contract.answers)\n-    }\n   }, [])\n \n-  const playBetData = useBetData({\n-    contractId: props.contract.id,\n-    outcomeType: props.contract.outcomeType,\n+  const { bets, totalBets, yourNewBets, betPoints } = useBetData({\n+    contractId: liveContract.id,\n+    outcomeType: liveContract.outcomeType,\n     userId: user?.id,\n     lastBetTime: props.lastBetTime,\n     totalBets: props.totalBets,\n-    pointsString,\n-    multiPointsString,\n+    pointsString: pointsString,\n+    multiPointsString: multiPointsString,\n   })\n \n-  const cashBetData = useBetData({\n-    contractId: cash?.contract.id ?? '_',\n-    outcomeType: cash?.contract.outcomeType,\n-    userId: user?.id,\n-    lastBetTime: cash?.lastBetTime,\n-    totalBets: cash?.totalBets ?? 0,\n-    pointsString: cash?.pointsString,\n-    multiPointsString: cash?.multiPointsString,\n-  })\n-\n-  const { bets, totalBets, yourNewBets, betPoints } =\n-    cash && !isPlay ? cashBetData : playBetData\n-\n   const { isResolved, outcomeType, resolution, closeTime, creatorId } =\n     liveContract\n-  const { coverImageUrl } = livePlayContract\n+  const { coverImageUrl } = liveContract\n \n-  const description = livePlayContract.description\n+  const description = liveContract.description\n \n   const isAdmin = useAdmin()\n   const isMod = useTrusted()\n   const isCreator = creatorId === user?.id\n@@ -299,9 +220,9 @@\n                   }}\n                   priority\n                 />\n                 <ChangeBannerButton\n-                  contract={livePlayContract}\n+                  contract={liveContract}\n                   className=\"absolute right-4 top-12\"\n                 />\n               </div>\n             )}\n@@ -336,11 +257,9 @@\n                 )}\n               </Row>\n               {(headerStuck || !coverImageUrl) && (\n                 <HeaderActions\n-                  setIsPlay={setIsPlayAndQuery}\n-                  playContract={livePlayContract}\n-                  currentContract={liveContract}\n+                  contract={liveContract}\n                   initialHideGraph={initialHideGraph}\n                   hideGraph={hideGraph}\n                   setHideGraph={setHideGraph}\n                 />\n@@ -353,11 +272,9 @@\n               <div>\n                 <BackButton className=\"pr-8\" />\n               </div>\n               <HeaderActions\n-                setIsPlay={setIsPlayAndQuery}\n-                playContract={livePlayContract}\n-                currentContract={liveContract}\n+                contract={liveContract}\n                 initialHideGraph={initialHideGraph}\n                 hideGraph={hideGraph}\n                 setHideGraph={setHideGraph}\n               />\n@@ -373,9 +290,9 @@\n                     isLarge\n                     className=\"mr-1\"\n                   />\n                   <EditableQuestionTitle\n-                    contract={livePlayContract}\n+                    contract={liveContract}\n                     canEdit={isAdmin || isCreator || isMod}\n                   />\n                 </div>\n               </Col>\n@@ -495,14 +412,27 @@\n                 {showResolver && <Spacer h={4} />}\n                 <CreatorSharePanel contract={liveContract} />\n               </>\n             )}\n-            <ContractDescription\n-              contractId={props.contract.id}\n-              creatorId={props.contract.creatorId}\n-              isSweeps={isCashContract}\n-              description={description}\n-            />\n+            {liveContract.token === 'CASH' ? (\n+              <span className=\"bg-canvas-50 rounded-md p-4\">\n+                See parent question for description and comments:{' '}\n+                <Link\n+                  href={`/${\n+                    liveContract.creatorUsername\n+                  }/${liveContract.slug.replace('--cash', '')}`}\n+                >\n+                  {liveContract.question}\n+                </Link>\n+              </span>\n+            ) : (\n+              <ContractDescription\n+                contractId={props.contract.id}\n+                creatorId={props.contract.creatorId}\n+                isSweeps={isCashContract}\n+                description={description}\n+              />\n+            )}\n             <Row className=\"mb-4 items-center gap-2\">\n               <MarketTopics\n                 contract={props.contract}\n                 dashboards={dashboards}\n@@ -552,11 +482,9 @@\n                 liveContract={liveContract}\n                 bets={bets}\n                 totalBets={totalBets}\n                 comments={comments}\n-                totalPositions={\n-                  !isPlay && cash ? cash.totalPositions : props.totalPositions\n-                }\n+                totalPositions={props.totalPositions}\n                 replyTo={replyTo}\n                 setReplyTo={setReplyTo}\n                 blockedUserIds={blockedUserIds}\n                 activeIndex={activeTabIndex}\n"
        },
        {
          "path": "web/components/contract/contract-seo.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-seo.tsx\n===================================================================\n--- web/components/contract/contract-seo.tsx\t5d7a0b8 (parent)\n+++ web/components/contract/contract-seo.tsx\ta3aeeb1 (commit)\n@@ -1,5 +1,5 @@\n-import { Contract, twombaContractPath } from 'common/contract'\n+import { Contract, contractPath } from 'common/contract'\n import { getSeoDescription, getContractOGProps } from 'common/contract-seo'\n import { removeUndefinedProps } from 'common/util/object'\n import { SEO } from '../SEO'\n \n@@ -20,9 +20,9 @@\n   return (\n     <SEO\n       title={question}\n       description={seoDesc}\n-      url={twombaContractPath(contract)}\n+      url={contractPath(contract)}\n       ogProps={{ props: ogCardProps, endpoint: 'market' }}\n       shouldIgnore={contract.visibility !== 'public'}\n     />\n   )\n"
        },
        {
          "path": "web/components/contract/header-actions.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/header-actions.tsx\n===================================================================\n--- web/components/contract/header-actions.tsx\t5d7a0b8 (parent)\n+++ web/components/contract/header-actions.tsx\ta3aeeb1 (commit)\n@@ -36,70 +36,60 @@\n import { ChangeBannerButton } from './change-banner-button'\n import { GoGraph } from 'react-icons/go'\n \n export function HeaderActions(props: {\n-  playContract: Contract\n-  setIsPlay: (isPlay: boolean) => void\n-  currentContract: Contract\n+  contract: Contract\n   initialHideGraph: boolean\n   hideGraph: boolean\n   setHideGraph: (hideGraph: boolean) => void\n }) {\n-  const {\n-    playContract,\n-    currentContract,\n-    initialHideGraph,\n-    hideGraph,\n-    setHideGraph,\n-    setIsPlay,\n-  } = props\n+  const { contract, initialHideGraph, hideGraph, setHideGraph } = props\n   const user = useUser()\n   const privateUser = usePrivateUser()\n-  const isCreator = user?.id === playContract.creatorId\n+  const isCreator = user?.id === contract.creatorId\n \n   const [detailsOpen, setDetailsOpen] = useState(false)\n   const [repostOpen, setRepostOpen] = useState(false)\n   const [reportOpen, setReportOpen] = useState(false)\n   const [liquidityOpen, setLiquidityOpen] = useState(false)\n \n-  const duplicateHref = duplicateContractHref(playContract)\n+  const duplicateHref = duplicateContractHref(contract)\n \n   const isBlocked =\n-    privateUser && privateUser.blockedContractIds?.includes(playContract.id)\n+    privateUser && privateUser.blockedContractIds?.includes(contract.id)\n \n   const onBlock = async () => {\n     await toast.promise(\n-      api('market/:contractId/block', { contractId: playContract.id }),\n+      api('market/:contractId/block', { contractId: contract.id }),\n       {\n         loading: 'Blocking...',\n         success: `You'll no longer see this question in your feed nor search.`,\n         error: 'Error blocking user',\n       }\n     )\n   }\n   const onUnblock = async () => {\n-    await api('market/:contractId/unblock', { contractId: playContract.id })\n+    await api('market/:contractId/unblock', { contractId: contract.id })\n   }\n \n   const markUninteresting = async () => {\n     await updateUserDisinterestEmbedding({\n-      contractId: playContract.id,\n-      creatorId: playContract.creatorId,\n+      contractId: contract.id,\n+      creatorId: contract.creatorId,\n     })\n     toast(`We won't show you content like that again`, {\n       icon: <TiVolumeMute className={'h-5 w-5 text-teal-500'} />,\n     })\n   }\n \n   const contractOpenAndPublic =\n-    !currentContract.isResolved &&\n-    (currentContract.closeTime ?? Infinity) > Date.now() &&\n-    currentContract.visibility == 'public'\n+    !contract.isResolved &&\n+    (contract.closeTime ?? Infinity) > Date.now() &&\n+    contract.visibility == 'public'\n \n   const addLiquidityEnabled =\n     user &&\n-    (currentContract.mechanism == 'cpmm-1' ||\n-      currentContract.mechanism == 'cpmm-multi-1') &&\n+    (contract.mechanism == 'cpmm-1' || contract.mechanism == 'cpmm-multi-1') &&\n     contractOpenAndPublic\n \n   const [following, setFollowing] = useState<boolean>()\n   const [followingOpen, setFollowingOpen] = useState(false)\n@@ -107,9 +97,9 @@\n     if (!user?.id) return\n     db.from('contract_follows')\n       .select('contract_id')\n       .eq('follow_id', user.id)\n-      .eq('contract_id', currentContract.id)\n+      .eq('contract_id', contract.id)\n       .then((res) => {\n         setFollowing((res.data?.length ?? 0) > 0)\n       })\n   }, [user?.id, followingOpen])\n@@ -131,12 +121,12 @@\n           {\n             name: following ? 'Unwatch' : 'Watch',\n             onClick: async () => {\n               if (following) {\n-                await unfollowMarket(playContract.id, playContract.slug)\n+                await unfollowMarket(contract.id, contract.slug)\n                 setFollowing(false)\n               } else {\n-                await followMarket(playContract.id, playContract.slug)\n+                await followMarket(contract.id, contract.slug)\n                 setFollowing(true)\n               }\n               if (!user.hasSeenContractFollowModal) {\n                 await api('me/update', { hasSeenContractFollowModal: true })\n@@ -241,42 +231,37 @@\n   ]\n \n   return (\n     <Row className=\"mr-4 shrink-0 items-center [&>*]:flex\">\n-      {!playContract.coverImageUrl && isCreator && (\n-        <ChangeBannerButton\n-          contract={playContract}\n-          className=\"ml-3 first:ml-0\"\n-        />\n+      {!contract.coverImageUrl && isCreator && (\n+        <ChangeBannerButton contract={contract} className=\"ml-3 first:ml-0\" />\n       )}\n-      <FollowMarketIconButton contract={currentContract} user={user} />\n+      <FollowMarketIconButton contract={contract} user={user} />\n       <CopyLinkOrShareButton\n-        url={getShareUrl(currentContract, user?.username)}\n+        url={getShareUrl(contract, user?.username)}\n         tooltip=\"Copy question share link\"\n         className=\"text-ink-500 hover:text-ink-600\"\n         size=\"xs\"\n         eventTrackingName=\"copy market link\"\n-        trackingInfo={{ contractId: currentContract.id }}\n+        trackingInfo={{ contractId: contract.id }}\n       />\n       <DropdownMenu items={dropdownItems} />\n       <ContractInfoDialog\n-        playContract={playContract}\n-        statsContract={currentContract}\n+        contract={contract}\n         user={user}\n-        setIsPlay={setIsPlay}\n         open={detailsOpen}\n         setOpen={setDetailsOpen}\n       />\n       {repostOpen && (\n         <RepostModal\n-          playContract={playContract}\n+          playContract={contract}\n           open={repostOpen}\n           setOpen={setRepostOpen}\n         />\n       )}\n       {addLiquidityEnabled && (\n         <AddLiquidityModal\n-          contract={currentContract}\n+          contract={contract}\n           isOpen={liquidityOpen}\n           setOpen={setLiquidityOpen}\n         />\n       )}\n@@ -284,11 +269,11 @@\n         isModalOpen={reportOpen}\n         label={'contract'}\n         setIsModalOpen={setReportOpen}\n         report={{\n-          contentId: playContract.id,\n+          contentId: contract.id,\n           contentType: 'contract',\n-          contentOwnerId: playContract.creatorId,\n+          contentOwnerId: contract.creatorId,\n         }}\n       />\n       <FollowMarketModal\n         open={followingOpen}\n"
        },
        {
          "path": "web/components/new-contract/contract-params-form.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/contract-params-form.tsx\n===================================================================\n--- web/components/new-contract/contract-params-form.tsx\t5d7a0b8 (parent)\n+++ web/components/new-contract/contract-params-form.tsx\ta3aeeb1 (commit)\n@@ -11,11 +11,11 @@\n   MAX_DESCRIPTION_LENGTH,\n   MAX_QUESTION_LENGTH,\n   NUMBER_BUCKETS_MAX,\n   NON_BETTING_OUTCOMES,\n-  twombaContractPath,\n   Visibility,\n   PollVoterVisibility,\n+  contractPath,\n } from 'common/contract'\n import {\n   getAnte,\n   getUniqueBettorBonusAmount,\n@@ -650,9 +650,9 @@\n       })\n \n       // Await to clear form data from localstorage after navigate, since market is created.\n       // Don't clear before navigate, because looks like a bug.\n-      const path = twombaContractPath(newContract)\n+      const path = contractPath(newContract)\n       await router.push(path)\n       resetProperties()\n     } catch (e) {\n       console.error('error creating contract', e)\n"
        },
        {
          "path": "web/middleware.ts",
          "status": "modified",
          "diff": "Index: web/middleware.ts\n===================================================================\n--- web/middleware.ts\t5d7a0b8 (parent)\n+++ web/middleware.ts\ta3aeeb1 (commit)\n@@ -1,24 +1,46 @@\n import { NextResponse, type NextRequest } from 'next/server'\n import { PROD_CONFIG } from 'common/envs/prod'\n \n export async function middleware(req: NextRequest) {\n-  const path = req.nextUrl.pathname.replace('/api/', '')\n+  const url = req.nextUrl\n \n-  if (pathsToSkip.includes(path)) {\n-    return NextResponse.next()\n+  // Handle play parameter removal for all requests\n+  if (url.searchParams.has('play')) {\n+    url.searchParams.delete('play')\n+    return NextResponse.redirect(url, 308)\n   }\n \n-  return new Response('Permanent Redirect', {\n-    status: 308,\n-    headers: {\n-      location: getProxiedRequestUrl(req, path),\n-    },\n-  })\n+  // Only run API proxy logic for API requests\n+  if (url.pathname.startsWith('/api/')) {\n+    const path = req.nextUrl.pathname.replace('/api/', '')\n+\n+    if (pathsToSkip.includes(path)) {\n+      return NextResponse.next()\n+    }\n+\n+    return new Response('Permanent Redirect', {\n+      status: 308,\n+      headers: {\n+        location: getProxiedRequestUrl(req, path),\n+      },\n+    })\n+  }\n+\n+  // For non-API requests, just continue normally\n+  return NextResponse.next()\n }\n \n export const config = {\n-  matcher: ['/api/v0/:path*'],\n+  matcher: [\n+    // API proxy\n+    '/api/v0/:path*',\n+    // Contract pages - be specific about the format\n+    // This matches /username/contract-slug but not / or /browse etc\n+    '/([^/]+)/([^/]+)',\n+    // Embed pages\n+    '/embed/([^/]+)/([^/]+)',\n+  ],\n }\n \n const pathsToSkip = ['v0/deployment-id', 'v0/revalidate']\n \n"
        },
        {
          "path": "web/pages/[username]/[contractSlug].tsx",
          "status": "modified",
          "diff": "Index: web/pages/[username]/[contractSlug].tsx\n===================================================================\n--- web/pages/[username]/[contractSlug].tsx\t5d7a0b8 (parent)\n+++ web/pages/[username]/[contractSlug].tsx\ta3aeeb1 (commit)\n@@ -7,19 +7,17 @@\n } from 'common/contract'\n import { ContractMetric } from 'common/contract-metric'\n import { getContractParams } from 'common/contract-params'\n import { base64toPoints } from 'common/edge/og'\n-import { CASH_SUFFIX } from 'common/envs/constants'\n-import { getContract, getContractFromSlug } from 'common/supabase/contracts'\n+import { getContractFromSlug } from 'common/supabase/contracts'\n import { removeUndefinedProps } from 'common/util/object'\n-import { pick, sortBy, uniqBy } from 'lodash'\n+import { sortBy, uniqBy } from 'lodash'\n import { ContractBetsTable } from 'web/components/bet/contract-bets-table'\n import { YourOrders } from 'web/components/bet/order-book'\n import { ContractPageContent } from 'web/components/contract/contract-page'\n import { ContractSEO } from 'web/components/contract/contract-seo'\n import { Col } from 'web/components/layout/col'\n import { Page } from 'web/components/layout/page'\n-import { useSweepstakes } from 'web/components/sweepstakes-provider'\n import { Title } from 'web/components/widgets/title'\n import { useIsIframe } from 'web/hooks/use-is-iframe'\n import { useIsPageVisible } from 'web/hooks/use-page-visible'\n import { useUser } from 'web/hooks/use-user'\n@@ -30,9 +28,9 @@\n \n export async function getStaticProps(ctx: {\n   params: { username: string; contractSlug: string }\n }) {\n-  const { username, contractSlug } = ctx.params\n+  const { contractSlug } = ctx.params\n   const adminDb = await initSupabaseAdmin()\n   const contract = await getContractFromSlug(adminDb, contractSlug)\n \n   if (!contract) {\n@@ -50,44 +48,14 @@\n       },\n     }\n   }\n \n-  if (contract.token === 'CASH') {\n-    const manaContract = contract.siblingContractId\n-      ? await getContract(adminDb, contract.siblingContractId)\n-      : null\n-    const slug = manaContract?.slug ?? contractSlug.replace(CASH_SUFFIX, '')\n-\n-    return {\n-      redirect: {\n-        destination: `/${username}/${slug}?play=false`,\n-        permanent: false,\n-      },\n-    }\n-  }\n-\n   const props = await getContractParams(contract, adminDb)\n \n-  // Fetch sibling contract if it exists\n-  let cash = undefined\n-  if (contract.siblingContractId) {\n-    const cashContract = await getContract(adminDb, contract.siblingContractId)\n-    if (cashContract) {\n-      const params = await getContractParams(cashContract, adminDb)\n-      cash = pick(params, [\n-        'contract',\n-        'lastBetTime',\n-        'pointsString',\n-        'multiPointsString',\n-        'totalPositions',\n-        'totalBets',\n-      ])\n-    }\n-  }\n   return {\n     props: {\n       state: 'authed',\n-      params: removeUndefinedProps({ ...props, cash }),\n+      params: removeUndefinedProps(props),\n     },\n   }\n }\n \n@@ -109,39 +77,23 @@\n   return <NonPrivateContractPage contractParams={props.params} />\n }\n \n function NonPrivateContractPage(props: { contractParams: ContractParams }) {\n-  const { contract, pointsString, cash } = props.contractParams\n-  const { prefersPlay } = useSweepstakes()\n+  const { contract, pointsString } = props.contractParams\n \n   const points = pointsString ? base64toPoints(pointsString) : []\n-  const cashPoints = cash\n-    ? cash.pointsString\n-      ? base64toPoints(cash.pointsString)\n-      : []\n-    : null\n \n   const inIframe = useIsIframe()\n   if (!contract) {\n     return <Custom404 customText=\"Unable to fetch question\" />\n   }\n   if (inIframe) {\n-    return (\n-      <ContractEmbedPage\n-        contract={contract}\n-        points={points}\n-        cashContract={cash ? cash.contract : null}\n-        cashPoints={cashPoints}\n-      />\n-    )\n+    return <ContractEmbedPage contract={contract} points={points} />\n   }\n \n   return (\n     <Page trackPageView={false} className=\"xl:col-span-10\">\n-      <ContractSEO\n-        contract={!prefersPlay && cash?.contract ? cash.contract : contract}\n-        points={pointsString}\n-      />\n+      <ContractSEO contract={contract} points={pointsString} />\n       <ContractPageContent key={contract.id} {...props.contractParams} />\n     </Page>\n   )\n }\n"
        },
        {
          "path": "web/pages/embed/[username]/[contractSlug].tsx",
          "status": "modified",
          "diff": "Index: web/pages/embed/[username]/[contractSlug].tsx\n===================================================================\n--- web/pages/embed/[username]/[contractSlug].tsx\t5d7a0b8 (parent)\n+++ web/pages/embed/[username]/[contractSlug].tsx\ta3aeeb1 (commit)\n@@ -7,15 +7,15 @@\n } from 'common/chart'\n import {\n   CPMMMultiContract,\n   Contract,\n+  contractPath,\n   getMainBinaryMCAnswer,\n   isBinaryMulti,\n-  twombaContractPath,\n } from 'common/contract'\n import { getMultiBetPoints, getSingleBetPoints } from 'common/contract-params'\n import { DOMAIN, TRADE_TERM } from 'common/envs/constants'\n-import { getContract, getContractFromSlug } from 'common/supabase/contracts'\n+import { getContractFromSlug } from 'common/supabase/contracts'\n import { formatMoney } from 'common/util/format'\n import { getShareUrl } from 'common/util/share'\n import Image from 'next/image'\n import { useRouter } from 'next/router'\n@@ -82,16 +82,8 @@\n   }\n \n   const points = await getHistoryData(contract)\n \n-  let cashContract = null\n-  let cashPoints = null\n-  if (contract.siblingContractId) {\n-    cashContract = await getContract(db, contract.siblingContractId)\n-    if (cashContract) {\n-      cashPoints = await getHistoryData(cashContract)\n-    }\n-  }\n   let multiPoints = null\n   if (\n     contract.outcomeType === 'MULTI_NUMERIC' ||\n     contract.outcomeType === 'DATE'\n@@ -108,9 +100,9 @@\n       pointsToBase64(v)\n     )\n   }\n   return {\n-    props: { contract, points, multiPoints, cashContract, cashPoints },\n+    props: { contract, points, multiPoints },\n   }\n }\n \n export async function getStaticPaths() {\n@@ -120,34 +112,24 @@\n export default function ContractEmbedPage(props: {\n   contract: Contract\n   points: Points | null\n   multiPoints?: MultiBase64Points | null\n-  cashContract: Contract | null\n-  cashPoints: Points | null\n }) {\n   const [showQRCode, setShowQRCode] = useState(false)\n-  const [isCash, setIsCash] = useState(false)\n-  const { cashContract, points, cashPoints } = props\n+  const { points } = props\n   const multiPoints = props.multiPoints\n     ? unserializeBase64Multi(props.multiPoints)\n     : null\n \n   const contract = useLiveContract(props.contract)\n-  const liveCashContract = cashContract\n-    ? // eslint-disable-next-line react-hooks/rules-of-hooks\n-      useLiveContract(cashContract)\n-    : null\n \n   const router = useRouter()\n \n   useEffect(() => {\n     if (router.isReady) {\n       if (router.query.qr !== undefined) {\n         setShowQRCode(true)\n       }\n-      if (router.query.play !== undefined) {\n-        setIsCash(router.query.play === 'false')\n-      }\n     }\n   }, [router.isReady, router.query])\n \n   useEffect(() => {\n@@ -159,19 +141,19 @@\n         hostname: window.location.hostname,\n       })\n   }, [contract?.creatorId, contract?.id, contract?.slug])\n \n-  if (!contract || (isCash && !liveCashContract)) {\n+  if (!contract) {\n     return <Custom404 />\n   }\n \n   return (\n     <>\n       <NoSEO />\n-      <ContractSEO contract={isCash ? liveCashContract! : contract} />\n+      <ContractSEO contract={contract} />\n       <ContractSmolView\n-        contract={isCash ? liveCashContract! : contract}\n-        points={isCash ? cashPoints : points}\n+        contract={contract}\n+        points={points}\n         multiPoints={multiPoints}\n         showQRCode={showQRCode}\n       />\n     </>\n@@ -286,9 +268,9 @@\n   const isPoll = outcomeType === 'POLL'\n   const isMultiNumeric = outcomeType === 'MULTI_NUMERIC'\n   const isDate = outcomeType === 'DATE'\n \n-  const href = `https://${DOMAIN}${twombaContractPath(contract)}`\n+  const href = `https://${DOMAIN}${contractPath(contract)}`\n   const user = useUser()\n   const shareUrl = getShareUrl(contract, user?.username)\n \n   const showMultiChart = isMulti && !!props.multiPoints\n"
        }
      ]
    },
    {
      "id": "paginate-positions",
      "sha": "83e025d7d7bda27e15a4663fc924d1ad7bd77c81",
      "parentSha": "4f61d9bccd1a66d02a43a4eb1fec5b4ca00ec74b",
      "spec": "Implement incremental, offset-based loading for the user positions table and the underlying Supabase query.\n\nChanges required:\n\n1) common/src/supabase/contract-metrics.ts\n- Update getOrderedContractMetricRowsForContractId to support paging by offset in addition to limit.\n  - Add a new trailing parameter: offset: number = 0.\n  - Replace prior limit-only usage with range(offset, offset + limit - 1) on both query halves (the two queries for the two sides/partitions).\n  - Maintain existing filters/orderings:\n    - If answerId is provided, filter eq('answer_id', answerId); else is('answer_id', null).\n    - If order === 'shares', query1 filters has_yes_shares and orders by total_shares_yes descending; query2 filters has_no_shares and orders by total_shares_no descending.\n    - Else (order === 'profit'), query1 orders profit desc and gt('profit', 0); query2 orders profit asc and lt('profit', 0).\n  - Execute with run(query1) and run(query2); return concatenated rows.\n\n2) web/components/contract/user-positions-table.tsx\n- Implement incremental loading using the updated backend function.\n  - Add constants: ROWS_PER_CALL = 50 (per side per request), USER_TABLE_PAGE_SIZE = 20 (UI page size).\n  - State: maintain separate metric arrays and paging state per sort type:\n    - contractMetricsOrderedByProfit: ContractMetric[] | undefined\n    - contractMetricsOrderedByShares: ContractMetric[] | undefined\n    - nextProfitOffset: number\n    - nextSharesOffset: number\n    - hasMoreProfit: boolean\n    - hasMoreShares: boolean\n  - Compute answers array as empty unless viewing a cpmm-multi-1 contract without a preselected answer (then use contract.answers). If an answer is provided via props, treat as a single-answer view.\n  - Update updateContractMetrics(newSortBy, answerIdForShares, loadMore=false):\n    - Guard against overlapping loads; if loadMore is requested but already loading or no more results for that sort, return. Allow full refresh when changing sort type even if currently loading.\n    - On a fresh load (loadMore=false): reset page to 0; clear the corresponding metrics array; reset offsets (0) and hasMore=true for the relevant sort type.\n    - Determine offsetToUse: loadMore ? nextProfitOffset/nextSharesOffset : 0.\n    - Call getOrderedContractMetricRowsForContractId(contractId, db, (newSortBy==='profit' ? undefined : answerIdForShares), newSortBy, ROWS_PER_CALL, offsetToUse).\n    - Convert rows via convertContractMetricRows and append to the appropriate metrics array with uniqBy dedupe keyed by userId + (answerId ?? '') + contractId.\n    - Advance the corresponding next offset by ROWS_PER_CALL.\n    - Update hasMore flags based on rows.length (if loadMore and 0 rows, set hasMore to false; on fresh load set hasMore to rows.length > 0).\n    - Manage loading state to only be true during the fetch.\n  - Trigger initial load in a useEffect once on mount, calling updateContractMetrics(sortBy, currentAnswerId, false).\n  - Counts: keep existing calls to getContractMetricsCount for YES and NO for the current answerId; keep dependencies [currentAnswerId, contractId].\n  - Fetch all answer position counts only for multi-choice contracts that have answers; add dependencies [contract.id, contract.mechanism, answers, setTotalPositions].\n  - Filtering for display:\n    - shares sort: filter by currentAnswerId (answer match or answerId null).\n    - profit sort: display the accumulated profit metrics returned (already restricted to summary rows by the backend when order is profit); do not re-filter by !answerId.\n  - Add a useEffect to auto-load more when the currently visible page needs more items per side:\n    - Partition the currently accumulated metrics for the active sort:\n      - profit: partition by profit >= 0 (left: Profit, right: Loss).\n      - shares: partition by hasYesShares (left: YES, right: NO).\n    - Compute requiredItemsForPageEnd = (page + 1) * USER_TABLE_PAGE_SIZE.\n    - If either side has fewer than requiredItemsForPageEnd and hasMore for the current sort is true and not loading, call updateContractMetrics with loadMore=true to fetch the next chunk.\n  - On sort toggles or answer selection changes, call updateContractMetrics(newSort, selectedAnswerId, false). Do not manually set page; the function resets it.\n  - Update BinaryUserPositionsTable props: replace loadingPositions with pageSize and pass USER_TABLE_PAGE_SIZE. For loading prop, pass true only while loading the first page for the active sort (i.e., when the corresponding next offset is 0).\n  - Inside BinaryUserPositionsTable:\n    - Use largestColumnLength = Math.max(totalYesPositions, totalNoPositions) to drive Pagination totalItems.\n    - Replace prior minHeight logic: reserve space using placeholders computed from the larger of current YES/NO totals; number of placeholders equals min(max(totalYesPositions, totalNoPositions), pageSize), or pageSize if totals are zero.\n    - Update LoadingResults to accept placeholderCount prop and render that many placeholder rows per column.\n\nBehavioral expectations:\n- When the page requires more rows in either column (YES/NO or Profit/Loss), the component fetches the next chunk (ROWS_PER_CALL per side) using the new offset and appends deduped rows.\n- Initial loading spinners and placeholders appear only for the first page. Subsequent loads happen seamlessly without collapsing the table height.\n- Pagination reflects the known total per side (max of YES/NO counts), not just the currently loaded rows.\n- Sorting and answer changes reset paging and loaded state appropriately.",
      "prompt": "Implement paginated, offset-based loading for the user positions table so it can progressively load and display all available positions. Add an offset parameter to the Supabase query that fetches user contract metrics and use range-based paging. In the UI, keep separate offsets and has-more flags per sort type (profit vs shares), prefetch additional data as the user pages so both columns stay filled, and only show the loading state on the initial page. Update the table to reserve space using placeholders based on the known counts for each side, and adjust the pagination to use the total count rather than loaded items. Ensure changing sort or selected answer resets paging and data appropriately.",
      "supplementalFiles": [
        "common/src/supabase/utils.ts",
        "common/src/contract-metric.ts",
        "web/components/widgets/pagination.tsx",
        "web/lib/supabase/db.ts",
        "web/hooks/use-saved-contract-metrics.ts"
      ],
      "fileDiffs": [
        {
          "path": "common/src/supabase/contract-metrics.ts",
          "status": "modified",
          "diff": "Index: common/src/supabase/contract-metrics.ts\n===================================================================\n--- common/src/supabase/contract-metrics.ts\t4f61d9b (parent)\n+++ common/src/supabase/contract-metrics.ts\t83e025d (commit)\n@@ -155,40 +155,49 @@\n   contractId: string,\n   db: SupabaseClient,\n   answerId?: string,\n   order: 'profit' | 'shares' = 'profit',\n-  limit: number = 50\n+  limit: number = 50,\n+  offset: number = 0\n ) {\n-  const q1 = db\n+  let query1 = db\n     .from('user_contract_metrics')\n     .select('*')\n     .eq('contract_id', contractId)\n-    .limit(limit)\n-  const q2 = db\n+  let query2 = db\n     .from('user_contract_metrics')\n     .select('*')\n     .eq('contract_id', contractId)\n-    .limit(limit)\n \n   if (answerId) {\n-    q1.eq('answer_id', answerId)\n-    q2.eq('answer_id', answerId)\n+    query1.eq('answer_id', answerId)\n+    query2.eq('answer_id', answerId)\n   } else {\n-    q1.is('answer_id', null)\n-    q2.is('answer_id', null)\n+    query1.is('answer_id', null)\n+    query2.is('answer_id', null)\n   }\n \n   if (order === 'shares') {\n-    q1.eq(`has_yes_shares`, true).order(`total_shares_yes`, {\n+    query1.eq('has_yes_shares', true).order('total_shares_yes', {\n       ascending: false,\n     })\n-    q2.eq(`has_no_shares`, true).order(`total_shares_no`, { ascending: false })\n+    query2\n+      .eq('has_no_shares', true)\n+      .order('total_shares_no', { ascending: false })\n   } else {\n-    q1.order(`profit`, { ascending: false, nullsFirst: false }).gt(`profit`, 0)\n-    q2.order(`profit`, { ascending: true, nullsFirst: false }).lt(`profit`, 0)\n+    query1\n+      .order('profit', { ascending: false, nullsFirst: false })\n+      .gt('profit', 0)\n+    query2\n+      .order('profit', { ascending: true, nullsFirst: false })\n+      .lt('profit', 0)\n   }\n-  const { data: q1Data } = await run(q1)\n-  const { data: q2Data } = await run(q2)\n+\n+  query1 = query1.range(offset, offset + limit - 1)\n+  query2 = query2.range(offset, offset + limit - 1)\n+\n+  const { data: q1Data } = await run(query1)\n+  const { data: q2Data } = await run(query2)\n   return q1Data.concat(q2Data)\n }\n \n export async function getContractIdsWithMetrics(\n"
        },
        {
          "path": "web/components/contract/user-positions-table.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/user-positions-table.tsx\n===================================================================\n--- web/components/contract/user-positions-table.tsx\t4f61d9b (parent)\n+++ web/components/contract/user-positions-table.tsx\t83e025d (commit)\n@@ -42,8 +42,11 @@\n import { UserHovercard } from '../user/user-hovercard'\n import { Select } from '../widgets/select'\n import { getPseudonym } from '../charts/contract/choice'\n \n+const ROWS_PER_CALL = 50 // Number of items to fetch per backend call, per side\n+const USER_TABLE_PAGE_SIZE = 20 // Number of items displayed per page in the UI\n+\n export const UserPositionsTable = memo(\n   function UserPositionsTableContent(props: {\n     contract: BinaryContract | CPMMMultiContract\n     setTotalPositions?: (totalPositions: number) => void\n@@ -55,114 +58,230 @@\n     const { contract, setTotalPositions, answerDetails } = props\n     const answer = answerDetails?.answer\n     const contractId = contract.id\n \n-    useEffect(() => {\n-      updateContractMetrics(sortBy, currentAnswerId)\n-    }, [])\n-\n     const [contractMetricsOrderedByProfit, setContractMetricsOrderedByProfit] =\n       useState<ContractMetric[] | undefined>()\n+    const [nextProfitOffset, setNextProfitOffset] = useState(0)\n+    const [hasMoreProfit, setHasMoreProfit] = useState(true)\n+\n     const [contractMetricsOrderedByShares, setContractMetricsOrderedByShares] =\n       useState<ContractMetric[] | undefined>(undefined)\n+    const [nextSharesOffset, setNextSharesOffset] = useState(0)\n+    const [hasMoreShares, setHasMoreShares] = useState(true)\n+\n     const [metricsCountsByAnswerId, setMetricsCountsByAnswerId] = useState<{\n       [key: string]: number\n     }>(\n       answerDetails\n         ? { [answerDetails.answer.id]: answerDetails.totalPositions }\n         : {}\n     )\n-    const answers = answer\n-      ? [answer]\n-      : contract.mechanism === 'cpmm-multi-1'\n-      ? contract.answers\n-      : []\n+    const answers =\n+      answer || contract.mechanism !== 'cpmm-multi-1' ? [] : contract.answers\n \n     const [currentAnswerId, setCurrentAnswerId] = useState<string | undefined>(\n       answers.length > 0\n         ? getMainBinaryMCAnswer(contract)?.id ??\n             first(orderBy(answers, 'totalLiquidity', 'desc'))?.id\n         : undefined\n     )\n     const [page, setPage] = useState(0)\n-    const [loading, setLoading] = useState(true)\n+    const [loading, setLoading] = useState(false)\n     const [totalYesPositions, setTotalYesPositions] = useState(0)\n     const [totalNoPositions, setTotalNoPositions] = useState(0)\n     const [sortBy, setSortBy] = useState<'profit' | 'shares'>(\n       contract.isResolved ? 'profit' : 'shares'\n     )\n \n     const updateContractMetrics = async (\n-      sortBy: 'profit' | 'shares',\n-      answerId?: string\n+      newSortBy: 'profit' | 'shares',\n+      answerIdForShares?: string,\n+      loadMore = false\n     ) => {\n+      const currentLoading = loading\n+      const currentHasMore =\n+        newSortBy === 'profit' ? hasMoreProfit : hasMoreShares\n+\n+      if (loadMore && (currentLoading || !currentHasMore)) {\n+        if (!currentHasMore && !currentLoading) setLoading(false) // If no more, ensure loading is false\n+        return\n+      }\n+      // If a full refresh is requested while loading something else, allow it if it's not for the same sort type or not a loadMore operation.\n+      // This condition might need refinement based on desired UX for rapid changes.\n+      if (currentLoading && !loadMore && newSortBy !== sortBy) {\n+        // Allow if changing sort type\n+      } else if (currentLoading) {\n+        return\n+      }\n+\n       setLoading(true)\n+\n+      const offsetToUse = loadMore\n+        ? newSortBy === 'profit'\n+          ? nextProfitOffset\n+          : nextSharesOffset\n+        : 0\n+\n+      if (!loadMore) {\n+        setPage(0) // Reset page on new sort/filter\n+        if (newSortBy === 'profit') {\n+          setContractMetricsOrderedByProfit(undefined)\n+          setNextProfitOffset(0)\n+          setHasMoreProfit(true)\n+        } else {\n+          setContractMetricsOrderedByShares(undefined)\n+          setNextSharesOffset(0)\n+          setHasMoreShares(true)\n+        }\n+      }\n       const rows = await getOrderedContractMetricRowsForContractId(\n         contractId,\n         db,\n-        sortBy === 'profit' ? undefined : answerId,\n-        sortBy\n+        newSortBy === 'profit' ? undefined : answerIdForShares,\n+        newSortBy,\n+        ROWS_PER_CALL,\n+        offsetToUse\n       )\n \n-      if (sortBy === 'profit') {\n+      const newMetrics = convertContractMetricRows(rows)\n+\n+      if (newSortBy === 'profit') {\n         setContractMetricsOrderedByProfit((prev) =>\n           uniqBy(\n-            convertContractMetricRows(rows).concat(prev ?? []),\n-            (cm) => cm.userId + cm.answerId + cm.contractId\n+            (loadMore && prev ? prev : []).concat(newMetrics),\n+            (cm) => cm.userId + (cm.answerId ?? '') + cm.contractId\n           )\n         )\n+        setNextProfitOffset(offsetToUse + ROWS_PER_CALL)\n+        if (loadMore) {\n+          if (rows.length === 0) setHasMoreProfit(false)\n+        } else {\n+          setHasMoreProfit(rows.length > 0)\n+        }\n       } else {\n         setContractMetricsOrderedByShares((prev) =>\n           uniqBy(\n-            convertContractMetricRows(rows).concat(prev ?? []),\n-            (cm) => cm.userId + cm.answerId + cm.contractId\n+            (loadMore && prev ? prev : []).concat(newMetrics),\n+            (cm) => cm.userId + (cm.answerId ?? '') + cm.contractId\n           )\n         )\n+        setNextSharesOffset(offsetToUse + ROWS_PER_CALL)\n+        if (loadMore) {\n+          if (rows.length === 0) setHasMoreShares(false)\n+        } else {\n+          setHasMoreShares(rows.length > 0)\n+        }\n       }\n-\n       setLoading(false)\n     }\n \n     useEffect(() => {\n+      // Initial load\n+      updateContractMetrics(sortBy, currentAnswerId, false)\n+    }, []) // sortBy and currentAnswerId are stable initially from props/useState\n+\n+    // Fetch total counts for YES/NO labels (independent of paged positions)\n+    useEffect(() => {\n       getContractMetricsCount(contractId, db, 'yes', currentAnswerId).then(\n         setTotalYesPositions\n       )\n       getContractMetricsCount(contractId, db, 'no', currentAnswerId).then(\n         setTotalNoPositions\n       )\n     }, [currentAnswerId, contractId])\n \n+    // Fetch total positions for all answers (for multi-choice carousel/select)\n     const getAllAnswerPositionCounts = async () => {\n       if (!setTotalPositions) return\n       const count = await getContractMetricsCount(contractId, db)\n       setTotalPositions(count)\n-      if (contract.mechanism == 'cpmm-1') return\n+      if (contract.mechanism === 'cpmm-1' || answers.length === 0) return\n       const allCounts = Object.fromEntries(\n         await Promise.all(\n-          answers.map(async (answer) => {\n-            const count = await getContractMetricsCount(\n+          answers.map(async (ans) => {\n+            const ansCount = await getContractMetricsCount(\n               contractId,\n               db,\n               undefined,\n-              answer.id\n+              ans.id\n             )\n-            return [answer.id, count]\n+            return [ans.id, ansCount]\n           })\n         )\n       )\n       setMetricsCountsByAnswerId(allCounts)\n     }\n     useEffect(() => {\n       getAllAnswerPositionCounts()\n-    }, [])\n+    }, [contract.id, contract.mechanism, answers, setTotalPositions]) // Added dependencies\n \n     const positionsToDisplay = contractMetricsOrderedByShares?.filter((cm) =>\n       currentAnswerId ? cm.answerId === currentAnswerId : !cm.answerId\n     )\n-    const profitPositionsToDisplay = contractMetricsOrderedByProfit?.filter(\n-      (cm) => !cm.answerId\n-    )\n+    const profitPositionsToDisplay = contractMetricsOrderedByProfit // Already filtered by backend for !cm.answerId effectively when sortBy is profit\n \n+    // Effect to load more data when user scrolls near the end of the list\n+    useEffect(() => {\n+      if (loading) return\n+\n+      const currentHasMore = sortBy === 'profit' ? hasMoreProfit : hasMoreShares\n+      if (!currentHasMore) return\n+\n+      const metricsForPartition =\n+        sortBy === 'profit'\n+          ? profitPositionsToDisplay ?? []\n+          : positionsToDisplay ?? []\n+\n+      if (\n+        metricsForPartition.length === 0 &&\n+        (sortBy === 'profit' ? nextProfitOffset : nextSharesOffset) === 0\n+      ) {\n+        // Initial load might still be in progress or returned nothing, wait for it\n+        return\n+      }\n+\n+      let tempLeftLength = 0\n+      let tempRightLength = 0\n+\n+      if (sortBy === 'profit') {\n+        const [left, right] = partition(\n+          metricsForPartition,\n+          (cm) => cm.profit >= 0\n+        )\n+        tempLeftLength = left.length\n+        tempRightLength = right.length\n+      } else {\n+        // 'shares'\n+        const [left, right] = partition(\n+          metricsForPartition,\n+          (cm) => cm.hasYesShares\n+        )\n+        tempLeftLength = left.length\n+        tempRightLength = right.length\n+      }\n+\n+      const requiredItemsForPageEnd = (page + 1) * USER_TABLE_PAGE_SIZE\n+      const shouldLoadMore =\n+        requiredItemsForPageEnd > tempLeftLength ||\n+        requiredItemsForPageEnd > tempRightLength\n+\n+      if (shouldLoadMore && currentHasMore && !loading) {\n+        updateContractMetrics(sortBy, currentAnswerId, true /* loadMore */)\n+      }\n+    }, [\n+      page,\n+      sortBy,\n+      profitPositionsToDisplay,\n+      positionsToDisplay,\n+      hasMoreProfit,\n+      hasMoreShares,\n+      loading,\n+      currentAnswerId,\n+      nextProfitOffset,\n+      nextSharesOffset,\n+    ])\n+\n     if (contract.mechanism === 'cpmm-1' || isBinaryMulti(contract)) {\n       return (\n         <Col className={'w-full'}>\n           <Row className={'mb-2 items-center justify-end gap-2'}>\n@@ -170,24 +289,26 @@\n               sort={sortBy === 'profit' ? 'profit' : 'position'}\n               onSortClick={() => {\n                 const newSort = sortBy === 'shares' ? 'profit' : 'shares'\n                 setSortBy(newSort)\n-                setPage(0)\n-                updateContractMetrics(newSort, currentAnswerId)\n+                updateContractMetrics(newSort, currentAnswerId, false)\n               }}\n             />\n           </Row>\n           <BinaryUserPositionsTable\n-            loading={loading}\n+            loading={\n+              loading &&\n+              (sortBy === 'profit' ? nextProfitOffset : nextSharesOffset) === 0\n+            }\n             contract={contract}\n             positionsByShares={positionsToDisplay}\n             positionsByProfit={profitPositionsToDisplay}\n             totalYesPositions={totalYesPositions}\n             totalNoPositions={totalNoPositions}\n             sortBy={sortBy}\n             page={page}\n             setPage={setPage}\n-            loadingPositions={Math.max(totalYesPositions, totalNoPositions)}\n+            pageSize={USER_TABLE_PAGE_SIZE}\n           />\n         </Col>\n       )\n     } else if (contract.mechanism === 'cpmm-multi-1') {\n@@ -204,9 +325,9 @@\n                   key={answer.id}\n                   selected={answer.id === currentAnswerId}\n                   onSelect={() => {\n                     setCurrentAnswerId(answer.id)\n-                    updateContractMetrics(sortBy, answer.id)\n+                    updateContractMetrics(sortBy, answer.id, false)\n                   }}\n                 >\n                   <Row className={'gap-1'}>\n                     <span className={'max-w-[60px] truncate text-ellipsis'}>\n@@ -230,9 +351,9 @@\n                   className=\"h-9 w-full max-w-sm\"\n                   value={currentAnswerId}\n                   onChange={(e) => {\n                     setCurrentAnswerId(e.target.value)\n-                    updateContractMetrics(sortBy, e.target.value)\n+                    updateContractMetrics(sortBy, e.target.value, false)\n                   }}\n                 >\n                   {orderBy(\n                     answers,\n@@ -259,29 +380,26 @@\n               sort={sortBy === 'profit' ? 'profit' : 'position'}\n               onSortClick={() => {\n                 const newSort = sortBy === 'shares' ? 'profit' : 'shares'\n                 setSortBy(newSort)\n-                setPage(0)\n-                updateContractMetrics(newSort, currentAnswerId)\n+                updateContractMetrics(newSort, currentAnswerId, false)\n               }}\n             />\n           </Row>\n           <BinaryUserPositionsTable\n-            loading={loading}\n+            loading={\n+              loading &&\n+              (sortBy === 'profit' ? nextProfitOffset : nextSharesOffset) === 0\n+            }\n             contract={contract}\n             positionsByShares={positionsToDisplay}\n             positionsByProfit={profitPositionsToDisplay}\n             totalYesPositions={totalYesPositions}\n             totalNoPositions={totalNoPositions}\n             sortBy={sortBy}\n             page={page}\n             setPage={setPage}\n-            loadingPositions={\n-              currentAnswerId && metricsCountsByAnswerId[currentAnswerId]\n-                ? // Just an approximation, could be more asymmetric\n-                  metricsCountsByAnswerId[currentAnswerId] / 2\n-                : Math.max(totalYesPositions, totalNoPositions)\n-            }\n+            pageSize={USER_TABLE_PAGE_SIZE}\n           />\n         </Col>\n       )\n     }\n@@ -299,9 +417,9 @@\n     sortBy: 'profit' | 'shares'\n     page: number\n     setPage: (page: number) => void\n     loading: boolean\n-    loadingPositions: number\n+    pageSize: number\n   }) {\n     const {\n       contract,\n       totalYesPositions,\n@@ -311,11 +429,10 @@\n       sortBy,\n       page,\n       setPage,\n       loading,\n-      loadingPositions,\n+      pageSize,\n     } = props\n-    const pageSize = 20\n     const currentUser = useUser()\n     const followedUsers = useFollows(currentUser?.id)\n     const isCashContract = contract.token === 'CASH'\n \n@@ -335,12 +452,9 @@\n       (cm) => (sortBy === 'profit' ? -cm.profit : cm.totalShares['NO']),\n       'desc'\n     ).slice(page * pageSize, (page + 1) * pageSize)\n \n-    const largestColumnLength =\n-      leftColumnPositions.length > rightColumnPositions.length\n-        ? leftColumnPositions.length\n-        : rightColumnPositions.length\n+    const largestColumnLength = Math.max(totalYesPositions, totalNoPositions)\n \n     const isBinary =\n       contract.outcomeType === 'BINARY' || contract.mechanism === 'cpmm-multi-1'\n     const isStonk = contract.outcomeType === 'STONK'\n@@ -401,22 +515,25 @@\n         </span>\n       )\n     }\n \n+    // Calculate placeholders based on totalYes/No positions for the current view.\n+    const maxSidePositions = Math.max(totalYesPositions, totalNoPositions)\n+    const numPlaceholders =\n+      maxSidePositions > 0 ? Math.min(maxSidePositions, pageSize) : pageSize\n+    const itemsToReserveSpaceFor =\n+      maxSidePositions > 0 ? Math.min(maxSidePositions, pageSize) : pageSize\n+\n     return (\n       <>\n         <Col\n           className={clsx('w-full')}\n-          // To avoid the table height jumping when loading\n           style={{\n-            minHeight: `${\n-              80 +\n-              (loadingPositions > pageSize ? pageSize : loadingPositions) * 57\n-            }px`,\n+            minHeight: `${80 + itemsToReserveSpaceFor * 57}px`,\n           }}\n         >\n           {loading ? (\n-            <LoadingResults />\n+            <LoadingResults placeholderCount={numPlaceholders} />\n           ) : (\n             <Row className={'gap-1'}>\n               <Col className={'w-1/2'}>\n                 <Row className={'justify-between p-2'}>\n@@ -596,20 +713,20 @@\n       </Col>\n     </Row>\n   )\n })\n-const LoadingResults = () => {\n+const LoadingResults = ({ placeholderCount }: { placeholderCount: number }) => {\n   return (\n     <Row className={'gap-1'}>\n       <Col className={'w-1/2'}>\n-        <LoadingPositionsRows />\n-        <LoadingPositionsRows />\n-        <LoadingPositionsRows />\n+        {Array.from({ length: placeholderCount }).map((_, i) => (\n+          <LoadingPositionsRows key={`left-loading-${i}`} />\n+        ))}\n       </Col>\n       <Col className={'w-1/2'}>\n-        <LoadingPositionsRows />\n-        <LoadingPositionsRows />\n-        <LoadingPositionsRows />\n+        {Array.from({ length: placeholderCount }).map((_, i) => (\n+          <LoadingPositionsRows key={`right-loading-${i}`} />\n+        ))}\n       </Col>\n     </Row>\n   )\n }\n"
        }
      ]
    },
    {
      "id": "pin-creator-notifs",
      "sha": "cb40f74102f513d0892a6fd9e8e6534f359e768e",
      "parentSha": "c3fc89f46ccf29deafb69b07dc5b82d31886333a",
      "spec": "Implement pinned comment notifications for market creators that remain visible until explicitly dismissed, with backend detection, read-state updates, websocket broadcasts, and UI support.\n\nBackend API and routing:\n- Define a new authenticated API endpoint path 'mark-notification-read' in common/src/api/schema.ts (POST, authed, props { notificationId: string }, returns { success: boolean }).\n- Implement the handler markNotificationRead in backend/api/src/mark-all-notifications.ts using APIHandler<'mark-notification-read'>:\n  - Update the row in the user_notifications table for the authed user and provided notificationId, setting data.markedAsRead = true (jsonb_set).\n  - After updating, broadcast to topic user-notification-status/{userId} a payload { type: 'marked_as_read', notificationIds: [notificationId] }.\n- Register the handler in backend/api/src/routes.ts by importing markNotificationRead and adding 'mark-notification-read': markNotificationRead to the handlers map.\n\nWebsocket broadcast helper:\n- In backend/shared/src/websockets/helpers.ts, add a helper broadcastNotificationsRead(userId, notificationIds) that calls broadcast('user-notification-status/{userId}', { type: 'marked_as_read', notificationIds }).\n\nNotification typing and creation:\n- Replace the Notification.worksOnSweeple?: boolean field with Notification.markedAsRead?: boolean in common/src/notification.ts.\n- In backend/shared/src/create-notification.ts, update createCommentOnContractNotification to accept a new boolean parameter requiresResponse. When building notifications, set markedAsRead to false only for the market creator’s copy when requiresResponse is true; otherwise leave markedAsRead undefined. Remove any references to worksOnSweeple from notifications in this file so types compile.\n\nComment-created flow (AI detection + notification call site):\n- In backend/api/src/on-create-comment-on-contract.ts:\n  - Build reply-thread context: fetch comments in the same reply chain (by answerOutcome or replyToCommentId) ordered by created time (ascending). Use their data (including user info and content) to construct a plain-text threadContext string with [CREATOR]/[USER] tags and author display names, excluding the new comment itself. Format the new comment’s text similarly.\n  - Skip AI detection if commenter is the creator. Otherwise, call a new function checkCommentNeedsResponse(contract, threadContext | null, newCommentText) that returns { needsResponse: boolean; reason: string } based on a Gemini prompt and parser (see shared helpers). On error, default to needsResponse=false.\n  - Pass needsResponse to createCommentOnContractNotification as the new requiresResponse parameter.\n  - Ensure lastCommentTime and lastUpdatedTime are updated promptly on comment creation (updateContract), then follow contract, revalidate props.\n\nGemini helper usage:\n- Use shared/helpers/gemini to implement checkCommentNeedsResponse: construct a prompt that includes market title, description (parsed to text), optional thread context, and the newest comment; call promptGemini and parseGeminiResponseAsJson; return parsed JSON with fallback to { needsResponse: false, reason: '' } on failure.\n\nClient data flow and state updates:\n- In client-common/src/hooks/use-notifications.ts:\n  - Add a websocket subscription via useApiSubscription to topic user-notification-status/{userId}.\n  - On receiving { type: 'marked_as_read', notificationIds }, update local notifications state by setting markedAsRead=true for those IDs.\n  - Compute pinnedNotifications = notifications with markedAsRead === false and regularNotifications = all others. Group only regularNotifications in existing grouping helpers. Expose pinnedNotifications alongside groupedNotifications and mostRecentNotification.\n\nUI updates for pinned notifications:\n- Update web/components/notifications/notification-helpers.tsx (NotificationFrame):\n  - Support new props isPinned?: boolean and onDismiss?: () => void.\n  - Visually distinguish pinned notifications (e.g., background highlight) and render a dismiss button (X icon) that invokes onDismiss without navigating.\n  - Ensure the dropdown button remains in the frame header and adjust styles accordingly.\n- Update web/components/notifications/notification-types.tsx (CommentNotification rendering):\n  - Treat notifications with markedAsRead === false as pinned (isPinned=true).\n  - When pinned, provide onDismiss handler that calls api('mark-notification-read', { notificationId }) to mark it read.\n- Update web/pages/notifications.tsx:\n  - Render a pinned notifications section at the top when pinnedNotifications exist; show the count, allow collapsing/expanding via persistent local state, and list pinned Comment notifications there.\n  - Keep existing grouped notifications below. If no regular notifications and no pinned, show the standard empty state.\n- Minor UI tweak: adjust the notification dropdown icon class to match the new layout (remove extra margin so it aligns in the header).\n\nAcceptance criteria:\n- When a non-creator comments and the comment likely needs creator attention (per Gemini), the creator receives a notification with markedAsRead=false.\n- Pinned notifications appear in a dedicated section on the Notifications page and within list items get a highlighted background and dismiss button.\n- Clicking dismiss marks that specific notification as read on the server (data.markedAsRead=true) and removes it from the pinned section immediately via websocket update.\n- The new API route 'mark-notification-read' is authed, validated, and exposed via the typed API, and the client call succeeds.\n- Regular notifications continue to function; grouping excludes pinned items. Types compile with the new Notification.markedAsRead field and removed worksOnSweeple usages.",
      "prompt": "Add pinned comment notifications for market creators. When a new comment on a market plausibly requires a response from the creator, automatically create a notification for the creator that stays pinned until they dismiss it. Add an authenticated API to mark a single notification as read, broadcast that change to the user in real time, and update the client to display a collapsible “needs your attention” section with dismiss buttons for these pinned items. Use the existing websocket client to subscribe to read-status updates, and integrate this into the existing notifications hook and components. Use an LLM to decide when a comment needs a response by analyzing the market’s title, description, and the comment thread context, and only pin the notification for the creator when the model indicates it should. Preserve normal notification behavior for everything else.",
      "supplementalFiles": [
        "backend/api/src/helpers/endpoint.ts",
        "backend/shared/src/websockets/server.ts",
        "client-common/src/hooks/use-api-subscription.ts",
        "common/src/util/parse.ts",
        "web/lib/api/api.ts",
        "backend/shared/src/helpers/gemini.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/mark-all-notifications.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/mark-all-notifications.ts\n===================================================================\n--- backend/api/src/mark-all-notifications.ts\tc3fc89f (parent)\n+++ backend/api/src/mark-all-notifications.ts\tcb40f74 (commit)\n@@ -1,6 +1,7 @@\n-import { authEndpoint } from './helpers/endpoint'\n+import { APIHandler, authEndpoint } from './helpers/endpoint'\n import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { broadcastNotificationsRead } from 'shared/websockets/helpers'\n \n export const markallnotifications = authEndpoint(async (_req, auth) => {\n   const pg = createSupabaseDirectClient()\n   await pg.none(\n@@ -12,4 +13,20 @@\n   )\n \n   return { success: true }\n })\n+\n+export const markNotificationRead: APIHandler<\n+  'mark-notification-read'\n+> = async (props, auth) => {\n+  const { notificationId } = props\n+  const pg = createSupabaseDirectClient()\n+\n+  await pg.none(\n+    `update user_notifications set data = jsonb_set(data, '{markedAsRead}', 'true'::jsonb) where notification_id = $1 and user_id = $2`,\n+    [notificationId, auth.uid]\n+  )\n+\n+  broadcastNotificationsRead(auth.uid, [notificationId])\n+\n+  return { success: true }\n+}\n"
        },
        {
          "path": "backend/api/src/on-create-comment-on-contract.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/on-create-comment-on-contract.ts\n===================================================================\n--- backend/api/src/on-create-comment-on-contract.ts\tc3fc89f (parent)\n+++ backend/api/src/on-create-comment-on-contract.ts\tcb40f74 (commit)\n@@ -6,9 +6,13 @@\n   createCommentOnContractNotification,\n   replied_users_info,\n   createAIDescriptionUpdateNotification,\n } from 'shared/create-notification'\n-import { parseMentions, richTextToString } from 'common/util/parse'\n+import {\n+  parseJsonContentToText,\n+  parseMentions,\n+  richTextToString,\n+} from 'common/util/parse'\n import { Contract, contractPath } from 'common/contract'\n import { User } from 'common/user'\n import {\n   createSupabaseDirectClient,\n@@ -25,8 +29,9 @@\n import { cloneDeep } from 'lodash'\n import { track } from 'shared/analytics'\n import { DEV_HOUSE_LIQUIDITY_PROVIDER_ID } from 'common/antes'\n import { promptOpenAI } from 'shared/helpers/openai-utils'\n+import { parseGeminiResponseAsJson, promptGemini } from 'shared/helpers/gemini'\n \n type ClarificationResponse = {\n   isClarification: boolean\n   description?: string\n@@ -39,26 +44,23 @@\n   bet?: Bet\n }) => {\n   const { contract, comment, creator, bet } = props\n   const pg = createSupabaseDirectClient()\n-\n+  const lastCommentTime = comment.createdTime\n+  await updateContract(pg, contract.id, {\n+    lastCommentTime,\n+    lastUpdatedTime: Date.now(),\n+  })\n   await revalidateStaticProps(contractPath(contract)).catch((e) =>\n     log.error('Failed to revalidate contract after comment', {\n       e,\n       comment,\n       creator,\n     })\n   )\n \n-  const lastCommentTime = comment.createdTime\n-\n   await followContractInternal(pg, contract.id, true, creator.id)\n \n-  await updateContract(pg, contract.id, {\n-    lastCommentTime,\n-    lastUpdatedTime: Date.now(),\n-  })\n-\n   if (\n     creator.id === contract.creatorId &&\n     !contract.isResolved &&\n     contract.outcomeType !== 'POLL'\n@@ -75,38 +77,43 @@\n   contract: Contract\n ) => {\n   if (comment.answerOutcome && contract.outcomeType === 'MULTIPLE_CHOICE') {\n     const answer = await getAnswer(pg, comment.answerOutcome)\n-    const comments = await pg.manyOrNone(\n-      `select comment_id, user_id\n+    const comments = await pg.manyOrNone<{\n+      user_id: string\n+      data: ContractComment // Need data for context\n+    }>(\n+      `select user_id, data\n       from contract_comments\n-      where contract_id = $1 and coalesce(data->>'answerOutcome', '') = $2`,\n+      where contract_id = $1 and coalesce(data->>'answerOutcome', '') = $2\n+      order by created_time asc`,\n       [contract.id, answer?.id ?? '']\n     )\n     return {\n       repliedToAnswer: answer,\n       repliedToType: 'answer',\n       repliedUserId: answer?.userId,\n-      commentsInSameReplyChain: comments,\n+      commentsInSameReplyChain: comments, // Comments replying to the same answer\n     } as const\n   } else if (comment.replyToCommentId) {\n-    const comments = await pg.manyOrNone(\n-      `select comment_id, user_id, data->>'replyToCommentId' as reply_to_id\n+    const comments = await pg.manyOrNone<{\n+      user_id: string\n+      data: ContractComment\n+    }>(\n+      `select user_id, data\n       from contract_comments where contract_id = $1\n         and (coalesce(data->>'replyToCommentId', '') = $2\n             or comment_id = $2)\n-      `,\n+      order by created_time asc`,\n       [contract.id, comment.replyToCommentId]\n     )\n     return {\n       repliedToAnswer: null,\n       repliedToType: 'comment',\n       repliedUserId: comments.find(\n-        (c) => c.comment_id === comment.replyToCommentId\n+        (c) => c.data.id === comment.replyToCommentId\n       )?.user_id,\n-      commentsInSameReplyChain: comments.filter(\n-        (c) => c.reply_to_id === comment.replyToCommentId\n-      ),\n+      commentsInSameReplyChain: comments,\n     } as const\n   } else {\n     return null\n   }\n@@ -143,9 +150,10 @@\n         bet: bet,\n       }\n \n     if (commentsInSameReplyChain) {\n-      // The rest of the children in the chain are always comments\n+      // Add users from the reply chain (parent and siblings) to notifications,\n+      // excluding the commenter and the direct recipient (already added)\n       commentsInSameReplyChain.forEach((c) => {\n         if (c.user_id !== comment.userId && c.user_id !== repliedUserId) {\n           repliedUsers[c.user_id] = {\n             repliedToType: 'comment',\n@@ -160,15 +168,60 @@\n   if (mentionedMods) {\n     await insertModReport(comment)\n   }\n \n+  // Prepare context for Gemini check\n+  let threadContext: string | null = null\n+  let newCommentText = ''\n+  if (replyInfo?.commentsInSameReplyChain) {\n+    // Build the thread context: comments in the same chain + the new comment\n+    const threadComments = [\n+      ...replyInfo.commentsInSameReplyChain\n+        .filter((c) => c.data.id !== comment.id) // Filter out the new comment itself\n+        .map((c) => ({\n+          userId: c.user_id,\n+          userName: c.data.userName,\n+          userUsername: c.data.userUsername,\n+          content: c.data.content,\n+        })),\n+    ]\n+\n+    threadContext = threadComments\n+      .map((c) => {\n+        const authorTag =\n+          c.userId === contract.creatorId ? '[CREATOR]' : '[USER]'\n+        const name = c.userName\n+          ? `${c.userName} (@${c.userUsername})`\n+          : `User ${c.userId.substring(0, 4)}`\n+        return `${authorTag} ${name}: ${richTextToString(c.content)}`\n+      })\n+      .join('\\n---\\n') // Separator between comments\n+  }\n+\n+  // Format the new comment text\n+  const newCommentAuthorTag =\n+    comment.userId === contract.creatorId ? '[CREATOR]' : '[USER]'\n+  newCommentText = `${newCommentAuthorTag} ${\n+    commentCreator.name\n+      ? `${commentCreator.name} (@${commentCreator.username})`\n+      : `User ${commentCreator.id.substring(0, 4)}`\n+  }: ${richTextToString(comment.content)}`\n+\n+  // Check if comment needs response using Gemini, now with context\n+  const checkResult =\n+    comment.userId === contract.creatorId\n+      ? { needsResponse: false }\n+      : await checkCommentNeedsResponse(contract, threadContext, newCommentText)\n+  const needsResponse = checkResult.needsResponse\n+\n   await createCommentOnContractNotification(\n     comment.id,\n     commentCreator,\n     richTextToString(comment.content),\n     contract,\n     repliedUsers,\n-    mentionedUsers\n+    mentionedUsers,\n+    needsResponse\n   )\n   return [...mentionedUsers, ...Object.keys(repliedUsers)]\n }\n \n@@ -350,4 +403,52 @@\n   } catch (e) {\n     log.error('Error checking for clarification:', { e })\n   }\n }\n+\n+export const checkCommentNeedsResponse = async (\n+  contract: Contract,\n+  threadContext: string | null,\n+  newCommentText: string\n+) => {\n+  const prompt = `\n+  Analyze the NEWEST COMMENT on a prediction market and determine if it requires a response from the market creator.\n+\n+  The creator is a user of Manifold Markets that created the market and resolves it using their judgement, along with the title and description of the market.\n+\n+  The NEWEST COMMENT should be considered as needing a response if it:\n+  1. Asks for clarification about the market or its resolution criteria\n+  2. Requests the market to be resolved\n+  3. Points out potential issues that need to be addressed\n+  4. (If relevant to the market) Requests an update on the status of the market from the creator\n+  5. Asks a direct question to the market creator and the question is related to the market\n+\n+  Market title: ${contract.question}\n+  Market description: ${parseJsonContentToText(contract.description)}\n+\n+  ${\n+    threadContext\n+      ? `COMMENT THREAD CONTEXT (previous messages):\\n\\`\\`\\`\\n${threadContext}\\n\\`\\`\\`\\nThe thread context uses [USER] and [CREATOR] tags. Discussions between users not addressing the creator should NOT be considered as needing a response.`\n+      : 'This is a top-level comment (not a reply).'\n+  }\n+\n+  NEWEST COMMENT (Analyze this comment for whether a response is needed):\n+  \\`\\`\\`\n+  ${newCommentText}\n+  \\`\\`\\`\n+\n+  Return a JSON object with:\n+  - needsResponse: boolean // True if the *newest comment* requires a response based ONLY on its content and the criteria above.\n+  - reason: string (brief explanation why, or empty if no response needed)\n+\n+  Only return the JSON object, no other text.`\n+\n+  try {\n+    const response = await promptGemini(prompt)\n+    const result = parseGeminiResponseAsJson(response)\n+    return result as { needsResponse: boolean; reason: string }\n+  } catch (error) {\n+    log.error(`Error checking if comment needs response: ${error}`)\n+    // Default to false if there's an error\n+    return { needsResponse: false, reason: '' }\n+  }\n+}\n"
        },
        {
          "path": "backend/api/src/routes.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/routes.ts\n===================================================================\n--- backend/api/src/routes.ts\tc3fc89f (parent)\n+++ backend/api/src/routes.ts\tcb40f74 (commit)\n@@ -180,8 +180,9 @@\n   getMarketDrafts,\n   deleteMarketDraft,\n } from './market-drafts'\n import { getSeasonInfo } from './get-season-info'\n+import { markNotificationRead } from './mark-all-notifications'\n \n export const handlers: { [k in APIPath]: APIHandler<k> } = {\n   'refresh-all-clients': refreshAllClients,\n   bet: placeBet,\n@@ -372,5 +373,6 @@\n   'save-market-draft': saveMarketDraft,\n   'get-market-drafts': getMarketDrafts,\n   'delete-market-draft': deleteMarketDraft,\n   'get-season-info': getSeasonInfo,\n+  'mark-notification-read': markNotificationRead,\n }\n"
        },
        {
          "path": "backend/shared/src/create-notification.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/create-notification.ts\n===================================================================\n--- backend/shared/src/create-notification.ts\tc3fc89f (parent)\n+++ backend/shared/src/create-notification.ts\tcb40f74 (commit)\n@@ -199,9 +199,10 @@\n   sourceUser: User,\n   sourceText: string,\n   sourceContract: Contract,\n   repliedUsersInfo: replied_users_info,\n-  taggedUserIds: string[]\n+  taggedUserIds: string[],\n+  requiresResponse: boolean\n ) => {\n   const pg = createSupabaseDirectClient()\n \n   const usersToReceivedNotifications: Record<\n@@ -215,9 +216,9 @@\n     (r) => r.follow_id\n   )\n   const isReply = Object.keys(repliedUsersInfo).length > 0\n   const buildNotification = (userId: string, reason: NotificationReason) => {\n-    const notification: Notification = {\n+    return removeUndefinedProps({\n       id: nanoid(6),\n       userId,\n       reason,\n       createdTime: Date.now(),\n@@ -237,11 +238,13 @@\n       sourceTitle: sourceContract.question,\n       data: {\n         isReply,\n       } as CommentNotificationData,\n-      worksOnSweeple: !!sourceContract.siblingContractId,\n-    }\n-    return removeUndefinedProps(notification)\n+      markedAsRead:\n+        requiresResponse && sourceContract.creatorId === userId\n+          ? false\n+          : undefined,\n+    }) as Notification\n   }\n \n   const needNotFollowContractReasons = ['tagged_user']\n \n@@ -559,9 +562,8 @@\n       limitAt: limitAt.toString(),\n       outcomeType: contract.outcomeType,\n       token: contract.token,\n     } as BetFillData,\n-    worksOnSweeple: !!contract.siblingContractId,\n   }\n   if (sendToBrowser) {\n     const pg = createSupabaseDirectClient()\n     await insertNotificationToSupabase(notification, pg)\n@@ -837,9 +839,8 @@\n       streak: streak,\n       bonusAmount: amount,\n       cashAmount: 0,\n     } as BettingStreakData,\n-    worksOnSweeple: true,\n   }\n   const pg = createSupabaseDirectClient()\n   await insertNotificationToSupabase(notification, pg)\n }\n@@ -880,9 +881,8 @@\n       sourceTitle: 'Betting Streak Expiring',\n       data: {\n         streak: streak,\n       } as BettingStreakData,\n-      worksOnSweeple: true,\n     }\n     if (sendToMobile) {\n       bulkPushNotifications.push([\n         privateUser,\n@@ -1025,9 +1025,8 @@\n     sourceContractId: contractId,\n     sourceText: text,\n     sourceSlug: slug,\n     sourceTitle: contract.question,\n-    worksOnSweeple: !!contract.siblingContractId && content_type !== 'contract',\n   }\n   return await insertNotificationToSupabase(notification, pg)\n }\n \n@@ -1350,9 +1349,8 @@\n         totalShareholders: sortedProfits.length,\n         profit: userIdToContractMetrics?.[userId]?.profit ?? 0,\n         token,\n       }) as ContractResolutionData,\n-      worksOnSweeple: !!contract.siblingContractId,\n     }\n   }\n \n   const sendNotificationsIfSettingsPermit = async (\n@@ -1550,9 +1548,8 @@\n     data: {\n       questType,\n       questCount,\n     } as QuestRewardTxn['data'],\n-    worksOnSweeple: true,\n   }\n   const pg = createSupabaseDirectClient()\n   await insertNotificationToSupabase(notification, pg)\n }\n@@ -2027,9 +2024,8 @@\n     sourceUserUsername: MANIFOLD_USER_USERNAME,\n     sourceUserAvatarUrl: MANIFOLD_AVATAR_URL,\n     sourceText: amount.toString(),\n     sourceTitle: 'Push Notification Bonus',\n-    worksOnSweeple: true,\n   }\n   const pg = createSupabaseDirectClient()\n   await insertNotificationToSupabase(notification, pg)\n }\n@@ -2132,9 +2128,8 @@\n     sourceUserUsername: '',\n     sourceUserAvatarUrl: '',\n     sourceText: '',\n     data: paymentData,\n-    worksOnSweeple: true,\n   }\n \n   const pg = createSupabaseDirectClient()\n   await insertNotificationToSupabase(notification, pg)\n"
        },
        {
          "path": "backend/shared/src/websockets/helpers.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/websockets/helpers.ts\n===================================================================\n--- backend/shared/src/websockets/helpers.ts\tc3fc89f (parent)\n+++ backend/shared/src/websockets/helpers.ts\tcb40f74 (commit)\n@@ -128,4 +128,14 @@\n   annotation: ChartAnnotation\n ) {\n   broadcast(`contract/${contractId}/chart-annotation`, { annotation })\n }\n+\n+export function broadcastNotificationsRead(\n+  userId: string,\n+  notificationIds: string[]\n+) {\n+  broadcast(`user-notification-status/${userId}`, {\n+    type: 'marked_as_read',\n+    notificationIds,\n+  })\n+}\n"
        },
        {
          "path": "client-common/src/hooks/use-notifications.ts",
          "status": "modified",
          "diff": "Index: client-common/src/hooks/use-notifications.ts\n===================================================================\n--- client-common/src/hooks/use-notifications.ts\tc3fc89f (parent)\n+++ client-common/src/hooks/use-notifications.ts\tcb40f74 (commit)\n@@ -98,8 +98,27 @@\n         return [newNotification, ...(notifs ?? [])]\n       })\n     },\n   })\n+  useApiSubscription({\n+    topics: [`user-notification-status/${userId}`],\n+    onBroadcast: ({ data }) => {\n+      const payload = data as {\n+        type: string\n+        notificationIds: string[]\n+      }\n+      if (payload.type === 'marked_as_read' && payload.notificationIds) {\n+        // Handle notification read update\n+        setNotifications((notifs) =>\n+          notifs?.map((n) =>\n+            payload.notificationIds.includes(n.id)\n+              ? { ...n, markedAsRead: true }\n+              : n\n+          )\n+        )\n+      }\n+    },\n+  })\n   return { notifications, markAllAsSeen }\n }\n \n export function useGroupedUnseenNotifications(\n@@ -154,21 +173,28 @@\n   const sortedNotifications = filteredNotifications\n     ? sortBy(filteredNotifications, (n) => -n.createdTime)\n     : undefined\n \n+  const pinnedNotifications = sortedNotifications?.filter(\n+    (n) => n.markedAsRead === false\n+  )\n+  const regularNotifications = sortedNotifications?.filter(\n+    (n) => n.markedAsRead !== false\n+  )\n+\n   const [groupedNotifications, mostRecentNotification] =\n-    groupGeneralNotifications(sortedNotifications, [\n+    groupGeneralNotifications(regularNotifications, [\n       'loan_income',\n       'contract_from_followed_user',\n     ])\n \n   const groupedNewMarketNotifications = groupSpecificNotifications(\n-    sortedNotifications,\n+    regularNotifications,\n     (n) => n.reason === 'contract_from_followed_user',\n     (n) => new Date(n.createdTime).toDateString() + n.sourceUserUsername\n   )\n   const groupedMentionNotifications = groupSpecificNotifications(\n-    sortedNotifications,\n+    regularNotifications,\n     (n) =>\n       n.reason === 'tagged_user' ||\n       (n.sourceType === 'comment' &&\n         n.sourceText &&\n@@ -180,8 +206,9 @@\n \n   return useMemo(\n     () => ({\n       mostRecentNotification,\n+      pinnedNotifications,\n       groupedNotifications,\n       groupedNewMarketNotifications,\n       groupedMentionNotifications,\n       markAllAsSeen,\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\tc3fc89f (parent)\n+++ common/src/api/schema.ts\tcb40f74 (commit)\n@@ -2382,8 +2382,17 @@\n       endTime: number | null // epoch ms, null if a *mystery* for clients\n       status: 'active' | 'processing' | 'complete'\n     },\n   },\n+  'mark-notification-read': {\n+    method: 'POST',\n+    visibility: 'private',\n+    authed: true,\n+    returns: {} as { success: boolean },\n+    props: z.object({\n+      notificationId: z.string(),\n+    }).strict(),\n+  },\n } as const)\n \n export type APIPath = keyof typeof API\n export type APISchema<N extends APIPath> = (typeof API)[N]\n"
        },
        {
          "path": "common/src/notification.ts",
          "status": "modified",
          "diff": "Index: common/src/notification.ts\n===================================================================\n--- common/src/notification.ts\tc3fc89f (parent)\n+++ common/src/notification.ts\tcb40f74 (commit)\n@@ -41,9 +41,9 @@\n   sourceSlug?: string\n   sourceTitle?: string\n \n   isSeenOnHref?: string\n-  worksOnSweeple?: boolean\n+  markedAsRead?: boolean\n }\n \n export type NotificationReason =\n   | notification_reason_types\n"
        },
        {
          "path": "web/components/notifications/notification-dropdown.tsx",
          "status": "modified",
          "diff": "Index: web/components/notifications/notification-dropdown.tsx\n===================================================================\n--- web/components/notifications/notification-dropdown.tsx\tc3fc89f (parent)\n+++ web/components/notifications/notification-dropdown.tsx\tcb40f74 (commit)\n@@ -30,9 +30,9 @@\n       <DropdownMenu\n         items={notificationDropdownItems}\n         buttonContent={\n           <DotsVerticalIcon\n-            className={clsx('my-1 h-4 w-4 md:invisible md:group-hover:visible')}\n+            className={clsx('h-4 w-4 md:invisible md:group-hover:visible')}\n           />\n         }\n         menuWidth=\"w-52\"\n       />\n"
        },
        {
          "path": "web/components/notifications/notification-helpers.tsx",
          "status": "modified",
          "diff": "Index: web/components/notifications/notification-helpers.tsx\n===================================================================\n--- web/components/notifications/notification-helpers.tsx\tc3fc89f (parent)\n+++ web/components/notifications/notification-helpers.tsx\tcb40f74 (commit)\n@@ -10,11 +10,12 @@\n import { Row } from '../layout/row'\n import { RelativeTimestampNoTooltip } from '../relative-timestamp'\n import { truncateText } from '../widgets/truncate'\n import NotificationDropdown from './notification-dropdown'\n-import { SparklesIcon } from '@heroicons/react/solid'\n+import { SparklesIcon, XCircleIcon } from '@heroicons/react/solid'\n import { UserLink } from '../widgets/user-link'\n import { UserHovercard } from '../user/user-hovercard'\n+import { Button } from '../buttons/button'\n \n function getHighlightClass(highlight: boolean) {\n   return highlight ? 'text-ink-1000 bg-primary-50' : 'text-ink-700'\n }\n@@ -171,8 +172,10 @@\n   onClick?: () => void\n   subtitle?: string | ReactNode\n   isChildOfGroup?: boolean\n   customBackground?: ReactNode\n+  isPinned?: boolean\n+  onDismiss?: () => void\n }) {\n   const {\n     notification,\n     highlighted,\n@@ -182,8 +185,10 @@\n     subtitle,\n     onClick,\n     link,\n     customBackground,\n+    isPinned,\n+    onDismiss,\n   } = props\n   const isMobile = useIsMobile()\n \n   const markAsSeen = () => {\n@@ -200,29 +205,47 @@\n           <span>{children}</span>\n           <div className=\"mt-1 line-clamp-3 text-xs md:text-sm\">{subtitle}</div>\n         </Col>\n \n-        <Row className=\"mt-1 items-center justify-end gap-1 pr-1 sm:w-36\">\n-          {highlighted && !isMobile && (\n-            <SparklesIcon className=\"text-primary-600 h-4 w-4\" />\n-          )}\n-          <RelativeTimestampNoTooltip\n-            time={notification.createdTime}\n-            shortened={isMobile}\n-            className={clsx(\n-              'text-xs',\n-              highlighted ? 'text-primary-600' : 'text-ink-700'\n+        <Col className=\"h-full items-end justify-between gap-1\">\n+          <Row className=\"mt-1 justify-end gap-1 sm:w-36\">\n+            {highlighted && !isMobile && (\n+              <SparklesIcon className=\"text-primary-600 h-4 w-4\" />\n             )}\n-          />\n-        </Row>\n+            <RelativeTimestampNoTooltip\n+              time={notification.createdTime}\n+              shortened={isMobile}\n+              className={clsx(\n+                'text-xs',\n+                highlighted ? 'text-primary-600' : 'text-ink-700'\n+              )}\n+            />\n+            <NotificationDropdown notification={notification} />\n+          </Row>\n+          {isPinned && onDismiss && (\n+            <Button\n+              color=\"gray-white\"\n+              onClick={(e) => {\n+                e.preventDefault()\n+                e.stopPropagation()\n+                onDismiss()\n+              }}\n+              className=\"text-ink-500 hover:text-ink-700 \"\n+            >\n+              <XCircleIcon className=\"h-5 w-5\" />\n+            </Button>\n+          )}\n+        </Col>\n       </Row>\n     </Row>\n   )\n \n   return (\n     <Row\n       className={clsx(\n-        'hover:bg-primary-100 group p-2 transition-colors',\n+        'group p-2 transition-colors',\n+        isPinned && 'bg-primary-50',\n+        'hover:bg-primary-100',\n         getHighlightClass(highlighted)\n       )}\n     >\n       {customBackground}\n@@ -250,12 +273,8 @@\n         >\n           {frameObject}\n         </Col>\n       )}\n-\n-      <div className=\"self-start\">\n-        <NotificationDropdown notification={notification} />\n-      </div>\n     </Row>\n   )\n }\n \n"
        },
        {
          "path": "web/components/notifications/notification-types.tsx",
          "status": "modified",
          "diff": "Index: web/components/notifications/notification-types.tsx\n===================================================================\n--- web/components/notifications/notification-types.tsx\tc3fc89f (parent)\n+++ web/components/notifications/notification-types.tsx\tcb40f74 (commit)\n@@ -66,8 +66,9 @@\n   PrimaryNotificationLink,\n   QuestionOrGroupLink,\n } from './notification-helpers'\n import { FaArrowTrendUp, FaArrowTrendDown } from 'react-icons/fa6'\n+import { api } from 'web/lib/api/api'\n \n export function NotificationItem(props: {\n   notification: Notification\n   isChildOfGroup?: boolean\n@@ -1089,14 +1090,26 @@\n     sourceUserUsername,\n     reason,\n     sourceText,\n     sourceContractTitle,\n+    markedAsRead,\n   } = notification\n+\n   const reasonText =\n     reason === 'reply_to_users_answer' || reason === 'reply_to_users_comment'\n       ? 'replied to you '\n       : `commented `\n+\n   const comment = sourceText\n+\n+  const handleDismiss = async () => {\n+    await api('mark-notification-read', {\n+      notificationId: notification.id,\n+    })\n+  }\n+\n+  const isPinned = markedAsRead === false\n+\n   return (\n     <NotificationFrame\n       notification={notification}\n       isChildOfGroup={isChildOfGroup}\n@@ -1105,17 +1118,19 @@\n       icon={\n         <AvatarNotificationIcon notification={notification} symbol={'💬'} />\n       }\n       subtitle={\n-        comment ? (\n-          <div className=\"line-clamp-2\">\n-            <Linkify text={comment} />{' '}\n-          </div>\n-        ) : (\n-          <></>\n-        )\n+        <div>\n+          {comment && (\n+            <div className=\"line-clamp-2\">\n+              <Linkify text={comment} />\n+            </div>\n+          )}\n+        </div>\n       }\n       link={getSourceUrl(notification)}\n+      isPinned={isPinned}\n+      onDismiss={isPinned ? handleDismiss : undefined}\n     >\n       <div className=\"line-clamp-3\">\n         <NotificationUserLink\n           userId={sourceId}\n"
        },
        {
          "path": "web/pages/notifications.tsx",
          "status": "modified",
          "diff": "Index: web/pages/notifications.tsx\n===================================================================\n--- web/pages/notifications.tsx\tc3fc89f (parent)\n+++ web/pages/notifications.tsx\tcb40f74 (commit)\n@@ -46,8 +46,9 @@\n import { maybePluralize } from 'common/util/format'\n import dayjs from 'dayjs'\n import { postMessageToNative } from 'web/lib/native/post-message'\n import { useEvent } from 'client-common/hooks/use-event'\n+import { ChevronDownIcon, ChevronUpIcon } from '@heroicons/react/solid'\n \n export default function NotificationsPage() {\n   const privateUser = usePrivateUser()\n   const user = useUser()\n@@ -113,8 +114,9 @@\n }) {\n   const { privateUser, user, section } = props\n   const {\n     groupedNotifications,\n+    pinnedNotifications,\n     mostRecentNotification,\n     groupedNewMarketNotifications,\n     groupedMentionNotifications,\n     markAllAsSeen,\n@@ -200,8 +202,9 @@\n               content: (\n                 <NotificationsList\n                   privateUser={privateUser}\n                   groupedNotifications={groupedNotifications}\n+                  pinnedNotifications={pinnedNotifications}\n                   mostRecentNotification={mostRecentNotification}\n                   markAllAsSeen={markAllAsSeen}\n                 />\n               ),\n@@ -316,8 +319,9 @@\n }\n \n export function NotificationsList(props: {\n   groupedNotifications: NotificationGroup[] | undefined\n+  pinnedNotifications?: Notification[]\n   privateUser?: PrivateUser\n   mostRecentNotification?: Notification\n   emptyTitle?: string\n   markAllAsSeen?: () => void\n@@ -327,11 +331,16 @@\n     emptyTitle,\n     groupedNotifications,\n     mostRecentNotification,\n     markAllAsSeen,\n+    pinnedNotifications,\n   } = props\n   const [page, setPage] = useState(0)\n   const user = useUser()\n+  const [pinnedExpanded, setPinnedExpanded] = usePersistentLocalState(\n+    true,\n+    'pinned-notifications-expanded'\n+  )\n \n   const paginatedGroupedNotifications = useMemo(() => {\n     const start = page * NOTIFICATIONS_PER_PAGE\n     const end = start + NOTIFICATIONS_PER_PAGE\n@@ -352,24 +361,56 @@\n     markAllAsSeen,\n   ])\n \n   return (\n-    <Col className={'min-h-[100vh] gap-0 text-sm'}>\n-      {groupedNotifications === undefined ||\n-      paginatedGroupedNotifications === undefined ? (\n-        <LoadingIndicator />\n-      ) : paginatedGroupedNotifications.length === 0 ? (\n-        <div className={'mt-2'}>\n-          {emptyTitle ? emptyTitle : `You don't have any notifications, yet.`}\n-        </div>\n-      ) : (\n-        <RenderNotificationGroups\n-          notificationGroups={paginatedGroupedNotifications}\n-          totalItems={groupedNotifications.length}\n-          page={page}\n-          setPage={setPage}\n-        />\n+    <Col className=\"gap-2\">\n+      {pinnedNotifications && pinnedNotifications.length > 0 && (\n+        <Col className=\"gap-1 rounded-md border-2 border-indigo-500 p-2\">\n+          <Row\n+            className={clsx(\n+              'bg-primary-100',\n+              'cursor-pointer items-center justify-between px-3 py-2'\n+            )}\n+            onClick={() => setPinnedExpanded(!pinnedExpanded)}\n+          >\n+            <span>\n+              {pinnedNotifications.length}{' '}\n+              {maybePluralize('comment', pinnedNotifications.length)} that may\n+              need your attention\n+            </span>\n+            {pinnedExpanded ? (\n+              <ChevronUpIcon className=\"h-5 w-5\" />\n+            ) : (\n+              <ChevronDownIcon className=\"h-5 w-5\" />\n+            )}\n+          </Row>\n+          {pinnedExpanded &&\n+            pinnedNotifications.map((notification) => (\n+              <NotificationItem\n+                key={notification.id}\n+                notification={notification}\n+              />\n+            ))}\n+        </Col>\n       )}\n+\n+      {groupedNotifications === undefined && user && <LoadingIndicator />}\n+      {groupedNotifications &&\n+        groupedNotifications.length === 0 &&\n+        (!pinnedNotifications || pinnedNotifications.length === 0) && (\n+          <div className=\"text-ink-500 mt-4 text-center\">\n+            {emptyTitle ? emptyTitle : `You don't have any notifications yet.`}\n+          </div>\n+        )}\n+      {paginatedGroupedNotifications &&\n+        paginatedGroupedNotifications.length > 0 && (\n+          <RenderNotificationGroups\n+            notificationGroups={paginatedGroupedNotifications}\n+            totalItems={groupedNotifications?.length ?? 0}\n+            page={page}\n+            setPage={setPage}\n+          />\n+        )}\n       {privateUser && groupedNotifications && user && isNative && (\n         <PushNotificationsModal\n           user={user}\n           privateUser={privateUser}\n"
        }
      ]
    },
    {
      "id": "automate-leagues",
      "sha": "14e0625213c12dd277d202c79a5e84f8ae1abb6f",
      "parentSha": "495e67b9a79556cd6480ffd09f574e97b4770eb4",
      "spec": "Implement database-driven, automated league season management and update clients and schedulers accordingly.\n\n1) Create DB table to drive season timing and status\n- Add a new Postgres table leagues_season_end_times with columns: season (int, primary key), end_time (timestamptz), status (text enum constrained to 'active' | 'processing' | 'complete' with default 'active'). Enable row level security.\n- Backfill historical seasons (1..23) as complete with their end_time timestamps. Do not pre-create the next active season row; allow automation to insert it.\n- Location: backend/supabase/leagues_season_end_times.sql\n\n2) Add shared helpers for season state in Supabase\n- In backend/shared/src/supabase/leagues.ts implement:\n  - Types: SeasonStatus = 'active' | 'processing' | 'complete' and SeasonEndTimeInfo { season: number; end_time: number; status: SeasonStatus } (end_time in ms).\n  - getSeasonEndTimeRow(pg, season) -> select season, ts_to_millis(end_time) end_time, status from leagues_season_end_times for the given season; return null if missing.\n  - insertSeasonEndTime(pg, season, endTime: Date) -> insert row with default status 'active'; on conflict do nothing.\n  - updateSeasonStatus(pg, season, status) -> update status.\n  - getEffectiveCurrentSeason() -> return season flagged as active; if none, log error and return latest completed + 1; if table empty, return 1.\n\n3) Add public API endpoint for season info\n- Define API schema entry 'get-season-info' (GET, public, no auth) with optional query prop season (positive integer) and returns { season, startTime: epoch ms, endTime: epoch ms | null, status: 'active' | 'processing' | 'complete' }.\n- Implement backend/api/src/get-season-info.ts handler to:\n  - Use createSupabaseDirectClient.\n  - Resolve season = props.season or await getEffectiveCurrentSeason().\n  - Load seasonInfo via getSeasonEndTimeRow(pg, season). If absent, respond 404.\n  - Compute startTime in ms from LEAGUES_START + (season-1) months.\n  - For status 'active', set endTime to null (hidden/mystery to clients). For other statuses, return end_time from DB.\n- Register the handler in backend/api/src/routes.ts: import './get-season-info' and map 'get-season-info' to getSeasonInfo. Also fix getRelatedMarkets import to './get-related-markets'.\n\n4) Automate league rollover via scheduler\n- Add backend/scheduler/src/jobs/auto-leagues-cycle.ts that:\n  - Ensures an 'active' season row exists. If missing, create one with a randomized end time between the start of the next month (PDT) and the start of the following day; then generateNextSeason(pg, currentSeason) and insertBots(pg, currentSeason).\n  - When now >= end_time and status is 'active', start a single database transaction that:\n    1) updateSeasonStatus(currentSeason, 'processing')\n    2) run updateLeague(currentSeason, tx) and updateLeagueRanks(currentSeason, tx)\n    3) prepare nextSeason = currentSeason + 1; generateNextSeason(tx, nextSeason) and insertBots(tx, nextSeason)\n    4) insertSeasonEndTime(tx, nextSeason, random end time in proper window) to mark it active by default\n    5) run updateLeague(nextSeason, tx) and updateLeagueRanks(nextSeason, tx)\n    6) send end-of-season payouts/notifications for currentSeason using sendEndOfSeasonNotificationsAndBonuses(tx, currentSeason, nextSeason)\n    7) updateSeasonStatus(currentSeason, 'complete')\n  - Use dayjs with timezone (America/Los_Angeles) for end time windows.\n- Register a new job in backend/scheduler/src/jobs/index.ts with createJob('auto-leagues-cycle', '0 */10 * * * *', autoLeaguesCycle) to run every 10 minutes.\n- Ensure existing jobs calling updateLeague and updateLeagueRanks call them via lambdas (() => updateLeague()) and (() => updateLeagueRanks()) without passing season, letting them resolve the current season.\n\n5) Update league update jobs to use DB-driven season window\n- backend/scheduler/src/jobs/update-league.ts:\n  - Accept optional parameters (manualSeason?: number, tx?: SupabaseDirectClient). Default pg to tx or a new client.\n  - Determine season = manualSeason ?? await getEffectiveCurrentSeason(). Load seasonInfo via getSeasonEndTimeRow(pg, season); if not found, log and exit.\n  - Use getSeasonDates(season) to compute start time; use seasonInfo.end_time for the actual end bound.\n  - If Date.now() > seasonEnd, exit early. Adjust logs to use log instead of console.\n  - Keep bets/contracts logic as before, but ensure contracts filter uses coalesce((data->'isRanked')::boolean, true) = true and skip when no betContractIds.\n  - Remove creatorFees from aggregation (commented out) so only trader profit contributes to mana_earned.\n- backend/scheduler/src/jobs/update-league-ranks.ts:\n  - Accept optional (manualSeason?: number, tx?: SupabaseDirectClient). Default to getEffectiveCurrentSeason() and pg = tx ?? create client.\n\n6) Bulkify league change notifications and payouts\n- backend/shared/src/create-notification.ts:\n  - Replace deprecated createLeagueChangedNotification with createLeagueChangedNotifications(pg, data: LeagueChangeNotificationData[]), which:\n    - Bulk fetches private users for provided userIds.\n    - Respects notification preferences through getNotificationDestinationsForUser with reason 'league_changed'.\n    - Builds Notification objects with per-user NanoID, reason 'league_changed', sourceType 'league_change', sourceId id, sourceText = bonusAmount as string, and data: LeagueChangeData.\n    - Performs a bulkInsertNotifications call.\n- backend/shared/src/generate-leagues.ts:\n  - Use getEffectiveCurrentSeason() instead of constants.\n  - Refactor generateCohorts to be a pure function (no pg), returning a userId -> { division, cohort } map. Log useful shapes.\n  - In addToLeagueIfNotInOne and addNewUserToLeague, use getEffectiveCurrentSeason() and call createLeagueChangedNotifications(pg, [ ... ]) with bonusAmount: 0.\n- backend/shared/src/payout-leagues.ts:\n  - Replace per-user runTxnFromBank with a bulk payout flow inside a transaction: compute eligible users (where prize > 0 and no existing LEAGUE_PRIZE txn for prevSeason), aggregate balance increments and TxnData entries, apply bulkIncrementBalances(pg, increments) and insertTxns(pg, txnDatas), then call createLeagueChangedNotifications(pg, notifications). Accept SupabaseTransaction and signature sendEndOfSeasonNotificationsAndBonuses(pg, prevSeason, newSeason).\n\n7) Update common leagues API and consumer code\n- common/src/leagues.ts:\n  - Remove exported constants SEASONS, CURRENT_SEASON, and SEASON_END_TIMES.\n  - Change getSeasonDates(season) to return { start: Date, approxEnd: Date } where approxEnd is LEAGUES_START + season months + 1 day and serves as a display fallback. Add a comment noting that the authoritative end time now lives in leagues_season_end_times.\n  - Export LeagueChangeNotificationData type as LeagueChangeData & { userId: string }.\n  - Update parseLeaguePath(slugs, rowsBySeason, seasons, userId?) to accept an array of available seasons and fallback to the latest if the slug isn't valid.\n\n8) Update client code to depend on server-provided season info\n- web/hooks/use-leagues.ts: Add useAPIGetter('get-season-info', {}) to retrieve the current season and pass season to getLeagueInfo(userId, season). Store league info keyed by user.\n- web/lib/supabase/leagues.ts: Update getLeagueInfo(userId, season) to query user_league_info for that season instead of using a CURRENT_SEASON constant.\n- web/components/leagues/mana-earned-breakdown.tsx: Use getSeasonDates(season).approxEnd for end bound.\n- web/pages/leagues/[[...leagueSlugs]].tsx:\n  - Add getStaticPaths returning { paths: [], fallback: 'blocking' }.\n  - Add getStaticProps to fetch current season info and the requested season info (if present in URL) via api('get-season-info', ...). Inject into page props: { initialSeasonInfo, currentSeasonInfo }.\n  - Build seasons array [1..currentSeasonInfo.season]. Initialize selected season from initialSeasonInfo or fallback.\n  - Replace usage of CURRENT_SEASON/SEASONS and getSeasonStatus; use seasonInfo.status ('active' | 'processing' | 'complete'). For UI, treat closingPeriod when status is 'active' and approxEnd is within 1 day.\n  - Update routing calls to replace(...) without shallow where appropriate. Pass seasons into parseLeaguePath.\n  - Continue to use getSeasonCountdownEnd(season) and getSeasonDates(season).approxEnd for display.\n\n9) API route import fix\n- In backend/api/src/routes.ts change import of getRelatedMarkets to a relative './get-related-markets'.\n\n10) Documentation adjustments\n- README.md: Update architecture wording to reflect the Supabase migration status and that clients primarily read from Supabase. Update common/ directory description to include shared/ usage.\n\n11) Remove stale script\n- Delete backend/scripts/generate-next-season.ts (obsolete once automation is active).\n\nAcceptance criteria\n- leagues_season_end_times exists with RLS enabled; historical seasons present as 'complete'; exactly one 'active' season at runtime once initialized by the scheduler job.\n- GET /api/v0/get-season-info returns season metadata; for active seasons, endTime is null; for completed/processing seasons, endTime is populated.\n- Scheduler job auto-leagues-cycle runs every 10 minutes, initializes missing active season rows, and transitions seasons atomically when end_time passes; logs progress.\n- updateLeague and updateLeagueRanks operate on the effective current season and stop after season end_time has passed.\n- End-of-season payouts and notifications are delivered in bulk only once per user; notifications are created via createLeagueChangedNotifications.\n- Web leagues page renders using season info from the API and no longer uses CURRENT_SEASON/SEASONS or getSeasonStatus.\n- All references to CURRENT_SEASON/SEASONS removed from edited areas; parseLeaguePath updated to accept seasons array.\n- No regressions in other league pages/components; tests/build pass.",
      "prompt": "Implement database-driven, automated league seasons. Replace hardcoded season constants and client-side season status with a server-managed season table and a public API. Add a scheduler job that maintains the active season, triggers rollover when the end time passes, and performs end-of-season updates, payouts, and notifications atomically. Update the leagues page and hooks to fetch season info from the API, and adjust backend jobs to compute league stats using the DB season window. Ensure end-of-season prizes and notifications are processed in bulk and idempotently. Include a SQL script to create/backfill the season table and minor documentation updates.",
      "supplementalFiles": [
        "backend/scheduler/src/jobs/helpers.ts",
        "backend/scheduler/src/index.ts",
        "backend/api/helpers/endpoint.ts",
        "common/src/api/utils.ts",
        "common/src/notification.ts",
        "common/src/supabase/utils.ts",
        "backend/shared/src/supabase/init.ts",
        "backend/shared/src/utils.ts",
        "backend/shared/src/supabase/users.ts",
        "backend/shared/src/txn/run-txn.ts",
        "backend/shared/src/resolve-market-helpers.ts",
        "web/lib/api/api.ts",
        "web/hooks/use-api-getter.ts",
        "web/lib/supabase/db.ts",
        "web/components/notifications/income-summary-notifications.tsx",
        "common/src/supabase/leagues.ts",
        "backend/api/src/get-related-markets.ts"
      ],
      "fileDiffs": [
        {
          "path": "README.md",
          "status": "modified",
          "diff": "Index: README.md\n===================================================================\n--- README.md\t495e67b (parent)\n+++ README.md\t14e0625 (commit)\n@@ -13,21 +13,19 @@\n See [`web/README.md`][web-readme] for more details on hacking on the web client.\n \n ## General architecture\n \n-Manifold's public API and web app are hosted by [Vercel][vercel]. Our data has been stored in Firebase's database [Cloud Firestore][cloud-firestore] but we are currently migrating it to SQL hosted on [Supabase][supabase].\n+Manifold's public API and web app are hosted by [Vercel][vercel]. Our data has been stored in Firebase's database [Cloud Firestore][cloud-firestore] but we have almost enitrely migrated it to SQL hosted on [Supabase][supabase].\n \n-We often use firebase and supabase directly on the client to get the data. However, for complicated operations (like buying shares) we have a separate internal HTTP API deployed in a docker container in google cloud. This is seperate from the public-facing api hosted via Vercel; see [`functions/README.md`][functions-readme] for more details.\n+We often use supabase directly on the client to get the data. However, for complicated operations (like buying shares) we have a separate internal HTTP API deployed in a docker container in google cloud. This is seperate from the public-facing api hosted via Vercel; see [`functions/README.md`][functions-readme] for more details.\n \n ## Directory overview\n \n - [web/](./web/): UI and business logic for the client. Where most of the site lives. The public API endpoints are also in here.\n \n - [backend/](./backend/): All the rest of the stuff we run on GCP.\n \n-- [common/](./common/): Typescript library code shared between `web/` & `backend/`. If you want to look at how the market math\n-  works, most of that's in here (it gets called from the `bet` and `sellBet` endpoints in `functions/`.) Also\n-  contains in `common/envs` configuration for the different environments (i.e. prod, dev, Manifold for Teams instances.)\n+- [common/](./common/): Typescript library code shared between `web/` & `backend/` & `shared/`. If you want to look at how the market math works, most of that's in here (it gets called from the `bet` and `sellBet` endpoints in `functions/`.) Also contains in `common/envs` configuration for the different environments (i.e. prod, dev, Manifold for Teams instances.)\n \n - [docs/](./docs/): Manifold's public documentation that lives at https://docs.manifold.markets.\n \n ## Contributing\n"
        },
        {
          "path": "backend/api/src/get-season-info.ts",
          "status": "added",
          "diff": "Index: backend/api/src/get-season-info.ts\n===================================================================\n--- backend/api/src/get-season-info.ts\t495e67b (parent)\n+++ backend/api/src/get-season-info.ts\t14e0625 (commit)\n@@ -0,0 +1,34 @@\n+import { APIError, APIHandler } from 'api/helpers/endpoint'\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import {\n+  getSeasonEndTimeRow,\n+  getEffectiveCurrentSeason,\n+} from 'shared/supabase/leagues'\n+import { LEAGUES_START } from 'common/leagues'\n+\n+export const getSeasonInfo: APIHandler<'get-season-info'> = async (props) => {\n+  const pg = createSupabaseDirectClient()\n+  const season = props.season ?? (await getEffectiveCurrentSeason())\n+\n+  const seasonInfo = await getSeasonEndTimeRow(pg, season)\n+  if (!seasonInfo) {\n+    throw new APIError(404, 'Season info not found')\n+  }\n+\n+  const startTime = new Date(LEAGUES_START)\n+  startTime.setMonth(startTime.getMonth() + season - 1)\n+  const startTimeMs = startTime.getTime()\n+  const { status, end_time } = seasonInfo // Use status directly from DB\n+  let endTime: number | null = null\n+  // end time is a mystery if status is active\n+  if (status !== 'active') {\n+    endTime = end_time\n+  }\n+\n+  return {\n+    season,\n+    startTime: startTimeMs,\n+    endTime,\n+    status,\n+  }\n+}\n"
        },
        {
          "path": "backend/api/src/league-activity.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/league-activity.ts\n===================================================================\n--- backend/api/src/league-activity.ts\t495e67b (parent)\n+++ backend/api/src/league-activity.ts\t14e0625 (commit)\n@@ -38,9 +38,9 @@\n     [season, cohort],\n     (row: { user_id: string }) => row.user_id\n   )\n \n-  const { start, end } = getSeasonDates(season)\n+  const { start, approxEnd: end } = getSeasonDates(season)\n \n   const bets = await pg.map<Bet>(\n     `select\n       cb.data\n"
        },
        {
          "path": "backend/api/src/routes.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/routes.ts\n===================================================================\n--- backend/api/src/routes.ts\t495e67b (parent)\n+++ backend/api/src/routes.ts\t14e0625 (commit)\n@@ -116,9 +116,9 @@\n import { getNotifications } from 'api/get-notifications'\n import { getCheckoutSession } from 'api/gidx/get-checkout-session'\n import { completeCheckoutSession } from 'api/gidx/complete-checkout-session'\n import { getContractTopics } from './get-contract-topics'\n-import { getRelatedMarkets } from 'api/get-related-markets'\n+import { getRelatedMarkets } from './get-related-markets'\n import { getRelatedMarketsByGroup } from './get-related-markets-by-group'\n import { followContract } from './follow-contract'\n import { getUserLimitOrdersWithContracts } from 'api/get-user-limit-orders-with-contracts'\n import { getInterestingGroupsFromViews } from 'api/get-interesting-groups-from-views'\n@@ -174,9 +174,14 @@\n import { inferNumericUnit } from './infer-numeric-unit'\n import { generateConciseTitle } from './generate-concise-title'\n import { getCloseDateEndpoint } from './get-close-date'\n import { referUser } from './refer-user'\n-import { saveMarketDraft, getMarketDrafts, deleteMarketDraft } from './market-drafts'\n+import {\n+  saveMarketDraft,\n+  getMarketDrafts,\n+  deleteMarketDraft,\n+} from './market-drafts'\n+import { getSeasonInfo } from './get-season-info'\n \n export const handlers: { [k in APIPath]: APIHandler<k> } = {\n   'refresh-all-clients': refreshAllClients,\n   bet: placeBet,\n@@ -366,5 +371,6 @@\n   'refer-user': referUser,\n   'save-market-draft': saveMarketDraft,\n   'get-market-drafts': getMarketDrafts,\n   'delete-market-draft': deleteMarketDraft,\n+  'get-season-info': getSeasonInfo,\n }\n"
        },
        {
          "path": "backend/scheduler/src/jobs/auto-leagues-cycle.ts",
          "status": "added",
          "diff": "Index: backend/scheduler/src/jobs/auto-leagues-cycle.ts\n===================================================================\n--- backend/scheduler/src/jobs/auto-leagues-cycle.ts\t495e67b (parent)\n+++ backend/scheduler/src/jobs/auto-leagues-cycle.ts\t14e0625 (commit)\n@@ -0,0 +1,196 @@\n+import { SupabaseDirectClient } from 'shared/supabase/init'\n+import {\n+  SeasonEndTimeInfo,\n+  SeasonStatus,\n+  getSeasonEndTimeRow,\n+  insertSeasonEndTime,\n+  updateSeasonStatus,\n+  getEffectiveCurrentSeason,\n+} from 'shared/supabase/leagues'\n+import { LEAGUES_START } from 'common/leagues'\n+import { generateNextSeason, insertBots } from 'shared/generate-leagues'\n+import { sendEndOfSeasonNotificationsAndBonuses } from 'shared/payout-leagues'\n+import { updateLeague } from './update-league'\n+import { updateLeagueRanks } from './update-league-ranks'\n+import { log } from 'shared/utils'\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { HOUR_MS } from 'common/util/time'\n+import * as dayjs from 'dayjs'\n+import * as utc from 'dayjs/plugin/utc'\n+import * as timezone from 'dayjs/plugin/timezone'\n+dayjs.extend(utc)\n+dayjs.extend(timezone)\n+\n+// How many days into the next month the season *could* end (randomly chosen).\n+const PACIFIC_TIMEZONE = 'America/Los_Angeles'\n+\n+export async function autoLeaguesCycle() {\n+  const pg = createSupabaseDirectClient()\n+  const currentSeason = await getEffectiveCurrentSeason()\n+\n+  log(`Running autoLeaguesCycle for active season: ${currentSeason}`)\n+\n+  let seasonInfo = await getSeasonEndTimeRow(pg, currentSeason)\n+  const now = Date.now()\n+\n+  // Initialization: Ensure the active season has an end time row.\n+  if (!seasonInfo) {\n+    log(`No row found for active season ${currentSeason}. Creating one.`)\n+    const randomEndTime = calculateRandomEndTime(currentSeason, now)\n+    await insertSeasonEndTime(pg, currentSeason, randomEndTime) // Inserts with status 'active'\n+    await generateNextSeason(pg, currentSeason)\n+    await insertBots(pg, currentSeason)\n+    seasonInfo = await getSeasonEndTimeRow(pg, currentSeason) // Re-fetch\n+    if (!seasonInfo) {\n+      log.error(\n+        `Failed to create and fetch row for season ${currentSeason}! Aborting.`\n+      )\n+      return\n+    }\n+    log(\n+      `Created row for season ${currentSeason} with end time ${dayjs(\n+        seasonInfo.end_time\n+      )\n+        .tz(PACIFIC_TIMEZONE)\n+        .toISOString()}`\n+    )\n+  }\n+\n+  log(\n+    `Found season info for ${currentSeason}: end_time=${dayjs(\n+      seasonInfo.end_time\n+    )\n+      .tz(PACIFIC_TIMEZONE)\n+      .toISOString()}, status=${seasonInfo.status}`\n+  )\n+\n+  // Check if the season end time has passed and it is currently active.\n+  if (now >= seasonInfo.end_time && seasonInfo.status === 'active') {\n+    log(`Season ${currentSeason} end time has passed. Processing rollover...`)\n+    let nextSeason: number | undefined // Declare outside to use in success log\n+    // Wrap the sequence in a transaction\n+    await pg.tx(async (tx) => {\n+      // 1. Mark current season as processing\n+      log(\n+        `Updating season ${currentSeason} status to 'processing' within transaction.`,\n+        { season: currentSeason }\n+      )\n+      await updateSeasonStatus(tx, currentSeason, 'processing')\n+\n+      // 2. Run final league updates for the season\n+      log(\n+        `Running updateLeague for season ${currentSeason} within transaction...`,\n+        { season: currentSeason }\n+      )\n+      await updateLeague(currentSeason, tx)\n+      log(\n+        `Running updateLeagueRanks for season ${currentSeason} within transaction...`,\n+        { season: currentSeason }\n+      )\n+      await updateLeagueRanks(currentSeason, tx)\n+\n+      // 3. Generate the *next* season's structure\n+      nextSeason = currentSeason + 1 // Assign here\n+      log(\n+        `Generating leagues for next season ${nextSeason} within transaction...`,\n+        { nextSeason }\n+      )\n+      await generateNextSeason(tx, nextSeason)\n+      await insertBots(tx, nextSeason)\n+\n+      // 4. Create the row for the *next* season and set its status to active\n+      log(\n+        `Creating row for next season ${nextSeason} with status 'active' within transaction.`,\n+        { nextSeason }\n+      )\n+      const nextSeasonEndTime = calculateRandomEndTime(nextSeason, now)\n+      await insertSeasonEndTime(tx, nextSeason, nextSeasonEndTime)\n+\n+      // 5. Run first league updates for the *next* season\n+      log(\n+        `Running updateLeague for season ${nextSeason} within transaction...`,\n+        { season: nextSeason }\n+      )\n+      await updateLeague(nextSeason, tx)\n+\n+      log(\n+        `Running updateLeagueRanks for season ${nextSeason} within transaction...`,\n+        { season: nextSeason }\n+      )\n+      await updateLeagueRanks(nextSeason, tx)\n+\n+      // 6. Send notifications and bonuses for the *completed* season\n+      log(\n+        `Sending end-of-season payouts/notifications for ${currentSeason} within transaction...`,\n+        { season: currentSeason }\n+      )\n+      await sendEndOfSeasonNotificationsAndBonuses(\n+        tx,\n+        currentSeason,\n+        nextSeason\n+      )\n+\n+      // 7. Mark the current season as complete\n+      log(\n+        `Updating season ${currentSeason} status to 'complete' within transaction.`,\n+        { season: currentSeason }\n+      )\n+      await updateSeasonStatus(tx, currentSeason, 'complete')\n+    })\n+\n+    // If the transaction succeeded:\n+    log(\n+      `Season ${currentSeason} rollover transaction complete. Season ${\n+        nextSeason ?? '(unknown)'\n+      } is now active.`\n+    )\n+  } else if (seasonInfo.status === 'processing') {\n+    log(`Season ${currentSeason} is already processing. Skipping.`)\n+  } else if (seasonInfo.status === 'complete') {\n+    log(\n+      `Season ${currentSeason} has already been completed. Waiting for next active season.`\n+    )\n+    // If getEffectiveCurrentSeason returns this one, there's an issue there or in state management.\n+    log.warn(\n+      `getEffectiveCurrentSeason returned ${currentSeason}, but its status is 'complete'. Check logic.`\n+    )\n+  } else {\n+    log(`Season ${currentSeason} end time has not yet passed.`)\n+  }\n+}\n+\n+// Helper to calculate a random end time for a *given* season\n+const calculateRandomEndTime = (season: number, now: number): Date => {\n+  // Calculate the start date of the given season\n+  const seasonStartDate = dayjs(LEAGUES_START)\n+    .tz(PACIFIC_TIMEZONE)\n+    .add(season - 1, 'month')\n+\n+  // Calculate the start of the month *after* the season month\n+  const minEndTime = seasonStartDate\n+    .add(1, 'month')\n+    .startOf('month')\n+    .tz(PACIFIC_TIMEZONE) // Keep PT\n+\n+  // Calculate the latest possible end time (start of the day after the offset)\n+  const latestEndTime = minEndTime\n+    .add(1, 'day')\n+    .startOf('day')\n+    .tz(PACIFIC_TIMEZONE) // Keep PT\n+\n+  // If the calculated latest end time is somehow *before* the minimum required time,\n+  if (latestEndTime.isBefore(minEndTime)) {\n+    log.warn(\n+      `Calculated latest end time ${latestEndTime.toISOString()} is before minimum end time ${minEndTime.toISOString()} for season ${season}. Using minimum time.`\n+    )\n+    return minEndTime.toDate()\n+  }\n+\n+  // Generate a random timestamp between min and max end times\n+  const randomEndTimeMillis =\n+    minEndTime.valueOf() +\n+    Math.random() * (latestEndTime.valueOf() - minEndTime.valueOf())\n+\n+  // Return as a JS Date object\n+  return dayjs(randomEndTimeMillis).tz(PACIFIC_TIMEZONE).toDate()\n+}\n"
        },
        {
          "path": "backend/scheduler/src/jobs/index.ts",
          "status": "modified",
          "diff": "Index: backend/scheduler/src/jobs/index.ts\n===================================================================\n--- backend/scheduler/src/jobs/index.ts\t495e67b (parent)\n+++ backend/scheduler/src/jobs/index.ts\t14e0625 (commit)\n@@ -36,11 +36,17 @@\n import { updateUserPortfolioHistoriesCore } from 'shared/update-user-portfolio-histories-core'\n import { isProd } from 'shared/utils'\n import { sendMarketMovementNotifications } from 'shared/send-market-movement-notifications'\n import { sendUnseenMarketMovementNotifications } from 'shared/send-unseen-notifications'\n+import { autoLeaguesCycle } from './auto-leagues-cycle'\n \n export function createJobs() {\n   return [\n+    createJob(\n+      'auto-leagues-cycle',\n+      '0 */10 * * * *', // every 10 minutes\n+      autoLeaguesCycle\n+    ),\n     // Hourly jobs:\n     createJob(\n       'send-market-close-emails',\n       '0 0 * * * *', // every hour\n@@ -63,9 +69,9 @@\n     ),\n     createJob(\n       'update-league',\n       '0 */15 * * * *', // every 15 minutes\n-      updateLeague\n+      () => updateLeague()\n     ),\n     createJob(\n       'check-push-receipts',\n       '0 15 * * * *', // on the 15th minute of every hour\n@@ -181,9 +187,9 @@\n     ),\n     createJob(\n       'update-league-ranks',\n       '0 0 0 * * *', // every day at midnight\n-      updateLeagueRanks\n+      () => updateLeagueRanks()\n     ),\n     createJob(\n       'reset-betting-streaks',\n       '0 0 0 * * *', // every day at midnight\n"
        },
        {
          "path": "backend/scheduler/src/jobs/update-league-ranks.ts",
          "status": "modified",
          "diff": "Index: backend/scheduler/src/jobs/update-league-ranks.ts\n===================================================================\n--- backend/scheduler/src/jobs/update-league-ranks.ts\t495e67b (parent)\n+++ backend/scheduler/src/jobs/update-league-ranks.ts\t14e0625 (commit)\n@@ -1,13 +1,19 @@\n import { log, revalidateStaticProps } from 'shared/utils'\n-import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import {\n+  SupabaseDirectClient,\n+  createSupabaseDirectClient,\n+} from 'shared/supabase/init'\n import { bulkUpdate } from 'shared/supabase/utils'\n-import { SEASONS } from 'common/leagues'\n+import { getEffectiveCurrentSeason } from 'shared/supabase/leagues'\n \n-export async function updateLeagueRanks() {\n-  const pg = createSupabaseDirectClient()\n+export async function updateLeagueRanks(\n+  manualSeason?: number,\n+  tx?: SupabaseDirectClient\n+) {\n+  const pg = tx ?? createSupabaseDirectClient()\n \n-  const season = SEASONS[SEASONS.length - 1]\n+  const season = manualSeason ?? (await getEffectiveCurrentSeason())\n \n   log('Loading user ranks...')\n   const userIds = await pg.manyOrNone<{ id: string; rank: number }>(\n     `select id, rank from users\n"
        },
        {
          "path": "backend/scheduler/src/jobs/update-league.ts",
          "status": "modified",
          "diff": "Index: backend/scheduler/src/jobs/update-league.ts\n===================================================================\n--- backend/scheduler/src/jobs/update-league.ts\t495e67b (parent)\n+++ backend/scheduler/src/jobs/update-league.ts\t14e0625 (commit)\n@@ -5,19 +5,32 @@\n   SupabaseDirectClient,\n   createSupabaseDirectClient,\n } from 'shared/supabase/init'\n import { bulkUpdate } from 'shared/supabase/utils'\n-import { CURRENT_SEASON, getSeasonDates } from 'common/leagues'\n+import { getSeasonDates } from 'common/leagues'\n import { getProfitMetrics } from 'common/calculate'\n import { convertContract } from 'common/supabase/contracts'\n+import {\n+  getEffectiveCurrentSeason,\n+  getSeasonEndTimeRow,\n+} from 'shared/supabase/leagues'\n \n-export async function updateLeague() {\n-  const pg = createSupabaseDirectClient()\n+export async function updateLeague(\n+  manualSeason?: number,\n+  tx?: SupabaseDirectClient\n+) {\n+  const pg = tx ?? createSupabaseDirectClient()\n \n-  const season = CURRENT_SEASON\n-  const { start, end } = getSeasonDates(season)\n+  const season = manualSeason ?? (await getEffectiveCurrentSeason())\n+  let seasonInfo = await getSeasonEndTimeRow(pg, season)\n+  if (!seasonInfo) {\n+    log('Season info not found. Exiting.')\n+    return\n+  }\n+  const { start } = getSeasonDates(season)\n+  log(`Season start: ${start}`)\n   const seasonStart = start.getTime()\n-  const seasonEnd = end.getTime()\n+  const seasonEnd = seasonInfo.end_time\n \n   if (Date.now() > seasonEnd) {\n     log('Season has ended. Exiting.')\n     return\n@@ -31,29 +44,28 @@\n     [season],\n     (r) => r.id as string\n   )\n   log(`Loaded ${userIds.length} user ids.`)\n-  // Earned fees from bets in your markets during the season.\n-  const creatorFees = await pg.manyOrNone<{\n-    user_id: string\n-    category: string\n-    amount: number\n-  }>(\n-    `select\n-      contracts.creator_id as user_id,\n-      'CREATOR_FEE' as category,\n-      sum((cb.data->'fees'->>'creatorFee')::numeric) as amount\n-    from contract_bets cb\n-    join contracts on contracts.id = cb.contract_id\n-    where\n-      cb.created_time > millis_to_ts($2)\n-      and cb.created_time < millis_to_ts($3)\n-    group by contracts.creator_id\n-    `,\n-    [season, seasonStart, seasonEnd]\n-  )\n \n-  console.log('creator fees', creatorFees.length)\n+  // // Earned fees from bets in your markets during the season.\n+  // const creatorFees = await pg.manyOrNone<{\n+  //   user_id: string\n+  //   category: string\n+  //   amount: number\n+  // }>(\n+  //   `select\n+  //     contracts.creator_id as user_id,\n+  //     'CREATOR_FEE' as category,\n+  //     sum((cb.data->'fees'->>'creatorFee')::numeric) as amount\n+  //   from contract_bets cb\n+  //   join contracts on contracts.id = cb.contract_id\n+  //   where\n+  //     cb.created_time > millis_to_ts($2)\n+  //     and cb.created_time < millis_to_ts($3)\n+  //   group by contracts.creator_id\n+  //   `,\n+  //   [season, seasonStart, seasonEnd]\n+  // )\n \n   log('Loading bets...')\n   const betData = await pg.manyOrNone<{ data: Bet }>(\n     `select cb.data\n@@ -93,14 +105,10 @@\n         !EXCLUDED_CONTRACT_SLUGS.has(contract.slug)\n       ) {\n         const { profit } = getProfitMetrics(contract, contractBets)\n         if (isNaN(profit)) {\n-          console.error(\n-            'Profit is NaN! contract',\n-            contract.slug,\n-            contract.id,\n-            'userId',\n-            userId\n+          log.error(\n+            `Profit is NaN! contract ${contract.slug} (${contract.id}) userId ${userId}`\n           )\n           continue\n         }\n \n@@ -114,9 +122,9 @@\n     })\n   }\n \n   const amountByUserId = groupBy(\n-    [...userProfit, ...creatorFees].map((u) => ({\n+    userProfit.map((u) => ({\n       ...u,\n       amount: +u.amount,\n     })),\n     'user_id'\n@@ -135,22 +143,23 @@\n       mana_earned_breakdown: `${JSON.stringify(manaEarnedBreakdown)}::jsonb`,\n     })\n   }\n \n-  console.log('Mana earned updates', manaEarnedUpdates.length)\n+  log(`Mana earned updates: ${manaEarnedUpdates.length}`)\n \n   await bulkUpdate(pg, 'leagues', ['user_id', 'season'], manaEarnedUpdates)\n   log('Done.')\n }\n \n const getRelevantContracts = async (pg: SupabaseDirectClient, bets: Bet[]) => {\n   const betContractIds = uniq(bets.map((b) => b.contractId))\n+  if (betContractIds.length === 0) return []\n   return await pg.map(\n     `select * from contracts\n     where id in ($1:list)\n     and token = 'MANA'\n     and visibility = 'public'\n-    and (data->'isRanked')::boolean is not false`,\n+    and coalesce((data->'isRanked')::boolean, true) = true`,\n     [betContractIds],\n     convertContract\n   )\n }\n"
        },
        {
          "path": "backend/scripts/generate-next-season.ts",
          "status": "deleted",
          "diff": "Index: backend/scripts/generate-next-season.ts\n===================================================================\n--- backend/scripts/generate-next-season.ts\t495e67b (parent)\n+++ backend/scripts/generate-next-season.ts\t14e0625 (commit)\n@@ -1,17 +0,0 @@\n-import { CURRENT_SEASON } from 'common/leagues'\n-import { runScript } from 'run-script'\n-import { generateNextSeason, insertBots } from 'shared/generate-leagues'\n-\n-if (require.main === module) {\n-  runScript(async ({ pg }) => {\n-    const newSeason = 24\n-    if ((newSeason as any) <= CURRENT_SEASON) {\n-      console.log('Are you sure you want to generate the current season?')\n-      return\n-    }\n-\n-    await generateNextSeason(pg, newSeason)\n-    await insertBots(pg, newSeason)\n-    console.log('Completed generateNextSeason.')\n-  })\n-}\n"
        },
        {
          "path": "backend/shared/src/create-notification.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/create-notification.ts\n===================================================================\n--- backend/shared/src/create-notification.ts\t495e67b (parent)\n+++ backend/shared/src/create-notification.ts\t14e0625 (commit)\n@@ -73,9 +73,9 @@\n   getUniqueBettorIdsForAnswer,\n   getUniqueVoterIds,\n } from 'shared/supabase/contracts'\n import { richTextToString } from 'common/util/parse'\n-import { league_user_info } from 'common/leagues'\n+import { LeagueChangeNotificationData } from 'common/leagues'\n import { hasUserSeenMarket } from 'shared/helpers/seen-markets'\n import { isAdminId, isModId } from 'common/envs/constants'\n import {\n   bulkInsertNotifications,\n@@ -898,46 +898,74 @@\n   await createPushNotifications(bulkPushNotifications)\n   await bulkInsertNotifications(bulkNotifications, pg)\n }\n \n-/** @deprecated until bulkified **/\n-export const createLeagueChangedNotification = async (\n-  userId: string,\n-  previousLeague: league_user_info | undefined,\n-  newLeague: { season: number; division: number; cohort: string },\n-  bonusAmount: number,\n-  pg: SupabaseDirectClient\n+export const createLeagueChangedNotifications = async (\n+  pg: SupabaseDirectClient,\n+  data: LeagueChangeNotificationData[]\n ) => {\n-  const privateUser = await getPrivateUser(userId)\n-  if (!privateUser) return\n-  const { sendToBrowser } = getNotificationDestinationsForUser(\n-    privateUser,\n-    'league_changed'\n+  if (data.length === 0) return\n+\n+  log(`Creating ${data.length} league change notifications.`)\n+\n+  const userIds = data.map((d) => d.userId)\n+\n+  // Fetch all relevant private users in bulk\n+  const privateUsers = await pg.map(\n+    `select * from private_users where id = any($1)`,\n+    [userIds],\n+    convertPrivateUser\n   )\n-  if (!sendToBrowser) return\n+  const privateUserMap = new Map(privateUsers.map((user) => [user.id, user]))\n \n-  const id = nanoid(6)\n-  const data: LeagueChangeData = {\n-    previousLeague,\n-    newLeague,\n-    bonusAmount,\n+  const bulkNotifications: Notification[] = []\n+\n+  for (const item of data) {\n+    const privateUser = privateUserMap.get(item.userId)\n+    if (!privateUser) {\n+      log(`Could not find private user ${item.userId}`)\n+      continue\n+    }\n+\n+    // Check notification preferences\n+    const { sendToBrowser } = getNotificationDestinationsForUser(\n+      privateUser,\n+      'league_changed'\n+    )\n+    if (!sendToBrowser) continue\n+\n+    // Construct notification data\n+    const id = nanoid(6) // Still need a unique ID per notification\n+    const notificationData: LeagueChangeData = {\n+      previousLeague: item.previousLeague,\n+      newLeague: item.newLeague,\n+      bonusAmount: item.bonusAmount,\n+    }\n+\n+    const notification: Notification = {\n+      id,\n+      userId: item.userId,\n+      reason: 'league_changed',\n+      createdTime: Date.now(),\n+      isSeen: false,\n+      sourceId: id, // Use the generated id as sourceId for uniqueness? Or maybe season identifier? Let's use id for now.\n+      sourceText: item.bonusAmount.toString(),\n+      sourceType: 'league_change',\n+      sourceUpdateType: 'created',\n+      sourceUserName: '', // Not relevant for this type\n+      sourceUserUsername: '', // Not relevant for this type\n+      sourceUserAvatarUrl: '', // Not relevant for this type\n+      data: notificationData,\n+    }\n+    bulkNotifications.push(notification)\n   }\n-  const notification: Notification = {\n-    id,\n-    userId,\n-    reason: 'league_changed',\n-    createdTime: Date.now(),\n-    isSeen: false,\n-    sourceId: id,\n-    sourceText: bonusAmount.toString(),\n-    sourceType: 'league_change',\n-    sourceUpdateType: 'created',\n-    sourceUserName: '',\n-    sourceUserUsername: '',\n-    sourceUserAvatarUrl: '',\n-    data,\n+\n+  if (bulkNotifications.length > 0) {\n+    await bulkInsertNotifications(bulkNotifications, pg)\n+    log(`Inserted ${bulkNotifications.length} league change notifications.`)\n+  } else {\n+    log('No league change notifications met filter criteria.')\n   }\n-  await insertNotificationToSupabase(notification, pg)\n }\n \n export const createLikeNotification = async (reaction: Reaction) => {\n   const { reaction_id, content_owner_id, user_id, content_id, content_type } =\n"
        },
        {
          "path": "backend/shared/src/generate-leagues.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/generate-leagues.ts\n===================================================================\n--- backend/shared/src/generate-leagues.ts\t495e67b (parent)\n+++ backend/shared/src/generate-leagues.ts\t14e0625 (commit)\n@@ -2,28 +2,28 @@\n import { pgp, SupabaseDirectClient } from './supabase/init'\n import { genNewAdjectiveAnimal } from 'common/util/adjective-animal'\n import { BOT_USERNAMES, OPTED_OUT_OF_LEAGUES } from 'common/envs/constants'\n import {\n-  CURRENT_SEASON,\n   getCohortSize,\n   getDivisionChange,\n   getSeasonDates,\n   league_user_info,\n   MAX_COHORT_SIZE,\n-  SEASONS,\n } from 'common/leagues'\n import { getCurrentPortfolio } from './helpers/portfolio'\n-import { createLeagueChangedNotification } from 'shared/create-notification'\n+import { createLeagueChangedNotifications } from 'shared/create-notification'\n import { bulkInsert } from './supabase/utils'\n import { log } from './utils'\n+import { getEffectiveCurrentSeason } from './supabase/leagues'\n \n export async function generateNextSeason(\n   pg: SupabaseDirectClient,\n   season: number\n ) {\n-  console.log('Generating season', season)\n+  log(`Generating season ${season}`)\n   const prevSeason = season - 1\n   const startDate = getSeasonDates(prevSeason).start\n+  // const startDate = new Date('2025-01-01')\n   const rows = await pg.manyOrNone<league_user_info>(\n     `select * from user_league_info\n     where season = $1\n     order by mana_earned desc`,\n@@ -46,12 +46,12 @@\n   )\n   const activeUserIdsSet = new Set(activeUserIds.map((u) => u.user_id))\n \n   const usersByDivision = generateDivisions(rows, activeUserIdsSet)\n-  console.log('usersByDivision', usersByDivision)\n+  log(`usersByDivision`, { usersByDivision })\n \n-  const userCohorts = await generateCohorts(pg, usersByDivision)\n-  console.log('user cohorts', userCohorts)\n+  const userCohorts = generateCohorts(usersByDivision)\n+  log(`user cohorts`, { userCohorts })\n \n   const leagueInserts = Object.entries(userCohorts).map(\n     ([userId, { division, cohort }]) => ({\n       user_id: userId,\n@@ -59,10 +59,11 @@\n       division,\n       cohort,\n     })\n   )\n-  console.log('league inserts', leagueInserts)\n-  console.log('Inserting', leagueInserts.length, 'cohort rows')\n+  log(`league inserts`, { leagueInserts })\n+  log(`Inserting ${leagueInserts.length} cohort rows`)\n+  if (leagueInserts.length === 0) return\n \n   // Bulk insert leagues.\n   const insertStatement =\n     pgp.helpers.insert(\n@@ -83,9 +84,9 @@\n   const usersByNewDivision: Record<number, string[]> = {}\n \n   const rowsByCohort = groupBy(rows, 'cohort')\n   const activeRows = rows.filter((r) => activeUserIds.has(r.user_id))\n-  console.log('rows', rows.length, 'active rows', activeRows.length)\n+  log(`rows: ${rows.length}, active rows: ${activeRows.length}`)\n \n   for (const row of activeRows) {\n     const { user_id, division, cohort, rank, mana_earned } = row\n \n@@ -107,12 +108,9 @@\n \n   return usersByNewDivision\n }\n \n-const generateCohorts = async (\n-  pg: SupabaseDirectClient,\n-  usersByDivision: { [division: number]: string[] }\n-) => {\n+const generateCohorts = (usersByDivision: { [division: number]: string[] }) => {\n   const userCohorts: {\n     [userId: string]: { division: number; cohort: string }\n   } = {}\n   const cohortSet = new Set<string>()\n@@ -124,17 +122,10 @@\n     const numCohorts = Math.ceil(divisionUserIds.length / cohortSize)\n     const usersPerCohort = Math.ceil(divisionUserIds.length / numCohorts)\n     const cohortsWithOneLess =\n       usersPerCohort * numCohorts - divisionUserIds.length\n-    console.log(\n-      'division users',\n-      divisionUserIds.length,\n-      'numCohorts',\n-      numCohorts,\n-      'usersPerCohort',\n-      usersPerCohort,\n-      'cohortsWithOneLess',\n-      cohortsWithOneLess\n+    log(\n+      `division users: ${divisionUserIds.length}, numCohorts: ${numCohorts}, usersPerCohort: ${usersPerCohort}, cohortsWithOneLess: ${cohortsWithOneLess}`\n     )\n \n     let remainingUserIds = shuffle(divisionUserIds.concat())\n     let i = 0\n@@ -150,9 +141,9 @@\n         userCohorts[userId] = { division, cohort }\n       }\n       remainingUserIds = remainingUserIds.filter((uid) => !userCohorts[uid])\n       i++\n-      console.log('cohort', cohort, cohortOfUsers.length)\n+      log(`cohort: ${cohort}, cohortOfUsers: ${cohortOfUsers.length}`)\n     }\n   }\n \n   return userCohorts\n@@ -298,11 +289,11 @@\n   if (OPTED_OUT_OF_LEAGUES.includes(userId)) {\n     log('User opted out of leagues', userId)\n     return\n   }\n+  log('Adding user to league', userId)\n+  const season = await getEffectiveCurrentSeason()\n \n-  const season = SEASONS[SEASONS.length - 1]\n-\n   const existingLeague = await pg.oneOrNone<{\n     season: number\n     division: number\n     cohort: string\n@@ -319,29 +310,32 @@\n   const data = await addUserToLeague(pg, userId, season, division)\n   if (!data) return\n   const cohort = data.cohort\n \n-  await createLeagueChangedNotification(\n-    userId,\n-    undefined,\n-    { season, division, cohort },\n-    0,\n-    pg\n-  )\n+  await createLeagueChangedNotifications(pg, [\n+    {\n+      userId,\n+      previousLeague: undefined,\n+      newLeague: { season, division, cohort },\n+      bonusAmount: 0,\n+    },\n+  ])\n   return { season, division, cohort }\n }\n \n export const addNewUserToLeague = async (\n   pg: SupabaseDirectClient,\n   userId: string\n ) => {\n-  const data = await addUserToLeague(pg, userId, CURRENT_SEASON, 1)\n+  const season = await getEffectiveCurrentSeason()\n+  const data = await addUserToLeague(pg, userId, season, 1)\n   if (!data) return\n-  const { season, division, cohort } = data\n-  await createLeagueChangedNotification(\n-    userId,\n-    undefined,\n-    { season, division, cohort },\n-    0,\n-    pg\n-  )\n+  const { division, cohort } = data\n+  await createLeagueChangedNotifications(pg, [\n+    {\n+      userId,\n+      previousLeague: undefined,\n+      newLeague: { season, division, cohort },\n+      bonusAmount: 0,\n+    },\n+  ])\n }\n"
        },
        {
          "path": "backend/shared/src/payout-leagues.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/payout-leagues.ts\n===================================================================\n--- backend/shared/src/payout-leagues.ts\t495e67b (parent)\n+++ backend/shared/src/payout-leagues.ts\t14e0625 (commit)\n@@ -1,17 +1,21 @@\n-import { getLeaguePrize, league_user_info } from 'common/leagues'\n-import { SupabaseDirectClient } from './supabase/init'\n-import { createLeagueChangedNotification } from './create-notification'\n-import { runTxnFromBank } from './txn/run-txn'\n+import {\n+  getLeaguePrize,\n+  league_user_info,\n+  LeagueChangeNotificationData,\n+} from 'common/leagues'\n+import { SupabaseTransaction } from './supabase/init'\n+import { createLeagueChangedNotifications } from './create-notification'\n+import { TxnData, insertTxns } from './txn/run-txn'\n+import { bulkIncrementBalances } from './supabase/users'\n \n-import { LeaguePrizeTxn } from 'common/txn'\n-import { chunk } from 'lodash'\n+import { log } from './utils'\n \n export const sendEndOfSeasonNotificationsAndBonuses = async (\n-  pg: SupabaseDirectClient,\n-  prevSeason: number\n+  pg: SupabaseTransaction,\n+  prevSeason: number,\n+  newSeason: number\n ) => {\n-  const newSeason = prevSeason + 1\n   const prevRows = await pg.manyOrNone<league_user_info>(\n     `select * from user_league_info\n     where season = $1`,\n     [prevSeason]\n@@ -24,71 +28,106 @@\n   const prevRowsByUserId = Object.fromEntries(\n     prevRows.map((r) => [r.user_id, r])\n   )\n \n-  for (const rows of chunk(newRows, 5)) {\n-    await Promise.all(\n-      rows.map((newRow) => {\n-        const prevRow = prevRowsByUserId[newRow.user_id] as\n-          | league_user_info\n-          | undefined\n-        if (prevRow) {\n-          return sendEndOfSeasonNotificationAndBonus(\n-            pg,\n-            prevRow,\n-            newRow,\n-            prevSeason\n-          )\n-        }\n-        return Promise.resolve()\n+  // Fetch all users who already received prizes for this season\n+  const alreadyGotPrizeRows = await pg.manyOrNone<{ to_id: string }>(\n+    `select to_id from txns\n+     where category = 'LEAGUE_PRIZE'\n+     and data->'data'->>'season' = $1`,\n+    [prevSeason.toString()]\n+  )\n+  // Create a Set for efficient lookups\n+  const alreadyGotPrizeUserIds = new Set(\n+    alreadyGotPrizeRows.map((row) => row.to_id)\n+  )\n+\n+  const notificationData: LeagueChangeNotificationData[] = []\n+\n+  const prizesToAward: Array<{\n+    userId: string\n+    prevRow: league_user_info\n+    newRow: league_user_info\n+    prize: number\n+  }> = []\n+\n+  // Check eligibility for users in this chunk\n+  for (const newRow of newRows) {\n+    const prevRow = prevRowsByUserId[newRow.user_id]\n+    if (!prevRow) continue\n+\n+    const prize = getLeaguePrize(prevRow.division, prevRow.rank)\n+    if (!prize || prize <= 0) continue\n+\n+    // Check if prize already awarded using our Set\n+    if (!alreadyGotPrizeUserIds.has(newRow.user_id)) {\n+      prizesToAward.push({\n+        userId: newRow.user_id,\n+        prevRow,\n+        newRow,\n+        prize,\n       })\n-    )\n+    } else {\n+      log(\n+        `User ${newRow.user_id} already received prize for season ${prevSeason}`\n+      )\n+    }\n   }\n-}\n \n-const sendEndOfSeasonNotificationAndBonus = async (\n-  pg: SupabaseDirectClient,\n-  prevRow: league_user_info,\n-  newRow: league_user_info,\n-  season: number\n-) => {\n-  const { user_id: userId, division, rank } = prevRow\n+  if (prizesToAward.length > 0) {\n+    const balanceIncrements: Array<{\n+      id: string\n+      balance: number\n+      totalDeposits: number\n+    }> = []\n+    const txnDatas: TxnData[] = []\n+    const currentNotifications: LeagueChangeNotificationData[] = []\n \n-  const prize = getLeaguePrize(division, rank)\n-  if (!prize) return\n+    for (const prizeAward of prizesToAward) {\n+      const { userId, prevRow, newRow, prize } = prizeAward\n \n-  const data: Omit<LeaguePrizeTxn, 'fromId' | 'id' | 'createdTime'> = {\n-    fromType: 'BANK',\n-    toId: userId,\n-    toType: 'USER',\n-    amount: prize,\n-    token: 'M$',\n-    category: 'LEAGUE_PRIZE',\n-    data: prevRow,\n-  }\n+      // Prepare balance increment data\n+      balanceIncrements.push({\n+        id: userId,\n+        balance: prize,\n+        totalDeposits: prize,\n+      })\n \n-  const alreadyGotPrize = await pg.oneOrNone(\n-    `select * from txns\n-      where category = 'LEAGUE_PRIZE'\n-      and data->'data'->>'season' = $1\n-      and to_id = $2`,\n-    [season.toString(), userId]\n-  )\n-  if (!alreadyGotPrize) {\n-    console.log(\n-      'send',\n-      newRow.user_id,\n-      'division',\n-      division,\n-      'rank',\n-      rank,\n-      'prize',\n-      prize,\n-      data.token\n-    )\n+      // Construct transaction data - including fromId now\n+      const txnData: TxnData = {\n+        fromId: 'BANK',\n+        fromType: 'BANK',\n+        toId: userId,\n+        toType: 'USER',\n+        amount: prize,\n+        token: 'M$',\n+        category: 'LEAGUE_PRIZE',\n+        data: { ...prevRow, season: prevSeason },\n+      }\n+      txnDatas.push(txnData)\n \n-    await pg.tx(async (tx) => {\n-      await runTxnFromBank(tx, data)\n-      await createLeagueChangedNotification(userId, prevRow, newRow, prize, tx)\n-    })\n+      // Prepare notification data\n+      currentNotifications.push({\n+        userId,\n+        previousLeague: prevRow,\n+        newLeague: newRow,\n+        bonusAmount: prize,\n+      })\n+    }\n+\n+    // Execute bulk updates and inserts within the transaction\n+    // Pass the transaction object 'tx' to the helper functions\n+    await bulkIncrementBalances(pg, balanceIncrements)\n+    await insertTxns(pg, txnDatas)\n+\n+    // Add notifications to the main list only if the transaction succeeds\n+    notificationData.push(...currentNotifications)\n   }\n+\n+  // Call the bulk notification function after collecting all data\n+  if (notificationData.length > 0) {\n+    log(`Sending ${notificationData.length} league change notifications.`)\n+    await createLeagueChangedNotifications(pg, notificationData)\n+  } else {\n+    log(`No league change notifications to send for season ${prevSeason}.`)\n+  }\n }\n"
        },
        {
          "path": "backend/shared/src/supabase/leagues.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/supabase/leagues.ts\n===================================================================\n--- backend/shared/src/supabase/leagues.ts\t495e67b (parent)\n+++ backend/shared/src/supabase/leagues.ts\t14e0625 (commit)\n@@ -1,7 +1,9 @@\n import { APIError } from 'common/api/utils'\n import { convertLeague } from 'common/supabase/leagues'\n import { type SupabaseClient, run } from 'common/supabase/utils'\n+import { createSupabaseDirectClient, SupabaseDirectClient } from './init'\n+import { log } from '../utils' // Assuming log exists\n \n export async function getLeaguesForUser(\n   db: SupabaseClient,\n   filters: {\n@@ -26,4 +28,83 @@\n \n   const res = await run(q)\n   return res.data.map(convertLeague)\n }\n+\n+export type SeasonStatus = 'active' | 'processing' | 'complete'\n+\n+export type SeasonEndTimeInfo = {\n+  season: number\n+  end_time: number\n+  status: SeasonStatus\n+}\n+\n+export const getSeasonEndTimeRow = async (\n+  pg: SupabaseDirectClient,\n+  season: number\n+): Promise<SeasonEndTimeInfo | null> => {\n+  const row = await pg.oneOrNone(\n+    `SELECT season, ts_to_millis(end_time) as end_time, status\n+     FROM leagues_season_end_times\n+     WHERE season = $1`,\n+    [season]\n+  )\n+  return row as SeasonEndTimeInfo | null\n+}\n+\n+export const insertSeasonEndTime = async (\n+  pg: SupabaseDirectClient,\n+  season: number,\n+  endTime: Date\n+): Promise<void> => {\n+  await pg.none(\n+    // Inserts with default status 'active'\n+    `INSERT INTO leagues_season_end_times (season, end_time)\n+     VALUES ($1, $2)\n+     ON CONFLICT (season) DO NOTHING`,\n+    [season, endTime.toISOString()]\n+  )\n+}\n+\n+export const updateSeasonStatus = async (\n+  pg: SupabaseDirectClient,\n+  season: number,\n+  status: SeasonStatus\n+): Promise<void> => {\n+  await pg.none(\n+    `UPDATE leagues_season_end_times\n+     SET status = $2\n+     WHERE season = $1`,\n+    [season, status]\n+  )\n+}\n+\n+export const getEffectiveCurrentSeason = async (): Promise<number> => {\n+  const pg = createSupabaseDirectClient()\n+  // Find the season marked as active\n+  const activeSeason = await pg.oneOrNone<{ season: number }>(\n+    `SELECT season FROM leagues_season_end_times WHERE status = 'active' LIMIT 1`\n+  )\n+\n+  if (activeSeason?.season) {\n+    return activeSeason.season\n+  }\n+\n+  // If no season is active (error state or initialization), find the latest completed and return + 1\n+  // This case *shouldn't* happen in normal operation after initialization.\n+  log.error(\n+    'No active season found in leagues_season_end_times! Falling back to latest completed + 1.'\n+  )\n+  const latestCompleted = await pg.oneOrNone<{ season: number }>(\n+    `SELECT max(season) as season FROM leagues_season_end_times WHERE status = 'complete'`\n+  )\n+\n+  if (latestCompleted?.season) {\n+    return latestCompleted.season + 1\n+  }\n+\n+  // If the table is completely empty (very first run ever)\n+  log.error(\n+    'leagues_season_end_times table appears empty. Defaulting to season 1.'\n+  )\n+  return 1\n+}\n"
        },
        {
          "path": "backend/supabase/leagues_season_end_times.sql",
          "status": "added",
          "diff": "Index: backend/supabase/leagues_season_end_times.sql\n===================================================================\n--- backend/supabase/leagues_season_end_times.sql\t495e67b (parent)\n+++ backend/supabase/leagues_season_end_times.sql\t14e0625 (commit)\n@@ -0,0 +1,43 @@\n+create table\n+  leagues_season_end_times (\n+    season int primary key,\n+    end_time timestamp with time zone not null,\n+    status text not null default 'active' check (status in ('active', 'processing', 'complete'))\n+  );\n+\n+-- Row Level Security\n+alter table leagues_season_end_times enable row level security;\n+\n+-- Backfill script for leagues_season_end_times table\n+insert into\n+  leagues_season_end_times (season, end_time, status) -- Changed processed to status\n+values\n+  (1, '2023-06-01T12:06:23-07:00', 'complete'), -- Set status to complete\n+  (2, '2023-07-01T12:22:53-07:00', 'complete'),\n+  (3, '2023-08-01T17:05:29-07:00', 'complete'),\n+  (4, '2023-09-01T20:20:04-07:00', 'complete'),\n+  (5, '2023-10-01T11:17:16-07:00', 'complete'),\n+  (6, '2023-11-01T14:01:38-07:00', 'complete'),\n+  (7, '2023-12-01T14:02:25-08:00', 'complete'),\n+  (8, '2024-01-01T19:06:12-08:00', 'complete'),\n+  (9, '2024-02-01T17:51:49-08:00', 'complete'),\n+  (10, '2024-03-01T15:30:22-08:00', 'complete'),\n+  (11, '2024-04-01T21:43:18-08:00', 'complete'),\n+  (12, '2024-05-01T16:32:08-07:00', 'complete'),\n+  (13, '2024-06-01T11:10:19-07:00', 'complete'),\n+  (14, '2024-07-01T18:41:35-07:00', 'complete'),\n+  (15, '2024-08-01T22:11:54-07:00', 'complete'),\n+  (16, '2024-09-01T12:54:14-07:00', 'complete'),\n+  (17, '2024-10-01T15:55:00-07:00', 'complete'),\n+  (18, '2024-11-02T22:18:29+00:00', 'complete'),\n+  (19, '2024-12-02T10:19:34-08:00', 'complete'),\n+  (20, '2025-01-01T22:06:13-08:00', 'complete'),\n+  (21, '2025-02-01T22:18:13-08:00', 'complete'),\n+  (22, '2025-03-02T02:25:41-08:00', 'complete'),\n+  (23, '2025-04-01T20:32:23-08:00', 'complete')\n+  -- (24, '2025-05-01T00:00:00-07:00', 'active') -- Example: Needs a placeholder or actual end time\n+on conflict (season) do\n+update\n+set\n+  end_time = EXCLUDED.end_time,\n+  status = EXCLUDED.status;\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\t495e67b (parent)\n+++ common/src/api/schema.ts\t14e0625 (commit)\n@@ -2368,8 +2368,22 @@\n         id: z.coerce.number(),\n       })\n       .strict(),\n   },\n+  'get-season-info': {\n+    method: 'GET',\n+    visibility: 'public',\n+    authed: false,\n+    props: z.object({\n+      season: z.coerce.number().int().positive().optional(),\n+    }),\n+    returns: {} as {\n+      season: number\n+      startTime: number // epoch ms\n+      endTime: number | null // epoch ms, null if a *mystery* for clients\n+      status: 'active' | 'processing' | 'complete'\n+    },\n+  },\n } as const)\n \n export type APIPath = keyof typeof API\n export type APISchema<N extends APIPath> = (typeof API)[N]\n"
        },
        {
          "path": "common/src/leagues.ts",
          "status": "modified",
          "diff": "Index: common/src/leagues.ts\n===================================================================\n--- common/src/leagues.ts\t495e67b (parent)\n+++ common/src/leagues.ts\t14e0625 (commit)\n@@ -1,42 +1,9 @@\n+import { LeagueChangeData } from './notification'\n import { Row } from './supabase/utils'\n \n-export type season = (typeof SEASONS)[number]\n-\n-export const SEASONS = [\n-  1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22,\n-  23, 24,\n-] as const\n-export const CURRENT_SEASON = SEASONS[SEASONS.length - 1]\n-\n export const LEAGUES_START = new Date('2023-05-01T00:00:00-07:00') // Pacific Daylight Time (PDT) as time zone offset\n \n-const SEASON_END_TIMES = [\n-  new Date('2023-06-01T12:06:23-07:00'),\n-  new Date('2023-07-01T12:22:53-07:00'),\n-  new Date('2023-08-01T17:05:29-07:00'),\n-  new Date('2023-09-01T20:20:04-07:00'),\n-  new Date('2023-10-01T11:17:16-07:00'),\n-  new Date('2023-11-01T14:01:38-07:00'),\n-  new Date('2023-12-01T14:02:25-08:00'),\n-  new Date('2024-01-01T19:06:12-08:00'),\n-  new Date('2024-02-01T17:51:49-08:00'),\n-  new Date('2024-03-01T15:30:22-08:00'),\n-  new Date('2024-04-01T21:43:18-08:00'),\n-  new Date('2024-05-01T16:32:08-07:00'),\n-  new Date('2024-06-01T11:10:19-07:00'),\n-  new Date('2024-07-01T18:41:35-07:00'),\n-  new Date('2024-08-01T22:11:54-07:00'), // 16\n-  new Date('2024-09-01T12:54:14-07:00'),\n-  new Date('2024-10-01T15:55:00-07:00'),\n-  new Date('2024-11-02T22:18:29+00:00'),\n-  new Date('2024-12-02T10:19:34-08:00'),\n-  new Date('2025-01-01T22:06:13-08:00'),\n-  new Date('2025-02-01T22:18:13-08:00'),\n-  new Date('2025-03-02T02:25:41-08:00'),\n-  new Date('2025-04-01T20:32:23-08:00'),\n-]\n-\n export type League = {\n   season: number\n   division: number\n   cohort: string\n@@ -57,41 +24,28 @@\n export const getSeasonDates = (season: number) => {\n   const start = new Date(LEAGUES_START)\n   start.setMonth(start.getMonth() + season - 1)\n \n-  let end: Date\n-  if (SEASON_END_TIMES[season - 1]) {\n-    end = new Date(SEASON_END_TIMES[season - 1])\n-  } else {\n-    end = new Date(LEAGUES_START)\n-    end.setMonth(end.getMonth() + season)\n-    // Add a day, though the random close time will be some time before this.\n-    end.setDate(end.getDate() + 1)\n-  }\n+  // NOTE: The exact season end time used for backend logic (rollover, payouts)\n+  // is now stored in the leagues_season_end_times table in the database.\n+  // This function now calculates an approximate end date primarily for display purposes\n+  // or as a fallback if the database row doesn't exist.\n+  const approxEnd = new Date(LEAGUES_START)\n+  approxEnd.setMonth(approxEnd.getMonth() + season)\n+  // Add a day, just to be safely after the potential random close time.\n+  approxEnd.setDate(approxEnd.getDate() + 1)\n \n-  return { start, end }\n+  return { start, approxEnd }\n }\n \n export const getSeasonCountdownEnd = (season: number) => {\n   const end = new Date(LEAGUES_START)\n   end.setMonth(end.getMonth() + season)\n   return end\n }\n \n-export const getSeasonStatus = (season: number) => {\n-  const { start } = getSeasonDates(season)\n-  const countdownEnd = getSeasonCountdownEnd(season)\n-  const now = new Date()\n-  if (now < start) {\n-    return 'upcoming'\n-  } else if (now > countdownEnd) {\n-    if (!SEASON_END_TIMES[season - 1]) {\n-      return 'closing-period'\n-    }\n-    return 'ended'\n-  } else {\n-    return 'current'\n-  }\n+export type LeagueChangeNotificationData = LeagueChangeData & {\n+  userId: string\n }\n \n export const DIVISION_NAMES = {\n   0: 'Silicon',\n@@ -265,14 +219,15 @@\n \n export const parseLeaguePath = (\n   slugs: string[],\n   rowsBySeason: { [season: number]: league_user_info[] },\n+  seasons: number[],\n   userId?: string\n ) => {\n   const [seasonSlug, divisionSlug, cohortSlug, userIdSlug] = slugs\n   let season = +seasonSlug\n-  if (!SEASONS.includes(season as season)) {\n-    season = CURRENT_SEASON\n+  if (!seasons.includes(season)) {\n+    season = seasons[seasons.length - 1]\n   }\n \n   const seasonRows = rowsBySeason[season] ?? []\n   const userIdToFind = userIdSlug || userId\n"
        },
        {
          "path": "web/components/leagues/mana-earned-breakdown.tsx",
          "status": "modified",
          "diff": "Index: web/components/leagues/mana-earned-breakdown.tsx\n===================================================================\n--- web/components/leagues/mana-earned-breakdown.tsx\t495e67b (parent)\n+++ web/components/leagues/mana-earned-breakdown.tsx\t14e0625 (commit)\n@@ -50,9 +50,9 @@\n   //     (mana_earned_breakdown.MARKET_BOOST_REDEEM ?? 0) +\n   //     (mana_earned_breakdown.AD_REDEEM ?? 0),\n   // } as { [key: string]: number }\n \n-  const { start, end } = getSeasonDates(season)\n+  const { start, approxEnd: end } = getSeasonDates(season)\n   const loadingBets = useBetsOnce((params) => api('bets', params), {\n     userId: user.id,\n     afterTime: start.getTime(),\n     beforeTime: end.getTime(),\n"
        },
        {
          "path": "web/hooks/use-leagues.ts",
          "status": "modified",
          "diff": "Index: web/hooks/use-leagues.ts\n===================================================================\n--- web/hooks/use-leagues.ts\t495e67b (parent)\n+++ web/hooks/use-leagues.ts\t14e0625 (commit)\n@@ -7,21 +7,23 @@\n   getOwnedLeagueChats,\n } from 'web/lib/supabase/leagues'\n import { usePersistentInMemoryState } from 'client-common/hooks/use-persistent-in-memory-state'\n import { usePersistentLocalState } from './use-persistent-local-state'\n+import { useAPIGetter } from './use-api-getter'\n \n export const useLeagueInfo = (userId: string | null | undefined) => {\n   const [leagueInfo, setLeagueInfo] = usePersistentLocalState<\n     league_user_info | null | undefined\n   >(undefined, `league-info-${userId}`)\n+  const { data: seasonInfo } = useAPIGetter('get-season-info', {})\n \n   useEffect(() => {\n-    if (userId) {\n-      getLeagueInfo(userId).then((result) => {\n+    if (userId && seasonInfo?.season) {\n+      getLeagueInfo(userId, seasonInfo.season).then((result) => {\n         setLeagueInfo(result as league_user_info | null)\n       })\n     }\n-  }, [userId])\n+  }, [userId, seasonInfo?.season])\n \n   return leagueInfo\n }\n \n"
        },
        {
          "path": "web/lib/supabase/leagues.ts",
          "status": "modified",
          "diff": "Index: web/lib/supabase/leagues.ts\n===================================================================\n--- web/lib/supabase/leagues.ts\t495e67b (parent)\n+++ web/lib/supabase/leagues.ts\t14e0625 (commit)\n@@ -1,14 +1,14 @@\n-import { CURRENT_SEASON, league_user_info } from 'common/leagues'\n+import { league_user_info } from 'common/leagues'\n import { convertSQLtoTS, tsToMillis } from 'common/supabase/utils'\n import { db } from './db'\n \n-export async function getLeagueInfo(userId: string) {\n+export async function getLeagueInfo(userId: string, season: number) {\n   const { data } = await db\n     .from('user_league_info')\n     .select('*')\n     .eq('user_id', userId)\n-    .eq('season', CURRENT_SEASON)\n+    .eq('season', season)\n     .limit(1)\n   if (data && data.length > 0) {\n     return data[0]\n   }\n"
        },
        {
          "path": "web/pages/leagues/[[...leagueSlugs]].tsx",
          "status": "modified",
          "diff": "Index: web/pages/leagues/[[...leagueSlugs]].tsx\n===================================================================\n--- web/pages/leagues/[[...leagueSlugs]].tsx\t495e67b (parent)\n+++ web/pages/leagues/[[...leagueSlugs]].tsx\t14e0625 (commit)\n@@ -4,16 +4,12 @@\n import { useRouter } from 'next/router'\n \n import {\n   DIVISION_NAMES,\n-  CURRENT_SEASON,\n   getLeaguePath,\n   league_user_info,\n   parseLeaguePath,\n-  getSeasonStatus,\n-  SEASONS,\n   getSeasonMonth,\n-  season,\n   getSeasonCountdownEnd,\n   getSeasonDates,\n   getMaxDivisionBySeason,\n   getDemotionAndPromotionCountBySeason,\n@@ -40,20 +36,73 @@\n import { InfoTooltip } from 'web/components/widgets/info-tooltip'\n import { LoadingIndicator } from 'web/components/widgets/loading-indicator'\n import { useEffectCheckEquality } from 'web/hooks/use-effect-check-equality'\n import Link from 'next/link'\n+import { DAY_MS } from 'common/util/time'\n+import { api } from 'web/lib/api/api'\n+import { APIResponse } from 'common/api/schema'\n \n-export default function Leagues() {\n+export async function getStaticPaths() {\n+  return { paths: [], fallback: 'blocking' }\n+}\n+\n+export async function getStaticProps(props: {\n+  params: { leagueSlugs: string[] }\n+}) {\n+  try {\n+    // Extract season from URL if available\n+    const leagueSlugs = props.params?.leagueSlugs || []\n+    const seasonParam = leagueSlugs[0]\n+    const season =\n+      seasonParam && !isNaN(parseInt(seasonParam))\n+        ? parseInt(seasonParam)\n+        : undefined\n+\n+    const currentSeasonInfo = await api('get-season-info', {})\n+    const seasonInfo = await api('get-season-info', season ? { season } : {})\n+    return {\n+      props: {\n+        initialSeasonInfo: seasonInfo,\n+        currentSeasonInfo,\n+      },\n+      revalidate: 60, // Revalidate every minute\n+    }\n+  } catch (err) {\n+    console.error('Error fetching season info:', err)\n+    return {\n+      props: {\n+        initialSeasonInfo: null,\n+      },\n+      revalidate: 60, // Retry sooner if there was an error\n+    }\n+  }\n+}\n+\n+interface LeaguesProps {\n+  initialSeasonInfo: APIResponse<'get-season-info'> | null\n+  currentSeasonInfo: APIResponse<'get-season-info'> | null\n+}\n+\n+export default function Leagues(props: LeaguesProps) {\n+  const { initialSeasonInfo, currentSeasonInfo } = props\n   const user = useUser()\n \n   const [rows, setRows] = usePersistentInMemoryState<league_user_info[]>(\n     [],\n     'league-rows'\n   )\n \n   const rowsBySeason = useMemo(() => groupBy(rows, 'season'), [rows])\n+  const seasonInfo = initialSeasonInfo ?? currentSeasonInfo\n+  const seasons = useMemo(() => {\n+    const seasons = []\n+    for (let i = 1; i <= (currentSeasonInfo?.season ?? 1); i++) {\n+      seasons.push(i)\n+    }\n+    return seasons\n+  }, [currentSeasonInfo?.season])\n \n-  const [season, setSeason] = useState<number>(CURRENT_SEASON)\n+  const [season, setSeason] = useState<number>(seasonInfo?.season ?? 1)\n   useEffect(() => {\n     getLeagueRows(season).then((rows) => {\n       setRows((currRows) =>\n         currRows.filter((r) => r.season !== season).concat(rows)\n@@ -97,17 +146,16 @@\n   const onSetSeason = (newSeason: number) => {\n     const { season, division, cohort } = parseLeaguePath(\n       [newSeason.toString()],\n       rowsBySeason,\n+      seasons,\n       user?.id\n     )\n \n     if (cohort) {\n-      replace(getLeaguePath(season, division, cohort), undefined, {\n-        shallow: true,\n-      })\n+      replace(getLeaguePath(season, division, cohort), undefined)\n     } else {\n-      replace(`${season}`, undefined, { shallow: true })\n+      replace(`${season}`, undefined)\n     }\n   }\n \n   const onSetDivision = (division: number) => {\n@@ -133,8 +181,9 @@\n \n     const { season, division, cohort, highlightedUserId } = parseLeaguePath(\n       leagueSlugs ?? [],\n       rowsBySeason,\n+      seasons,\n       user?.id\n     )\n     console.log(\n       'setting league',\n@@ -149,12 +198,14 @@\n     setHighlightedUserId(highlightedUserId)\n   }, [isReady, seasonLoaded, leagueSlugs, user?.id])\n \n   const MARKER = '★'\n-  const seasonStatus = getSeasonStatus(season)\n+  const seasonStatus = seasonInfo?.status\n   const countdownEnd = getSeasonCountdownEnd(season)\n-  const { end: seasonEnd } = getSeasonDates(season)\n-  const randomPeriodEnd = new Date(countdownEnd.getTime() + 24 * 60 * 60 * 1000)\n+  const { approxEnd: seasonEnd } = getSeasonDates(season)\n+  const closingPeriod =\n+    seasonStatus === 'active' && seasonEnd.getTime() < Date.now() + DAY_MS\n+  const randomPeriodEnd = new Date(countdownEnd.getTime() + DAY_MS)\n \n   const userRow = seasonRows.find((row) => row.user_id === user?.id)\n   const userDivision = userRow?.division\n   const userCohort = userRow?.cohort\n@@ -177,11 +228,11 @@\n             <Title className=\"!mb-0\">Leagues</Title>\n             <Select\n               className=\"!border-ink-200 !h-10\"\n               value={season}\n-              onChange={(e) => onSetSeason(+e.target.value as season)}\n+              onChange={(e) => onSetSeason(+e.target.value)}\n             >\n-              {SEASONS.map((season) => (\n+              {seasons.map((season) => (\n                 <option key={season} value={season}>\n                   Season {season}: {getSeasonMonth(season)}\n                 </option>\n               ))}\n@@ -198,17 +249,19 @@\n               </span>{' '}\n               for the most profit (realized and unrealized) on trades placed\n               this month!\n               <span className={'ml-1'}>\n-                {seasonStatus === 'closing-period' && (\n+                {closingPeriod && (\n                   <>\n                     Ends randomly within <br />\n                     <ClockIcon className=\"text-ink-1000 inline h-4 w-4\" />{' '}\n                     {getCountdownStringHoursMinutes(randomPeriodEnd)}\n                   </>\n                 )}\n-                {seasonStatus === 'ended' && <>Ended {formatTime(seasonEnd)}</>}\n-                {seasonStatus === 'current' && (\n+                {seasonStatus === 'complete' && (\n+                  <>Ended {formatTime(seasonEnd)}</>\n+                )}\n+                {seasonStatus === 'active' && (\n                   <>\n                     Season ends in:{' '}\n                     <InfoTooltip\n                       text={\n"
        }
      ]
    },
    {
      "id": "share-limit-bets",
      "sha": "f1222e5db9b8b457f1994dda940e82aa4da13a16",
      "parentSha": "26ff10e57542b3939709c991853f6758bc8aa1c7",
      "spec": "Implement a share-after-trade experience for limit orders and simplify the share-row logic in the buy panel.\n\nScope:\n- Files to modify:\n  - web/components/bet/limit-order-panel.tsx\n  - web/components/bet/bet-panel.tsx\n\nRequired behavior and structure:\n1) Limit order panel share flow:\n- After a successful limit bet submission, show an inline confirmation row with the text \"Trade successful!\" and a Share button.\n- Clicking Share opens the ShareBetModal prefilled with the bet details.\n- Delay calling onBuySuccess by a short timeout (e.g., 3000ms) to keep the panel open long enough for the user to click Share. While the share modal is open, do not dismiss the panel; only dismiss when not sharing.\n- On API error, clear any share state and do not show the share row.\n- Replace toast-based success feedback with the inline success row. Preserve analytics tracking of the bet.\n- Track isSharing (boolean) and lastBetDetails (Bet | null) in state.\n- Build a full Bet object from the API response by combining the CandidateBet response with id = bet.betId and userId = user.id, and set lastBetDetails to it on success. Clear lastBetDetails on error.\n- Use formatOutcomeLabel for the outcome label provided to ShareBetModal, and formatPercent for average price.\n- Render ShareBetModal only when lastBetDetails exists, the user is present, and isSharing is true. Ensure the modal is provided the correct question text, outcome label, optional answer text (for multi), average price, bet amount, potential win amount (based on limit probability and order amount if available, otherwise fallback to shares), bettor info, and mark it as a limit bet.\n\n2) Buy panel simplification for share row:\n- Remove the showShareRow state and any conditions that depend on it.\n- Show the share row (and ShareBetModal) whenever lastBetDetails exists.\n- When the bet results in no final bet (updatedBet/submittedBet are falsy) or an error occurs, clear lastBetDetails so the share row is not rendered.\n- Maintain the existing delay before dismissing and ensure onBuySuccess is not called while sharing.\n\nDo not modify ShareBetModal’s API; use it in the same way it is used elsewhere (e.g., in feed and user bet summary components).",
      "prompt": "Add a share flow to the limit order trade panel and simplify the buy panel’s share-row logic. When a user places a limit order successfully, show an inline confirmation row with a Share button and open a share modal prefilled with the trade details. Delay auto-dismiss to give time to share and do not close the panel while the share modal is open. For the buy panel, remove any separate share-row flags and instead show the share row whenever a successful bet exists. Ensure the share modal is populated with the correct bet details and user information.",
      "supplementalFiles": [
        "web/components/bet/share-bet.tsx",
        "web/components/feed/feed-bets.tsx",
        "web/components/bet/user-bet-summary.tsx",
        "common/src/util/format.ts",
        "common/src/new-bet.ts",
        "client-common/hooks/use-event.ts"
      ],
      "fileDiffs": [
        {
          "path": "web/components/bet/bet-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/bet-panel.tsx\n===================================================================\n--- web/components/bet/bet-panel.tsx\t26ff10e (parent)\n+++ web/components/bet/bet-panel.tsx\tf1222e5 (commit)\n@@ -286,9 +286,8 @@\n     : manaSlippageProtection\n   const [inputRef, focusAmountInput] = useFocus()\n \n   // State for share row\n-  const [showShareRow, setShowShareRow] = useState(false)\n   const [isSharing, setIsSharing] = useState(false)\n   const [lastBetDetails, setLastBetDetails] = useState<Bet | null>(null)\n \n   const isCpmmMulti = contract.mechanism === 'cpmm-multi-1'\n@@ -342,14 +341,14 @@\n       setIsSubmitting(false)\n       const finalBetDetails = updatedBet ?? submittedBet\n       if (finalBetDetails) {\n         setLastBetDetails(finalBetDetails)\n-        setShowShareRow(true)\n         setIsSharing(false)\n         setTimeout(() => {\n           callOnBuySuccess()\n         }, WAIT_TO_DISMISS)\n       } else {\n+        setLastBetDetails(null)\n         callOnBuySuccess()\n       }\n     }\n   }, [updatedBet, submittedBet])\n@@ -463,9 +462,8 @@\n           id: bet.betId,\n           userId: user.id,\n         }\n         setLastBetDetails(fullBet)\n-        setShowShareRow(true)\n         setIsSharing(false)\n         // TODO: we could remove the timeout and just not dismiss the modal\n         setTimeout(() => {\n           callOnBuySuccess()\n@@ -522,8 +520,9 @@\n         setError(`Error placing ${TRADE_TERM}`)\n         toast.error(`Error submitting ${TRADE_TERM}`, { id: toastId })\n       }\n       setIsSubmitting(false)\n+      setLastBetDetails(null)\n     }\n   }\n   const [showLocationMonitor, setShowLocationMonitor] = useState(false)\n \n@@ -888,9 +887,9 @@\n               </Button>\n             )}\n           </Col>\n         )}\n-        {showShareRow && lastBetDetails && (\n+        {lastBetDetails && (\n           <Row className=\"bg-primary-100 mt-2 items-center justify-between rounded-lg p-3\">\n             <Row className=\"items-baseline gap-2\">\n               <span className=\"text-primary-700 text-sm \">\n                 {isSubmitting ? 'Placing trade...' : 'Trade successful!'}\n@@ -908,9 +907,9 @@\n             </Button>\n           </Row>\n         )}\n \n-        {showShareRow && lastBetDetails && isSharing && user && (\n+        {lastBetDetails && isSharing && user && (\n           <ShareBetModal\n             open={isSharing}\n             setOpen={setIsSharing}\n             questionText={contract.question}\n"
        },
        {
          "path": "web/components/bet/limit-order-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/limit-order-panel.tsx\n===================================================================\n--- web/components/bet/limit-order-panel.tsx\t26ff10e (parent)\n+++ web/components/bet/limit-order-panel.tsx\tf1222e5 (commit)\n@@ -1,17 +1,16 @@\n import dayjs from 'dayjs'\n import { capitalize, clamp } from 'lodash'\n import { useEffect, useRef, useState } from 'react'\n-import toast from 'react-hot-toast'\n import { LimitBet } from 'common/bet'\n import { getProbability } from 'common/calculate'\n import {\n   getBinaryMCProb,\n   isBinaryMulti,\n   MarketContract,\n   MultiContract,\n } from 'common/contract'\n-import { formatPercent } from 'common/util/format'\n+import { formatOutcomeLabel, formatPercent } from 'common/util/format'\n import { DAY_MS, HOUR_MS, MINUTE_MS, MONTH_MS, WEEK_MS } from 'common/util/time'\n import { Input } from 'web/components/widgets/input'\n import { firebaseLogin, User } from 'web/lib/firebase/users'\n import { Button } from '../buttons/button'\n@@ -35,8 +34,13 @@\n import { getLimitBetReturns, MultiBetProps } from 'client-common/lib/bet'\n import DropdownMenu from '../widgets/dropdown-menu'\n import { SelectorIcon } from '@heroicons/react/solid'\n import { InfoTooltip } from '../widgets/info-tooltip'\n+import { LuShare } from 'react-icons/lu'\n+import { ShareBetModal } from './share-bet'\n+import { Bet } from 'common/bet'\n+import { useEvent } from 'client-common/hooks/use-event'\n+import { CandidateBet } from 'common/new-bet'\n \n const expirationOptions = [\n   { label: 'Never expires', value: 0 },\n   { label: 'Expires immediately', value: 1 },\n@@ -46,8 +50,10 @@\n   { label: 'Expires in 1 month', value: MONTH_MS },\n   { label: 'Custom time...', value: -1 },\n ]\n \n+const WAIT_TO_DISMISS = 3000\n+\n export default function LimitOrderPanel(props: {\n   contract: MarketContract\n   multiProps?: MultiBetProps\n   user: User | null | undefined\n@@ -120,9 +126,17 @@\n \n   const [selectedExpiration, setSelectedExpiration] =\n     usePersistentLocalState<number>(0, 'limit-order-expiration')\n \n-  // Find matching expiration option if available\n+  const [isSharing, setIsSharing] = useState(false)\n+  const [lastBetDetails, setLastBetDetails] = useState<Bet | null>(null)\n+\n+  const callOnBuySuccess = useEvent(() => {\n+    if (onBuySuccess && !isSharing) {\n+      onBuySuccess()\n+    }\n+  })\n+\n   useEffect(() => {\n     if (expiration === 0) {\n       setSelectedExpiration(0)\n     } else if (expiration) {\n@@ -202,34 +216,30 @@\n \n     const answerId = multiProps?.answerToBuy.id\n \n     try {\n-      const bet = await toast.promise(\n-        api(\n-          'bet',\n-          removeUndefinedProps({\n-            outcome,\n-            amount,\n-            contractId: contract.id,\n-            answerId,\n-            limitProb,\n-            expiresAt: addCustomExpiration ? expiresAt : undefined,\n-            expiresMillisAfter,\n-            deps: betDeps.current?.map((b) => b.userId),\n-            silent: expiresMillisAfter && expiresMillisAfter <= 1000,\n-          } as APIParams<'bet'>)\n-        ),\n-        {\n-          loading: `Submitting ${TRADE_TERM}...`,\n-          success: `${capitalize(TRADE_TERM)} submitted!`,\n-          error: `Error submitting ${TRADE_TERM}`,\n-        }\n+      const bet = await api(\n+        'bet',\n+        removeUndefinedProps({\n+          outcome,\n+          amount,\n+          contractId: contract.id,\n+          answerId,\n+          limitProb,\n+          expiresAt: addCustomExpiration ? expiresAt : undefined,\n+          expiresMillisAfter,\n+          deps: betDeps.current?.map((b) => b.userId),\n+          silent: expiresMillisAfter && expiresMillisAfter <= 1000,\n+        } as APIParams<'bet'>)\n       )\n-\n       console.log(`placed ${TRADE_TERM}. Result:`, bet)\n-      if (onBuySuccess) onBuySuccess()\n \n-      await track('bet', {\n+      const fullBet: Bet = {\n+        ...(bet as CandidateBet<LimitBet>),\n+        id: bet.betId,\n+        userId: user.id,\n+      }\n+      track('bet', {\n         location: 'bet panel',\n         outcomeType: contract.outcomeType,\n         slug: contract.slug,\n         contractId: contract.id,\n@@ -239,9 +249,15 @@\n         isLimitOrder: true,\n         answerId: multiProps?.answerToBuy.id,\n         token: contract.token,\n       })\n+      setLastBetDetails(fullBet)\n+      setIsSharing(false)\n+      setTimeout(() => {\n+        callOnBuySuccess()\n+      }, WAIT_TO_DISMISS)\n     } catch (e) {\n+      setLastBetDetails(null)\n       if (e instanceof APIError) {\n         setError(e.message.toString())\n       } else {\n         console.error(e)\n@@ -255,9 +271,8 @@\n   let currentPayout = 0\n   let currentReturn = 0\n   let orderAmount = 0\n   let filledAmount = 0\n-  // let fees = noFees\n   try {\n     const result = getLimitBetReturns(\n       outcome ?? 'YES',\n       amount,\n@@ -282,9 +297,9 @@\n         `An error occurred during ${TRADE_TERM} calculation, try again.`\n     )\n   }\n   const returnPercent = formatPercent(currentReturn)\n-  // const totalFees = getFeeTotal(fees)\n+\n   const hideYesNo = isBinaryMC || !!pseudonym\n \n   const expirationItems = expirationOptions.map((option) => ({\n     name: option.label,\n@@ -491,19 +506,8 @@\n             </div>\n           </Row>\n         )}\n \n-        {/* <Row className=\"items-center justify-between gap-2 text-sm\">\n-          <Row className=\"text-ink-500 flex-nowrap items-center gap-2 whitespace-nowrap\">\n-            Fees\n-          </Row>\n-          <FeeDisplay\n-            amount={filledAmount}\n-            totalFees={totalFees}\n-            isCashContract={isCashContract}\n-          />\n-        </Row> */}\n-\n         <Col className=\"gap-2\">\n           {user ? (\n             <>\n               <Row className=\"items-center justify-between gap-2\">\n@@ -545,8 +549,62 @@\n                     </span>\n                   )}\n                 </Button>\n               </Row>\n+\n+              {lastBetDetails && (\n+                <Row className=\"bg-primary-100 mt-2 items-center justify-between rounded-lg p-3\">\n+                  <Row className=\"items-baseline gap-2\">\n+                    <span className=\"text-primary-700 text-sm \">\n+                      {isSubmitting ? 'Placing trade...' : 'Trade successful!'}\n+                    </span>\n+                  </Row>\n+                  <Button\n+                    className=\"w-1/2\"\n+                    color=\"gradient\"\n+                    onClick={() => setIsSharing(true)}\n+                  >\n+                    <Row className=\"items-center gap-1.5\">\n+                      <LuShare className=\"h-5 w-5\" aria-hidden />\n+                      Share Bet\n+                    </Row>\n+                  </Button>\n+                </Row>\n+              )}\n+\n+              {lastBetDetails && isSharing && user && (\n+                <ShareBetModal\n+                  open={isSharing}\n+                  setOpen={setIsSharing}\n+                  questionText={contract.question}\n+                  outcome={formatOutcomeLabel(\n+                    contract,\n+                    lastBetDetails.outcome as 'YES' | 'NO'\n+                  )}\n+                  answer={multiProps?.answerToBuy.text}\n+                  avgPrice={formatPercent(lastBetDetails.limitProb ?? 0)}\n+                  betAmount={\n+                    lastBetDetails.orderAmount ?? lastBetDetails.amount\n+                  }\n+                  winAmount={\n+                    lastBetDetails.limitProb !== undefined &&\n+                    lastBetDetails.orderAmount !== undefined\n+                      ? lastBetDetails.outcome === 'YES'\n+                        ? lastBetDetails.orderAmount / lastBetDetails.limitProb\n+                        : lastBetDetails.orderAmount /\n+                          (1 - lastBetDetails.limitProb)\n+                      : lastBetDetails.shares\n+                  }\n+                  bettor={{\n+                    id: user.id,\n+                    name: user.name,\n+                    username: user.username,\n+                    avatarUrl: user.avatarUrl,\n+                  }}\n+                  isLimitBet={true}\n+                  orderAmount={lastBetDetails.orderAmount}\n+                />\n+              )}\n             </>\n           ) : (\n             <Button\n               color={outcome === 'NO' ? 'red' : 'green'}\n"
        }
      ]
    },
    {
      "id": "add-mc-startpoints",
      "sha": "d827e632712ba21620dc66ddcfba984131c394a9",
      "parentSha": "5bb7818b4aa9d67137177818e741cf852e08c0d4",
      "spec": "Implement per-answer starting points for multi-answer (cpmm-multi-1) market graphs and update related APIs and consumers.\n\nRequirements:\n- In common/src/bets.ts:\n  - Change getBetPointsBetween to accept two arguments: (contract: MarketContract, options: Omit<APIParams<'bet-points'>, 'contractId'>).\n  - Forward the request to unauthedApi('bet-points') including contractId: contract.id alongside other options.\n  - For non-multi mechanisms (not 'cpmm-multi-1'):\n    - After fetching and sorting points by createdTime, if there are no points, return [].\n    - Otherwise, prepend a single starting point using the first point’s probBefore at x = firstPoint.createdTime - 1, preserving answerId when present.\n  - For 'cpmm-multi-1' contracts:\n    - Group fetched bet points by answerId.\n    - For every answer on the contract, compute a starting point with:\n      - x = options.afterTime if provided; otherwise contract.createdTime.\n      - y = earliest bet’s probBefore for that answer if available; otherwise the initial answer probability; otherwise 0.\n      - answerId = the answer’s id.\n    - Prepend all such starting points to the series before the fetched points mapped to { x: createdTime, y: probAfter, answerId }.\n\n- In common/src/contract-params.ts:\n  - In getContractParams, update the bet points fetch to call getBetPointsBetween(contract as MarketContract, { ... }) instead of passing contractId, preserving the existing filterRedemptions and includeZeroShareRedemptions logic and the beforeTime bound.\n  - In getMultiBetPoints:\n    - Stop limiting answers by MAX_ANSWERS; include all answers in the chart.\n    - Remove injecting an extra starting point derived from getInitialAnswerProbability; instead, use the points produced by getBetPointsBetween (which now includes starting points for each answer).\n    - For each answer, sort that answer’s points by x and then bin with maxMinBin(points, 500) as before.\n\n- In web/components/charts/contract/zoom-utils.ts:\n  - Change getPointsBetween signature to accept (contract: MarketContract, min, max) and pass that contract to getBetPointsBetween.\n  - Update useDataZoomFetcher props to accept contract: MarketContract instead of discrete contractId/createdTime/lastBetTime, and derive those values internally from the contract.\n  - Update getMultichoicePointsBetween to pass the full contract to getBetPointsBetween.\n\n- In web/components/contract/contract-overview.tsx:\n  - Update the useDataZoomFetcher invocation to pass the full contract object instead of separate id/createdTime/lastBetTime.\n\n- In web/pages/embed/[username]/[contractSlug].tsx:\n  - Update the getBetPointsBetween call in getStaticProps to pass the full contract object rather than contractId.\n\n- Types/Imports:\n  - Where needed, import MarketContract from common/contract and getInitialAnswerProbability from common/src/calculate.\n  - Where needed, import groupBy, minBy, sortBy from lodash.\n\nObservable outcomes:\n- Multi-answer market charts now show a correct per-answer starting state even when the zoomed time window excludes earlier bets, using probBefore or initial probabilities.\n- All call sites compile with the updated getBetPointsBetween signature and behave as before for non-multi contracts.\n- Multi-answer chart generation no longer injects its own starting point within getMultiBetPoints; it relies on the enriched data from getBetPointsBetween.",
      "prompt": "Update the bet-points data assembly so multi-answer markets render with a correct per-answer starting state when zooming or embedding. Have the bet-points fetcher accept a full market object instead of just an ID, and use that to add a starting point per answer based on either the earliest bet’s prior probability or the answer’s initial probability. Ensure all consumers of the fetcher (including zoomed views and embeds) pass the market object, and remove any separate logic that tries to inject initial points within multi-answer chart building so the data source is the single source of truth for starting points.",
      "supplementalFiles": [
        "common/src/contract.ts",
        "common/src/calculate.ts",
        "common/src/answer.ts",
        "common/src/util/array.ts",
        "backend/api/src/get-bets.ts",
        "backend/api/src/routes.ts"
      ],
      "fileDiffs": [
        {
          "path": "common/src/bets.ts",
          "status": "modified",
          "diff": "Index: common/src/bets.ts\n===================================================================\n--- common/src/bets.ts\t5bb7818 (parent)\n+++ common/src/bets.ts\td827e63 (commit)\n@@ -1,8 +1,10 @@\n import { unauthedApi } from 'common/util/api'\n import { APIParams } from 'common/api/schema'\n-import { sortBy } from 'lodash'\n+import { groupBy, minBy, sortBy } from 'lodash'\n import { buildArray } from 'common/util/array'\n+import { getInitialAnswerProbability } from './calculate'\n+import { MarketContract } from './contract'\n \n export async function getTotalBetCount(contractId: string) {\n   const res = (await unauthedApi('bets', {\n     contractId,\n@@ -45,24 +47,48 @@\n   )\n }\n \n // gets random bets - 50,000 by default\n-export const getBetPointsBetween = async (options: APIParams<'bet-points'>) => {\n-  const data = await unauthedApi('bet-points', options)\n+export const getBetPointsBetween = async (\n+  contract: MarketContract,\n+  options: Omit<APIParams<'bet-points'>, 'contractId'>\n+) => {\n+  const data = await unauthedApi('bet-points', {\n+    ...options,\n+    contractId: contract.id,\n+  })\n \n   const sorted = sortBy(data, 'createdTime')\n \n-  if (sorted.length === 0) return []\n+  const startingProbs = []\n+  if (contract.mechanism === 'cpmm-multi-1') {\n+    const { answers } = contract\n+    const rawPointsByAns = groupBy(data, 'answerId')\n \n-  // we need to include previous prob for binary in case the prob shifted from something\n-  const includePrevProb = !sorted[0].answerId\n+    const beforePoints = answers.map((ans) => {\n+      const earliestBet = minBy(rawPointsByAns[ans.id], (b) => b.createdTime)\n+      return {\n+        x: options.afterTime ?? contract.createdTime,\n+        y:\n+          earliestBet?.probBefore ??\n+          getInitialAnswerProbability(contract, ans) ??\n+          0,\n+        answerId: ans.id,\n+      }\n+    })\n+    startingProbs.push(...beforePoints)\n+  } else {\n+    if (sorted.length === 0) return []\n \n-  return buildArray(\n-    includePrevProb && {\n+    startingProbs.push({\n       x: sorted[0].createdTime - 1,\n       y: sorted[0].probBefore,\n       answerId: sorted[0].answerId,\n-    },\n+    })\n+  }\n+\n+  return buildArray(\n+    startingProbs,\n     sorted.map((r) => ({\n       x: r.createdTime,\n       y: r.probAfter,\n       answerId: r.answerId,\n"
        },
        {
          "path": "common/src/contract-params.ts",
          "status": "modified",
          "diff": "Index: common/src/contract-params.ts\n===================================================================\n--- common/src/contract-params.ts\t5bb7818 (parent)\n+++ common/src/contract-params.ts\td827e63 (commit)\n@@ -24,14 +24,13 @@\n import {\n   ANSWERS_TO_HIDE_GRAPH,\n   getDefaultSort,\n   getSortedAnswers,\n-  MAX_ANSWERS,\n   sortAnswers,\n } from './answer'\n import { getDashboardsToDisplayOnContract } from './supabase/dashboards'\n import { getBetPointsBetween, getTotalBetCount } from './bets'\n-\n+import { MarketContract } from './contract'\n export async function getContractParams(\n   contract: Contract,\n   db: SupabaseClient\n ): Promise<Omit<ContractParams, 'cash'>> {\n@@ -71,10 +70,9 @@\n           filterRedemptions: true,\n         })\n       : ([] as Bet[]),\n     hasMechanism && !shouldHideGraph(contract)\n-      ? getBetPointsBetween({\n-          contractId: contract.id,\n+      ? getBetPointsBetween(contract as MarketContract, {\n           filterRedemptions: !includeRedemptions,\n           includeZeroShareRedemptions: includeRedemptions,\n           beforeTime: (contract.lastBetTime ?? contract.createdTime) + 1,\n           afterTime: contract.createdTime,\n@@ -158,25 +156,12 @@\n   const { answers } = contract\n \n   const rawPointsByAns = groupBy(betPoints, 'answerId')\n \n-  const subsetOfAnswers = sortBy(\n-    answers,\n-    (a) => (a.resolution ? 1 : 0),\n-    (a) => -a.totalLiquidity\n-  ).slice(0, MAX_ANSWERS)\n-\n   const pointsByAns = {} as { [answerId: string]: { x: number; y: number }[] }\n-  subsetOfAnswers.forEach((ans) => {\n-    const startY = getInitialAnswerProbability(contract, ans)\n-\n-    const points = rawPointsByAns[ans.id] ?? []\n-    points.sort((a, b) => a.x - b.x)\n-\n-    pointsByAns[ans.id] = buildArray<{ x: number; y: number }>(\n-      startY != undefined && { x: ans.createdTime, y: startY },\n-      maxMinBin(points, 500)\n-    )\n+  answers.forEach((ans) => {\n+    const points = sortBy(rawPointsByAns[ans.id] ?? [], 'x')\n+    pointsByAns[ans.id] = maxMinBin(points, 500)\n   })\n \n   return serializeMultiPoints(pointsByAns)\n }\n"
        },
        {
          "path": "web/components/charts/contract/zoom-utils.ts",
          "status": "modified",
          "diff": "Index: web/components/charts/contract/zoom-utils.ts\n===================================================================\n--- web/components/charts/contract/zoom-utils.ts\t5bb7818 (parent)\n+++ web/components/charts/contract/zoom-utils.ts\td827e63 (commit)\n@@ -4,17 +4,16 @@\n import { useCallback, useEffect, useLayoutEffect, useState } from 'react'\n import { ScaleTime } from 'd3-scale'\n import { getBetPointsBetween } from 'common/bets'\n import { getMultiBetPoints } from 'common/contract-params'\n-import { MultiContract } from 'common/contract'\n+import { MarketContract, MultiContract } from 'common/contract'\n \n export async function getPointsBetween(\n-  contractId: string,\n+  contract: MarketContract,\n   min: number,\n   max: number\n ) {\n-  const points = await getBetPointsBetween({\n-    contractId,\n+  const points = await getBetPointsBetween(contract, {\n     beforeTime: max,\n     afterTime: min,\n     filterRedemptions: true,\n   })\n@@ -25,23 +24,23 @@\n }\n \n // only for single value contracts\n export const useDataZoomFetcher = <T>(props: {\n-  contractId: string\n-  createdTime: number\n-  lastBetTime: number\n+  contract: MarketContract\n   viewXScale?: ScaleTime<number, number>\n   points: HistoryPoint<T>[]\n }) => {\n-  const { contractId, createdTime, lastBetTime, viewXScale, points } = props\n+  const { contract, viewXScale, points } = props\n+  const { id: contractId, createdTime } = contract\n+  const lastBetTime = contract.lastBetTime ?? createdTime\n   const [data, setData] = useState(points)\n   const [loading, setLoading] = useState(false)\n \n   const onZoomData = useCallback(\n     debounce(async (min: number, max: number) => {\n       if (min && max) {\n         setLoading(true)\n-        const zoomedPoints = await getPointsBetween(contractId, min, max)\n+        const zoomedPoints = await getPointsBetween(contract, min, max)\n \n         setData(\n           buildArray(\n             points.filter((p) => p.x <= min),\n@@ -85,10 +84,9 @@\n   contract: MultiContract,\n   min: number,\n   max: number\n ) {\n-  const allBetPoints = await getBetPointsBetween({\n-    contractId: contract.id,\n+  const allBetPoints = await getBetPointsBetween(contract, {\n     filterRedemptions: false,\n     includeZeroShareRedemptions: true,\n     beforeTime: max,\n     afterTime: min,\n"
        },
        {
          "path": "web/components/contract/contract-overview.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-overview.tsx\n===================================================================\n--- web/components/contract/contract-overview.tsx\t5bb7818 (parent)\n+++ web/components/contract/contract-overview.tsx\td827e63 (commit)\n@@ -219,11 +219,9 @@\n   const { currentTimePeriod, setTimePeriod, maxRange, zoomParams } =\n     useTimePicker(contract, () => setShowZoomer(true))\n \n   const { points, loading } = useDataZoomFetcher({\n-    contractId: contract.id,\n-    createdTime: contract.createdTime,\n-    lastBetTime: contract.lastBetTime ?? contract.createdTime,\n+    contract,\n     viewXScale: zoomParams?.viewXScale,\n     points: props.betPoints,\n   })\n \n"
        },
        {
          "path": "web/pages/embed/[username]/[contractSlug].tsx",
          "status": "modified",
          "diff": "Index: web/pages/embed/[username]/[contractSlug].tsx\n===================================================================\n--- web/pages/embed/[username]/[contractSlug].tsx\t5bb7818 (parent)\n+++ web/pages/embed/[username]/[contractSlug].tsx\td827e63 (commit)\n@@ -96,10 +96,9 @@\n     contract.outcomeType === 'DATE'\n   ) {\n     const includeRedemptions =\n       contract.mechanism === 'cpmm-multi-1' && contract.shouldAnswersSumToOne\n-    const allBetPoints = await getBetPointsBetween({\n-      contractId: contract.id,\n+    const allBetPoints = await getBetPointsBetween(contract, {\n       filterRedemptions: !includeRedemptions,\n       includeZeroShareRedemptions: includeRedemptions,\n       beforeTime: (contract.lastBetTime ?? contract.createdTime) + 1,\n       afterTime: contract.createdTime,\n"
        }
      ]
    },
    {
      "id": "filter-site-activity",
      "sha": "75c37553d4ba60101c902e9c3e49d051ea2ab081",
      "parentSha": "16e0692ce9890847e83fb7daf59c7df1330850de",
      "spec": "Implement followed-based filtering for site activity across backend, schema, and UI.\n\nBackend API (backend/api/src/get-site-activity.ts):\n- Update the get-site-activity handler to remove topicSlug and topicId inputs and support new filters:\n  - Accept props: limit, offset, blockedUserIds, blockedGroupSlugs, blockedContractIds, topicIds (existing), types, minBetAmount, and new flags onlyFollowedTopics (boolean), onlyFollowedContracts (boolean), userId (string).\n- If onlyFollowedTopics is true and userId is provided, select all group_id from group_members where member_id = userId into followedTopicIds. If none exist, return an empty payload with bets: [], comments: [], newContracts: [], relatedContracts: [].\n- If onlyFollowedContracts is true and userId is provided, select all contract_id from contract_follows where follow_id = userId into followedContractIds. If none exist, return the same empty payload.\n- Preserve blockedGroupSlugs → blockedTopicIds resolution via groups table.\n- Update SQL queries for bets, comments, and new contracts to conditionally filter by:\n  - Provided topicIds (join group_contracts as gc and filter gc.group_id = ANY($6)).\n  - Followed topics (join group_contracts as gct and filter gct.group_id = ANY($8)) when onlyFollowedTopics.\n  - Followed contracts (filter on contract id ANY($9)) when onlyFollowedContracts.\n- Maintain existing filters for blockedUserIds ($1), blockedContractIds ($2), blockedTopicIds ($5), minBetAmount ($7 for bets), visibility, limit ($3), and offset ($4). Ensure parameter ordering is consistent across all queries.\n- Use DISTINCT ON created_time in the SELECTs to avoid duplicates when joining.\n- Return the same response structure: { bets, comments, newContracts, relatedContracts }.\n\nShared API schema (common/src/api/schema.ts):\n- Modify the get-site-activity request schema:\n  - Remove topicSlug and topicId.\n  - Add onlyFollowedTopics?: boolean, onlyFollowedContracts?: boolean, and userId?: string (coerce booleans as elsewhere in the API).\n  - Keep existing fields (limit, offset, blockedUserIds, blockedGroupSlugs, blockedContractIds, topicIds, types, minBetAmount). Response shape remains unchanged.\n\nFrontend UI and logic (web/components/site-activity.tsx):\n- Extend the local ActivityState to include filterMode: 'custom-topics' | 'followed-topics' | 'followed-markets'. Keep selectedTopics, types, and minBetAmount. Use a new persistence key (e.g., 'site-activity-state-1').\n- Derive onlyFollowedTopics = filterMode === 'followed-topics' and onlyFollowedContracts = filterMode === 'followed-markets'.\n- Compute topicIds only when filterMode is 'custom-topics'; do not send topicIds for 'followed-markets'.\n- Pass onlyFollowedTopics, onlyFollowedContracts, and userId into useAPIGetter('get-site-activity', ...).\n- Replace the original filter header with pills for:\n  - Custom: shows a MultiTopicPillSelector inline; selecting topics updates persistent state and tracks an analytics event.\n  - My Topics: sets filterMode to 'followed-topics'.\n  - My Markets: sets filterMode to 'followed-markets'.\n- Keep activity type selection as pills (All activity, Trades only, Comments only, Markets only). Update state and track analytics on selection.\n- Show the Min bet dropdown only when the selected activity types are exclusively 'bets'. Keep preset amounts and custom input behavior (apply on blur or Enter).\n- Extract per-contract rendering into an ActivityLog component that:\n  - Receives parentId, items, contractsById, privateUser, user, router.\n  - Renders the contract header (ContractMention), FeedBet for bets, MarketCreatedLog for new markets, and CommentLog with inline replies and a link to view remaining replies.\n  - Shows the contract cover image on the right, with the same responsive visibility behavior.\n  - If the contract is binary and the user has shares (via useSavedContractMetrics), render YourMetricsFooter with the user’s position.\n- Keep infinite scrolling pagination with VisibilityObserver and offset/limit behavior intact.\n\nSupporting UI components:\n- web/components/search/filter-pills.tsx:\n  - Update DropdownPill props to accept optional onClick and className and pass them through to the button element.\n\n- web/components/topics/topic-selector.tsx:\n  - Update MultiTopicPillSelector to accept highlight?: boolean and buttonClassName?: string and forward them to the DropdownPill.\n  - Change the button label to \"All Topics\" when none are selected, otherwise \"N Topics\".\n\nCosmetic adjustment:\n- web/pages/explore/index.tsx: Adjust the root container padding from p-1 to px-2 to harmonize layout spacing.\n\nExpected behavior:\n- Users can toggle between three feed sources: custom-selected topics, their followed topics, or their followed markets.\n- Backend correctly filters activity via group_members and contract_follows based on the selected mode, without returning any results if the relevant followed set is empty.\n- The request shape is updated (no topicSlug/topicId; new onlyFollowedTopics/onlyFollowedContracts/userId flags). The response shape remains the same.\n- The feed UI shows appropriate pills, conditional min bet filter for trades-only, and user position metrics under binary markets when applicable.",
      "prompt": "Add followed-based filters to the site activity feed. Let users switch between activity from custom-selected topics, topics they follow, and markets they follow. Update the public API to accept new filtering flags and the user ID, query the database for followed topics and followed markets, and filter bets, comments, and newly created markets accordingly. Update the activity page UI to show pills for selecting Custom (with a topics selector), My Topics, or My Markets alongside the existing activity-type pills. Only show the min bet filter when viewing trades only. Extract the per-market feed rendering into its own component and show the user’s position metrics on binary markets when available. Keep pagination and current behavior intact while removing deprecated topicSlug/topicId inputs and using the new request shape.",
      "supplementalFiles": [
        "web/hooks/use-api-getter.ts",
        "web/hooks/use-user.tsx",
        "web/components/widgets/dropdown-menu.tsx",
        "web/components/widgets/visibility-observer.tsx",
        "web/components/widgets/input.tsx",
        "web/components/contract/feed-contract-card.tsx",
        "web/components/contract/contract-mention.tsx",
        "web/components/feed/feed-bets.tsx",
        "web/pages/activity.tsx",
        "web/lib/service/analytics.ts",
        "common/src/bet.ts",
        "common/src/comment.ts",
        "common/src/group.ts",
        "supabase/group_members.sql",
        "supabase/contract_follows.sql",
        "supabase/group_contracts.sql"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/get-site-activity.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/get-site-activity.ts\n===================================================================\n--- backend/api/src/get-site-activity.ts\t16e0692 (parent)\n+++ backend/api/src/get-site-activity.ts\t75c3755 (commit)\n@@ -1,5 +1,5 @@\n-import { APIError, APIHandler } from 'api/helpers/endpoint'\n+import { APIHandler } from 'api/helpers/endpoint'\n import { createSupabaseDirectClient } from 'shared/supabase/init'\n import { convertContract } from 'common/supabase/contracts'\n import { filterDefined } from 'common/util/array'\n import { uniqBy } from 'lodash'\n@@ -18,25 +18,17 @@\n     limit,\n     offset = 0,\n     blockedGroupSlugs = [],\n     blockedContractIds = [],\n-    topicSlug,\n     types = ['bets', 'comments', 'markets'],\n     minBetAmount,\n+    onlyFollowedTopics = false,\n+    onlyFollowedContracts = false,\n+    userId,\n+    topicIds,\n   } = props\n   const pg = createSupabaseDirectClient()\n \n-  const topicIds = filterDefined([...(props.topicIds ?? []), props.topicId])\n-  if (topicSlug) {\n-    const topic = await pg.one(`select id from groups where slug = $1`, [\n-      topicSlug,\n-    ])\n-    if (!topic) {\n-      throw new APIError(404, 'Topic not found')\n-    }\n-    topicIds.push(topic.id)\n-  }\n-\n   let blockedTopicIds = []\n   if (blockedGroupSlugs.length > 0) {\n     const blockedTopics = await pg.manyOrNone(\n       `select id from groups where slug = ANY($1)`,\n@@ -49,23 +41,74 @@\n     'FDWTsTHFytZz96xmcKzf7S5asYL2', // yunabot (does a lot of manual trades)\n     ...(props.blockedUserIds ?? []),\n   ]\n \n-  const hasTopicFilter = topicIds.length > 0\n+  const hasTopicFilter = !!topicIds?.length\n+  const emptyReturn = {\n+    bets: [],\n+    comments: [],\n+    newContracts: [],\n+    relatedContracts: [],\n+  }\n+  // Get followed topic IDs if user wants to filter by followed topics\n+  let followedTopicIds: string[] = []\n+  if (onlyFollowedTopics && userId) {\n+    const followedTopics = await pg.manyOrNone(\n+      `select group_id from group_members where member_id = $1`,\n+      [userId]\n+    )\n+    followedTopicIds = followedTopics.map((t) => t.group_id)\n+    if (followedTopicIds.length === 0) {\n+      return emptyReturn\n+    }\n+  }\n \n-  const betsSelect = `SELECT cb.*\n+  // Get followed contract IDs if user wants to filter by followed contracts\n+  let followedContractIds: string[] = []\n+  if (onlyFollowedContracts && userId) {\n+    const followedContracts = await pg.manyOrNone(\n+      `select contract_id from contract_follows where follow_id = $1`,\n+      [userId]\n+    )\n+    followedContractIds = followedContracts.map((c) => c.contract_id)\n+    if (followedContractIds.length === 0) {\n+      return emptyReturn\n+    }\n+  }\n+\n+  const topicFilterPart = hasTopicFilter\n+    ? 'JOIN group_contracts gc ON cb.contract_id = gc.contract_id'\n+    : ''\n+\n+  const followedTopicsFilterPart =\n+    onlyFollowedTopics && followedTopicIds.length > 0\n+      ? 'JOIN group_contracts gct ON cb.contract_id = gct.contract_id'\n+      : ''\n+\n+  const followedContractsFilterPart =\n+    onlyFollowedContracts && followedContractIds.length > 0 ? '' : ''\n+\n+  const betsSelect = `SELECT distinct on (cb.created_time) cb.*\n        FROM contract_bets cb\n-       ${\n-         hasTopicFilter\n-           ? 'JOIN group_contracts gc ON cb.contract_id = gc.contract_id'\n-           : ''\n-       }`\n+       ${topicFilterPart}\n+       ${followedTopicsFilterPart}\n+       ${followedContractsFilterPart}`\n \n   const betsEnd = `\n     AND cb.user_id != ALL($1)\n     AND cb.contract_id != ALL($2)\n     AND not cb.is_api\n     ${hasTopicFilter ? 'AND gc.group_id = ANY($6)' : ''}\n+    ${\n+      onlyFollowedTopics && followedTopicIds.length > 0\n+        ? 'AND gct.group_id = ANY($8)'\n+        : ''\n+    }\n+    ${\n+      onlyFollowedContracts && followedContractIds.length > 0\n+        ? 'AND cb.contract_id = ANY($9)'\n+        : ''\n+    }\n      ORDER BY cb.created_time DESC\n     LIMIT $3 OFFSET $4;\n   `\n \n@@ -83,43 +126,75 @@\n          AND NOT cb.is_filled AND NOT cb.is_cancelled\n         ${betsEnd}`\n     : 'select null where false;'\n \n+  const topicFilterForComments = hasTopicFilter\n+    ? 'JOIN group_contracts gc ON cc.contract_id = gc.contract_id'\n+    : ''\n+\n+  const followedTopicsFilterForComments =\n+    onlyFollowedTopics && followedTopicIds.length > 0\n+      ? 'JOIN group_contracts gct ON cc.contract_id = gct.contract_id'\n+      : ''\n+\n   const recentCommentsQuery = types.includes('comments')\n-    ? `SELECT\n+    ? `SELECT distinct on (cc.created_time)\n            cc.contract_id,\n            cc.comment_id,\n            cc.data,\n            cc2.data as reply_to_data\n        FROM contract_comments cc\n-       ${\n-         hasTopicFilter\n-           ? 'JOIN group_contracts gc ON cc.contract_id = gc.contract_id'\n-           : ''\n-       }\n+       ${topicFilterForComments}\n+       ${followedTopicsFilterForComments}\n        LEFT JOIN contract_comments cc2 ON cc2.comment_id = cc.data->>'replyToCommentId'\n       WHERE cc.user_id != ALL($1)\n          AND cc.contract_id != ALL($2)\n          AND cc.visibility = 'public'\n          ${hasTopicFilter ? 'AND gc.group_id = ANY($6)' : ''}\n+         ${\n+           onlyFollowedTopics && followedTopicIds.length > 0\n+             ? 'AND gct.group_id = ANY($8)'\n+             : ''\n+         }\n+         ${\n+           onlyFollowedContracts && followedContractIds.length > 0\n+             ? 'AND cc.contract_id = ANY($9)'\n+             : ''\n+         }\n        ORDER BY cc.created_time DESC\n        LIMIT $3 OFFSET $4;`\n     : 'select null where false;'\n \n+  const topicFilterForContracts = hasTopicFilter\n+    ? 'JOIN group_contracts gc ON c.id = gc.contract_id'\n+    : ''\n+\n+  const followedTopicsFilterForContracts =\n+    onlyFollowedTopics && followedTopicIds.length > 0\n+      ? 'JOIN group_contracts gct ON c.id = gct.contract_id'\n+      : ''\n+\n   const newContractsQuery = types.includes('markets')\n-    ? `SELECT c.*\n+    ? `SELECT distinct on (c.created_time) c.*\n        FROM contracts c\n-       ${\n-         hasTopicFilter\n-           ? 'JOIN group_contracts gc ON c.id = gc.contract_id'\n-           : ''\n-       }\n+       ${topicFilterForContracts}\n+       ${followedTopicsFilterForContracts}\n        WHERE c.visibility = 'public'\n          AND c.creator_id != ALL($1)\n          AND c.id != ALL($2)\n          AND c.resolution is null\n          AND is_valid_contract(c)\n          ${hasTopicFilter ? 'AND gc.group_id = ANY($6)' : ''}\n+         ${\n+           onlyFollowedTopics && followedTopicIds.length > 0\n+             ? 'AND gct.group_id = ANY($8)'\n+             : ''\n+         }\n+         ${\n+           onlyFollowedContracts && followedContractIds.length > 0\n+             ? 'AND c.id = ANY($9)'\n+             : ''\n+         }\n          AND NOT EXISTS (\n            SELECT 1 FROM group_contracts gc2\n            WHERE gc2.contract_id = c.id\n              AND gc2.group_id = ANY($5)\n@@ -142,8 +217,10 @@\n     offset,\n     blockedTopicIds,\n     topicIds,\n     minBetAmount ?? 500,\n+    followedTopicIds,\n+    followedContractIds,\n   ])\n \n   const recentBets = results[0] || []\n   const limitOrders = results[1] || []\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\t16e0692 (parent)\n+++ common/src/api/schema.ts\t75c3755 (commit)\n@@ -2074,13 +2074,14 @@\n         offset: z.coerce.number().default(0),\n         blockedUserIds: z.array(z.string()).optional(),\n         blockedGroupSlugs: z.array(z.string()).optional(),\n         blockedContractIds: z.array(z.string()).optional(),\n-        topicSlug: z.string().optional(),\n-        topicId: z.string().optional(),\n         topicIds: z.array(z.string()).optional(),\n         types: z.array(z.enum(['bets', 'comments', 'markets'])).optional(),\n         minBetAmount: z.coerce.number().optional(),\n+        onlyFollowedTopics: coerceBoolean.optional(),\n+        onlyFollowedContracts: coerceBoolean.optional(),\n+        userId: z.string().optional(),\n       })\n       .strict(),\n   },\n   'get-sports-games': {\n"
        },
        {
          "path": "web/components/search/filter-pills.tsx",
          "status": "modified",
          "diff": "Index: web/components/search/filter-pills.tsx\n===================================================================\n--- web/components/search/filter-pills.tsx\t16e0692 (parent)\n+++ web/components/search/filter-pills.tsx\t75c3755 (commit)\n@@ -188,8 +188,10 @@\n export function DropdownPill(props: {\n   color?: 'indigo' | 'gray' | 'light-gray'\n   open: boolean\n   children: ReactNode\n+  onClick?: () => void\n+  className?: string\n }) {\n   const color = props.color ?? 'gray'\n \n   return (\n@@ -199,10 +201,12 @@\n         color === 'indigo'\n           ? 'hover:bg-primary-600 focus-visible:bg-primary-600 bg-primary-500 text-white'\n           : color === 'light-gray'\n           ? 'bg-ink-100 hover:bg-ink-200 text-ink-600 dark:bg-ink-300 dark:hover:bg-ink-400'\n-          : 'bg-ink-200 hover:bg-ink-300 text-ink-600 dark:bg-ink-300 dark:hover:bg-ink-400'\n+          : 'bg-ink-200 hover:bg-ink-300 text-ink-600 dark:bg-ink-300 dark:hover:bg-ink-400',\n+        props.className\n       )}\n+      onClick={props.onClick}\n     >\n       {/* eslint-disable react/prop-types */}\n       {props.children}\n       <ChevronDownIcon\n"
        },
        {
          "path": "web/components/site-activity.tsx",
          "status": "modified",
          "diff": "Index: web/components/site-activity.tsx\n===================================================================\n--- web/components/site-activity.tsx\t16e0692 (parent)\n+++ web/components/site-activity.tsx\t75c3755 (commit)\n@@ -2,9 +2,9 @@\n import { CommentWithTotalReplies, ContractComment } from 'common/comment'\n import { Contract } from 'common/contract'\n import { groupBy, keyBy, orderBy, uniq, uniqBy } from 'lodash'\n import { memo, useCallback, useEffect, useState } from 'react'\n-import { usePrivateUser } from 'web/hooks/use-user'\n+import { usePrivateUser, useUser } from 'web/hooks/use-user'\n import { ContractMention } from './contract/contract-mention'\n import { FeedBet } from './feed/feed-bets'\n import { Col } from './layout/col'\n import { Row } from './layout/row'\n@@ -17,24 +17,29 @@\n import { useAPIGetter } from 'web/hooks/use-api-getter'\n import { VisibilityObserver } from 'web/components/widgets/visibility-observer'\n import { LikeAndDislikeComment } from './comments/comment-actions'\n import { NextRouter, useRouter } from 'next/router'\n-import { useUser } from 'web/hooks/use-user'\n import { User } from 'common/user'\n import { PrivateUser } from 'common/user'\n import { track } from 'web/lib/service/analytics'\n import { usePersistentLocalState } from 'web/hooks/use-persistent-local-state'\n import { LiteGroup } from 'common/group'\n import DropdownMenu, { DropdownItem } from './widgets/dropdown-menu'\n-import { DropdownPill } from './search/filter-pills'\n+import { DropdownPill, FilterPill } from './search/filter-pills'\n import { Input } from './widgets/input'\n import { APIResponse } from 'common/src/api/schema'\n import { MultiTopicPillSelector } from './topics/topic-selector'\n+import { useSavedContractMetrics } from 'web/hooks/use-saved-contract-metrics'\n+import { Bet } from 'common/bet'\n+import { YourMetricsFooter } from './contract/feed-contract-card'\n \n interface ActivityState {\n   selectedTopics: LiteGroup[]\n   types: ('bets' | 'comments' | 'markets')[]\n   minBetAmount: number | undefined\n+  onlyFollowedTopics: boolean\n+  onlyFollowedContracts: boolean\n+  filterMode: 'custom-topics' | 'followed-topics' | 'followed-markets'\n }\n \n const defaultGroups: LiteGroup[] = [\n   {\n@@ -87,16 +92,27 @@\n       {\n         selectedTopics: defaultGroups,\n         types: ['comments', 'bets', 'markets'],\n         minBetAmount: PRESET_BET_AMOUNTS[1],\n+        onlyFollowedTopics: false,\n+        onlyFollowedContracts: false,\n+        filterMode: 'custom-topics',\n       },\n-      'site-activity-state'\n+      'site-activity-state-1'\n     )\n   const [offset, setOffset] = useState(0)\n \n-  const { selectedTopics, types, minBetAmount } = activityState\n+  const { selectedTopics, types, minBetAmount, filterMode } = activityState\n+\n+  // Derive onlyFollowedTopics and onlyFollowedContracts from filterMode\n+  const onlyFollowedTopics = filterMode === 'followed-topics'\n+  const onlyFollowedContracts = filterMode === 'followed-markets'\n+\n+  // Only send topic IDs if we're in custom-topics or followed-topics mode (not in followed-markets mode)\n   const topicIds =\n-    selectedTopics.length > 0 ? selectedTopics.map((t) => t.id) : undefined\n+    filterMode === 'custom-topics' && selectedTopics.length > 0\n+      ? selectedTopics.map((t) => t.id)\n+      : undefined\n \n   const limit = 30 / types.length\n   const [allData, setAllData] = useState<APIResponse<'get-site-activity'>>()\n \n@@ -122,8 +138,17 @@\n     },\n     [setActivityState, setOffset]\n   )\n \n+  // Update filter mode when switching between different filtering options\n+  const setFilterMode = useCallback(\n+    (mode: ActivityState['filterMode']) => {\n+      updateActivityState({ filterMode: mode })\n+      track('site activity filter mode change', { mode })\n+    },\n+    [updateActivityState]\n+  )\n+\n   const { data, loading, refresh } = useAPIGetter(\n     'get-site-activity',\n     {\n       limit,\n@@ -136,8 +161,11 @@\n       ]),\n       topicIds,\n       types,\n       minBetAmount,\n+      onlyFollowedTopics,\n+      onlyFollowedContracts,\n+      userId: user?.id,\n     },\n     ['blockedContractIds', 'offset']\n   )\n \n@@ -205,284 +233,188 @@\n     'desc'\n   )\n \n   return (\n-    <Col className={clsx('gap-4', className)}>\n-      <Row className=\"mt-2 items-center gap-2\">\n-        <MultiTopicPillSelector\n-          topics={selectedTopics}\n-          setTopics={(topics) => {\n-            updateActivityState({ selectedTopics: topics })\n-            track('site activity topic change', {\n-              topics: topics.map((t) => t.slug),\n-            })\n-          }}\n-          maxTopics={10}\n-        />\n-        <DropdownMenu\n-          closeOnClick\n-          selectedItemName={\n-            ACTIVITY_TYPES.find(\n-              (t) =>\n-                t.value.length === types.length &&\n-                t.value.every((v) => types.includes(v))\n-            )?.name ?? 'All activity'\n-          }\n-          items={ACTIVITY_TYPES.map((type) => ({\n-            name: type.name,\n-            onClick: () => {\n-              updateActivityState({ types: [...type.value] })\n-              track('site activity type change', {\n-                types: [...type.value],\n-              })\n-            },\n-          }))}\n-          buttonContent={(open) => (\n-            <DropdownPill open={open}>\n-              {ACTIVITY_TYPES.find(\n-                (t) =>\n-                  t.value.length === types.length &&\n-                  t.value.every((v) => types.includes(v))\n-              )?.name ?? 'All activity'}\n-            </DropdownPill>\n+    <>\n+      <Col className=\"bg-canvas-0 sticky top-[2.9rem] z-10 -mt-2 gap-2 py-2\">\n+        {/* Primary Filter Mode Pills */}\n+        <Row className=\"flex-wrap gap-2\">\n+          <FilterPill\n+            selected={filterMode === 'custom-topics'}\n+            onSelect={() => {\n+              if (filterMode !== 'custom-topics') {\n+                setFilterMode('custom-topics')\n+              }\n+            }}\n+          >\n+            Custom\n+            <MultiTopicPillSelector\n+              buttonClassName={'-mr-2 !bg-transparent !py-0 !pl-1 '}\n+              topics={selectedTopics}\n+              setTopics={(topics) => {\n+                updateActivityState({ selectedTopics: topics })\n+                track('site activity topic change', {\n+                  topics: topics.map((t) => t.slug),\n+                })\n+              }}\n+              maxTopics={10}\n+              highlight={filterMode === 'custom-topics'}\n+            />\n+          </FilterPill>\n+          {user && (\n+            <>\n+              <FilterPill\n+                selected={filterMode === 'followed-topics'}\n+                onSelect={() => setFilterMode('followed-topics')}\n+              >\n+                My Topics\n+              </FilterPill>\n+              <FilterPill\n+                selected={filterMode === 'followed-markets'}\n+                onSelect={() => setFilterMode('followed-markets')}\n+              >\n+                My Markets\n+              </FilterPill>\n+            </>\n           )}\n-        />\n-        {types.includes('bets') && (\n-          <DropdownMenu\n-            buttonContent={(open) => (\n-              <DropdownPill open={open}>\n-                Min bet{' '}\n-                {minBetAmount !== undefined ? `M$${minBetAmount}` : 'Any'}\n-              </DropdownPill>\n-            )}\n-            items={[\n-              ...PRESET_BET_AMOUNTS.map((amount) => ({\n-                name: `M$${amount}`,\n-                onClick: () => {\n-                  updateActivityState({ minBetAmount: amount })\n-                  track('site activity bet amount change', {\n-                    amount,\n-                  })\n-                },\n-              })),\n-              {\n-                name: (\n-                  <Row\n-                    className=\"items-center gap-2\"\n-                    onClick={(e) => e.stopPropagation()}\n-                  >\n-                    M$\n-                    <Input\n-                      type=\"number\"\n-                      className=\"!h-8 w-32\"\n-                      placeholder=\"Custom\"\n-                      min={1}\n-                      value={customAmountString}\n-                      onChange={(e) => {\n-                        e.stopPropagation()\n-                        setCustomAmountString(e.target.value)\n-                      }}\n-                      onBlur={() => {\n-                        // Parse and apply the filter when input loses focus\n-                        const value = parseInt(customAmountString)\n-                        const newAmount =\n-                          isNaN(value) || value <= 0 ? undefined : value\n-                        updateActivityState({ minBetAmount: newAmount })\n-                      }}\n-                      onFocus={(e) => e.target.select()}\n-                      onKeyDown={(e) => {\n-                        if (e.key === 'Enter') {\n-                          e.preventDefault()\n-                          // Parse and apply filter immediately on Enter\n+        </Row>\n+\n+        {/* Activity Type Filter Pills */}\n+        <Row className=\"flex-wrap gap-2\">\n+          {ACTIVITY_TYPES.map((type) => (\n+            <FilterPill\n+              key={type.name}\n+              selected={\n+                types.length === type.value.length &&\n+                type.value.every((v) => types.includes(v))\n+              }\n+              onSelect={() => {\n+                updateActivityState({ types: [...type.value] })\n+                track('site activity type change', {\n+                  types: [...type.value],\n+                })\n+              }}\n+            >\n+              {type.name}\n+            </FilterPill>\n+          ))}\n+\n+          {/* Min Bet Amount (only show when filtering by trades exclusively) */}\n+          {types.every((t) => t === 'bets') && (\n+            <DropdownMenu\n+              buttonContent={(open) => (\n+                <DropdownPill open={open}>\n+                  Min bet{' '}\n+                  {minBetAmount !== undefined ? `M$${minBetAmount}` : 'Any'}\n+                </DropdownPill>\n+              )}\n+              items={[\n+                ...PRESET_BET_AMOUNTS.map((amount) => ({\n+                  name: `M$${amount}`,\n+                  onClick: () => {\n+                    updateActivityState({ minBetAmount: amount })\n+                    track('site activity bet amount change', {\n+                      amount,\n+                    })\n+                  },\n+                })),\n+                {\n+                  name: (\n+                    <Row\n+                      className=\"items-center gap-2\"\n+                      onClick={(e) => e.stopPropagation()}\n+                    >\n+                      M$\n+                      <Input\n+                        type=\"number\"\n+                        className=\"!h-8 w-32\"\n+                        placeholder=\"Custom\"\n+                        min={1}\n+                        value={customAmountString}\n+                        onChange={(e) => {\n+                          e.stopPropagation()\n+                          setCustomAmountString(e.target.value)\n+                        }}\n+                        onBlur={() => {\n+                          // Parse and apply the filter when input loses focus\n                           const value = parseInt(customAmountString)\n                           const newAmount =\n                             isNaN(value) || value <= 0 ? undefined : value\n                           updateActivityState({ minBetAmount: newAmount })\n-                        }\n-                      }}\n-                    />\n-                  </Row>\n-                ) as any,\n-                onClick: undefined, // Let onBlur/onKeyDown handle the state update\n-                selected:\n-                  minBetAmount !== undefined &&\n-                  !PRESET_BET_AMOUNTS.includes(minBetAmount),\n-                closeOnClickOverride: false,\n-              } as DropdownItem,\n-              {\n-                name: 'M$0',\n-                onClick: () => {\n-                  updateActivityState({ minBetAmount: 0 })\n+                        }}\n+                        onFocus={(e) => e.target.select()}\n+                        onKeyDown={(e) => {\n+                          if (e.key === 'Enter') {\n+                            e.preventDefault()\n+                            // Parse and apply filter immediately on Enter\n+                            const value = parseInt(customAmountString)\n+                            const newAmount =\n+                              isNaN(value) || value <= 0 ? undefined : value\n+                            updateActivityState({ minBetAmount: newAmount })\n+                          }\n+                        }}\n+                      />\n+                    </Row>\n+                  ) as any,\n+                  onClick: undefined, // Let onBlur/onKeyDown handle the state update\n+                  selected:\n+                    minBetAmount !== undefined &&\n+                    !PRESET_BET_AMOUNTS.includes(minBetAmount),\n+                  closeOnClickOverride: false,\n+                } as DropdownItem,\n+                {\n+                  name: 'M$0',\n+                  onClick: () => {\n+                    updateActivityState({ minBetAmount: 0 })\n+                  },\n                 },\n-              },\n-            ]}\n-          />\n+              ]}\n+            />\n+          )}\n+        </Row>\n+      </Col>\n+      <Col className={clsx('gap-3', className)}>\n+        <Col className=\"gap-4\">\n+          {!allData ? (\n+            <LoadingIndicator />\n+          ) : items.length === 0 ? (\n+            <div className=\"text-ink-500 mt-8 text-center\">\n+              No activity found with current filters\n+            </div>\n+          ) : (\n+            groups.map(({ parentId, items }) => {\n+              return (\n+                <ActivityLog\n+                  key={parentId}\n+                  parentId={parentId}\n+                  items={items}\n+                  contractsById={contractsById}\n+                  privateUser={privateUser}\n+                  user={user}\n+                  router={router}\n+                />\n+              )\n+            })\n+          )}\n+        </Col>\n+        {allData && (\n+          <div className=\"relative\">\n+            {loading && <LoadingIndicator />}\n+            <VisibilityObserver\n+              className=\"pointer-events-none absolute bottom-0 h-screen w-full select-none\"\n+              onVisibilityUpdated={(visible) => {\n+                if (visible && !loading) {\n+                  setOffset(offset + limit)\n+                  setTimeout(() => {\n+                    refresh()\n+                  }, 100)\n+                }\n+              }}\n+            />\n+          </div>\n         )}\n-      </Row>\n-      <Col className=\"gap-4\">\n-        {!allData ? (\n-          <LoadingIndicator />\n-        ) : (\n-          groups.map(({ parentId, items }) => {\n-            const contract = contractsById[parentId] as Contract\n-\n-            // Separate comments and group replies\n-            const comments = items.filter(\n-              (item): item is CommentWithTotalReplies =>\n-                'userId' in item && !('question' in item) && !('amount' in item)\n-            )\n-            const replies = comments.filter((c) => !!c.replyToCommentId)\n-            const repliesByParentId = groupBy(\n-              orderBy(replies, 'createdTime', 'asc'), // Sort replies ascending\n-              'replyToCommentId'\n-            )\n-\n-            // Filter items to include non-comments and parent comments, sorted descending\n-            const displayItems = orderBy(\n-              items.filter(\n-                (item) =>\n-                  !(\n-                    'userId' in item &&\n-                    (item as CommentWithTotalReplies).replyToCommentId\n-                  ) // Exclude replies from main list\n-              ),\n-              'createdTime',\n-              'desc'\n-            )\n-\n-            return (\n-              <Col\n-                key={parentId}\n-                className={clsx(\n-                  'bg-canvas-0 dark:bg-canvas-50 dark:border-canvas-50 hover:border-primary-300 gap-2 rounded-lg border p-3 shadow-md transition-colors sm:px-5'\n-                )}\n-              >\n-                <Row className=\"gap-2\">\n-                  <Col className=\"flex-1 gap-2\">\n-                    <ContractMention\n-                      contract={contract}\n-                      trackingLocation={'site-activity'}\n-                    />\n-                    <div className=\"space-y-1\">\n-                      {displayItems.map((item) => {\n-                        if ('amount' in item) {\n-                          // Render Bet\n-                          return (\n-                            <FeedBet\n-                              className=\"p-1\"\n-                              key={item.id}\n-                              contract={contract}\n-                              bet={item}\n-                              avatarSize=\"xs\"\n-                              hideActions={true}\n-                            />\n-                          )\n-                        } else if ('question' in item) {\n-                          // Render Market Creation\n-                          return (\n-                            <MarketCreatedLog\n-                              key={item.id}\n-                              contract={item}\n-                              showDescription={items.length === 1} // Maybe adjust this logic if needed\n-                            />\n-                          )\n-                        } else if ('userId' in item) {\n-                          const comment = item as CommentWithTotalReplies\n-                          const childReplies =\n-                            repliesByParentId[comment.id] ?? []\n-                          const hiddenRepliesCount =\n-                            (comment.totalReplies ?? 0) - childReplies.length\n-\n-                          return (\n-                            <div key={comment.id}>\n-                              <CommentLog\n-                                comment={comment}\n-                                privateUser={privateUser}\n-                                user={user}\n-                                router={router}\n-                                hiddenReplies={hiddenRepliesCount}\n-                              />\n-\n-                              {hiddenRepliesCount > 0 &&\n-                                childReplies.length > 0 && (\n-                                  <Row className=\"text-ink-400 ml-6 items-center gap-1 pb-2 pl-2 text-xs\">\n-                                    <div className=\"border-ink-400 w-5 border-b-[1px] border-l-[1px]\" />\n-                                    <button\n-                                      onClick={(e) => {\n-                                        e.stopPropagation()\n-                                        router.push(\n-                                          `/${comment.userUsername}/${comment.contractSlug}#${comment.id}`\n-                                        )\n-                                      }}\n-                                      className=\"hover:underline\"\n-                                    >\n-                                      {hiddenRepliesCount} more{' '}\n-                                      {hiddenRepliesCount === 1\n-                                        ? 'reply'\n-                                        : 'replies'}\n-                                    </button>\n-                                    <div className=\"border-ink-400 w-5 border-b-[1px] border-l-[1px]\" />\n-                                  </Row>\n-                                )}\n-\n-                              {childReplies.length > 0 && (\n-                                <Col className=\"ml-6 space-y-1 pl-2\">\n-                                  {childReplies.map((reply) => (\n-                                    <CommentLog\n-                                      key={reply.id}\n-                                      comment={reply}\n-                                      privateUser={privateUser}\n-                                      user={user}\n-                                      router={router}\n-                                      isReply={true} // Indicate this is a reply\n-                                    />\n-                                  ))}\n-                                </Col>\n-                              )}\n-                            </div>\n-                          )\n-                        }\n-                      })}\n-                    </div>\n-                  </Col>\n-\n-                  {contract.coverImageUrl && (\n-                    <img\n-                      src={contract.coverImageUrl}\n-                      alt=\"\"\n-                      className={clsx(\n-                        'rounded-md object-cover',\n-                        'h-12 w-12 sm:h-32 sm:w-32',\n-                        // Only hide on desktop if single bet\n-                        items.length === 1 &&\n-                          'amount' in items[0] &&\n-                          'sm:hidden'\n-                      )}\n-                    />\n-                  )}\n-                </Row>\n-              </Col>\n-            )\n-          })\n-        )}\n       </Col>\n-      {allData && (\n-        <div className=\"relative\">\n-          {loading && <LoadingIndicator />}\n-          <VisibilityObserver\n-            className=\"pointer-events-none absolute bottom-0 h-screen w-full select-none\"\n-            onVisibilityUpdated={(visible) => {\n-              if (visible && !loading) {\n-                setOffset(offset + limit)\n-                setTimeout(() => {\n-                  refresh()\n-                }, 100)\n-              }\n-            }}\n-          />\n-        </div>\n-      )}\n-    </Col>\n+    </>\n   )\n }\n \n const MarketCreatedLog = memo(\n@@ -535,8 +467,160 @@\n     )\n   }\n )\n \n+const ActivityLog = memo(function ActivityLog(props: {\n+  parentId: string\n+  items: [\n+    Contract | CommentWithTotalReplies | Bet,\n+    ...(Contract | CommentWithTotalReplies | Bet)[]\n+  ]\n+  contractsById: Record<string, Contract>\n+  privateUser: PrivateUser | null | undefined\n+  user: User | null | undefined\n+  router: NextRouter\n+}) {\n+  const { items, contractsById, parentId, privateUser, user, router } = props\n+  const contract = contractsById[parentId] as Contract\n+  const position = useSavedContractMetrics(contract)\n+\n+  // Separate comments and group replies\n+  const comments = items.filter(\n+    (item): item is CommentWithTotalReplies =>\n+      'userId' in item && !('question' in item) && !('amount' in item)\n+  )\n+  const replies = comments.filter((c) => !!c.replyToCommentId)\n+  const repliesByParentId = groupBy(\n+    orderBy(replies, 'createdTime', 'asc'), // Sort replies ascending\n+    'replyToCommentId'\n+  )\n+\n+  // Filter items to include non-comments and parent comments, sorted descending\n+  const displayItems = orderBy(\n+    items.filter(\n+      (item) =>\n+        !(\n+          'userId' in item && (item as CommentWithTotalReplies).replyToCommentId\n+        ) // Exclude replies from main list\n+    ),\n+    'createdTime',\n+    'desc'\n+  )\n+\n+  return (\n+    <Col\n+      className={clsx(\n+        'bg-canvas-0 dark:bg-canvas-50 dark:border-canvas-50 hover:border-primary-300 gap-2 rounded-lg border p-3 shadow-md transition-colors sm:px-5'\n+      )}\n+    >\n+      <Row className=\"gap-2\">\n+        <Col className=\"flex-1 gap-2\">\n+          <ContractMention\n+            contract={contract}\n+            trackingLocation={'site-activity'}\n+          />\n+          <div className=\"space-y-1\">\n+            {displayItems.map((item) => {\n+              if ('amount' in item) {\n+                // Render Bet\n+                return (\n+                  <FeedBet\n+                    className=\"p-1\"\n+                    key={`${item.id}-bet-${parentId}`}\n+                    contract={contract}\n+                    bet={item}\n+                    avatarSize=\"xs\"\n+                    hideActions={true}\n+                  />\n+                )\n+              } else if ('question' in item) {\n+                // Render Market Creation\n+                return (\n+                  <MarketCreatedLog\n+                    key={`${item.id}-market-created-${parentId}`}\n+                    contract={item}\n+                    showDescription={items.length === 1} // Maybe adjust this logic if needed\n+                  />\n+                )\n+              } else if ('userId' in item) {\n+                const comment = item as CommentWithTotalReplies\n+                const childReplies = repliesByParentId[comment.id] ?? []\n+                const hiddenRepliesCount =\n+                  (comment.totalReplies ?? 0) - childReplies.length\n+\n+                return (\n+                  <div key={`${comment.id}-comment-${parentId}`}>\n+                    <CommentLog\n+                      comment={comment}\n+                      privateUser={privateUser}\n+                      user={user}\n+                      router={router}\n+                      hiddenReplies={hiddenRepliesCount}\n+                    />\n+\n+                    {hiddenRepliesCount > 0 && childReplies.length > 0 && (\n+                      <Row className=\"text-ink-400 ml-6 items-center gap-1 pb-2 pl-2 text-xs\">\n+                        <div className=\"border-ink-400 w-5 border-b-[1px] border-l-[1px]\" />\n+                        <button\n+                          onClick={(e) => {\n+                            e.stopPropagation()\n+                            router.push(\n+                              `/${comment.userUsername}/${comment.contractSlug}#${comment.id}`\n+                            )\n+                          }}\n+                          className=\"hover:underline\"\n+                        >\n+                          {hiddenRepliesCount} more{' '}\n+                          {hiddenRepliesCount === 1 ? 'reply' : 'replies'}\n+                        </button>\n+                        <div className=\"border-ink-400 w-5 border-b-[1px] border-l-[1px]\" />\n+                      </Row>\n+                    )}\n+\n+                    {childReplies.length > 0 && (\n+                      <Col className=\"ml-6 space-y-1 pl-2\">\n+                        {childReplies.map((reply) => (\n+                          <CommentLog\n+                            key={`${reply.id}-reply-${parentId}`}\n+                            comment={reply}\n+                            privateUser={privateUser}\n+                            user={user}\n+                            router={router}\n+                            isReply={true} // Indicate this is a reply\n+                          />\n+                        ))}\n+                      </Col>\n+                    )}\n+                  </div>\n+                )\n+              }\n+            })}\n+          </div>\n+        </Col>\n+\n+        {contract.coverImageUrl && (\n+          <img\n+            src={contract.coverImageUrl}\n+            alt=\"\"\n+            className={clsx(\n+              'rounded-md object-cover',\n+              'h-12 w-12 sm:h-32 sm:w-32',\n+              // Only hide on desktop if single bet\n+              items.length === 1 && 'amount' in items[0] && 'sm:hidden'\n+            )}\n+          />\n+        )}\n+      </Row>\n+      {contract.outcomeType === 'BINARY' && position && position.hasShares && (\n+        <YourMetricsFooter\n+          metrics={position}\n+          isCashContract={contract.token === 'CASH'}\n+        />\n+      )}\n+    </Col>\n+  )\n+})\n+\n const CommentLog = memo(function FeedComment(props: {\n   comment: ContractComment\n   privateUser: PrivateUser | null | undefined\n   user: User | null | undefined\n"
        },
        {
          "path": "web/components/topics/topic-selector.tsx",
          "status": "modified",
          "diff": "Index: web/components/topics/topic-selector.tsx\n===================================================================\n--- web/components/topics/topic-selector.tsx\t16e0692 (parent)\n+++ web/components/topics/topic-selector.tsx\t75c3755 (commit)\n@@ -291,10 +291,18 @@\n export function MultiTopicPillSelector(props: {\n   topics: LiteGroup[]\n   setTopics: (topics: LiteGroup[]) => void\n   maxTopics?: number\n+  highlight?: boolean\n+  buttonClassName?: string\n }) {\n-  const { topics, setTopics, maxTopics = 10 } = props\n+  const {\n+    topics,\n+    setTopics,\n+    maxTopics = 10,\n+    highlight = false,\n+    buttonClassName,\n+  } = props\n   const { query, setQuery, searchedGroups } = useSearchGroups(false)\n \n   const toggleTopic = (topic: LiteGroup) => {\n     const isSelected = topics.some((t) => t.id === topic.id)\n@@ -348,10 +356,14 @@\n               onClick: () => toggleTopic(topic),\n             })),\n         ]}\n         buttonContent={(open) => (\n-          <DropdownPill open={open}>\n-            {topics.length === 0 ? 'All topics' : `${topics.length} topics`}\n+          <DropdownPill\n+            className={buttonClassName}\n+            open={open}\n+            color={highlight ? 'indigo' : 'gray'}\n+          >\n+            {topics.length === 0 ? 'All Topics' : `${topics.length} Topics`}\n           </DropdownPill>\n         )}\n       />\n     </div>\n"
        },
        {
          "path": "web/pages/explore/index.tsx",
          "status": "modified",
          "diff": "Index: web/pages/explore/index.tsx\n===================================================================\n--- web/pages/explore/index.tsx\t16e0692 (parent)\n+++ web/pages/explore/index.tsx\t75c3755 (commit)\n@@ -113,9 +113,9 @@\n     ...baseTabs.filter((tab) => !tabOrder.includes(tab.title)),\n   ]\n \n   return (\n-    <Col className=\"relative w-full p-1\">\n+    <Col className=\"relative w-full px-2\">\n       <DragDropContext\n         onDragEnd={(result) => {\n           if (!result.destination) return\n \n"
        }
      ]
    },
    {
      "id": "reinstate-referrals",
      "sha": "05cd89045485dbab7fc76388b18e9c38cb2ea455",
      "parentSha": "2c9045be73e11906b1aba7e6a3bcd5fa904af2d4",
      "spec": "Implement an end-to-end referral program with share-link attribution and a new backend endpoint.\n\nBackend API\n- Add a new authed POST endpoint 'refer-user' in backend/api/src/refer-user.ts and register it in backend/api/src/routes.ts and common/src/api/schema.ts.\n  - Props: { referredByUsername: string; contractId?: string }.\n  - Behavior:\n    - Look up the referring user by username; reject if not found or banned from posting.\n    - Get the authed user as the new user; reject if missing.\n    - If contractId is provided, fetch the contract; reject if not found.\n    - In a SERIAL transaction:\n      - Re-fetch the new user; ensure they have no existing referral details.\n      - Ensure the new user account is no older than MINUTES_ALLOWED_TO_REFER.\n      - Ensure there is no existing referral txn to the referring user for this referred user (category 'REFERRAL', data.referredUserId == newUser.id), otherwise reject.\n      - Create a bank-to-user M$ transaction to the referrer for REFERRAL_AMOUNT with data { referredUserId, referredContractId? }.\n      - Update the new user with { referredByUserId, referredByContractId? }.\n    - After commit, create a referral notification to the referrer with the bonus amount and (if present) the referring contract.\n    - Return { success: true }.\n\nNotifications\n- Update createReferralNotification signature and payload (backend/shared/src/create-notification.ts):\n  - New signature: (toUserId: string, referredUser: User, bonusAmount: string, referredByContract?: Contract).\n  - Set Notification.reason to 'user_joined_to_bet_on_your_market' if referredByContract.creatorId === toUserId; otherwise 'you_referred_user'.\n  - Populate source fields: sourceContractId, sourceContractTitle (question), sourceContractSlug, sourceContractCreatorUsername, and set sourceText to bonusAmount.\n\nRemove legacy referral flow\n- Delete backend/shared/src/distribute-referral-bonus.ts and remove all imports/usages, including from backend/api/src/gidx/complete-checkout-session.ts.\n- Remove REFERRAL_AMOUNT_CASH and REFERRAL_MIN_PURCHASE_DOLLARS from common/src/economy.ts and any code that relies on them (e.g., email copy in backend/shared/src/emails.ts).\n\nShare link utilities\n- Update common/src/util/share.ts:\n  - getShareUrl(contract, username?: string) to append referral query when username is provided.\n  - getTopicShareUrl(groupSlug, username?: string) to include referral query and use the /browse/{slug} path.\n  - Add referralQuery(username) which encodes the username into a short referral parameter '?r=' + base64(username) (strip '='), falling back to '?referrer=' + username.\n  - Remove getReferralCodeFromUser.\n\nClient referral capture and apply\n- Add a new hook web/hooks/use-save-referral.ts:\n  - Reads URL params: prefer 'r' (base64-decoded to username), fallback 'referrer'.\n  - Writes referral info to local storage if the viewer is not signed in (user === null). Accept an optional defaultReferrerUsername and contractId for implicit attribution (e.g., market creator).\n\n- Extend web/lib/firebase/users.ts:\n  - Implement writeReferralInfo(defaultReferrerUsername, { contractId?, explicitReferrer? }) to set/override cached referral username and optional contract id in local storage, with explicit referrer taking priority.\n  - Implement canSetReferrer(user) to gate referral assignment to new, humanish users without existing referrer and within MINUTES_ALLOWED_TO_REFER.\n  - Implement setCachedReferralInfoForUser(user) to call API 'refer-user' with cached details; mark completion in local storage; no-op on failure.\n\nIntegrate referral capture\n- Integrate useSaveReferral(user, options?) on high-traffic pages and views to capture referrals and default attributions:\n  - Contract pages: default referrer is contract.creatorUsername, include contractId.\n  - Pages such as dashboard (and variants), home, explore, browse, AI forecast, profile pages.\n  - After onboarding welcome (or when skipping), call setCachedReferralInfoForUser(user) to apply the referral promptly.\n\nShare/tweet buttons and QR\n- Update all share link invocations to pass the current user’s username to getShareUrl/getTopicShareUrl so outbound links carry referral.\n- Update tweet helper functions (web/components/buttons/tweet-button.tsx):\n  - getPositionTweet and getWinningTweet accept username and embed it in the shared URL.\n- Update share QR and copy-link components to use the referral-aware URLs.\n\nNavigation and referrals page\n- Add a sidebar navigation link to '/referrals'.\n- Implement the referrals page showing the personal referral link (domain + referralQuery(username)), QR code, and a brief explainer of the bonus amount.\n\nContract/topic share URLs\n- Ensure all instances of getShareUrl and getTopicShareUrl are updated to new signatures and paths across contract headers, creator panels, embeds, buttons, and topic title components.\n\nAnalytics\n- Track a public event when a referral is set on the backend (refer-user) including referredByUserId and optional referredByContractId.\n\nValidation and types\n- Ensure common/src/notification.ts supports the reasons used: 'you_referred_user' and 'user_joined_to_bet_on_your_market', and accepts the new source fields set in createReferralNotification.\n- Ensure API schema addition for 'refer-user' matches the handler’s expectations.\n\nAcceptance criteria\n- Visiting a shared link with '?r=<base64 username>' or '?referrer=<username>' while signed out caches the referrer and optional contract id.\n- Creating a new humanish account within the allowed time window automatically triggers a referral award to the referrer (M$ REFERRAL_AMOUNT) and sets referredBy fields on the new user; referrer receives an in-app notification, with market-aware reason when applicable.\n- All share links and tweets include the referral query when available.\n- Old purchase-based referral bonus logic is removed and no longer triggers any referral payouts.\n- The /referrals page shows a working personal link and QR code with the encoded referral query.",
      "prompt": "Reintroduce a full referral program: allow users to share links that append a short referral code, capture that referral code client-side for signed-out visitors, and upon signup attribute and reward the correct referrer. Add a public API to finalize the referral attribution and send a notification. Update site-wide share links and tweets to include referral info. Provide a simple referrals page and nav entry. Remove the previous purchase-triggered referral bonus and any unused constants or email content tied to it. Ensure attribution only applies to newly created, human-like accounts within a short time window.",
      "supplementalFiles": [
        "common/src/user.ts",
        "common/src/notification.ts",
        "backend/shared/src/supabase/init.ts",
        "web/lib/api/api.ts",
        "web/hooks/use-defined-search-params.ts",
        "web/lib/util/local.ts",
        "common/src/util/clean-username.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/gidx/complete-checkout-session.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/gidx/complete-checkout-session.ts\n===================================================================\n--- backend/api/src/gidx/complete-checkout-session.ts\t2c9045b (parent)\n+++ backend/api/src/gidx/complete-checkout-session.ts\t05cd890 (commit)\n@@ -1,27 +1,22 @@\n import { APIError, APIHandler } from 'api/helpers/endpoint'\n-import {\n-  PaymentAmount,\n-  REFERRAL_MIN_PURCHASE_DOLLARS,\n-  WEB_PRICES,\n-} from 'common/economy'\n+import { PaymentAmount, WEB_PRICES } from 'common/economy'\n import { SWEEP_PRODUCTION_ENABLED } from 'common/envs/constants'\n import {\n   CompleteSessionDirectCashierResponse,\n   ProcessSessionCode,\n } from 'common/gidx/gidx'\n import { User } from 'common/user'\n import { getIp, track, trackPublicEvent } from 'shared/analytics'\n-import { distributeReferralBonusIfNoneGiven } from 'shared/distribute-referral-bonus'\n import {\n   getGIDXStandardParams,\n   getLocalServerIP,\n   getUserRegistrationRequirements,\n   GIDX_BASE_URL,\n } from 'shared/gidx/helpers'\n import { log } from 'shared/monitoring/log'\n import { createSupabaseDirectClient } from 'shared/supabase/init'\n-import { getReferrerInfo, updateUser } from 'shared/supabase/users'\n+import { updateUser } from 'shared/supabase/users'\n import { runTxnInBetQueue } from 'shared/txn/run-txn'\n import { getUser, LOCAL_DEV } from 'shared/utils'\n \n const ENDPOINT = GIDX_BASE_URL + '/v3.0/api/DirectCashier/CompleteSession'\n@@ -247,11 +242,8 @@\n     category: 'CASH_BONUS',\n     description: `Free sweepcash bonus for purchasing mana.`,\n   } as const\n \n-  const referrerInfo = user.usedReferralCode\n-    ? await getReferrerInfo(pg, user.referredByUserId)\n-    : undefined\n   await pg.tx(async (tx) => {\n     await runTxnInBetQueue(tx, manaPurchaseTxn)\n     if (isSweepsVerified) {\n       await runTxnInBetQueue(tx, cashBonusTxn)\n@@ -259,16 +251,8 @@\n     await updateUser(tx, userId, {\n       purchasedMana: true,\n       purchasedSweepcash: isSweepsVerified,\n     })\n-    if (referrerInfo && paidInCents / 100 >= REFERRAL_MIN_PURCHASE_DOLLARS) {\n-      await distributeReferralBonusIfNoneGiven(\n-        tx,\n-        user,\n-        referrerInfo.id,\n-        referrerInfo.sweepsVerified\n-      )\n-    }\n   })\n \n   await trackPublicEvent(user.id, 'M$ purchase', {\n     amount: amount.mana,\n"
        },
        {
          "path": "backend/api/src/refer-user.ts",
          "status": "added",
          "diff": "Index: backend/api/src/refer-user.ts\n===================================================================\n--- backend/api/src/refer-user.ts\t2c9045b (parent)\n+++ backend/api/src/refer-user.ts\t05cd890 (commit)\n@@ -0,0 +1,131 @@\n+import { APIError, APIHandler } from 'api/helpers/endpoint'\n+import { MINUTES_ALLOWED_TO_REFER } from 'common/user'\n+import { Contract } from 'common/contract'\n+import { createSupabaseDirectClient, SERIAL_MODE } from 'shared/supabase/init'\n+import { REFERRAL_AMOUNT } from 'common/economy'\n+import { createReferralNotification } from 'shared/create-notification'\n+import { convertUser } from 'common/supabase/users'\n+import { first } from 'lodash'\n+import { log, getContractSupabase, getUser } from 'shared/utils'\n+import { runTxnFromBank } from 'shared/txn/run-txn'\n+import { MINUTE_MS } from 'common/util/time'\n+import { removeUndefinedProps } from 'common/util/object'\n+import { trackPublicEvent } from 'shared/analytics'\n+import { updateUser } from 'shared/supabase/users'\n+\n+export const referUser: APIHandler<'refer-user'> = async (props, auth) => {\n+  const { referredByUsername, contractId } = props\n+\n+  const pg = createSupabaseDirectClient()\n+  const referredByUser = first(\n+    await pg.map(\n+      `select * from users where username = $1`,\n+      [referredByUsername],\n+      (row) => convertUser(row)\n+    )\n+  )\n+  if (!referredByUser) {\n+    throw new APIError(404, `User ${referredByUsername} not found`)\n+  }\n+  if (referredByUser.isBannedFromPosting) {\n+    throw new APIError(\n+      404,\n+      `User ${referredByUsername} is banned from posting, not eligible for referral bonus`\n+    )\n+  }\n+  const newUser = await getUser(auth.uid)\n+  if (!newUser) {\n+    throw new APIError(401, `User ${auth.uid} not found`)\n+  }\n+  let referredByContract: Contract | undefined\n+  if (contractId) {\n+    referredByContract = await getContractSupabase(contractId)\n+    if (!referredByContract) {\n+      throw new APIError(404, `Contract ${contractId} not found`)\n+    }\n+    log(`referredByContract: ${referredByContract.slug}`)\n+  }\n+  await handleReferral(newUser.id, referredByUser.id, referredByContract)\n+  await trackPublicEvent(newUser.id, 'Referral', {\n+    referredByUserId: referredByUser.id,\n+    referredByContractId: contractId,\n+  })\n+\n+  return { success: true }\n+}\n+\n+async function handleReferral(\n+  newUserId: string,\n+  referredByUserId: string,\n+  referredByContract?: Contract\n+) {\n+  const pg = createSupabaseDirectClient()\n+  log(`referredByUserId: ${referredByUserId}`)\n+  const { txn, user } = await pg.tx({ mode: SERIAL_MODE }, async (tx) => {\n+    const newUser = await getUser(newUserId, tx)\n+    if (!newUser) throw new APIError(500, `User ${newUserId} not found`)\n+\n+    if (newUser.referredByUserId || newUser.referredByContractId) {\n+      throw new APIError(400, `User ${newUser.id} already has referral details`)\n+    }\n+    if (\n+      newUser.createdTime <\n+      Date.now() - MINUTES_ALLOWED_TO_REFER * MINUTE_MS\n+    ) {\n+      throw new APIError(400, `User ${newUser.id} is too old to be referred`)\n+    }\n+\n+    const txns = await tx.one(\n+      `select count(*) from txns where to_id = $1\n+       and category = 'REFERRAL'\n+       and data->>'referredUserId' = $2`,\n+      [referredByUserId, newUser.id],\n+      (row) => row.count\n+    )\n+\n+    // If the referring user already has a referral txn due to referring this user, halt\n+    // TODO: store in data instead\n+    if (txns > 0) {\n+      throw new APIError(\n+        404,\n+        'Existing referral bonus found with matching details'\n+      )\n+    }\n+    log('creating referral txns')\n+\n+    // if they're updating their referredId, create a txn for both\n+    const txnData = {\n+      fromType: 'BANK',\n+      toId: referredByUserId,\n+      toType: 'USER',\n+      amount: REFERRAL_AMOUNT,\n+      token: 'M$',\n+      category: 'REFERRAL',\n+      description: `Referred new user id: ${newUser.id} for ${REFERRAL_AMOUNT}`,\n+      data: removeUndefinedProps({\n+        referredUserId: newUser.id,\n+        referredContractId: referredByContract?.id,\n+      }),\n+    } as const\n+\n+    const txn = await runTxnFromBank(tx, txnData)\n+\n+    await updateUser(\n+      tx,\n+      newUserId,\n+      removeUndefinedProps({\n+        referredByUserId,\n+        referredByContractId: referredByContract?.id,\n+      })\n+    )\n+\n+    return { txn, user: newUser }\n+  })\n+\n+  await createReferralNotification(\n+    referredByUserId,\n+    user,\n+    txn.amount.toString(),\n+    referredByContract\n+  )\n+}\n"
        },
        {
          "path": "backend/api/src/routes.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/routes.ts\n===================================================================\n--- backend/api/src/routes.ts\t2c9045b (parent)\n+++ backend/api/src/routes.ts\t05cd890 (commit)\n@@ -173,9 +173,9 @@\n } from './generate-ai-date-ranges'\n import { inferNumericUnit } from './infer-numeric-unit'\n import { generateConciseTitle } from './generate-concise-title'\n import { getCloseDateEndpoint } from './get-close-date'\n-\n+import { referUser } from './refer-user'\n export const handlers: { [k in APIPath]: APIHandler<k> } = {\n   'refresh-all-clients': refreshAllClients,\n   bet: placeBet,\n   'multi-bet': placeMultiBet,\n@@ -360,5 +360,6 @@\n   'generate-ai-date-ranges': generateAIDateRanges,\n   'regenerate-date-midpoints': regenerateDateMidpoints,\n   'generate-concise-title': generateConciseTitle,\n   'get-close-date': getCloseDateEndpoint,\n+  'refer-user': referUser,\n }\n"
        },
        {
          "path": "backend/shared/src/create-notification.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/create-notification.ts\n===================================================================\n--- backend/shared/src/create-notification.ts\t2c9045b (parent)\n+++ backend/shared/src/create-notification.ts\t05cd890 (commit)\n@@ -10,9 +10,8 @@\n   NOTIFICATION_DESCRIPTIONS,\n   notification_reason_types,\n   NotificationReason,\n   PaymentCompletedData,\n-  ReferralData,\n   ReviewNotificationData,\n   UniqueBettorData,\n } from 'common/notification'\n import {\n@@ -690,9 +689,10 @@\n \n export const createReferralNotification = async (\n   toUserId: string,\n   referredUser: User,\n-  bonusAmounts: ReferralData\n+  bonusAmount: string,\n+  referredByContract?: Contract\n ) => {\n   const privateUser = await getPrivateUser(toUserId)\n   if (!privateUser) return\n   const { sendToBrowser } = getNotificationDestinationsForUser(\n@@ -703,19 +703,29 @@\n \n   const notification: Notification = {\n     id: referredUser.id + '-signup-referral-bonus',\n     userId: toUserId,\n-    reason: 'you_referred_user',\n+    reason:\n+      referredByContract?.creatorId === toUserId\n+        ? 'user_joined_to_bet_on_your_market'\n+        : 'you_referred_user',\n     createdTime: Date.now(),\n     isSeen: false,\n     sourceId: referredUser.id,\n     sourceType: 'user',\n+    sourceContractId: referredByContract?.id,\n+\n     sourceUpdateType: 'updated',\n     sourceUserName: referredUser.name,\n     sourceUserUsername: referredUser.username,\n     sourceUserAvatarUrl: referredUser.avatarUrl,\n-    sourceText: '',\n-    data: bonusAmounts,\n+    sourceText: bonusAmount,\n+    // Only pass the contract referral details if they weren't referred to a group\n+    sourceContractCreatorUsername: referredByContract?.creatorUsername,\n+    sourceContractTitle: referredByContract?.question,\n+    sourceContractSlug: referredByContract?.slug,\n+    sourceSlug: referredByContract?.slug,\n+    sourceTitle: referredByContract?.question,\n   }\n   const pg = createSupabaseDirectClient()\n   await insertNotificationToSupabase(notification, pg)\n   // TODO send email notification\n"
        },
        {
          "path": "backend/shared/src/distribute-referral-bonus.ts",
          "status": "deleted",
          "diff": "Index: backend/shared/src/distribute-referral-bonus.ts\n===================================================================\n--- backend/shared/src/distribute-referral-bonus.ts\t2c9045b (parent)\n+++ backend/shared/src/distribute-referral-bonus.ts\t05cd890 (commit)\n@@ -1,75 +0,0 @@\n-import { SupabaseTransaction } from 'shared/supabase/init'\n-import { runTxnFromBank } from 'shared/txn/run-txn'\n-import { REFERRAL_AMOUNT, REFERRAL_AMOUNT_CASH } from 'common/economy'\n-import { createReferralNotification } from './create-notification'\n-import { User } from 'common/user'\n-\n-export async function distributeReferralBonusIfNoneGiven(\n-  tx: SupabaseTransaction,\n-  user: User,\n-  referrerId: string,\n-  referrerSweepsVerified: boolean | undefined\n-) {\n-  const userId = user.id\n-  const previousReferralTxn = await tx.oneOrNone(\n-    `select 1 from txns where to_id = $1\n-           and category = 'REFERRAL'\n-           and token = 'M$'\n-           and data->'data'->>'referredById' = $2`,\n-    [userId, referrerId]\n-  )\n-  if (previousReferralTxn) {\n-    return\n-  }\n-  await runTxnFromBank(tx, {\n-    category: 'REFERRAL',\n-    token: 'M$',\n-    amount: REFERRAL_AMOUNT,\n-    fromType: 'BANK',\n-    toType: 'USER',\n-    toId: userId,\n-    data: {\n-      referredById: referrerId,\n-    },\n-  })\n-  await runTxnFromBank(tx, {\n-    category: 'REFERRAL',\n-    token: 'CASH',\n-    amount: REFERRAL_AMOUNT_CASH,\n-    fromType: 'BANK',\n-    toType: 'USER',\n-    toId: userId,\n-    data: {\n-      referredById: referrerId,\n-    },\n-  })\n-\n-  await runTxnFromBank(tx, {\n-    category: 'REFERRAL',\n-    token: 'M$',\n-    amount: REFERRAL_AMOUNT,\n-    fromType: 'BANK',\n-    toType: 'USER',\n-    toId: referrerId,\n-    data: {\n-      referredId: userId,\n-    },\n-  })\n-  if (referrerSweepsVerified) {\n-    await runTxnFromBank(tx, {\n-      category: 'REFERRAL',\n-      token: 'CASH',\n-      amount: REFERRAL_AMOUNT_CASH,\n-      fromType: 'BANK',\n-      toType: 'USER',\n-      toId: referrerId,\n-      data: {\n-        referredId: userId,\n-      },\n-    })\n-  }\n-  await createReferralNotification(referrerId, user, {\n-    manaAmount: REFERRAL_AMOUNT,\n-    cashAmount: referrerSweepsVerified ? REFERRAL_AMOUNT_CASH : 0,\n-  })\n-}\n"
        },
        {
          "path": "backend/shared/src/emails.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/emails.ts\n===================================================================\n--- backend/shared/src/emails.ts\t2c9045b (parent)\n+++ backend/shared/src/emails.ts\t05cd890 (commit)\n@@ -8,9 +8,8 @@\n   MultiContract,\n   renderResolution,\n } from 'common/contract'\n import { PrivateUser, User } from 'common/user'\n-import { getReferralCodeFromUser } from 'common/util/share'\n import {\n   formatLargeNumber,\n   formatMoney,\n   formatSweepies,\n@@ -34,9 +33,8 @@\n   createSupabaseDirectClient,\n } from 'shared/supabase/init'\n import { getLoverRow } from 'common/love/lover'\n import { HOUR_MS } from 'common/util/time'\n-import { REFERRAL_AMOUNT, REFERRAL_AMOUNT_CASH } from 'common/economy'\n \n export type PerContractInvestmentsData = {\n   questionTitle: string\n   questionUrl: string\n@@ -540,14 +538,8 @@\n     'interesting-markets',\n     {\n       name: firstName,\n       unsubscribeUrl,\n-      referralCode: getReferralCodeFromUser(privateUser.id),\n-      referralManaAmount: formatMoney(REFERRAL_AMOUNT).replace(\n-        ENV_CONFIG.moneyMoniker,\n-        ''\n-      ),\n-      referralCashAmount: REFERRAL_AMOUNT_CASH.toFixed(0),\n       question1Title: contractsToSend[0].question,\n       question1Link: contractUrl(contractsToSend[0]),\n       question1ImgSrc: imageSourceUrl(contractsToSend[0]),\n       question2Title: contractsToSend[1].question,\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\t2c9045b (parent)\n+++ common/src/api/schema.ts\t05cd890 (commit)\n@@ -2302,8 +2302,20 @@\n       })\n       .strict(),\n     returns: {} as { closeTime: number },\n   },\n+  'refer-user': {\n+    method: 'POST',\n+    visibility: 'public',\n+    authed: true,\n+    props: z\n+      .object({\n+        referredByUsername: z.string(),\n+        contractId: z.string().optional(),\n+      })\n+      .strict(),\n+    returns: {} as { success: boolean },\n+  },\n } as const)\n \n export type APIPath = keyof typeof API\n export type APISchema<N extends APIPath> = (typeof API)[N]\n"
        },
        {
          "path": "common/src/economy.ts",
          "status": "modified",
          "diff": "Index: common/src/economy.ts\n===================================================================\n--- common/src/economy.ts\t2c9045b (parent)\n+++ common/src/economy.ts\t05cd890 (commit)\n@@ -46,10 +46,8 @@\n export const SUS_STARTING_BALANCE = 10\n export const PHONE_VERIFICATION_BONUS = 1000\n \n export const REFERRAL_AMOUNT = 1_000\n-export const REFERRAL_AMOUNT_CASH = 10.0\n-export const REFERRAL_MIN_PURCHASE_DOLLARS = 20\n \n const uniqueBettorBonusAmounts = [3, 10, 15, 20]\n export const getUniqueBettorBonusAmount = (\n   liquidity: number,\n"
        },
        {
          "path": "common/src/util/share.ts",
          "status": "modified",
          "diff": "Index: common/src/util/share.ts\n===================================================================\n--- common/src/util/share.ts\t2c9045b (parent)\n+++ common/src/util/share.ts\t05cd890 (commit)\n@@ -1,11 +1,23 @@\n import { Contract } from 'common/contract'\n import { ENV_CONFIG } from 'common/envs/constants'\n \n-export const getShareUrl = (contract: Contract) =>\n-  `https://${ENV_CONFIG.domain}/${contract.creatorUsername}/${contract.slug}`\n+export const getShareUrl = (contract: Contract, username: string | undefined) =>\n+  `https://${ENV_CONFIG.domain}/${contract.creatorUsername}/${contract.slug}${\n+    username ? referralQuery(username) : ''\n+  }`\n \n-export const getTopicShareUrl = (groupSlug: string) =>\n-  `https://${ENV_CONFIG.domain}/topic/${groupSlug}`\n+export const getTopicShareUrl = (\n+  groupSlug: string,\n+  username: string | undefined\n+) =>\n+  `https://${ENV_CONFIG.domain}/browse/${groupSlug}${\n+    username ? referralQuery(username) : ''\n+  }`\n \n-export const getReferralCodeFromUser = (userId: string | undefined) =>\n-  (userId?.slice(0, 5) ?? '').toUpperCase().replace(/0/g, '#')\n+export const referralQuery = (username: string) => {\n+  try {\n+    return '?r=' + btoa(username).replace(/=/g, '')\n+  } catch (e) {\n+    return '?referrer=' + username\n+  }\n+}\n"
        },
        {
          "path": "web/components/ai-forecast.tsx",
          "status": "modified",
          "diff": "Index: web/components/ai-forecast.tsx\n===================================================================\n--- web/components/ai-forecast.tsx\t2c9045b (parent)\n+++ web/components/ai-forecast.tsx\t05cd890 (commit)\n@@ -25,8 +25,10 @@\n import { LiaKiwiBirdSolid } from 'react-icons/lia'\n import TooltipComponent from 'web/components/widgets/tooltip'\n import { SizedBinaryChart } from 'web/components/charts/contract/binary'\n import { getBetPoints } from 'common/bets'\n+import { useUser } from 'web/hooks/use-user'\n+import { useSaveReferral } from 'web/hooks/use-save-referral'\n \n // Shared background pattern for all cards\n const BG_PATTERN_LIGHT =\n   \"bg-[url(\\\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23000000' fill-opacity='0.02' fill-rule='evenodd'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/svg%3E\\\")]\"\n@@ -488,9 +490,9 @@\n     () => contracts.find((c) => c.id === marketId),\n     [contracts, marketId]\n   )\n \n-  // Always call hooks unconditionally\n+  // eslint-disable-next-line react-hooks/rules-of-hooks\n   const liveContract = contract ? useLiveContract(contract) : null\n \n   // Get the expected value if it's a numeric contract\n   const numericValue =\n@@ -1011,8 +1013,9 @@\n     })\n   }, [cards, contracts])\n \n   const contractsWithLiveData = contractsWithLive.map(({ card, contract }) => {\n+    // eslint-disable-next-line react-hooks/rules-of-hooks\n     const liveContract = contract ? useLiveContract(contract) : null\n     return { card, contract, liveContract }\n   })\n \n@@ -1169,12 +1172,15 @@\n   whenAgi,\n   contracts = [],\n   hideTitle,\n }: AIForecastProps) {\n+  // eslint-disable-next-line react-hooks/rules-of-hooks\n   const liveWhenAgi = whenAgi && whenAgi.id ? useLiveContract(whenAgi) : null\n   const expectedValueAGI = liveWhenAgi\n     ? getNumberExpectedValue(liveWhenAgi)\n     : 2030\n+  const user = useUser()\n+  useSaveReferral(user)\n   const eventYear = Math.floor(expectedValueAGI)\n   const eventMonth = Math.round((expectedValueAGI - eventYear) * 12)\n   const expectedYear = new Date(eventYear, eventMonth, 1)\n \n"
        },
        {
          "path": "web/components/bet/bet-summary.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/bet-summary.tsx\n===================================================================\n--- web/components/bet/bet-summary.tsx\t2c9045b (parent)\n+++ web/components/bet/bet-summary.tsx\t05cd890 (commit)\n@@ -20,8 +20,9 @@\n import { NoLabel, YesLabel } from '../outcome-label'\n import { ProfitBadge } from '../profit-badge'\n import { InfoTooltip } from '../widgets/info-tooltip'\n import { MoneyDisplay } from './money-display'\n+import { useUser } from 'web/hooks/use-user'\n \n export function UserBetsSummary(props: {\n   contract: Contract\n   initialMetrics?: ContractMetric\n@@ -77,8 +78,9 @@\n   const isStonk = outcomeType === 'STONK'\n   const mainBinaryMCAnswer = getMainBinaryMCAnswer(contract)\n   const prob = contract.mechanism === 'cpmm-1' ? getProbability(contract) : 0\n   const expectation = prob * yesWinnings + (1 - prob) * noWinnings\n+  const user = useUser()\n \n   if (metrics.invested === 0 && metrics.profit === 0) return null\n \n   const isCashContract = contract.token === 'CASH'\n@@ -244,9 +246,13 @@\n             {areYourBets ? 'You' : 'They'} made{' '}\n             <MoneyDisplay amount={profit} isCashContract={isCashContract} /> in\n             profit!{' '}\n             <TweetButton\n-              tweetText={getWinningTweet(profit, contract)}\n+              tweetText={getWinningTweet(\n+                profit,\n+                contract,\n+                user?.username ?? ''\n+              )}\n               className=\"ml-2\"\n             />\n           </div>\n         </Row>\n"
        },
        {
          "path": "web/components/bet/sell-row.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/sell-row.tsx\n===================================================================\n--- web/components/bet/sell-row.tsx\t2c9045b (parent)\n+++ web/components/bet/sell-row.tsx\t05cd890 (commit)\n@@ -95,9 +95,10 @@\n             <TweetButton\n               tweetText={getPositionTweet(\n                 (sharesOutcome === 'NO' ? -1 : 1) * shares,\n                 metric.invested,\n-                contract\n+                contract,\n+                user?.username ?? ''\n               )}\n             />\n           )}\n         </Row>\n"
        },
        {
          "path": "web/components/buttons/referrals-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/buttons/referrals-button.tsx\n===================================================================\n--- web/components/buttons/referrals-button.tsx\t2c9045b (parent)\n+++ web/components/buttons/referrals-button.tsx\t05cd890 (commit)\n@@ -2,9 +2,8 @@\n import { DisplayUser } from 'common/api/user-types'\n import { REFERRAL_AMOUNT } from 'common/economy'\n import { getReferralCount } from 'common/supabase/referrals'\n import { User } from 'common/user'\n-import { getReferralCodeFromUser } from 'common/util/share'\n import { useEffect, useState } from 'react'\n import { CopyLinkRow } from 'web/components/buttons/copy-link-button'\n import { Row } from 'web/components/layout/row'\n import { Avatar } from 'web/components/widgets/avatar'\n@@ -17,8 +16,10 @@\n import { getReferrals } from 'web/lib/supabase/referrals'\n import { Col } from '../layout/col'\n import { CASH_COLOR } from '../portfolio/portfolio-graph'\n import { Subtitle } from '../widgets/subtitle'\n+import { ENV_CONFIG } from 'common/envs/constants'\n+import { referralQuery } from 'common/util/share'\n \n export const useReferralCount = (user: User) => {\n   const [referralCount, setReferralCount] = useState(0)\n   useEffect(() => {\n@@ -41,9 +42,11 @@\n   const currentUser = useUser()\n   const isYou = currentUser?.id === user.id\n \n   const referredByUser = useDisplayUserById(user.referredByUserId)\n-  const url = getReferralCodeFromUser(currentUser?.id)\n+  const url = `https://${ENV_CONFIG.domain}${referralQuery(\n+    user?.username ?? ''\n+  )}`\n \n   return (\n     <Col className=\"bg-canvas-0 rounded p-6\">\n       {isYou && (\n"
        },
        {
          "path": "web/components/buttons/share-qr-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/buttons/share-qr-button.tsx\n===================================================================\n--- web/components/buttons/share-qr-button.tsx\t2c9045b (parent)\n+++ web/components/buttons/share-qr-button.tsx\t05cd890 (commit)\n@@ -4,16 +4,17 @@\n import { useState } from 'react'\n import { Modal } from '../layout/modal'\n import { QRCode } from '../widgets/qr-code'\n import { Button } from './button'\n+import { useUser } from 'web/hooks/use-user'\n \n export function ShareQRButton(props: {\n   contract: Contract\n   className?: string\n }) {\n   const { contract, className } = props\n-  const shareUrl = getShareUrl(contract)\n-\n+  const user = useUser()\n+  const shareUrl = getShareUrl(contract, user?.username)\n   const [open, setOpen] = useState(false)\n \n   return (\n     <>\n"
        },
        {
          "path": "web/components/buttons/tweet-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/buttons/tweet-button.tsx\n===================================================================\n--- web/components/buttons/tweet-button.tsx\t2c9045b (parent)\n+++ web/components/buttons/tweet-button.tsx\t05cd890 (commit)\n@@ -41,21 +41,30 @@\n \n export const getPositionTweet = (\n   position: number,\n   invested: number,\n-  contract: Contract\n+  contract: Contract,\n+  username: string\n ) => {\n   const p = invested / Math.abs(position)\n   const prob = formatPercent(position > 0 ? p : 1 - p)\n   const side = position > 0 ? 'greater' : 'less'\n \n   return `I'm predicting there's a ${side} than ${prob} chance. ${getShareUrl(\n-    contract\n+    contract,\n+    username\n   )}`\n }\n \n-export const getWinningTweet = (profit: number, contract: Contract) => {\n+export const getWinningTweet = (\n+  profit: number,\n+  contract: Contract,\n+  username: string\n+) => {\n   const isCashContract = contract.token === 'CASH'\n   return `I made ${isCashContract ? SWEEPIES_MONIKER : 'M$'}${formatMoneyNumber(\n     profit\n-  )} in profit trading on\\n'${contract.question}'! ${getShareUrl(contract)}`\n+  )} in profit trading on\\n'${contract.question}'! ${getShareUrl(\n+    contract,\n+    username\n+  )}`\n }\n"
        },
        {
          "path": "web/components/contract/contract-page.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-page.tsx\n===================================================================\n--- web/components/contract/contract-page.tsx\t2c9045b (parent)\n+++ web/components/contract/contract-page.tsx\t05cd890 (commit)\n@@ -75,8 +75,9 @@\n import { api } from 'web/lib/api/api'\n import { shouldHideGraph } from 'common/contract-params'\n import { CreatorSharePanel, NonCreatorSharePanel } from './creator-share-panel'\n import { FollowMarketButton } from '../buttons/follow-market-button'\n+import { useSaveReferral } from 'web/hooks/use-save-referral'\n \n export function ContractPageContent(props: ContractParams) {\n   const {\n     comments,\n@@ -103,9 +104,12 @@\n \n   const liveContract =\n     !isPlay && liveCashContract ? liveCashContract : livePlayContract\n   const user = useUser()\n-\n+  useSaveReferral(user, {\n+    defaultReferrerUsername: props.contract.creatorUsername,\n+    contractId: props.contract.id,\n+  })\n   // Read and set play state from the query\n   useEffect(() => {\n     if (!router.isReady) return\n     const playQuery = router.query.play\n"
        },
        {
          "path": "web/components/contract/creator-share-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/creator-share-panel.tsx\n===================================================================\n--- web/components/contract/creator-share-panel.tsx\t2c9045b (parent)\n+++ web/components/contract/creator-share-panel.tsx\t05cd890 (commit)\n@@ -16,8 +16,9 @@\n import { getUniqueBettorBonusAmount } from 'common/economy'\n import { AddBoostButton } from './add-boost-button'\n import { BoostAnalytics } from './boost-analytics'\n import { Col } from '../layout/col'\n+import { useUser } from 'web/hooks/use-user'\n \n export function CreatorSharePanel(props: { contract: Contract }) {\n   const { contract } = props\n   return (\n@@ -29,9 +30,12 @@\n           )}\n           <AddBoostButton contract={contract} />\n           <ShareLinkButton contract={contract} />\n           <TweetButton\n-            tweetText={'I created a question. ' + getShareUrl(contract)}\n+            tweetText={\n+              'I created a question. ' +\n+              getShareUrl(contract, contract.creatorUsername)\n+            }\n             className=\"hidden sm:flex\"\n           />\n           {contract.outcomeType == 'BOUNTIED_QUESTION' && (\n             <CancelBountyButton contract={contract} />\n@@ -72,9 +76,9 @@\n       <AddBoostButton contract={contract} />\n       {children}\n       <ShareLinkButton contract={contract} />\n       <TweetButton\n-        tweetText={getShareUrl(contract)}\n+        tweetText={getShareUrl(contract, contract.creatorUsername)}\n         className=\"hidden sm:flex\"\n       />\n     </Row>\n   )\n@@ -82,9 +86,10 @@\n \n const ShareLinkButton = (props: { contract: Contract; className?: string }) => {\n   const { contract, className } = props\n   const { isNative } = useNativeInfo()\n-  const url = getShareUrl(contract)\n+  const user = useUser()\n+  const url = getShareUrl(contract, user?.username)\n \n   const onClick = () => {\n     if (!url) return\n     copyToClipboard(url)\n"
        },
        {
          "path": "web/components/contract/header-actions.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/header-actions.tsx\n===================================================================\n--- web/components/contract/header-actions.tsx\t2c9045b (parent)\n+++ web/components/contract/header-actions.tsx\t05cd890 (commit)\n@@ -278,9 +278,9 @@\n         />\n       )}\n       <FollowMarketIconButton contract={currentContract} user={user} />\n       <CopyLinkOrShareButton\n-        url={getShareUrl(currentContract)}\n+        url={getShareUrl(currentContract, user?.username)}\n         tooltip=\"Copy question share link\"\n         className=\"text-ink-500 hover:text-ink-600\"\n         size=\"xs\"\n         eventTrackingName=\"copy market link\"\n"
        },
        {
          "path": "web/components/dashboard/dashboard-page.tsx",
          "status": "modified",
          "diff": "Index: web/components/dashboard/dashboard-page.tsx\n===================================================================\n--- web/components/dashboard/dashboard-page.tsx\t2c9045b (parent)\n+++ web/components/dashboard/dashboard-page.tsx\t05cd890 (commit)\n@@ -30,8 +30,10 @@\n import { type Contract } from 'common/contract'\n import { UserHovercard } from '../user/user-hovercard'\n import clsx from 'clsx'\n import { useSaveCampaign } from 'web/hooks/use-save-campaign'\n+import { referralQuery } from 'common/util/share'\n+import { useSaveReferral } from 'web/hooks/use-save-referral'\n \n export type DashboardEndpoints = 'news' | 'politics' | 'ai'\n \n export function DashboardPage(props: {\n@@ -45,8 +47,9 @@\n   endpoint: DashboardEndpoints\n   className?: string\n }) {\n   const user = useUser()\n+  useSaveReferral(user)\n   useSaveCampaign()\n \n   const router = useRouter()\n   const pathName = usePathname() ?? ''\n@@ -137,9 +140,11 @@\n               <Title className=\"!mb-0 \">{dashboard.title}</Title>\n \n               <div className=\"flex items-center\">\n                 <CopyLinkOrShareButton\n-                  url={`https://${ENV_CONFIG.domain}/${endpoint}/${slug}`}\n+                  url={`https://${ENV_CONFIG.domain}/${endpoint}/${slug}${\n+                    user?.username ? referralQuery(user.username) : ''\n+                  }`}\n                   eventTrackingName=\"copy dashboard link\"\n                   tooltip=\"Share\"\n                 />\n \n"
        },
        {
          "path": "web/components/dashboard/horizontal-dashboard.tsx",
          "status": "modified",
          "diff": "Index: web/components/dashboard/horizontal-dashboard.tsx\n===================================================================\n--- web/components/dashboard/horizontal-dashboard.tsx\t2c9045b (parent)\n+++ web/components/dashboard/horizontal-dashboard.tsx\t05cd890 (commit)\n@@ -17,16 +17,20 @@\n } from '../news/dashboard-news-item'\n import { Carousel } from '../widgets/carousel'\n import { DashboardText } from './dashboard-text-card'\n import { HorizontalDashboardCard } from './horizontal-dashboard-card'\n+import { useUser } from 'web/hooks/use-user'\n+import { useSaveReferral } from 'web/hooks/use-save-referral'\n \n export function HorizontalDashboard(props: {\n   initialDashboard: Dashboard\n   previews: LinkPreviews\n   initialContracts: Contract[]\n   slug: string\n }) {\n   const { initialDashboard, slug, previews, initialContracts } = props\n+  const user = useUser()\n+  useSaveReferral(user)\n   const fetchedDashboard = useDashboardFromSlug(slug)\n   const [dashboard, setDashboard] = useState<Dashboard>(initialDashboard)\n \n   // Update the dashboard state if a new fetchedDashboard becomes available\n"
        },
        {
          "path": "web/components/dashboard/politics-dashboard-page.tsx",
          "status": "modified",
          "diff": "Index: web/components/dashboard/politics-dashboard-page.tsx\n===================================================================\n--- web/components/dashboard/politics-dashboard-page.tsx\t2c9045b (parent)\n+++ web/components/dashboard/politics-dashboard-page.tsx\t05cd890 (commit)\n@@ -27,9 +27,9 @@\n import { Headline } from 'common/news'\n import { type Contract } from 'common/contract'\n import clsx from 'clsx'\n import { DashboardEndpoints } from 'web/components/dashboard/dashboard-page'\n-\n+import { useSaveReferral } from 'web/hooks/use-save-referral'\n export function PoliticsDashboardPage(props: {\n   initialDashboard: Dashboard\n   previews: LinkPreviews\n   initialContracts: Contract[]\n@@ -40,8 +40,9 @@\n   endpoint: DashboardEndpoints\n   className?: string\n }) {\n   const user = useUser()\n+  useSaveReferral(user)\n   const router = useRouter()\n   const pathName = usePathname() ?? ''\n \n   const {\n"
        },
        {
          "path": "web/components/nav/sidebar.tsx",
          "status": "modified",
          "diff": "Index: web/components/nav/sidebar.tsx\n===================================================================\n--- web/components/nav/sidebar.tsx\t2c9045b (parent)\n+++ web/components/nav/sidebar.tsx\t05cd890 (commit)\n@@ -7,8 +7,9 @@\n   LoginIcon,\n   SearchIcon,\n   GlobeAltIcon,\n   ChatIcon,\n+  StarIcon,\n } from '@heroicons/react/outline'\n // import { PiTelevisionSimple } from 'react-icons/pi'\n import TrophyIcon from 'web/lib/icons/trophy-icon.svg'\n import clsx from 'clsx'\n@@ -144,8 +145,13 @@\n       //   href: '/tv',\n       //   icon: PiTelevisionSimple,\n       // },\n       {\n+        name: 'Share with friends',\n+        href: '/referrals',\n+        icon: StarIcon,\n+      },\n+      {\n         name: 'Notifications',\n         href: `/notifications`,\n         icon: NotificationsIcon,\n       },\n@@ -171,8 +177,10 @@\n   const { isAdminOrMod } = options\n \n   return buildArray<NavItem>(\n     { name: 'Leagues', href: '/leagues', icon: TrophyIcon },\n+    { name: 'Share with friends', href: '/referrals', icon: StarIcon }, // remove this and I will beat you — SG\n+\n     // { name: 'TV', href: '/tv', icon: PiTelevisionSimple },\n     isAdminOrMod && {\n       name: 'Reports',\n       href: '/reports',\n"
        },
        {
          "path": "web/components/onboarding/welcome.tsx",
          "status": "modified",
          "diff": "Index: web/components/onboarding/welcome.tsx\n===================================================================\n--- web/components/onboarding/welcome.tsx\t2c9045b (parent)\n+++ web/components/onboarding/welcome.tsx\t05cd890 (commit)\n@@ -33,8 +33,9 @@\n import { getSavedContractVisitsLocally } from 'web/hooks/use-save-visits'\n import { capitalize } from 'lodash'\n import { TRADE_TERM } from 'common/envs/constants'\n import { convertGroup } from 'common/supabase/groups'\n+import { setCachedReferralInfoForUser } from 'web/lib/firebase/users'\n \n export const DEFAULT_FOR_YOU = false\n const SHOW_TOPICS = false\n \n@@ -61,11 +62,15 @@\n     setPage(page)\n   }\n \n   useEffect(() => {\n+    if (!user) return\n     if (shouldShowWelcomeModal) {\n       track('welcome screen: landed')\n       setOpen(true)\n+    } else {\n+      // Wait until after they've had the opportunity to change their name\n+      setCachedReferralInfoForUser(user)\n     }\n   }, [shouldShowWelcomeModal])\n \n   const [userInterestedTopics, setUserInterestedTopics] = useState<Group[]>([])\n"
        },
        {
          "path": "web/components/topics/questions-topic-title.tsx",
          "status": "modified",
          "diff": "Index: web/components/topics/questions-topic-title.tsx\n===================================================================\n--- web/components/topics/questions-topic-title.tsx\t2c9045b (parent)\n+++ web/components/topics/questions-topic-title.tsx\t05cd890 (commit)\n@@ -14,9 +14,8 @@\n // import { TopicDropdown } from 'web/components/topics/topic-dropdown'\n import { useIsMobile } from 'web/hooks/use-is-mobile'\n import { TOPIC_IDS_YOU_CANT_FOLLOW } from 'common/supabase/groups'\n import { getTopicShareUrl } from 'common/util/share'\n-import { useRouter } from 'next/router'\n import { useUser } from 'web/hooks/use-user'\n \n export const QuestionsTopicTitle = forwardRef(\n   (props: { topic: Group; addAbout: () => void }, ref: Ref<HTMLDivElement>) => {\n@@ -25,9 +24,8 @@\n     const [showAddContract, setShowAddContract] = useState(false)\n     const [loading, setLoading] = useState(false)\n     const user = useUser()\n     const isMobile = useIsMobile()\n-    const router = useRouter()\n \n     return (\n       <Row\n         className={\n@@ -39,9 +37,9 @@\n           {topic.name}\n         </h1>\n         <Row>\n           <CopyLinkOrShareButton\n-            url={getTopicShareUrl(topic.slug)}\n+            url={getTopicShareUrl(topic.slug, user?.username)}\n             className={'gap-1 whitespace-nowrap'}\n             eventTrackingName={'copy questions page link'}\n             size={isMobile ? 'sm' : 'md'}\n           >\n"
        },
        {
          "path": "web/hooks/use-save-referral.ts",
          "status": "added",
          "diff": "Index: web/hooks/use-save-referral.ts\n===================================================================\n--- web/hooks/use-save-referral.ts\t2c9045b (parent)\n+++ web/hooks/use-save-referral.ts\t05cd890 (commit)\n@@ -0,0 +1,34 @@\n+import { cleanUsername } from 'common/util/clean-username'\n+import { useEffect } from 'react'\n+\n+import { User, writeReferralInfo } from 'web/lib/firebase/users'\n+import { useDefinedSearchParams } from 'web/hooks/use-defined-search-params'\n+\n+export const useSaveReferral = (\n+  user: User | null | undefined,\n+  options?: {\n+    defaultReferrerUsername?: string\n+    contractId?: string\n+  }\n+) => {\n+  const { searchParams } = useDefinedSearchParams()\n+\n+  useEffect(() => {\n+    const referrer = searchParams.get('r')\n+      ? decodeBase64(searchParams.get('r') as string)\n+      : (searchParams.get('referrer') as string)\n+\n+    const referrerOrDefault = referrer || options?.defaultReferrerUsername\n+\n+    if (user === null && referrerOrDefault) {\n+      writeReferralInfo(referrerOrDefault, {\n+        contractId: options?.contractId,\n+        explicitReferrer: referrer,\n+      })\n+    }\n+  }, [user, searchParams, JSON.stringify(options)])\n+}\n+\n+const decodeBase64 = (base64: string) => {\n+  return Buffer.from(cleanUsername(base64), 'base64').toString()\n+}\n"
        },
        {
          "path": "web/lib/firebase/users.ts",
          "status": "modified",
          "diff": "Index: web/lib/firebase/users.ts\n===================================================================\n--- web/lib/firebase/users.ts\t2c9045b (parent)\n+++ web/lib/firebase/users.ts\t05cd890 (commit)\n@@ -1,6 +1,11 @@\n import { Contract } from 'common/contract'\n-import { PrivateUser, User } from 'common/user'\n+import {\n+  humanish,\n+  MINUTES_ALLOWED_TO_REFER,\n+  PrivateUser,\n+  User,\n+} from 'common/user'\n import dayjs from 'dayjs'\n import utc from 'dayjs/plugin/utc'\n import {\n   GoogleAuthProvider,\n@@ -11,15 +16,80 @@\n import { nativeSignOut } from 'web/lib/native/native-messages'\n import { postMessageToNative } from 'web/lib/native/post-message'\n import { getFirebaseAuth } from './auth'\n dayjs.extend(utc)\n+import { safeLocalStorage } from '../util/local'\n+import { api } from '../api/api'\n+import { removeUndefinedProps } from 'common/util/object'\n \n export type { User }\n \n export const auth = getFirebaseAuth()\n export const CACHED_REFERRAL_USERNAME_KEY = 'CACHED_REFERRAL_KEY'\n const CACHED_REFERRAL_CONTRACT_ID_KEY = 'CACHED_REFERRAL_CONTRACT_KEY'\n \n+// Scenarios:\n+// 1. User is referred by another user to homepage, group page, market page etc. explicitly via referrer= query param\n+// 2. User lands on a market or group without a referrer, we attribute the market/group creator\n+// Explicit referrers take priority over the implicit ones, (e.g. they're overwritten)\n+export function writeReferralInfo(\n+  defaultReferrerUsername: string,\n+  otherOptions?: {\n+    contractId?: string\n+    explicitReferrer?: string\n+  }\n+) {\n+  const local = safeLocalStorage\n+  const cachedReferralUser = local?.getItem(CACHED_REFERRAL_USERNAME_KEY)\n+  const { contractId, explicitReferrer } = otherOptions || {}\n+\n+  // Write the first referral username we see.\n+  if (!cachedReferralUser) {\n+    local?.setItem(\n+      CACHED_REFERRAL_USERNAME_KEY,\n+      explicitReferrer || defaultReferrerUsername\n+    )\n+    if (contractId) local?.setItem(CACHED_REFERRAL_CONTRACT_ID_KEY, contractId)\n+  }\n+\n+  // Overwrite all referral info if we see an explicit referrer.\n+  if (explicitReferrer) {\n+    local?.setItem(CACHED_REFERRAL_USERNAME_KEY, explicitReferrer)\n+    if (!contractId) local?.removeItem(CACHED_REFERRAL_CONTRACT_ID_KEY)\n+    else local?.setItem(CACHED_REFERRAL_CONTRACT_ID_KEY, contractId)\n+  }\n+}\n+\n+export async function setCachedReferralInfoForUser(user: User) {\n+  if (!canSetReferrer(user)) return\n+\n+  const local = safeLocalStorage\n+  const cachedReferralUsername = local?.getItem(CACHED_REFERRAL_USERNAME_KEY)\n+  const cachedReferralContractId = local?.getItem(\n+    CACHED_REFERRAL_CONTRACT_ID_KEY\n+  )\n+  const referralComplete = local?.getItem('referral-complete') == 'true'\n+  if (!cachedReferralUsername || referralComplete) return\n+  console.log(\n+    `User created in last ${MINUTES_ALLOWED_TO_REFER} minutes, trying to set referral`\n+  )\n+  // get user via username\n+  api(\n+    'refer-user',\n+    removeUndefinedProps({\n+      referredByUsername: cachedReferralUsername,\n+      contractId: cachedReferralContractId ?? undefined,\n+    })\n+  )\n+    .then((resp) => {\n+      console.log('referral resp', resp)\n+      local?.setItem('referral-complete', 'true')\n+    })\n+    .catch((err) => {\n+      console.log('error setting referral details', err)\n+    })\n+}\n+\n export async function firebaseLogin() {\n   if (getIsNative()) {\n     // Post the message back to expo\n     postMessageToNative('loginClicked', {})\n@@ -70,4 +140,12 @@\n     blockedByUserIds?.includes(contract.creatorId) ||\n     blockedUserIds?.includes(contract.creatorId)\n   )\n }\n+\n+export const canSetReferrer = (user: User) => {\n+  if (user.referredByUserId) return false\n+  if (!humanish(user)) return false\n+  const now = dayjs().utc()\n+  const userCreatedTime = dayjs(user.createdTime)\n+  return now.diff(userCreatedTime, 'minute') < MINUTES_ALLOWED_TO_REFER\n+}\n"
        },
        {
          "path": "web/pages/[username]/index.tsx",
          "status": "modified",
          "diff": "Index: web/pages/[username]/index.tsx\n===================================================================\n--- web/pages/[username]/index.tsx\t2c9045b (parent)\n+++ web/pages/[username]/index.tsx\t05cd890 (commit)\n@@ -54,8 +54,9 @@\n import { useHeaderIsStuck } from 'web/hooks/use-header-is-stuck'\n import { useIsMobile } from 'web/hooks/use-is-mobile'\n import { useLeagueInfo } from 'web/hooks/use-leagues'\n import { usePersistentLocalState } from 'web/hooks/use-persistent-local-state'\n+import { useSaveReferral } from 'web/hooks/use-save-referral'\n import { usePrivateUser, useUser, useWebsocketUser } from 'web/hooks/use-user'\n import { User } from 'web/lib/firebase/users'\n import TrophyIcon from 'web/lib/icons/trophy-icon.svg'\n import { db } from 'web/lib/supabase/db'\n@@ -164,9 +165,11 @@\n   const user = useWebsocketUser(props.user.id) ?? props.user\n   const isMobile = useIsMobile()\n   const router = useRouter()\n   const currentUser = useUser()\n-\n+  useSaveReferral(currentUser, {\n+    defaultReferrerUsername: user.username,\n+  })\n   const isCurrentUser = user.id === currentUser?.id\n   const [expandProfileInfo, setExpandProfileInfo] = usePersistentLocalState(\n     false,\n     'expand-profile-info'\n"
        },
        {
          "path": "web/pages/browse/index.tsx",
          "status": "modified",
          "diff": "Index: web/pages/browse/index.tsx\n===================================================================\n--- web/pages/browse/index.tsx\t2c9045b (parent)\n+++ web/pages/browse/index.tsx\t05cd890 (commit)\n@@ -14,11 +14,12 @@\n import { useIsMobile } from 'web/hooks/use-is-mobile'\n import { usePrivateUser, useUser } from 'web/hooks/use-user'\n import { ManifoldLogo } from 'web/components/nav/manifold-logo'\n import { DEFAULT_FOR_YOU, Welcome } from 'web/components/onboarding/welcome'\n-\n+import { useSaveReferral } from 'web/hooks/use-save-referral'\n export default function BrowsePage() {\n   const user = useUser()\n+  useSaveReferral(user)\n \n   return (\n     <Page trackPageView={'questions page'} className=\"lg:px-4\">\n       {/* only show logo on mobile, since there's no sidebar */}\n"
        },
        {
          "path": "web/pages/embed/[username]/[contractSlug].tsx",
          "status": "modified",
          "diff": "Index: web/pages/embed/[username]/[contractSlug].tsx\n===================================================================\n--- web/pages/embed/[username]/[contractSlug].tsx\t2c9045b (parent)\n+++ web/pages/embed/[username]/[contractSlug].tsx\t05cd890 (commit)\n@@ -53,8 +53,9 @@\n import { MultiNumericContractChart } from 'web/components/charts/contract/multi-numeric'\n import { MultiDateContractChart } from 'web/components/charts/contract/multi-date'\n import { pointsToBase64 } from 'common/util/og'\n import { mapValues } from 'lodash'\n+import { useUser } from 'web/hooks/use-user'\n type Points = HistoryPoint<any>[]\n \n async function getHistoryData(contract: Contract) {\n   switch (contract.outcomeType) {\n@@ -286,11 +287,11 @@\n   const isMultiNumeric = outcomeType === 'MULTI_NUMERIC'\n   const isDate = outcomeType === 'DATE'\n \n   const href = `https://${DOMAIN}${twombaContractPath(contract)}`\n+  const user = useUser()\n+  const shareUrl = getShareUrl(contract, user?.username)\n \n-  const shareUrl = getShareUrl(contract)\n-\n   const showMultiChart = isMulti && !!props.multiPoints\n \n   return (\n     <Col className=\"bg-canvas-0 h-[100vh] w-full gap-1 px-6 py-4\">\n"
        },
        {
          "path": "web/pages/explore/index.tsx",
          "status": "modified",
          "diff": "Index: web/pages/explore/index.tsx\n===================================================================\n--- web/pages/explore/index.tsx\t2c9045b (parent)\n+++ web/pages/explore/index.tsx\t05cd890 (commit)\n@@ -36,8 +36,9 @@\n import DropdownMenu from 'web/components/widgets/dropdown-menu'\n import { ACTIVITY_TYPES } from '../activity'\n import { DropdownPill } from 'web/components/search/filter-pills'\n import { TopicPillSelector } from 'web/components/topics/topic-selector'\n+import { useSaveReferral } from 'web/hooks/use-save-referral'\n const isProd = ENV === 'PROD'\n const NFL_ID = 'TNQwmbE5p6dnKx2e6Qlp'\n const NBA_ID = 'i0v3cXwuxmO9fpcInVYb'\n const EPL_ID = '5gsW3dPR3ySBRZCodrgm'\n@@ -48,8 +49,10 @@\n const ALL_IDS = [NFL_ID, SPORTS_ID, EPL_ID, NBA_ID, MLB_ID].join(',')\n export function ExploreContent(props: { render: boolean }) {\n   const { render } = props\n   const user = useUser()\n+  useSaveReferral(user)\n+\n   const [isSportsInterested, setIsSportsInterested] = usePersistentLocalState<\n     boolean | undefined\n   >(undefined, 'is-sports-interested')\n   const getIsSportsInterested = async () => {\n"
        },
        {
          "path": "web/pages/home/index.tsx",
          "status": "modified",
          "diff": "Index: web/pages/home/index.tsx\n===================================================================\n--- web/pages/home/index.tsx\t2c9045b (parent)\n+++ web/pages/home/index.tsx\t05cd890 (commit)\n@@ -16,11 +16,12 @@\n import { Welcome } from 'web/components/onboarding/welcome'\n import { LiveGeneratedFeed } from 'web/components/feed/live-generated-feed'\n import { ExploreContent } from '../explore'\n import { useBanner } from 'web/components/nav/banner'\n-\n+import { useSaveReferral } from 'web/hooks/use-save-referral'\n export default function Home() {\n   const user = useUser()\n+  useSaveReferral(user)\n   useRedirectIfSignedOut()\n   const [showManifestBanner, hideManifestBanner] = useBanner('manifest-2025')\n \n   return (\n"
        },
        {
          "path": "web/pages/referrals.tsx",
          "status": "modified",
          "diff": "Index: web/pages/referrals.tsx\n===================================================================\n--- web/pages/referrals.tsx\t2c9045b (parent)\n+++ web/pages/referrals.tsx\t05cd890 (commit)\n@@ -1,42 +1,69 @@\n import { Col } from 'web/components/layout/col'\n import { SEO } from 'web/components/SEO'\n+import { Title } from 'web/components/widgets/title'\n import { useUser } from 'web/hooks/use-user'\n import { Page } from 'web/components/layout/page'\n import { redirectIfLoggedOut } from 'web/lib/firebase/server-auth'\n-\n-import { getReferralCodeFromUser } from 'common/util/share'\n-\n+import { CopyLinkRow } from 'web/components/buttons/copy-link-button'\n+import { ENV_CONFIG } from 'common/envs/constants'\n+import { InfoBox } from 'web/components/widgets/info-box'\n+import { QRCode } from 'web/components/widgets/qr-code'\n+import { REFERRAL_AMOUNT } from 'common/economy'\n+import { formatMoney } from 'common/util/format'\n+import clsx from 'clsx'\n+import { TokenNumber } from 'web/components/widgets/token-number'\n+import { referralQuery } from 'common/util/share'\n export const getServerSideProps = redirectIfLoggedOut('/')\n \n export default function ReferralsPage() {\n   const user = useUser()\n-  const isSweepstakesVerified = user?.sweepstakesVerified\n \n-  const code = getReferralCodeFromUser(user?.id)\n+  const url = `https://${ENV_CONFIG.domain}${referralQuery(\n+    user?.username ?? ''\n+  )}`\n+\n   return (\n     <Page trackPageView={'referrals'}>\n       <SEO\n         title=\"Refer a friend\"\n-        description={`Invite new users to Manifold!`}\n+        description={`Invite new users to Manifold and get ${formatMoney(\n+          REFERRAL_AMOUNT\n+        )} if they sign up and place a trade!`}\n         url=\"/referrals\"\n       />\n \n-      <Col className=\"mx-auto max-w-2xl items-center\">\n-        <Col className=\"bg-canvas-0 rounded-lg p-8 shadow-lg\">\n-          <h1 className=\"mb-6 text-center text-3xl font-bold\">\n-            Refer a Friend\n-          </h1>\n-\n+      <Col className=\"items-center\">\n+        <Col className=\"bg-canvas-0 h-full rounded p-4 py-8 sm:p-8 sm:shadow-md\">\n+          <Title>Refer a friend</Title>\n           <img\n-            className=\"mx-auto mb-8 block\"\n+            className=\"mb-6 block -scale-x-100 self-center\"\n             src=\"/logo-flapping-with-money.gif\"\n             width={200}\n             height={200}\n-            alt=\"Animated logo\"\n+            alt=\"\"\n           />\n \n-          <div className=\"text-center text-xl\">Coming soon...</div>\n+          <div className={'mb-4'}>\n+            Invite new users to Manifold and get{' '}\n+            <TokenNumber\n+              coinType={'MANA'}\n+              amount={REFERRAL_AMOUNT}\n+              className={clsx('font-bold')}\n+              isInline\n+            />{' '}\n+            if they sign up and place a trade!\n+          </div>\n+\n+          <CopyLinkRow url={url} eventTrackingName=\"copy referral link\" />\n+\n+          <QRCode url={url} className=\"mt-4 self-center\" />\n+\n+          <InfoBox\n+            title=\"FYI\"\n+            className=\"mt-4\"\n+            text=\"You can also earn the referral bonus using the share link to any question or group!\"\n+          />\n         </Col>\n       </Col>\n     </Page>\n   )\n"
        }
      ]
    },
    {
      "id": "simplify-trades-table",
      "sha": "702a5b83248af6fd73abf118c05411fad29e4f55",
      "parentSha": "80a4d9486ee05ab71963558a8ed7f88f2d2e2c73",
      "spec": "Implement a simplified User Bets (Trades) experience, update expected value/date calculations for resolved multi-answer markets, harden click interactions in paginated, expandable lists, and adjust resolved text color fallback.\n\n1) Expected value/date for resolved multi-answer markets\n- Files: common/src/multi-numeric.ts, common/src/multi-date.ts\n- getExpectedValue(contract, initialOnly?) and getExpectedDate(contract, initialOnly?) must:\n  - Read contract.isResolved in addition to answers and shouldAnswersSumToOne.\n  - When initialOnly is true, continue using getInitialAnswerProbability for each answer.\n  - When initialOnly is false:\n    - If contract.isResolved is true, use each Answer.prob directly to compute expected value/date.\n    - Otherwise, use getAnswerProbability(contract, answer.id) as before.\n- Keep all existing logic for shouldAnswersSumToOne weighting and threshold-style handling.\n\n2) ContractBetsTable: defaultExpanded behavior and click isolations\n- File: web/components/bet/contract-bets-table.tsx\n- Add an optional prop defaultExpanded?: boolean (default false).\n- Initialize the expanded state from defaultExpanded (not hard-coded false).\n- Ensure the \"Show more\" button’s onClick stops propagation (e.stopPropagation()) so it doesn’t trigger parent row clicks.\n- This change must be backward compatible with all existing usages.\n\n3) LimitOrdersTable cash icon rendering\n- File: web/components/bet/limit-orders-table.tsx\n- In the contract header link where the SweepiesCoin appears when contract.token === 'CASH', render <SweepiesCoin /> without absolute/top classes. Remove the absolute inset/top positioning wrapper.\n\n4) UserBetsTable: refactor UI to simplified list with dropdown filters and sorting\n- File: web/components/bet/user-bets-table.tsx\n- Replace the carousel and complex column grid with:\n  - A sticky top controls bar (only for non-limit-orders view) including:\n    - Search input (unchanged behavior).\n    - A Filter dropdown with options: All, Open, Sold, Closed, Resolved, Limit Orders.\n      - When Limit Orders is selected, set showLimitOrders = true and set a default bets filter (e.g., 'open').\n      - When any other filter is selected, set showLimitOrders = false and apply the chosen bets filter.\n    - When showLimitOrders is true (and if viewing your own bets), show a second dropdown for limit order status: Open (active), Expired, Filled, Cancelled. Toggling updates the includeExpired/includeFilled/includeCancelled props used by LimitOrdersTable.\n    - When showLimitOrders is false, show a Sort dropdown with the options below.\n  - Persist the sort selection in memory (usePersistentInMemoryState). Define sortOption as an object { field: BetSort; direction: 'asc' | 'desc' } with initial { field: 'newest', direction: 'desc' }.\n    - Sort options (labels map to field and direction):\n      - Newest (newest, desc)\n      - Oldest (newest, asc)\n      - Highest Value (value, desc)\n      - Highest Position (position, desc)\n      - Highest Profit (profit, desc)\n      - Lowest Profit (profit, asc)\n      - Highest 1d Change (day, desc)\n      - Lowest 1d Change (day, asc)\n      - Highest 1w Change (week, desc)\n      - Lowest 1w Change (week, asc)\n      - Closing Soon (closeTime, asc)\n  - Only show the Sweepcash toggle PillButton when hasSweeps is true and the filter is 'resolved'.\n- Limit orders view:\n  - When showLimitOrders is true, render LimitOrdersTable with filter set to \"all\" (ignore the bets filter), and includeExpired/filled/cancelled controlled by the limit order status dropdown.\n- Bets view list rendering:\n  - Change BetsTable prop types from CPMMContract[] to MarketContract[].\n  - Remove header row, editable columns, modal, and NumberCell/Header components entirely.\n  - Accept sortOption from parent (remove internal sort state) and sort using the supplied option. Fix profitPercent sorting to use metricsByContractId[c.id].profitPercent (not profit).\n  - Render each contract as a single row with:\n    - Left: question link (stopping propagation), with SweepiesCoin tooltip for CASH markets; below/adjacent, a status chip:\n      - If resolved and outcomeType is MULTIPLE_CHOICE: show resolution as MULTI if multiple winners/MKT; CANCEL via BinaryOutcomeLabel(\"CANCEL\"); else show the winning answer with MultiOutcomeLabel; otherwise use ContractStatusLabel for non-multi types.\n      - If not resolved and not MULTIPLE_CHOICE: show ContractStatusLabel.\n      - Show creator name, and additionally:\n        - If sorting by closeTime: show the close/resolution date (MM/DD[/YY]).\n        - If sorting by newest: show time since last bet via RelativeTimestamp.\n    - Right: values based on sort selection:\n      - Position: sum of totalShares (positive formatting) with token (CASH vs M$).\n      - Otherwise show payout value (positive formatting) with token.\n      - For day/week sort: display profit for that window and a small percentage pill using from.day.profitPercent or from.week.profitPercent (with teal styling if positive).\n      - Otherwise show overall profit and a percentage pill with profitPercent.\n    - A chevron icon indicating expandable state; rotate when expanded.\n  - Clicking a row toggles expansion for that contract (expandedIds). Links inside the row must stop propagation.\n  - In the expanded area, render ContractBetsTable with defaultExpanded enabled to show full bets, passing isYourBets, contractMetric, and paginate.\n\n5) Resolved text color fallback\n- File: web/components/contract/text-color.ts\n- When contract.resolution is set but not found in the OUTCOME_TO_COLOR_TEXT mapping, return 'text-blue-600 dark:text-blue-200' as the fallback class (not the previous 'text-primary-200').\n\n6) Pagination: stop event propagation when changing pages\n- File: web/components/widgets/pagination.tsx\n- Change PaginationArrow onClick signature to accept an optional React.MouseEvent.\n- In Pagination, update both Prev and Next handlers to stop propagation (e.stopPropagation()) before changing page.\n- In PageNumbers, update the button onClick to stop propagation before calling setPage.\n- Ensure these changes prevent parent row onClick (expand/collapse) from triggering when interacting with pagination controls.\n\n7) User profile header actions layout\n- File: web/pages/[username]/index.tsx\n- For the current user in the header actions row:\n  - Replace the existing pair of AddFundsButton and RedeemSweepsButtons with a single AddFundsButton (className: \"mr-2 w-full whitespace-nowrap px-8 lg:hidden\").\n  - Move RedeemSweepsButtons to a separate rendering block for current user only, with className: \"m-2 w-48\" and remove the previous mobile-only row that combined both buttons.\n\n8) Imports and cleanup\n- Update imports in user-bets-table.tsx to include Headless UI Menu components (Menu, MenuButton, MenuItem, MenuItems) and ChevronDownIcon. Remove unused imports/components removed as part of the simplification (carousel, dropdown-menu, modal, icon buttons for headers, etc.).\n- Update uses of BinaryOutcomeLabel, MultiOutcomeLabel, ContractStatusLabel, RelativeTimestamp per the new layout.\n- Ensure links and interactive elements within rows call e.stopPropagation() to avoid toggling expansion.\n\nAcceptance criteria:\n- In Trades tab of a user profile, the control bar shows a search input and dropdowns (Filter, optional Limit Order Status in limit orders view, and Sort in non-limit view). Switching filters updates the view appropriately; selecting Limit Orders shows the limit orders list and ignores the standard bets filters.\n- In non-limit orders view, the list is a simplified row layout with question, status/resolution, creator, optional time/date, and right-aligned values with token formatting and change badges, and an expand chevron. Clicking the row expands details; pagination inside expanded bets or its “show more” button does not accidentally toggle expansion.\n- Default expansion of bets in the expanded section is on (via defaultExpanded).\n- For resolved multi-answer markets, expected value/date functions use the final Answer.prob values (reflected wherever these functions are used).\n- The resolved text color fallback appears blue (‘text-blue-600’ in light and ‘dark:text-blue-200’ in dark) if the resolution key isn’t in the map.\n- SweepiesCoin renders without absolute positioning in limit orders table titles.\n- Prev/Next and page number clicks no longer bubble to parent row onClick handlers.",
      "prompt": "Revamp the user trades view and tighten interactions while ensuring resolved multi-answer market stats display correctly.\n\n- Add a simplified Trades list UI: a sticky control bar with a search box, a Filter dropdown (All/Open/Sold/Closed/Resolved/Limit Orders), a Limit Order Status dropdown (Open/Expired/Filled/Cancelled) visible only when in the limit orders view, and a Sort dropdown for non-limit-views. Persist the sort setting and apply it to the bets list.\n- Replace the old column-grid table with a single-row-per-contract layout showing the question, status/resolution, creator, and context (date/time by sort), and on the right the key numeric figure (position or value) and change metrics (profit or day/week profit) with % badges. Rows are expandable; the expand chevron reflects state. Links and controls inside rows must not toggle expansion.\n- When viewing Limit Orders, feed a neutral filter to the table and control the included statuses via the dropdown.\n- Make the expanded bets section default to expanded.\n- Fix expected value and expected date calculations for resolved multi-answer contracts by using the answers’ stored probabilities post-resolution.\n- Use a blue fallback text color for resolved status when no mapped color is available.\n- Ensure pagination clicks and “show more” do not bubble and inadvertently toggle row expansion.\n- Adjust the current user’s profile header actions: show only the Add Funds button there; render Redeem Sweeps separately below with simpler layout.\n\nKeep prop types consistent, remove unused imports/components from the old UI, and maintain backward compatibility for existing ContractBetsTable callers.",
      "supplementalFiles": [
        "common/src/contract.ts",
        "common/src/answer.ts",
        "web/components/outcome-label.tsx",
        "web/components/contract/contracts-table.tsx",
        "web/components/widgets/tooltip.tsx",
        "web/components/add-funds-modal.tsx"
      ],
      "fileDiffs": [
        {
          "path": "common/src/multi-date.ts",
          "status": "modified",
          "diff": "Index: common/src/multi-date.ts\n===================================================================\n--- common/src/multi-date.ts\t80a4d94 (parent)\n+++ common/src/multi-date.ts\t702a5b8 (commit)\n@@ -9,14 +9,16 @@\n export function getExpectedDate(\n   contract: MultiDateContract,\n   initialOnly?: boolean\n ) {\n-  const { answers, shouldAnswersSumToOne } = contract\n+  const { answers, shouldAnswersSumToOne, isResolved } = contract\n \n   const answerProbabilities = filterDefined(\n     answers.map((a) =>\n       initialOnly\n         ? getInitialAnswerProbability(contract, a)\n+        : isResolved\n+        ? a.prob\n         : getAnswerProbability(contract, a.id)\n     )\n   )\n   const answerMidpoints = answers.map((a) => a.midpoint!)\n"
        },
        {
          "path": "common/src/multi-numeric.ts",
          "status": "modified",
          "diff": "Index: common/src/multi-numeric.ts\n===================================================================\n--- common/src/multi-numeric.ts\t80a4d94 (parent)\n+++ common/src/multi-numeric.ts\t702a5b8 (commit)\n@@ -9,14 +9,16 @@\n export function getExpectedValue(\n   contract: MultiNumericContract,\n   initialOnly?: boolean\n ) {\n-  const { answers, shouldAnswersSumToOne } = contract\n+  const { answers, shouldAnswersSumToOne, isResolved } = contract\n \n   const answerProbabilities = filterDefined(\n     answers.map((a) =>\n       initialOnly\n         ? getInitialAnswerProbability(contract, a)\n+        : isResolved\n+        ? a.prob\n         : getAnswerProbability(contract, a.id)\n     )\n   )\n   const answerMidpoints = answers.map((a) => a.midpoint!)\n"
        },
        {
          "path": "web/components/bet/contract-bets-table.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/contract-bets-table.tsx\n===================================================================\n--- web/components/bet/contract-bets-table.tsx\t80a4d94 (parent)\n+++ web/components/bet/contract-bets-table.tsx\t702a5b8 (commit)\n@@ -35,15 +35,17 @@\n   isYourBets: boolean\n   contractMetric: ContractMetric\n   hideRedemptionAndLoanMessages?: boolean\n   paginate?: boolean\n+  defaultExpanded?: boolean\n }) {\n   const {\n     contract,\n     isYourBets,\n     hideRedemptionAndLoanMessages,\n     paginate,\n     contractMetric,\n+    defaultExpanded = false,\n   } = props\n   const { isResolved, mechanism, outcomeType } = contract\n \n   const bets = sortBy(\n@@ -79,9 +81,9 @@\n \n   const [page, setPage] = useState(0)\n   const unexpandedBetsPerPage = 2\n   const betsPerPage = 5\n-  const [expanded, setExpanded] = useState(false)\n+  const [expanded, setExpanded] = useState(defaultExpanded)\n \n   const displayedBets = expanded\n     ? normalBets.slice(page * betsPerPage, (page + 1) * betsPerPage)\n     : normalBets.slice(0, unexpandedBetsPerPage)\n@@ -132,9 +134,12 @@\n           <button\n             className={\n               'hover:bg-canvas-100 text-primary-700 mb-1 rounded-md p-2 text-sm'\n             }\n-            onClick={() => setExpanded(true)}\n+            onClick={(e) => {\n+              e.stopPropagation()\n+              setExpanded(true)\n+            }}\n           >\n             Show {normalBets.length - unexpandedBetsPerPage} more {TRADE_TERM}s\n           </button>\n         )}\n"
        },
        {
          "path": "web/components/bet/limit-orders-table.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/limit-orders-table.tsx\n===================================================================\n--- web/components/bet/limit-orders-table.tsx\t80a4d94 (parent)\n+++ web/components/bet/limit-orders-table.tsx\t702a5b8 (commit)\n@@ -357,11 +357,9 @@\n                     className={''}\n                   />\n                 </span>\n                 <span className=\"text-ink-600 line-clamp-1\">\n-                  {contract.token == 'CASH' && (\n-                    <SweepiesCoin className=\"absolute inset-0 top-[0.2em]\" />\n-                  )}\n+                  {contract.token == 'CASH' && <SweepiesCoin />}\n                   {contract.question}\n                 </span>\n               </Link>\n             </Row>\n"
        },
        {
          "path": "web/components/bet/user-bets-table.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/user-bets-table.tsx\n===================================================================\n--- web/components/bet/user-bets-table.tsx\t80a4d94 (parent)\n+++ web/components/bet/user-bets-table.tsx\t702a5b8 (commit)\n@@ -1,6 +1,5 @@\n 'use client'\n-import { ChevronUpIcon } from '@heroicons/react/solid'\n import clsx from 'clsx'\n import { LimitBet } from 'common/bet'\n import { getContractBetNullMetrics } from 'common/calculate'\n import {\n@@ -9,55 +8,45 @@\n   CPMMContract,\n   MarketContract,\n } from 'common/contract'\n import { ContractMetric } from 'common/contract-metric'\n-import { ENV_CONFIG, SWEEPIES_MARKET_TOOLTIP } from 'common/envs/constants'\n+import { SWEEPIES_MARKET_TOOLTIP } from 'common/envs/constants'\n import { buildArray } from 'common/util/array'\n-import {\n-  formatWithToken,\n-  maybePluralize,\n-  shortFormatNumber,\n-  SWEEPIES_MONIKER,\n-} from 'common/util/format'\n+import { formatWithToken } from 'common/util/format'\n import { searchInAny } from 'common/util/parse'\n import { Dictionary, sortBy, sum, uniqBy, mapValues } from 'lodash'\n import Link from 'next/link'\n-import { ReactNode, useEffect, useMemo, useState } from 'react'\n-import { BiCaretDown, BiCaretUp } from 'react-icons/bi'\n-import { BsThreeDotsVertical } from 'react-icons/bs'\n+import { useEffect, useMemo, useState } from 'react'\n import { BetsSummary } from 'web/components/bet/bet-summary'\n import { ContractBetsTable } from 'web/components/bet/contract-bets-table'\n import { OrderTable } from 'web/components/bet/order-book'\n-import { Button, IconButton } from 'web/components/buttons/button'\n import { PillButton } from 'web/components/buttons/pill-button'\n-import { ContractStatusLabel } from 'web/components/contract/contracts-table'\n-import { OutcomeLabel } from 'web/components/outcome-label'\n-import { RelativeTimestamp } from 'web/components/relative-timestamp'\n-import { Avatar } from 'web/components/widgets/avatar'\n-import { Carousel } from 'web/components/widgets/carousel'\n import { Input } from 'web/components/widgets/input'\n import { Pagination } from 'web/components/widgets/pagination'\n import { useContractBets } from 'client-common/hooks/use-bets'\n import { useEvent } from 'client-common/hooks/use-event'\n-import { useIsMobile } from 'web/hooks/use-is-mobile'\n import { usePersistentInMemoryState } from 'client-common/hooks/use-persistent-in-memory-state'\n import { usePersistentLocalState } from 'web/hooks/use-persistent-local-state'\n import { usePersistentQueryState } from 'web/hooks/use-persistent-query-state'\n import { useIsAuthorized, useUser } from 'web/hooks/use-user'\n import { api } from 'web/lib/api/api'\n import { User } from 'web/lib/firebase/users'\n import { SweepiesCoin } from 'web/public/custom-components/sweepiesCoin'\n-import DropdownMenu from '../widgets/dropdown-menu'\n-import { Modal, MODAL_CLASS } from '../layout/modal'\n import { useSweepstakes } from '../sweepstakes-provider'\n import { LoadingIndicator } from '../widgets/loading-indicator'\n import { linkClass } from '../widgets/site-link'\n import { Tooltip } from '../widgets/tooltip'\n import { floatingEqual } from 'common/util/math'\n import { Col } from '../layout/col'\n import { Row } from '../layout/row'\n import { useIsPageVisible } from 'web/hooks/use-page-visible'\n-import { LimitOrdersTable, LimitOrdersToggle } from './limit-orders-table'\n+import { LimitOrdersTable } from './limit-orders-table'\n+import { Menu, MenuButton, MenuItem, MenuItems } from '@headlessui/react'\n+import { ChevronDownIcon } from '@heroicons/react/solid'\n+import { ContractStatusLabel } from '../contract/contracts-table'\n+import { BinaryOutcomeLabel, MultiOutcomeLabel } from '../outcome-label'\n+import { RelativeTimestamp } from '../relative-timestamp'\n+\n type BetSort =\n   | 'newest'\n   | 'profit'\n   | 'closeTime'\n@@ -96,15 +85,16 @@\n   const [showLimitOrders, setShowLimitOrders] = usePersistentLocalState(\n     false,\n     'show-limit-orders-view'\n   )\n+  type LimitOrderFilter = 'active' | 'filled' | 'expired' | 'cancelled'\n   // Add state for showing different order types\n-  const [orderFilter, setOrderFilter] = usePersistentInMemoryState<\n-    'active' | 'filled' | 'expired' | 'cancelled'\n-  >('active', 'limit-orders-filter')\n-  const updateOrderFilter = (\n-    newFilter: 'active' | 'filled' | 'expired' | 'cancelled'\n-  ) => {\n+  const [orderFilter, setOrderFilter] =\n+    usePersistentInMemoryState<LimitOrderFilter>(\n+      'active',\n+      'limit-orders-filter'\n+    )\n+  const updateOrderFilter = (newFilter: LimitOrderFilter) => {\n     setOrderFilter(orderFilter === newFilter ? 'active' : newFilter)\n   }\n \n   const getMetrics = useEvent(() =>\n@@ -148,10 +138,19 @@\n   const [page, setPage] = usePersistentInMemoryState(0, 'portfolio-page')\n \n   const [query, setQuery] = usePersistentQueryState('b', '')\n \n-  const onSetFilter = (f: BetFilter) => {\n-    setFilter(f)\n+  const onSetFilter = (f: BetFilter | 'limit_orders') => {\n+    if (f === 'limit_orders') {\n+      setShowLimitOrders(true)\n+      // When toggling limit orders on, set a default filter but it won't be used\n+      // while limit orders view is active\n+      setFilter('open')\n+      return\n+    }\n+    // When selecting any other filter, turn off limit orders view\n+    setShowLimitOrders(false)\n+    setFilter(f as BetFilter)\n     setPage(0)\n   }\n \n   const toggleTokenFilter = () => {\n@@ -211,82 +210,205 @@\n         })\n     : []\n \n   const hasSweeps = contracts?.some((c) => c.token === 'CASH')\n+\n+  // Define sort options for the dropdown\n+  const [sortOption, setSortOption] = usePersistentInMemoryState<{\n+    field: BetSort\n+    direction: 'asc' | 'desc'\n+  }>({ field: 'newest', direction: 'desc' }, 'bets-list-sort')\n+\n+  const sortOptions: {\n+    label: string\n+    field: BetSort\n+    direction: 'asc' | 'desc'\n+  }[] = [\n+    { label: 'Newest', field: 'newest', direction: 'desc' },\n+    { label: 'Oldest', field: 'newest', direction: 'asc' },\n+    { label: 'Highest Value', field: 'value', direction: 'desc' },\n+    { label: 'Highest Position', field: 'position', direction: 'desc' },\n+    { label: 'Highest Profit', field: 'profit', direction: 'desc' },\n+    { label: 'Lowest Profit', field: 'profit', direction: 'asc' },\n+    { label: 'Highest 1d Change', field: 'day', direction: 'desc' },\n+    { label: 'Lowest 1d Change', field: 'day', direction: 'asc' },\n+    { label: 'Highest 1w Change', field: 'week', direction: 'desc' },\n+    { label: 'Lowest 1w Change', field: 'week', direction: 'asc' },\n+    { label: 'Closing Soon', field: 'closeTime', direction: 'asc' },\n+  ]\n+\n+  const filterOptions = [\n+    { label: 'All', value: 'all' },\n+    { label: 'Open', value: 'open' },\n+    { label: 'Sold', value: 'sold' },\n+    { label: 'Closed', value: 'closed' },\n+    { label: 'Resolved', value: 'resolved' },\n+    { label: 'Limit Orders', value: 'limit_orders' },\n+  ]\n+\n+  const limitOrderFilterOptions: {\n+    label: string\n+    value: LimitOrderFilter\n+  }[] = [\n+    { label: 'Open', value: 'active' },\n+    { label: 'Expired', value: 'expired' },\n+    { label: 'Filled', value: 'filled' },\n+    { label: 'Cancelled', value: 'cancelled' },\n+  ]\n+\n+  const onSelectSortOption = (option: {\n+    field: BetSort\n+    direction: 'asc' | 'desc'\n+  }) => {\n+    setSortOption(option)\n+    setPage(0)\n+  }\n+\n   return (\n-    <Col>\n-      <div className=\"flex flex-wrap justify-between gap-4 max-sm:flex-col\">\n+    <Col className=\"relative\">\n+      <div\n+        className={clsx(\n+          'flex flex-wrap justify-between gap-4 max-sm:flex-col',\n+          !showLimitOrders && 'bg-canvas-0 sticky top-0 z-10 pt-1'\n+        )}\n+      >\n         <Col className=\"w-full gap-2\">\n-          <Row className=\"items-center gap-1 sm:gap-2\">\n+          <Col\n+            className={\n+              'items-end gap-2 sm:flex-row sm:items-center sm:justify-between'\n+            }\n+          >\n             <Input\n               placeholder={isYou ? 'Search your bets' : 'Search bets'}\n               className={'w-full min-w-[30px]'}\n               value={query}\n               onChange={(e) => setQuery(e.target.value)}\n             />\n-            {isYou && (\n-              <LimitOrdersToggle\n-                showLimitOrders={showLimitOrders}\n-                setShowLimitOrders={setShowLimitOrders}\n-              />\n-            )}\n-          </Row>\n-          <Carousel labelsParentClassName={'gap-1'}>\n-            {showLimitOrders && isYou && (\n+            <Row className=\"h-full gap-2\">\n+              {/* Filter Dropdown */}\n+              <Col className=\"relative\">\n+                <Menu>\n+                  <MenuButton className=\"bg-canvas-0 border-ink-200 hover:bg-canvas-50 inline-flex h-full w-32 items-center justify-between rounded-md border px-3 py-1.5 text-sm shadow-sm\">\n+                    <span>\n+                      {showLimitOrders\n+                        ? 'Limit Orders'\n+                        : filterOptions.find((opt) => opt.value === filter)\n+                            ?.label || 'Filter'}\n+                    </span>\n+                    <ChevronDownIcon className=\"ml-2 h-4 w-4\" />\n+                  </MenuButton>\n+                  <MenuItems className=\"bg-canvas-0 border-ink-200 absolute right-0 z-20 mt-1 w-48 overflow-hidden rounded-md border shadow-lg\">\n+                    {filterOptions.map((option) => (\n+                      <MenuItem key={option.value}>\n+                        {({ focus }) => (\n+                          <button\n+                            className={clsx(\n+                              'w-full px-4 py-2 text-left text-sm',\n+                              focus ? 'bg-primary-50' : '',\n+                              option.value === 'limit_orders' && showLimitOrders\n+                                ? 'bg-primary-100'\n+                                : ''\n+                            )}\n+                            onClick={() =>\n+                              onSetFilter(\n+                                option.value as BetFilter | 'limit_orders'\n+                              )\n+                            }\n+                          >\n+                            {option.label}\n+                          </button>\n+                        )}\n+                      </MenuItem>\n+                    ))}\n+                  </MenuItems>\n+                </Menu>\n+              </Col>\n+\n+              {/* Limit Order Status Dropdown - Only visible when showLimitOrders is true */}\n+              {showLimitOrders && isYou && (\n+                <Col className=\"relative\">\n+                  <Menu>\n+                    <MenuButton className=\"bg-canvas-0 border-ink-200 hover:bg-canvas-50 inline-flex h-full w-28 items-center justify-between rounded-md border px-3 py-1.5 text-sm shadow-sm\">\n+                      <span>\n+                        {limitOrderFilterOptions.find(\n+                          (opt) => opt.value === orderFilter\n+                        )?.label || 'Open'}\n+                      </span>\n+                      <ChevronDownIcon className=\"ml-2 h-4 w-4\" />\n+                    </MenuButton>\n+                    <MenuItems className=\"bg-canvas-0 border-ink-200 absolute right-0 z-20 mt-1 w-48 overflow-hidden rounded-md border shadow-lg\">\n+                      {limitOrderFilterOptions.map((option) => (\n+                        <MenuItem key={option.value}>\n+                          {({ focus }) => (\n+                            <button\n+                              className={clsx(\n+                                'w-full px-4 py-2 text-left text-sm',\n+                                focus ? 'bg-primary-50' : '',\n+                                orderFilter === option.value\n+                                  ? 'bg-primary-100'\n+                                  : ''\n+                              )}\n+                              onClick={() => updateOrderFilter(option.value)}\n+                            >\n+                              {option.label}\n+                            </button>\n+                          )}\n+                        </MenuItem>\n+                      ))}\n+                    </MenuItems>\n+                  </Menu>\n+                </Col>\n+              )}\n+\n+              {!showLimitOrders && (\n+                <Col className=\"relative\">\n+                  <Menu>\n+                    <MenuButton className=\"bg-canvas-0 border-ink-200 hover:bg-canvas-50 inline-flex h-full w-44 items-center justify-between rounded-md border px-3 py-1.5 text-sm shadow-sm\">\n+                      <span>\n+                        {sortOptions.find(\n+                          (opt) =>\n+                            opt.field === sortOption.field &&\n+                            opt.direction === sortOption.direction\n+                        )?.label || 'Sort'}\n+                      </span>\n+                      <ChevronDownIcon className=\"ml-2 h-4 w-4\" />\n+                    </MenuButton>\n+                    <MenuItems className=\"bg-canvas-0 border-ink-200 absolute right-0 z-10 mt-1 w-48 overflow-hidden rounded-md border shadow-lg\">\n+                      {sortOptions.map((option) => (\n+                        <MenuItem key={`${option.field}-${option.direction}`}>\n+                          {({ focus }) => (\n+                            <button\n+                              className={clsx(\n+                                'w-full px-4 py-2 text-left text-sm',\n+                                focus ? 'bg-primary-50' : '',\n+                                sortOption.field === option.field &&\n+                                  sortOption.direction === option.direction\n+                                  ? 'bg-primary-100'\n+                                  : ''\n+                              )}\n+                              onClick={() => onSelectSortOption(option)}\n+                            >\n+                              {option.label}\n+                            </button>\n+                          )}\n+                        </MenuItem>\n+                      ))}\n+                    </MenuItems>\n+                  </Menu>\n+                </Col>\n+              )}\n+            </Row>\n+          </Col>\n+          {hasSweeps && filter === 'resolved' && (\n+            <Row>\n               <PillButton\n-                selected={orderFilter === 'expired'}\n-                onSelect={() => updateOrderFilter('expired')}\n-              >\n-                Expired\n-              </PillButton>\n-            )}\n-            {showLimitOrders && isYou && (\n-              <PillButton\n-                selected={orderFilter === 'filled'}\n-                onSelect={() => updateOrderFilter('filled')}\n-              >\n-                Filled\n-              </PillButton>\n-            )}\n-            {showLimitOrders && isYou && (\n-              <PillButton\n-                selected={orderFilter === 'cancelled'}\n-                onSelect={() => updateOrderFilter('cancelled')}\n-              >\n-                Cancelled\n-              </PillButton>\n-            )}\n-            {showLimitOrders && isYou && (\n-              <span className=\"text-ink-500 \">|</span>\n-            )}\n-            {(['all', 'open', 'sold', 'closed', 'resolved'] as BetFilter[]).map(\n-              (f) => (\n-                <PillButton\n-                  key={f}\n-                  selected={filter === f}\n-                  onSelect={() => onSetFilter(f)}\n-                >\n-                  {f === 'all'\n-                    ? 'All'\n-                    : f === 'sold'\n-                    ? 'Sold'\n-                    : f === 'closed'\n-                    ? 'Closed'\n-                    : f === 'resolved'\n-                    ? 'Resolved'\n-                    : 'Open'}\n-                </PillButton>\n-              )\n-            )}\n-            {hasSweeps && (\n-              <PillButton\n                 selected={!(prefersPlay ?? false)}\n                 onSelect={toggleTokenFilter}\n               >\n                 Sweepcash\n               </PillButton>\n-            )}\n-          </Carousel>\n+            </Row>\n+          )}\n         </Col>\n       </div>\n \n       {!loaded ? (\n@@ -304,20 +426,21 @@\n           isYourBets={isYou}\n           includeExpired={orderFilter === 'expired'}\n           includeFilled={orderFilter === 'filled'}\n           includeCancelled={orderFilter === 'cancelled'}\n-          filter={filter}\n+          filter=\"all\" // Use a default filter since filters don't matter for limit orders view\n           className=\"mt-2\"\n         />\n       ) : (\n         <BetsTable\n-          contracts={filteredContracts as CPMMContract[]}\n+          contracts={filteredContracts as MarketContract[]}\n           metricsByContractId={nullableMetricsByContract}\n           page={page}\n           user={user}\n           setPage={setPage}\n           filter={filter}\n           signedInUser={signedInUser}\n+          sortOption={sortOption}\n         />\n       )}\n     </Col>\n   )\n@@ -336,73 +459,33 @@\n   )\n }\n \n function BetsTable(props: {\n-  contracts: CPMMContract[]\n+  contracts: MarketContract[]\n   metricsByContractId: { [key: string]: ContractMetric }\n   page: number\n   setPage: (page: number) => void\n   filter: BetFilter\n   user: User\n   signedInUser: User | null | undefined\n+  sortOption: { field: BetSort; direction: 'asc' | 'desc' }\n }) {\n-  const { metricsByContractId, page, setPage, filter, user, signedInUser } =\n-    props\n+  const {\n+    metricsByContractId,\n+    page,\n+    setPage,\n+    filter,\n+    user,\n+    signedInUser,\n+    sortOption,\n+  } = props\n   const areYourBets = user.id === signedInUser?.id\n-  const [sort, setSort] = usePersistentInMemoryState<{\n-    field: BetSort\n-    direction: 'asc' | 'desc'\n-  }>({ field: 'newest', direction: 'desc' }, 'bets-list-sort')\n-  const onSetSort = (field: BetSort) => {\n-    if (sort.field === field) {\n-      setSort((prevSort) => ({\n-        ...prevSort,\n-        direction: prevSort.direction === 'asc' ? 'desc' : 'asc',\n-      }))\n-    } else {\n-      setSort({ field, direction: 'desc' })\n-    }\n-    setPage(0)\n-  }\n \n-  type ColumnHeader = {\n-    sort: BetSort\n-    label: string\n-    enabled: boolean\n-    altSort?: BetSort\n-    placeholder?: boolean\n-  }\n-\n-  const [columns, setColumns] = usePersistentLocalState<ColumnHeader[]>(\n-    [\n-      { sort: 'newest', label: 'Time', enabled: true },\n-      { sort: 'value', label: 'Value', enabled: true },\n-      { sort: 'position', label: 'Position', enabled: false },\n-      { sort: 'profit', label: 'Profit', enabled: true },\n-      { sort: 'day', label: '1d', enabled: true },\n-      { sort: 'week', label: '1w', enabled: true },\n-      { sort: 'closeTime', label: 'Close', enabled: true },\n-    ],\n-    'user-bet-table-columns'\n-  )\n-  const isEnabled = (sort: BetSort) =>\n-    !isMobile || columns.find((col) => col.sort === sort)?.enabled\n-\n-  const handleColumnToggle = (sort: BetSort) => {\n-    setColumns((prevConfigs) =>\n-      prevConfigs.map((config) =>\n-        config.sort === sort ? { ...config, enabled: !config.enabled } : config\n-      )\n-    )\n-  }\n-  const enabledColumnsCount = columns.filter((c) => c.enabled).length\n-  const [modalOpen, setModalOpen] = useState(false)\n-\n   // Most of these are descending sorts by default.\n   const SORTS: Record<BetSort, (c: Contract) => number> = {\n     position: (c) => -sum(Object.values(metricsByContractId[c.id].totalShares)),\n     profit: (c) => -metricsByContractId[c.id].profit,\n-    profitPercent: (c) => -metricsByContractId[c.id].profit,\n+    profitPercent: (c) => -metricsByContractId[c.id].profitPercent,\n     value: (c) => -metricsByContractId[c.id].payout,\n     newest: (c) => -(metricsByContractId[c.id].lastBetTime ?? 0),\n     probChangeDay: (c) => {\n       if (c.mechanism === 'cpmm-1') {\n@@ -416,349 +499,272 @@\n       // This is in fact the intuitive sort direction.\n       (filter === 'open' ? -1 : 1) *\n       (c.resolutionTime ?? c.closeTime ?? Infinity),\n   }\n+\n+  const sortFunction = SORTS[sortOption.field]\n   const contracts =\n-    sort.direction === 'desc'\n-      ? sortBy(props.contracts, SORTS[sort.field])\n-      : sortBy(props.contracts, SORTS[sort.field]).reverse()\n+    sortOption.direction === 'desc'\n+      ? sortBy(props.contracts, sortFunction)\n+      : sortBy(props.contracts, sortFunction).reverse()\n+\n   const rowsPerSection = 50\n   const currentSlice = page * rowsPerSection\n-  const isMobile = useIsMobile(600)\n \n-  const dataColumns: {\n-    header: ColumnHeader\n-    span: number\n-    renderCell: (c: Contract) => ReactNode\n-    headerBuddy?: ReactNode\n-  }[] = buildArray([\n-    {\n-      header: columns[0],\n-      span: isMobile ? 2 : 1,\n-      renderCell: (c: Contract) => (\n-        <Row className={'justify-start'}>\n-          <RelativeTimestamp\n-            time={metricsByContractId[c.id].lastBetTime}\n-            shortened\n-            className=\"text-ink-500 -ml-1\"\n-          />\n-        </Row>\n-      ),\n-    },\n-    {\n-      header: columns[1],\n-      span: isMobile ? 3 : 2,\n-      renderCell: (c: Contract) => {\n-        const maxOutcome = metricsByContractId[c.id].maxSharesOutcome\n-        const showOutcome = maxOutcome && c.outcomeType === 'BINARY'\n-        return (\n-          <Row className={clsx('justify-end gap-1')}>\n-            {showOutcome && isMobile && (\n-              <OutcomeLabel\n-                contract={c}\n-                outcome={maxOutcome}\n-                truncate={'short'}\n-              />\n-            )}\n-            <Col className={'sm:min-w-[50px]'}>\n-              {Math.floor(metricsByContractId[c.id].payout) <= 0 ? (\n-                <span className=\"text-ink-500 text-right\">-</span>\n-              ) : (\n-                <NumberCell\n-                  num={metricsByContractId[c.id].payout}\n-                  isCashContract={c.token === 'CASH'}\n-                />\n-              )}\n-            </Col>\n-          </Row>\n-        )\n-      },\n-    },\n-\n-    {\n-      header: columns[2],\n-      span: 3,\n-      renderCell: (c: Contract) => {\n-        const maxOutcome = metricsByContractId[c.id].maxSharesOutcome\n-        const showOutcome = maxOutcome && c.outcomeType === 'BINARY'\n-        const totalShares = sum(\n-          Object.values(metricsByContractId[c.id].totalShares)\n-        )\n-        return (\n-          <Row className={clsx('justify-end gap-1')}>\n-            {showOutcome &&\n-              ((isMobile && !isEnabled('value')) || !isMobile) && (\n-                <OutcomeLabel\n-                  contract={c}\n-                  outcome={maxOutcome}\n-                  truncate={'short'}\n-                />\n-              )}\n-            <Col className={'sm:min-w-[50px]'}>\n-              {Math.floor(totalShares) <= 0 ? (\n-                <span className=\"text-ink-500 text-right\">-</span>\n-              ) : (\n-                <NumberCell\n-                  num={totalShares}\n-                  isCashContract={c.token === 'CASH'}\n-                />\n-              )}\n-            </Col>\n-          </Row>\n-        )\n-      },\n-      headerBuddy: isMobile && <div className=\"-mr-2\" />,\n-    },\n-    {\n-      header: { ...columns[3] },\n-      span: isMobile ? 3 : 2,\n-      renderCell: (c: Contract) => {\n-        const cm = metricsByContractId[c.id]\n-        return (\n-          <Row className={'justify-end gap-1'}>\n-            {Math.floor(cm.profit) === 0 ? (\n-              <span className=\"text-ink-500 text-right\">-</span>\n-            ) : (\n-              <NumberCell\n-                num={cm.profit}\n-                change={true}\n-                isCashContract={c.token === 'CASH'}\n-              />\n-            )}\n-          </Row>\n-        )\n-      },\n-    },\n-    {\n-      header: columns[4],\n-      span: isMobile ? 3 : 2,\n-      renderCell: (c: Contract) => {\n-        const cm = metricsByContractId[c.id]\n-        return (\n-          <Row className={'justify-end gap-1'}>\n-            {Math.floor(cm.from?.day.profit ?? 0) === 0 ? (\n-              <span className=\"text-ink-500 text-right\">-</span>\n-            ) : (\n-              <NumberCell\n-                num={cm.from?.day.profit ?? 0}\n-                change={true}\n-                isCashContract={c.token === 'CASH'}\n-              />\n-            )}\n-          </Row>\n-        )\n-      },\n-    },\n-    {\n-      header: columns[5],\n-      span: isMobile ? 3 : 2,\n-      renderCell: (c: Contract) => {\n-        const cm = metricsByContractId[c.id]\n-        return (\n-          <Row className={'justify-end gap-1'}>\n-            {Math.floor(cm.from?.week.profit ?? 0) === 0 ? (\n-              <span className=\"text-ink-500 text-right\">-</span>\n-            ) : (\n-              <NumberCell\n-                num={cm.from?.week.profit ?? 0}\n-                change={true}\n-                isCashContract={c.token === 'CASH'}\n-              />\n-            )}\n-          </Row>\n-        )\n-      },\n-    },\n-    {\n-      header: columns[6],\n-      span: isMobile ? 3 : 2,\n-      renderCell: (c: Contract) => {\n-        const closeTime = c.resolutionTime ?? c.closeTime\n-        const date = new Date(closeTime ?? Infinity)\n-        const isThisYear = new Date().getFullYear() === date.getFullYear()\n-        const dateString = date.toLocaleDateString('en-US', {\n-          month: '2-digit',\n-          day: '2-digit',\n-          year: isThisYear ? undefined : '2-digit',\n-        })\n-        return (\n-          <Row className={'justify-end'}>\n-            <span className={'text-ink-800'}>\n-              {closeTime ? dateString : 'N/A'}\n-            </span>\n-          </Row>\n-        )\n-      },\n-    },\n-  ])\n-  const getColSpan = (i: number) =>\n-    i === 4\n-      ? 'col-span-4'\n-      : i === 3\n-      ? 'col-span-3'\n-      : i === 2\n-      ? 'col-span-2'\n-      : 'col-span-1'\n-\n   const [expandedIds, setExpandedIds] = useState<string[]>([])\n-\n-  const setNewExpandedId = async (id: string) => {\n+  const setNewExpandedId = (id: string) => {\n     setExpandedIds((oldIds) =>\n       oldIds.includes(id)\n         ? oldIds.filter((oldId) => oldId !== id)\n         : [...oldIds, id]\n     )\n   }\n \n-  const MAX_SHOWN_MOBILE = 5\n-  const columnsToDisplay = dataColumns\n-    .filter((c) => isEnabled(c.header.sort))\n-    .slice(0, isMobile ? MAX_SHOWN_MOBILE : 10)\n-\n   return (\n     <Col className=\"mb-4 flex-1 gap-4\">\n       <Col className={'w-full'}>\n-        <div\n-          className={clsx(\n-            'grid-cols-15 bg-canvas-0 sticky z-10 grid w-full py-2 pr-1',\n-            isMobile ? 'top-12' : 'top-0' // Sets it below sticky user profile header on mobile\n-          )}\n-        >\n-          {columnsToDisplay.map((col) =>\n-            col.header.placeholder ? (\n-              <span key={col.header.label} className=\"text-sm\" />\n-            ) : (\n-              <span\n-                key={col.header.sort}\n-                className={clsx(\n-                  getColSpan(col.span),\n-                  'relative flex justify-end first:justify-start'\n-                )}\n-              >\n-                <Header\n-                  onClick={() =>\n-                    onSetSort(\n-                      (col.header.altSort && sort.field === col.header.altSort\n-                        ? col.header.altSort\n-                        : col.header.sort) as BetSort\n-                    )\n-                  }\n-                  up={\n-                    sort.field === col.header.sort ||\n-                    sort.field === col.header.altSort\n-                      ? sort.direction === 'asc'\n-                      : undefined\n-                  }\n-                  className=\"text-sm font-semibold\"\n-                >\n-                  {col.header.label}\n-                </Header>\n-                {col.headerBuddy ? col.headerBuddy : null}\n-              </span>\n-            )\n-          )}\n-          {isMobile && (\n-            <div className=\"absolute bottom-1.5 right-0\">\n-              <DropdownMenu\n-                menuWidth=\"w-32\"\n-                items={[\n-                  {\n-                    name: 'Edit Columns',\n-                    onClick: () => setModalOpen(true),\n-                  },\n-                ]}\n-                buttonContent={<BsThreeDotsVertical className=\"h-4\" />}\n-              />\n-            </div>\n-          )}\n-        </div>\n         {contracts\n           .slice(currentSlice, currentSlice + rowsPerSection)\n           .map((contract) => {\n+            const metric = metricsByContractId[contract.id]\n+            const closeDate = contract.resolutionTime ?? contract.closeTime\n+            const date = closeDate ? new Date(closeDate) : null\n+            const isThisYear = date\n+              ? new Date().getFullYear() === date.getFullYear()\n+              : false\n+            const dateString = date\n+              ? date.toLocaleDateString('en-US', {\n+                  month: '2-digit',\n+                  day: '2-digit',\n+                  year: isThisYear ? undefined : '2-digit',\n+                })\n+              : 'N/A'\n+            const resolvedAnswer =\n+              contract.mechanism === 'cpmm-multi-1'\n+                ? contract.answers.find(\n+                    (a) =>\n+                      a.id === contract.resolution ||\n+                      (contract.resolutions?.[a.id] ?? 0) >= 99\n+                  )\n+                : undefined\n+\n             return (\n               <Row\n                 key={contract.id + 'bets-table-row'}\n                 className={\n-                  'border-ink-200 hover:bg-canvas-50 cursor-pointer border-b py-2'\n+                  'border-ink-200 hover:bg-canvas-50 cursor-pointer border-b py-3'\n                 }\n+                onClick={() => setNewExpandedId(contract.id)}\n               >\n-                <Col className={'w-full gap-3 sm:gap-2'}>\n-                  {/* Contract title*/}\n-                  <Row className={'justify-between'}>\n-                    <Link\n-                      href={contractPath(contract)}\n-                      className={clsx(\n-                        linkClass,\n-                        'line-clamp-2 flex items-center pr-2 sm:pr-1'\n-                      )}\n-                      onClick={(e) => e.stopPropagation()}\n-                    >\n-                      <span className=\"mr-2 inline-flex items-center\">\n-                        <Avatar\n-                          avatarUrl={contract.creatorAvatarUrl}\n-                          size={'2xs'}\n-                          className={''}\n-                        />\n-                      </span>\n-                      <span className=\"text-ink-600 line-clamp-1\">\n+                <Col className=\"w-full px-2\">\n+                  <Row className=\"justify-between\">\n+                    {/* Left side - Question, probability and creator */}\n+                    <Col className=\"w-3/4\">\n+                      <Link\n+                        href={contractPath(contract)}\n+                        className={clsx(\n+                          linkClass,\n+                          'line-clamp-2 text-lg font-medium'\n+                        )}\n+                        onClick={(e) => e.stopPropagation()}\n+                      >\n                         {contract.token == 'CASH' && (\n-                          <span>\n-                            <Tooltip\n-                              text={SWEEPIES_MARKET_TOOLTIP}\n-                              className=\" relative mr-0.5 inline-flex h-[1em] w-[1.1em] items-baseline\"\n+                          <Tooltip\n+                            text={SWEEPIES_MARKET_TOOLTIP}\n+                            className=\"relative mr-0.5 inline-flex h-[1em] w-[1.1em] items-baseline\"\n+                          >\n+                            <SweepiesCoin className=\"absolute inset-0 top-[0.2em]\" />\n+                          </Tooltip>\n+                        )}\n+                        {contract.question}\n+                      </Link>\n+                      <Row className=\"mt-1 items-center\">\n+                        {contract.isResolved ? (\n+                          <span className=\"text-ink-800 mr-1 text-sm\">\n+                            {contract.outcomeType === 'MULTIPLE_CHOICE' ? (\n+                              Object.values(contract.resolutions ?? {}).filter(\n+                                (r) => r > 1\n+                              ).length > 1 || contract.resolution === 'MKT' ? (\n+                                <span>MULTI</span>\n+                              ) : contract.resolution === 'CANCEL' ? (\n+                                <BinaryOutcomeLabel outcome=\"CANCEL\" />\n+                              ) : resolvedAnswer ? (\n+                                <MultiOutcomeLabel\n+                                  answer={resolvedAnswer}\n+                                  resolution={contract.resolution ?? ''}\n+                                  truncate=\"none\"\n+                                  answerClassName={\n+                                    'font-bold text-base-400 !break-normal'\n+                                  }\n+                                />\n+                              ) : null\n+                            ) : (\n+                              <ContractStatusLabel contract={contract} />\n+                            )}\n+                            <span className=\"text-ink-500 ml-1 text-sm\">•</span>\n+                          </span>\n+                        ) : contract.outcomeType !== 'MULTIPLE_CHOICE' ? (\n+                          <span className=\"text-ink-800 mr-1 text-sm\">\n+                            <ContractStatusLabel contract={contract} />\n+                            <span className=\"text-ink-500 ml-1 text-sm\">•</span>\n+                          </span>\n+                        ) : null}\n+                        <Row className=\"items-center gap-1\">\n+                          {/* <Avatar\n+                            avatarUrl={contract.creatorAvatarUrl}\n+                            username={contract.creatorUsername}\n+                            size={'xs'}\n+                          /> */}\n+                          <span className=\"text-ink-500 text-sm\">\n+                            {contract.creatorName}\n+                          </span>\n+\n+                          {sortOption.field === 'closeTime' ? (\n+                            <span className=\"text-ink-500 text-sm\">\n+                              • {dateString}\n+                            </span>\n+                          ) : sortOption.field === 'newest' ? (\n+                            <span className=\"text-ink-500 text-sm\">\n+                              •\n+                              <RelativeTimestamp\n+                                time={metric.lastBetTime}\n+                                className=\"text-ink-500 text-sm\"\n+                                shortened\n+                              />\n+                            </span>\n+                          ) : null}\n+                        </Row>\n+                      </Row>\n+                    </Col>\n+\n+                    {/* Right side - Value and profit */}\n+                    <Row className=\"items-start gap-2\">\n+                      <Col className=\"text-right\">\n+                        {/* Display different values based on sort selection */}\n+                        {sortOption.field === 'position' ? (\n+                          <span className=\"text-ink-900 text-lg font-medium\">\n+                            {formatWithToken({\n+                              amount: sum(Object.values(metric.totalShares)),\n+                              token: contract.token === 'CASH' ? 'CASH' : 'M$',\n+                            }).replace('-', '')}\n+                          </span>\n+                        ) : (\n+                          <span className=\"text-ink-900 text-lg font-medium\">\n+                            {formatWithToken({\n+                              amount: metric.payout,\n+                              token: contract.token === 'CASH' ? 'CASH' : 'M$',\n+                            }).replace('-', '')}\n+                          </span>\n+                        )}\n+\n+                        {sortOption.field === 'day' ? (\n+                          <span\n+                            className={clsx(\n+                              'text-sm font-medium',\n+                              (metric.from?.day.profit ?? 0) > 0\n+                                ? 'text-teal-500'\n+                                : 'text-ink-500'\n+                            )}\n+                          >\n+                            {formatWithToken({\n+                              amount: metric.from?.day.profit ?? 0,\n+                              token: contract.token === 'CASH' ? 'CASH' : 'M$',\n+                            }).replace('-', '')}\n+                            <span\n+                              className={clsx(\n+                                'ml-1 rounded-full px-1.5 py-0.5 text-xs',\n+                                (metric.from?.day.profitPercent ?? 0) > 0\n+                                  ? 'bg-teal-100 text-teal-800'\n+                                  : 'bg-canvas-50 text-ink-600'\n+                              )}\n                             >\n-                              <SweepiesCoin className=\"absolute inset-0 top-[0.2em]\" />\n-                            </Tooltip>\n+                              {(metric.from?.day.profitPercent ?? 0) > 0\n+                                ? '+'\n+                                : ''}\n+                              {(metric.from?.day.profitPercent ?? 0).toFixed(0)}\n+                              %\n+                            </span>\n                           </span>\n+                        ) : sortOption.field === 'week' ? (\n+                          <span\n+                            className={clsx(\n+                              'text-sm font-medium',\n+                              (metric.from?.week.profit ?? 0) > 0\n+                                ? 'text-teal-500'\n+                                : 'text-ink-500'\n+                            )}\n+                          >\n+                            {formatWithToken({\n+                              amount: metric.from?.week.profit ?? 0,\n+                              token: contract.token === 'CASH' ? 'CASH' : 'M$',\n+                            }).replace('-', '')}\n+                            <span\n+                              className={clsx(\n+                                'ml-1 rounded-full px-1.5 py-0.5 text-xs',\n+                                (metric.from?.week.profitPercent ?? 0) > 0\n+                                  ? 'bg-teal-100 text-teal-800'\n+                                  : 'bg-canvas-50 text-ink-600'\n+                              )}\n+                            >\n+                              {(metric.from?.week.profitPercent ?? 0) > 0\n+                                ? '+'\n+                                : ''}\n+                              {(metric.from?.week.profitPercent ?? 0).toFixed(\n+                                0\n+                              )}\n+                              %\n+                            </span>\n+                          </span>\n+                        ) : (\n+                          <span\n+                            className={clsx(\n+                              'text-sm font-medium',\n+                              metric.profit > 0\n+                                ? 'text-teal-500'\n+                                : 'text-ink-500'\n+                            )}\n+                          >\n+                            {formatWithToken({\n+                              amount: metric.profit,\n+                              token: contract.token === 'CASH' ? 'CASH' : 'M$',\n+                            }).replace('-', '')}\n+                            <span\n+                              className={clsx(\n+                                'ml-1 rounded-full px-1.5 py-0.5 text-xs',\n+                                metric.profitPercent > 0\n+                                  ? 'bg-teal-100 text-teal-800'\n+                                  : 'bg-canvas-50 text-ink-600'\n+                              )}\n+                            >\n+                              {metric.profitPercent > 0 ? '+' : ''}\n+                              {metric.profitPercent.toFixed(0)}%\n+                            </span>\n+                          </span>\n                         )}\n-                        {contract.question}\n-                      </span>\n-                      <span className={' ml-1 flex min-w-[40px] justify-end'}>\n-                        <ContractStatusLabel\n-                          className={\n-                            '!text-ink-600 whitespace-nowrap font-semibold'\n-                          }\n-                          contract={contract}\n+                      </Col>\n+                      <Col className=\"flex items-start pt-1\">\n+                        <ChevronDownIcon\n+                          className={clsx(\n+                            'text-ink-500 h-4 w-4 transition-transform',\n+                            expandedIds.includes(contract.id)\n+                              ? 'rotate-180'\n+                              : ''\n+                          )}\n                         />\n-                      </span>\n-                    </Link>\n-                    <IconButton\n-                      size={'2xs'}\n-                      onClick={() => setNewExpandedId(contract.id)}\n-                    >\n-                      {expandedIds.includes(contract.id) ? (\n-                        <ChevronUpIcon className=\"h-4\" />\n-                      ) : (\n-                        <ChevronUpIcon className=\"h-4 rotate-180\" />\n-                      )}\n-                    </IconButton>\n+                      </Col>\n+                    </Row>\n                   </Row>\n \n-                  {/* Contract Metrics details*/}\n-                  <div\n-                    className={'grid-cols-15 grid w-full'}\n-                    onClick={() => setNewExpandedId(contract.id)}\n-                  >\n-                    {columnsToDisplay.map((c) => (\n-                      <div\n-                        className={clsx(getColSpan(c.span))}\n-                        key={c.header.sort + contract.id + 'row'}\n-                      >\n-                        {c.renderCell(contract)}\n-                      </div>\n-                    ))}\n-                  </div>\n-                  <Col className={'-mt-2 w-full'}>\n-                    {expandedIds.includes(contract.id) && (\n-                      <ExpandedBetRow\n-                        contract={contract}\n-                        user={user}\n-                        signedInUser={signedInUser}\n-                        contractMetric={metricsByContractId[contract.id]}\n-                        areYourBets={areYourBets}\n-                      />\n-                    )}\n-                  </Col>\n+                  {/* Expanded View */}\n+                  {expandedIds.includes(contract.id) && (\n+                    <ExpandedBetRow\n+                      contract={contract}\n+                      user={user}\n+                      signedInUser={signedInUser}\n+                      contractMetric={metricsByContractId[contract.id]}\n+                      areYourBets={areYourBets}\n+                    />\n+                  )}\n                 </Col>\n               </Row>\n             )\n           })}\n@@ -769,41 +775,8 @@\n         pageSize={rowsPerSection}\n         totalItems={contracts.length}\n         setPage={setPage}\n       />\n-      <Modal setOpen={setModalOpen} open={modalOpen}>\n-        <div className={MODAL_CLASS}>\n-          <span className=\"mb-4 text-lg font-bold\">\n-            {enabledColumnsCount >= MAX_SHOWN_MOBILE\n-              ? `Unselect ${\n-                  MAX_SHOWN_MOBILE + 1 - enabledColumnsCount\n-                } column to select another`\n-              : `Select ${\n-                  MAX_SHOWN_MOBILE - enabledColumnsCount\n-                } more ${maybePluralize(\n-                  'column',\n-                  MAX_SHOWN_MOBILE - enabledColumnsCount\n-                )} (max 5)`}\n-          </span>\n-          {columns.map((col) => (\n-            <div key={col.sort}>\n-              <div className=\"mb-2 flex items-center\">\n-                <input\n-                  type=\"checkbox\"\n-                  disabled={\n-                    !col.enabled &&\n-                    columns.filter((c) => c.enabled).length >= MAX_SHOWN_MOBILE\n-                  }\n-                  checked={col.enabled}\n-                  onChange={() => handleColumnToggle(col.sort)}\n-                />\n-                <label className=\"ml-2\">{col.label}</label>\n-              </div>\n-            </div>\n-          ))}\n-          <Button onClick={() => setModalOpen(false)}>Done</Button>\n-        </div>\n-      </Modal>\n     </Col>\n   )\n }\n \n@@ -873,69 +846,14 @@\n         bets={bets}\n         isYourBets={areYourBets}\n         contractMetric={contractMetric}\n         paginate\n+        defaultExpanded\n       />\n     </Col>\n   )\n }\n \n-const NumberCell = (props: {\n-  num: number\n-  change?: boolean\n-  isCashContract: boolean\n-}) => {\n-  const { num, change, isCashContract } = props\n-  const formattedNum =\n-    num < 1000 && num > -1000\n-      ? formatWithToken({ amount: num, token: isCashContract ? 'CASH' : 'M$' })\n-      : isCashContract\n-      ? SWEEPIES_MONIKER + shortFormatNumber(num)\n-      : ENV_CONFIG.moneyMoniker + shortFormatNumber(num)\n-  return (\n-    <Row className=\"items-start justify-end \">\n-      {change &&\n-      formattedNum !==\n-        formatWithToken({\n-          amount: 0,\n-          token: isCashContract ? 'CASH' : 'M$',\n-        }) ? (\n-        num > 0 ? (\n-          <span className=\"text-teal-500\">{formattedNum}</span>\n-        ) : (\n-          <span className=\"text-ink-500\">{formattedNum}</span>\n-        )\n-      ) : (\n-        <span className=\"text-ink-800\">{formattedNum}</span>\n-      )}\n-    </Row>\n-  )\n-}\n-\n-const Header = (props: {\n-  children: ReactNode\n-  onClick?: () => void\n-  up?: boolean\n-  className?: string\n-}) => {\n-  const { onClick, up, className, children } = props\n-  return (\n-    <Row\n-      className={clsx(className, 'cursor-pointer items-center')}\n-      onClick={onClick}\n-    >\n-      {up != undefined ? (\n-        up ? (\n-          <BiCaretUp className=\" h-4\" />\n-        ) : (\n-          <BiCaretDown className=\" h-4\" />\n-        )\n-      ) : null}\n-      <span>{children}</span>\n-    </Row>\n-  )\n-}\n-\n export function LoadingMetricRow() {\n   return (\n     <div className=\"animate-pulse py-4\">\n       <Row className=\"mb-2 items-center gap-2\">\n"
        },
        {
          "path": "web/components/contract/text-color.ts",
          "status": "modified",
          "diff": "Index: web/components/contract/text-color.ts\n===================================================================\n--- web/components/contract/text-color.ts\t80a4d94 (parent)\n+++ web/components/contract/text-color.ts\t702a5b8 (commit)\n@@ -13,9 +13,12 @@\n }) {\n   const { resolution } = contract\n \n   if (resolution) {\n-    return OUTCOME_TO_COLOR_TEXT[resolution as resolution] ?? 'text-primary-200'\n+    return (\n+      OUTCOME_TO_COLOR_TEXT[resolution as resolution] ??\n+      'text-blue-600 dark:text-blue-200'\n+    )\n   }\n   if ((contract.closeTime ?? Infinity) < Date.now()) {\n     return 'text-ink-600'\n   }\n"
        },
        {
          "path": "web/components/widgets/pagination.tsx",
          "status": "modified",
          "diff": "Index: web/components/widgets/pagination.tsx\n===================================================================\n--- web/components/widgets/pagination.tsx\t80a4d94 (parent)\n+++ web/components/widgets/pagination.tsx\t702a5b8 (commit)\n@@ -88,9 +88,12 @@\n       aria-label=\"Pagination\"\n     >\n       <Row className=\"mx-auto gap-4\">\n         <PaginationArrow\n-          onClick={() => onClick(page - 1)}\n+          onClick={(e) => {\n+            e?.stopPropagation()\n+            onClick(page - 1)\n+          }}\n           disabled={page <= 0}\n           nextOrPrev=\"prev\"\n         />\n         <Row className=\"gap-2\">\n@@ -107,9 +110,12 @@\n             />\n           ))}\n         </Row>\n         <PaginationArrow\n-          onClick={() => onClick(page + 1)}\n+          onClick={(e) => {\n+            e?.stopPropagation()\n+            onClick(page + 1)\n+          }}\n           disabled={page >= maxPage}\n           nextOrPrev=\"next\"\n         />\n       </Row>\n@@ -117,9 +123,9 @@\n   )\n }\n \n export function PaginationArrow(props: {\n-  onClick: () => void\n+  onClick: (e?: React.MouseEvent) => void\n   disabled: boolean\n   nextOrPrev: 'next' | 'prev'\n }) {\n   const { onClick, disabled, nextOrPrev } = props\n@@ -153,9 +159,12 @@\n     return <div className=\"text-ink-400 select-none\">{PAGE_ELLIPSES}</div>\n   }\n   return (\n     <button\n-      onClick={() => setPage(pageNumber)}\n+      onClick={(e) => {\n+        e.stopPropagation()\n+        setPage(pageNumber)\n+      }}\n       className={clsx(\n         'select-none rounded-lg px-2',\n         page === pageNumber\n           ? 'bg-primary-100 text-primary-700'\n"
        },
        {
          "path": "web/pages/[username]/index.tsx",
          "status": "modified",
          "diff": "Index: web/pages/[username]/index.tsx\n===================================================================\n--- web/pages/[username]/index.tsx\t80a4d94 (parent)\n+++ web/pages/[username]/index.tsx\t702a5b8 (commit)\n@@ -312,19 +312,12 @@\n           )}\n \n           <Row className={'items-center gap-1 sm:gap-2'}>\n             {isCurrentUser ? (\n-              <Row className=\"my-2 hidden items-center gap-2 px-4 sm:flex\">\n-                <AddFundsButton\n-                  userId={user.id}\n-                  className=\"whitespace-nowra w-full lg:hidden\"\n-                />\n-                <RedeemSweepsButtons\n-                  user={user}\n-                  className=\"shrink-0\"\n-                  redeemableCash={user.cashBalance}\n-                />\n-              </Row>\n+              <AddFundsButton\n+                userId={user.id}\n+                className=\"mr-2 w-full whitespace-nowrap px-8 lg:hidden\"\n+              />\n             ) : (\n               <>\n                 <SendMessageButton toUser={user} currentUser={currentUser} />\n                 <FollowButton userId={user.id} />\n@@ -351,19 +344,13 @@\n           </Col>\n         )}\n \n         {isCurrentUser && (\n-          <Row className=\"my-2 w-full items-center gap-2 px-4 sm:hidden\">\n-            <AddFundsButton\n-              userId={user.id}\n-              className=\"w-1/2 whitespace-nowrap\"\n-            />\n-            <RedeemSweepsButtons\n-              user={user}\n-              className=\"w-1/2\"\n-              redeemableCash={user.cashBalance}\n-            />\n-          </Row>\n+          <RedeemSweepsButtons\n+            user={user}\n+            className=\"m-2 w-48\"\n+            redeemableCash={user.cashBalance}\n+          />\n         )}\n \n         <Col className=\"mx-4\">\n           <QueryUncontrolledTabs\n"
        }
      ]
    },
    {
      "id": "rename-movement-notifications",
      "sha": "1a0388e961b3fb78df303f2e88e956d872c7c54e",
      "parentSha": "b8d7c2f3e30e273d370a48a43f80ec29049bba2e",
      "spec": "Rename the movement notifications module and exported function from “contract” to “market” across the backend codebase without altering functionality.\n\nScope of changes:\n1) Shared module file rename\n- Move backend/shared/src/send-contract-movement-notifications.ts to backend/shared/src/send-market-movement-notifications.ts.\n\n2) Exported function rename within the file\n- In the renamed file backend/shared/src/send-market-movement-notifications.ts, change the exported function name from sendContractMovementNotifications to sendMarketMovementNotifications. Do not change the function body, parameters, or behavior.\n\n3) Update all imports and call sites to the new path and name\n- In backend/scheduler/src/jobs/index.ts:\n  - Import from 'shared/send-market-movement-notifications' and reference sendMarketMovementNotifications.\n  - Update the scheduled job callback to () => sendMarketMovementNotifications(false).\n- In backend/scripts/test-market-movements.ts:\n  - Import from 'shared/send-market-movement-notifications' and reference sendMarketMovementNotifications.\n  - Update the call to await sendMarketMovementNotifications(true).\n\n4) Remove stale references\n- Ensure there are no remaining imports from 'shared/send-contract-movement-notifications' and no references to sendContractMovementNotifications anywhere in the repository.\n\nAcceptance criteria:\n- Type check and build pass.\n- Scheduler job compiles and schedules using sendMarketMovementNotifications(false).\n- Test script compiles and runs using sendMarketMovementNotifications(true).\n- Repository-wide search finds no references to the old module path or function name.",
      "prompt": "Standardize naming from “contract movement notifications” to “market movement notifications.” Rename the shared module to the market-based name, rename its exported function accordingly, and update the scheduler job and test script to import and call the new function from the new module path. Preserve all behavior; this is only a naming and path update. Confirm there are no lingering references to the old name and that the project builds successfully.",
      "supplementalFiles": [
        "backend/shared/src/send-contract-movement-notifications.ts",
        "backend/shared/src/utils.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/scheduler/src/jobs/index.ts",
          "status": "modified",
          "diff": "Index: backend/scheduler/src/jobs/index.ts\n===================================================================\n--- backend/scheduler/src/jobs/index.ts\tb8d7c2f (parent)\n+++ backend/scheduler/src/jobs/index.ts\t1a0388e (commit)\n@@ -35,9 +35,9 @@\n   resetWeeklyQuestStatsInternal,\n } from './reset-quests-stats'\n import { updateUserPortfolioHistoriesCore } from 'shared/update-user-portfolio-histories-core'\n import { isProd } from 'shared/utils'\n-import { sendContractMovementNotifications } from 'shared/send-contract-movement-notifications'\n+import { sendMarketMovementNotifications } from 'shared/send-contract-movement-notifications'\n export function createJobs() {\n   return [\n     // Hourly jobs:\n     createJob(\n@@ -72,9 +72,9 @@\n     ),\n     createJob(\n       'send-contract-movement-notifications',\n       '0 12 * * * *', // on the 12th minute of every hour\n-      () => sendContractMovementNotifications(false)\n+      () => sendMarketMovementNotifications(false)\n     ),\n     createJob(\n       'calculate-conversion-scores',\n       '0 46 * * * *', // on the 46th minute of every hour\n"
        },
        {
          "path": "backend/scripts/test-market-movements.ts",
          "status": "modified",
          "diff": "Index: backend/scripts/test-market-movements.ts\n===================================================================\n--- backend/scripts/test-market-movements.ts\tb8d7c2f (parent)\n+++ backend/scripts/test-market-movements.ts\t1a0388e (commit)\n@@ -1,6 +1,6 @@\n import { runScript } from 'run-script'\n-import { sendContractMovementNotifications } from 'shared/send-contract-movement-notifications'\n+import { sendMarketMovementNotifications } from 'shared/send-contract-movement-notifications'\n \n runScript(async () => {\n-  await sendContractMovementNotifications(true)\n+  await sendMarketMovementNotifications(true)\n })\n"
        },
        {
          "path": "backend/shared/src/send-market-movement-notifications.ts",
          "status": "renamed",
          "oldPath": "backend/shared/src/send-contract-movement-notifications.ts",
          "diff": "===================================================================\n--- backend/shared/src/send-contract-movement-notifications.ts\tb8d7c2f (parent)\n+++ backend/shared/src/send-market-movement-notifications.ts\t1a0388e (commit)\n@@ -17,9 +17,9 @@\n const nowPeriodHoursAgoStart = 2\n const TEST_USER_ID = 'AJwLWoo3xue32XIiAVrL5SyR1WB2'\n const TEST_CONTRACT_IDS = `'Ll8LclSZ8C', 'Z8CqLOzRAq', '6A9gSqIzld', 'D5o5fIGpQnjANdl2DxdU'`\n \n-export async function sendContractMovementNotifications(debug = false) {\n+export async function sendMarketMovementNotifications(debug = false) {\n   const pg = createSupabaseDirectClient()\n   const now = Date.now()\n   const nowStart = now - nowPeriodHoursAgoStart * HOUR_MS\n   const nowEnd = now\n"
        }
      ]
    },
    {
      "id": "add-date-markets",
      "sha": "e96bced24acd6e3e19bff1fd849b6dc35ec317f1",
      "parentSha": "d70bc7a4d2878aa28eca08c69e2786f034a254e0",
      "spec": "Implement a new predictive market outcome type: DATE.\n\nFunctional requirements\n- A DATE market can be created with answers (ranges or thresholds) and midpoints (timestamps in ms), with shouldAnswersSumToOne controlling buckets vs thresholds.\n- The market stores an IANA timezone string and an optional display mode 'clock' or 'default'.\n- Creators can use AI to generate date ranges (both buckets and thresholds) and regenerate midpoints when ranges change.\n- Expected date displays on contract pages, tables, and OG metadata; optionally as a live clock when display='clock'.\n- A time-series chart shows expected date over time with date-formatted Y-axis and time-based X-axis.\n- Bets and resolutions for DATE use existing cpmm-multi-1 paths without adding new outcome-type-specific branches.\n- Duplicating a DATE market carries over answers and midpoints (no unit); search filters include DATE; notifications and resolution helpers treat DATE like multi contracts, respecting independent vs sum-to-one behavior.\n\nCommon (types, unions, helpers)\n- Define MultiDate type (like MultiNumeric but with outcomeType 'DATE', timezone: string, optional display: 'clock').\n- Extend unions/aliases to include MultiDate: AnyContractType, MarketContract, MultiContract; include 'DATE' in CREATEABLE_OUTCOME_TYPES; exclude from isSpecialLoveContract.\n- Add chart ValueKind 'date'.\n- Add multi-date helpers: getExpectedDate (handles buckets and thresholds with tail handling) and formatExpectedDate; reuse getMinMax to return min/max of date midpoints.\n- Rename numeric-only constant MULTI_NUMERIC_BUCKETS_MAX to NUMBER_BUCKETS_MAX where used for numeric bucket precision checks (DATE does not use unit or number bucket limits).\n\nValidation schemas\n- Add createMultiDateSchema with fields: outcomeType 'DATE', answers (string[]; length <= MAX_MULTI_NUMERIC_ANSWERS), midpoints (number[] ms; length <= same), shouldAnswersSumToOne (boolean), addAnswersMode 'DISABLED', timezone (string).\n- Update createMarketProps to include createMultiDateSchema.\n- Update updateMarketProps to accept display?: 'clock' | 'default'.\n- Update API schema:\n  - generate-ai-date-ranges props: { question, min, max, description? }; returns { buckets: {answers, midpoints}, thresholds: {answers, midpoints} }.\n  - regenerate-date-midpoints props: { question, description?, answers, min, max, tab: 'thresholds' | 'buckets' }; returns { midpoints } with ms epoch values.\n- Update market-search-types to include 'DATE'.\n\nBackend API\n- Create market: validate DATE using createMultiDateSchema; enforce answers.length >= 2 and answers.length === midpoints.length; pass timezone to contract creation and native columns.\n- AI date ranges:\n  - generate-ai-date-ranges: prompt the model to return both buckets and thresholds with answers and midpoints as ISO date strings. Convert midpoints to ms (convertDateMidpointsToTimes), assert uniqueness and ascending order; return both sets.\n  - regenerate-date-midpoints: accept tab; prompt for midpoint dates only, convert to ms, assert uniqueness and ascending order; return ms array.\n- Update update-market to persist display.\n- Clean contract for static props: preserve answers for DATE.\n- Place bet / resolve: rely on mechanism branching (cpmm-1 vs cpmm-multi-1) so DATE is included automatically.\n- Notifications and resolve helpers: use MarketContract and include DATE in multi-choice logic (independent multi if shouldAnswersSumToOne is false).\n\nEconomy and payouts\n- Treat DATE like multi when computing ante (common/economy).\n- Collapse fixed payout helpers for multi contracts to accept MultiContract (includes DATE) when calculating payouts.\n\nContract creation\n- Implement getDateProps in new-contract.ts to build MultiDate contracts with provided answers/midpoints, shouldAnswersSumToOne, and timezone. Do not set unit for DATE.\n\nWeb UI and charting\n- Add MultiDate chart component rendering expected-date history:\n  - For buckets, sum prob*midpoint across answers.\n  - For thresholds, use discrete probabilities (diff of cumulative thresholds) with a tail beyond the last threshold interval.\n  - Use yKind='date' and date-formatted ticks in the generic chart.\n- Enhance generic chart to support yKind 'date' with appropriate tick formatting (years, month-year, month-day based on span).\n- Expected date display component:\n  - When unresolved, show formatted expected date with animated number; if display='clock', show live Clock to expected date with tz tooltip.\n  - When resolved, show resolved answer text or cancel label.\n- Contract overview for DATE: show time range picker, the date chart, and answers panel; show resolution panel based on shouldAnswersSumToOne.\n- Treat DATE as multi in:\n  - contract-page bet data fetching (include DATE in multiPoints processing).\n  - contracts table / SEO expected value formatting.\n  - answers panel prop types (use MultiContract).\n  - hide binary multi panels where DATE should not appear.\n  - duplicate-contract: carry over answers and midpoints; only set unit for MULTI_NUMERIC.\n\nClock component\n- Support year or ms timestamp inputs; add size prop (xs|sm|md|lg) that controls text sizing and layout; update to compute durations from ms target.\n\nAcceptance\n- Creating a DATE market via UI with AI-generated ranges is possible; input fields collect min/max date strings; switching between tabs (buckets/thresholds) updates shouldAnswersSumToOne and keeps separate answers/midpoints per tab; midpoint regeneration debounced and robust to errors.\n- Expected date displays consistently across contract page, tables, and OG metadata. Clock mode works with visible ticking and timezone tooltip.\n- Chart renders and scales correctly, with date-formatted Y-axis and time-based X-axis; zoom/slider integration works.\n- Bets and resolution paths work without DATE-specific conditionals beyond mechanism-based branching.\n- Search includes DATE filter; notifications are sent for DATE resolutions; duplicate-contract URL includes answers and midpoints for DATE.\n- API contracts conform to updated schemas; midpoints are validated (unique, ascending) and converted from ISO strings to epoch ms.",
      "prompt": "Add a new Date market outcome type across backend, shared, and web. The type should behave like multi-choice numeric markets but represent answer midpoints as timestamps. Support two modes: buckets (answers sum to one) and thresholds (cumulative). Include timezone on creation and a toggleable clock display. Provide AI endpoints to generate date ranges (both buckets and thresholds) and to regenerate midpoint dates when ranges change. Update types, schemas, creation flows, expected date calculation/formatting, charting with date axes, and UI so DATE is handled like other cpmm-multi-1 markets for betting, resolving, duplication, search, and notifications.",
      "supplementalFiles": [
        "common/src/calculate.ts",
        "common/src/answer.ts",
        "common/src/numeric-constants.ts",
        "web/lib/api/api.ts",
        "web/components/charts/contract/single-value.tsx",
        "web/components/charts/helpers.ts",
        "web/components/sized-container.tsx",
        "web/components/widgets/tooltip.tsx",
        "backend/api/src/helpers/rate-limit.ts",
        "backend/api/src/helpers/endpoint.ts",
        "web/components/charts/contract/number.tsx"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/create-market.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/create-market.ts\n===================================================================\n--- backend/api/src/create-market.ts\td70bc7a (parent)\n+++ backend/api/src/create-market.ts\te96bced (commit)\n@@ -7,8 +7,9 @@\n   createNumericSchema,\n   createPollSchema,\n   toLiteMarket,\n   createMultiNumericSchema,\n+  createMultiDateSchema,\n } from 'common/api/market-types'\n import { ValidatedAPIParams } from 'common/api/schema'\n import {\n   Contract,\n@@ -127,8 +128,9 @@\n     takerAPIOrdersDisabled,\n     liquidityTier,\n     unit,\n     midpoints,\n+    timezone,\n   } = validateMarketBody(body)\n \n   const userId = auth.uid\n \n@@ -220,8 +222,9 @@\n           sportsLeague,\n           takerAPIOrdersDisabled,\n           unit: unit ?? '',\n           midpoints: midpoints,\n+          timezone: timezone,\n         })\n       )\n       const nativeKeys = nativeContractColumnsArray.map(camelCase)\n       const nativeValues = nativeKeys\n@@ -353,9 +356,10 @@\n     shouldAnswersSumToOne: boolean | undefined,\n     totalBounty: number | undefined,\n     isAutoBounty: boolean | undefined,\n     unit: string | undefined,\n-    midpoints: number[] | undefined\n+    midpoints: number[] | undefined,\n+    timezone: string | undefined\n \n   if (outcomeType === 'PSEUDO_NUMERIC') {\n     const parsed = validateMarketType(outcomeType, createNumericSchema, body)\n \n@@ -423,8 +427,22 @@\n         400,\n         'Number of answers must match number of midpoints.'\n       )\n   }\n+  if (outcomeType === 'DATE') {\n+    ;({ answers, midpoints, shouldAnswersSumToOne, timezone } =\n+      validateMarketType(outcomeType, createMultiDateSchema, body))\n+    if (answers.length < 2)\n+      throw new APIError(\n+        400,\n+        'Numeric markets must have at least 2 answer buckets.'\n+      )\n+    if (answers.length !== midpoints.length)\n+      throw new APIError(\n+        400,\n+        'Number of answers must match number of midpoints.'\n+      )\n+  }\n \n   if (outcomeType === 'MULTIPLE_CHOICE') {\n     ;({\n       answers,\n@@ -483,8 +501,9 @@\n     answerImageUrls,\n     takerAPIOrdersDisabled,\n     unit,\n     midpoints,\n+    timezone,\n   }\n }\n \n function validateMarketType<T extends z.ZodType>(\n"
        },
        {
          "path": "backend/api/src/generate-ai-date-ranges.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/generate-ai-date-ranges.ts\n===================================================================\n--- backend/api/src/generate-ai-date-ranges.ts\td70bc7a (parent)\n+++ backend/api/src/generate-ai-date-ranges.ts\te96bced (commit)\n@@ -1,185 +1,210 @@\n import { APIHandler } from './helpers/endpoint'\n import { track } from 'shared/analytics'\n-import {\n-  models,\n-  promptClaudeParsingJson,\n-} from 'shared/helpers/claude'\n+import { models, promptClaudeParsingJson } from 'shared/helpers/claude'\n import { log } from 'shared/utils'\n import { rateLimitByUser } from './helpers/rate-limit'\n import { HOUR_MS } from 'common/util/time'\n import {\n   assertMidpointsAreAscending,\n   assertMidpointsAreUnique,\n-  RangeResponse,\n } from './generate-ai-numeric-ranges'\n // Shared guidelines for both threshold and bucket ranges\n // Base system prompt template that both threshold and bucket prompts will use\n \n-const baseDateSystemPrompt = () => {\n+type DateRangeResponse = {\n+  answers: string[]\n+  midpoints: string[]\n+}\n+\n+const baseDateSystemPrompt = (type: 'buckets' | 'thresholds') => {\n   return `\n     You are a helpful AI assistant that generates date ranges for prediction market questions.\n     \n     GUIDLINES:\n     - Generate 2-12 ranges that cover the entire span from start to end\n     - Err on the side of fewer (3-5) ranges when possible\n-    - Favor human-friendly ranges like:\n-      * Round numbers\n-      * Smaller ranges for more precision when values are likely to be close\n+    - Do NOT generate more than 12 ranges\n+    - Today's date is ${new Date().toISOString()}\n     - Each range should have a midpoint value for expected value calculations\n+    - The midpoints should be dates that represent the exact middle date of the range.\n     - Return the ranges and associated midpoints in ascending order\n-    - If the unit is a year/month/day and the max-min < 10 just use single years/months/days as buckets.\n-    - If the unit is a unit of time, the midpoint should be the ms from now to the target date.\n+    ${\n+      type === 'buckets'\n+        ? '- If the min/max is a year/month/day and the max-min < 10 just use single years/months/days as buckets.'\n+        : `- If the min/max is a year/month/day and the max-min < 10 just use single 'before year/ before month/ before day' as thresholds.`\n+    }\n     - ONLY return a single JSON object without any other text or formatting:\n     {\n       answers: array of range strings,\n-      midpoints: array of corresponding midpoint numbers\n+      midpoints: array of corresponding midpoint dates\n     }\n-    ${bucketExamples}\n+    ${type === 'buckets' ? bucketExamples : thresholdExamples}\n `\n }\n \n const bucketExamples = `\n EXAMPLES:\n   Question: If convicted, when will SBF serve time? (min: 2025, max: 2028)\n   {\n     \"answers\": [\"2025\", \"2026\", \"2027\", \"2028\"],\n-    \"midpoints\": [2025.5, 2026.5, 2027.5, 2028.5]\n+    \"midpoints\": [\"2025-07-02\", \"2026-07-02\", \"2027-07-02\", \"2028-07-02\"]\n   }\n+\n+  Question: When will the next US recession begin? (min: Q1 2025, max: Q4 2026)\n+  {\n+    \"answers\": [\"Q1 2025\", \"Q2 2025\", \"Q3 2025\", \"Q4 2025\", \"Q1 2026\", \"Q2 2026\", \"Q3 2026\", \"Q4 2026\"],\n+    \"midpoints\": [\"2025-02-14\", \"2025-05-14\", \"2025-08-14\", \"2025-11-14\", \"2026-02-14\", \"2026-05-14\", \"2026-08-14\", \"2026-11-14\"]\n+  }\n+\n+  Question: When will SpaceX complete its first crewed Mars mission? (min: 2025, max: 2035)\n+  {\n+    \"answers\": [\"2025\", \"2026\", \"2027\", \"2028\", \"2029\", \"2030\", \"2031\", \"2032\", \"2033\", \"2034\", \"2035\"],\n+    \"midpoints\": [\"2025-07-02\", \"2026-07-02\", \"2027-07-02\", \"2028-07-02\", \"2029-07-02\", \"2030-07-02\", \"2031-07-02\", \"2032-07-02\", \"2033-07-02\", \"2034-07-02\", \"2035-07-02\"]\n+  }\n+\n+  Question: When will artificial general intelligence be achieved? (min: 2025, max: 2035)\n+  {\n+    \"answers\": [\"2025\", \"2026\", \"2027\", \"2028\", \"2029\", \"2030\", \"2031\", \"2032\", \"2033\", \"2034\", \"2035\"],\n+    \"midpoints\": [\"2025-07-02\", \"2026-07-02\", \"2027-07-02\", \"2028-07-02\", \"2029-07-02\", \"2030-07-02\", \"2031-07-02\", \"2032-07-02\", \"2033-07-02\", \"2034-07-02\", \"2035-07-02\"]\n+  }\n `\n \n-const giveTimeExample = () =>\n-  `The current time is ${new Date().toLocaleDateString('en-US', {\n-    year: 'numeric',\n-    month: 'long',\n-    day: 'numeric',\n-  })}`\n+const thresholdExamples = `\n+EXAMPLES:\n+  Question: If convicted, when will SBF start serving time? (min: 2025, max: 2028)\n+  {\n+    \"answers\": [\"Before 2026\", \"Before 2027\", \"Before 2028\", \"Before 2029\"],\n+    \"midpoints\": [\"2025-07-02\", \"2026-07-02\", \"2027-07-02\", \"2028-07-02\"]\n+  }\n \n+  Question: When will the next US recession begin? (min: Q1 2025, max: Q4 2026)\n+  {\n+    \"answers\": [\"Before Q1 2025\", \"Before Q2 2025\", \"Before Q3 2025\", \"Before Q4 2025\", \"Before Q1 2026\", \"Before Q2 2026\", \"Before Q3 2026\", \"Before Q4 2026\"],\n+    \"midpoints\": [\"2025-02-14\", \"2025-05-14\", \"2025-08-14\", \"2025-11-14\", \"2026-02-14\", \"2026-05-14\", \"2026-08-14\", \"2026-11-14\"]\n+  }\n+\n+  Question: When will SpaceX complete its first crewed Mars mission? (min: 2026, max: 2035)\n+  {\n+    \"answers\": [\"Before 2027\", \"Before 2028\", \"Before 2029\", \"Before 2030\", \"Before 2031\", \"Before 2032\", \"Before 2033\", \"Before 2034\", \"Before 2035\"],\n+    \"midpoints\": [\"2026-07-02\", \"2027-07-02\", \"2028-07-02\", \"2029-07-02\", \"2030-07-02\", \"2031-07-02\", \"2032-07-02\", \"2033-07-02\", \"2034-07-02\", \"2035-07-02\"]\n+  }\n+\n+  Question: When will artificial general intelligence be achieved? (min: 2025, max: 2035)\n+  {\n+    \"answers\": [\"Before 2026\", \"Before 2027\", \"Before 2028\", \"Before 2029\", \"Before 2030\", \"Before 2031\", \"Before 2032\", \"Before 2033\", \"Before 2034\", \"Before 2035\"],\n+    \"midpoints\": [\"2026-07-02\", \"2027-07-02\", \"2028-07-02\", \"2029-07-02\", \"2030-07-02\", \"2031-07-02\", \"2032-07-02\", \"2033-07-02\", \"2034-07-02\", \"2035-07-02\"]\n+  }\n+`\n+\n+const giveTimeExample = () => `The current time is ${new Date().toISOString()}`\n+\n const userPrompt = (\n   question: string,\n   min: string,\n   max: string,\n-  unit: string,\n   description?: string\n ) => {\n   return `Question: ${question} ${\n     description && description !== '<p></p>'\n       ? `\\nDescription: ${description}`\n       : ''\n-  }\\nStart: ${min} End: ${max} Unit: ${unit} ${giveTimeExample()}`\n+  }\\nStart: ${min} End: ${max} ${giveTimeExample()}`\n }\n \n export const generateAIDateRanges: APIHandler<'generate-ai-date-ranges'> =\n   rateLimitByUser(\n     async (props, auth) => {\n-      const { question, min, max, description, unit } = props\n+      const { question, min, max, description } = props\n \n-      const prompt = userPrompt(question, min, max, unit, description)\n+      const prompt = userPrompt(question, min, max, description)\n \n-      const bucketSystemPrompt = baseDateSystemPrompt()\n+      // Prepare system prompts\n+      const bucketSystemPrompt = baseDateSystemPrompt('buckets')\n+      const thresholdSystemPrompt = baseDateSystemPrompt('thresholds')\n \n-      const buckets = await promptClaudeParsingJson<RangeResponse>(prompt, {\n-        model: models.sonnet,\n-        system: bucketSystemPrompt,\n-      })\n+      // Generate both bucket and threshold ranges in parallel\n+      const [buckets, thresholds] = await Promise.all([\n+        promptClaudeParsingJson<DateRangeResponse>(prompt, {\n+          model: models.sonnet,\n+          system: bucketSystemPrompt,\n+        }),\n+        promptClaudeParsingJson<DateRangeResponse>(prompt, {\n+          model: models.sonnet,\n+          system: thresholdSystemPrompt,\n+        }),\n+      ])\n \n-      assertMidpointsAreUnique(buckets.midpoints)\n-      assertMidpointsAreAscending(buckets.midpoints)\n-      buckets.midpoints = convertTimeMidpointsToDates(unit, buckets.midpoints)\n-      log('buckets', buckets)\n+      // Process bucket results\n+      const convertedBuckets = {\n+        ...buckets,\n+        midpoints: convertDateMidpointsToTimes(buckets.midpoints),\n+      }\n+      assertMidpointsAreUnique(convertedBuckets.midpoints)\n+      assertMidpointsAreAscending(convertedBuckets.midpoints)\n+      log('buckets', convertedBuckets)\n+\n+      // Process threshold results\n+      const convertedThresholds = {\n+        ...thresholds,\n+        midpoints: convertDateMidpointsToTimes(thresholds.midpoints),\n+      }\n+      assertMidpointsAreUnique(convertedThresholds.midpoints)\n+      assertMidpointsAreAscending(convertedThresholds.midpoints)\n+      log('thresholds', convertedThresholds)\n+\n       track(auth.uid, 'generate-ai-date-ranges', {\n         question,\n       })\n \n       return {\n-        buckets,\n+        buckets: convertedBuckets,\n+        thresholds: convertedThresholds,\n       }\n     },\n     { maxCalls: 60, windowMs: HOUR_MS }\n   )\n \n export const regenerateDateMidpoints: APIHandler<'regenerate-date-midpoints'> =\n   rateLimitByUser(\n     async (props, auth) => {\n-      const { question, description, answers, min, max, unit } = props\n+      const { question, description, answers, min, max, tab } = props\n \n       const prompt = `${userPrompt(\n         question,\n         min,\n         max,\n-        unit,\n         description\n       )}\\nRanges: ${answers.join(', ')}.\n-      Generate appropriate midpoints for each range.\n+      Generate appropriate midpoint dates for each range.\n       RULES:\n-      - The midpoints should be numbers that represent the expected value for each range.\n-      - If the range is a log scale, use the geometric mean for the midpoint.\n+      - The midpoints should be the exact middle date of the range.\n \n-      ${bucketExamples}\n+      ${tab === 'buckets' ? bucketExamples : thresholdExamples}\n \n-      Return ONLY an array of midpoint numbers, one for each range, without any other text or formatting.`\n+      Return ONLY an array of midpoint dates, one for each range, without any other text or formatting.`\n \n-      const result = await promptClaudeParsingJson<number[]>(prompt, {\n+      const result = await promptClaudeParsingJson<string[]>(prompt, {\n         model: models.sonnet,\n       })\n       log('claudeResponse', result)\n \n-      track(auth.uid, 'regenerate-numeric-midpoints', {\n+      track(auth.uid, 'regenerate-date-midpoints', {\n         answers,\n       })\n \n-      assertMidpointsAreUnique(result)\n-      assertMidpointsAreAscending(result)\n+      const convertedMidpoints = convertDateMidpointsToTimes(result)\n \n-      return { midpoints: convertTimeMidpointsToDates(unit, result) }\n+      assertMidpointsAreUnique(convertedMidpoints)\n+      assertMidpointsAreAscending(convertedMidpoints)\n+\n+      return { midpoints: convertedMidpoints }\n     },\n     { maxCalls: 60, windowMs: HOUR_MS }\n   )\n \n-const convertTimeMidpointsToDates = (unit: string, midpoints: number[]) => {\n-  const now = new Date()\n-  const currentYear = now.getFullYear()\n-  const currentMonth = now.getMonth()\n-  const currentDay = now.getDate()\n-\n+const convertDateMidpointsToTimes = (midpoints: string[]) => {\n   return midpoints.map((midpoint) => {\n-    if (unit.trim().toLowerCase() === 'year') {\n-      // For years, calculate milliseconds from now to the target year point\n-      const targetYear = Math.floor(midpoint)\n-      const fraction = midpoint - targetYear\n-\n-      // Create date for the target year (same month/day as today)\n-      const targetDate = new Date(targetYear, currentMonth, currentDay)\n-\n-      // Add the fraction of the year in milliseconds if there is one\n-      if (fraction > 0) {\n-        const millisecondsInYear = 365.25 * 24 * 60 * 60 * 1000\n-        const additionalMilliseconds = Math.floor(fraction * millisecondsInYear)\n-        targetDate.setTime(targetDate.getTime() + additionalMilliseconds)\n-      }\n-\n-      // Return milliseconds from now to target date\n-      // If target is in the past, we'll return a small positive value (1 day)\n-      const msDiff = targetDate.getTime() - now.getTime()\n-      return msDiff > 0 ? msDiff : 24 * 60 * 60 * 1000 // Return at least 1 day if in past\n-    } else if (unit.trim().toLowerCase() === 'month') {\n-      // For months, add the number of months to current date\n-      const targetDate = new Date(\n-        currentYear,\n-        currentMonth + midpoint,\n-        currentDay\n-      )\n-      const msDiff = targetDate.getTime() - now.getTime()\n-      return msDiff > 0 ? msDiff : 24 * 60 * 60 * 1000\n-    } else if (unit.trim().toLowerCase() === 'day') {\n-      // For days, add the number of days to current date\n-      const targetDate = new Date(\n-        now.getTime() + midpoint * 24 * 60 * 60 * 1000\n-      )\n-      const msDiff = targetDate.getTime() - now.getTime()\n-      return msDiff > 0 ? msDiff : 24 * 60 * 60 * 1000\n-    } else {\n-      // Fallback for any other time unit\n-      return midpoint\n-    }\n+    const date = new Date(midpoint)\n+    return date.valueOf()\n   })\n }\n"
        },
        {
          "path": "backend/api/src/get-related-markets.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/get-related-markets.ts\n===================================================================\n--- backend/api/src/get-related-markets.ts\td70bc7a (parent)\n+++ backend/api/src/get-related-markets.ts\te96bced (commit)\n@@ -60,9 +60,12 @@\n export const cleanContractForStaticProps = (c: Contract) =>\n   ({\n     ...c,\n     description: '',\n-    answers: c.outcomeType === 'MULTI_NUMERIC' ? c.answers : [],\n+    answers:\n+      c.outcomeType === 'MULTI_NUMERIC' || c.outcomeType === 'DATE'\n+        ? c.answers\n+        : [],\n     groupSlugs: [],\n   } as Contract)\n \n const refreshedRelatedMarkets = async (\n"
        },
        {
          "path": "backend/api/src/place-bet.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/place-bet.ts\n===================================================================\n--- backend/api/src/place-bet.ts\td70bc7a (parent)\n+++ backend/api/src/place-bet.ts\te96bced (commit)\n@@ -238,14 +238,9 @@\n ) => {\n   const { amount, expiresMillisAfter } = body\n   const { outcomeType, mechanism } = contract\n \n-  if (\n-    (outcomeType == 'BINARY' ||\n-      outcomeType === 'PSEUDO_NUMERIC' ||\n-      outcomeType === 'STONK') &&\n-    mechanism == 'cpmm-1'\n-  ) {\n+  if (mechanism == 'cpmm-1') {\n     // eslint-disable-next-line prefer-const\n     let { outcome, limitProb, expiresAt } = body\n     if (expiresAt && expiresAt < Date.now())\n       throw new APIError(400, 'Bet cannot expire in the past.')\n@@ -273,14 +268,9 @@\n       balanceByUserId,\n       expiresAt,\n       expiresMillisAfter\n     )\n-  } else if (\n-    (outcomeType === 'MULTIPLE_CHOICE' ||\n-      outcomeType === 'NUMBER' ||\n-      outcomeType === 'MULTI_NUMERIC') &&\n-    mechanism == 'cpmm-multi-1'\n-  ) {\n+  } else if (mechanism == 'cpmm-multi-1') {\n     const { shouldAnswersSumToOne } = contract\n     if (!body.answerId || !answers) {\n       throw new APIError(400, 'answerId must be specified for multi bets')\n     }\n"
        },
        {
          "path": "backend/api/src/resolve-market.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/resolve-market.ts\n===================================================================\n--- backend/api/src/resolve-market.ts\td70bc7a (parent)\n+++ backend/api/src/resolve-market.ts\te96bced (commit)\n@@ -115,10 +115,9 @@\n   contract: Contract,\n   props: ValidatedAPIParams<'market/:contractId/resolve'>\n ) {\n   const { outcomeType } = contract\n-  const isMultiChoice =\n-    outcomeType === 'MULTIPLE_CHOICE' || outcomeType === 'MULTI_NUMERIC'\n+  const isMultiChoice = contract.mechanism === 'cpmm-multi-1'\n \n   if (\n     outcomeType === 'BINARY' ||\n     (isMultiChoice && !contract.shouldAnswersSumToOne)\n"
        },
        {
          "path": "backend/api/src/update-market.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/update-market.ts\n===================================================================\n--- backend/api/src/update-market.ts\td70bc7a (parent)\n+++ backend/api/src/update-market.ts\te96bced (commit)\n@@ -27,8 +27,9 @@\n     closeTime,\n     sort,\n     question,\n     coverImageUrl,\n+    display,\n \n     description: raw,\n     descriptionHtml: html,\n     descriptionMarkdown: markdown,\n@@ -65,8 +66,9 @@\n     unlistedById: visibility === 'unlisted' ? auth.uid : undefined,\n     addAnswersMode,\n     sort,\n     description,\n+    display,\n     lastUpdatedTime: Date.now(),\n   })\n   await updateContract(pg, contractId, {\n     ...update,\n"
        },
        {
          "path": "backend/shared/src/create-notification.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/create-notification.ts\n===================================================================\n--- backend/shared/src/create-notification.ts\td70bc7a (parent)\n+++ backend/shared/src/create-notification.ts\te96bced (commit)\n@@ -20,9 +20,9 @@\n   MANIFOLD_USER_USERNAME,\n   PrivateUser,\n   User,\n } from 'common/user'\n-import { Contract, renderResolution } from 'common/contract'\n+import { Contract, MarketContract, renderResolution } from 'common/contract'\n import { getContract, getPrivateUser, getUser, isProd, log } from 'shared/utils'\n import { ContractComment } from 'common/comment'\n import {\n   forEach,\n@@ -1214,9 +1214,9 @@\n   )\n }\n \n export const createContractResolvedNotifications = async (\n-  contract: Contract,\n+  contract: MarketContract,\n   resolver: User,\n   creator: User,\n   outcome: string,\n   probabilityInt: number | undefined,\n@@ -1235,9 +1235,10 @@\n   let resolutionText = outcome ?? contract.question\n   const { token } = contract\n   const isMultiChoice =\n     contract.outcomeType === 'MULTIPLE_CHOICE' ||\n-    contract.outcomeType === 'MULTI_NUMERIC'\n+    contract.outcomeType === 'MULTI_NUMERIC' ||\n+    contract.outcomeType === 'DATE'\n   const isIndependentMulti = isMultiChoice && !contract.shouldAnswersSumToOne\n \n   if (isIndependentMulti) {\n     const answer = contract.answers.find((answer) => answer.id === answerId)\n"
        },
        {
          "path": "backend/shared/src/resolve-market-helpers.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/resolve-market-helpers.ts\n===================================================================\n--- backend/shared/src/resolve-market-helpers.ts\td70bc7a (parent)\n+++ backend/shared/src/resolve-market-helpers.ts\te96bced (commit)\n@@ -210,9 +210,9 @@\n \n     const resolvedContract = {\n       ...unresolvedContract,\n       ...updatedContractAttrs,\n-    } as Contract\n+    } as MarketContract\n \n     // handle exploit where users can get negative payouts\n     const negPayoutThreshold =\n       resolvedContract.uniqueBettorCount < 100 ? 0 : -1000\n"
        },
        {
          "path": "common/src/api/market-search-types.ts",
          "status": "modified",
          "diff": "Index: common/src/api/market-search-types.ts\n===================================================================\n--- common/src/api/market-search-types.ts\td70bc7a (parent)\n+++ common/src/api/market-search-types.ts\te96bced (commit)\n@@ -48,8 +48,9 @@\n         z.literal('STONK'),\n         z.literal('POLL'),\n         z.literal('NUMBER'),\n         z.literal('MULTI_NUMERIC'),\n+        z.literal('DATE'),\n       ])\n       .default('ALL'),\n     offset: z.coerce.number().gte(0).default(0),\n     limit: z.coerce.number().gt(0).lte(1000).default(100),\n"
        },
        {
          "path": "common/src/api/market-types.ts",
          "status": "modified",
          "diff": "Index: common/src/api/market-types.ts\n===================================================================\n--- common/src/api/market-types.ts\td70bc7a (parent)\n+++ common/src/api/market-types.ts\te96bced (commit)\n@@ -301,8 +301,17 @@\n   addAnswersMode: z.enum(['DISABLED']).default('DISABLED'),\n   unit: z.string(),\n })\n \n+export const createMultiDateSchema = z.object({\n+  outcomeType: z.enum(['DATE']),\n+  answers: z.array(z.string().trim().min(1)).max(MAX_MULTI_NUMERIC_ANSWERS),\n+  midpoints: z.array(z.number().safe()).max(MAX_MULTI_NUMERIC_ANSWERS),\n+  shouldAnswersSumToOne: z.boolean(),\n+  addAnswersMode: z.enum(['DISABLED']).default('DISABLED'),\n+  timezone: z.string(),\n+})\n+\n export const createBountySchema = z.object({\n   outcomeType: z.enum(['BOUNTIED_QUESTION']),\n   totalBounty: z.number().min(MINIMUM_BOUNTY),\n   isAutoBounty: z.boolean().optional(),\n@@ -348,8 +357,9 @@\n       createPollSchema,\n       createBinarySchema,\n       createNumberSchema,\n       createMultiNumericSchema,\n+      createMultiDateSchema,\n     ])\n   )\n \n export const updateMarketProps = z\n@@ -364,8 +374,9 @@\n     description: z.string().optional(),\n     descriptionHtml: z.string().optional(),\n     descriptionMarkdown: z.string().optional(),\n     descriptionJson: z.string().optional(),\n+    display: z.enum(['clock', 'default']).optional(),\n   })\n   .strict()\n \n // resolve market\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\td70bc7a (parent)\n+++ common/src/api/schema.ts\te96bced (commit)\n@@ -2231,16 +2231,16 @@\n     visibility: 'public',\n     authed: true,\n     returns: {} as {\n       buckets: { answers: string[]; midpoints: number[] }\n+      thresholds: { answers: string[]; midpoints: number[] }\n     },\n     props: z\n       .object({\n         question: z.string(),\n         min: z.string(),\n         max: z.string(),\n         description: z.string().optional(),\n-        unit: z.string(),\n       })\n       .strict(),\n   },\n   'regenerate-numeric-midpoints': {\n@@ -2271,9 +2271,9 @@\n         question: z.string(),\n         answers: z.array(z.string()),\n         min: z.string(),\n         max: z.string(),\n-        unit: z.string(),\n+        tab: z.enum(['thresholds', 'buckets']),\n       })\n       .strict(),\n   },\n } as const)\n"
        },
        {
          "path": "common/src/calculate-fixed-payouts.ts",
          "status": "modified",
          "diff": "Index: common/src/calculate-fixed-payouts.ts\n===================================================================\n--- common/src/calculate-fixed-payouts.ts\td70bc7a (parent)\n+++ common/src/calculate-fixed-payouts.ts\te96bced (commit)\n@@ -1,13 +1,8 @@\n import { sum } from 'lodash'\n import { Bet } from './bet'\n import { getProbability } from './calculate'\n-import {\n-  CPMMContract,\n-  CPMMMultiContract,\n-  CPMMNumericContract,\n-  MultiNumeric,\n-} from './contract'\n+import { CPMMContract, MultiContract } from './contract'\n \n export function calculateFixedPayout(\n   contract: CPMMContract,\n   bet: Bet,\n@@ -41,12 +36,9 @@\n   const betP = outcome === 'YES' ? prob : 1 - prob\n   return betP * shares\n }\n \n-function calculateBetPayoutMulti(\n-  contract: CPMMMultiContract | CPMMNumericContract | MultiNumeric,\n-  bet: Bet\n-) {\n+function calculateBetPayoutMulti(contract: MultiContract, bet: Bet) {\n   let prob = 0\n   const { answerId } = bet\n   if (answerId) {\n     const { answers, resolutions } = contract\n@@ -68,9 +60,9 @@\n   return betP * shares\n }\n \n export function calculateFixedPayoutMulti(\n-  contract: CPMMMultiContract | CPMMNumericContract | MultiNumeric,\n+  contract: MultiContract,\n   bet: Bet,\n   outcome: string\n ) {\n   if (outcome === 'CANCEL') return calculateFixedCancelPayout(bet)\n"
        },
        {
          "path": "common/src/chart.ts",
          "status": "modified",
          "diff": "Index: common/src/chart.ts\n===================================================================\n--- common/src/chart.ts\td70bc7a (parent)\n+++ common/src/chart.ts\te96bced (commit)\n@@ -4,9 +4,15 @@\n \n export type Point<X, Y, T = unknown> = { x: X; y: Y; obj?: T }\n export type HistoryPoint<T = unknown> = Point<number, number, T>\n export type DistributionPoint<T = unknown> = Point<number, number, T>\n-export type ValueKind = 'Ṁ' | 'percent' | 'amount' | 'spice' | 'sweepies'\n+export type ValueKind =\n+  | 'Ṁ'\n+  | 'percent'\n+  | 'amount'\n+  | 'spice'\n+  | 'sweepies'\n+  | 'date'\n \n export type MultiPoints = { [answerId: string]: HistoryPoint<never>[] }\n \n /** answer  -> base 64 encoded */\n"
        },
        {
          "path": "common/src/contract-params.ts",
          "status": "modified",
          "diff": "Index: common/src/contract-params.ts\n===================================================================\n--- common/src/contract-params.ts\td70bc7a (parent)\n+++ common/src/contract-params.ts\te96bced (commit)\n@@ -237,9 +237,10 @@\n export const shouldHideGraph = (contract: Contract) => {\n   if (contract.mechanism !== 'cpmm-multi-1') return false\n   if (\n     contract.outcomeType == 'NUMBER' ||\n-    contract.outcomeType == 'MULTI_NUMERIC'\n+    contract.outcomeType == 'MULTI_NUMERIC' ||\n+    contract.outcomeType == 'DATE'\n   )\n     return false\n   const defaultSort = getDefaultSort(contract)\n   const sortedAnswers = sortAnswers(contract, contract.answers, defaultSort)\n"
        },
        {
          "path": "common/src/contract-seo.ts",
          "status": "modified",
          "diff": "Index: common/src/contract-seo.ts\n===================================================================\n--- common/src/contract-seo.ts\td70bc7a (parent)\n+++ common/src/contract-seo.ts\te96bced (commit)\n@@ -5,8 +5,9 @@\n import { formatMoneyNumber, formatPercent } from './util/format'\n import { getFormattedNumberExpectedValue } from 'common/number'\n import { sortAnswers } from './answer'\n import { getFormattedExpectedValue } from './multi-numeric'\n+import { getFormattedExpectedDate } from './multi-date'\n \n export const getContractOGProps = (\n   contract: Contract\n ): Omit<OgCardProps, 'points'> => {\n@@ -40,8 +41,10 @@\n     outcomeType === 'NUMBER'\n       ? getFormattedNumberExpectedValue(contract)\n       : outcomeType === 'MULTI_NUMERIC'\n       ? getFormattedExpectedValue(contract)\n+      : outcomeType === 'DATE'\n+      ? getFormattedExpectedDate(contract)\n       : outcomeType === 'PSEUDO_NUMERIC' || outcomeType === 'STONK'\n       ? getFormattedMappedValue(contract, getDisplayProbability(contract))\n       : undefined\n \n"
        },
        {
          "path": "common/src/contract.ts",
          "status": "modified",
          "diff": "Index: common/src/contract.ts\n===================================================================\n--- common/src/contract.ts\td70bc7a (parent)\n+++ common/src/contract.ts\te96bced (commit)\n@@ -43,9 +43,9 @@\n   | (NonBet & BountiedQuestion)\n   | (NonBet & Poll)\n   | CPMMNumber\n   | MultiNumeric\n-\n+  | MultiDate\n export type Contract<T extends AnyContractType = AnyContractType> = {\n   id: string\n   slug: string // auto-generated; must be unique\n \n@@ -130,14 +130,15 @@\n export type CPMMContract = Contract & CPMM\n export type CPMMMultiContract = Contract & CPMMMulti\n export type CPMMNumericContract = Contract & CPMMNumber\n export type MultiNumericContract = Contract & MultiNumeric\n+export type MultiDateContract = Contract & MultiDate\n export type MarketContract =\n   | CPMMContract\n   | CPMMMultiContract\n   | CPMMNumericContract\n   | MultiNumericContract\n-\n+  | MultiDateContract\n export type BinaryContract = Contract & Binary\n export type PseudoNumericContract = Contract & PseudoNumeric\n export type QuadraticFundingContract = Contract & QuadraticFunding\n export type StonkContract = Contract & Stonk\n@@ -199,8 +200,9 @@\n export const isSpecialLoveContract = (contract: Contract) =>\n   contract.mechanism === 'cpmm-multi-1' &&\n   contract.outcomeType !== 'NUMBER' &&\n   contract.outcomeType !== 'MULTI_NUMERIC' &&\n+  contract.outcomeType !== 'DATE' &&\n   contract.specialLiquidityPerAnswer\n \n export type CPMMNumber = {\n   mechanism: 'cpmm-multi-1'\n@@ -278,8 +280,14 @@\n   resolution?: string | 'CHOOSE_MULTIPLE' | 'CANCEL'\n   sort?: SortType\n }\n \n+export type MultiDate = Omit<MultiNumeric, 'outcomeType' | 'unit'> & {\n+  outcomeType: 'DATE'\n+  timezone: string\n+  display?: 'clock'\n+}\n+\n export type Stonk = {\n   outcomeType: 'STONK'\n   initialProbability: number\n }\n@@ -310,8 +318,9 @@\n export type MultiContract =\n   | CPMMMultiContract\n   | CPMMNumericContract\n   | MultiNumericContract\n+  | MultiDateContract\n \n type AnyOutcomeType =\n   | Binary\n   | QuadraticFunding\n@@ -321,8 +330,10 @@\n   | Number\n   | CPMMMulti\n   | PseudoNumeric\n   | MultiNumeric\n+  | MultiDate\n+\n export type OutcomeType = AnyOutcomeType['outcomeType']\n export type resolution = 'YES' | 'NO' | 'MKT' | 'CANCEL'\n export const RESOLUTIONS = ['YES', 'NO', 'MKT', 'CANCEL'] as const\n export const CREATEABLE_OUTCOME_TYPES = [\n@@ -333,8 +344,9 @@\n   'BOUNTIED_QUESTION',\n   'POLL',\n   'NUMBER',\n   'MULTI_NUMERIC',\n+  'DATE',\n ] as const\n \n export const CREATEABLE_NON_PREDICTIVE_OUTCOME_TYPES = [\n   'POLL',\n@@ -416,9 +428,9 @@\n export const MAX_QUESTION_LENGTH = 120\n export const MAX_DESCRIPTION_LENGTH = 16000\n \n export const CPMM_MIN_POOL_QTY = 0.01\n-export const MULTI_NUMERIC_BUCKETS_MAX = 50\n+export const NUMBER_BUCKETS_MAX = 50\n export const NUMBER_CREATION_ENABLED = false\n \n export type Visibility = 'public' | 'unlisted'\n export const VISIBILITIES = ['public', 'unlisted'] as const\n"
        },
        {
          "path": "common/src/economy.ts",
          "status": "modified",
          "diff": "Index: common/src/economy.ts\n===================================================================\n--- common/src/economy.ts\td70bc7a (parent)\n+++ common/src/economy.ts\te96bced (commit)\n@@ -12,9 +12,13 @@\n   if (outcomeType === 'POLL') {\n     return 10\n   }\n \n-  if (outcomeType === 'MULTIPLE_CHOICE' || outcomeType === 'MULTI_NUMERIC') {\n+  if (\n+    outcomeType === 'MULTIPLE_CHOICE' ||\n+    outcomeType === 'MULTI_NUMERIC' ||\n+    outcomeType === 'DATE'\n+  ) {\n     const tierIndex =\n       liquidityTiers.findIndex((tier) => tier >= liquidityTier) ??\n       liquidityTiers[liquidityTiers.length - 1]\n     return numAnswers\n"
        },
        {
          "path": "common/src/multi-date.ts",
          "status": "added",
          "diff": "Index: common/src/multi-date.ts\n===================================================================\n--- common/src/multi-date.ts\td70bc7a (parent)\n+++ common/src/multi-date.ts\te96bced (commit)\n@@ -0,0 +1,103 @@\n+import { sum } from 'lodash'\n+import { getAnswerProbability } from './calculate'\n+import { filterDefined } from './util/array'\n+import { getInitialAnswerProbability } from './calculate'\n+import { MultiDateContract } from './contract'\n+import { getMinMax } from './multi-numeric'\n+export const MAX_MULTI_NUMERIC_ANSWERS = 12\n+\n+export function getExpectedDate(\n+  contract: MultiDateContract,\n+  initialOnly?: boolean\n+) {\n+  const { answers, shouldAnswersSumToOne } = contract\n+\n+  const answerProbabilities = filterDefined(\n+    answers.map((a) =>\n+      initialOnly\n+        ? getInitialAnswerProbability(contract, a)\n+        : getAnswerProbability(contract, a.id)\n+    )\n+  )\n+  const answerMidpoints = answers.map((a) => a.midpoint!)\n+\n+  if (shouldAnswersSumToOne) {\n+    // For bucket-style answers, simple weighted average\n+    return sum(answerProbabilities.map((p, i) => p * answerMidpoints[i]))\n+  } else {\n+    // For threshold-style answers, calculate discrete probabilities\n+    // First, get the discrete probabilities for each time period\n+    const discreteProbs = []\n+\n+    // First period: probability of the first threshold\n+    discreteProbs.push(answerProbabilities[0])\n+\n+    // Middle periods: difference between adjacent thresholds\n+    for (let i = 1; i < answerProbabilities.length; i++) {\n+      discreteProbs.push(answerProbabilities[i] - answerProbabilities[i - 1])\n+    }\n+\n+    // Final period: remaining probability\n+    const afterLastProb =\n+      1 - answerProbabilities[answerProbabilities.length - 1]\n+\n+    // Calculate expected value using discrete probabilities\n+    let expectedValue = 0\n+\n+    // Sum probability-weighted time periods\n+    for (let i = 0; i < answerProbabilities.length; i++) {\n+      expectedValue += answerMidpoints[i] * discreteProbs[i]\n+    }\n+\n+    // Handle the \"after last threshold\" case by using the last midpoint plus one time period\n+    if (afterLastProb > 0 && answerMidpoints.length > 0) {\n+      const lastMidpoint = answerMidpoints[answerMidpoints.length - 1]\n+      const secondLastMidpoint = answerMidpoints[answerMidpoints.length - 2]\n+      const timePeriod = lastMidpoint - secondLastMidpoint\n+      const beyondLastMidpoint = lastMidpoint + timePeriod\n+      expectedValue += beyondLastMidpoint * afterLastProb\n+    }\n+\n+    return expectedValue\n+  }\n+}\n+\n+export function formatExpectedDate(\n+  value: number,\n+  contract: MultiDateContract,\n+  contractPageView = true\n+) {\n+  const { answers } = contract\n+  const { min, max } = getMinMax(contract)\n+  // There are a few NaN & undefined values on dev\n+  if (isNaN(value) || min === undefined || max === undefined || max === min)\n+    return 'N/A'\n+  if (answers.length == 0) return '' // probably from static props\n+\n+  const formatter = new Intl.DateTimeFormat(\n+    'en-US',\n+    contractPageView\n+      ? {\n+          year: 'numeric',\n+          month: 'long',\n+          day: 'numeric',\n+        }\n+      : {\n+          month: 'numeric',\n+          day: 'numeric',\n+          year: '2-digit',\n+        }\n+  )\n+  return formatter.format(value)\n+}\n+\n+export function getFormattedExpectedDate(\n+  contract: MultiDateContract,\n+  contractPageView = true\n+) {\n+  return formatExpectedDate(\n+    getExpectedDate(contract),\n+    contract,\n+    contractPageView\n+  )\n+}\n"
        },
        {
          "path": "common/src/multi-numeric.ts",
          "status": "modified",
          "diff": "Index: common/src/multi-numeric.ts\n===================================================================\n--- common/src/multi-numeric.ts\td70bc7a (parent)\n+++ common/src/multi-numeric.ts\te96bced (commit)\n@@ -1,9 +1,9 @@\n import { sum } from 'lodash'\n import { getAnswerProbability } from './calculate'\n import { filterDefined } from './util/array'\n import { getInitialAnswerProbability } from './calculate'\n-import { MultiNumericContract } from './contract'\n+import { MultiDateContract, MultiNumericContract } from './contract'\n import { formatLargeNumber } from './util/format'\n export const MAX_MULTI_NUMERIC_ANSWERS = 12\n \n export function getExpectedValue(\n@@ -31,9 +31,11 @@\n     )\n   )\n }\n \n-export const getMinMax = (contract: MultiNumericContract) => {\n+export const getMinMax = (\n+  contract: MultiNumericContract | MultiDateContract\n+) => {\n   const { answers } = contract\n   const min = Math.min(...answers.map((a) => a.midpoint!))\n   const max = Math.max(...answers.map((a) => a.midpoint!))\n   return { min, max }\n"
        },
        {
          "path": "common/src/new-contract.ts",
          "status": "modified",
          "diff": "Index: common/src/new-contract.ts\n===================================================================\n--- common/src/new-contract.ts\td70bc7a (parent)\n+++ common/src/new-contract.ts\te96bced (commit)\n@@ -8,8 +8,9 @@\n   CPMMMulti,\n   CPMMNumber,\n   CREATEABLE_OUTCOME_TYPES,\n   Contract,\n+  MultiDate,\n   MultiNumeric,\n   NonBet,\n   Poll,\n   PseudoNumeric,\n@@ -65,8 +66,9 @@\n \n     // Multi-numeric\n     unit: string | undefined\n     midpoints: number[] | undefined\n+    timezone: string | undefined\n   }\n ) {\n   const {\n     id,\n@@ -97,8 +99,9 @@\n     takerAPIOrdersDisabled,\n     siblingContractId,\n     unit,\n     midpoints,\n+    timezone,\n   } = props\n   const createdTime = Date.now()\n \n   const propsByOutcomeType = {\n@@ -129,8 +132,18 @@\n         ante,\n         unit ?? '',\n         shouldAnswersSumToOne ?? true\n       ),\n+    DATE: () =>\n+      getDateProps(\n+        id,\n+        creator.id,\n+        answers,\n+        midpoints ?? [],\n+        ante,\n+        shouldAnswersSumToOne ?? true,\n+        timezone ?? ''\n+      ),\n   }[outcomeType]()\n \n   const contract: Contract = removeUndefinedProps({\n     id,\n@@ -364,9 +377,40 @@\n   }\n \n   return system\n }\n+const getDateProps = (\n+  contractId: string,\n+  userId: string,\n+  answers: string[],\n+  midpoints: number[],\n+  ante: number,\n+  shouldAnswersSumToOne: boolean,\n+  timezone: string\n+) => {\n+  const answerObjects = createAnswers(\n+    contractId,\n+    userId,\n+    'DISABLED',\n+    shouldAnswersSumToOne,\n+    ante,\n+    answers,\n+    { midpoints }\n+  )\n+  const system: MultiDate = {\n+    mechanism: 'cpmm-multi-1',\n+    outcomeType: 'DATE',\n+    shouldAnswersSumToOne,\n+    addAnswersMode: 'DISABLED',\n+    answers: answerObjects,\n+    totalLiquidity: ante,\n+    subsidyPool: 0,\n+    timezone,\n+  }\n \n+  return system\n+}\n+\n function createAnswers(\n   contractId: string,\n   userId: string,\n   addAnswersMode: add_answers_mode,\n"
        },
        {
          "path": "common/src/number.ts",
          "status": "modified",
          "diff": "Index: common/src/number.ts\n===================================================================\n--- common/src/number.ts\td70bc7a (parent)\n+++ common/src/number.ts\te96bced (commit)\n@@ -1,5 +1,5 @@\n-import { CPMMNumericContract, MULTI_NUMERIC_BUCKETS_MAX } from 'common/contract'\n+import { CPMMNumericContract, NUMBER_BUCKETS_MAX } from 'common/contract'\n import { filterDefined } from 'common/util/array'\n import { find, findLast, mean, sum } from 'lodash'\n import {\n   getAnswerProbability,\n@@ -46,9 +46,9 @@\n   min: number,\n   max: number,\n   precision: number\n ) => {\n-  const highestPrecision = (max - min) / MULTI_NUMERIC_BUCKETS_MAX\n+  const highestPrecision = (max - min) / NUMBER_BUCKETS_MAX\n   const lowestPrecision = (max - min) / 2\n   const hasPrecisionError =\n     !precision || precision < highestPrecision || precision > lowestPrecision\n   if (hasPrecisionError) return []\n"
        },
        {
          "path": "web/components/answers/answers-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/answers/answers-panel.tsx\n===================================================================\n--- web/components/answers/answers-panel.tsx\td70bc7a (parent)\n+++ web/components/answers/answers-panel.tsx\te96bced (commit)\n@@ -23,9 +23,8 @@\n import {\n   CPMMMultiContract,\n   Contract,\n   MultiContract,\n-  MultiNumericContract,\n   contractPath,\n   tradingAllowed,\n } from 'common/contract'\n import { isAdminId, isModId } from 'common/envs/constants'\n@@ -93,9 +92,9 @@\n const DEBOUNCE_DELAY = 100\n \n // full resorting, hover, clickiness, search and add\n export function AnswersPanel(props: {\n-  contract: CPMMMultiContract | MultiNumericContract\n+  contract: MultiContract\n   selectedAnswerIds: string[]\n   sort: MultiSort\n   setSort: (sort: MultiSort) => void\n   query: string\n@@ -562,9 +561,9 @@\n   )\n }\n \n export function Answer(props: {\n-  contract: CPMMMultiContract | MultiNumericContract\n+  contract: MultiContract\n   answer: Answer\n   unfilledBets?: Array<LimitBet>\n   color: string\n   user: User | undefined | null\n"
        },
        {
          "path": "web/components/buttons/duplicate-contract-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/buttons/duplicate-contract-button.tsx\n===================================================================\n--- web/components/buttons/duplicate-contract-button.tsx\td70bc7a (parent)\n+++ web/components/buttons/duplicate-contract-button.tsx\te96bced (commit)\n@@ -58,17 +58,23 @@\n   }\n \n   if (\n     contract.outcomeType === 'MULTIPLE_CHOICE' ||\n-    contract.outcomeType === 'MULTI_NUMERIC'\n+    contract.outcomeType === 'MULTI_NUMERIC' ||\n+    contract.outcomeType === 'DATE'\n   ) {\n     params.answers = contract.answers\n       .filter((a) => !a.isOther)\n       .map((a) => a.text)\n   }\n+  if (\n+    contract.outcomeType === 'MULTI_NUMERIC' ||\n+    contract.outcomeType === 'DATE'\n+  ) {\n+    params.midpoints = contract.answers.map((a) => a.midpoint!)\n+  }\n   if (contract.outcomeType === 'MULTI_NUMERIC') {\n     params.unit = contract.unit\n-    params.midpoints = contract.answers.map((a) => a.midpoint!)\n   }\n \n   if (contract.mechanism === 'cpmm-multi-1') {\n     params.addAnswersMode = contract.addAnswersMode\n"
        },
        {
          "path": "web/components/charts/contract/multi-date.tsx",
          "status": "added",
          "diff": "Index: web/components/charts/contract/multi-date.tsx\n===================================================================\n--- web/components/charts/contract/multi-date.tsx\td70bc7a (parent)\n+++ web/components/charts/contract/multi-date.tsx\te96bced (commit)\n@@ -0,0 +1,169 @@\n+import { useMemo } from 'react'\n+import { last, map, max, sum, zip, min, keyBy } from 'lodash'\n+import { scaleLinear, scaleTime } from 'd3-scale'\n+import { MultiDateContract } from 'common/contract'\n+import { NUMERIC_GRAPH_COLOR } from 'common/numeric-constants'\n+import { getEndDate, getRightmostVisibleDate, ZoomParams } from '../helpers'\n+import { SingleValueHistoryChart } from '../generic-charts'\n+import { SingleContractChartTooltip } from './single-value'\n+\n+import { MultiPoints } from 'common/chart'\n+import { getMinMax } from 'common/src/multi-numeric'\n+import { formatExpectedDate, getExpectedDate } from 'common/multi-date'\n+import { getAnswerProbAtEveryBetTime } from 'common/contract-params'\n+\n+export const getDateBetPoints = (\n+  contract: MultiDateContract,\n+  bets: MultiPoints\n+) => {\n+  const { answers, shouldAnswersSumToOne } = contract\n+  const answersById = keyBy(answers, 'id')\n+  const filledInBetPoints = getAnswerProbAtEveryBetTime(bets, contract)\n+  if (shouldAnswersSumToOne) {\n+    // multiply the prob value by the value of the bucket\n+    const expectedValues = Object.entries(filledInBetPoints).map(\n+      ([answerId, pts]) =>\n+        pts.map((pt) => ({\n+          x: pt.x,\n+          y: pt.y * answersById[answerId].midpoint!,\n+        }))\n+    )\n+    return map(\n+      zip(...expectedValues) as Array<{ x: number; y: number }[]>,\n+      (group) => ({\n+        y: sum(group.map((pt) => pt.y)) ?? 0,\n+        x: group[0].x,\n+      })\n+    )\n+  } else {\n+    // Handle threshold-style expected value calculation\n+    // First, organize points by timestamp\n+    const pointsByTimestamp: Record<number, Record<string, number>> = {}\n+\n+    // Group all probabilities by timestamp\n+    Object.entries(filledInBetPoints).forEach(([answerId, pts]) => {\n+      pts.forEach((pt) => {\n+        const timestamp = pt.x\n+        if (!pointsByTimestamp[timestamp]) {\n+          pointsByTimestamp[timestamp] = {}\n+        }\n+        pointsByTimestamp[timestamp][answerId] = pt.y\n+      })\n+    })\n+\n+    // Calculate expected value at each timestamp\n+    return Object.entries(pointsByTimestamp)\n+      .map(([timestamp, probsByAnswer]) => {\n+        const answerIds = answers.map((a) => a.id)\n+        const probabilities = answerIds.map((id) => probsByAnswer[id] || 0)\n+\n+        // Calculate expected value using threshold method\n+        let expectedValue = 0\n+\n+        // For each threshold except the last one\n+        for (let i = 0; i < probabilities.length - 1; i++) {\n+          // Calculate the probability of being in this \"bucket\" between thresholds\n+          const bucketProbability =\n+            i === 0\n+              ? probabilities[i] // First threshold\n+              : probabilities[i] - probabilities[i - 1] // Difference between thresholds\n+\n+          // Add the contribution to the expected value\n+          expectedValue +=\n+            answersById[answerIds[i]].midpoint! * bucketProbability\n+        }\n+\n+        // Calculate the tail probability (events after the last threshold)\n+        const lastIndex = probabilities.length - 1\n+        const lastThresholdProb = probabilities[lastIndex]\n+        const prevThresholdProb =\n+          lastIndex > 0 ? probabilities[lastIndex - 1] : 0\n+\n+        // Probability of the last discrete bucket\n+        const lastBucketProb = lastThresholdProb - prevThresholdProb\n+        expectedValue +=\n+          answersById[answerIds[lastIndex]].midpoint! * lastBucketProb\n+\n+        // Handle probability beyond the last threshold (tail probability)\n+        const tailProb = 1 - lastThresholdProb\n+        if (tailProb > 0) {\n+          const lastMidpoint = answersById[answerIds[lastIndex]].midpoint!\n+          const prevMidpoint = answersById[answerIds[lastIndex - 1]].midpoint!\n+          const timePeriod = lastMidpoint - prevMidpoint\n+          const beyondLastMidpoint = lastMidpoint + timePeriod\n+\n+          // Add the contribution from events beyond the last threshold\n+          expectedValue += beyondLastMidpoint * tailProb\n+        }\n+\n+        return {\n+          x: parseInt(timestamp),\n+          y: expectedValue,\n+        }\n+      })\n+      .sort((a, b) => a.x - b.x) // Sort by timestamp\n+  }\n+}\n+\n+export const MultiDateContractChart = (props: {\n+  contract: MultiDateContract\n+  multiPoints: MultiPoints\n+  width: number\n+  height: number\n+  zoomParams?: ZoomParams\n+  showZoomer?: boolean\n+}) => {\n+  const { contract, width, multiPoints, height, zoomParams, showZoomer } = props\n+  const start = contract.createdTime\n+  const end = getEndDate(contract)\n+  const endP = getExpectedDate(contract)\n+  const stringifiedMultiPoints = JSON.stringify(multiPoints)\n+  const betPoints = useMemo(\n+    () => getDateBetPoints(contract, multiPoints),\n+    [stringifiedMultiPoints]\n+  )\n+  const now = useMemo(() => Date.now(), [stringifiedMultiPoints, endP])\n+\n+  const singlePointData = useMemo(\n+    () => [\n+      ...(betPoints || []),\n+      {\n+        x: end ?? now,\n+        y: endP,\n+      },\n+    ],\n+    [betPoints, end, endP, now]\n+  )\n+  const { min: answerMin, max: answerMax } = getMinMax(contract)\n+  const allYs = singlePointData.map((p) => p.y)\n+  const minY = min([...allYs, answerMin])!\n+  const maxY = max([...allYs, answerMax])!\n+  const rightmostDate = getRightmostVisibleDate(end, last(betPoints)?.x, now)\n+  const xScale = scaleTime([start, rightmostDate], [0, width])\n+\n+  // Scale for dates on Y-axis (time values in milliseconds)\n+  const yScale = scaleLinear([minY, maxY], [height, 0])\n+\n+  return (\n+    <SingleValueHistoryChart\n+      w={width}\n+      h={height}\n+      xScale={xScale}\n+      yScale={yScale}\n+      rightmostDate={rightmostDate}\n+      negativeThreshold={minY}\n+      zoomParams={zoomParams}\n+      showZoomer={showZoomer}\n+      data={singlePointData}\n+      Tooltip={(props) => (\n+        <SingleContractChartTooltip\n+          ttProps={props}\n+          xScale={zoomParams?.viewXScale ?? xScale}\n+          formatY={(y) => formatExpectedDate(y, contract)}\n+        />\n+      )}\n+      color={NUMERIC_GRAPH_COLOR}\n+      yKind=\"date\"\n+    />\n+  )\n+}\n"
        },
        {
          "path": "web/components/charts/generic-charts.tsx",
          "status": "modified",
          "diff": "Index: web/components/charts/generic-charts.tsx\n===================================================================\n--- web/components/charts/generic-charts.tsx\td70bc7a (parent)\n+++ web/components/charts/generic-charts.tsx\te96bced (commit)\n@@ -48,8 +48,9 @@\n   ZoomParams,\n } from './helpers'\n import { ZoomSlider } from './zoom-slider'\n import { NUMERIC_GRAPH_COLOR } from 'common/numeric-constants'\n+import { timeFormat } from 'd3-time-format'\n \n const interpolateY = (\n   curve: CurveFactory,\n   x: number,\n@@ -810,8 +811,22 @@\n         : yKind === 'Ṁ' || yKind === 'spice'\n         ? (n) => formatMoneyNumber(n)\n         : yKind === 'sweepies'\n         ? (n) => formatSweepiesNumber(n)\n+        : yKind === 'date'\n+        ? (n) => {\n+            const date = new Date(n)\n+            const timeSpan = max - min\n+            if (timeSpan > 3 * 365 * 24 * 60 * 60 * 1000) {\n+              // > 3 years\n+              return timeFormat('%Y')(date) // Years only\n+            } else if (timeSpan > 60 * 24 * 60 * 60 * 1000) {\n+              // > 60 days\n+              return timeFormat('%b %Y')(date) // Month and year\n+            } else {\n+              return timeFormat('%b %d')(date) // Month, day\n+            }\n+          }\n         : (n) => formatWithCommas(n)\n     )\n \n     return { xAxis, yAxis }\n"
        },
        {
          "path": "web/components/clock/clock.tsx",
          "status": "modified",
          "diff": "Index: web/components/clock/clock.tsx\n===================================================================\n--- web/components/clock/clock.tsx\td70bc7a (parent)\n+++ web/components/clock/clock.tsx\te96bced (commit)\n@@ -33,68 +33,194 @@\n     seconds,\n   }\n }\n \n-export const Clock = (props: { year: number }) => {\n-  const { year } = props\n-  const [timeUntil, setTimeUntil] = useState(getTimeUntil(year))\n+export const getTimeUntilFromMs = (ms: number) => {\n+  const currentTime = dayjs()\n+  const eventTime = dayjs(ms)\n+  const difference = eventTime.diff(currentTime)\n+\n+  const years = Math.floor(dayjs.duration(difference).asYears())\n+  const months = Math.floor(dayjs.duration(difference).asMonths()) % 12\n+  const days = Math.floor(dayjs.duration(difference).asDays()) % 30\n+  const hours = Math.floor(dayjs.duration(difference).asHours()) % 24\n+  const minutes = Math.floor(dayjs.duration(difference).asMinutes()) % 60\n+  const seconds = Math.floor(dayjs.duration(difference).asSeconds()) % 60\n+\n+  return {\n+    years,\n+    months,\n+    days,\n+    hours,\n+    minutes,\n+    seconds,\n+  }\n+}\n+\n+export const Clock = (props: {\n+  year?: number\n+  ms?: number\n+  className?: string\n+  size?: 'xs' | 'sm' | 'md' | 'lg'\n+}) => {\n+  const { year, ms, className, size = 'lg' } = props\n+  const [timeUntil, setTimeUntil] = useState(\n+    ms !== undefined\n+      ? getTimeUntilFromMs(ms)\n+      : year !== undefined\n+      ? getTimeUntil(year)\n+      : getTimeUntil(0)\n+  )\n   const isClient = useIsClient()\n   useEffect(() => {\n     const timer = setInterval(() => {\n-      setTimeUntil(getTimeUntil(year))\n+      if (ms !== undefined) {\n+        setTimeUntil(getTimeUntilFromMs(ms))\n+      } else if (year !== undefined) {\n+        setTimeUntil(getTimeUntil(year))\n+      }\n     }, 1000)\n \n     return () => {\n       clearInterval(timer)\n     }\n-  }, [year])\n-  const dotClass = ' h-1 w-1 sm:h-1.5 sm:w-1.5 rounded-sm'\n+  }, [year, ms])\n+\n+  // Sizing configuration based on size prop\n+  const sizeConfig = {\n+    xs: {\n+      clockText: 'text-xs sm:text-sm',\n+      dotSize: 'h-0.5 w-0.5 sm:h-1 sm:w-1',\n+      dotGap: 'gap-1 sm:gap-1.5',\n+      padding: 'p-1 sm:p-1.5',\n+      displayHeight: { mobile: 15, desktop: 20 },\n+      unitText: 'text-[8px] sm:text-xs',\n+      columnGap: 'gap-0.5 sm:gap-1',\n+      ringSize: 'ring-2',\n+    },\n+    sm: {\n+      clockText: 'text-sm sm:text-base',\n+      dotSize: 'h-0.5 w-0.5 sm:h-1 sm:w-1',\n+      dotGap: 'gap-1.5 sm:gap-2',\n+      padding: 'p-2 sm:p-2.5',\n+      displayHeight: { mobile: 20, desktop: 30 },\n+      unitText: 'text-[9px] sm:text-xs',\n+      columnGap: 'gap-0.5 sm:gap-1.5',\n+      ringSize: 'ring-2',\n+    },\n+    md: {\n+      clockText: 'text-base sm:text-2xl',\n+      dotSize: 'h-1 w-1 sm:h-1.5 sm:w-1.5',\n+      dotGap: 'gap-2 sm:gap-3',\n+      padding: 'p-3 sm:p-3.5',\n+      displayHeight: { mobile: 25, desktop: 40 },\n+      unitText: 'text-[10px] sm:text-sm',\n+      columnGap: 'gap-1 sm:gap-2',\n+      ringSize: 'ring-6',\n+    },\n+    lg: {\n+      clockText: 'text-xl sm:text-7xl',\n+      dotSize: 'h-1 w-1 sm:h-1.5 sm:w-1.5',\n+      dotGap: 'gap-2.5 sm:gap-4',\n+      padding: 'p-4 sm:p-4',\n+      displayHeight: { mobile: 30, desktop: 60 },\n+      unitText: 'text-xs sm:text-sm',\n+      columnGap: 'gap-1.5 sm:gap-3',\n+      ringSize: 'ring-8',\n+    },\n+  }\n+\n+  const config = sizeConfig[size]\n+  const dotClass = clsx(config.dotSize, 'rounded-sm')\n+\n   const colon = (\n-    <Col className={'h-full justify-center  gap-2.5 sm:gap-4'}>\n+    <Col className={clsx('h-full justify-center', config.dotGap)}>\n       <div style={{ backgroundColor: 'red' }} className={dotClass} />\n       <div\n         style={{ backgroundColor: 'red' }}\n         className={clsx('mb-2 sm:mb-4', dotClass)}\n       />\n     </Col>\n   )\n+\n   return (\n-    <Row className={'gap-1 text-xl sm:text-7xl'}>\n+    <Row className={clsx(config.clockText, 'gap-1', className)}>\n       <Row\n         style={{ color: 'red' }}\n-        className={\n-          'justify-center gap-1.5 rounded-lg bg-gray-900 p-4 ring-8 ring-gray-300 sm:gap-3 sm:pl-10 sm:pr-6'\n-        }\n+        className={clsx(\n+          'justify-center rounded-lg bg-gray-900 ring ring-gray-300',\n+          config.padding,\n+          config.columnGap,\n+          config.ringSize\n+        )}\n       >\n-        <TimeUnit value={timeUntil.years.toString()} unit={'years'} />\n+        <TimeUnit\n+          value={timeUntil.years.toString()}\n+          unit={'years'}\n+          displayHeight={config.displayHeight}\n+          unitTextClass={config.unitText}\n+        />\n         {colon}\n-        <TimeUnit value={timeUntil.months.toString()} unit={'months'} />\n+        <TimeUnit\n+          value={timeUntil.months.toString()}\n+          unit={'months'}\n+          displayHeight={config.displayHeight}\n+          unitTextClass={config.unitText}\n+        />\n         {colon}\n-        <TimeUnit value={timeUntil.days.toString()} unit={'days'} />\n+        <TimeUnit\n+          value={timeUntil.days.toString()}\n+          unit={'days'}\n+          displayHeight={config.displayHeight}\n+          unitTextClass={config.unitText}\n+        />\n         {colon}\n-        <TimeUnit value={timeUntil.hours.toString()} unit={'hours'} />\n+        <TimeUnit\n+          value={timeUntil.hours.toString()}\n+          unit={'hours'}\n+          displayHeight={config.displayHeight}\n+          unitTextClass={config.unitText}\n+        />\n         {colon}\n-        <TimeUnit unit={'minutes'} value={timeUntil.minutes.toString()} />\n+        <TimeUnit\n+          unit={'minutes'}\n+          value={timeUntil.minutes.toString()}\n+          displayHeight={config.displayHeight}\n+          unitTextClass={config.unitText}\n+        />\n         {colon}\n         {/* We want to show the -- for the changing seconds */}\n         <TimeUnit\n           unit={'seconds'}\n           value={isClient ? timeUntil.seconds : null}\n+          displayHeight={config.displayHeight}\n+          unitTextClass={config.unitText}\n         />\n       </Row>\n     </Row>\n   )\n }\n-const TimeUnit = (props: { value: number | string | null; unit: string }) => {\n-  const { value, unit } = props\n+\n+const TimeUnit = (props: {\n+  value: number | string | null\n+  unit: string\n+  displayHeight?: { mobile: number; desktop: number }\n+  unitTextClass?: string\n+}) => {\n+  const {\n+    value,\n+    unit,\n+    displayHeight = { mobile: 30, desktop: 60 },\n+    unitTextClass = 'text-xs font-bold sm:text-sm',\n+  } = props\n   return (\n     <Col className={'items-center'}>\n       <div className={'sm:hidden'}>\n-        <Display height={30} value={value} />\n+        <Display height={displayHeight.mobile} value={value} />\n       </div>\n       <div className={'hidden sm:block'}>\n-        <Display height={60} value={value} />\n+        <Display height={displayHeight.desktop} value={value} />\n       </div>\n-      <span className={'text-xs font-bold sm:text-sm'}>{unit}</span>\n+      <span className={unitTextClass}>{unit}</span>\n     </Col>\n   )\n }\n"
        },
        {
          "path": "web/components/contract/contract-info-dialog.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-info-dialog.tsx\n===================================================================\n--- web/components/contract/contract-info-dialog.tsx\td70bc7a (parent)\n+++ web/components/contract/contract-info-dialog.tsx\te96bced (commit)\n@@ -449,8 +449,31 @@\n               />\n             </td>\n           </tr>\n         )}\n+\n+        {!hideAdvanced && contract.outcomeType === 'DATE' && (\n+          <tr className={clsx(isMod && 'bg-purple-500/30')}>\n+            <td>\n+              🕒 Clock mode{' '}\n+              <InfoTooltip\n+                text={'Display date as a clock instead of the default view'}\n+              />\n+            </td>\n+            <td>\n+              <CheckOrSwitch\n+                canToggle={isMod || isCreator}\n+                on={contract.display === 'clock'}\n+                setOn={(on) =>\n+                  updateMarket({\n+                    contractId: contract.id,\n+                    display: on ? 'clock' : 'default',\n+                  })\n+                }\n+              />\n+            </td>\n+          </tr>\n+        )}\n       </tbody>\n     </Table>\n   )\n }\n"
        },
        {
          "path": "web/components/contract/contract-overview.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-overview.tsx\n===================================================================\n--- web/components/contract/contract-overview.tsx\td70bc7a (parent)\n+++ web/components/contract/contract-overview.tsx\te96bced (commit)\n@@ -12,8 +12,9 @@\n   BountiedQuestionContract,\n   CPMMMultiContract,\n   CPMMNumericContract,\n   Contract,\n+  MultiDateContract,\n   MultiNumericContract,\n   PseudoNumericContract,\n   StonkContract,\n   getMainBinaryMCAnswer,\n@@ -37,8 +38,9 @@\n import { NumberContractChart } from 'web/components/charts/contract/number'\n import { UserPositionSearchButton } from 'web/components/charts/user-position-search-button'\n import {\n   BinaryResolutionOrChance,\n+  MultiDateResolutionOrExpectation,\n   MultiNumericResolutionOrExpectation,\n   NumberResolutionOrExpectation,\n   PseudoNumericResolutionOrExpectation,\n   StonkPrice,\n@@ -78,8 +80,9 @@\n import { LoadingIndicator } from '../widgets/loading-indicator'\n import { GradientContainer } from '../widgets/gradient-container'\n import { getIsLive } from 'common/sports-info'\n import { MultiNumericContractChart } from '../charts/contract/multi-numeric'\n+import { MultiDateContractChart } from '../charts/contract/multi-date'\n \n export const ContractOverview = memo(\n   (props: {\n     contract: Contract\n@@ -164,8 +167,19 @@\n             resolutionRating={resolutionRating}\n             onAnswerCommentClick={onAnswerCommentClick}\n           />\n         )\n+      case 'DATE':\n+        return (\n+          <MultiDateOverview\n+            contract={contract}\n+            points={betPoints as MultiPoints}\n+            showResolver={showResolver}\n+            setShowResolver={setShowResolver}\n+            resolutionRating={resolutionRating}\n+            onAnswerCommentClick={onAnswerCommentClick}\n+          />\n+        )\n       case 'NUMBER':\n         return (\n           <NumberOverview\n             contract={contract}\n@@ -655,26 +669,99 @@\n   const [showZoomer, setShowZoomer] = useState(false)\n   const { currentTimePeriod, setTimePeriod, maxRange, zoomParams } =\n     useTimePicker(contract, () => setShowZoomer(true))\n \n-  const shouldAnswersSumToOne =\n-    'shouldAnswersSumToOne' in contract ? contract.shouldAnswersSumToOne : true\n-\n-  const [query, setQuery] = usePersistentInMemoryState(\n-    '',\n-    'create-answer-text' + contract.id\n+  return (\n+    <>\n+      <Row className=\"relative justify-between gap-2\">\n+        <MultiNumericResolutionOrExpectation contract={contract} />\n+        <Row className={'relative gap-1'}>\n+          <TimeRangePicker\n+            className=\"h-[2.4rem]\"\n+            currentTimePeriod={currentTimePeriod}\n+            setCurrentTimePeriod={setTimePeriod}\n+            maxRange={maxRange}\n+            color=\"indigo\"\n+          />\n+        </Row>\n+      </Row>\n+      <SizedContainer\n+        className={clsx('mb-12 h-[150px] w-full pb-4 pr-10 sm:h-[200px]')}\n+      >\n+        {(w, h) => (\n+          <MultiNumericContractChart\n+            width={w}\n+            height={h}\n+            multiPoints={points}\n+            zoomParams={zoomParams}\n+            contract={contract}\n+            showZoomer={showZoomer}\n+          />\n+        )}\n+      </SizedContainer>\n+      {!contract.shouldAnswersSumToOne ? (\n+        <IndependentAnswersResolvePanel\n+          show={showResolver}\n+          contract={contract}\n+          onClose={() => setShowResolver(false)}\n+        />\n+      ) : showResolver ? (\n+        <GradientContainer>\n+          <AnswersResolvePanel\n+            contract={contract}\n+            onClose={() => setShowResolver(false)}\n+          />\n+        </GradientContainer>\n+      ) : null}\n+      {!showResolver && (\n+        <>\n+          {resolutionRating}\n+          <AnswersPanel\n+            hideSearch\n+            selectedAnswerIds={[]}\n+            contract={contract}\n+            onAnswerCommentClick={onAnswerCommentClick}\n+            sort={getDefaultSort(contract)}\n+            setSort={() => {}}\n+            query={''}\n+            setQuery={() => {}}\n+          />\n+          {tradingAllowed(contract) && (\n+            <UserBetsSummary\n+              className=\"border-ink-200 !mb-2 mt-2 \"\n+              contract={contract}\n+            />\n+          )}\n+        </>\n+      )}\n+    </>\n   )\n+}\n+const MultiDateOverview = (props: {\n+  points: MultiPoints\n+  contract: MultiDateContract\n+  showResolver: boolean\n+  resolutionRating?: ReactNode\n+  setShowResolver: (show: boolean) => void\n+  onAnswerCommentClick: (answer: Answer) => void\n+}) => {\n+  const {\n+    points,\n+    contract,\n+    showResolver,\n+    resolutionRating,\n+    setShowResolver,\n+    onAnswerCommentClick,\n+  } = props\n \n-  const defaultSort = getDefaultSort(contract)\n-  const [sort, setSort] = usePersistentInMemoryState<MultiSort>(\n-    defaultSort,\n-    'answer-sort' + contract.id\n-  )\n+  const [showZoomer, setShowZoomer] = useState(false)\n+  const { currentTimePeriod, setTimePeriod, maxRange, zoomParams } =\n+    useTimePicker(contract, () => setShowZoomer(true))\n \n   return (\n     <>\n       <Row className=\"relative justify-between gap-2\">\n-        <MultiNumericResolutionOrExpectation contract={contract} />\n+        <MultiDateResolutionOrExpectation contract={contract} />\n         <Row className={'relative gap-1'}>\n           <TimeRangePicker\n             className=\"h-[2.4rem]\"\n             currentTimePeriod={currentTimePeriod}\n@@ -687,9 +774,9 @@\n       <SizedContainer\n         className={clsx('mb-12 h-[150px] w-full pb-4 pr-10 sm:h-[200px]')}\n       >\n         {(w, h) => (\n-          <MultiNumericContractChart\n+          <MultiDateContractChart\n             width={w}\n             height={h}\n             multiPoints={points}\n             zoomParams={zoomParams}\n@@ -697,9 +784,9 @@\n             showZoomer={showZoomer}\n           />\n         )}\n       </SizedContainer>\n-      {!shouldAnswersSumToOne && contract.mechanism === 'cpmm-multi-1' ? (\n+      {!contract.shouldAnswersSumToOne ? (\n         <IndependentAnswersResolvePanel\n           show={showResolver}\n           contract={contract}\n           onClose={() => setShowResolver(false)}\n@@ -719,12 +806,12 @@\n             hideSearch\n             selectedAnswerIds={[]}\n             contract={contract}\n             onAnswerCommentClick={onAnswerCommentClick}\n-            sort={sort}\n-            setSort={setSort}\n-            query={query}\n-            setQuery={setQuery}\n+            sort={getDefaultSort(contract)}\n+            setSort={() => {}}\n+            query={''}\n+            setQuery={() => {}}\n           />\n           {tradingAllowed(contract) && (\n             <UserBetsSummary\n               className=\"border-ink-200 !mb-2 mt-2 \"\n"
        },
        {
          "path": "web/components/contract/contract-page.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-page.tsx\n===================================================================\n--- web/components/contract/contract-page.tsx\td70bc7a (parent)\n+++ web/components/contract/contract-page.tsx\te96bced (commit)\n@@ -594,15 +594,17 @@\n     multiPointsString,\n   } = props\n \n   const isNumber = outcomeType === 'NUMBER'\n-  const isMultiNumeric = outcomeType === 'MULTI_NUMERIC'\n+  const isMultiNumeric =\n+    outcomeType === 'MULTI_NUMERIC' || outcomeType === 'DATE'\n \n   const newBets = useContractBets(\n     contractId,\n     {\n       afterTime: lastBetTime ?? 0,\n       includeZeroShareRedemptions: true,\n+      // TODO: this shows the redemptions in the trades tab??\n       filterRedemptions: !isNumber && !isMultiNumeric,\n     },\n     useIsPageVisible,\n     (params) => api('bets', params)\n@@ -627,9 +629,10 @@\n   const betPoints = useMemo(() => {\n     if (\n       outcomeType === 'MULTIPLE_CHOICE' ||\n       outcomeType === 'NUMBER' ||\n-      outcomeType === 'MULTI_NUMERIC'\n+      outcomeType === 'MULTI_NUMERIC' ||\n+      outcomeType === 'DATE'\n     ) {\n       const data = multiPointsString\n         ? unserializeBase64Multi(multiPointsString)\n         : {}\n"
        },
        {
          "path": "web/components/contract/contract-price.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-price.tsx\n===================================================================\n--- web/components/contract/contract-price.tsx\td70bc7a (parent)\n+++ web/components/contract/contract-price.tsx\te96bced (commit)\n@@ -1,7 +1,8 @@\n import {\n   BinaryContract,\n   CPMMNumericContract,\n+  MultiDateContract,\n   MultiNumericContract,\n   PseudoNumericContract,\n   StonkContract,\n } from 'common/contract'\n@@ -26,8 +27,11 @@\n   getNumberExpectedValue,\n   answerTextToRange,\n } from 'common/src/number'\n import { formatExpectedValue, getExpectedValue } from 'common/multi-numeric'\n+import { formatExpectedDate } from 'common/multi-date'\n+import { getExpectedDate } from 'common/multi-date'\n+import { Clock } from '../clock/clock'\n \n export function BinaryResolutionOrChance(props: {\n   contract: BinaryContract\n   className?: string\n@@ -213,9 +217,52 @@\n       )}\n     </span>\n   )\n }\n+export function MultiDateResolutionOrExpectation(props: {\n+  contract: MultiDateContract\n+  className?: string\n+}) {\n+  const { contract, className } = props\n+  const { answers, resolution, timezone, display } = contract\n+  const resolvedAnswer = answers.find((a) => a.id === resolution)\n+  const value = getExpectedDate(contract)\n+  const formattedValue = formatExpectedDate(value, contract)\n+  const spring = useAnimatedNumber(value)\n \n+  return (\n+    <span\n+      className={clsx(\n+        'items-baseline text-2xl sm:inline-flex sm:text-3xl',\n+        className\n+      )}\n+    >\n+      {resolution ? (\n+        <>\n+          <div className=\"mr-2 text-base\">Resolved</div>\n+          {resolution === 'CANCEL' ? (\n+            <CancelLabel />\n+          ) : (\n+            <MultiNumericValueLabel\n+              formattedValue={resolvedAnswer?.text ?? formattedValue}\n+            />\n+          )}\n+        </>\n+      ) : display === 'clock' ? (\n+        <Tooltip text={`tz: ${timezone}`} placement=\"bottom\">\n+          <Clock ms={value} size=\"sm\" />\n+        </Tooltip>\n+      ) : (\n+        <Tooltip text={`tz: ${timezone}`} placement=\"bottom\">\n+          <animated.div className={'mr-2 inline-block'}>\n+            {spring.to((val) => formatExpectedDate(val, contract))}\n+          </animated.div>\n+        </Tooltip>\n+      )}\n+    </span>\n+  )\n+}\n+\n export function StonkPrice(props: {\n   contract: StonkContract\n   className?: string\n }) {\n"
        },
        {
          "path": "web/components/contract/contracts-table.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contracts-table.tsx\n===================================================================\n--- web/components/contract/contracts-table.tsx\td70bc7a (parent)\n+++ web/components/contract/contracts-table.tsx\te96bced (commit)\n@@ -32,8 +32,9 @@\n import { Tooltip } from '../widgets/tooltip'\n import { SpiceCoin } from 'web/public/custom-components/spiceCoin'\n import { SweepiesCoin } from 'web/public/custom-components/sweepiesCoin'\n import { getFormattedExpectedValue } from 'common/multi-numeric'\n+import { getFormattedExpectedDate } from 'common/multi-date'\n \n export function ContractsTable(props: {\n   contracts: Contract[]\n   onContractClick?: (contract: Contract) => void\n@@ -218,8 +219,12 @@\n     case 'MULTI_NUMERIC': {\n       const val = getFormattedExpectedValue(contract, false)\n       return <span className={clsx(probTextColor, className)}>{val}</span>\n     }\n+    case 'DATE': {\n+      const val = getFormattedExpectedDate(contract, false)\n+      return <span className={clsx(probTextColor, className)}>{val}</span>\n+    }\n     case 'MULTIPLE_CHOICE': {\n       return <ContractMinibar width={width} contract={contract} />\n     }\n     case 'QUADRATIC_FUNDING': {\n"
        },
        {
          "path": "web/components/contract/feed-contract-card.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/feed-contract-card.tsx\n===================================================================\n--- web/components/contract/feed-contract-card.tsx\td70bc7a (parent)\n+++ web/components/contract/feed-contract-card.tsx\te96bced (commit)\n@@ -290,9 +290,10 @@\n \n         {isBinaryMc &&\n           contract.mechanism === 'cpmm-multi-1' &&\n           contract.outcomeType !== 'NUMBER' &&\n-          contract.outcomeType !== 'MULTI_NUMERIC' && (\n+          contract.outcomeType !== 'MULTI_NUMERIC' &&\n+          contract.outcomeType !== 'DATE' && (\n             <BinaryMultiAnswersPanel\n               contract={contract}\n               feedReason={feedReason}\n             />\n"
        },
        {
          "path": "web/components/dashboard/horizontal-dashboard-card.tsx",
          "status": "modified",
          "diff": "Index: web/components/dashboard/horizontal-dashboard-card.tsx\n===================================================================\n--- web/components/dashboard/horizontal-dashboard-card.tsx\td70bc7a (parent)\n+++ web/components/dashboard/horizontal-dashboard-card.tsx\te96bced (commit)\n@@ -154,9 +154,10 @@\n \n           {isBinaryMc &&\n             contract.mechanism === 'cpmm-multi-1' &&\n             contract.outcomeType !== 'NUMBER' &&\n-            contract.outcomeType !== 'MULTI_NUMERIC' && (\n+            contract.outcomeType !== 'MULTI_NUMERIC' &&\n+            contract.outcomeType !== 'DATE' && (\n               <BinaryMultiAnswersPanel contract={contract} />\n             )}\n \n           {isBinaryCpmm && (showGraph || !ignore) && (\n"
        },
        {
          "path": "web/components/new-contract/choosing-contract-form.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/choosing-contract-form.tsx\n===================================================================\n--- web/components/new-contract/choosing-contract-form.tsx\td70bc7a (parent)\n+++ web/components/new-contract/choosing-contract-form.tsx\te96bced (commit)\n@@ -67,8 +67,9 @@\n   value:\n     | CreateableOutcomeType\n     | 'INDEPENDENT_MULTIPLE_CHOICE'\n     | 'DEPENDENT_MULTIPLE_CHOICE'\n+    | 'DATE'\n   visual: ReactNode\n   className?: string\n   backgroundColor?: string\n   selectClassName?: string\n"
        },
        {
          "path": "web/components/new-contract/contract-params-form.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/contract-params-form.tsx\n===================================================================\n--- web/components/new-contract/contract-params-form.tsx\td70bc7a (parent)\n+++ web/components/new-contract/contract-params-form.tsx\te96bced (commit)\n@@ -8,9 +8,9 @@\n   Contract,\n   CreateableOutcomeType,\n   MAX_DESCRIPTION_LENGTH,\n   MAX_QUESTION_LENGTH,\n-  MULTI_NUMERIC_BUCKETS_MAX,\n+  NUMBER_BUCKETS_MAX,\n   NON_BETTING_OUTCOMES,\n   twombaContractPath,\n   Visibility,\n } from 'common/contract'\n@@ -69,8 +69,9 @@\n import { randomString } from 'common/util/random'\n import { formatWithToken } from 'common/util/format'\n import { BiUndo } from 'react-icons/bi'\n import { liquidityTiers } from 'common/tier'\n+import { MultiNumericDateSection } from './multi-numeric-date-section'\n \n export function ContractParamsForm(props: {\n   creator: User\n   outcomeType: CreateableOutcomeType\n@@ -132,9 +133,10 @@\n   // For multiple choice, init to 2 empty answers\n   const defaultAnswers =\n     outcomeType === 'MULTIPLE_CHOICE' ||\n     outcomeType == 'POLL' ||\n-    outcomeType == 'MULTI_NUMERIC'\n+    outcomeType == 'MULTI_NUMERIC' ||\n+    outcomeType == 'DATE'\n       ? ['', '']\n       : []\n \n   const answersKey = 'new-answers-with-other' + paramsKey\n@@ -162,9 +164,9 @@\n       params?.addAnswersMode ?? 'DISABLED',\n       addAnswersModeKey\n     )\n   const shouldAnswersSumToOne =\n-    outcomeType === 'MULTI_NUMERIC'\n+    outcomeType === 'MULTI_NUMERIC' || outcomeType === 'DATE'\n       ? multiNumericSumsToOne\n       : params?.shouldAnswersSumToOne ?? false\n \n   // NOTE: if you add another user-controlled state variable, you should also add it to the duplication parameters and resetProperties()\n@@ -326,9 +328,13 @@\n   }, [outcomeType])\n \n   const isValidQuestion =\n     question.length > 0 && question.length <= MAX_QUESTION_LENGTH\n-  const hasAnswers = outcomeType === 'MULTIPLE_CHOICE' || outcomeType === 'POLL'\n+  const hasAnswers =\n+    outcomeType === 'MULTIPLE_CHOICE' ||\n+    outcomeType === 'POLL' ||\n+    outcomeType === 'MULTI_NUMERIC' ||\n+    outcomeType === 'DATE'\n   const isValidMultipleChoice =\n     !hasAnswers || answers.every((answer) => answer.trim().length > 0)\n \n   const isValidDate =\n@@ -349,9 +355,9 @@\n     isFinite(max) &&\n     min < max\n \n   const midpointsError =\n-    outcomeType === 'MULTI_NUMERIC'\n+    outcomeType === 'MULTI_NUMERIC' || outcomeType === 'DATE'\n       ? midpoints.length !== answers.length\n       : false\n \n   const isValid =\n@@ -368,12 +374,11 @@\n     isValidMultipleChoice &&\n     !midpointsError &&\n     (outcomeType !== 'BOUNTIED_QUESTION' || bountyAmount !== undefined) &&\n     (outcomeType === 'NUMBER'\n-      ? numberOfBuckets <= MULTI_NUMERIC_BUCKETS_MAX && numberOfBuckets >= 2\n+      ? numberOfBuckets <= NUMBER_BUCKETS_MAX && numberOfBuckets >= 2\n       : true) &&\n-    (outcomeType !== 'MULTI_NUMERIC' ||\n-      ((minMaxValid || isValidMultipleChoice) && unit !== ''))\n+    (outcomeType !== 'MULTI_NUMERIC' || (minMaxValid && unit !== ''))\n \n   const [errorText, setErrorText] = useState<string>('')\n   useEffect(() => {\n     setErrorText('')\n@@ -468,9 +473,12 @@\n         isLogScale,\n         groupIds: selectedGroups.map((g) => g.id),\n         answers,\n         midpoints,\n-        addAnswersMode: isMultiNumeric ? 'DISABLED' : addAnswersMode,\n+        addAnswersMode:\n+          outcomeType === 'MULTI_NUMERIC' || outcomeType === 'DATE'\n+            ? 'DISABLED'\n+            : addAnswersMode,\n         shouldAnswersSumToOne,\n         visibility,\n         utcOffset: new Date().getTimezoneOffset(),\n         totalBounty: bountyAmount,\n@@ -482,8 +490,9 @@\n         sportsStartTimestamp: params?.sportsStartTimestamp,\n         sportsEventId: params?.sportsEventId,\n         sportsLeague: params?.sportsLeague,\n         unit: unit.trim(),\n+        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n       })\n \n       const newContract = await api('market', createProps as any)\n \n@@ -541,8 +550,9 @@\n \n   const isMulti = outcomeType === 'MULTIPLE_CHOICE'\n   const isNumber = outcomeType === 'NUMBER'\n   const isMultiNumeric = outcomeType === 'MULTI_NUMERIC'\n+  const isDate = outcomeType === 'DATE'\n \n   const [isGeneratingDescription, setIsGeneratingDescription] = useState(false)\n   const [preGenerateContent, setPreGenerateContent] = useState<\n     JSONContent | undefined\n@@ -716,8 +726,26 @@\n           setShouldAnswersSumToOne={setMultiNumericSumsToOne}\n           unit={unit}\n           setUnit={setUnit}\n         />\n+      )}{' '}\n+      {isDate && (\n+        <MultiNumericDateSection\n+          paramsKey={paramsKey}\n+          submitState={submitState}\n+          question={question}\n+          description={editor?.getHTML()}\n+          answers={answers}\n+          setAnswers={setAnswers}\n+          midpoints={midpoints}\n+          setMidpoints={setMidpoints}\n+          minString={minString}\n+          setMinString={setMinString}\n+          maxString={maxString}\n+          setMaxString={setMaxString}\n+          shouldAnswersSumToOne={shouldAnswersSumToOne}\n+          setShouldAnswersSumToOne={setMultiNumericSumsToOne}\n+        />\n       )}\n       {outcomeType === 'PSEUDO_NUMERIC' && (\n         <PseudoNumericRangeSection\n           minString={minString}\n"
        },
        {
          "path": "web/components/new-contract/create-contract-types.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/create-contract-types.tsx\n===================================================================\n--- web/components/new-contract/create-contract-types.tsx\td70bc7a (parent)\n+++ web/components/new-contract/create-contract-types.tsx\te96bced (commit)\n@@ -2,8 +2,9 @@\n   BsFillCheckCircleFill,\n   BsFillXCircleFill,\n   BsUiChecks,\n   BsUiChecksGrid,\n+  BsCalendar2Date,\n } from 'react-icons/bs'\n import { Col } from 'web/components/layout/col'\n import { CgPoll } from 'react-icons/cg'\n import { GoNumber } from 'react-icons/go'\n@@ -81,8 +82,22 @@\n     ),\n     shouldSumToOne: true,\n     outcomeType: 'MULTI_NUMERIC',\n   },\n+  DATE: {\n+    label: 'Date',\n+    value: 'DATE',\n+    name: 'date',\n+    descriptor: 'A question with a date answer.',\n+    example: 'When will OpenAI release GPT-7?',\n+    visual: (\n+      <Col className=\"text-primary-400 relative my-auto h-12 w-12\">\n+        <BsCalendar2Date className=\"h-12 w-12\" />\n+      </Col>\n+    ),\n+    shouldSumToOne: true,\n+    outcomeType: 'DATE',\n+  },\n } as const\n \n export const NON_PREDICTIVE_CONTRACT_TYPES = {\n   // BOUNTIED_QUESTION: {\n"
        },
        {
          "path": "web/components/new-contract/multi-numeric-date-section.tsx",
          "status": "added",
          "diff": "Index: web/components/new-contract/multi-numeric-date-section.tsx\n===================================================================\n--- web/components/new-contract/multi-numeric-date-section.tsx\td70bc7a (parent)\n+++ web/components/new-contract/multi-numeric-date-section.tsx\te96bced (commit)\n@@ -0,0 +1,398 @@\n+import { Col } from 'web/components/layout/col'\n+import { InfoTooltip } from 'web/components/widgets/info-tooltip'\n+import { Row } from 'web/components/layout/row'\n+import { Input } from 'web/components/widgets/input'\n+import { useState, useCallback, useEffect } from 'react'\n+import { Button } from '../buttons/button'\n+import { api, APIError } from 'web/lib/api/api'\n+import { XIcon } from '@heroicons/react/solid'\n+import { usePersistentLocalState } from 'web/hooks/use-persistent-local-state'\n+import { ControlledTabs } from '../layout/tabs'\n+import { debounce } from 'lodash'\n+import { MAX_MULTI_NUMERIC_ANSWERS } from 'common/multi-numeric'\n+\n+export const MultiNumericDateSection = (props: {\n+  submitState: 'EDITING' | 'LOADING' | 'DONE'\n+  question: string\n+  minString: string\n+  setMinString: (value: string) => void\n+  maxString: string\n+  setMaxString: (value: string) => void\n+  description?: string\n+  answers: string[]\n+  paramsKey: string\n+  setAnswers: (answers: string[]) => void\n+  midpoints: number[]\n+  setMidpoints: (midpoints: number[]) => void\n+  shouldAnswersSumToOne: boolean\n+  setShouldAnswersSumToOne: (shouldAnswersSumToOne: boolean) => void\n+}) => {\n+  const {\n+    paramsKey,\n+    submitState,\n+    question,\n+    description,\n+    answers,\n+    midpoints,\n+    setAnswers,\n+    setMidpoints,\n+    minString,\n+    setMinString,\n+    maxString,\n+    setMaxString,\n+    setShouldAnswersSumToOne,\n+    shouldAnswersSumToOne,\n+  } = props\n+  const defaultAnswers = ['', '']\n+  const [isGeneratingRanges, setIsGeneratingRanges] = useState(false)\n+  // thresholds\n+  const [thresholdAnswers, setThresholdAnswers] = usePersistentLocalState<\n+    string[]\n+  >(\n+    shouldAnswersSumToOne ? defaultAnswers : answers,\n+    'threshold-answers' + paramsKey\n+  )\n+  const [thresholdMidpoints, setThresholdMidpoints] = usePersistentLocalState<\n+    number[]\n+  >(shouldAnswersSumToOne ? [] : midpoints, 'threshold-midpoints' + paramsKey)\n+  // buckets\n+  const [bucketAnswers, setBucketAnswers] = usePersistentLocalState<string[]>(\n+    !shouldAnswersSumToOne ? defaultAnswers : answers,\n+    'bucket-answers' + paramsKey\n+  )\n+  const [bucketMidpoints, setBucketMidpoints] = usePersistentLocalState<\n+    number[]\n+  >(!shouldAnswersSumToOne ? [] : midpoints, 'bucket-midpoints' + paramsKey)\n+  const minMaxError = minString === '' || maxString === ''\n+  const [error, setError] = useState<string>('')\n+  const [regenerateError, setRegenerateError] = useState<string>('')\n+  const [maxAnswersReached, setMaxAnswersReached] = useState<boolean>(false)\n+\n+  const selectedTab = shouldAnswersSumToOne ? 'buckets' : 'thresholds'\n+\n+  // Check if max answers limit is reached\n+  useEffect(() => {\n+    const currentAnswers =\n+      selectedTab === 'buckets' ? bucketAnswers : thresholdAnswers\n+    setMaxAnswersReached(currentAnswers.length > MAX_MULTI_NUMERIC_ANSWERS)\n+  }, [selectedTab, bucketAnswers.length, thresholdAnswers.length])\n+\n+  const generateRanges = async () => {\n+    setError('')\n+    setRegenerateError('')\n+    if (!question || minString === '' || maxString === '') return\n+    setIsGeneratingRanges(true)\n+    try {\n+      const result = await api('generate-ai-date-ranges', {\n+        question,\n+        description,\n+        min: minString,\n+        max: maxString,\n+      })\n+\n+      setThresholdAnswers(result.thresholds.answers)\n+      setThresholdMidpoints(result.thresholds.midpoints)\n+      setBucketAnswers(result.buckets.answers)\n+      setBucketMidpoints(result.buckets.midpoints)\n+    } catch (e) {\n+      console.error('Error generating date ranges:', e)\n+      if (e instanceof APIError) {\n+        setError(e.message.slice(0, 100))\n+      } else {\n+        setError('An error occurred while generating date ranges.')\n+      }\n+    }\n+    setIsGeneratingRanges(false)\n+  }\n+\n+  const removeAnswer = (i: number, tab: 'thresholds' | 'buckets') => {\n+    const newAnswers =\n+      tab === 'thresholds'\n+        ? thresholdAnswers.slice(0, i).concat(thresholdAnswers.slice(i + 1))\n+        : bucketAnswers.slice(0, i).concat(bucketAnswers.slice(i + 1))\n+    const newMidpoints =\n+      tab === 'thresholds'\n+        ? thresholdMidpoints.slice(0, i).concat(thresholdMidpoints.slice(i + 1))\n+        : bucketMidpoints.slice(0, i).concat(bucketMidpoints.slice(i + 1))\n+    if (tab === 'thresholds') {\n+      setThresholdAnswers(newAnswers)\n+      setThresholdMidpoints(newMidpoints)\n+    } else {\n+      setBucketAnswers(newAnswers)\n+      setBucketMidpoints(newMidpoints)\n+    }\n+  }\n+\n+  const handleRangeBlur = () => {\n+    setError('')\n+    setRegenerateError('')\n+    if (!minMaxError && question) {\n+      generateRanges()\n+    }\n+  }\n+\n+  const handleTabChange = (tab: 'thresholds' | 'buckets') => {\n+    setShouldAnswersSumToOne(tab === 'buckets')\n+    // Switch between threshold and bucket answers without any post-processing\n+    if (tab === 'thresholds') {\n+      setAnswers(thresholdAnswers)\n+      setMidpoints(thresholdMidpoints)\n+    } else {\n+      setAnswers(bucketAnswers)\n+      setMidpoints(bucketMidpoints)\n+    }\n+  }\n+\n+  useEffect(() => {\n+    handleTabChange(selectedTab)\n+  }, [\n+    JSON.stringify(thresholdAnswers),\n+    JSON.stringify(bucketAnswers),\n+    JSON.stringify(thresholdMidpoints),\n+    JSON.stringify(bucketMidpoints),\n+  ])\n+\n+  const handleAnswerChanged = async (\n+    answers: string[],\n+    min: string,\n+    max: string,\n+    tab: 'thresholds' | 'buckets'\n+  ) => {\n+    setRegenerateError('')\n+    // Only regenerate midpoints if we have min and max\n+    if (min === '' || max === '') return\n+\n+    try {\n+      // Call regenerate-date-midpoints without tab parameter\n+      const result = await api('regenerate-date-midpoints', {\n+        question,\n+        answers,\n+        min,\n+        max,\n+        description,\n+        tab,\n+      })\n+\n+      // Update midpoints state\n+      setMidpoints(result.midpoints)\n+\n+      // Update the tab-specific state\n+      if (tab === 'thresholds') {\n+        setThresholdMidpoints(result.midpoints)\n+      } else {\n+        setBucketMidpoints(result.midpoints)\n+      }\n+    } catch (e) {\n+      console.error('Error regenerating date midpoints:', e)\n+      if (e instanceof APIError) {\n+        setRegenerateError(e.message.slice(0, 100))\n+      } else {\n+        setRegenerateError(\n+          'An error occurred while regenerating date midpoints.'\n+        )\n+      }\n+    }\n+  }\n+\n+  // Create debounced version of handleAnswerChanged\n+  const debouncedHandleAnswerChanged = useCallback(\n+    debounce(\n+      (answers: string[], tab: 'thresholds' | 'buckets') =>\n+        handleAnswerChanged(answers, minString, maxString, tab),\n+      1500\n+    ),\n+    [minString, maxString, setMidpoints]\n+  )\n+\n+  const addAnswer = () => {\n+    if (selectedTab === 'thresholds') {\n+      if (thresholdAnswers.length < MAX_MULTI_NUMERIC_ANSWERS) {\n+        setThresholdAnswers([...thresholdAnswers, ''])\n+      }\n+    } else {\n+      if (bucketAnswers.length < MAX_MULTI_NUMERIC_ANSWERS) {\n+        setBucketAnswers([...bucketAnswers, ''])\n+      }\n+    }\n+  }\n+\n+  const tabs = [\n+    {\n+      title: 'Buckets',\n+      content: (\n+        <Col className=\"mt-2 gap-2\">\n+          {bucketAnswers.map((answer, i) => (\n+            <Row key={i} className=\"items-center gap-2\">\n+              {i + 1}.{' '}\n+              <Input\n+                className=\"w-full\"\n+                value={answer}\n+                onChange={(e) => {\n+                  const newAnswers = [...bucketAnswers]\n+                  newAnswers[i] = e.target.value\n+                  setBucketAnswers(newAnswers)\n+                  debouncedHandleAnswerChanged(newAnswers, 'buckets')\n+                }}\n+              />\n+              {bucketAnswers.length > 2 && (\n+                <button\n+                  onClick={() => removeAnswer(i, 'buckets')}\n+                  type=\"button\"\n+                  className=\"hover:bg-canvas-50 border-ink-300 text-ink-700 bg-canvas-0 focus:ring-primary-500 inline-flex items-center rounded-full border p-1 text-xs font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2\"\n+                >\n+                  <XIcon className=\"h-5 w-5\" aria-hidden=\"true\" />\n+                </button>\n+              )}\n+            </Row>\n+          ))}\n+          <Row className=\"justify-end gap-2\">\n+            <Button\n+              color=\"none\"\n+              disabled={bucketAnswers.length >= MAX_MULTI_NUMERIC_ANSWERS}\n+              onClick={addAnswer}\n+              className=\"hover:bg-canvas-50 border-ink-300 text-ink-700 bg-canvas-0 focus:ring-primary-500 inline-flex items-center rounded border px-2.5 py-1.5 text-xs font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2\"\n+            >\n+              Add bucket\n+            </Button>\n+          </Row>\n+        </Col>\n+      ),\n+    },\n+    {\n+      title: 'Thresholds',\n+      content: (\n+        <Col className=\"mt-2 gap-2\">\n+          {thresholdAnswers.map((answer, i) => (\n+            <Row key={i} className=\"items-center gap-2\">\n+              {i + 1}.{' '}\n+              <Input\n+                className=\"w-full\"\n+                value={answer}\n+                onChange={(e) => {\n+                  const newAnswers = [...thresholdAnswers]\n+                  newAnswers[i] = e.target.value\n+                  setThresholdAnswers(newAnswers)\n+                  debouncedHandleAnswerChanged(newAnswers, 'thresholds')\n+                }}\n+              />\n+              {thresholdAnswers.length > 2 && (\n+                <button\n+                  onClick={() => removeAnswer(i, 'thresholds')}\n+                  type=\"button\"\n+                  className=\"hover:bg-canvas-50 border-ink-300 text-ink-700 bg-canvas-0 focus:ring-primary-500 inline-flex items-center rounded-full border p-1 text-xs font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2\"\n+                >\n+                  <XIcon className=\"h-5 w-5\" aria-hidden=\"true\" />\n+                </button>\n+              )}\n+            </Row>\n+          ))}\n+          <Row className=\"justify-end gap-2\">\n+            <Button\n+              color=\"none\"\n+              disabled={thresholdAnswers.length >= MAX_MULTI_NUMERIC_ANSWERS}\n+              onClick={addAnswer}\n+              className=\"hover:bg-canvas-50 border-ink-300 text-ink-700 bg-canvas-0 focus:ring-primary-500 inline-flex items-center rounded border px-2.5 py-1.5 text-xs font-medium shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2\"\n+            >\n+              Add threshold\n+            </Button>\n+          </Row>\n+        </Col>\n+      ),\n+    },\n+  ]\n+  const titles = tabs.map((tab) => tab.title.toLowerCase())\n+\n+  return (\n+    <Col>\n+      <Row className={' flex-wrap'}>\n+        <Col className=\"mb-2 w-full items-start\">\n+          <Row className=\"items-baseline gap-1 px-1 py-2\">\n+            <span className=\"\">Date range</span>\n+            <InfoTooltip text=\"The start and end dates for your question. Choose dates the value could reasonably be expected to fall between.\" />\n+          </Row>\n+          <Row className={'w-full gap-2'}>\n+            <Input\n+              type=\"text\"\n+              error={!!error}\n+              className=\"w-full\"\n+              placeholder=\"Start\"\n+              onClick={(e) => e.stopPropagation()}\n+              onChange={(e) => setMinString(e.target.value)}\n+              onBlur={handleRangeBlur}\n+              disabled={submitState === 'LOADING'}\n+              value={minString}\n+            />\n+\n+            <Input\n+              type=\"text\"\n+              error={!!error}\n+              className=\"w-full\"\n+              placeholder=\"End\"\n+              onClick={(e) => e.stopPropagation()}\n+              onChange={(e) => setMaxString(e.target.value)}\n+              onBlur={handleRangeBlur}\n+              disabled={submitState === 'LOADING'}\n+              value={maxString}\n+            />\n+            <Button\n+              className=\"hidden whitespace-nowrap sm:inline-flex\"\n+              color=\"indigo-outline\"\n+              onClick={generateRanges}\n+              loading={isGeneratingRanges}\n+              disabled={\n+                !question ||\n+                isGeneratingRanges ||\n+                minString === '' ||\n+                maxString === '' ||\n+                minMaxError\n+              }\n+            >\n+              {answers.length > 0\n+                ? 'Regenerate date ranges'\n+                : 'Generate date ranges'}\n+            </Button>\n+          </Row>\n+        </Col>\n+      </Row>\n+      <Row className=\"mb-2 w-full gap-2 sm:hidden\">\n+        <Button\n+          color=\"indigo-outline\"\n+          onClick={generateRanges}\n+          loading={isGeneratingRanges}\n+          disabled={\n+            !question ||\n+            isGeneratingRanges ||\n+            minString === '' ||\n+            maxString === '' ||\n+            minMaxError\n+          }\n+        >\n+          {answers.length > 0\n+            ? 'Regenerate date ranges'\n+            : 'Generate date ranges'}\n+        </Button>\n+      </Row>\n+      {error && (\n+        <div className=\"text-scarlet-500 mb-2 mt-2 text-sm\">{error}</div>\n+      )}\n+\n+      <ControlledTabs\n+        activeIndex={titles.indexOf(selectedTab)}\n+        onClick={(title) => {\n+          handleTabChange(title.toLowerCase() as 'thresholds' | 'buckets')\n+        }}\n+        tabs={tabs}\n+      />\n+      {regenerateError && (\n+        <div className=\"text-scarlet-500 mb-2 mt-2 text-sm\">\n+          {regenerateError}\n+        </div>\n+      )}\n+      {maxAnswersReached && (\n+        <div className=\"mb-2 mt-2 text-sm text-amber-500\">\n+          Maximum of {MAX_MULTI_NUMERIC_ANSWERS} answers reached.\n+        </div>\n+      )}\n+    </Col>\n+  )\n+}\n"
        },
        {
          "path": "web/components/new-contract/number-range-section.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/number-range-section.tsx\n===================================================================\n--- web/components/new-contract/number-range-section.tsx\td70bc7a (parent)\n+++ web/components/new-contract/number-range-section.tsx\te96bced (commit)\n@@ -7,9 +7,9 @@\n   getMultiNumericAnswerBucketRangeNames,\n   getMultiNumericAnswerBucketRanges,\n } from 'common/src/number'\n import { usePersistentLocalState } from 'web/hooks/use-persistent-local-state'\n-import { MULTI_NUMERIC_BUCKETS_MAX } from 'common/contract'\n+import { NUMBER_BUCKETS_MAX } from 'common/contract'\n import ShortToggle from 'web/components/widgets/short-toggle'\n import { track } from 'web/lib/service/analytics'\n import { useEvent } from 'client-common/hooks/use-event'\n \n@@ -38,9 +38,9 @@\n     paramsKey,\n   } = props\n   const boundsDefined = min !== undefined && max !== undefined\n   const highestPrecision = boundsDefined\n-    ? (max - min) / MULTI_NUMERIC_BUCKETS_MAX\n+    ? (max - min) / NUMBER_BUCKETS_MAX\n     : undefined\n   const lowestPrecision = boundsDefined ? (max - min) / 2 : undefined\n   const numberOfBuckets = boundsDefined\n     ? getMultiNumericAnswerBucketRangeNames(min, max, precision ?? 1).length\n"
        },
        {
          "path": "web/components/outcome-label.tsx",
          "status": "modified",
          "diff": "Index: web/components/outcome-label.tsx\n===================================================================\n--- web/components/outcome-label.tsx\td70bc7a (parent)\n+++ web/components/outcome-label.tsx\te96bced (commit)\n@@ -85,9 +85,9 @@\n       </span>\n     )\n   }\n \n-  if (outcomeType === 'MULTIPLE_CHOICE' || outcomeType === 'MULTI_NUMERIC') {\n+  if (mechanism === 'cpmm-multi-1') {\n     return (\n       <span>\n         {answer && (\n           <MultiOutcomeLabel\n"
        }
      ]
    },
    {
      "id": "add-limit-orders",
      "sha": "aa9990205e0bd652bd79ae90baea239d69273d06",
      "parentSha": "c2258ebf78588e8ceee2d74aa14435cef6823dcc",
      "spec": "Implement a user limit-orders view and supporting backend, realtime, and UI infrastructure.\n\nDatabase\n- Add a new expires_at timestamp with time zone column to the contract_bets table (default null). No other schema changes required.\n\nBackend API\n1) get-user-limit-orders-with-contracts\n- Endpoint props: userId (string), count (number <= 5000), includeExpired (boolean, default false), includeCancelled (boolean, default false), includeFilled (boolean, default false).\n- Behavior: Return up to count of the user’s limit orders with their associated contracts.\n  - Query aggregates bets by contract_id for the given user, filtering:\n    - includeExpired=false: only orders where expires_at > now() OR expires_at IS NULL\n    - includeFilled=false: only orders with is_filled = false\n    - includeCancelled=false: only orders with is_cancelled = false\n    - Always exclude redemptions (not is_redemption), only include rows with limitProb set (data->>'limitProb' not null), and exclude silent orders (data->>'silent' = 'false' or null).\n  - Ensure each bet JSON includes updated_time by setting data := jsonb_set(data::jsonb, '{updated_time}', to_jsonb(updated_time)).\n  - Join to contracts to return contract data.\n- Return shape: { bets: LimitBet[], contracts: MarketContract[] }.\n  - Convert each bet with common/supabase/bets.convertBet.\n  - Convert contracts to MarketContract using common/supabase/contracts.convertContract (generic typed) and return as MarketContract[].\n\n2) get-user-contract-metrics-with-contracts\n- Return contracts typed strictly as MarketContract[]. Convert with convertContract<MarketContract>.\n\nRealtime (Websockets)\n- Update broadcastOrders to also broadcast per user:\n  - Continue broadcasting to contract/{contractId}/orders with { bets }.\n  - Additionally group by bet.userId and broadcast to user/{userId}/orders with just that user’s subset of bets.\n- Ensure groupBy from lodash is imported in the helpers file.\n\nCommon API Schema\n- Update common/src/api/schema.ts\n  - For get-user-limit-orders-with-contracts: returns { bets: LimitBet[], contracts: MarketContract[] }, props include the three optional booleans defaulting to false.\n  - For get-user-contract-metrics-with-contracts: contracts: MarketContract[].\n\nClient Hooks\n- In client-common/src/hooks/use-bets.ts, add listenToUserOrders(userId, setNewBets, enabled):\n  - Subscribes to topic user/{userId}/orders via useApiSubscription.\n  - On broadcast, merges incoming LimitBet updates by id into state (Map by bet.id), preserving existing bets if not updated.\n\nUI Components\n1) New limit orders table view\n- Create a component that:\n  - Fetches the user’s limit orders via useAPIGetter('get-user-limit-orders-with-contracts', { userId, count: 5000, includeExpired, includeFilled, includeCancelled }).\n  - Subscribes to per-user websocket updates using listenToUserOrders and merges updates with fetched results.\n  - Ensures contracts for any updated bets not present in data.contracts are loaded via getContracts and appended to the list.\n  - Computes per-bet details: remainingAmount (orderAmount - sum(fills.amount)), priceDiff (current prob minus limitProb), timeToExpiry and isExpired.\n  - Provides sorting by: createTime, expiryTime, updateTime (last fill or updatedTime), remainingAmount, priceDiff; with asc/desc toggle.\n  - Provides filtering using the existing bet filters: open, closed, resolved, all, sold, plus text query across market question, creator name/username, and answer text for multi.\n  - Renders columns: Market (link with avatar, outcome/answer label, limit prob), Created, Expiry (Never or relative/Expired), Fill (last fill time or Never), Remaining (remaining/order), Price ∆ (with color-coded direction and from→to display), and Edit actions.\n  - Edit actions: per-row button to open a modal that reloads an order with same parameters (probability, amount, outcome, answer) using LimitOrderPanel; another button opens a modal with OrderTable for that market showing all orders.\n  - Use RelativeTimestamp with useUseClient=false where needed to avoid client-only hooks.\n\n2) Integrate into user-bets-table\n- Add a toggle to switch between Bets and Orders when viewing your own profile. When Orders is active, render the new limit orders table.\n- Replace the prior limit_bet filter with three toggles that control includeExpired, includeFilled, includeCancelled booleans and pass them to the API call.\n- Keep existing All/Open/Sold/Closed/Resolved filters for contracts, and keep the token filters; update labels and styling as per design.\n\n3) Order table improvements\n- In order-book, update “Cancel all” to only appear when there is at least one active (not isCancelled) and not fully filled (amount < orderAmount) order; cancel only those.\n- In each row’s Expires cell, display human-readable status: Expired if past expiresAt, Filled if fully filled, Cancelled if isCancelled, else remaining time.\n- Hide the per-row Cancel button for orders that are already filled or cancelled.\n\n4) LimitOrderPanel adjustments\n- Change the contract prop type to MarketContract; accept an optional initialProb to seed the slider.\n- Remove KYC gating and LocationMonitor from this panel and any call sites (do not pass kycError or shouldPromptVerification, do not render KYC errors in panel, do not set disregardUserBalance based on verification).\n- Keep existing buy button enablement based on required inputs and location monitor state; do not gate on KYC.\n\n5) Component utilities\n- RelativeTimestamp: add a useUseClient?: boolean prop (default true). When false, avoid calling useIsClient to allow usage in contexts that don’t run that hook. Maintain existing tooltip/date formatting behavior.\n- ChoicesToggleGroup: add a new color key 'light-gray' using the same styling semantics as the light/gray variants per design.\n\nTyping and imports\n- Use MarketContract consistently where contracts are passed or returned.\n- Ensure lodash groupBy is imported where used in websockets/helpers.\n- Use convertBet for bet conversion and convertContract for contract conversion.\n\nAcceptance criteria\n- API returns a flat list of LimitBet plus MarketContract[] for the requesting user, respecting includeExpired/includeFilled/includeCancelled toggles.\n- Websocket broadcasts to contract/{contractId}/orders and user/{userId}/orders, and the client subscribes to and live-updates the Orders view when the user’s orders change.\n- User’s Trades tab has an Orders toggle. In Orders view, user can see, filter, and sort their limit orders, open a modal to edit orders for a market, and quickly re-open an order with the same parameters.\n- “Cancel all” only cancels active, not-yet-filled orders and hides when none are cancelable. Per-row Cancel button hidden for filled/cancelled orders. Expires column shows Expired, Filled, Cancelled, or a relative time.\n- LimitOrderPanel no longer shows KYC/verification prompts; it accepts initialProb and uses MarketContract.\n- RelativeTimestamp works with useUseClient=false without React hook warnings.",
      "prompt": "Add a first-class Limit Orders experience to the Trades tab. Users should be able to switch between their regular bets and all their limit orders, see and filter orders (including expired, filled, and cancelled), sort by useful fields, and live-update via websockets when their orders change. Expose an API to fetch a user’s limit orders and associated markets with optional filters, and publish per-user order updates over websockets. Add an Orders edit modal where users can view all their orders for a market, and a quick action to reload a past order with the same parameters. Remove KYC gating from the limit order panel. Include a small utility update so relative timestamps can render without relying on a client-only hook, and a minor toggle style addition.",
      "supplementalFiles": [
        "common/src/contract.ts",
        "common/src/bet.ts",
        "common/src/supabase/contracts.ts",
        "common/src/supabase/bets.ts",
        "web/lib/api/api.ts",
        "web/hooks/use-api-getter.ts",
        "web/hooks/use-contract.ts",
        "web/hooks/use-page-visible.ts",
        "client-common/src/hooks/use-persistent-in-memory-state.ts",
        "backend/shared/src/supabase/init.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/get-user-contract-metrics-with-contracts.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/get-user-contract-metrics-with-contracts.ts\n===================================================================\n--- backend/api/src/get-user-contract-metrics-with-contracts.ts\tc2258eb (parent)\n+++ backend/api/src/get-user-contract-metrics-with-contracts.ts\taa99902 (commit)\n@@ -5,8 +5,9 @@\n import { calculateUpdatedMetricsForContracts } from 'common/calculate-metrics'\n import { Dictionary, mapValues } from 'lodash'\n import { convertContract } from 'common/supabase/contracts'\n import { prefixedContractColumnsToSelect } from 'shared/utils'\n+import { MarketContract } from 'common/contract'\n \n export const getUserContractMetricsWithContracts: APIHandler<\n   'get-user-contract-metrics-with-contracts'\n > = async (props, auth) => {\n@@ -35,9 +36,9 @@\n         ORDER BY max((ucm.data->>'lastBetTime')::bigint) DESC NULLS LAST\n         OFFSET $2 LIMIT $3\n       `\n   const results = await pg.map(q, [userId, offset, limit], (row) => ({\n-    contract: convertContract(row.contract),\n+    contract: convertContract<MarketContract>(row.contract),\n     metrics: row.metrics as ContractMetric[],\n   }))\n \n   const { metricsByContract: allMetrics } =\n"
        },
        {
          "path": "backend/api/src/get-user-limit-orders-with-contracts.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/get-user-limit-orders-with-contracts.ts\n===================================================================\n--- backend/api/src/get-user-limit-orders-with-contracts.ts\tc2258eb (parent)\n+++ backend/api/src/get-user-limit-orders-with-contracts.ts\taa99902 (commit)\n@@ -1,40 +1,46 @@\n import type { APIHandler } from 'api/helpers/endpoint'\n import { Dictionary } from 'lodash'\n import { LimitBet } from 'common/bet'\n-import { Contract } from 'common/contract'\n+import { MarketContract } from 'common/contract'\n import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { convertBet } from 'common/supabase/bets'\n \n export const getUserLimitOrdersWithContracts: APIHandler<\n   'get-user-limit-orders-with-contracts'\n > = async (props) => {\n-  const { count, userId } = props\n+  const { count, userId, includeExpired, includeCancelled, includeFilled } =\n+    props\n   const pg = createSupabaseDirectClient()\n-  const contracts = [] as Contract[]\n-  const betsByContract = {} as Dictionary<LimitBet[]>\n+  const contracts = [] as MarketContract[]\n+  const bets = [] as LimitBet[]\n   await pg.map(\n     `\n     select contract_id, bets.data as bets, contracts.data as contracts\n     from (\n     select contract_id,\n       array_agg(\n-        data\n+        jsonb_set(data::jsonb, '{updated_time}', to_jsonb(updated_time))\n         order by created_time desc\n       ) as data\n     from contract_bets\n     where user_id = $1\n-      and contract_bets.is_filled = false\n-      and contract_bets.is_cancelled = false\n+      and ($3 or (contract_bets.expires_at > now() or contract_bets.expires_at is null))\n+      and ($4 or contract_bets.is_filled = false)\n+      and ($5 or contract_bets.is_cancelled = false)\n+      and not is_redemption\n+      and data->>'limitProb' is not null\n+      and (data->>'silent' = 'false' or data->>'silent' is null)\n     group by contract_id\n   ) as bets\n   join contracts on contracts.id = bets.contract_id\n   limit $2\n   `,\n-    [userId, count],\n+    [userId, count, includeExpired, includeFilled, includeCancelled],\n     (r) => {\n-      betsByContract[r.contract_id] = r.bets as LimitBet[]\n-      contracts.push(r.contract as Contract)\n+      bets.push(...(r.bets.map(convertBet) as LimitBet[]))\n+      contracts.push(r.contracts as MarketContract)\n     }\n   )\n \n-  return { betsByContract, contracts }\n+  return { bets, contracts }\n }\n"
        },
        {
          "path": "backend/shared/src/websockets/helpers.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/websockets/helpers.ts\n===================================================================\n--- backend/shared/src/websockets/helpers.ts\tc2258eb (parent)\n+++ backend/shared/src/websockets/helpers.ts\taa99902 (commit)\n@@ -36,8 +36,12 @@\n export function broadcastOrders(bets: LimitBet[]) {\n   if (bets.length === 0) return\n   const { contractId } = bets[0]\n   broadcast(`contract/${contractId}/orders`, { bets })\n+  const betsByUser = groupBy(bets, (b) => b.userId)\n+  for (const userBets of Object.values(betsByUser)) {\n+    broadcast(`user/${userBets[0].userId}/orders`, { bets: userBets })\n+  }\n }\n \n export function broadcastUpdatedMetrics(metrics: Omit<ContractMetric, 'id'>[]) {\n   if (metrics.length === 0) return\n"
        },
        {
          "path": "backend/supabase/contract_bets.sql",
          "status": "modified",
          "diff": "Index: backend/supabase/contract_bets.sql\n===================================================================\n--- backend/supabase/contract_bets.sql\tc2258eb (parent)\n+++ backend/supabase/contract_bets.sql\taa99902 (commit)\n@@ -16,9 +16,10 @@\n     prob_after numeric,\n     prob_before numeric,\n     shares numeric,\n     updated_time timestamp with time zone default now() not null,\n-    user_id text not null\n+    user_id text not null,\n+    expires_at timestamp with time zone\n   );\n \n -- Triggers\n create trigger contract_bet_populate before insert\n"
        },
        {
          "path": "client-common/src/hooks/use-bets.ts",
          "status": "modified",
          "diff": "Index: client-common/src/hooks/use-bets.ts\n===================================================================\n--- client-common/src/hooks/use-bets.ts\tc2258eb (parent)\n+++ client-common/src/hooks/use-bets.ts\taa99902 (commit)\n@@ -89,8 +89,29 @@\n     },\n     enabled,\n   })\n }\n+export const listenToUserOrders = (\n+  userId: string,\n+  setNewBets: Dispatch<SetStateAction<LimitBet[]>>,\n+  enabled: boolean\n+) => {\n+  useApiSubscription({\n+    topics: [`user/${userId}/orders`],\n+    onBroadcast: (msg) => {\n+      const betUpdates = msg.data.bets as LimitBet[]\n+      console.log('betUpdates', betUpdates)\n+      setNewBets((currentBets) => {\n+        const currentBetsMap = new Map(currentBets.map((bet) => [bet.id, bet]))\n+        betUpdates.forEach((updatedBet) => {\n+          currentBetsMap.set(updatedBet.id, updatedBet)\n+        })\n+        return Array.from(currentBetsMap.values())\n+      })\n+    },\n+    enabled,\n+  })\n+}\n \n export function betShouldBeFiltered(bet: Bet, options?: APIParams<'bets'>) {\n   if (!options) {\n     return false\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\tc2258eb (parent)\n+++ common/src/api/schema.ts\taa99902 (commit)\n@@ -330,15 +330,18 @@\n     method: 'GET',\n     visibility: 'undocumented',\n     authed: false,\n     returns: {} as {\n-      betsByContract: { [contractId: string]: LimitBet[] }\n-      contracts: Contract[]\n+      bets: LimitBet[]\n+      contracts: MarketContract[]\n     },\n     props: z\n       .object({\n         userId: z.string(),\n         count: z.coerce.number().lte(5000),\n+        includeExpired: coerceBoolean.optional().default(false),\n+        includeCancelled: coerceBoolean.optional().default(false),\n+        includeFilled: coerceBoolean.optional().default(false),\n       })\n       .strict(),\n   },\n   'get-interesting-groups-from-views': {\n@@ -2109,9 +2112,9 @@\n     preferAuth: true,\n     authed: false,\n     returns: {} as {\n       metricsByContract: Dictionary<ContractMetric[]>\n-      contracts: Contract[]\n+      contracts: MarketContract[]\n     },\n     props: z.object({\n       userId: z.string(),\n       limit: z.coerce.number(),\n"
        },
        {
          "path": "web/components/bet/bet-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/bet-panel.tsx\n===================================================================\n--- web/components/bet/bet-panel.tsx\tc2258eb (parent)\n+++ web/components/bet/bet-panel.tsx\taa99902 (commit)\n@@ -795,14 +795,8 @@\n               unfilledBets={unfilledBets}\n               balanceByUserId={balanceByUserId}\n               outcome={outcome}\n               pseudonym={props.pseudonym}\n-              kycError={\n-                isCashContract && verificationStatus !== 'success'\n-                  ? verificationMessage\n-                  : undefined\n-              }\n-              shouldPromptVerification={shouldPromptVerification}\n             />\n           </>\n         )}\n \n"
        },
        {
          "path": "web/components/bet/limit-order-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/limit-order-panel.tsx\n===================================================================\n--- web/components/bet/limit-order-panel.tsx\tc2258eb (parent)\n+++ web/components/bet/limit-order-panel.tsx\taa99902 (commit)\n@@ -4,16 +4,12 @@\n import toast from 'react-hot-toast'\n import { LimitBet } from 'common/bet'\n import { getProbability } from 'common/calculate'\n import {\n-  BinaryContract,\n-  CPMMMultiContract,\n-  CPMMNumericContract,\n   getBinaryMCProb,\n   isBinaryMulti,\n+  MarketContract,\n   MultiContract,\n-  PseudoNumericContract,\n-  StonkContract,\n } from 'common/contract'\n import { formatPercent } from 'common/util/format'\n import { DAY_MS, HOUR_MS, MINUTE_MS, MONTH_MS, WEEK_MS } from 'common/util/time'\n import { Input } from 'web/components/widgets/input'\n@@ -31,9 +27,8 @@\n import clsx from 'clsx'\n import { getAnswerColor } from '../charts/contract/choice'\n import { MoneyDisplay } from './money-display'\n import { TRADE_TERM } from 'common/envs/constants'\n-import { LocationMonitor } from '../gidx/location-monitor'\n import { sliderColors } from '../widgets/slider'\n import { ProbabilitySlider } from '../widgets/probability-input'\n import { usePersistentLocalState } from 'web/hooks/use-persistent-local-state'\n import { APIParams } from 'common/api/schema'\n@@ -53,20 +48,13 @@\n   { label: 'Custom time...', value: -1 },\n ]\n \n export default function LimitOrderPanel(props: {\n-  contract:\n-    | BinaryContract\n-    | PseudoNumericContract\n-    | StonkContract\n-    | CPMMMultiContract\n-    | CPMMNumericContract\n+  contract: MarketContract\n   multiProps?: MultiBetProps\n   user: User | null | undefined\n   unfilledBets: LimitBet[]\n   balanceByUserId: { [userId: string]: number }\n-  kycError: string | undefined\n-  shouldPromptVerification?: boolean\n   onBuySuccess?: () => void\n   className?: string\n   betAmount?: number\n   outcome: 'YES' | 'NO' | undefined\n@@ -79,20 +67,19 @@\n       pseudonymName: string\n       pseudonymColor: keyof typeof sliderColors\n     }\n   }\n+  initialProb?: number\n }) {\n   const {\n     contract,\n     multiProps,\n     unfilledBets,\n     balanceByUserId,\n     user,\n-    kycError,\n     outcome,\n     onBuySuccess,\n     pseudonym,\n-    shouldPromptVerification,\n   } = props\n   const { pseudonymName, pseudonymColor } =\n     pseudonym?.[outcome as 'YES' | 'NO'] ?? {}\n   const isBinaryMC = isBinaryMulti(contract)\n@@ -142,15 +129,16 @@\n       ? selectedExpiration\n       : undefined\n \n   const initialProb =\n-    isBinaryMC && outcome === 'YES'\n+    props.initialProb ??\n+    (isBinaryMC && outcome === 'YES'\n       ? multiProps!.answerToBuy.prob\n       : isBinaryMC && outcome === 'NO'\n       ? 1 - multiProps!.answerToBuy.prob\n       : isCpmmMulti\n       ? multiProps!.answerToBuy.prob\n-      : getProbability(contract)\n+      : getProbability(contract))\n \n   const [limitProbInt, setLimitProbInt] = useState<number | undefined>(\n     Math.round(initialProb * 100)\n   )\n@@ -163,10 +151,9 @@\n     !outcome ||\n     !betAmount ||\n     !hasLimitBet ||\n     error === 'Insufficient balance' ||\n-    showLocationMonitor ||\n-    !!kycError\n+    showLocationMonitor\n \n   const preLimitProb =\n     limitProbInt === undefined\n       ? undefined\n@@ -305,9 +292,8 @@\n           disabled={isSubmitting}\n           showSlider\n           token={isCashContract ? 'CASH' : 'M$'}\n           sliderColor={pseudonymColor}\n-          disregardUserBalance={shouldPromptVerification}\n         />\n       </Col>\n       <Col className=\"relative mt-6 w-full gap-1\">\n         <div className=\"text-ink-600\">\n@@ -502,69 +488,52 @@\n             isCashContract={isCashContract}\n           />\n         </Row> */}\n \n-        {kycError && !shouldPromptVerification && user && (\n-          <div className=\"text-red-500\">{kycError}</div>\n-        )}\n-\n         <Col className=\"gap-2\">\n           {user ? (\n-            shouldPromptVerification ? (\n-              <span className=\"text-error\">\n-                New sweepstakes signups disabled{' '}\n-              </span>\n-            ) : (\n-              <>\n-                <LocationMonitor\n-                  contract={contract}\n-                  user={user}\n-                  setShowPanel={setShowLocationMonitor}\n-                  showPanel={showLocationMonitor}\n-                />\n-                <Row className=\"items-center justify-between gap-2\">\n-                  <Button\n-                    size=\"xl\"\n-                    disabled={betDisabled}\n-                    color={\n-                      (pseudonymColor as any) ??\n-                      (hideYesNo ? 'none' : outcome === 'YES' ? 'green' : 'red')\n-                    }\n-                    loading={isSubmitting}\n-                    className={clsx('flex-1 text-white')}\n-                    style={{\n-                      backgroundColor:\n-                        binaryMCColors?.[outcome == 'YES' ? 0 : 1],\n-                    }}\n-                    onClick={submitBet}\n-                  >\n-                    {isSubmitting ? (\n-                      'Submitting...'\n-                    ) : !outcome ? (\n-                      'Choose YES or NO'\n-                    ) : !limitProb ? (\n-                      'Enter a probability'\n-                    ) : !betAmount ? (\n-                      'Enter an amount'\n-                    ) : (\n-                      <span>\n-                        Buy{' '}\n-                        <MoneyDisplay\n-                          amount={betAmount}\n-                          isCashContract={isCashContract}\n-                        />{' '}\n-                        {!binaryMCOutcome && !pseudonymName ? outcome : ''} at{' '}\n-                        {formatPercent(\n-                          binaryMCOutcome || pseudonymName\n-                            ? preLimitProb ?? 0\n-                            : limitProb\n-                        )}\n-                      </span>\n-                    )}\n-                  </Button>\n-                </Row>\n-              </>\n-            )\n+            <>\n+              <Row className=\"items-center justify-between gap-2\">\n+                <Button\n+                  size=\"xl\"\n+                  disabled={betDisabled}\n+                  color={\n+                    (pseudonymColor as any) ??\n+                    (hideYesNo ? 'none' : outcome === 'YES' ? 'green' : 'red')\n+                  }\n+                  loading={isSubmitting}\n+                  className={clsx('flex-1 text-white')}\n+                  style={{\n+                    backgroundColor: binaryMCColors?.[outcome == 'YES' ? 0 : 1],\n+                  }}\n+                  onClick={submitBet}\n+                >\n+                  {isSubmitting ? (\n+                    'Submitting...'\n+                  ) : !outcome ? (\n+                    'Choose YES or NO'\n+                  ) : !limitProb ? (\n+                    'Enter a probability'\n+                  ) : !betAmount ? (\n+                    'Enter an amount'\n+                  ) : (\n+                    <span>\n+                      Buy{' '}\n+                      <MoneyDisplay\n+                        amount={betAmount}\n+                        isCashContract={isCashContract}\n+                      />{' '}\n+                      {!binaryMCOutcome && !pseudonymName ? outcome : ''} at{' '}\n+                      {formatPercent(\n+                        binaryMCOutcome || pseudonymName\n+                          ? preLimitProb ?? 0\n+                          : limitProb\n+                      )}\n+                    </span>\n+                  )}\n+                </Button>\n+              </Row>\n+            </>\n           ) : (\n             <Button\n               color={outcome === 'NO' ? 'red' : 'green'}\n               size=\"xl\"\n"
        },
        {
          "path": "web/components/bet/limit-orders-table.tsx",
          "status": "added",
          "diff": "Index: web/components/bet/limit-orders-table.tsx\n===================================================================\n--- web/components/bet/limit-orders-table.tsx\tc2258eb (parent)\n+++ web/components/bet/limit-orders-table.tsx\taa99902 (commit)\n@@ -0,0 +1,557 @@\n+'use client'\n+import { useState, useMemo, useEffect } from 'react'\n+import clsx from 'clsx'\n+import { groupBy, maxBy, sortBy, uniqBy } from 'lodash'\n+import { BiCaretDown, BiCaretUp, BiRefresh } from 'react-icons/bi'\n+import { contractPath, MarketContract } from 'common/contract'\n+import { LimitBet } from 'common/bet'\n+import { formatPercent } from 'common/util/format'\n+import Link from 'next/link'\n+import { Col } from '../layout/col'\n+import { Button, IconButton } from '../buttons/button'\n+import { Avatar } from '../widgets/avatar'\n+import { Modal, MODAL_CLASS } from '../layout/modal'\n+import { Tooltip } from '../widgets/tooltip'\n+import { api } from 'web/lib/api/api'\n+import { User } from 'web/lib/firebase/users'\n+import { usePersistentInMemoryState } from 'client-common/hooks/use-persistent-in-memory-state'\n+import { OrderTable } from './order-book'\n+import { OutcomeLabel } from '../outcome-label'\n+import { RelativeTimestamp } from '../relative-timestamp'\n+import { useAPIGetter } from 'web/hooks/use-api-getter'\n+import { BetFilter } from './user-bets-table'\n+import LimitOrderPanel from './limit-order-panel'\n+import {\n+  listenToUserOrders,\n+  useUnfilledBetsAndBalanceByUserId,\n+} from 'client-common/hooks/use-bets'\n+import { useIsPageVisible } from 'web/hooks/use-page-visible'\n+import { ChoicesToggleGroup } from '../widgets/choices-toggle-group'\n+import { Row } from '../layout/row'\n+import { PencilIcon } from '@heroicons/react/solid'\n+import { useLiveContract } from 'web/hooks/use-contract'\n+import { getContracts } from 'common/supabase/contracts'\n+import { db } from 'web/lib/supabase/db'\n+\n+type LimitOrderSort =\n+  | 'createTime'\n+  | 'expiryTime'\n+  | 'updateTime'\n+  | 'remainingAmount'\n+  | 'priceDiff'\n+\n+// Removed DismissedOrder type since we're removing dismiss functionality\n+type DetailedBet = LimitBet & {\n+  contract: MarketContract\n+  remainingAmount: number\n+  priceDiff: number\n+  timeToExpiry: number\n+  isExpired: boolean\n+}\n+// Function to toggle expired filter - will be exported to allow parent to use it\n+export function LimitOrdersTable(props: {\n+  query: string | undefined\n+  user: User\n+  isYourBets: boolean\n+  includeExpired: boolean\n+  includeFilled: boolean\n+  includeCancelled: boolean\n+  filter: BetFilter\n+  className?: string\n+}) {\n+  const {\n+    user,\n+    isYourBets,\n+    className,\n+    query,\n+    includeExpired,\n+    includeFilled,\n+    includeCancelled,\n+    filter,\n+  } = props\n+\n+  const { data } = useAPIGetter('get-user-limit-orders-with-contracts', {\n+    userId: user.id,\n+    count: 5000,\n+    includeExpired,\n+    includeFilled,\n+    includeCancelled,\n+  })\n+  const [limitUpdates, setLimitUpdates] = useState<LimitBet[]>([])\n+  listenToUserOrders(user.id, setLimitUpdates, true)\n+  const allLimitBets = uniqBy([...limitUpdates, ...(data?.bets ?? [])], 'id')\n+  const [missingContracts, setMissingContracts] = useState<MarketContract[]>([])\n+  const contracts = [...(data?.contracts ?? []), ...missingContracts]\n+  useEffect(() => {\n+    const missingContractIds = limitUpdates\n+      .map((b) => b.contractId)\n+      .filter((id) => !contracts.find((c) => c.id === id))\n+    if (missingContractIds.length > 0) {\n+      getContracts(db, missingContractIds).then((c) =>\n+        setMissingContracts(c as MarketContract[])\n+      )\n+    }\n+  }, [limitUpdates, data?.contracts])\n+\n+  const FILTERS: Record<BetFilter, (b: DetailedBet) => boolean> = {\n+    resolved: (b) =>\n+      !!b.contract.resolutionTime ||\n+      !!(\n+        b.contract.mechanism === 'cpmm-multi-1' &&\n+        b.contract.answers.find((a) => a.id === b.answerId)?.resolutionTime\n+      ),\n+    closed: (b) =>\n+      !FILTERS.resolved(b) && (b.contract.closeTime ?? Infinity) < Date.now(),\n+    open: (c) => !(FILTERS.closed(c) || FILTERS.resolved(c)),\n+    all: () => true,\n+    sold: () => true,\n+  }\n+\n+  // Removed dismissedOrders state and cleanup logic\n+\n+  // Sorting state\n+  const [sort, setSort] = usePersistentInMemoryState<{\n+    field: LimitOrderSort\n+    direction: 'asc' | 'desc'\n+  }>({ field: 'createTime', direction: 'desc' }, 'limit-orders-sort')\n+\n+  const onSetSort = (field: LimitOrderSort) => {\n+    if (sort.field === field) {\n+      setSort((prevSort) => ({\n+        ...prevSort,\n+        direction: prevSort.direction === 'asc' ? 'desc' : 'asc',\n+      }))\n+    } else {\n+      setSort({ field, direction: 'desc' })\n+    }\n+  }\n+\n+  const currentProb = (bet: LimitBet & { contract: MarketContract }) => {\n+    const contract = bet.contract\n+    if (contract.mechanism === 'cpmm-1') {\n+      return contract.prob\n+    } else if (bet.answerId && 'answers' in contract) {\n+      const answer = contract.answers.find((a) => a.id === bet.answerId)\n+      return answer?.prob ?? 0\n+    }\n+    return 0\n+  }\n+\n+  // Group bets by contract\n+  const betsByContract = useMemo(() => {\n+    return groupBy(allLimitBets, 'contractId')\n+  }, [allLimitBets])\n+\n+  // Create map of contracts by id for easier lookup\n+  const contractsById = useMemo(() => {\n+    return Object.fromEntries(contracts.map((c) => [c.id, c]))\n+  }, [contracts])\n+\n+  // Calculate remaining amount for each bet\n+  const betWithDetails = useMemo(() => {\n+    return allLimitBets\n+      .map((bet) => {\n+        const contract = contractsById[bet.contractId]\n+        if (!contract) return null\n+\n+        // Calculate remaining amount\n+        const filledAmount = bet.fills.reduce(\n+          (sum, fill) => sum + fill.amount,\n+          0\n+        )\n+        const remainingAmount = bet.orderAmount - filledAmount\n+\n+        const prob = currentProb({ ...bet, contract })\n+        const priceDiff = prob - bet.limitProb\n+\n+        // Calculate time to expiry\n+        const expiryTime = bet.expiresAt ?? Infinity\n+        const timeToExpiry = expiryTime - Date.now()\n+\n+        return {\n+          ...bet,\n+          contract,\n+          remainingAmount,\n+          priceDiff,\n+          timeToExpiry,\n+          isExpired: timeToExpiry <= 0 && isFinite(timeToExpiry),\n+        }\n+      })\n+      .filter(Boolean) as DetailedBet[]\n+  }, [allLimitBets, contractsById])\n+\n+  const lastFillTime = (bet: LimitBet) => {\n+    return maxBy(bet.fills, 'timestamp')?.timestamp ?? bet.updatedTime\n+  }\n+\n+  // Filter bets by search query and expired status\n+  const filteredByQueryAndExpiredBets = useMemo(() => {\n+    let filtered = betWithDetails.filter((b) => FILTERS[filter](b))\n+\n+    // Filter by search query\n+    if (query) {\n+      const lowerQuery = query.toLowerCase().trim()\n+      filtered = filtered.filter((bet) => {\n+        const contract = bet.contract\n+        // Search in contract question\n+        if (contract.question.toLowerCase().includes(lowerQuery)) return true\n+        // Search in creator name/username\n+        if (contract.creatorName?.toLowerCase().includes(lowerQuery))\n+          return true\n+        if (contract.creatorUsername?.toLowerCase().includes(lowerQuery))\n+          return true\n+        // Search in outcome/answer\n+        // Search in answer text for multiple choice\n+        if (bet.answerId && 'answers' in contract) {\n+          const answer = contract.answers.find((a) => a.id === bet.answerId)\n+          if (answer?.text.toLowerCase().includes(lowerQuery)) return true\n+        }\n+        return false\n+      })\n+    }\n+\n+    return filtered\n+  }, [betWithDetails, query, filter])\n+\n+  // Apply sorting\n+  const sortedBets = useMemo(() => {\n+    const sortFn = (bet: DetailedBet) => {\n+      switch (sort.field) {\n+        case 'createTime':\n+          return bet.createdTime\n+        case 'expiryTime':\n+          return bet.expiresAt ?? Infinity\n+        case 'updateTime':\n+          return lastFillTime(bet) ?? Infinity\n+        case 'remainingAmount':\n+          return bet.remainingAmount\n+        case 'priceDiff':\n+          return bet.priceDiff\n+        default:\n+          return bet.createdTime\n+      }\n+    }\n+\n+    return sort.direction === 'desc'\n+      ? sortBy(filteredByQueryAndExpiredBets, sortFn).reverse()\n+      : sortBy(filteredByQueryAndExpiredBets, sortFn)\n+  }, [filteredByQueryAndExpiredBets, sort, lastFillTime])\n+  const [showLimitModal, setShowLimitModal] = useState<LimitBet | null>(null)\n+  const [contractModalId, setContractModalId] = useState<string | null>(null)\n+  const openContractModal = (contractId: string) =>\n+    setContractModalId(contractId)\n+  const closeContractModal = () => setContractModalId(null)\n+\n+  if (betWithDetails.length === 0) {\n+    return (\n+      <Col className={clsx(className, 'items-center justify-center p-4')}>\n+        <p className=\"text-ink-600\">No limit orders found</p>\n+      </Col>\n+    )\n+  }\n+\n+  if (filteredByQueryAndExpiredBets.length === 0) {\n+    return (\n+      <Col className={clsx(className, 'items-center justify-center p-4')}>\n+        <p className=\"text-ink-600\">No limit orders match your criteria</p>\n+      </Col>\n+    )\n+  }\n+\n+  return (\n+    <Col className={clsx(className, 'w-full')}>\n+      <div className=\"bg-canvas-0 grid-cols-16 sticky top-10 z-10 grid gap-2 text-sm font-semibold\">\n+        <div className=\"col-span-4 sm:col-span-3\">Market</div>\n+        <div\n+          className=\"col-span-2 flex cursor-pointer items-center justify-end \"\n+          onClick={() => onSetSort('createTime')}\n+        >\n+          Created\n+          {sort.field === 'createTime' &&\n+            (sort.direction === 'asc' ? <BiCaretUp /> : <BiCaretDown />)}\n+        </div>\n+        <div\n+          className=\"col-span-2 flex cursor-pointer items-center justify-end\"\n+          onClick={() => onSetSort('expiryTime')}\n+        >\n+          Expiry\n+          {sort.field === 'expiryTime' &&\n+            (sort.direction === 'asc' ? <BiCaretUp /> : <BiCaretDown />)}\n+        </div>\n+        <div\n+          className=\"col-span-2 flex cursor-pointer items-center justify-end\"\n+          onClick={() => onSetSort('updateTime')}\n+        >\n+          Fill\n+          {sort.field === 'updateTime' &&\n+            (sort.direction === 'asc' ? <BiCaretUp /> : <BiCaretDown />)}\n+        </div>\n+        <div\n+          className=\"col-span-4 flex cursor-pointer items-center justify-end sm:col-span-2\"\n+          onClick={() => onSetSort('remainingAmount')}\n+        >\n+          Remaining\n+          {sort.field === 'remainingAmount' &&\n+            (sort.direction === 'asc' ? <BiCaretUp /> : <BiCaretDown />)}\n+        </div>\n+        <div\n+          className=\"col-span-2 hidden cursor-pointer items-center justify-end sm:flex\"\n+          onClick={() => onSetSort('priceDiff')}\n+        >\n+          Price ∆\n+          {sort.field === 'priceDiff' &&\n+            (sort.direction === 'asc' ? <BiCaretUp /> : <BiCaretDown />)}\n+        </div>\n+        <div className=\"col-span-2 flex justify-end sm:col-span-2\">Edit</div>\n+      </div>\n+\n+      {sortedBets.map((bet) => {\n+        const contract = bet.contract\n+        const isOpen =\n+          !contract.isResolved && (contract.closeTime ?? Infinity) > Date.now()\n+        const isFilledOrCancelled = bet.isFilled || bet.isCancelled\n+        const isExpired = bet.isExpired\n+\n+        return (\n+          <div\n+            key={bet.id}\n+            className={clsx(\n+              'border-ink-200 grid-cols-16 grid items-center gap-2 border-b py-3',\n+              (isFilledOrCancelled || isExpired) && 'bg-canvas-50'\n+            )}\n+          >\n+            <div className=\"col-span-4 min-w-0 sm:col-span-3\">\n+              <Link\n+                href={contractPath(contract)}\n+                className=\"flex items-center gap-2 truncate hover:underline\"\n+              >\n+                <Avatar avatarUrl={contract.creatorAvatarUrl} size=\"2xs\" />\n+                <span className=\"text-ink-500 truncate\">\n+                  {contract.question}\n+                </span>\n+              </Link>\n+              <div className=\" text-xs\">\n+                <OutcomeLabel\n+                  contract={contract}\n+                  outcome={bet.outcome}\n+                  truncate=\"short\"\n+                  answer={\n+                    'answers' in contract\n+                      ? contract.answers.find((a) => a.id === bet.answerId)\n+                      : undefined\n+                  }\n+                />{' '}\n+                {formatPercent(bet.limitProb)}\n+              </div>\n+            </div>\n+\n+            <div className=\"col-span-2 text-right text-sm\">\n+              <Tooltip text={new Date(bet.createdTime).toLocaleString()}>\n+                <span>\n+                  {RelativeTimestamp({\n+                    time: bet.createdTime,\n+                    shortened: true,\n+                    useUseClient: false,\n+                    className: 'text-ink-500',\n+                  })}\n+                </span>\n+              </Tooltip>\n+            </div>\n+\n+            <div className=\"text-ink-500 col-span-2 text-right text-sm \">\n+              {bet.expiresAt ? (\n+                <Tooltip text={new Date(bet.expiresAt).toLocaleString()}>\n+                  <span>\n+                    {bet.timeToExpiry <= 0\n+                      ? 'Expired'\n+                      : RelativeTimestamp({\n+                          time: bet.expiresAt,\n+                          shortened: true,\n+                          useUseClient: false,\n+                          className: 'text-ink-500',\n+                        })}\n+                  </span>\n+                </Tooltip>\n+              ) : (\n+                <span className=\"\">Never</span>\n+              )}\n+            </div>\n+            <div className=\"col-span-2 text-right text-sm\">\n+              {lastFillTime(bet) ? (\n+                <Tooltip text={new Date(lastFillTime(bet)!).toLocaleString()}>\n+                  <span>\n+                    {RelativeTimestamp({\n+                      time: lastFillTime(bet)!,\n+                      shortened: true,\n+                      useUseClient: false,\n+                      className: 'text-ink-500',\n+                    })}\n+                  </span>\n+                </Tooltip>\n+              ) : (\n+                <span className=\"text-ink-500\">Never</span>\n+              )}\n+            </div>\n+\n+            <div className=\"col-span-4 text-right sm:col-span-2\">\n+              <div className={clsx(isFilledOrCancelled ? 'text-ink-500' : '')}>\n+                {Math.floor(bet.remainingAmount)}/{Math.floor(bet.orderAmount)}\n+              </div>\n+              {isFilledOrCancelled && (\n+                <div className=\"text-ink-500 text-xs\">\n+                  {bet.isFilled ? 'Filled' : 'Cancelled'}\n+                </div>\n+              )}\n+            </div>\n+\n+            <div className=\"col-span-2 hidden text-right sm:block\">\n+              <div\n+                className={clsx(\n+                  'text-sm',\n+                  // For YES bets, profit when price goes up; for NO bets, profit when price goes down\n+                  (bet.outcome === 'YES' && bet.priceDiff > 0) ||\n+                    (bet.outcome === 'NO' && bet.priceDiff < 0)\n+                    ? 'text-teal-500'\n+                    : (bet.outcome === 'YES' && bet.priceDiff < 0) ||\n+                      (bet.outcome === 'NO' && bet.priceDiff > 0)\n+                    ? 'text-scarlet-500'\n+                    : 'text-ink-500'\n+                )}\n+              >\n+                {bet.priceDiff > 0 ? '+' : ''}\n+                {Math.round(bet.priceDiff * 100)}\n+              </div>\n+              <span className=\"text-ink-500 text-xs\">\n+                {formatPercent(bet.limitProb)} →{' '}\n+                {formatPercent(currentProb(bet))}\n+              </span>\n+            </div>\n+\n+            <div className=\"col-span-2 flex justify-end gap-1\">\n+              {isYourBets && (isFilledOrCancelled || isExpired) && isOpen && (\n+                <IconButton size=\"xs\" onClick={() => setShowLimitModal(bet)}>\n+                  <Tooltip text=\"Reload order with same parameters\">\n+                    <BiRefresh />\n+                  </Tooltip>\n+                </IconButton>\n+              )}\n+\n+              <IconButton\n+                size=\"xs\"\n+                onClick={() => openContractModal(contract.id)}\n+              >\n+                <Tooltip text=\"Edit orders for this market\">\n+                  <span className=\"text-xs\">\n+                    <PencilIcon className=\"h-4 w-4\" />\n+                  </span>\n+                </Tooltip>\n+              </IconButton>\n+            </div>\n+            {showLimitModal?.id === bet.id && (\n+              <RefreshLimitOrderModal\n+                bet={showLimitModal}\n+                contract={contract}\n+                user={user}\n+                onClose={() => setShowLimitModal(null)}\n+              />\n+            )}\n+          </div>\n+        )\n+      })}\n+\n+      {contractModalId && (\n+        <Modal open={!!contractModalId} setOpen={closeContractModal}>\n+          <div className={MODAL_CLASS}>\n+            <h3 className=\"mb-4 text-lg font-bold\">All orders</h3>\n+            {contractModalId && contractsById[contractModalId] && (\n+              <OrderTable\n+                contract={contractsById[contractModalId]}\n+                limitBets={betsByContract[contractModalId] || []}\n+                isYou={isYourBets}\n+              />\n+            )}\n+            <Button className=\"mt-4\" onClick={closeContractModal}>\n+              Close\n+            </Button>\n+          </div>\n+        </Modal>\n+      )}\n+    </Col>\n+  )\n+}\n+\n+const RefreshLimitOrderModal = (props: {\n+  bet: LimitBet\n+  contract: MarketContract\n+  user: User\n+  onClose: () => void\n+}) => {\n+  const { bet, user, onClose } = props\n+  const { limitProb } = bet\n+  const contract = useLiveContract(props.contract)\n+  const answerId = bet.answerId\n+  const prob =\n+    contract.mechanism === 'cpmm-multi-1'\n+      ? contract.answers.find((a) => a.id === answerId)?.prob ?? 0\n+      : contract.prob\n+  const { unfilledBets: allUnfilledBets, balanceByUserId } =\n+    useUnfilledBetsAndBalanceByUserId(\n+      contract.id,\n+      (params) => api('bets', params),\n+      (params) => api('users/by-id/balance', params),\n+      useIsPageVisible\n+    )\n+\n+  const unfilledBetsMatchingAnswer = allUnfilledBets.filter(\n+    (b) => b.answerId === answerId\n+  )\n+\n+  return (\n+    <Modal open={true} setOpen={onClose}>\n+      <div className={MODAL_CLASS}>\n+        <Row className=\"mb-2 items-baseline justify-between gap-2 text-lg\">\n+          <div className=\"\">{contract.question}</div>\n+          <div className=\"font-bold\">{formatPercent(prob)}</div>\n+        </Row>\n+        <LimitOrderPanel\n+          initialProb={limitProb}\n+          multiProps={\n+            contract.mechanism === 'cpmm-multi-1'\n+              ? {\n+                  answers: contract.answers,\n+                  answerToBuy: contract.answers.find((a) => a.id === answerId)!,\n+                }\n+              : undefined\n+          }\n+          contract={contract}\n+          user={user}\n+          unfilledBets={unfilledBetsMatchingAnswer}\n+          balanceByUserId={balanceByUserId}\n+          betAmount={bet.orderAmount}\n+          outcome={bet.outcome as 'YES' | 'NO'}\n+        />\n+      </div>\n+    </Modal>\n+  )\n+}\n+\n+// A small component to toggle limit order view in UserBetsTable\n+export function LimitOrdersToggle(props: {\n+  showLimitOrders: boolean\n+  setShowLimitOrders: (show: boolean) => void\n+}) {\n+  const { showLimitOrders, setShowLimitOrders } = props\n+\n+  return (\n+    <Col>\n+      <ChoicesToggleGroup\n+        currentChoice={showLimitOrders ? 'Orders' : 'Bets'}\n+        choicesMap={{\n+          Bets: 'Bets',\n+          Orders: 'Orders',\n+        }}\n+        setChoice={(choice) => setShowLimitOrders(choice === 'Orders')}\n+      />\n+    </Col>\n+  )\n+}\n"
        },
        {
          "path": "web/components/bet/order-book.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/order-book.tsx\n===================================================================\n--- web/components/bet/order-book.tsx\tc2258eb (parent)\n+++ web/components/bet/order-book.tsx\taa99902 (commit)\n@@ -127,9 +127,11 @@\n   const [isCancelling, setIsCancelling] = useState(false)\n   const onCancel = async () => {\n     setIsCancelling(true)\n     await Promise.all(\n-      limitBets.map((bet) => api('bet/cancel/:betId', { betId: bet.id }))\n+      limitBets\n+        .filter((b) => !b.isCancelled)\n+        .map((bet) => api('bet/cancel/:betId', { betId: bet.id }))\n     )\n     setIsCancelling(false)\n   }\n   return (\n@@ -143,19 +145,23 @@\n             <th>Amount</th>\n             <th>\n               <Row className={'mt-1 justify-between gap-1 sm:justify-start'}>\n                 Expires\n-                {isYou && limitBets.length > 1 && (\n-                  <Button\n-                    loading={isCancelling}\n-                    size={'2xs'}\n-                    color={'gray-outline'}\n-                    onClick={onCancel}\n-                    className={'ml-1 whitespace-normal'}\n-                  >\n-                    Cancel all\n-                  </Button>\n-                )}\n+                {isYou &&\n+                  limitBets.length > 1 &&\n+                  limitBets.some(\n+                    (b) => !b.isCancelled && b.amount < b.orderAmount\n+                  ) && (\n+                    <Button\n+                      loading={isCancelling}\n+                      size={'2xs'}\n+                      color={'gray-outline'}\n+                      onClick={onCancel}\n+                      className={'ml-1 whitespace-normal'}\n+                    >\n+                      Cancel all\n+                    </Button>\n+                  )}\n               </Row>\n             </th>\n           </tr>\n         </thead>\n@@ -198,8 +204,10 @@\n     setIsCancelling(false)\n   }\n   const isCashContract = contract.token === 'CASH'\n   const expired = bet.expiresAt && bet.expiresAt < Date.now()\n+  const filled = bet.amount >= bet.orderAmount\n+  const cancelled = bet.isCancelled\n \n   return (\n     <tr>\n       {!isYou && user && (\n@@ -251,8 +259,12 @@\n             <Col className={'sm:flex-row sm:gap-1'}>\n               <span>\n                 {expired ? (\n                   'Expired'\n+                ) : filled ? (\n+                  'Filled'\n+                ) : cancelled ? (\n+                  'Cancelled'\n                 ) : bet.expiresAt ? (\n                   <Tooltip\n                     text={`${new Date(\n                       bet.expiresAt\n@@ -267,16 +279,18 @@\n                 )}\n               </span>\n             </Col>\n             <div>\n-              <Button\n-                loading={isCancelling}\n-                size=\"2xs\"\n-                color=\"gray-outline\"\n-                onClick={onCancel}\n-              >\n-                Cancel\n-              </Button>\n+              {filled || cancelled ? null : (\n+                <Button\n+                  loading={isCancelling}\n+                  size=\"2xs\"\n+                  color=\"gray-outline\"\n+                  onClick={onCancel}\n+                >\n+                  Cancel\n+                </Button>\n+              )}\n             </div>\n           </Row>\n         </td>\n       )}\n"
        },
        {
          "path": "web/components/bet/user-bets-table.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/user-bets-table.tsx\n===================================================================\n--- web/components/bet/user-bets-table.tsx\tc2258eb (parent)\n+++ web/components/bet/user-bets-table.tsx\taa99902 (commit)\n@@ -2,16 +2,20 @@\n import { ChevronUpIcon } from '@heroicons/react/solid'\n import clsx from 'clsx'\n import { LimitBet } from 'common/bet'\n import { getContractBetNullMetrics } from 'common/calculate'\n-import { Contract, contractPath, CPMMContract } from 'common/contract'\n+import {\n+  Contract,\n+  contractPath,\n+  CPMMContract,\n+  MarketContract,\n+} from 'common/contract'\n import { ContractMetric } from 'common/contract-metric'\n import {\n   ENV_CONFIG,\n   SWEEPIES_MARKET_TOOLTIP,\n   TRADE_TERM,\n } from 'common/envs/constants'\n-import { unauthedApi } from 'common/util/api'\n import { buildArray } from 'common/util/array'\n import {\n   formatMoney,\n   formatWithToken,\n@@ -19,9 +23,9 @@\n   shortFormatNumber,\n   SWEEPIES_MONIKER,\n } from 'common/util/format'\n import { searchInAny } from 'common/util/parse'\n-import { Dictionary, max, sortBy, sum, uniqBy, mapValues } from 'lodash'\n+import { Dictionary, sortBy, sum, uniqBy, mapValues } from 'lodash'\n import Link from 'next/link'\n import { ReactNode, useEffect, useMemo, useState } from 'react'\n import { BiCaretDown, BiCaretUp } from 'react-icons/bi'\n import { BsThreeDotsVertical } from 'react-icons/bs'\n@@ -49,17 +53,17 @@\n import { User } from 'web/lib/firebase/users'\n import { SweepiesCoin } from 'web/public/custom-components/sweepiesCoin'\n import DropdownMenu from '../widgets/dropdown-menu'\n import { Modal, MODAL_CLASS } from '../layout/modal'\n-import { SweepsToggle } from '../sweeps/sweeps-toggle'\n import { useSweepstakes } from '../sweepstakes-provider'\n import { LoadingIndicator } from '../widgets/loading-indicator'\n import { linkClass } from '../widgets/site-link'\n import { Tooltip } from '../widgets/tooltip'\n import { floatingEqual } from 'common/util/math'\n import { Col } from '../layout/col'\n import { Row } from '../layout/row'\n import { useIsPageVisible } from 'web/hooks/use-page-visible'\n+import { LimitOrdersTable, LimitOrdersToggle } from './limit-orders-table'\n type BetSort =\n   | 'newest'\n   | 'profit'\n   | 'closeTime'\n@@ -69,9 +73,9 @@\n   | 'probChangeDay'\n   | 'profitPercent'\n   | 'position'\n \n-type BetFilter = 'open' | 'limit_bet' | 'sold' | 'closed' | 'resolved' | 'all'\n+export type BetFilter = 'open' | 'sold' | 'closed' | 'resolved' | 'all'\n \n const JUNE_1_2022 = new Date('2022-06-01T00:00:00.000Z').valueOf()\n export function UserBetsTable(props: { user: User }) {\n   const { user } = props\n@@ -85,16 +89,28 @@\n     Dictionary<ContractMetric> | undefined\n   >(undefined, `user-contract-metrics-${user.id}`)\n \n   const [contracts, setContracts] = usePersistentInMemoryState<\n-    Contract[] | undefined\n+    MarketContract[] | undefined\n   >(undefined, `user-contract-metrics-contracts-${user.id}`)\n \n-  const [openLimitBetsByContract, setOpenLimitBetsByContract] =\n-    usePersistentInMemoryState<Dictionary<LimitBet[]> | undefined>(\n-      undefined,\n-      `user-open-limit-bets-${user.id}`\n-    )\n+  const [showLimitOrders, setShowLimitOrders] = usePersistentLocalState(\n+    false,\n+    'show-limit-orders-view'\n+  )\n+  // Add state for showing expired orders\n+  const [includeExpired, setIncludeExpired] = usePersistentInMemoryState(\n+    false,\n+    'limit-orders-show-expired'\n+  )\n+  const [includeFilled, setIncludeFilled] = usePersistentInMemoryState(\n+    false,\n+    'limit-orders-show-filled'\n+  )\n+  const [includeCancelled, setIncludeCancelled] = usePersistentInMemoryState(\n+    false,\n+    'limit-orders-show-cancelled'\n+  )\n \n   const getMetrics = useEvent(() =>\n     api('get-user-contract-metrics-with-contracts', {\n       userId: user.id,\n@@ -117,21 +133,8 @@\n       getMetrics()\n     }\n   }, [getMetrics, user.id, isAuth])\n \n-  useEffect(() => {\n-    unauthedApi('get-user-limit-orders-with-contracts', {\n-      userId: user.id,\n-      count: 5000,\n-    }).then((betsWithContracts) => {\n-      const { contracts, betsByContract } = betsWithContracts\n-      setOpenLimitBetsByContract(betsByContract)\n-      setContracts((c) =>\n-        uniqBy(buildArray([...(c ?? []), ...contracts]), 'id')\n-      )\n-    })\n-  }, [setContracts, setOpenLimitBetsByContract, user.id, isAuth])\n-\n   const [filter, setFilter] = usePersistentLocalState<BetFilter>(\n     'open',\n     'bets-list-filter'\n   )\n@@ -180,12 +183,10 @@\n       !FILTERS.resolved(c) && (c.closeTime ?? Infinity) < Date.now(),\n     open: (c) => !(FILTERS.closed(c) || FILTERS.resolved(c)),\n     all: () => true,\n     sold: () => true,\n-    limit_bet: (c) => FILTERS.open(c),\n   }\n-  const loaded =\n-    nullableMetricsByContract && openLimitBetsByContract && contracts\n+  const loaded = nullableMetricsByContract && contracts\n \n   const filteredContracts = loaded\n     ? queriedContracts\n         ?.filter(FILTERS[filter])\n@@ -196,62 +197,87 @@\n           const hasShares = Object.values(totalShares).some(\n             (s) => !floatingEqual(s, 0)\n           )\n           if (filter === 'sold') return !hasShares\n-          if (filter === 'limit_bet')\n-            return openLimitBetsByContract[c.id]?.length > 0\n           return hasShares\n         })\n         .filter((c) => {\n           if (!prefersPlay) return c.token === 'CASH'\n           else return c.token === 'MANA' || !c.token\n         })\n     : []\n+\n+  const hasSweeps = contracts?.some((c) => c.token === 'CASH')\n   return (\n     <Col>\n       <div className=\"flex flex-wrap justify-between gap-4 max-sm:flex-col\">\n         <Col className=\"w-full gap-2\">\n-          <Input\n-            placeholder={isYou ? 'Search your trades' : 'Search trades'}\n-            className={'w-full min-w-[30px]'}\n-            value={query}\n-            onChange={(e) => setQuery(e.target.value)}\n-          />\n+          <Row className=\"items-center gap-1 sm:gap-2\">\n+            <Input\n+              placeholder={isYou ? 'Search your bets' : 'Search bets'}\n+              className={'w-full min-w-[30px]'}\n+              value={query}\n+              onChange={(e) => setQuery(e.target.value)}\n+            />\n+            {isYou && (\n+              <LimitOrdersToggle\n+                showLimitOrders={showLimitOrders}\n+                setShowLimitOrders={setShowLimitOrders}\n+              />\n+            )}\n+          </Row>\n           <Carousel labelsParentClassName={'gap-1'}>\n-            {!prefersPlay && (\n-              <SweepsToggle sweepsEnabled isSmall onClick={toggleTokenFilter} />\n+            {showLimitOrders && isYou && (\n+              <PillButton\n+                selected={includeExpired}\n+                onSelect={() => setIncludeExpired(!includeExpired)}\n+              >\n+                Expired\n+              </PillButton>\n             )}\n-            {(\n-              [\n-                'all',\n-                'open',\n-                'limit_bet',\n-                'sold',\n-                'closed',\n-                'resolved',\n-              ] as BetFilter[]\n-            ).map((f) => (\n+            {showLimitOrders && isYou && (\n               <PillButton\n-                key={f}\n-                selected={filter === f}\n-                onSelect={() => onSetFilter(f)}\n+                selected={includeFilled}\n+                onSelect={() => setIncludeFilled(!includeFilled)}\n               >\n-                {f === 'limit_bet'\n-                  ? 'Limit orders'\n-                  : f === 'all'\n-                  ? 'All'\n-                  : f === 'sold'\n-                  ? 'Sold'\n-                  : f === 'closed'\n-                  ? 'Closed'\n-                  : f === 'resolved'\n-                  ? 'Resolved'\n-                  : 'Open'}\n+                Filled\n               </PillButton>\n-            ))}\n-            {prefersPlay && (\n-              <SweepsToggle sweepsEnabled isSmall onClick={toggleTokenFilter} />\n             )}\n+            {showLimitOrders && isYou && (\n+              <PillButton\n+                selected={includeCancelled}\n+                onSelect={() => setIncludeCancelled(!includeCancelled)}\n+              >\n+                Cancelled\n+              </PillButton>\n+            )}\n+            {(['all', 'open', 'sold', 'closed', 'resolved'] as BetFilter[]).map(\n+              (f) => (\n+                <PillButton\n+                  key={f}\n+                  selected={filter === f}\n+                  onSelect={() => onSetFilter(f)}\n+                >\n+                  {f === 'all'\n+                    ? 'All'\n+                    : f === 'sold'\n+                    ? 'Sold'\n+                    : f === 'closed'\n+                    ? 'Closed'\n+                    : f === 'resolved'\n+                    ? 'Resolved'\n+                    : 'Open'}\n+                </PillButton>\n+              )\n+            )}\n+            {hasSweeps && (\n+              <PillButton\n+                selected={!(prefersPlay ?? false)}\n+                onSelect={toggleTokenFilter}\n+              >\n+                Sweepcash\n+              </PillButton>\n+            )}\n           </Carousel>\n         </Col>\n       </div>\n \n@@ -262,13 +288,23 @@\n           <LoadingMetricRow />\n         </Col>\n       ) : Object.keys(nullableMetricsByContract).length === 0 ? (\n         <NoBets user={user} />\n+      ) : showLimitOrders && isYou ? (\n+        <LimitOrdersTable\n+          query={query}\n+          user={user}\n+          isYourBets={isYou}\n+          includeExpired={includeExpired}\n+          includeFilled={includeFilled}\n+          includeCancelled={includeCancelled}\n+          filter={filter}\n+          className=\"mt-2\"\n+        />\n       ) : (\n         <BetsTable\n           contracts={filteredContracts as CPMMContract[]}\n           metricsByContractId={nullableMetricsByContract}\n-          openLimitBetsByContract={openLimitBetsByContract}\n           page={page}\n           user={user}\n           setPage={setPage}\n           filter={filter}\n@@ -299,24 +335,16 @@\n \n function BetsTable(props: {\n   contracts: CPMMContract[]\n   metricsByContractId: { [key: string]: ContractMetric }\n-  openLimitBetsByContract: { [key: string]: LimitBet[] }\n   page: number\n   setPage: (page: number) => void\n   filter: BetFilter\n   user: User\n   signedInUser: User | null | undefined\n }) {\n-  const {\n-    metricsByContractId,\n-    page,\n-    setPage,\n-    filter,\n-    openLimitBetsByContract,\n-    user,\n-    signedInUser,\n-  } = props\n+  const { metricsByContractId, page, setPage, filter, user, signedInUser } =\n+    props\n   const areYourBets = user.id === signedInUser?.id\n   const [sort, setSort] = usePersistentInMemoryState<{\n     field: BetSort\n     direction: 'asc' | 'desc'\n@@ -370,21 +398,10 @@\n   const SORTS: Record<BetSort, (c: Contract) => number> = {\n     position: (c) => -sum(Object.values(metricsByContractId[c.id].totalShares)),\n     profit: (c) => -metricsByContractId[c.id].profit,\n     profitPercent: (c) => -metricsByContractId[c.id].profitPercent,\n-    value: (c) =>\n-      -(\n-        metricsByContractId[c.id].payout +\n-        (filter === 'limit_bet'\n-          ? sum(openLimitBetsByContract[c.id].map((b) => b.orderAmount))\n-          : 0)\n-      ),\n-    newest: (c) =>\n-      -(\n-        metricsByContractId[c.id].lastBetTime ??\n-        max(openLimitBetsByContract[c.id]?.map((b) => b.createdTime)) ??\n-        0\n-      ),\n+    value: (c) => -metricsByContractId[c.id].payout,\n+    newest: (c) => -(metricsByContractId[c.id].lastBetTime ?? 0),\n     probChangeDay: (c) => {\n       if (c.mechanism === 'cpmm-1') {\n         return -(c as CPMMContract).probChanges.day\n       }\n@@ -631,9 +648,9 @@\n           )}\n         >\n           {columnsToDisplay.map((col) =>\n             col.header.placeholder ? (\n-              <span key={col.header.label} />\n+              <span key={col.header.label} className=\"text-sm\" />\n             ) : (\n               <span\n                 key={col.header.sort}\n                 className={clsx(\n@@ -654,8 +671,9 @@\n                     sort.field === col.header.altSort\n                       ? sort.direction === 'asc'\n                       : undefined\n                   }\n+                  className=\"text-sm font-semibold\"\n                 >\n                   {col.header.label}\n                 </Header>\n                 {col.headerBuddy ? col.headerBuddy : null}\n@@ -704,9 +722,9 @@\n                           size={'2xs'}\n                           className={''}\n                         />\n                       </span>\n-                      <span>\n+                      <span className=\"text-ink-500 line-clamp-1\">\n                         {contract.token == 'CASH' && (\n                           <span>\n                             <Tooltip\n                               text={SWEEPIES_MARKET_TOOLTIP}\n@@ -717,11 +735,13 @@\n                           </span>\n                         )}\n                         {contract.question}\n                       </span>\n-                      <span className={'ml-2 flex min-w-[40px] items-center'}>\n+                      <span className={' ml-1 flex min-w-[40px] justify-end'}>\n                         <ContractStatusLabel\n-                          className={'font-semibold'}\n+                          className={\n+                            '!text-ink-500 whitespace-nowrap font-semibold'\n+                          }\n                           contract={contract}\n                         />\n                       </span>\n                     </Link>\n@@ -860,16 +880,18 @@\n         areYourBets={areYourBets}\n       />\n       {contract.mechanism === 'cpmm-1' && limitBets.length > 0 && (\n         <div className=\"max-w-md\">\n-          <div className=\"bg-canvas-50 mt-4 p-2\">Limit orders</div>\n+          <div className=\" font-semibold\">Limit orders</div>\n           <OrderTable\n             contract={contract}\n             limitBets={limitBets}\n             isYou={areYourBets}\n           />\n+          <div className=\"font-semibold\">Bets</div>\n         </div>\n       )}\n+\n       <ContractBetsTable\n         key={contract.id + 'bets-table'}\n         contract={contract}\n         bets={bets}\n@@ -920,21 +942,19 @@\n   className?: string\n }) => {\n   const { onClick, up, className, children } = props\n   return (\n-    <Row className={clsx(className, 'cursor-pointer')} onClick={onClick}>\n+    <Row\n+      className={clsx(className, 'cursor-pointer items-center')}\n+      onClick={onClick}\n+    >\n       {up != undefined ? (\n         up ? (\n           <BiCaretUp className=\" h-4\" />\n         ) : (\n-          <BiCaretDown className=\"mt-1.5 h-4\" />\n+          <BiCaretDown className=\" h-4\" />\n         )\n-      ) : (\n-        <Col className={'items-center justify-center'}>\n-          <BiCaretUp className=\"text-ink-300 -mb-2 h-4\" />\n-          <BiCaretDown className=\"text-ink-300 h-4\" />\n-        </Col>\n-      )}\n+      ) : null}\n       <span>{children}</span>\n     </Row>\n   )\n }\n"
        },
        {
          "path": "web/components/relative-timestamp.tsx",
          "status": "modified",
          "diff": "Index: web/components/relative-timestamp.tsx\n===================================================================\n--- web/components/relative-timestamp.tsx\tc2258eb (parent)\n+++ web/components/relative-timestamp.tsx\taa99902 (commit)\n@@ -7,11 +7,13 @@\n   time: number\n   className?: string\n   placement?: Placement\n   shortened?: boolean\n+  useUseClient?: boolean\n }) {\n-  const { time, className, placement, shortened } = props\n-  const isClient = useIsClient()\n+  const { time, className, placement, shortened, useUseClient } = props\n+  // eslint-disable-next-line react-hooks/rules-of-hooks\n+  const isClient = useUseClient ? useIsClient() : true\n   return (\n     <DateTimeTooltip\n       className=\"text-ink-400 ml-1 whitespace-nowrap\"\n       time={time}\n"
        },
        {
          "path": "web/components/widgets/choices-toggle-group.tsx",
          "status": "modified",
          "diff": "Index: web/components/widgets/choices-toggle-group.tsx\n===================================================================\n--- web/components/widgets/choices-toggle-group.tsx\tc2258eb (parent)\n+++ web/components/widgets/choices-toggle-group.tsx\taa99902 (commit)\n@@ -9,8 +9,10 @@\n   green:\n     'text-ink-500 hover:bg-ink-50 aria-checked:bg-teal-500 aria-checked:text-ink-0',\n   red: 'text-ink-500 hover:bg-ink-50 aria-checked:bg-scarlet-500 aria-checked:text-ink-0',\n   gray: 'text-ink-900 aria-checked:shadow bg-canvas-50 hover:bg-canvas-50 aria-checked:bg-canvas-0',\n+  'light-gray':\n+    'text-ink-900 aria-checked:shadow bg-canvas-50 hover:bg-canvas-50 aria-checked:bg-canvas-0',\n   light:\n     'text-ink-900 aria-checked:shadow bg-transparent hover:bg-canvas-50/70 aria-checked:bg-canvas-0 ',\n   'light-green':\n     'text-ink-900 aria-checked:shadow bg-transparent hover:bg-canvas-50/70 aria-checked:bg-teal-500/20 ',\n@@ -48,9 +50,10 @@\n   const isModernStyle =\n     color === 'gray' ||\n     color === 'light' ||\n     color === 'light-green' ||\n-    color === 'light-red'\n+    color === 'light-red' ||\n+    color === 'light-gray'\n \n   return (\n     <RadioGroup\n       className={clsx(\n"
        }
      ]
    },
    {
      "id": "optimize-metrics-query",
      "sha": "d311fbd77565f345c27c45814611dcd9fe79135b",
      "parentSha": "96044280e430f994e608c40449fb06d53cb85081",
      "spec": "Implement targeted metric querying and safe summary recomputation for market resolution.\n\nMake the following changes:\n\n1) Update common/src/calculate-metrics.ts\n- Change the signature of calculateUpdatedMetricsForContracts to accept a second optional boolean parameter useIncludedSummaryMetric with a default of false.\n- In the cpmm-multi-1 branch:\n  - If useIncludedSummaryMetric is true, find the existing summary metric for this user with isSummary(). Store it as oldSummary.\n  - When mapping answerMetrics to updatedAnswerMetrics, if oldSummary exists, call applyMetricToSummary(m, oldSummary, false) before recalculating each answer metric. This removes previous contributions from the included summary.\n  - Compute summaryMetric as either the included summary metric (if useIncludedSummaryMetric is true and present) or a freshly created default via getDefaultMetric. Ensure a summary metric exists even if none was included.\n  - Apply applyMetricToSummary on each updated answer metric to the summaryMetric (with add=true), then return [...updatedAnswerMetrics, summaryMetric].\n- Ensure the original behavior is unchanged for binary contracts and for multi contracts when useIncludedSummaryMetric is false.\n\n2) Update backend/shared/src/utils.ts (getContractAndMetricsAndLiquidities)\n- Add logic to build a metricsQuery string depending on contract type:\n  - Compute isMulti from mechanism === 'cpmm-multi-1'.\n  - Compute sumsToOne = isMulti && unresolvedContract.shouldAnswersSumToOne.\n  - If sumsToOne is true: metricsQuery should select only per-answer rows for the contract: `select data from user_contract_metrics where contract_id = $1 and answer_id is not null`.\n  - Else if isMulti is true (independent MC): metricsQuery should select rows where answer_id equals $2 (the passed answerId) OR select summary rows (answer_id is null) only if a row exists for that contract and that answer id. Use the exists subquery exactly as in the diff. Do not include unrelated metrics.\n  - Else (non-multi): metricsQuery remains `select data from user_contract_metrics where contract_id = $1`.\n- Replace the prior inline metrics SQL in the pg.multi call with the new ${metricsQuery} string. Keep the parameter list [contractId, answerId] and existing handling of answers and contract_liquidity unchanged.\n\n3) Update backend/shared/src/resolve-market-helpers.ts\n- Add a TODO comment just after creating the Supabase client: `// TODO: Why not add this to front of bet queue?` per the diff.\n- In the transaction block, remove the destructuring of outcomeType from unresolvedContract where closeTime and id are extracted; only keep closeTime and id.\n- After retrieving the latest contract, compute a boolean isIndieMC = c.mechanism === 'cpmm-multi-1' && !c.shouldAnswersSumToOne.\n- When recalculating metrics post-resolution, change the call to calculateUpdatedMetricsForContracts to pass isIndieMC as the second argument: calculateUpdatedMetricsForContracts([{ contract: resolvedContract, metrics: contractMetrics }], isIndieMC).\n\nScope and compatibility notes:\n- Do not alter other call sites of calculateUpdatedMetricsForContracts; the new parameter must default to false to preserve behavior.\n- Do not edit any schema or types; use existing Contract, MarketContract, ContractMetric, and isSummary utilities.\n- Preserve all existing logic for payouts, updates, and notifications; only tighten the metrics query and summary recomputation as specified.",
      "prompt": "Improve market resolution performance and correctness by narrowing which user metrics are processed. For multiple-choice markets, only load the necessary per-answer metrics and, when needed, include each user’s summary metric without double-counting. Add an optional flag to the metrics recomputation routine so it can reuse an included summary row safely. Then have the resolution helper detect independent multiple choice markets and enable this behavior. Leave all other code paths intact and make sure existing callers continue to work without modification.",
      "supplementalFiles": [
        "common/src/contract.ts",
        "common/src/contract-metric.ts",
        "backend/api/src/get-user-contract-metrics-with-contracts.ts",
        "backend/shared/src/update-user-portfolio-histories-core.ts",
        "mani/hooks/use-saved-contract-metrics.ts",
        "web/hooks/use-saved-contract-metrics.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/shared/src/resolve-market-helpers.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/resolve-market-helpers.ts\n===================================================================\n--- backend/shared/src/resolve-market-helpers.ts\t9604428 (parent)\n+++ backend/shared/src/resolve-market-helpers.ts\td311fbd (commit)\n@@ -71,16 +71,17 @@\n   { value, resolutions, probabilityInt, outcome, answerId }: ResolutionParams\n ) => {\n   const pg = createSupabaseDirectClient()\n \n+  // TODO: Why not add this to front of bet queue?\n   const {\n     resolvedContract,\n     updatedContractMetrics,\n     payoutsWithoutLoans,\n     updatedContractAttrs,\n     userUpdates,\n   } = await pg.tx({ mode: SERIAL_MODE }, async (tx) => {\n-    const { closeTime, id: contractId, outcomeType } = unresolvedContract\n+    const { closeTime, id: contractId } = unresolvedContract\n     const {\n       contract: c,\n       liquidities,\n       contractMetrics,\n@@ -88,8 +89,9 @@\n       tx,\n       unresolvedContract,\n       answerId\n     )\n+    const isIndieMC = c.mechanism === 'cpmm-multi-1' && !c.shouldAnswersSumToOne\n \n     unresolvedContract = c as MarketContract\n     if (unresolvedContract.isResolved) {\n       throw new APIError(403, 'Contract is already resolved')\n@@ -252,11 +254,12 @@\n         })\n       )\n       await updateAnswers(tx, contractId, answerUpdates)\n     }\n-    const { metricsByContract } = calculateUpdatedMetricsForContracts([\n-      { contract: resolvedContract, metrics: contractMetrics },\n-    ])\n+    const { metricsByContract } = calculateUpdatedMetricsForContracts(\n+      [{ contract: resolvedContract, metrics: contractMetrics }],\n+      isIndieMC\n+    )\n     const updatedContractMetrics = metricsByContract[resolvedContract.id] ?? []\n     const updateMetricsQuery = bulkUpdateContractMetricsQuery(\n       updatedContractMetrics\n     )\n"
        },
        {
          "path": "backend/shared/src/utils.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/utils.ts\n===================================================================\n--- backend/shared/src/utils.ts\t9604428 (parent)\n+++ backend/shared/src/utils.ts\td311fbd (commit)\n@@ -147,19 +147,35 @@\n   answerId: string | undefined\n ) => {\n   const { id: contractId, mechanism } = unresolvedContract\n   const isMulti = mechanism === 'cpmm-multi-1'\n+  const sumsToOne = isMulti && unresolvedContract.shouldAnswersSumToOne\n+  const metricsQuery = sumsToOne\n+    ? `\n+     select data from user_contract_metrics \n+     where contract_id = $1 and\n+     answer_id is not null`\n+    : isMulti\n+    ? `\n+    select data from user_contract_metrics \n+      where contract_id = $1\n+      and (answer_id = $2 or (\n+            -- Only get summary metric if they've bet on the answer\n+            answer_id is null and\n+            exists (\n+              select 1 from user_contract_metrics ucm\n+              where ucm.contract_id = $1\n+              and ucm.answer_id = $2\n+              )\n+            )\n+          )`\n+    : `select data from user_contract_metrics where contract_id = $1`\n   // Filter out initial liquidity if set up with special liquidity per answer.\n   const filterAnte = isMulti && isSpecialLoveContract(unresolvedContract)\n   const results = await pg.multi(\n     `select ${contractColumnsToSelect} from contracts where id = $1;\n      select * from answers where contract_id = $1 order by index;\n-     select data from user_contract_metrics \n-     where contract_id = $1 and\n-     ${isMulti ? 'answer_id is not null and' : ''}\n-     ($2 is null or exists (select 1 from user_contract_metrics ucm\n-      where ucm.contract_id = $1\n-      and ucm.answer_id = $2));\n+     ${metricsQuery};\n      select * from contract_liquidity where contract_id = $1 ${\n        filterAnte ? `and data->>'answerId' = $2` : ''\n      };`,\n     [contractId, answerId]\n"
        },
        {
          "path": "common/src/calculate-metrics.ts",
          "status": "modified",
          "diff": "Index: common/src/calculate-metrics.ts\n===================================================================\n--- common/src/calculate-metrics.ts\t9604428 (parent)\n+++ common/src/calculate-metrics.ts\td311fbd (commit)\n@@ -496,9 +496,10 @@\n export const calculateUpdatedMetricsForContracts = (\n   contractsWithMetrics: {\n     contract: Contract\n     metrics: ContractMetric[]\n-  }[]\n+  }[],\n+  useIncludedSummaryMetric = false\n ) => {\n   const metricsByContract: Dictionary<Omit<ContractMetric, 'id'>[]> = {}\n \n   for (const { contract, metrics } of contractsWithMetrics) {\n@@ -519,8 +520,11 @@\n           return metric\n             ? [calculateProfitMetricsAtProbOrCancel(state, metric)]\n             : []\n         } else if (contract.mechanism === 'cpmm-multi-1') {\n+          const oldSummary = useIncludedSummaryMetric\n+            ? userMetrics.find(isSummary)\n+            : undefined\n           // For multiple choice markets, update each answer's metrics and compute summary per user\n           const answerMetrics = userMetrics.filter((m) => !isSummary(m))\n \n           const updatedAnswerMetrics = answerMetrics.map((m) => {\n@@ -534,15 +538,24 @@\n                   ? 1\n                   : answer.resolution === 'NO'\n                   ? 0\n                   : answer.prob\n+\n+              if (oldSummary) {\n+                // Subtract the old stats from the old summary metric\n+                applyMetricToSummary(m, oldSummary, false)\n+              }\n               return calculateProfitMetricsAtProbOrCancel(state, m)\n             }\n             return m\n           })\n \n-          // Calculate summary metrics for this user\n-          const summaryMetric = getDefaultMetric(userId, contractId, null)\n+          const defaultMetric = getDefaultMetric(userId, contractId, null)\n+          const summaryMetric =\n+            (useIncludedSummaryMetric\n+              ? userMetrics.find(isSummary)\n+              : defaultMetric) ?? defaultMetric\n+\n           updatedAnswerMetrics.forEach((m) =>\n             applyMetricToSummary(m, summaryMetric, true)\n           )\n \n"
        }
      ]
    },
    {
      "id": "indie-mc-resolution",
      "sha": "0316bb81bfcf9ab9f3f92c3c49703f56d7f9ab3b",
      "parentSha": "7eb20fcc6dfcd742b51b53d33ad7d9639955b8cd",
      "spec": "Implement a new independent multiple-choice resolution flow and integrate it into the app.\n\nScope\n- Files to change:\n  - web/components/answers/answer-resolve-panel.tsx\n  - web/components/contract/contract-overview.tsx\n  - web/components/contract/contract-table-action.tsx\n  - web/components/widgets/amount-input.tsx\n\n1) Update answers/answer-resolve-panel.tsx\n- Imports\n  - Remove MiniResolutionPanel from the imports in this file where it is no longer used in independent resolution flow.\n  - Add imports:\n    - YesNoCancelSelector from ../bet/yes-no-selector\n    - resolution type from common/contract\n    - usePersistentInMemoryState from client-common/hooks/use-persistent-in-memory-state\n- AnswersResolvePanel behavior for non-sum-to-one\n  - In AnswersResolvePanel, when contract.shouldAnswersSumToOne is false, replace the existing message with a simple, non-blocking placeholder: `wrong resolution panel` styled with text-ink-500.\n- IndependentAnswersResolvePanel enhancements\n  - Update component signature to accept a new prop: show: boolean. If show is false, the component must return null but retain in-memory state (this avoids janky behavior when clearing state after submission).\n  - Manage the following persistent, in-memory state:\n    - selectedResolutions: { [answerId: string]: resolution } (keyed by answer id)\n    - completedResolutions: string[] (list of answer ids successfully resolved in this session)\n    - resolutionProbs: { [answerId: string]: number | undefined } (probability for MKT resolutions; store as integer percent)\n    - isShowingConfirmation: boolean (toggles showing the review/confirmation step)\n    - isSubmitting: boolean (submission-in-progress state)\n    - error: string | undefined (for submission or validation errors)\n  - At the top of the panel (under ResolveHeader), display a status row showing count of currently selected answers for resolution and a Review & Submit button:\n    - Copy: “X answer(s) selected for resolution” where X is selectedCount.\n    - Button: Review & Submit; disabled when no answers are selected. Clicking it shows the confirmation screen.\n  - Resolve list: For each answer (sorted by resolution and then by prob/index matching existing sorting), render:\n    - If answer.resolution exists, render a read-only AnswerBar showing status (AnswerStatus) and no controls.\n    - If unresolved:\n      - Show the AnswerBar (status, creator avatar/label if applicable) and to the right display the currently selected resolution (YES/NO/CANCEL/MKT and, for MKT, the percentage) if chosen.\n      - Below the bar, provide controls:\n        - YesNoCancelSelector to set selected resolution for this answer. Selecting MKT should default the percentage to the current probability rounded to an integer percent if not already set.\n        - If MKT is selected, show an AmountInput labeled “%” allowing the user to input an integer percent (store in resolutionProbs[answerId]). The input must allow clearing to undefined.\n        - Show a small gray Remove button to clear any selected resolution for this answer.\n  - Confirmation screen:\n    - When isShowingConfirmation is true, replace the panel content with a review list of selected resolutions. Show for each:\n      - Answer text\n      - Resolution chosen (YES/NO/CANCEL/MKT), and if MKT then also the chosen percent (e.g., “MKT 42%”).\n      - A per-answer status indicator: “✓ Completed” for completed ones, and a “Processing…” pulse indicator for the one currently waiting during submission.\n    - Inline error area (text-scarlet-500) for validation or submission errors.\n    - Buttons:\n      - Back (gray) to return to the selection UI when not submitting and not fully completed.\n      - Submit All Resolutions (indigo) to begin sequential submission when not submitting and not fully completed. If some resolutions already completed, label the button “Continue Resolving”.\n      - While processing, show a disabled loading button labeled “Processing…”.\n      - Once all have completed, show a green Done button that clears the stored resolution state and calls onClose.\n  - Submission logic:\n    - On submit, process selectedResolutions sequentially in stable order (Object.entries iteration is sufficient).\n    - Skip any answerId already in completedResolutions.\n    - If a selected outcome is MKT but resolutionProbs[answerId] is missing, set an error with a message identifying the missing probability by answer text and stop processing.\n    - For each answer:\n      - Call api('market/:contractId/resolve', { contractId: contract.id, outcome, answerId, probabilityInt: resolutionProbs[answerId] if MKT })\n      - On success, append the answerId to completedResolutions.\n      - On failure, set an error (use APIError.message if available; otherwise a generic error) and stop processing.\n    - Always reset isSubmitting at the end.\n  - Done action:\n    - Clear selectedResolutions, completedResolutions, resolutionProbs, set isShowingConfirmation to false, and call onClose.\n\n2) Update contract/contract-overview.tsx\n- For ChoiceOverview (MULTIPLE_CHOICE):\n  - When contract.mechanism === 'cpmm-multi-1' and shouldAnswersSumToOne is false, always mount the IndependentAnswersResolvePanel inside a GradientContainer and pass show={showResolver}. If showResolver is false, the component should render null but keep state.\n  - Otherwise, when showResolver is true, mount AnswersResolvePanel inside a GradientContainer as before.\n  - When showResolver is false, render resolutionRating and AnswersPanel as usual.\n- For MultiNumericOverview (MULTI_NUMERIC):\n  - Make the same conditional rendering change as above: mount IndependentAnswersResolvePanel when !shouldAnswersSumToOne and mechanism === 'cpmm-multi-1' with show={showResolver}; otherwise render AnswersResolvePanel when showResolver is true; when showResolver is false, render the default content.\n\n3) Update contract/contract-table-action.tsx\n- Imports\n  - Change the import of answers panel to import both AnswersResolvePanel and IndependentAnswersResolvePanel from ../answers/answer-resolve-panel.\n- SmallResolutionPanel modal routing\n  - If outcomeType === 'MULTIPLE_CHOICE' and !contract.shouldAnswersSumToOne, render IndependentAnswersResolvePanel with show={true} within the modal. Keep other branches intact for BINARY, PSEUDO_NUMERIC, and standard MULTIPLE_CHOICE.\n\n4) Update widgets/amount-input.tsx\n- Adjust the label position styling by removing the -mt-0.5 class from the label span to improve vertical centering. The label’s class should be: `text-ink-400 absolute top-1/2 my-auto ml-2 -translate-y-1/2`.\n\nBehavioral expectations\n- Independent multiple-choice markets (shouldAnswersSumToOne === false) should allow selecting YES/NO/CANCEL/MKT per answer, optionally setting a percent for MKT, reviewing the pending selections, and submitting them sequentially via the resolve API.\n- The independent resolver should maintain its selection state while hidden (show=false) and only clear after completing and pressing Done (or when explicitly removed per answer).\n- The old sum-to-one AnswersResolvePanel should not handle independent markets; it should show a placeholder text for the unsupported case as specified.\n- The resolver mounting in contract-overview and contract-table-action should reflect the new independent flow as described.",
      "prompt": "Add an independent multiple-choice resolution flow for non-sum-to-one markets. Provide a per-answer UI to pick YES, NO, CANCEL, or a partial (MKT) resolution with a percent, allow users to review all selections, and submit them in sequence with clear progress and error handling. Integrate this flow in the contract overview and the small modal trigger so that independent markets always use the new flow and keep selection state while hidden. Ensure the standard sum-to-one flow still works for ordinary multiple-choice markets, and polish the amount input label alignment.",
      "supplementalFiles": [
        "web/components/resolution-panel.tsx",
        "web/components/bet/yes-no-selector.tsx",
        "web/lib/api/api.ts",
        "web/hooks/use-persistent-local-state.ts",
        "common/src/contract.ts"
      ],
      "fileDiffs": [
        {
          "path": "web/components/answers/answer-resolve-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/answers/answer-resolve-panel.tsx\n===================================================================\n--- web/components/answers/answer-resolve-panel.tsx\t7eb20fc (parent)\n+++ web/components/answers/answer-resolve-panel.tsx\t0316bb8 (commit)\n@@ -13,13 +13,9 @@\n import { useUser } from 'web/hooks/use-user'\n import { Answer, OTHER_TOOLTIP_TEXT } from 'common/answer'\n import { getAnswerProbability } from 'common/calculate'\n import { useDisplayUserByIdOrAnswer } from 'web/hooks/use-user-supabase'\n-import {\n-  MiniResolutionPanel,\n-  ResolutionExplainer,\n-  ResolveHeader,\n-} from '../resolution-panel'\n+import { ResolutionExplainer, ResolveHeader } from '../resolution-panel'\n import { InfoTooltip } from '../widgets/info-tooltip'\n import {\n   AnswerBar,\n   CreatorAndAnswerLabel,\n@@ -29,8 +25,11 @@\n } from './answer-components'\n import { useAdmin } from 'web/hooks/use-admin'\n import { AmountInput } from '../widgets/amount-input'\n import { getAnswerColor } from '../charts/contract/choice'\n+import { YesNoCancelSelector } from '../bet/yes-no-selector'\n+import { resolution } from 'common/contract'\n+import { usePersistentInMemoryState } from 'client-common/hooks/use-persistent-in-memory-state'\n \n function getAnswerResolveButtonColor(\n   resolveOption: string | undefined,\n   answers: string[],\n@@ -274,11 +273,9 @@\n         onClose={onClose}\n         fullTitle={!inModal}\n       />\n       {!contract.shouldAnswersSumToOne ? (\n-        <div className=\"text-scarlet-500\">\n-          Independent multiple choice markets cannot currently be resolved.\n-        </div>\n+        <div className=\"text-ink-500\">wrong resolution panel</div>\n       ) : (\n         <>\n           <AnswersResolveOptions\n             contract={contract}\n@@ -406,10 +403,12 @@\n \n export const IndependentAnswersResolvePanel = (props: {\n   contract: MultiContract\n   onClose: () => void\n+  // If you remove this, the hiding after clearing the resolutions will be janky\n+  show: boolean\n }) => {\n-  const { contract, onClose } = props\n+  const { contract, onClose, show } = props\n \n   const isAdmin = useAdmin()\n   const user = useUser()\n \n@@ -419,23 +418,286 @@\n     (a) => (a.resolution ? -a.subsidyPool : -Infinity),\n     (a) => (addAnswersMode === 'ANYONE' ? -1 * a.prob : a.index)\n   )\n \n+  // Track resolutions for batch submission\n+  const [selectedResolutions, setSelectedResolutions] =\n+    usePersistentInMemoryState<{\n+      [answerId: string]: resolution\n+    }>({}, 'selectedResolutions')\n+  const [isShowingConfirmation, setIsShowingConfirmation] = useState(false)\n+  const [isSubmitting, setIsSubmitting] = useState(false)\n+  const [error, setError] = useState<string | undefined>(undefined)\n+  const [completedResolutions, setCompletedResolutions] =\n+    usePersistentInMemoryState<string[]>([], 'completedResolutions')\n+  const [resolutionProbs, setResolutionProbs] = usePersistentInMemoryState<{\n+    [answerId: string]: number | undefined\n+  }>({}, 'resolutionProbs')\n+\n+  const handleSelectResolution = (answerId: string, resolution: resolution) => {\n+    setSelectedResolutions((prev) => ({\n+      ...prev,\n+      [answerId]: resolution,\n+    }))\n+\n+    // Reset probability if not MKT\n+    if (resolution !== 'MKT') {\n+      setResolutionProbs((prev) => {\n+        const updated = { ...prev }\n+        delete updated[answerId]\n+        return updated\n+      })\n+    }\n+  }\n+\n+  const handleRemoveResolution = (answerId: string) => {\n+    setSelectedResolutions((prev) => {\n+      const updated = { ...prev }\n+      delete updated[answerId]\n+      return updated\n+    })\n+\n+    // Also remove probability if exists\n+    setResolutionProbs((prev) => {\n+      const updated = { ...prev }\n+      delete updated[answerId]\n+      return updated\n+    })\n+  }\n+\n+  const handleSetResolutionProb = (answerId: string, prob?: number) => {\n+    setResolutionProbs((prev) => ({\n+      ...prev,\n+      [answerId]: prob, // Default to 50% if undefined\n+    }))\n+  }\n+\n+  const selectedCount = Object.keys(selectedResolutions).length\n+\n+  const submitBatchResolutions = async () => {\n+    setIsSubmitting(true)\n+    setError(undefined)\n+\n+    try {\n+      // Process resolutions sequentially\n+      for (const [answerId, outcome] of Object.entries(selectedResolutions)) {\n+        // Skip already resolved answers\n+        if (completedResolutions.includes(answerId)) {\n+          continue\n+        }\n+        if (outcome === 'MKT') {\n+          if (!resolutionProbs[answerId]) {\n+            setError(\n+              `Please set a probability for ${\n+                answers.find((a) => a.id === answerId)?.text\n+              }`\n+            )\n+            break\n+          }\n+        }\n+        try {\n+          await api('market/:contractId/resolve', {\n+            contractId: contract.id,\n+            outcome,\n+            answerId,\n+            probabilityInt:\n+              outcome === 'MKT' ? resolutionProbs[answerId] : undefined,\n+          })\n+\n+          // Mark this resolution as completed\n+          setCompletedResolutions((prev) => [...prev, answerId])\n+        } catch (e) {\n+          setError(\n+            `Error resolving answer: ${\n+              e instanceof APIError ? e.message : 'Unknown error'\n+            }`\n+          )\n+          break\n+        }\n+      }\n+    } catch (e) {\n+      if (e instanceof APIError) {\n+        setError(e.message)\n+      } else {\n+        console.error(e)\n+        setError('Error resolving answers')\n+      }\n+    } finally {\n+      setIsSubmitting(false)\n+    }\n+  }\n+\n+  const handleDone = () => {\n+    // Clear all resolution state\n+    setSelectedResolutions({})\n+    setCompletedResolutions([])\n+    setResolutionProbs({})\n+    setIsShowingConfirmation(false)\n+\n+    // Close the panel\n+    onClose()\n+  }\n+  if (!show) return null\n+\n+  if (isShowingConfirmation) {\n+    const allResolutionIds = Object.keys(selectedResolutions)\n+    const isProcessing = isSubmitting\n+    const hasCompletedAll =\n+      !isSubmitting &&\n+      completedResolutions.length === allResolutionIds.length &&\n+      allResolutionIds.length > 0\n+\n+    // Calculate remaining answers to resolve\n+    const remainingAnswers = allResolutionIds.filter(\n+      (id) => !completedResolutions.includes(id)\n+    )\n+    const hasPartiallyCompleted =\n+      completedResolutions.length > 0 && remainingAnswers.length > 0\n+\n+    return (\n+      <Col className=\"gap-3\">\n+        <div className=\"text-lg font-semibold\">\n+          {!isProcessing && !hasCompletedAll && !hasPartiallyCompleted\n+            ? 'Confirm Resolution'\n+            : !isProcessing && hasPartiallyCompleted\n+            ? 'Continue Resolution'\n+            : isProcessing\n+            ? 'Processing Resolutions...'\n+            : 'Resolutions Complete'}\n+        </div>\n+\n+        <div>\n+          {!isProcessing && !hasCompletedAll && !hasPartiallyCompleted\n+            ? 'You are about to resolve the following answers:'\n+            : !isProcessing && hasPartiallyCompleted\n+            ? `${completedResolutions.length} answer(s) resolved. Continue with remaining ${remainingAnswers.length}`\n+            : isProcessing\n+            ? 'Processing your selected resolutions:'\n+            : 'All resolutions have been processed successfully:'}\n+        </div>\n+\n+        <div className=\"border-ink-200 max-h-60 overflow-y-auto rounded border p-2\">\n+          {Object.entries(selectedResolutions).map(([answerId, resolution]) => {\n+            const answer = answers.find((a) => a.id === answerId)\n+            if (!answer) return null\n+\n+            const isCompleted = completedResolutions.includes(answerId)\n+            const isCurrentlyProcessing =\n+              isSubmitting &&\n+              !isCompleted &&\n+              completedResolutions.length === allResolutionIds.indexOf(answerId)\n+\n+            return (\n+              <div\n+                key={answerId}\n+                className=\"border-ink-100 flex items-center justify-between border-b py-2 last:border-0\"\n+              >\n+                <div className=\"font-medium\">{answer.text}</div>\n+                <Row className=\"items-center gap-2\">\n+                  <div\n+                    className={clsx(\n+                      'font-semibold',\n+                      resolution === 'YES'\n+                        ? 'text-green-500'\n+                        : resolution === 'NO'\n+                        ? 'text-red-500'\n+                        : resolution === 'CANCEL'\n+                        ? 'text-yellow-500'\n+                        : 'text-blue-500'\n+                    )}\n+                  >\n+                    {resolution}\n+                    {resolution === 'MKT' &&\n+                      resolutionProbs[answerId] &&\n+                      ` ${resolutionProbs[answerId]}%`}\n+                  </div>\n+\n+                  {isCompleted && (\n+                    <div className=\"ml-2 text-sm font-medium text-green-500\">\n+                      ✓ Completed\n+                    </div>\n+                  )}\n+\n+                  {isCurrentlyProcessing && (\n+                    <div className=\"text-ink-500 ml-2 animate-pulse text-sm font-medium\">\n+                      Processing...\n+                    </div>\n+                  )}\n+                </Row>\n+              </div>\n+            )\n+          })}\n+        </div>\n+        {error && <div className=\"text-scarlet-500 p-3\">{error}</div>}\n+        <Row className=\"justify-end gap-3\">\n+          {!isSubmitting && !hasCompletedAll && (\n+            <Button\n+              color=\"gray\"\n+              onClick={() => setIsShowingConfirmation(false)}\n+            >\n+              Back\n+            </Button>\n+          )}\n+\n+          {!isSubmitting && !hasCompletedAll && (\n+            <Button color=\"indigo\" onClick={submitBatchResolutions}>\n+              {hasPartiallyCompleted\n+                ? 'Continue Resolving'\n+                : 'Submit All Resolutions'}\n+            </Button>\n+          )}\n+\n+          {hasCompletedAll && (\n+            <Button color=\"green\" onClick={handleDone}>\n+              Done\n+            </Button>\n+          )}\n+\n+          {isProcessing && (\n+            <Button color=\"indigo\" disabled loading>\n+              Processing...\n+            </Button>\n+          )}\n+        </Row>\n+      </Col>\n+    )\n+  }\n+\n   return (\n     <Col className=\"gap-3\">\n       <ResolveHeader\n         contract={contract}\n         isCreator={user?.id === contract.creatorId}\n         onClose={onClose}\n       />\n+\n+      <Row className=\"bg-primary-50 items-center justify-between rounded p-3\">\n+        <div>\n+          <span className=\"font-medium\">{selectedCount}</span> answer\n+          {selectedCount !== 1 ? 's' : ''} selected for resolution\n+        </div>\n+        <Button\n+          color=\"indigo\"\n+          disabled={selectedCount === 0}\n+          onClick={() => setIsShowingConfirmation(true)}\n+        >\n+          Review & Submit\n+        </Button>\n+      </Row>\n+\n       <Col className=\"gap-2\">\n         {sortedAnswers.map((answer) => (\n           <IndependentResolutionAnswerItem\n             key={answer.id}\n             contract={contract}\n             answer={answer}\n             color={getAnswerColor(answer)}\n             isAdmin={isAdmin}\n+            selectedResolution={selectedResolutions[answer.id]}\n+            resolutionProb={resolutionProbs[answer.id]}\n+            onSelectResolution={handleSelectResolution}\n+            onRemoveResolution={handleRemoveResolution}\n+            onSetResolutionProb={handleSetResolutionProb}\n           />\n         ))}\n       </Col>\n       <ResolutionExplainer independentMulti />\n@@ -447,18 +709,87 @@\n   contract: MultiContract\n   answer: Answer\n   color: string\n   isAdmin: boolean\n+  selectedResolution?: resolution\n+  resolutionProb?: number\n+  onSelectResolution: (answerId: string, resolution: resolution) => void\n+  onRemoveResolution: (answerId: string) => void\n+  onSetResolutionProb: (answerId: string, prob?: number) => void\n }) {\n-  const { contract, answer, color, isAdmin } = props\n+  const {\n+    contract,\n+    answer,\n+    color,\n+    isAdmin,\n+    selectedResolution,\n+    resolutionProb,\n+    onSelectResolution,\n+    onRemoveResolution,\n+    onSetResolutionProb,\n+  } = props\n+\n   const answerCreator = useDisplayUserByIdOrAnswer(answer)\n   const user = useUser()\n   const isCreator = user?.id === contract.creatorId\n \n   const prob = getAnswerProbability(contract, answer.id)\n \n   const addAnswersMode = contract.addAnswersMode ?? 'DISABLED'\n \n+  // Skip already resolved answers\n+  if (answer.resolution) {\n+    return (\n+      <Col>\n+        <AnswerBar\n+          color={color}\n+          prob={prob}\n+          label={\n+            <Row className={'items-center gap-1'}>\n+              <AnswerStatus contract={contract} answer={answer} />\n+              {answer.isOther ? (\n+                <span>\n+                  Other{' '}\n+                  <InfoTooltip\n+                    className=\"!text-ink-600\"\n+                    text={OTHER_TOOLTIP_TEXT}\n+                  />\n+                </span>\n+              ) : (\n+                <CreatorAndAnswerLabel\n+                  text={answer.text}\n+                  createdTime={answer.createdTime}\n+                  creator={\n+                    addAnswersMode === 'ANYONE'\n+                      ? answerCreator ?? false\n+                      : undefined\n+                  }\n+                  className={clsx(\n+                    'items-center text-sm !leading-none sm:text-base'\n+                  )}\n+                />\n+              )}\n+            </Row>\n+          }\n+          end={null}\n+        />\n+      </Col>\n+    )\n+  }\n+\n+  const handleOutcomeSelect = (outcome: resolution | undefined) => {\n+    if (!outcome) {\n+      onRemoveResolution(answer.id)\n+    } else {\n+      onSelectResolution(answer.id, outcome)\n+\n+      // Set default probability if MKT selected\n+      if (outcome === 'MKT' && !resolutionProb) {\n+        onSetResolutionProb(answer.id, Math.round(prob * 100))\n+      }\n+    }\n+  }\n+\n   return (\n     <Col>\n       <AnswerBar\n         color={color}\n@@ -489,20 +820,68 @@\n               />\n             )}\n           </Row>\n         }\n-        end={null}\n+        end={\n+          selectedResolution ? (\n+            <div\n+              className={clsx(\n+                'text-sm font-semibold',\n+                selectedResolution === 'YES'\n+                  ? 'text-green-500'\n+                  : selectedResolution === 'NO'\n+                  ? 'text-red-500'\n+                  : selectedResolution === 'CANCEL'\n+                  ? 'text-yellow-500'\n+                  : 'text-blue-500'\n+              )}\n+            >\n+              {selectedResolution}\n+              {selectedResolution === 'MKT' &&\n+                resolutionProb &&\n+                ` ${resolutionProb}%`}\n+            </div>\n+          ) : null\n+        }\n       />\n-      {!answer.resolution && (\n-        <>\n-          <MiniResolutionPanel\n-            contract={contract}\n-            answer={answer}\n-            isAdmin={isAdmin}\n-            isCreator={isCreator}\n+      <div className=\"mt-2\">\n+        <Row className=\"flex-wrap gap-4\">\n+          {isAdmin && !isCreator && (\n+            <div className=\"bg-scarlet-50 text-scarlet-500 self-start rounded p-1 text-xs\">\n+              ADMIN\n+            </div>\n+          )}\n+          <YesNoCancelSelector\n+            selected={selectedResolution as resolution | undefined}\n+            onSelect={handleOutcomeSelect}\n           />\n-          <hr className=\"border-ink-300 mb-2 mt-4\" />\n-        </>\n-      )}\n+\n+          {selectedResolution === 'MKT' && (\n+            <Row className=\"items-center gap-2\">\n+              <span className=\"text-ink-500 text-sm\">Resolve to</span>\n+              <AmountInput\n+                inputClassName=\"w-20 h-9\"\n+                label=\"%\"\n+                amount={resolutionProb ? Math.round(resolutionProb) : undefined}\n+                onChangeAmount={(value) =>\n+                  onSetResolutionProb(answer.id, value ? value : undefined)\n+                }\n+                disableClearButton\n+              />\n+            </Row>\n+          )}\n+\n+          {selectedResolution && (\n+            <Button\n+              color=\"gray\"\n+              size=\"xs\"\n+              onClick={() => onRemoveResolution(answer.id)}\n+            >\n+              Remove\n+            </Button>\n+          )}\n+        </Row>\n+      </div>\n+      <hr className=\"border-ink-300 mb-2 mt-4\" />\n     </Col>\n   )\n }\n"
        },
        {
          "path": "web/components/contract/contract-overview.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-overview.tsx\n===================================================================\n--- web/components/contract/contract-overview.tsx\t7eb20fc (parent)\n+++ web/components/contract/contract-overview.tsx\t0316bb8 (commit)\n@@ -399,9 +399,8 @@\n             </Row>\n           </>\n         )}\n       </Row>\n-\n       {contract.mechanism == 'cpmm-multi-1' && !hideGraph && (\n         <SizedContainer\n           className={clsx(\n             'h-[150px] w-full pb-4 pr-10 sm:h-[250px]',\n@@ -445,25 +444,25 @@\n           hoveredAnnotation={hoveredAnnotation}\n           setHoveredAnnotation={setHoveredAnnotation}\n         />\n       ) : null}\n-      {showResolver ? (\n-        !shouldAnswersSumToOne && contract.mechanism === 'cpmm-multi-1' ? (\n-          <GradientContainer>\n-            <IndependentAnswersResolvePanel\n-              contract={contract}\n-              onClose={() => setShowResolver(false)}\n-            />\n-          </GradientContainer>\n-        ) : (\n-          <GradientContainer>\n-            <AnswersResolvePanel\n-              contract={contract as CPMMMultiContract}\n-              onClose={() => setShowResolver(false)}\n-            />\n-          </GradientContainer>\n-        )\n-      ) : (\n+      {!shouldAnswersSumToOne && contract.mechanism === 'cpmm-multi-1' ? (\n+        <GradientContainer>\n+          <IndependentAnswersResolvePanel\n+            contract={contract}\n+            onClose={() => setShowResolver(false)}\n+            show={showResolver}\n+          />\n+        </GradientContainer>\n+      ) : showResolver ? (\n+        <GradientContainer>\n+          <AnswersResolvePanel\n+            contract={contract as CPMMMultiContract}\n+            onClose={() => setShowResolver(false)}\n+          />\n+        </GradientContainer>\n+      ) : null}\n+      {!showResolver && (\n         <>\n           {resolutionRating}\n           <AnswersPanel\n             setDefaultAnswerIdsToGraph={setDefaultAnswerIdsToGraph}\n@@ -700,25 +699,25 @@\n             showZoomer={showZoomer}\n           />\n         )}\n       </SizedContainer>\n-      {showResolver ? (\n-        !shouldAnswersSumToOne && contract.mechanism === 'cpmm-multi-1' ? (\n-          <GradientContainer>\n-            <IndependentAnswersResolvePanel\n-              contract={contract}\n-              onClose={() => setShowResolver(false)}\n-            />\n-          </GradientContainer>\n-        ) : (\n-          <GradientContainer>\n-            <AnswersResolvePanel\n-              contract={contract}\n-              onClose={() => setShowResolver(false)}\n-            />\n-          </GradientContainer>\n-        )\n-      ) : (\n+      {!shouldAnswersSumToOne && contract.mechanism === 'cpmm-multi-1' ? (\n+        <GradientContainer>\n+          <IndependentAnswersResolvePanel\n+            show={showResolver}\n+            contract={contract}\n+            onClose={() => setShowResolver(false)}\n+          />\n+        </GradientContainer>\n+      ) : showResolver ? (\n+        <GradientContainer>\n+          <AnswersResolvePanel\n+            contract={contract}\n+            onClose={() => setShowResolver(false)}\n+          />\n+        </GradientContainer>\n+      ) : null}\n+      {!showResolver && (\n         <>\n           {resolutionRating}\n           <AnswersPanel\n             hideSearch\n"
        },
        {
          "path": "web/components/contract/contract-table-action.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-table-action.tsx\n===================================================================\n--- web/components/contract/contract-table-action.tsx\t7eb20fc (parent)\n+++ web/components/contract/contract-table-action.tsx\t0316bb8 (commit)\n@@ -8,9 +8,12 @@\n import { Row } from '../layout/row'\n import { NumericResolutionPanel } from '../numeric-resolution-panel'\n import { ResolutionPanel } from '../resolution-panel'\n import { isClosed } from './contracts-table'\n-import { AnswersResolvePanel } from '../answers/answer-resolve-panel'\n+import {\n+  AnswersResolvePanel,\n+  IndependentAnswersResolvePanel,\n+} from '../answers/answer-resolve-panel'\n import { useUser } from 'web/hooks/use-user'\n import { track } from 'web/lib/service/analytics'\n import { PollPanel } from '../poll/poll-panel'\n import { TRADE_TERM } from 'common/envs/constants'\n@@ -189,8 +192,14 @@\n       contract={contract}\n       onClose={() => setOpen(false)}\n       inModal\n     />\n+  ) : outcomeType === 'MULTIPLE_CHOICE' && !contract.shouldAnswersSumToOne ? (\n+    <IndependentAnswersResolvePanel\n+      contract={contract as CPMMMultiContract}\n+      onClose={() => setOpen(false)}\n+      show={true}\n+    />\n   ) : outcomeType === 'MULTIPLE_CHOICE' ? (\n     <AnswersResolvePanel\n       contract={contract as CPMMMultiContract}\n       onClose={() => setOpen(false)}\n"
        },
        {
          "path": "web/components/widgets/amount-input.tsx",
          "status": "modified",
          "diff": "Index: web/components/widgets/amount-input.tsx\n===================================================================\n--- web/components/widgets/amount-input.tsx\t7eb20fc (parent)\n+++ web/components/widgets/amount-input.tsx\t0316bb8 (commit)\n@@ -94,9 +94,9 @@\n   return (\n     <Col className={clsx('relative', className)}>\n       <label className=\"font-sm md:font-lg relative\">\n         {label && (\n-          <span className=\"text-ink-400 absolute top-1/2 my-auto -mt-0.5 ml-2 -translate-y-1/2\">\n+          <span className=\"text-ink-400 absolute top-1/2 my-auto ml-2 -translate-y-1/2\">\n             {label}\n           </span>\n         )}\n         <Row>\n"
        }
      ]
    },
    {
      "id": "add-market-movements",
      "sha": "4e9cf04f3cbfa1a2c86e6ccf2c74f71249618935",
      "parentSha": "4100b9549cf07179a96ec391f76eb889313c2ad4",
      "spec": "Implement market movement notifications across backend, database, shared logic, user preferences, scheduler, and web UI.\n\nScope and behavior\n- Detect notable market probability movements for eligible contracts and answers within a recent window and notify interested users who have not recently interacted.\n- Only send browser notifications for now (email and push are out of scope), but respect per-user notification preferences and global opt-outs.\n- Persist a record of each notification candidate to a new table to deduplicate across time and destinations.\n- Group these notifications in the UI, render an appropriate message and icon, and include them in notification settings with a description and defaults.\n\nBackend detection and notification\n- Create a shared function to compute movements and deliver notifications:\n  - Add a new module to compute movements over two windows: previous window (start = now - 24h, end = now - 2h) and current window (start = now - 2h, end = now).\n  - Load unresolved contracts updated recently (last_bet_time within the current window), created at least 24h ago, and their answers if any.\n  - For cpmm-1 markets: compute the time-weighted average probability in both windows; compare and select changes with absolute delta > 0.1.\n  - For sum-to-one multiple-choice cpmm-multi-1 markets: compute time-weighted averages per answer; select the single answer with the largest absolute delta > 0.1.\n  - Order detected movements by contract importance score and process the top changes.\n  - Identify interested users per contract: followers, holders with shares, or contract creators; restrict to users whose notification preferences include at least one destination for “market_movements” and who are not fully opted out across all channels; require an email on file.\n  - Exclude users who have viewed the contract page or placed a bet on the contract in the current window.\n  - Deduplicate: for each user/contract(/answer), skip if a movement notification was recently recorded (within 24h) with the same direction and a similar magnitude (difference in magnitude < 0.1).\n  - Record each notification to a new movement records table with contract_id, user_id, optional answer_id, prev_val/new_val values, prev/new window start times, and destination (browser).\n  - Create browser notifications with reason = \"market_movements\" for the collected users, including data fields: val_start, val_end, val_start_time, val_end_time, and answerText when applicable. Insert notifications in bulk.\n  - Support a debug mode that limits recipients to a test user.\n\nDatabase changes\n- Create a new table contract_movement_notifications with columns:\n  - id (identity primary key), contract_id (text, FK contracts.id), answer_id (text, nullable), created_time (timestamp with time zone, default now), user_id (text, FK users.id), prev_val (numeric), new_val (numeric), prev_val_start_time (timestamp with time zone), new_val_start_time (timestamp with time zone), destination (text: mobile|browser|email).\n  - Enable row-level security and create an index on (contract_id, user_id, created_time desc).\n- Update the shared Supabase client schema types to include the new table with Row/Insert/Update and relationships.\n\nUser preferences and descriptions\n- Add a new notification preference key \"market_movements\" with default destinations enabled (email, browser, mobile).\n- Extend NOTIFICATION_DESCRIPTIONS with a simple and detailed description for market_movements.\n- Ensure update-notif-settings API updates the JSON preference array for any type/medium combination and still toggles the interestedInPushNotifications flag when opt_out_all/mobile is changed; broadcast updated private user after updates.\n\nScheduler and test script\n- Register a new hourly job (run at the 12th minute of each hour) that calls the movement computation function with debug disabled.\n- Add a script that can be run manually to trigger movement processing in debug mode.\n\nShared logic updates\n- Where probability time-series are keyed, normalize keys to either contract.id for binary markets or contract.id + answer.id for multiple-choice answers; update code that reads historical probabilities accordingly.\n\nWeb UI integration\n- Notification grouping and icon badge counts:\n  - Treat market_movements as a type that groups by day rather than per contract when aggregating for the bell icon.\n  - In general notifications grouping, add market_movements to a distinct grouping bucket and ensure these notifications are always grouped rather than expanded as a single item.\n- Notification item rendering:\n  - Add a new UI component to render market_movements notifications with:\n    - Title linking to the market.\n    - Display of the probability change (e.g., “20% → 35%”) and the answer text when present.\n    - An up or down trend icon based on direction, with appropriate color accents.\n- Notification page header strings:\n  - For groups of market_movements, display a summary like “N recent notable market movement(s)”.\n  - Replace hand-rolled pluralization in existing headers with a helper where used by this change.\n- Add the new preference to the web notification settings UI in appropriate sections for Email and Mobile Push and in the Updates section list.\n\nConstraints\n- Only browser notifications are sent at this time; email and mobile push generation may be commented or omitted but the preference and movement records schema must support their future use.\n- The movement threshold and windows are as specified above.\n- The implementation must maintain existing behavior for unrelated notification types.\n",
      "prompt": "Add a new cross-platform “market movement notifications” feature.\n\nGoal: Notify users when a market they follow, hold shares in, or created has a notable probability movement over the last couple of hours, while avoiding spamming users who are actively engaged or who have already received a similar notification recently.\n\nRequirements:\n- Create a periodic job that computes recent market/answer probability changes and selects notable movements.\n- For binary and multi-choice sum-to-one markets, compare the recent window vs a prior window, and pick movements above a threshold. Sort by importance and cap volume.\n- Determine interested recipients per market (followers, holders, creators), filter out users who recently viewed or bet on that market, and respect their notification preferences and global opt-outs. Only send browser notifications now.\n- Persist movement records for deduplication across time and mediums.\n- Deliver browser notifications carrying start/end probabilities, timestamps, and answer text when relevant.\n- Extend the notification settings to include “Market movements” with sensible defaults and descriptions.\n- Render a new notification type with appropriate iconography and grouping, and adjust grouping behavior so these are grouped by day and summarized clearly.\n- Provide a simple script to run the computation in debug mode for testing.\n\nKeep the solution cohesive with current notification infrastructure, database access patterns, and UI conventions. Do not send emails or mobile push yet, but prepare schema and preferences to support them later.",
      "supplementalFiles": [
        "backend/shared/src/utils.ts",
        "backend/shared/src/supabase/init.ts",
        "backend/shared/src/supabase/utils.ts",
        "common/src/supabase/contracts.ts",
        "common/src/supabase/utils.ts",
        "common/src/contract.ts",
        "common/src/answer.ts",
        "common/src/user.ts",
        "web/components/notifications/notification-helpers.tsx"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/update-notif-settings.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/update-notif-settings.ts\n===================================================================\n--- backend/api/src/update-notif-settings.ts\t4100b95 (parent)\n+++ backend/api/src/update-notif-settings.ts\t4e9cf04 (commit)\n@@ -11,18 +11,16 @@\n   if (type === 'opt_out_all' && medium === 'mobile') {\n     await updatePrivateUser(pg, auth.uid, {\n       interestedInPushNotifications: !enabled,\n     })\n-  } else {\n-    // deep update array at data.notificationPreferences[type]\n-    await pg.none(\n-      `update private_users\n+  }\n+  await pg.none(\n+    `update private_users\n       set data = jsonb_set(data, '{notificationPreferences, $1:raw}',\n         coalesce(data->'notificationPreferences'->$1, '[]'::jsonb)\n         ${enabled ? `|| '[$2:name]'::jsonb` : `- $2`}\n       )\n       where id = $3`,\n-      [type, medium, auth.uid]\n-    )\n-    broadcastUpdatedPrivateUser(auth.uid)\n-  }\n+    [type, medium, auth.uid]\n+  )\n+  broadcastUpdatedPrivateUser(auth.uid)\n }\n"
        },
        {
          "path": "backend/scheduler/src/jobs/index.ts",
          "status": "modified",
          "diff": "Index: backend/scheduler/src/jobs/index.ts\n===================================================================\n--- backend/scheduler/src/jobs/index.ts\t4100b95 (parent)\n+++ backend/scheduler/src/jobs/index.ts\t4e9cf04 (commit)\n@@ -34,11 +34,10 @@\n   resetDailyQuestStatsInternal,\n   resetWeeklyQuestStatsInternal,\n } from './reset-quests-stats'\n import { updateUserPortfolioHistoriesCore } from 'shared/update-user-portfolio-histories-core'\n-import { ENV } from 'common/envs/constants'\n import { isProd } from 'shared/utils'\n-\n+import { sendContractMovementNotifications } from 'shared/send-contract-movement-notifications'\n export function createJobs() {\n   return [\n     // Hourly jobs:\n     createJob(\n@@ -71,8 +70,13 @@\n       '0 15 * * * *', // on the 15th minute of every hour\n       checkPushNotificationReceipts\n     ),\n     createJob(\n+      'send-contract-movement-notifications',\n+      '0 12 * * * *', // on the 12th minute of every hour\n+      () => sendContractMovementNotifications(false)\n+    ),\n+    createJob(\n       'calculate-conversion-scores',\n       '0 46 * * * *', // on the 46th minute of every hour\n       calculateConversionScore\n     ),\n"
        },
        {
          "path": "backend/scripts/test-market-movements.ts",
          "status": "added",
          "diff": "Index: backend/scripts/test-market-movements.ts\n===================================================================\n--- backend/scripts/test-market-movements.ts\t4100b95 (parent)\n+++ backend/scripts/test-market-movements.ts\t4e9cf04 (commit)\n@@ -0,0 +1,6 @@\n+import { runScript } from 'run-script'\n+import { sendContractMovementNotifications } from 'shared/send-contract-movement-notifications'\n+\n+runScript(async () => {\n+  await sendContractMovementNotifications(true)\n+})\n"
        },
        {
          "path": "backend/shared/src/create-notification.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/create-notification.ts\n===================================================================\n--- backend/shared/src/create-notification.ts\t4100b95 (parent)\n+++ backend/shared/src/create-notification.ts\t4e9cf04 (commit)\n@@ -2103,4 +2103,135 @@\n \n   const pg = createSupabaseDirectClient()\n   await insertNotificationToSupabase(notification, pg)\n }\n+\n+export const createMarketMovementNotification = async (\n+  params: Array<{\n+    contract: Contract\n+    privateUser: PrivateUser\n+    beforeProb: number\n+    afterProb: number\n+    beforeTime: Date\n+    afterTime: Date\n+    answer?: Answer\n+  }>\n+) => {\n+  const pg = createSupabaseDirectClient()\n+\n+  // Arrays to collect bulk notifications\n+  const bulkNotifications: Notification[] = []\n+  // const bulkEmails: [PrivateUser, Notification, string, string][] = []\n+  // const bulkPushNotifications: [PrivateUser, Notification, string, string][] =\n+  //   []\n+\n+  // Process each notification parameter set\n+  for (const {\n+    contract,\n+    privateUser,\n+    beforeProb,\n+    afterProb,\n+    beforeTime,\n+    afterTime,\n+    answer,\n+  } of params) {\n+    // Skip if user blocked the creator\n+    if (userIsBlocked(privateUser, contract.creatorId)) continue\n+\n+    // Check notification preferences\n+    const { sendToBrowser } = getNotificationDestinationsForUser(\n+      privateUser,\n+      'market_movements'\n+    )\n+\n+    if (!sendToBrowser) continue\n+\n+    // Create the notification data\n+    const notificationData = {\n+      val_start: beforeProb,\n+      val_end: afterProb,\n+      val_start_time: beforeTime.toISOString(),\n+      val_end_time: afterTime.toISOString(),\n+      answerText: answer?.text,\n+    }\n+\n+    // Create the notification\n+    const notification: Notification = {\n+      id: crypto.randomUUID(),\n+      userId: privateUser.id,\n+      reason: 'market_movements',\n+      createdTime: Date.now(),\n+      isSeen: false,\n+      sourceId: contract.id,\n+      sourceType: 'contract',\n+      sourceContractId: contract.id,\n+      sourceUserName: contract.creatorName,\n+      sourceUserUsername: contract.creatorUsername,\n+      sourceUserAvatarUrl: contract.creatorAvatarUrl ?? '',\n+      sourceText: answer?.text ?? contract.question,\n+      sourceContractCreatorUsername: contract.creatorUsername,\n+      sourceContractTitle: contract.question,\n+      sourceContractSlug: contract.slug,\n+      sourceSlug: contract.slug,\n+      sourceTitle: contract.question,\n+      data: notificationData,\n+    }\n+\n+    if (sendToBrowser) {\n+      bulkNotifications.push(notification)\n+    }\n+\n+    // if (sendToEmail) {\n+    //   const subject = `Market Update: ${contract.question}`\n+    //   const probChange = Math.abs(afterProb - beforeProb) * 100\n+    //   const direction = afterProb > beforeProb ? 'rose' : 'fell'\n+    //   const body = answer?.text\n+    //     ? `The answer \"${answer.text}\" ${direction} from ${Math.round(\n+    //         beforeProb * 100\n+    //       )}% to ${Math.round(afterProb * 100)}% (a ${Math.round(\n+    //         probChange\n+    //       )}% change)`\n+    //     : `The probability ${direction} from ${Math.round(\n+    //         beforeProb * 100\n+    //       )}% to ${Math.round(afterProb * 100)}% (a ${Math.round(\n+    //         probChange\n+    //       )}% change)`\n+\n+    //   bulkEmails.push([privateUser, notification, subject, body])\n+    // }\n+\n+    // if (sendToMobile) {\n+    //   const title = `${contract.question.substring(0, 50)}${\n+    //     contract.question.length > 50 ? '...' : ''\n+    //   }`\n+    //   const probChange = Math.abs(afterProb - beforeProb) * 100\n+    //   const direction = afterProb > beforeProb ? 'rose' : 'fell'\n+    //   const body = answer?.text\n+    //     ? `The answer \"${answer.text}\" ${direction} to ${Math.round(\n+    //         afterProb * 100\n+    //       )}% (${Math.round(probChange)}% change)`\n+    //     : `The probability ${direction} to ${Math.round(\n+    //         afterProb * 100\n+    //       )}% (${Math.round(probChange)}% change)`\n+\n+    //   bulkPushNotifications.push([privateUser, notification, title, body])\n+    // }\n+  }\n+\n+  // Send the notifications in bulk\n+  if (bulkNotifications.length > 0) {\n+    await bulkInsertNotifications(bulkNotifications, pg)\n+  }\n+\n+  // Handle bulk emails (commented out in original code)\n+  // if (bulkEmails.length > 0) {\n+  //   // Would need to be updated to handle bulk emails\n+  //   // await sendMarketMovementEmails(bulkEmails)\n+  // }\n+\n+  // Handle bulk push notifications (commented out in original code)\n+  // if (bulkPushNotifications.length > 0) {\n+  //   await createPushNotifications(bulkPushNotifications)\n+  // }\n+\n+  return bulkNotifications\n+}\n"
        },
        {
          "path": "backend/shared/src/send-contract-movement-notifications.ts",
          "status": "added",
          "diff": "Index: backend/shared/src/send-contract-movement-notifications.ts\n===================================================================\n--- backend/shared/src/send-contract-movement-notifications.ts\t4100b95 (parent)\n+++ backend/shared/src/send-contract-movement-notifications.ts\t4e9cf04 (commit)\n@@ -0,0 +1,525 @@\n+import { convertAnswer, convertContract } from 'common/supabase/contracts'\n+import { createSupabaseDirectClient } from './supabase/init'\n+import { contractColumnsToSelect, log } from './utils'\n+import { HOUR_MS } from 'common/util/time'\n+import { orderBy } from 'lodash'\n+import { Contract } from 'common/contract'\n+import { Answer } from 'common/answer'\n+import { PrivateUser } from 'common/user'\n+import { getNotificationDestinationsForUser } from 'common/user-notification-preferences'\n+import { createMarketMovementNotification } from './create-notification'\n+import { Row } from 'common/supabase/utils'\n+import { SupabaseDirectClient } from './supabase/init'\n+import { bulkInsert } from 'shared/supabase/utils'\n+\n+const probThreshold = 0.1\n+const pastPeriodHoursAgoStart = 24\n+const nowPeriodHoursAgoStart = 2\n+const TEST_USER_ID = 'AJwLWoo3xue32XIiAVrL5SyR1WB2'\n+\n+export async function sendContractMovementNotifications(debug = false) {\n+  const pg = createSupabaseDirectClient()\n+  const now = Date.now()\n+  const nowStart = now - nowPeriodHoursAgoStart * HOUR_MS\n+  const nowEnd = now\n+  const where = `\n+    where c.last_bet_time > now() - interval '${nowPeriodHoursAgoStart} hours'     \n+    and c.resolution_time is null\n+    and c.created_time < now() - interval '${pastPeriodHoursAgoStart} hours'`\n+  const results = await pg.multi(\n+    `\n+    select ${contractColumnsToSelect} from contracts c ${where};\n+    select * from answers a\n+    where a.contract_id in (select id from contracts c ${where})\n+    and a.created_time < now() - interval '${pastPeriodHoursAgoStart} hours';\n+    `,\n+    []\n+  )\n+  const allContracts = results[0].map(convertContract)\n+  const sumToOneContractIds = allContracts\n+    .filter((c) => c.mechanism === 'cpmm-multi-1' && c.shouldAnswersSumToOne)\n+    .map((c) => c.id)\n+  const answers = results[1].map(convertAnswer)\n+  for (const contract of allContracts) {\n+    if ('answers' in contract) {\n+      contract.answers = answers.filter((a) => a.contractId === contract.id)\n+    }\n+  }\n+  log(`Loaded ${allContracts.length} contracts.`)\n+  log(`Loaded ${answers.length} answers.`)\n+  const contractIds = allContracts.map((c) => c.id)\n+\n+  const pastStart = now - HOUR_MS * pastPeriodHoursAgoStart\n+  const pastEnd = now - HOUR_MS * nowPeriodHoursAgoStart\n+\n+  // Get probabilities for both current and historical windows in parallel\n+  const [currentTimeProbs, timeAgoProbs] = await Promise.all([\n+    getAverageBetProbs(pg, nowStart, nowEnd, contractIds, sumToOneContractIds),\n+    getAverageBetProbs(\n+      pg,\n+      pastStart,\n+      pastEnd,\n+      contractIds,\n+      sumToOneContractIds\n+    ),\n+  ])\n+\n+  const probChanges: {\n+    contract: Contract\n+    answer?: Answer\n+    before: number\n+    after: number\n+  }[] = []\n+\n+  for (const contract of allContracts) {\n+    if (contract.mechanism === 'cpmm-1') {\n+      const { id, prob } = contract\n+      const timeAgoProb = timeAgoProbs[id]\n+      if (!timeAgoProb) continue\n+      const currentProb = currentTimeProbs[id] ?? prob\n+      const probChange = Math.abs(currentProb - timeAgoProb)\n+      if (probChange > probThreshold) {\n+        probChanges.push({\n+          contract,\n+          before: timeAgoProb,\n+          after: currentProb,\n+        })\n+      }\n+    } else if (\n+      contract.mechanism === 'cpmm-multi-1' &&\n+      contract.shouldAnswersSumToOne\n+    ) {\n+      const { answers: contractAnswers } = contract\n+      let maxChange = probThreshold\n+      let maxChangedAnswer = null\n+      let before = 0\n+      let after = 0\n+\n+      for (const answer of contractAnswers) {\n+        const { prob, resolutionTime } = answer\n+        if (resolutionTime) continue\n+        const key = contract.id + answer.id\n+        const timeAgoProb = timeAgoProbs[key]\n+        if (!timeAgoProb) continue\n+        const currentProb = currentTimeProbs[key] ?? prob\n+        const probChange = Math.abs(currentProb - timeAgoProb)\n+\n+        if (probChange > maxChange) {\n+          maxChange = probChange\n+          maxChangedAnswer = answer\n+          before = timeAgoProb\n+          after = currentProb\n+        }\n+      }\n+\n+      if (maxChangedAnswer) {\n+        probChanges.push({\n+          contract,\n+          answer: maxChangedAnswer,\n+          before,\n+          after,\n+        })\n+      }\n+    }\n+  }\n+\n+  const orderedProbChanges = orderBy(\n+    probChanges,\n+    (pc) => pc.contract.importanceScore,\n+    'desc'\n+  )\n+  console.log(`There are ${orderedProbChanges.length} prob changes`)\n+  const topProbChanges = orderedProbChanges.slice(0, 100)\n+  for (const pc of topProbChanges) {\n+    const { contract, answer, before, after } = pc\n+    console.log(\n+      `${contract.slug} ${answer?.text ?? ''} has moved ${before.toFixed(\n+        2\n+      )} -> ${after.toFixed(2)}`\n+    )\n+  }\n+\n+  // Create market movement notifications for interested users\n+  await createMarketMovementNotifications(\n+    pg,\n+    orderedProbChanges,\n+    now,\n+    pastStart,\n+    debug\n+  )\n+}\n+type UserWithContractId = PrivateUser & {\n+  name: string\n+  contractId: string\n+}\n+\n+type MovementRecord = Omit<\n+  Row<'contract_movement_notifications'>,\n+  'id' | 'created_time'\n+>\n+\n+async function createMarketMovementNotifications(\n+  pg: ReturnType<typeof createSupabaseDirectClient>,\n+  probChanges: {\n+    contract: Contract\n+    answer?: Answer\n+    before: number\n+    after: number\n+  }[],\n+  currentPeriodStart: number,\n+  previousPeriodStart: number,\n+  debug = false\n+) {\n+  if (probChanges.length === 0) return\n+\n+  const movementRecords: MovementRecord[] = []\n+  const contractIds = probChanges.map((pc) => pc.contract.id)\n+  const allInterestedUsers = (\n+    await pg.map(\n+      `\n+        SELECT DISTINCT on (u.id, coalesce(cf.contract_id, ucm.contract_id, c.id))\n+        pu.data, u.name, coalesce(cf.contract_id, ucm.contract_id, c.id) as contract_id\n+        from private_users pu\n+         join users u on pu.id = u.id\n+         LEFT JOIN contract_follows cf ON cf.follow_id = u.id AND cf.contract_id = ANY($1)\n+         LEFT JOIN user_contract_metrics ucm ON ucm.user_id = u.id AND ucm.contract_id = ANY($1)\n+         left join contracts c on c.creator_id = u.id and c.id = ANY($1)\n+        where (pu.data->'notificationPreferences'->>'market_movements')::jsonb ?| array['email', 'browser', 'mobile']\n+        and NOT ((pu.data->'notificationPreferences'->>'opt_out_all')::jsonb @> '[\"email\"]'\n+              AND (pu.data->'notificationPreferences'->>'opt_out_all')::jsonb @> '[\"browser\"]'\n+              AND (pu.data->'notificationPreferences'->>'opt_out_all')::jsonb @> '[\"mobile\"]')\n+        and pu.data->>'email' is not null\n+        and (cf.contract_id IS NOT NULL OR (ucm.contract_id is not null and ucm.has_shares)\n+        or c.creator_id = u.id);\n+      `,\n+      [contractIds],\n+      (r) =>\n+        ({\n+          ...(r.data as PrivateUser),\n+          name: r.name as string,\n+          contractId: r.contract_id as string,\n+        } as UserWithContractId)\n+    )\n+  ).filter((u) => (debug ? u.id === TEST_USER_ID : true))\n+  log(`Found ${allInterestedUsers.length} interested users`)\n+\n+  // Get existing recent movement notifications for these contracts and users\n+  // to avoid sending duplicate notifications for similar probability movements\n+  const userIds = allInterestedUsers.map((user) => user.id)\n+  const results = await pg.multi(\n+    `\n+    SELECT *\n+    FROM contract_movement_notifications\n+    WHERE \n+      contract_id = ANY($1) \n+      AND user_id = ANY($2)\n+      AND created_time > now() - interval '${pastPeriodHoursAgoStart} hours';\n+    \n+    SELECT\n+      contract_id,\n+      user_id\n+    FROM user_contract_views\n+    WHERE \n+      contract_id = ANY($1) \n+      AND user_id = ANY($2)\n+      AND last_page_view_ts > now() - interval '${nowPeriodHoursAgoStart} hours';\n+    \n+    SELECT distinct\n+      contract_id,\n+      user_id\n+    FROM contract_bets\n+    WHERE \n+      contract_id = ANY($1) \n+      AND user_id = ANY($2)\n+      AND created_time > now() - interval '${nowPeriodHoursAgoStart} hours';\n+    `,\n+    [contractIds, userIds]\n+  )\n+\n+  const recentMovementNotifications = results[0] as MovementRecord[]\n+  const recentContractPageViews = results[1].map((r) => ({\n+    contractId: r.contract_id,\n+    userId: r.user_id,\n+  }))\n+  const recentContractBets = results[2].map((r) => ({\n+    contractId: r.contract_id,\n+    userId: r.user_id,\n+  }))\n+\n+  // Collection of notification parameters for bulk processing\n+  const notificationParams: Array<{\n+    contract: Contract\n+    privateUser: PrivateUser\n+    beforeProb: number\n+    afterProb: number\n+    beforeTime: Date\n+    afterTime: Date\n+    answer?: Answer\n+  }> = []\n+\n+  for (const { contract, answer, before, after } of probChanges) {\n+    // Get users who are watching this market or have shares in it\n+    const usersInterestedInContract = allInterestedUsers\n+      .filter((u) => u.contractId === contract.id)\n+      .filter(\n+        (u) =>\n+          !recentContractPageViews.find(\n+            (rpv) => rpv.contractId === contract.id && rpv.userId === u.id\n+          ) &&\n+          !recentContractBets.find(\n+            (rb) => rb.contractId === contract.id && rb.userId === u.id\n+          )\n+      )\n+    log(\n+      `Found ${usersInterestedInContract.length} interested users for contract ${contract.slug}`\n+    )\n+\n+    // Create records and notifications\n+    for (const user of usersInterestedInContract) {\n+      // Check user notification preferences\n+      const { sendToBrowser } = getNotificationDestinationsForUser(\n+        user,\n+        'market_movements'\n+      )\n+\n+      if (!sendToBrowser) continue\n+\n+      // Check if a similar notification has already been sent\n+      const existingNotifications = recentMovementNotifications.filter(\n+        (notification) =>\n+          notification.user_id === user.id &&\n+          notification.contract_id === contract.id &&\n+          notification.answer_id == (answer?.id ?? null)\n+      )\n+\n+      // Skip if we have a similar notification already\n+      // We consider a notification similar if:\n+      // 1. It's for the same user, contract, and answer\n+      // 2. The probability movement is in the same direction (both increasing or both decreasing)\n+      // 3. The probability movement is of similar magnitude (within 0.1)\n+      const skipNotification = existingNotifications.some((notification) => {\n+        const existingDirection = notification.new_val > notification.prev_val\n+        const newDirection = after > before\n+        const similarDirection = existingDirection === newDirection\n+\n+        const existingMagnitude = Math.abs(\n+          notification.new_val - notification.prev_val\n+        )\n+        const newMagnitude = Math.abs(after - before)\n+        const similarMagnitude =\n+          Math.abs(existingMagnitude - newMagnitude) < 0.1\n+\n+        return similarDirection && similarMagnitude\n+      })\n+\n+      if (skipNotification) {\n+        continue\n+      }\n+\n+      try {\n+        const destinations = []\n+        if (sendToBrowser) destinations.push('browser')\n+\n+        for (const destination of destinations) {\n+          const record: MovementRecord = {\n+            contract_id: contract.id,\n+            answer_id: answer?.id ?? null,\n+            user_id: user.id,\n+            new_val: after,\n+            new_val_start_time: new Date(currentPeriodStart).toISOString(),\n+            prev_val: before,\n+            prev_val_start_time: new Date(previousPeriodStart).toISOString(),\n+            destination,\n+          }\n+          movementRecords.push(record)\n+        }\n+        log(\n+          `Created ${destinations.length} movement records for contract ${contract.slug} and user ${user.id}`\n+        )\n+\n+        // If browser notifications are enabled, collect the notification parameters for bulk processing\n+        if (sendToBrowser) {\n+          notificationParams.push({\n+            contract,\n+            privateUser: user,\n+            beforeProb: before,\n+            afterProb: after,\n+            beforeTime: new Date(previousPeriodStart),\n+            afterTime: new Date(currentPeriodStart),\n+            answer,\n+          })\n+        }\n+      } catch (e) {\n+        log.error(`Error creating notification for user ${user.id}: ${e}`)\n+      }\n+    }\n+  }\n+\n+  // Insert movement records in bulk\n+  if (movementRecords.length > 0) {\n+    try {\n+      await bulkInsert(pg, 'contract_movement_notifications', movementRecords)\n+      log(\n+        `Added ${movementRecords.length} contract movement notification records for tracking`\n+      )\n+      if (notificationParams.length > 0) {\n+        log(`Sending ${notificationParams.length} notifications in bulk`)\n+        const notifications = await createMarketMovementNotification(\n+          notificationParams\n+        )\n+        log(`Created ${notifications.length} notifications`)\n+      }\n+    } catch (e) {\n+      log.error(`Error adding contract movement notification records: ${e}`)\n+    }\n+  }\n+}\n+\n+/**\n+ * Gets the time-weighted average probability for markets within a specific time window.\n+ * Weights probabilities by how long they lasted in the window.\n+ */\n+const getAverageBetProbs = async (\n+  pg: SupabaseDirectClient,\n+  startTime: number,\n+  endTime: number,\n+  contractIds: string[],\n+  sumToOneContractIds: string[]\n+) => {\n+  return Object.fromEntries(\n+    await pg.map(\n+      `\n+      WITH \n+      -- Get all bets in the window plus the last bet before the window \n+      all_relevant_bets AS (\n+        (\n+          -- Last bet before the window (for initial probability)\n+          SELECT DISTINCT ON (contract_id, answer_id)\n+            contract_id,\n+            answer_id,\n+            prob_after,\n+            created_time,\n+            millis_to_ts($1) as effective_end_time,  -- It's effective until the window starts\n+            'pre_window' as bet_position\n+          FROM contract_bets\n+          WHERE \n+            created_time < millis_to_ts($1)\n+            AND contract_id = ANY($3)\n+            AND (NOT is_redemption OR contract_id = ANY($4))\n+          ORDER BY contract_id, answer_id, created_time DESC\n+        )\n+        UNION ALL\n+        (\n+          -- All bets within the window\n+          SELECT\n+            contract_id,\n+            answer_id,\n+            prob_after,\n+            created_time,\n+            created_time as effective_end_time, -- Will be overwritten in next step\n+            'in_window' as bet_position\n+          FROM contract_bets\n+          WHERE \n+            created_time BETWEEN millis_to_ts($1) AND millis_to_ts($2)\n+            AND contract_id = ANY($3)\n+            AND (NOT is_redemption OR contract_id = ANY($4))\n+          ORDER BY contract_id, answer_id, created_time\n+        )\n+      ),\n+      -- Calculate the effective duration of each probability\n+      bets_with_duration AS (\n+        SELECT\n+          contract_id,\n+          answer_id,\n+          prob_after,\n+          created_time,\n+          bet_position,\n+          -- Calculate the end time for this probability (when the next bet happens or window ends)\n+          LEAD(created_time, 1, millis_to_ts($2)) OVER (\n+            PARTITION BY contract_id, answer_id \n+            ORDER BY created_time\n+          ) as next_bet_time,\n+          -- Calculate how long this probability lasted within the window\n+          CASE\n+            -- For the pre-window bet, only count time from window start to next bet (if any in window)\n+            WHEN bet_position = 'pre_window' THEN\n+              EXTRACT(EPOCH FROM (\n+                LEAST(\n+                  LEAD(created_time, 1, millis_to_ts($2)) OVER (PARTITION BY contract_id, answer_id ORDER BY created_time),\n+                  millis_to_ts($2)\n+                ) - millis_to_ts($1)\n+              ))\n+            -- For in-window bets, count from bet time to next bet or window end\n+            ELSE\n+              EXTRACT(EPOCH FROM (\n+                LEAST(\n+                  LEAD(created_time, 1, millis_to_ts($2)) OVER (PARTITION BY contract_id, answer_id ORDER BY created_time),\n+                  millis_to_ts($2)\n+                ) - created_time\n+              ))\n+          END as duration_seconds\n+        FROM all_relevant_bets\n+      ),\n+      -- Mark records that should be included in weighted average\n+      filtered_bets AS (\n+        SELECT\n+          contract_id,\n+          answer_id,\n+          prob_after,\n+          duration_seconds,\n+          -- Flag records with positive duration and either in-window or pre-window with influence\n+          CASE\n+            WHEN duration_seconds > 0 AND bet_position = 'in_window' THEN true\n+            WHEN duration_seconds > 0 AND bet_position = 'pre_window' THEN true\n+            ELSE false\n+          END as include_in_avg\n+        FROM bets_with_duration\n+      ),\n+      -- Calculate weighted average for each contract/answer\n+      weighted_averages AS (\n+        SELECT\n+          contract_id,\n+          answer_id,\n+          -- If we have duration data, calculate weighted average\n+          CASE \n+            WHEN SUM(duration_seconds) > 0 THEN \n+              SUM(prob_after * duration_seconds) / SUM(duration_seconds)\n+            ELSE \n+              -- Fallback if no duration (shouldn't happen but just in case)\n+              AVG(prob_after) \n+          END as weighted_avg_prob,\n+          -- Include the total duration for debugging/filtering\n+          SUM(duration_seconds) as total_seconds,\n+          COUNT(*) as bet_count\n+        FROM filtered_bets\n+        WHERE include_in_avg = true\n+        GROUP BY contract_id, answer_id\n+      ),\n+      -- Get the most recent bet before the window as a fallback if nothing was found\n+      fallback_probs AS (\n+        SELECT DISTINCT ON (contract_id, answer_id)\n+          contract_id,\n+          answer_id,\n+          prob_after as prob\n+        FROM contract_bets\n+        WHERE \n+          created_time < millis_to_ts($1)\n+          AND contract_id = ANY($3)\n+          AND (NOT is_redemption OR contract_id = ANY($4))\n+        ORDER BY contract_id, answer_id, created_time DESC\n+      )\n+      -- Combine results, preferring weighted averages when available\n+      SELECT\n+        COALESCE(w.contract_id, f.contract_id) as contract_id,\n+        COALESCE(w.answer_id, f.answer_id) as answer_id,\n+        COALESCE(w.weighted_avg_prob, f.prob) as prob\n+      FROM weighted_averages w\n+      FULL OUTER JOIN fallback_probs f\n+        ON w.contract_id = f.contract_id AND w.answer_id = f.answer_id\n+      WHERE COALESCE(w.weighted_avg_prob, f.prob) IS NOT NULL\n+      `,\n+      [startTime, endTime, contractIds, sumToOneContractIds],\n+      (r) => [r.contract_id + (r.answer_id ?? ''), parseFloat(r.prob as string)]\n+    )\n+  )\n+}\n"
        },
        {
          "path": "backend/shared/src/update-contract-metrics-core.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/update-contract-metrics-core.ts\n===================================================================\n--- backend/shared/src/update-contract-metrics-core.ts\t4100b95 (parent)\n+++ backend/shared/src/update-contract-metrics-core.ts\t4e9cf04 (commit)\n@@ -89,14 +89,14 @@\n \n     for (const contract of contracts) {\n       let cpmmFields: Partial<CPMM> = {}\n       if (contract.mechanism === 'cpmm-1') {\n-        const { poolProb, resProb, resTime } = currentContractProbs[contract.id]\n+        const { id } = contract\n+        const { poolProb, resProb, resTime } = currentContractProbs[id]\n         const prob = resProb ?? poolProb\n-        const key = `${contract.id} _`\n-        const dayAgoProb = dayAgoProbs[key] ?? poolProb\n-        const weekAgoProb = weekAgoProbs[key] ?? poolProb\n-        const monthAgoProb = monthAgoProbs[key] ?? poolProb\n+        const dayAgoProb = dayAgoProbs[id] ?? poolProb\n+        const weekAgoProb = weekAgoProbs[id] ?? poolProb\n+        const monthAgoProb = monthAgoProbs[id] ?? poolProb\n         cpmmFields = {\n           prob,\n           probChanges: {\n             day: resTime && resTime <= dayAgo ? 0 : prob - dayAgoProb,\n@@ -117,9 +117,9 @@\n                   resTime: contract.resolutionTime,\n                 }\n               : currentAnswerProbs[answer.id]\n           const prob = resProb ?? poolProb\n-          const key = `${contract.id} ${answer.id}`\n+          const key = contract.id + answer.id\n           const dayAgoProb = dayAgoProbs[key] ?? poolProb\n           const weekAgoProb = weekAgoProbs[key] ?? poolProb\n           const monthAgoProb = monthAgoProbs[key] ?? poolProb\n           const answerCpmmFields = {\n@@ -269,11 +269,8 @@\n       full outer join probs_before as pb\n         on pa.contract_id = pb.contract_id and pa.answer_id = pb.answer_id\n       `,\n       [when, contractIds, sumToOneContractIds],\n-      (r) => [\n-        `${r.contract_id} ${r.answer_id ?? '_'}`,\n-        parseFloat(r.prob as string),\n-      ]\n+      (r) => [r.contract_id + (r.answer_id ?? ''), parseFloat(r.prob as string)]\n     )\n   )\n }\n"
        },
        {
          "path": "backend/supabase/contract_movement_notifications.sql",
          "status": "added",
          "diff": "Index: backend/supabase/contract_movement_notifications.sql\n===================================================================\n--- backend/supabase/contract_movement_notifications.sql\t4100b95 (parent)\n+++ backend/supabase/contract_movement_notifications.sql\t4e9cf04 (commit)\n@@ -0,0 +1,22 @@\n+create table if not exists\n+  contract_movement_notifications (\n+    id bigint primary key generated always as identity,\n+    contract_id text not null,\n+    answer_id text,\n+    created_time timestamp with time zone default now() not null,\n+    user_id text not null,\n+    prev_val numeric not null,\n+    new_val numeric not null,\n+    prev_val_start_time timestamp with time zone default now() not null,\n+    new_val_start_time timestamp with time zone default now() not null,\n+    destination text not null, -- mobile, browser, email\n+    constraint fk_contract_id foreign key (contract_id) references contracts (id),\n+    constraint fk_user_id foreign key (user_id) references users (id)\n+  );\n+\n+-- Row Level Security\n+alter table contract_movement_notifications enable row level security;\n+\n+drop index if exists contract_notifications_contract_user_created_time_idx;\n+\n+create index contract_notifications_contract_user_created_time_idx on contract_movement_notifications using btree (contract_id, user_id, created_time desc);\n"
        },
        {
          "path": "client-common/src/hooks/use-notifications.ts",
          "status": "modified",
          "diff": "Index: client-common/src/hooks/use-notifications.ts\n===================================================================\n--- client-common/src/hooks/use-notifications.ts\t4100b95 (parent)\n+++ client-common/src/hooks/use-notifications.ts\t4e9cf04 (commit)\n@@ -193,9 +193,10 @@\n   const sortedNotifications = sortBy(notifications, (n) => -n.createdTime)\n   const notificationGroupsByDayOrDayAndContract = groupBy(\n     sortedNotifications,\n     (notification) =>\n-      notification.reason === 'contract_from_followed_user'\n+      notification.reason === 'contract_from_followed_user' ||\n+      notification.reason === 'market_movements'\n         ? new Date(notification.createdTime).toDateString()\n         : new Date(notification.createdTime).toDateString() +\n           notification.sourceContractId +\n           notification.sourceTitle\n@@ -221,8 +222,10 @@\n         : n.sourceType === 'love_ship'\n         ? 'love_ship'\n         : n.data?.isPartner\n         ? 'isPartner'\n+        : n.reason === 'market_movements'\n+        ? 'market_movements'\n         : `${n.sourceTitle}${n.sourceContractId}`)\n   )\n   const mostRecentNotification = first(sortedNotifications)\n   const groupedNotifications = groupNotifications(\n"
        },
        {
          "path": "common/src/notification.ts",
          "status": "modified",
          "diff": "Index: common/src/notification.ts\n===================================================================\n--- common/src/notification.ts\t4100b95 (parent)\n+++ common/src/notification.ts\t4e9cf04 (commit)\n@@ -341,8 +341,13 @@\n   payment_status: {\n     simple: 'Payment updates',\n     detailed: 'Updates on your payment statuses',\n   },\n+  market_movements: {\n+    simple: 'Market movements',\n+    detailed:\n+      'When the probability of a market that you follow changes by a large amount',\n+  },\n }\n \n export type BettingStreakData = {\n   streak: number\n"
        },
        {
          "path": "common/src/supabase/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/supabase/schema.ts\n===================================================================\n--- common/src/supabase/schema.ts\t4100b95 (parent)\n+++ common/src/supabase/schema.ts\t4e9cf04 (commit)\n@@ -459,8 +459,69 @@\n           liquidity_id?: string\n         }\n         Relationships: []\n       }\n+      contract_movement_notifications: {\n+        Row: {\n+          answer_id: string | null\n+          contract_id: string\n+          created_time: string\n+          destination: string\n+          id: number\n+          user_id: string\n+          new_val: number\n+          new_val_start_time: string\n+          prev_val: number\n+          prev_val_start_time: string\n+        }\n+        Insert: {\n+          answer_id?: string | null\n+          contract_id: string\n+          created_time?: string\n+          destination: string\n+          id?: never\n+          user_id: string\n+          new_val: number\n+          new_val_start_time?: string\n+          prev_val: number\n+          prev_val_start_time?: string\n+        }\n+        Update: {\n+          answer_id?: string | null\n+          contract_id?: string\n+          created_time?: string\n+          destination?: string\n+          id?: never\n+          user_id?: string\n+          new_val?: number\n+          new_val_start_time?: string\n+          prev_val?: number\n+          prev_val_start_time?: string\n+        }\n+        Relationships: [\n+          {\n+            foreignKeyName: 'fk_contract_id'\n+            columns: ['contract_id']\n+            isOneToOne: false\n+            referencedRelation: 'contracts'\n+            referencedColumns: ['id']\n+          },\n+          {\n+            foreignKeyName: 'fk_user_id'\n+            columns: ['user_id']\n+            isOneToOne: false\n+            referencedRelation: 'user_referrals_profit'\n+            referencedColumns: ['id']\n+          },\n+          {\n+            foreignKeyName: 'fk_user_id'\n+            columns: ['user_id']\n+            isOneToOne: false\n+            referencedRelation: 'users'\n+            referencedColumns: ['id']\n+          }\n+        ]\n+      }\n       contracts: {\n         Row: {\n           close_time: string | null\n           conversion_score: number\n"
        },
        {
          "path": "common/src/user-notification-preferences.ts",
          "status": "modified",
          "diff": "Index: common/src/user-notification-preferences.ts\n===================================================================\n--- common/src/user-notification-preferences.ts\t4100b95 (parent)\n+++ common/src/user-notification-preferences.ts\t4e9cf04 (commit)\n@@ -33,8 +33,9 @@\n   probability_updates_on_watched_markets: notification_destination_types[]\n   bounty_awarded: notification_destination_types[]\n   bounty_added: notification_destination_types[]\n   bounty_canceled: notification_destination_types[]\n+  market_movements: notification_destination_types[]\n \n   // Balance Changes\n   loan_income: notification_destination_types[]\n   betting_streaks: notification_destination_types[]\n@@ -129,8 +130,9 @@\n     bounty_awarded: constructPref(true, false, false),\n     bounty_added: constructPref(true, false, false),\n     bounty_canceled: constructPref(true, false, false),\n     poll_close_on_watched_markets: constructPref(true, false, false),\n+    market_movements: constructPref(true, true, true),\n \n     // Balance Changes\n     loan_income: constructPref(true, false, false),\n     betting_streaks: constructPref(true, false, true),\n"
        },
        {
          "path": "web/components/notification-settings.tsx",
          "status": "modified",
          "diff": "Index: web/components/notification-settings.tsx\n===================================================================\n--- web/components/notification-settings.tsx\t4100b95 (parent)\n+++ web/components/notification-settings.tsx\t4e9cf04 (commit)\n@@ -66,8 +66,9 @@\n   'opt_out_all',\n   'new_endorsement',\n   'new_match',\n   'new_message',\n+  'market_movements',\n   // TODO: add these\n \n   // 'referral_bonuses',\n   // 'on_new_follow',\n@@ -90,9 +91,9 @@\n   'all_comments_on_my_markets',\n   'all_answers_on_my_markets',\n   'tagged_user',\n   'betting_streaks',\n-\n+  'market_movements',\n   // TODO: add these\n   // 'limit_order_fills',\n   // 'contract_from_followed_user',\n   // 'probability_updates_on_watched_markets',\n@@ -123,8 +124,9 @@\n   label: 'Updates & Resolutions',\n   subscriptionTypes: [\n     'resolutions_on_watched_markets',\n     'resolutions_on_watched_markets_with_shares_in',\n+    'market_movements',\n     'all_votes_on_watched_markets',\n     'poll_close_on_watched_markets',\n     'bounty_canceled',\n   ],\n"
        },
        {
          "path": "web/components/notifications/notification-types.tsx",
          "status": "modified",
          "diff": "Index: web/components/notifications/notification-types.tsx\n===================================================================\n--- web/components/notifications/notification-types.tsx\t4100b95 (parent)\n+++ web/components/notifications/notification-types.tsx\t4e9cf04 (commit)\n@@ -65,8 +65,9 @@\n   NotificationUserLink,\n   PrimaryNotificationLink,\n   QuestionOrGroupLink,\n } from './notification-helpers'\n+import { FaArrowTrendUp, FaArrowTrendDown } from 'react-icons/fa6'\n \n export function NotificationItem(props: {\n   notification: Notification\n   isChildOfGroup?: boolean\n@@ -428,8 +429,17 @@\n         highlighted={highlighted}\n         setHighlighted={setHighlighted}\n       />\n     )\n+  } else if (reason === 'market_movements') {\n+    return (\n+      <MarketMovementNotification\n+        notification={notification}\n+        isChildOfGroup={isChildOfGroup}\n+        highlighted={highlighted}\n+        setHighlighted={setHighlighted}\n+      />\n+    )\n   }\n   return (\n     <NotificationFrame\n       notification={notification}\n@@ -1966,4 +1976,81 @@\n       </span>\n     </NotificationFrame>\n   )\n }\n+\n+function MarketMovementNotification(props: {\n+  notification: Notification\n+  highlighted: boolean\n+  setHighlighted: (highlighted: boolean) => void\n+  isChildOfGroup?: boolean\n+}) {\n+  const { notification, isChildOfGroup, highlighted, setHighlighted } = props\n+  const { sourceContractTitle, data } = notification\n+\n+  const startProb = data?.val_start ?? 0\n+  const endProb = data?.val_end ?? 0\n+  const answerText = data?.answerText\n+\n+  // Calculate the difference and determine if it's an increase or decrease\n+  const probDiff = endProb - startProb\n+  const isIncrease = probDiff > 0\n+\n+  // Format the probabilities as percentages\n+  const startProbText = `${Math.round(startProb * 100)}%`\n+  const endProbText = `${Math.round(endProb * 100)}%`\n+\n+  // Colors and direction text based on movement\n+  // const changeColor = isIncrease ? 'text-teal-600' : 'text-scarlet-600'\n+  const newProbClass = 'text-ink-900 font-semibold'\n+\n+  // Font Awesome trend icons based on direction\n+  const TrendIcon = isIncrease ? FaArrowTrendUp : FaArrowTrendDown\n+  const iconColor = isIncrease ? 'text-teal-500' : 'text-scarlet-500'\n+\n+  // Content to display for different market types\n+  const content = (\n+    <div className=\"flex items-center gap-2\">\n+      <div className=\"flex-grow\">\n+        {answerText ? (\n+          <>\n+            <PrimaryNotificationLink text={sourceContractTitle} />\n+            <br />\n+            <span className=\"font-semibold\">{answerText}</span> moved{' '}\n+            <span className={newProbClass}>\n+              {startProbText} → <span>{endProbText}</span>\n+            </span>{' '}\n+          </>\n+        ) : (\n+          <>\n+            <PrimaryNotificationLink\n+              text={sourceContractTitle}\n+              truncatedLength=\"lg\"\n+            />\n+            <br />\n+            Probability moved{' '}\n+            <span className={newProbClass}>\n+              {startProbText} →<span>{endProbText}</span>\n+            </span>\n+          </>\n+        )}\n+      </div>\n+    </div>\n+  )\n+\n+  return (\n+    <NotificationFrame\n+      notification={notification}\n+      isChildOfGroup={isChildOfGroup}\n+      highlighted={highlighted}\n+      setHighlighted={setHighlighted}\n+      icon={\n+        <div className=\"flex h-full w-full items-center justify-center\">\n+          <TrendIcon className={`${iconColor} h-6 w-6`} />\n+        </div>\n+      }\n+      link={getSourceUrl(notification)}\n+    >\n+      {content}\n+    </NotificationFrame>\n+  )\n+}\n"
        },
        {
          "path": "web/pages/notifications.tsx",
          "status": "modified",
          "diff": "Index: web/pages/notifications.tsx\n===================================================================\n--- web/pages/notifications.tsx\t4100b95 (parent)\n+++ web/pages/notifications.tsx\t4e9cf04 (commit)\n@@ -41,8 +41,9 @@\n } from 'client-common/hooks/use-notifications'\n import { usePersistentLocalState } from 'web/hooks/use-persistent-local-state'\n import { useUnseenPrivateMessageChannels } from 'web/hooks/use-private-messages'\n import { PrivateMessagesList } from '../components/messaging/private-messages-list'\n+import { maybePluralize } from 'common/util/format'\n \n export default function NotificationsPage() {\n   const privateUser = usePrivateUser()\n   const user = useUser()\n@@ -223,13 +224,15 @@\n }) {\n   const { notificationGroups, page, setPage, totalItems } = props\n \n   const grayLine = <div className=\"bg-ink-300 mx-2 box-border h-[1.5px]\" />\n+  const alwaysGroupTypes = ['market_movements']\n   return (\n     <>\n       {notificationGroups.map((notification) => (\n         <Fragment key={notification.groupedById}>\n-          {notification.notifications.length === 1 ? (\n+          {notification.notifications.length === 1 &&\n+          !alwaysGroupTypes.includes(notification.notifications[0].reason) ? (\n             <>\n               <NotificationItem\n                 notification={notification.notifications[0]}\n                 key={notification.notifications[0].id}\n@@ -375,22 +378,27 @@\n           ) : onboardingNotifs ? (\n             <>Welcome to Manifold!</>\n           ) : questNotifs ? (\n             <>\n-              {notifications.length} quest\n-              {notifications.length > 1 ? 's' : ''} completed\n+              {notifications.length}{' '}\n+              {maybePluralize('quest', notifications.length)} completed\n             </>\n+          ) : notifications[0].reason === 'market_movements' ? (\n+            <>\n+              {notifications.length} recent notable market{' '}\n+              {maybePluralize('movement', notifications.length)}\n+            </>\n           ) : sourceTitle || sourceContractTitle ? (\n             <>\n-              {uniques} user{uniques > 1 ? `s` : ``} on{' '}\n+              {uniques} {maybePluralize('user', uniques)} on{' '}\n               <QuestionOrGroupLink\n                 notification={notifications[0]}\n                 truncatedLength={'xl'}\n               />\n             </>\n           ) : (\n             <>\n-              Other activity from {uniques} user{uniques > 1 ? 's' : ''}\n+              Other activity from {uniques} {maybePluralize('user', uniques)}\n             </>\n           )}\n         </ParentNotificationHeader>\n       }\n"
        }
      ]
    },
    {
      "id": "exclude-multipoints",
      "sha": "8bb970e74cafe4c0ce7c4d00b58f733428421805",
      "parentSha": "1fa2964a7590055719e79152504c0ffd5b920ac7",
      "spec": "Implement graph-hiding and multi-answer zoom refactor for multichoice markets and omit multiPoints from static props when the chart is hidden.\n\nScope and required changes\n\n1) Centralize multichoice answer utilities\n- File: common/src/answer.ts\n  - Add and export the following:\n    - const ANSWERS_TO_HIDE_GRAPH = 3\n    - const MAX_DEFAULT_ANSWERS = 20\n    - function getShouldAnswersSumToOne(contract: MultiContract): boolean — returns contract.shouldAnswersSumToOne if present, else true.\n    - function getAllResolved(contract: MultiContract, answers: Answer[]): boolean — true if (shouldAnswersSumToOne && contract.resolutions exists) OR every answer has resolution.\n    - function getSortedAnswers(contract: MultiContract, sortedAnswers: Answer[], sort: MultiSort, selectedAnswerIds?: string[]): Answer[] — filters sortedAnswers based on selectedAnswerIds, allResolved, and sort-specific visibility (hide near-certain answers for prob-asc/desc, hide resolved for liquidity/new/old), then returns first MAX_DEFAULT_ANSWERS.\n  - Note: Keep existing getDefaultSort and sortAnswers; new functions rely on them.\n\n2) Compute and export graph-hide predicate and gate multipoints in static props\n- File: common/src/contract-params.ts\n  - In getContractParams, set multiPoints as follows:\n    - If contract.mechanism === 'cpmm-multi-1' AND getShouldHideGraph(contract) returns false, compute multiPoints via getMultiBetPoints; otherwise, set multiPoints to {}.\n  - Add and export:\n    - function getShouldHideGraph(contract: Contract): boolean — only true for cpmm-multi-1. Determine defaultSort via getDefaultSort(contract), sort answers via sortAnswers, then compute initialAnswers via getSortedAnswers(contract, sortedAnswers, defaultSort). Return initialAnswers.length > ANSWERS_TO_HIDE_GRAPH.\n  - Ensure imports include ANSWERS_TO_HIDE_GRAPH, getDefaultSort, getSortedAnswers, MAX_ANSWERS, sortAnswers from './answer'.\n\n3) Use centralized utilities in answers panel\n- File: web/components/answers/answers-panel.tsx\n  - Replace imports:\n    - Import getAllResolved, getSortedAnswers, getShouldAnswersSumToOne from 'common/answer'.\n    - Remove import of getSortedAnswers from '../contract/contract-overview'.\n  - Remove local implementations of getShouldAnswersSumToOne and getAllResolved.\n  - Remove export const MAX_DEFAULT_ANSWERS; rely on MAX_DEFAULT_ANSWERS inside common getSortedAnswers instead.\n  - Keep MAX_DEFAULT_GRAPHED_ANSWERS as-is; answersToShow should continue to derive from centralized getSortedAnswers when not searching/show-all.\n\n4) Add multi-answer zoom fetch utilities\n- File: web/components/charts/contract/zoom-utils.ts\n  - Add and export:\n    - async function getMultichoicePointsBetween(contract: MultiContract, min?: number, max?: number): Promise<MultiPointsSerialized> — fetch bet points between min/max with getBetPoints (includeZeroShareRedemptions true; filterRedemptions false), then build multi answer points via getMultiBetPoints from common/contract-params.\n    - hook useMultiChoiceDataZoomFetcher({ contract: MultiContract, viewXScale?: ScaleTime, points: MultiPoints }): returns { points, loading }. When zooming, fetch zoomed points per answer via getMultichoicePointsBetween, convert [x,y] to HistoryPoint, merge with original points outside the zoom window, sort by x, and update state.\n  - Ensure imports include MultiPoints from 'common/chart', MultiContract from 'common/contract', and getMultiBetPoints from 'common/contract-params'. Keep existing single-series utilities intact.\n\n5) Update contract overview to use new multi-answer zoom and remove duplicated helpers\n- File: web/components/contract/contract-overview.tsx\n  - Remove local constants/functions related to multichoice answer filtering and graph hiding: ANSWERS_TO_HIDE_GRAPH, getSortedAnswers, getShouldHideGraph.\n  - Import and use useMultiChoiceDataZoomFetcher from '../charts/contract/zoom-utils'.\n  - In ChoiceOverview:\n    - Use useMultiChoiceDataZoomFetcher({ contract, viewXScale: zoomParams?.viewXScale, points: props.points }).\n    - Render a small LoadingIndicator beside the controls when loading is true.\n    - Render the ChoiceContractChart whenever contract.mechanism === 'cpmm-multi-1' and hideGraph is false, without guarding on Object.keys(points).length.\n  - Keep existing behavior for Binary, PseudoNumeric, Number, and Stonk overviews unchanged.\n\n6) Use common getShouldHideGraph in contract page\n- File: web/components/contract/contract-page.tsx\n  - Import getShouldHideGraph from 'common/contract-params' (not from contract-overview).\n  - Compute initialHideGraph with getShouldHideGraph(liveContract) and pass hideGraph/setHideGraph through as before.\n\nObservable behavior requirements\n- For MULTIPLE_CHOICE (cpmm-multi-1) markets:\n  - If the number of initially displayed answers (per centralized getSortedAnswers logic) exceeds ANSWERS_TO_HIDE_GRAPH (3), the chart should be hidden by default on page load and multiPoints should not be included in static props (multiPointsString should serialize an empty object in that case).\n  - When the chart is shown and zoomed, the graph data should dynamically refetch and render a higher-resolution subset between the zoom bounds for each selected answer while preserving points outside the zoom window.\n- The Answers panel should behave identically functionally, but its utilities now come from common/src/answer.ts.\n- The Choice chart should render even when initial points are absent, relying on dynamic fetching when zoomed; a small spinner should appear when fetching zoomed data.\n\nOut of scope\n- Do not change styling beyond the small loading indicator in the chart controls for ChoiceOverview.\n- Do not modify chart tooltips or annotation behavior beyond the data updates.\n",
      "prompt": "Refactor multichoice chart data handling to hide the chart by default when many answers are initially displayed, omit the chart’s multipoints from static props in that case, and add dynamic zoom fetching for multichoice charts. Centralize the multichoice answer utilities so that both the answers panel and the graph-hiding logic share the same behavior. Update the contract overview to use the new zoom hook for multichoice markets and show a small loading spinner while fetching zoomed data. Ensure the contract page uses a shared function to determine the initial hide state of the chart.",
      "supplementalFiles": [
        "common/src/chart.ts",
        "common/src/contract.ts",
        "common/src/bets.ts",
        "web/components/charts/contract/choice.tsx"
      ],
      "fileDiffs": [
        {
          "path": "common/src/answer.ts",
          "status": "modified",
          "diff": "Index: common/src/answer.ts\n===================================================================\n--- common/src/answer.ts\t1fa2964 (parent)\n+++ common/src/answer.ts\t8bb970e (commit)\n@@ -100,4 +100,48 @@\n       return 0\n     },\n   ])\n }\n+export const ANSWERS_TO_HIDE_GRAPH = 3\n+\n+export function getSortedAnswers(\n+  contract: MultiContract,\n+  sortedAnswers: Answer[],\n+  sort: MultiSort,\n+  selectedAnswerIds?: string[]\n+) {\n+  const answers = contract.answers\n+  const allResolved = getAllResolved(contract, answers)\n+  return sortedAnswers\n+    .filter((answer) => {\n+      if (selectedAnswerIds?.includes(answer.id)) {\n+        return true\n+      }\n+\n+      if (allResolved) return true\n+      if (sort === 'prob-asc') {\n+        return answer.prob < 0.99\n+      } else if (sort === 'prob-desc') {\n+        return answer.prob > 0.01\n+      } else if (sort === 'liquidity' || sort === 'new' || sort === 'old') {\n+        return !answer.resolution\n+      }\n+      return true\n+    })\n+    .slice(0, MAX_DEFAULT_ANSWERS)\n+}\n+\n+export function getAllResolved(contract: MultiContract, answers: Answer[]) {\n+  const shouldAnswersSumToOne = getShouldAnswersSumToOne(contract)\n+  return (\n+    (shouldAnswersSumToOne && !!contract.resolutions) ||\n+    answers.every((a) => a.resolution)\n+  )\n+}\n+\n+export function getShouldAnswersSumToOne(contract: MultiContract) {\n+  return 'shouldAnswersSumToOne' in contract\n+    ? contract.shouldAnswersSumToOne\n+    : true\n+}\n+\n+export const MAX_DEFAULT_ANSWERS = 20\n"
        },
        {
          "path": "common/src/contract-params.ts",
          "status": "modified",
          "diff": "Index: common/src/contract-params.ts\n===================================================================\n--- common/src/contract-params.ts\t1fa2964 (parent)\n+++ common/src/contract-params.ts\t8bb970e (commit)\n@@ -4,27 +4,33 @@\n } from 'common/calculate'\n import { Contract, ContractParams, MultiContract } from 'common/contract'\n import { binAvg, maxMinBin, serializeMultiPoints } from 'common/chart'\n import {\n-  getRecentTopLevelCommentsAndReplies,\n   getPinnedComments,\n+  getRecentTopLevelCommentsAndReplies,\n } from 'common/supabase/comments'\n import {\n-  getTopContractMetrics,\n   getContractMetricsCount,\n+  getTopContractMetrics,\n } from 'common/supabase/contract-metrics'\n import { getTopicsOnContract } from 'common/supabase/groups'\n import { removeUndefinedProps } from 'common/util/object'\n-import { pointsToBase64Float32, pointsToBase64 } from 'common/util/og'\n+import { pointsToBase64, pointsToBase64Float32 } from 'common/util/og'\n import { SupabaseClient } from 'common/supabase/utils'\n import { buildArray } from 'common/util/array'\n import { groupBy, mapValues, minBy, omit, orderBy, sortBy } from 'lodash'\n import { Bet } from 'common/bet'\n import { getChartAnnotations } from 'common/supabase/chart-annotations'\n import { unauthedApi } from './util/api'\n-import { MAX_ANSWERS, sortAnswers } from './answer'\n+import {\n+  ANSWERS_TO_HIDE_GRAPH,\n+  getDefaultSort,\n+  getSortedAnswers,\n+  MAX_ANSWERS,\n+  sortAnswers,\n+} from './answer'\n import { getDashboardsToDisplayOnContract } from './supabase/dashboards'\n-import { getTotalBetCount, getBetPoints } from './bets'\n+import { getBetPoints, getTotalBetCount } from './bets'\n \n export async function getContractParams(\n   contract: Contract,\n   db: SupabaseClient\n@@ -85,9 +91,12 @@\n   ])\n \n   // TODO: getMultiBetPoints breaks NUMBER market time series charts and I think MULTI_NUMERIC as well when they get enough bets\n   // TODO: remove multiPointsString for markets with more than x answers as it's not displayed by default anyways\n-  const multiPoints = isMulti ? getMultiBetPoints(allBetPoints, contract) : {}\n+  const multiPoints =\n+    isMulti && !getShouldHideGraph(contract)\n+      ? getMultiBetPoints(allBetPoints, contract)\n+      : {}\n   const multiPointsString = mapValues(multiPoints, (v) => pointsToBase64(v))\n \n   const ogPoints = !isMulti ? binAvg(allBetPoints) : []\n   // Non-numeric markets don't need as much precision\n@@ -206,4 +215,13 @@\n   })\n \n   return pointsByAns\n }\n+\n+export const getShouldHideGraph = (contract: Contract) => {\n+  if (contract.mechanism !== 'cpmm-multi-1') return false\n+  const defaultSort = getDefaultSort(contract)\n+  const sortedAnswers = sortAnswers(contract, contract.answers, defaultSort)\n+  const initialAnswers = getSortedAnswers(contract, sortedAnswers, defaultSort)\n+\n+  return initialAnswers.length > ANSWERS_TO_HIDE_GRAPH\n+}\n"
        },
        {
          "path": "web/components/answers/answers-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/answers/answers-panel.tsx\n===================================================================\n--- web/components/answers/answers-panel.tsx\t1fa2964 (parent)\n+++ web/components/answers/answers-panel.tsx\t8bb970e (commit)\n@@ -13,8 +13,11 @@\n   getMaximumAnswers,\n   sortAnswers,\n   type Answer,\n   type MultiSort,\n+  getAllResolved,\n+  getSortedAnswers,\n+  getShouldAnswersSumToOne,\n } from 'common/answer'\n import { LimitBet } from 'common/bet'\n import { getAnswerProbability } from 'common/calculate'\n import {\n@@ -77,34 +80,18 @@\n import { RelativeTimestamp } from '../relative-timestamp'\n import { buildArray } from 'common/util/array'\n import { useSavedContractMetrics } from 'web/hooks/use-saved-contract-metrics'\n import { floatingEqual } from 'common/util/math'\n-import { getSortedAnswers } from '../contract/contract-overview'\n import { useUnfilledBets } from 'client-common/hooks/use-bets'\n \n export const SHOW_LIMIT_ORDER_CHARTS_KEY = 'SHOW_LIMIT_ORDER_CHARTS_KEY'\n-export const MAX_DEFAULT_ANSWERS = 20\n const MAX_DEFAULT_GRAPHED_ANSWERS = 6\n \n // the offset in which the top of answers is visible\n const SCROLL_OFFSET = 100\n // debounce when typing a query to ensure smoother autoscrolling\n const DEBOUNCE_DELAY = 100\n \n-function getShouldAnswersSumToOne(contract: MultiContract) {\n-  return 'shouldAnswersSumToOne' in contract\n-    ? contract.shouldAnswersSumToOne\n-    : true\n-}\n-\n-export function getAllResolved(contract: MultiContract, answers: Answer[]) {\n-  const shouldAnswersSumToOne = getShouldAnswersSumToOne(contract)\n-  return (\n-    (shouldAnswersSumToOne && !!contract.resolutions) ||\n-    answers.every((a) => a.resolution)\n-  )\n-}\n-\n // full resorting, hover, clickiness, search and add\n export function AnswersPanel(props: {\n   contract: CPMMMultiContract | MultiNumericContract\n   selectedAnswerIds: string[]\n"
        },
        {
          "path": "web/components/charts/contract/zoom-utils.ts",
          "status": "modified",
          "diff": "Index: web/components/charts/contract/zoom-utils.ts\n===================================================================\n--- web/components/charts/contract/zoom-utils.ts\t1fa2964 (parent)\n+++ web/components/charts/contract/zoom-utils.ts\t8bb970e (commit)\n@@ -1,10 +1,12 @@\n-import { HistoryPoint, maxMinBin } from 'common/chart'\n+import { HistoryPoint, maxMinBin, MultiPoints } from 'common/chart'\n import { buildArray } from 'common/util/array'\n import { debounce } from 'lodash'\n import { useCallback, useEffect, useLayoutEffect, useState } from 'react'\n import { ScaleTime } from 'd3-scale'\n import { getBetPoints } from 'common/bets'\n+import { getMultiBetPoints } from 'common/contract-params'\n+import { MultiContract } from 'common/contract'\n \n export async function getPointsBetween(\n   contractId: string,\n   min?: number,\n@@ -70,4 +72,101 @@\n   }, [props.viewXScale])\n \n   return { points: data, loading }\n }\n+\n+export async function getMultichoicePointsBetween(\n+  contract: MultiContract,\n+  min?: number,\n+  max?: number\n+) {\n+  const allBetPoints = await getBetPoints(contract.id, {\n+    filterRedemptions: false,\n+    includeZeroShareRedemptions: true,\n+    beforeTime: max,\n+    afterTime: min,\n+  })\n+  const multiPoints = getMultiBetPoints(allBetPoints, contract)\n+\n+  return multiPoints\n+}\n+\n+// only for multichoice contracts\n+export const useMultiChoiceDataZoomFetcher = <T>(props: {\n+  contract: MultiContract\n+  viewXScale?: ScaleTime<number, number>\n+  points: MultiPoints\n+}) => {\n+  const { contract, points } = props\n+  const [data, setData] = useState(points)\n+  const [loading, setLoading] = useState(false)\n+\n+  const onZoomData = useCallback(\n+    debounce(async (min?: number, max?: number) => {\n+      if (min && max) {\n+        setLoading(true)\n+        const zoomedPoints = await getMultichoicePointsBetween(\n+          contract,\n+          min,\n+          max\n+        )\n+\n+        // Combine the original points outside the zoom range with the zoomed points\n+        const newData: MultiPoints = {}\n+\n+        // Get all answer IDs from both objects\n+        const allAnswerIds = Array.from(\n+          new Set([...Object.keys(props.points), ...Object.keys(zoomedPoints)])\n+        )\n+\n+        // Process each answer ID\n+        allAnswerIds.forEach((answerId) => {\n+          // Get points for this answer ID\n+          const answerPoints = props.points[answerId] || []\n+          const zoomedAnswerPoints = zoomedPoints[answerId] || []\n+\n+          // Convert serialized points to HistoryPoint objects\n+          const typedZoomedPoints = zoomedAnswerPoints.map(([x, y]) => ({\n+            x,\n+            y,\n+          }))\n+\n+          // Build combined array for this answer\n+          newData[answerId] = buildArray(\n+            answerPoints.filter((p) => p.x <= min),\n+            typedZoomedPoints,\n+            answerPoints.filter((p) => p.x >= max)\n+          ).sort((a, b) => a.x - b.x)\n+        })\n+\n+        setData(newData)\n+        setLoading(false)\n+      } else {\n+        setData(props.points)\n+      }\n+    }, 100),\n+    [contract.id]\n+  )\n+\n+  useLayoutEffect(() => {\n+    setData(props.points)\n+    if (Object.keys(props.points).length === 0 && props.viewXScale) {\n+      const [minX, maxX] = props.viewXScale.range()\n+      onZoomData(minX, maxX)\n+    }\n+  }, [contract.id])\n+\n+  useEffect(() => {\n+    if (props.viewXScale) {\n+      const [minX, maxX] = props.viewXScale.range()\n+      // 20px buffer\n+      const min = props.viewXScale.invert(minX - 20).valueOf()\n+      const max = props.viewXScale.invert(maxX + 20).valueOf()\n+\n+      onZoomData(min, max)\n+    } else {\n+      onZoomData()\n+    }\n+  }, [props.viewXScale])\n+\n+  return { points: data, loading }\n+}\n"
        },
        {
          "path": "web/components/contract/contract-overview.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-overview.tsx\n===================================================================\n--- web/components/contract/contract-overview.tsx\t1fa2964 (parent)\n+++ web/components/contract/contract-overview.tsx\t8bb970e (commit)\n@@ -1,8 +1,8 @@\n import clsx from 'clsx'\n import { ReactNode, memo, useEffect, useState } from 'react'\n \n-import { Answer, MultiSort, getDefaultSort, sortAnswers } from 'common/answer'\n+import { Answer, MultiSort, getDefaultSort } from 'common/answer'\n import { Bet } from 'common/bet'\n import { getAutoBountyPayoutPerHour } from 'common/bounty'\n import { getAnswerProbability } from 'common/calculate'\n import { HistoryPoint, MultiPoints } from 'common/chart'\n@@ -12,9 +12,8 @@\n   BountiedQuestionContract,\n   CPMMMultiContract,\n   CPMMNumericContract,\n   Contract,\n-  MultiContract,\n   MultiNumericContract,\n   PseudoNumericContract,\n   StonkContract,\n   getMainBinaryMCAnswer,\n@@ -53,13 +52,9 @@\n import {\n   AnswersResolvePanel,\n   IndependentAnswersResolvePanel,\n } from '../answers/answer-resolve-panel'\n-import {\n-  AnswersPanel,\n-  MAX_DEFAULT_ANSWERS,\n-  getAllResolved,\n-} from '../answers/answers-panel'\n+import { AnswersPanel } from '../answers/answers-panel'\n import { BuyPanel } from '../bet/bet-panel'\n import { UserBetsSummary } from '../bet/bet-summary'\n import {\n   ChartAnnotations,\n@@ -68,9 +63,12 @@\n import { MultiBinaryChart, SizedBinaryChart } from '../charts/contract/binary'\n import { ChoiceContractChart, getAnswerColor } from '../charts/contract/choice'\n import { PseudoNumericContractChart } from '../charts/contract/pseudo-numeric'\n import { StonkContractChart } from '../charts/contract/stonk'\n-import { useDataZoomFetcher } from '../charts/contract/zoom-utils'\n+import {\n+  useDataZoomFetcher,\n+  useMultiChoiceDataZoomFetcher,\n+} from '../charts/contract/zoom-utils'\n import { getEndDate, useZoom } from '../charts/helpers'\n import { TimeRangePicker } from '../charts/time-range-picker'\n import { Col } from '../layout/col'\n import { Row } from '../layout/row'\n@@ -266,46 +264,8 @@\n     </>\n   )\n }\n \n-const ANSWERS_TO_HIDE_GRAPH = 3\n-\n-export function getSortedAnswers(\n-  contract: MultiContract,\n-  sortedAnswers: Answer[],\n-  sort: MultiSort,\n-  selectedAnswerIds?: string[]\n-) {\n-  const answers = contract.answers\n-  const allResolved = getAllResolved(contract, answers)\n-  return sortedAnswers\n-    .filter((answer) => {\n-      if (selectedAnswerIds?.includes(answer.id)) {\n-        return true\n-      }\n-\n-      if (allResolved) return true\n-      if (sort === 'prob-asc') {\n-        return answer.prob < 0.99\n-      } else if (sort === 'prob-desc') {\n-        return answer.prob > 0.01\n-      } else if (sort === 'liquidity' || sort === 'new' || sort === 'old') {\n-        return !answer.resolution\n-      }\n-      return true\n-    })\n-    .slice(0, MAX_DEFAULT_ANSWERS)\n-}\n-\n-export const getShouldHideGraph = (contract: Contract) => {\n-  if (contract.mechanism !== 'cpmm-multi-1') return false\n-  const defaultSort = getDefaultSort(contract)\n-  const sortedAnswers = sortAnswers(contract, contract.answers, defaultSort)\n-  const initialAnswers = getSortedAnswers(contract, sortedAnswers, defaultSort)\n-\n-  return initialAnswers.length > ANSWERS_TO_HIDE_GRAPH\n-}\n-\n const ChoiceOverview = (props: {\n   points: MultiPoints\n   contract: CPMMMultiContract\n   showResolver: boolean\n@@ -317,9 +277,8 @@\n   hideGraph: boolean\n   setHideGraph: (hide: boolean) => void\n }) => {\n   const {\n-    points,\n     contract,\n     showResolver,\n     resolutionRating,\n     setShowResolver,\n@@ -392,9 +351,13 @@\n         ? answers.filter((a) => a !== answer.id)\n         : [...answers, answer.id]\n     )\n   }\n-\n+  const { points, loading } = useMultiChoiceDataZoomFetcher({\n+    contract,\n+    viewXScale: zoomParams?.viewXScale,\n+    points: props.points,\n+  })\n   return (\n     <>\n       <Row className=\"relative justify-between gap-2\">\n         {contract.resolution === 'CANCEL' ? (\n@@ -407,8 +370,11 @@\n         )}\n         {!hideGraph && (\n           <>\n             <Row className={'relative gap-1'}>\n+              {loading && (\n+                <LoadingIndicator spinnerColor=\"border-ink-400\" size=\"sm\" />\n+              )}\n               <UserPositionSearchButton\n                 currentUser={currentUser}\n                 displayUser={displayUser}\n                 contract={contract}\n@@ -430,48 +396,46 @@\n           </>\n         )}\n       </Row>\n \n-      {!!Object.keys(points).length &&\n-        contract.mechanism == 'cpmm-multi-1' &&\n-        !hideGraph && (\n-          <SizedContainer\n-            className={clsx(\n-              'h-[150px] w-full pb-4 pr-10 sm:h-[250px]',\n-              showZoomer && 'mb-12'\n-            )}\n-          >\n-            {(w, h) => (\n-              <ChoiceContractChart\n-                showZoomer={showZoomer}\n-                zoomParams={zoomParams}\n-                width={w}\n-                height={h}\n-                multiPoints={points}\n-                contract={contract}\n-                highlightAnswerId={hoverAnswerId}\n-                selectedAnswerIds={\n-                  selectedAnswerIds.length\n-                    ? selectedAnswerIds\n-                    : defaultAnswerIdsToGraph\n-                }\n-                pointerMode={pointerMode}\n-                setHoveredAnnotation={setHoveredAnnotation}\n-                hoveredAnnotation={hoveredAnnotation}\n-                chartAnnotations={chartAnnotations}\n-                chartPositions={chartPositions?.filter((cp) =>\n-                  hoverAnswerId\n-                    ? cp.answerId === hoverAnswerId\n-                    : selectedAnswerIds.length === 0 ||\n-                      (cp.answerId && selectedAnswerIds.includes(cp.answerId))\n-                )}\n-                hoveredChartPosition={hoveredChartPosition}\n-                setHoveredChartPosition={setHoveredChartPosition}\n-                zoomY={zoomY}\n-              />\n-            )}\n-          </SizedContainer>\n-        )}\n+      {contract.mechanism == 'cpmm-multi-1' && !hideGraph && (\n+        <SizedContainer\n+          className={clsx(\n+            'h-[150px] w-full pb-4 pr-10 sm:h-[250px]',\n+            showZoomer && 'mb-12'\n+          )}\n+        >\n+          {(w, h) => (\n+            <ChoiceContractChart\n+              showZoomer={showZoomer}\n+              zoomParams={zoomParams}\n+              width={w}\n+              height={h}\n+              multiPoints={points}\n+              contract={contract}\n+              highlightAnswerId={hoverAnswerId}\n+              selectedAnswerIds={\n+                selectedAnswerIds.length\n+                  ? selectedAnswerIds\n+                  : defaultAnswerIdsToGraph\n+              }\n+              pointerMode={pointerMode}\n+              setHoveredAnnotation={setHoveredAnnotation}\n+              hoveredAnnotation={hoveredAnnotation}\n+              chartAnnotations={chartAnnotations}\n+              chartPositions={chartPositions?.filter((cp) =>\n+                hoverAnswerId\n+                  ? cp.answerId === hoverAnswerId\n+                  : selectedAnswerIds.length === 0 ||\n+                    (cp.answerId && selectedAnswerIds.includes(cp.answerId))\n+              )}\n+              hoveredChartPosition={hoveredChartPosition}\n+              setHoveredChartPosition={setHoveredChartPosition}\n+              zoomY={zoomY}\n+            />\n+          )}\n+        </SizedContainer>\n+      )}\n       {chartAnnotations?.length && !hideGraph ? (\n         <ChartAnnotations\n           annotations={chartAnnotations}\n           hoveredAnnotation={hoveredAnnotation}\n"
        },
        {
          "path": "web/components/contract/contract-page.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-page.tsx\n===================================================================\n--- web/components/contract/contract-page.tsx\t1fa2964 (parent)\n+++ web/components/contract/contract-page.tsx\t8bb970e (commit)\n@@ -28,12 +28,9 @@\n import { ChangeBannerButton } from 'web/components/contract/change-banner-button'\n import { ContractDescription } from 'web/components/contract/contract-description'\n import { AuthorInfo } from 'web/components/contract/contract-details'\n import { ContractLeaderboard } from 'web/components/contract/contract-leaderboard'\n-import {\n-  ContractOverview,\n-  getShouldHideGraph,\n-} from 'web/components/contract/contract-overview'\n+import { ContractOverview } from 'web/components/contract/contract-overview'\n import { ContractTabs } from 'web/components/contract/contract-tabs'\n import { VisibilityIcon } from 'web/components/contract/contracts-table'\n import { DangerZone } from 'web/components/contract/danger-zone'\n import { EditableQuestionTitle } from 'web/components/contract/editable-question-title'\n@@ -76,8 +73,9 @@\n import { precacheAnswers } from 'web/hooks/use-answers'\n import { useIsPageVisible } from 'web/hooks/use-page-visible'\n import { api } from 'web/lib/api/api'\n import ContractSharePanel from './contract-share-panel'\n+import { getShouldHideGraph } from 'common/contract-params'\n \n export function ContractPageContent(props: ContractParams) {\n   const {\n     comments,\n"
        }
      ]
    },
    {
      "id": "add-usd-boost",
      "sha": "79a55838343c24b16304cf3f874f1816990ca062",
      "parentSha": "f23c3de83e0150593c47db7ffa600650078cc331",
      "spec": "Implement a USD purchase option for contract boosts while preserving the mana option.\n\nBackend API and logic\n- Modify backend/api/src/purchase-contract-boost.ts to support two payment methods via a new request prop method: 'mana' | 'cash'.\n  - Validate: require contract exists and visible to the user.\n  - Active boost check: when querying contract_boosts to validate the selected time, count only records where funded is true.\n  - For method === 'cash':\n    - Insert into contract_boosts a new row with funded = false and return the inserted ID. Start time is millis_to_ts(startTime) and end time is startTime + DAY_MS.\n    - Create a Stripe Checkout Session using STRIPE_APIKEY. Use the Stripe price id determined by environment: PROD_BOOST_STRIPE_PRICE_ID (prod) or DEV_BOOST_STRIPE_PRICE_ID (dev), and set line_items with quantity 1.\n    - Set success_url and cancel_url to the market’s URL (contractUrl(contract)) with a query flag boostSuccess=true/false.\n    - Return JSON { success: true, checkoutUrl } to the client (no mana txn). Also schedule tracking of a public event 'contract boost initiated' with paymentMethod 'cash'.\n  - For method === 'mana':\n    - Insert into contract_boosts with funded = true and the chosen start and end times.\n    - Charge the user’s mana by creating a CONTRACT_BOOST_PURCHASE txn for BOOST_COST_MANA from USER to BANK (toId is HOUSE_LIQUIDITY_PROVIDER_ID or DEV_HOUSE_LIQUIDITY_PROVIDER_ID based on isProd()).\n    - After success, return { success: true } and schedule tracking 'contract boost purchased' with paymentMethod 'mana'. If startTime <= now, immediately apply the boost effect via boostContractImmediately(pg, contract).\n  - Replace direct update to contracts in this endpoint with a call to boostContractImmediately when a boost should apply immediately.\n  - Enforce a max of MAX_ACTIVE_BOOSTS during the requested time window, considering only funded boosts.\n\nStripe webhook\n- Modify backend/api/src/stripe-endpoints.ts to handle boost payments in addition to mana purchases.\n  - Extend StripeSession metadata to allow optional fields: priceInDollars?, boostId?, contractId?.\n  - On 'checkout.session.completed':\n    - If metadata contains boostId and contractId, call a new handler handleBoostPayment(session) instead of issuing mana.\n    - Otherwise, continue the existing issueMoneys(session) behavior.\n  - Implement handleBoostPayment(session):\n    - Validate metadata includes userId, boostId, contractId.\n    - Update the corresponding row in contract_boosts, setting funded = true where id/user/contract match; return the updated row.\n    - If the boost's start_time is in the past or now, fetch the contract and immediately call boostContractImmediately(pg, contract).\n    - Track a public event 'contract boost purchased' with paymentMethod 'cash', including contractId and boostId.\n\nShared helpers and importance scoring\n- Add boostContractImmediately(pg, contract) in backend/shared/src/supabase/contracts.ts that updates the contract’s native columns to boosted=true and adjusts importance_score = min(max(contract.importanceScore + 0.5, 0.9), 1), then broadcasts the update.\n- Update backend/shared/src/importance-score.ts to only consider active boosts where funded is true in the contract_boosts select for computing boosted state and importance scores.\n\nDatabase schema\n- Update backend/supabase/contract_boosts.sql to add two columns:\n  - created_time timestamptz not null default now(),\n  - funded boolean not null default true.\n- Keep existing indexes and RLS. Existing data should default to funded=true for back-compat.\n\nCommon and API schema\n- In common/src/api/schema.ts, update the 'purchase-contract-boost' endpoint:\n  - props: add method: z.enum(['mana', 'cash']).\n  - returns: { success: boolean; checkoutUrl?: string }.\n- In common/src/economy.ts, add DEV_BOOST_STRIPE_PRICE_ID and PROD_BOOST_STRIPE_PRICE_ID constants for the boost Stripe price IDs. Keep BOOST_COST_MANA as is.\n\nFrontend UI\n- Update web/components/contract/add-boost-button.tsx to present both payment options in the modal and handle redirection for cash:\n  - Make loading state reflect which method is processing (e.g., 'cash' | 'mana').\n  - Show the USD price prominently (e.g., $99.99) in the modal.\n  - Add a button 'Pay $99.99 in USD' that calls the API with method: 'cash', handles the response, and if checkoutUrl is present, navigates the browser to it.\n  - Keep a 'Pay with M$' option that calls the API with method: 'mana'.\n  - Disable inputs when loading and ensure insufficient mana disables the mana button and prompts to add funds.\n  - Keep the existing scheduling UI (start date) and success toast; adjust modal sizing as needed.\n\nOther behavior\n- Ensure event tracking via trackPublicEvent includes paymentMethod context where appropriate.\n- Ensure the boosted flag on contracts remains computed by importance-score and optionally set immediately via boostContractImmediately when a boost starts now.\n- All changes should compile and integrate with existing env var usage (STRIPE_APIKEY, STRIPE_WEBHOOKSECRET) and isProd() behavior.",
      "prompt": "Add a USD payment option to purchase 24-hour market boosts in addition to paying with mana. Users should be able to choose to pay in USD via Stripe or with M$. If paying in USD, take them to a Stripe Checkout flow and only activate the boost when the payment succeeds. Keep the existing mana purchase flow.\n\nThe system should:\n- Store boosts in the database with a funded flag, defaulting to true for mana and false when starting a cash purchase.\n- Consider only funded boosts when checking whether a time slot is available and when calculating trending/importance scores.\n- On successful Stripe checkout, mark the boost as funded and immediately apply the boost if its start time is now or in the past.\n- Update the API to accept a payment method and return a redirect URL when the user selects USD.\n- Update the frontend modal to show both options, redirect to Stripe for USD, and continue using mana for the existing path.\n- Track analytics for boost initiation and successful purchases with the selected payment method.\n\nMake sure to update the API schema, server-side handlers, webhook processing, DB schema, and UI to support this behavior end-to-end.",
      "supplementalFiles": [
        "backend/shared/src/analytics.ts",
        "backend/shared/src/utils.ts",
        "backend/shared/src/txn/run-txn.ts",
        "common/src/txn.ts",
        "common/src/contract.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/purchase-contract-boost.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/purchase-contract-boost.ts\n===================================================================\n--- backend/api/src/purchase-contract-boost.ts\tf23c3de (parent)\n+++ backend/api/src/purchase-contract-boost.ts\t79a5583 (commit)\n@@ -8,18 +8,31 @@\n import { getContract, isProd } from 'shared/utils'\n import { runTxnInBetQueue, TxnData } from 'shared/txn/run-txn'\n import { ContractBoostPurchaseTxn } from 'common/txn'\n import { Row } from 'common/supabase/utils'\n-import { BOOST_COST_MANA } from 'common/economy'\n-import { updateContractNativeColumns } from 'shared/supabase/contracts'\n+import {\n+  BOOST_COST_MANA,\n+  DEV_BOOST_STRIPE_PRICE_ID,\n+  PROD_BOOST_STRIPE_PRICE_ID,\n+} from 'common/economy'\n import { trackPublicEvent } from 'shared/analytics'\n+import Stripe from 'stripe'\n+import { contractUrl } from 'common/contract'\n+import { boostContractImmediately } from 'shared/supabase/contracts'\n \n const MAX_ACTIVE_BOOSTS = 5\n \n+const initStripe = () => {\n+  const apiKey = process.env.STRIPE_APIKEY as string\n+  return new Stripe(apiKey, { apiVersion: '2020-08-27', typescript: true })\n+}\n+\n+//TODO; we could add a 'paid' column that is default true but for those paying with USD,\n+// defaults to false until the strpe webhook marks it as true\n export const purchaseContractBoost: APIHandler<\n   'purchase-contract-boost'\n > = async (props, auth) => {\n-  const { contractId, startTime } = props\n+  const { contractId, startTime, method } = props\n   const userId = auth.uid\n \n   const pg = createSupabaseDirectClient()\n \n@@ -27,13 +40,15 @@\n   const contract = await getContract(pg, contractId)\n   if (!contract) {\n     throw new APIError(404, 'Contract not found')\n   }\n+  const fundViaCash = method === 'cash'\n \n   // Check if there's already an active boost\n   const activeBoost = await pg.manyOrNone<Row<'contract_boosts'>>(\n     `select * from contract_boosts \n-     where millis_to_ts($1) between start_time and end_time`,\n+     where millis_to_ts($1) between start_time and end_time\n+     and funded`,\n     [startTime]\n   )\n   if (activeBoost.some((b) => b.contract_id === contractId)) {\n     throw new APIError(\n@@ -47,49 +62,91 @@\n       'That time period has the maximum number of boosts. Please select a different time.'\n     )\n   }\n \n-  // Start transaction\n-  await pg.tx(async (tx) => {\n-    const boost = await tx.one(\n-      `insert into contract_boosts (contract_id, user_id, start_time, end_time)\n-       values ($1, $2, millis_to_ts($3), millis_to_ts($4))\n-       returning *`,\n+  if (fundViaCash) {\n+    // insert the boost as unfunded and then in the stripe endpoint, query for the boost and mark it as funded\n+    const boost = await pg.one(\n+      `insert into contract_boosts (contract_id, user_id, start_time, end_time, funded)\n+       values ($1, $2, millis_to_ts($3), millis_to_ts($4), false)\n+       returning id`,\n       [contractId, userId, startTime, startTime + DAY_MS]\n     )\n \n-    // Charge mana\n-    const txnData: TxnData = {\n-      category: 'CONTRACT_BOOST_PURCHASE',\n-      fromType: 'USER',\n-      toType: 'BANK',\n-      token: 'M$',\n-      data: { contractId, boostId: boost.id },\n-      amount: BOOST_COST_MANA,\n-      fromId: userId,\n-      toId: isProd()\n-        ? HOUSE_LIQUIDITY_PROVIDER_ID\n-        : DEV_HOUSE_LIQUIDITY_PROVIDER_ID,\n-    } as ContractBoostPurchaseTxn\n+    // Create Stripe checkout session\n+    const stripe = initStripe()\n+    const priceId = isProd()\n+      ? PROD_BOOST_STRIPE_PRICE_ID\n+      : DEV_BOOST_STRIPE_PRICE_ID\n \n-    await runTxnInBetQueue(tx, txnData)\n-  })\n+    const session = await stripe.checkout.sessions.create({\n+      metadata: {\n+        userId,\n+        boostId: boost.id,\n+        contractId,\n+      },\n+      line_items: [\n+        {\n+          price: priceId,\n+          quantity: 1,\n+        },\n+      ],\n+      mode: 'payment',\n+      allow_promotion_codes: true,\n+      success_url: contractUrl(contract) + '?boostSuccess=true',\n+      cancel_url: contractUrl(contract) + '?boostSuccess=false',\n+    })\n+    if (!session.url) {\n+      throw new APIError(500, 'Failed to create Stripe checkout session')\n+    }\n \n+    return {\n+      result: { success: true, checkoutUrl: session.url },\n+      continue: async () => {\n+        trackPublicEvent(auth.uid, 'contract boost initiated', {\n+          contractId,\n+          slug: contract.slug,\n+          paymentMethod: 'cash',\n+        })\n+      },\n+    }\n+  } else {\n+    // Start transaction\n+    await pg.tx(async (tx) => {\n+      const boost = await tx.one(\n+        `insert into contract_boosts (contract_id, user_id, start_time, end_time, funded)\n+       values ($1, $2, millis_to_ts($3), millis_to_ts($4), true)\n+       returning id`,\n+        [contractId, userId, startTime, startTime + DAY_MS]\n+      )\n+\n+      // Charge mana\n+      const txnData: TxnData = {\n+        category: 'CONTRACT_BOOST_PURCHASE',\n+        fromType: 'USER',\n+        toType: 'BANK',\n+        token: 'M$',\n+        data: { contractId, boostId: boost.id },\n+        amount: BOOST_COST_MANA,\n+        fromId: userId,\n+        toId: isProd()\n+          ? HOUSE_LIQUIDITY_PROVIDER_ID\n+          : DEV_HOUSE_LIQUIDITY_PROVIDER_ID,\n+      } as ContractBoostPurchaseTxn\n+\n+      await runTxnInBetQueue(tx, txnData)\n+    })\n+  }\n+\n   return {\n     result: { success: true },\n     continue: async () => {\n       trackPublicEvent(auth.uid, 'contract boost purchased', {\n         contractId,\n         slug: contract.slug,\n+        paymentMethod: 'mana',\n       })\n-      if (startTime <= Date.now()) {\n-        await updateContractNativeColumns(pg, contractId, {\n-          boosted: true,\n-          importance_score: Math.min(\n-            Math.max(contract.importanceScore + 0.5, 0.9),\n-            1\n-          ),\n-        })\n-      }\n+      if (startTime <= Date.now() && !fundViaCash)\n+        await boostContractImmediately(pg, contract)\n     },\n   }\n }\n"
        },
        {
          "path": "backend/api/src/stripe-endpoints.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/stripe-endpoints.ts\n===================================================================\n--- backend/api/src/stripe-endpoints.ts\tf23c3de (parent)\n+++ backend/api/src/stripe-endpoints.ts\t79a5583 (commit)\n@@ -9,14 +9,18 @@\n import { runTxnInBetQueue } from 'shared/txn/run-txn'\n import { createSupabaseDirectClient } from 'shared/supabase/init'\n import { updateUser } from 'shared/supabase/users'\n import { WEB_PRICES } from 'common/economy'\n+import { getContract } from 'shared/utils'\n+import { boostContractImmediately } from 'shared/supabase/contracts'\n \n export type StripeSession = Stripe.Event.Data.Object & {\n   id: string\n   metadata: {\n     userId: string\n-    priceInDollars: string\n+    priceInDollars?: string\n+    boostId?: string\n+    contractId?: string\n   }\n }\n \n export type StripeTransaction = {\n@@ -97,9 +101,13 @@\n   }\n \n   if (event.type === 'checkout.session.completed') {\n     const session = event.data.object as StripeSession\n-    await issueMoneys(session)\n+    if (session.metadata.boostId && session.metadata.contractId) {\n+      await handleBoostPayment(session)\n+    } else {\n+      await issueMoneys(session)\n+    }\n   }\n \n   res.status(200).send('success')\n }\n@@ -200,5 +208,37 @@\n     )\n   }\n }\n \n+const handleBoostPayment = async (session: StripeSession) => {\n+  const { boostId, contractId, userId } = session.metadata\n+  if (!boostId || !contractId || !userId) {\n+    log.error('Invalid boost payment metadata', session.metadata)\n+    throw new APIError(400, 'Invalid boost payment metadata')\n+  }\n+\n+  const pg = createSupabaseDirectClient()\n+\n+  const boost = await pg.tx(async (tx) =>\n+    tx.one(\n+      `update contract_boosts \n+         set funded = true \n+         where id = $1 and contract_id = $2 and user_id = $3\n+         returning *`,\n+      [boostId, contractId, userId]\n+    )\n+  )\n+\n+  if (new Date(boost.start_time) <= new Date()) {\n+    const contract = await getContract(pg, contractId)\n+    if (!contract) throw new APIError(404, 'Contract not found')\n+    await boostContractImmediately(pg, contract)\n+  }\n+\n+  await trackPublicEvent(userId, 'contract boost purchased', {\n+    contractId,\n+    boostId,\n+    paymentMethod: 'cash',\n+  })\n+}\n+\n const firestore = admin.firestore()\n"
        },
        {
          "path": "backend/shared/src/importance-score.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/importance-score.ts\n===================================================================\n--- backend/shared/src/importance-score.ts\tf23c3de (parent)\n+++ backend/shared/src/importance-score.ts\t79a5583 (commit)\n@@ -103,9 +103,9 @@\n     ...(await getContractTraders(pg, weekAgo, contractIds)),\n     ...(await getContractVoters(pg, weekAgo, contractIds)),\n   }\n   const activeBoosts = await pg.manyOrNone<Row<'contract_boosts'>>(\n-    `select * from contract_boosts where start_time <= now() and end_time > now()`\n+    `select * from contract_boosts where start_time <= now() and end_time > now() and funded`\n   )\n \n   const contractsWithUpdates: Contract[] = []\n   const marketComponents: Record<string, any>[] = []\n"
        },
        {
          "path": "backend/shared/src/supabase/contracts.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/supabase/contracts.ts\n===================================================================\n--- backend/shared/src/supabase/contracts.ts\tf23c3de (parent)\n+++ backend/shared/src/supabase/contracts.ts\t79a5583 (commit)\n@@ -226,4 +226,17 @@\n   ) as Partial<Contract> & { id: string }\n   broadcastUpdatedContract(newContract.visibility, updatedValues)\n   return newContract\n }\n+\n+export const boostContractImmediately = async (\n+  pg: SupabaseDirectClient,\n+  contract: Contract\n+) => {\n+  await updateContractNativeColumns(pg, contract.id, {\n+    boosted: true,\n+    importance_score: Math.min(\n+      Math.max(contract.importanceScore + 0.5, 0.9),\n+      1\n+    ),\n+  })\n+}\n"
        },
        {
          "path": "backend/supabase/contract_boosts.sql",
          "status": "modified",
          "diff": "Index: backend/supabase/contract_boosts.sql\n===================================================================\n--- backend/supabase/contract_boosts.sql\tf23c3de (parent)\n+++ backend/supabase/contract_boosts.sql\t79a5583 (commit)\n@@ -3,9 +3,11 @@\n     id bigint generated always as identity primary key,\n     contract_id text not null references contracts (id),\n     user_id text not null references users (id),\n     start_time timestamptz not null,\n-    end_time timestamptz not null\n+    end_time timestamptz not null,\n+    created_time timestamptz not null default now(),\n+    funded boolean not null default true\n   );\n \n -- Indexes\n create index if not exists contract_boosts_contract_id_idx on contract_boosts (contract_id, start_time, end_time);\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\tf23c3de (parent)\n+++ common/src/api/schema.ts\t79a5583 (commit)\n@@ -2167,11 +2167,12 @@\n     props: z\n       .object({\n         contractId: z.string(),\n         startTime: z.number().positive().finite().safe(),\n+        method: z.enum(['mana', 'cash']),\n       })\n       .strict(),\n-    returns: {} as { success: boolean },\n+    returns: {} as { success: boolean; checkoutUrl?: string },\n   },\n } as const)\n \n export type APIPath = keyof typeof API\n"
        },
        {
          "path": "common/src/economy.ts",
          "status": "modified",
          "diff": "Index: common/src/economy.ts\n===================================================================\n--- common/src/economy.ts\tf23c3de (parent)\n+++ common/src/economy.ts\t79a5583 (commit)\n@@ -154,4 +154,6 @@\n export const SWEEPS_MIN_BET = 1\n export const MANA_MIN_BET = 1\n export const PROFIT_FEE_FRACTION = 0.1\n export const BOOST_COST_MANA = 10000\n+export const DEV_BOOST_STRIPE_PRICE_ID = 'price_1QuI5BGdoFKoCJW7lMjCIuKW'\n+export const PROD_BOOST_STRIPE_PRICE_ID = 'price_1QuItEGdoFKoCJW7t9qtiGoD'\n"
        },
        {
          "path": "web/components/contract/add-boost-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/add-boost-button.tsx\n===================================================================\n--- web/components/contract/add-boost-button.tsx\tf23c3de (parent)\n+++ web/components/contract/add-boost-button.tsx\t79a5583 (commit)\n@@ -56,9 +56,9 @@\n   setOpen: (open: boolean) => void\n   contract: Contract\n }) {\n   const { open, setOpen, contract } = props\n-  const [loading, setLoading] = useState(false)\n+  const [loading, setLoading] = useState<string>()\n   const [fundsModalOpen, setFundsModalOpen] = useState(false)\n   const now = Date.now()\n   const [startTime, setStartTime] = useState(now)\n   const user = useUser()\n@@ -66,29 +66,36 @@\n   if (!user) return null\n \n   const notEnoughFunds = (user.balance ?? 0) < BOOST_COST_MANA\n \n-  const purchaseBoost = async () => {\n-    setLoading(true)\n+  const purchaseBoost = async (paymentMethod: 'mana' | 'cash') => {\n+    setLoading(paymentMethod)\n     try {\n-      await api('purchase-contract-boost', {\n+      const result = (await api('purchase-contract-boost', {\n         contractId: contract.id,\n         startTime,\n-      })\n+        method: paymentMethod,\n+      })) as { success: boolean; checkoutUrl?: string }\n+\n+      if (result.checkoutUrl) {\n+        window.location.href = result.checkoutUrl\n+        return\n+      }\n+\n       toast.success(\n         'Market boosted! It will be featured on the homepage for 24 hours.'\n       )\n       setOpen(false)\n     } catch (e) {\n       console.error(e)\n       toast.error(e instanceof Error ? e.message : 'Error purchasing boost')\n     }\n-    setLoading(false)\n+    setLoading(undefined)\n   }\n \n   return (\n     <>\n-      <Modal open={open} setOpen={setOpen} size=\"sm\">\n+      <Modal open={open} setOpen={setOpen}>\n         <Col className=\"bg-canvas-0 gap-4 rounded-lg p-6\">\n           <Row className=\"items-center gap-2 text-xl font-semibold\">\n             <BsRocketTakeoff className=\"h-6 w-6\" />\n             Boost this market\n@@ -102,8 +109,10 @@\n                   .add(24, 'hours')\n                   .format('MMM D')}`}\n           </div>\n \n+          <div className=\"mb-2 text-center text-3xl font-semibold\">$99.99</div>\n+\n           <Row className=\"items-center gap-2\">\n             <div className=\"text-ink-600\">Start time:</div>\n             <Input\n               type={'date'}\n@@ -118,25 +127,35 @@\n                 }\n               }}\n               min={dayjs().format('YYYY-MM-DD')}\n               max=\"3000-12-31\"\n-              disabled={loading}\n+              disabled={!!loading}\n               value={dayjs(startTime).format('YYYY-MM-DD')}\n             />\n           </Row>\n \n-          <Row className=\"items-center gap-2\">\n+          <Row className=\"gap-2\">\n             <Button\n               color=\"indigo\"\n-              onClick={purchaseBoost}\n-              loading={loading}\n-              disabled={notEnoughFunds}\n-              className=\"w-full\"\n+              onClick={() => purchaseBoost('cash')}\n+              loading={loading === 'cash'}\n+              className=\"flex-1\"\n+              disabled={!!loading}\n             >\n-              Purchase boost for{' '}\n-              <TokenNumber className=\"mx-1\" amount={BOOST_COST_MANA} />\n+              Pay $99.99 in USD\n             </Button>\n+\n+            <Button\n+              color=\"gray-white\"\n+              onClick={() => purchaseBoost('mana')}\n+              loading={loading === 'mana'}\n+              disabled={!!loading || notEnoughFunds}\n+              className=\"flex-1\"\n+            >\n+              Pay with <TokenNumber className=\"mx-1\" amount={BOOST_COST_MANA} />\n+            </Button>\n           </Row>\n+\n           {notEnoughFunds && (\n             <div className=\"text-ink-600 flex items-center gap-2 text-sm\">\n               <span className=\"text-error\">Insufficient balance</span>\n               <Button\n"
        }
      ]
    },
    {
      "id": "add-bet-points",
      "sha": "094a9b7bf0b83fc1e9d0d97b57bb7aff413fd4ee",
      "parentSha": "e707d1b9cf678c5f554345231cd1b041001d71fb",
      "spec": "Implement a dedicated GET bet-points endpoint and update consumers to fetch time-bounded bet points using it.\n\nBackend API:\n1) backend/api/src/get-bets.ts\n- Extract existing bets logic into getBetsInternal(props: ValidatedAPIParams<'bets'>) that returns getBetsWithFilter(pg, opts) with support for the 'points' flag.\n- Export a new handler getBetPointsBetween as APIHandler<'bet-points'> that calls getBetsInternal with the incoming props plus points: true.\n- Keep the existing getBets export delegating to getBetsInternal to maintain behavior.\n\n2) backend/api/src/routes.ts\n- Register the new API path 'bet-points' and map it to getBetPointsBetween.\n\nShared schema and client:\n3) common/src/api/schema.ts\n- Add a new API definition 'bet-points' with:\n  - method: GET\n  - visibility: public\n  - authed: false\n  - cache: public, max-age=600, stale-while-revalidate=60\n  - returns: Bet[]\n  - props schema (Zod):\n    - contractId: string\n    - answerId: string (optional)\n    - limit: number (coerced), range 0–50000, default 50000\n    - beforeTime: number (required)\n    - afterTime: number (required)\n    - filterRedemptions: boolean (coerced, optional)\n    - includeZeroShareRedemptions: boolean (coerced, optional)\n\n4) common/src/bets.ts\n- Add getBetPointsBetween(options: APIParams<'bet-points'>) that:\n  - Calls unauthedApi('bet-points', options) to fetch Bet[]\n  - Sorts by createdTime ascending\n  - Converts to a series of points { x: createdTime, y: probAfter, answerId? }\n  - If the first element has no answerId (binary), prepend a continuity point at x = first.createdTime - 1 with y = first.probBefore\n  - Returns the assembled HistoryPoint array\n\nGraph consumers:\n5) common/src/contract-params.ts\n- Replace getBetPoints(contract.id, ...) for graph points with getBetPointsBetween using time bounds:\n  - contractId: contract.id\n  - beforeTime: contract.lastBetTime if present, otherwise contract.createdTime\n  - afterTime: contract.createdTime\n  - filterRedemptions: !includeRedemptions\n  - includeZeroShareRedemptions: includeRedemptions\n\n6) web/components/charts/contract/zoom-utils.ts\n- Import and use getBetPointsBetween instead of getBetPoints.\n- getPointsBetween(contractId, min, max): call getBetPointsBetween({ contractId, beforeTime: max, afterTime: min, filterRedemptions: true }), then bin results.\n- useDataZoomFetcher:\n  - Accept props: createdTime and lastBetTime in addition to contractId, viewXScale, points.\n  - When computing min/max from viewXScale, if the scale range is degenerate (|minX - maxX| <= 1), do not fetch.\n  - Clamp min and max to [createdTime, lastBetTime] before fetching.\n  - When no viewXScale is provided, fetch using [createdTime, lastBetTime].\n  - Merge and sort zoom-fetched points appropriately; do not use the original props.points as the source for outside-of-range segments; use the newly fetched points consistently.\n- getMultichoicePointsBetween: switch to getBetPointsBetween({ contractId: contract.id, beforeTime: max, afterTime: min, filterRedemptions: false, includeZeroShareRedemptions: true }).\n- useMultiChoiceDataZoomFetcher:\n  - Accept createdTime and lastBetTime; clamp min/max to these bounds.\n  - Add the same degenerate range guard as in the binary hook.\n  - Maintain merging across answers while using the zoom-fetched data and existing points consistently.\n\n7) web/components/contract/contract-overview.tsx\n- Pass createdTime: contract.createdTime and lastBetTime: contract.lastBetTime ?? contract.createdTime into the zoom hooks for both binary and multiple-choice overviews.\n\nBehavioral expectations:\n- Time-bounded chart requests hit the new cached bet-points endpoint, improving responsiveness and cacheability.\n- Zoom utilities request only the relevant window, clamped to the contract’s lifespan, and produce continuous series (with a pre-point for binary).\n- Non-time-bounded callers of getBetPoints remain unchanged and continue to work.",
      "prompt": "Add a dedicated cached API endpoint to fetch a contract’s bet points between two times, and switch chart zooming and contract parameter fetches to use it.\n\nGoals:\n- Provide a public, cached GET endpoint that returns bet points (probability history) for a contract and optional answerId between afterTime and beforeTime, with options to filter redemptions and include zero-share redemptions.\n- Refactor the existing bets logic for reuse and wire up the new route.\n- Create a shared client helper that converts returned bets into a time series, including a continuity point for binary markets.\n- Update chart zoom hooks to use the new helper, clamp requests to the contract’s created time and last bet time, and avoid fetching when the zoom range is degenerate.\n- Ensure types and schema are updated so the endpoint is discoverable and type-safe across the codebase.",
      "supplementalFiles": [
        "common/src/chart.ts",
        "common/src/bet.ts",
        "common/src/contract.ts",
        "web/lib/api/api.ts"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/get-bets.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/get-bets.ts\n===================================================================\n--- backend/api/src/get-bets.ts\te707d1b (parent)\n+++ backend/api/src/get-bets.ts\t094a9b7 (commit)\n@@ -7,10 +7,11 @@\n import { getUserIdFromUsername } from 'shared/supabase/users'\n import { getBetsWithFilter } from 'shared/supabase/bets'\n import { convertBet, NON_POINTS_BETS_LIMIT } from 'common/supabase/bets'\n import { filterDefined } from 'common/util/array'\n+import { ValidatedAPIParams } from 'common/api/schema'\n \n-export const getBets: APIHandler<'bets'> = async (props) => {\n+export const getBetsInternal = async (props: ValidatedAPIParams<'bets'>) => {\n   const {\n     limit,\n     username,\n     contractSlug,\n@@ -89,8 +90,17 @@\n \n   return await getBetsWithFilter(pg, opts)\n }\n \n+export const getBets: APIHandler<'bets'> = async (props) =>\n+  getBetsInternal(props)\n+\n+export const getBetPointsBetween: APIHandler<'bet-points'> = async (props) =>\n+  getBetsInternal({\n+    ...props,\n+    points: true,\n+  })\n+\n async function getBetTime(pg: SupabaseDirectClient, id: string) {\n   const created = await pg.oneOrNone(\n     `\n   select ts_to_millis(created_time) as \"createdTime\" from postgres.public.contract_bets where bet_id = $1`,\n"
        },
        {
          "path": "backend/api/src/routes.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/routes.ts\n===================================================================\n--- backend/api/src/routes.ts\te707d1b (parent)\n+++ backend/api/src/routes.ts\t094a9b7 (commit)\n@@ -26,9 +26,9 @@\n import { pinComment } from './pin-comment'\n import { getManagrams } from './get-managrams'\n import { getGroups } from './get-groups'\n import { getComments } from './get-comments'\n-import { getBets } from './get-bets'\n+import { getBetPointsBetween, getBets } from './get-bets'\n import { getLiteUser, getUser } from './get-user'\n import { getUsers } from './get-users'\n import { getUserBalancesByIds, getUsersByIds } from './get-users-by-ids'\n import { getMarket } from './get-market'\n@@ -180,8 +180,9 @@\n   'follow-contract': followContract,\n   'bet/cancel/:betId': cancelBet,\n   'market/:contractId/sell': sellShares,\n   bets: getBets,\n+  'bet-points': getBetPointsBetween,\n   'get-notifications': getNotifications,\n   'get-channel-memberships': getChannelMemberships,\n   'get-channel-messages': getChannelMessages,\n   'get-channel-seen-time': getLastSeenChannelTime,\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\te707d1b (parent)\n+++ common/src/api/schema.ts\t094a9b7 (commit)\n@@ -387,8 +387,26 @@\n         points: coerceBoolean.optional(),\n       })\n       .strict(),\n   },\n+  'bet-points': {\n+    method: 'GET',\n+    visibility: 'public',\n+    authed: false,\n+    cache: 'public, max-age=600, stale-while-revalidate=60',\n+    returns: [] as Bet[],\n+    props: z\n+      .object({\n+        contractId: z.string(),\n+        answerId: z.string().optional(),\n+        limit: z.coerce.number().gte(0).lte(50000).default(50000),\n+        beforeTime: z.coerce.number(),\n+        afterTime: z.coerce.number(),\n+        filterRedemptions: coerceBoolean.optional(),\n+        includeZeroShareRedemptions: coerceBoolean.optional(),\n+      })\n+      .strict(),\n+  },\n   'unique-bet-group-count': {\n     method: 'GET',\n     visibility: 'undocumented',\n     authed: false,\n"
        },
        {
          "path": "common/src/bets.ts",
          "status": "modified",
          "diff": "Index: common/src/bets.ts\n===================================================================\n--- common/src/bets.ts\te707d1b (parent)\n+++ common/src/bets.ts\t094a9b7 (commit)\n@@ -43,4 +43,29 @@\n       answerId: r.answerId,\n     }))\n   )\n }\n+\n+// gets random bets - 50,000 by default\n+export const getBetPointsBetween = async (options: APIParams<'bet-points'>) => {\n+  const data = await unauthedApi('bet-points', options)\n+\n+  const sorted = sortBy(data, 'createdTime')\n+\n+  if (sorted.length === 0) return []\n+\n+  // we need to include previous prob for binary in case the prob shifted from something\n+  const includePrevProb = !sorted[0].answerId\n+\n+  return buildArray(\n+    includePrevProb && {\n+      x: sorted[0].createdTime - 1,\n+      y: sorted[0].probBefore,\n+      answerId: sorted[0].answerId,\n+    },\n+    sorted.map((r) => ({\n+      x: r.createdTime,\n+      y: r.probAfter,\n+      answerId: r.answerId,\n+    }))\n+  )\n+}\n"
        },
        {
          "path": "common/src/contract-params.ts",
          "status": "modified",
          "diff": "Index: common/src/contract-params.ts\n===================================================================\n--- common/src/contract-params.ts\te707d1b (parent)\n+++ common/src/contract-params.ts\t094a9b7 (commit)\n@@ -28,9 +28,9 @@\n   MAX_ANSWERS,\n   sortAnswers,\n } from './answer'\n import { getDashboardsToDisplayOnContract } from './supabase/dashboards'\n-import { getBetPoints, getTotalBetCount } from './bets'\n+import { getBetPointsBetween, getTotalBetCount } from './bets'\n \n export async function getContractParams(\n   contract: Contract,\n   db: SupabaseClient\n@@ -71,11 +71,14 @@\n           filterRedemptions: true,\n         })\n       : ([] as Bet[]),\n     hasMechanism && !shouldHideGraph(contract)\n-      ? getBetPoints(contract.id, {\n+      ? getBetPointsBetween({\n+          contractId: contract.id,\n           filterRedemptions: !includeRedemptions,\n           includeZeroShareRedemptions: includeRedemptions,\n+          beforeTime: contract.lastBetTime ?? contract.createdTime,\n+          afterTime: contract.createdTime,\n         })\n       : [],\n     getRecentTopLevelCommentsAndReplies(db, contract.id, 25),\n     getPinnedComments(db, contract.id),\n"
        },
        {
          "path": "web/components/charts/contract/zoom-utils.ts",
          "status": "modified",
          "diff": "Index: web/components/charts/contract/zoom-utils.ts\n===================================================================\n--- web/components/charts/contract/zoom-utils.ts\te707d1b (parent)\n+++ web/components/charts/contract/zoom-utils.ts\t094a9b7 (commit)\n@@ -2,21 +2,22 @@\n import { buildArray } from 'common/util/array'\n import { debounce } from 'lodash'\n import { useCallback, useEffect, useLayoutEffect, useState } from 'react'\n import { ScaleTime } from 'd3-scale'\n-import { getBetPoints } from 'common/bets'\n+import { getBetPointsBetween } from 'common/bets'\n import { getMultiBetPoints } from 'common/contract-params'\n import { MultiContract } from 'common/contract'\n \n export async function getPointsBetween(\n   contractId: string,\n-  min?: number,\n-  max?: number\n+  min: number,\n+  max: number\n ) {\n-  const points = await getBetPoints(contractId, {\n-    filterRedemptions: true,\n+  const points = await getBetPointsBetween({\n+    contractId,\n     beforeTime: max,\n     afterTime: min,\n+    filterRedemptions: true,\n   })\n \n   const compressed = maxMinBin(points, 500)\n \n@@ -25,62 +26,69 @@\n \n // only for single value contracts\n export const useDataZoomFetcher = <T>(props: {\n   contractId: string\n+  createdTime: number\n+  lastBetTime: number\n   viewXScale?: ScaleTime<number, number>\n   points: HistoryPoint<T>[]\n }) => {\n-  const [data, setData] = useState(props.points)\n+  const { contractId, createdTime, lastBetTime, viewXScale, points } = props\n+  const [data, setData] = useState(points)\n   const [loading, setLoading] = useState(false)\n \n   const onZoomData = useCallback(\n-    debounce(async (min?: number, max?: number) => {\n+    debounce(async (min: number, max: number) => {\n       if (min && max) {\n         setLoading(true)\n-        const points = await getPointsBetween(props.contractId, min, max)\n+        const points = await getPointsBetween(contractId, min, max)\n \n         setData(\n           buildArray(\n-            props.points.filter((p) => p.x <= min),\n+            points.filter((p) => p.x <= min),\n             points,\n-            props.points.filter((p) => p.x >= max)\n+            points.filter((p) => p.x >= max)\n           ).sort((a, b) => a.x - b.x)\n         )\n \n         setLoading(false)\n       } else {\n-        setData(props.points)\n+        setData(points)\n       }\n     }, 100),\n-    [props.contractId]\n+    [contractId]\n   )\n \n   useLayoutEffect(() => {\n-    setData(props.points)\n-  }, [props.contractId])\n+    setData(points)\n+  }, [contractId])\n \n   useEffect(() => {\n-    if (props.viewXScale) {\n-      const [minX, maxX] = props.viewXScale.range()\n+    if (viewXScale) {\n+      const [minX, maxX] = viewXScale.range()\n+      if (Math.abs(minX - maxX) <= 1) return\n       // 20px buffer\n-      const min = props.viewXScale.invert(minX - 20).valueOf()\n-      const max = props.viewXScale.invert(maxX + 20).valueOf()\n+      const min = viewXScale.invert(minX - 20).valueOf()\n+      const max = viewXScale.invert(maxX + 20).valueOf()\n+      const fixedMin = Math.max(min, createdTime)\n+      const fixedMax = Math.min(max, lastBetTime)\n \n-      onZoomData(min, max)\n+      onZoomData(fixedMin, fixedMax)\n     } else {\n-      onZoomData()\n+      onZoomData(createdTime, lastBetTime)\n     }\n-  }, [props.viewXScale])\n+  }, [viewXScale])\n \n   return { points: data, loading }\n }\n \n export async function getMultichoicePointsBetween(\n   contract: MultiContract,\n-  min?: number,\n-  max?: number\n+  min: number,\n+  max: number\n ) {\n-  const allBetPoints = await getBetPoints(contract.id, {\n+  const allBetPoints = await getBetPointsBetween({\n+    contractId: contract.id,\n     filterRedemptions: false,\n     includeZeroShareRedemptions: true,\n     beforeTime: max,\n     afterTime: min,\n@@ -94,10 +102,12 @@\n export const useMultiChoiceDataZoomFetcher = <T>(props: {\n   contract: MultiContract\n   viewXScale?: ScaleTime<number, number>\n   points: MultiPoints\n+  createdTime: number\n+  lastBetTime: number\n }) => {\n-  const { contract, points } = props\n+  const { contract, points, createdTime, lastBetTime, viewXScale } = props\n   const [data, setData] = useState(points)\n   const [loading, setLoading] = useState(false)\n \n   const onZoomData = useCallback(\n@@ -114,15 +124,15 @@\n         const newData: MultiPoints = {}\n \n         // Get all answer IDs from both objects\n         const allAnswerIds = Array.from(\n-          new Set([...Object.keys(props.points), ...Object.keys(zoomedPoints)])\n+          new Set([...Object.keys(points), ...Object.keys(zoomedPoints)])\n         )\n \n         // Process each answer ID\n         allAnswerIds.forEach((answerId) => {\n           // Get points for this answer ID\n-          const answerPoints = props.points[answerId] || []\n+          const answerPoints = points[answerId] || []\n           const zoomedAnswerPoints = zoomedPoints[answerId] || []\n \n           // Convert serialized points to HistoryPoint objects\n           const typedZoomedPoints = zoomedAnswerPoints.map(([x, y]) => ({\n@@ -140,33 +150,36 @@\n \n         setData(newData)\n         setLoading(false)\n       } else {\n-        setData(props.points)\n+        setData(points)\n       }\n     }, 100),\n     [contract.id]\n   )\n \n   useLayoutEffect(() => {\n-    setData(props.points)\n-    if (Object.keys(props.points).length === 0 && props.viewXScale) {\n-      const [minX, maxX] = props.viewXScale.range()\n+    setData(points)\n+    if (Object.keys(points).length === 0 && viewXScale) {\n+      const [minX, maxX] = viewXScale.range()\n       onZoomData(minX, maxX)\n     }\n   }, [contract.id])\n \n   useEffect(() => {\n-    if (props.viewXScale) {\n-      const [minX, maxX] = props.viewXScale.range()\n+    if (viewXScale) {\n+      const [minX, maxX] = viewXScale.range()\n+      if (Math.abs(minX - maxX) <= 1) return\n       // 20px buffer\n-      const min = props.viewXScale.invert(minX - 20).valueOf()\n-      const max = props.viewXScale.invert(maxX + 20).valueOf()\n+      const min = viewXScale.invert(minX - 20).valueOf()\n+      const max = viewXScale.invert(maxX + 20).valueOf()\n+      const fixedMin = Math.max(min, createdTime)\n+      const fixedMax = Math.min(max, lastBetTime)\n \n-      onZoomData(min, max)\n+      onZoomData(fixedMin, fixedMax)\n     } else {\n       onZoomData()\n     }\n-  }, [props.viewXScale])\n+  }, [viewXScale])\n \n   return { points: data, loading }\n }\n"
        },
        {
          "path": "web/components/contract/contract-overview.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-overview.tsx\n===================================================================\n--- web/components/contract/contract-overview.tsx\te707d1b (parent)\n+++ web/components/contract/contract-overview.tsx\t094a9b7 (commit)\n@@ -206,8 +206,10 @@\n     useTimePicker(contract, () => setShowZoomer(true))\n \n   const { points, loading } = useDataZoomFetcher({\n     contractId: contract.id,\n+    createdTime: contract.createdTime,\n+    lastBetTime: contract.lastBetTime ?? contract.createdTime,\n     viewXScale: zoomParams?.viewXScale,\n     points: props.betPoints,\n   })\n \n@@ -355,8 +357,10 @@\n   const { points, loading } = useMultiChoiceDataZoomFetcher({\n     contract,\n     viewXScale: zoomParams?.viewXScale,\n     points: props.points,\n+    createdTime: contract.createdTime,\n+    lastBetTime: contract.lastBetTime ?? contract.createdTime,\n   })\n   return (\n     <>\n       <Row className=\"relative justify-between gap-2\">\n"
        }
      ]
    },
    {
      "id": "remove-tiers",
      "sha": "13133e30c40d2de635158bd58519bac0b473f069",
      "parentSha": "262f7ebf215c6315a321fc7ea83574d64c21b2d1",
      "spec": "Implement full removal of legacy market tiers and adopt numeric liquidity tiers throughout backend, common, and web layers.\n\nBack-end API and shared changes:\n1) Remove tier mutation on liquidity changes:\n- backend/api/src/add-liquidity.ts: Stop importing getTierFromLiquidity from common/tier and remove marketTier update in updateContract. Only increment subsidyPool and totalLiquidity.\n- backend/api/src/remove-liquidity.ts: Same—remove getTierFromLiquidity import and marketTier updates; only decrement subsidyPool and totalLiquidity.\n\n2) Update answer creation cost to be liquidity-derived:\n- backend/api/src/create-answer-cpmm.ts:\n  - Replace import of getTieredAnswerCost and getTierFromLiquidity with getAnswerCostFromLiquidity from common/tier.\n  - Compute answerCost as getAnswerCostFromLiquidity(contract.totalLiquidity, contract.answers.length) instead of tier-based cost.\n\n3) Update market creation to use numeric liquidity tier:\n- backend/api/src/create-market.ts:\n  - Remove import and any usage of getTieredCost from common/tier.\n  - Accept a new liquidityTier: number parameter from validateMarketBody and remove marketTier from the request/contract creation flow.\n  - Remove extraLiquidity from per-type create schemas (binary, pseudo-numeric, multi) and instead accept optional extraLiquidity at the top-level create props.\n  - Compute ante using getAnte(outcomeType, numAnswers, liquidityTier). Compute totalMarketCost as ante + (extraLiquidity ?? 0). Enforce ante >= 1; enforce closeTime in future as before. Do not compute marketTier-based costs.\n  - Pass liquidityTier through to new contract creation data as needed; do not include marketTier anywhere.\n\n4) Remove tier-based filtering from activity and search:\n- backend/api/src/get-site-activity.ts: Remove SQL filter and tier != 'play' condition; keep visibility/public and other filters.\n- backend/api/src/search-contracts.ts: Remove TierParamsType import; remove marketTier filter param from search props, and do not pass marketTier to shared SQL builder. Ensure search continues to work without tier filters.\n- backend/shared/src/supabase/search-contracts.ts:\n  - Remove imports MarketTierType, TierParamsType, tiers and any type usage.\n  - Remove marketTier parameters from getForYouSQL, basicSearchSQL, getSearchContractSQL, getSearchContractWhereSQL. Delete tier-based SQL where clauses. Adjust function signatures and invocations accordingly.\n- backend/shared/src/topic-interests.ts: Remove contracts.tier != 'play' minimum-quality filter.\n- backend/shared/src/weekly-markets-emails.ts: Stop passing marketTier in getForYouMarkets call.\n\n5) Remove tier-related scripts and SQL:\n- Delete backend/scripts/decrease-deposits-for-created-answers.ts.\n- Delete backend/scripts/shift-tiers/backfill-tier-column.sql and get-tier-from-liquidity-function.sql.\n\nCommon (shared) package changes:\n6) API search types and market types:\n- common/src/api/market-search-types.ts: Remove marketTier zod param from searchProps.\n- common/src/api/market-types.ts:\n  - Remove MarketTierType and tiers imports.\n  - Remove marketTier from LiteMarket type and from toLiteMarket serialization.\n  - Remove extraLiquidity from per-type create schemas (createBinarySchema, createNumericSchema, createMultiSchema).\n  - In createMarketProps, add extraLiquidity?: number (min 1) and liquidityTier: number().min(0). Remove marketTier enum.\n\n7) Contract type model:\n- common/src/contract.ts: Remove optional marketTier?: MarketTierType field and any related tier imports.\n\n8) Economy and tier helpers:\n- common/src/economy.ts:\n  - Import answerCostTiers and liquidityTiers from common/tier.\n  - Redefine getAnte(outcomeType, numAnswers, liquidityTier):\n    - If outcomeType === 'POLL', return 10.\n    - If outcomeType === 'MULTIPLE_CHOICE', determine tierIndex by the first liquidityTiers element >= liquidityTier; ante is max(numAnswers * answerCostTiers[tierIndex], liquidityTier) when numAnswers is provided; otherwise liquidityTiers[tierIndex].\n    - For all other predictive types, return liquidityTier.\n  - Keep MINIMUM_BOUNTY = 1000; remove FIXED_ANTE/MIN_ANSWER_COST-based tier logic.\n\n9) Tier utilities:\n- common/src/tier.ts:\n  - Replace legacy tiers array and types with:\n    - export const liquidityTiers = [100, 1_000, 10_000, 100_000] as const.\n    - export const answerCostTiers = [25, 100, 1000, 10000] as const.\n  - export function getTierFromLiquidity(liquidity: number): number that returns the index of the first liquidityTiers element >= liquidity.\n  - export function getAnswerCostFromLiquidity(liquidity: number, numAnswers: number): number that returns answerCostTiers[index], where index is determined by first liquidityTiers >= (liquidity / numAnswers).\n  - Remove MarketTierType, TierParamsType, tiers, getTieredCost, getTieredAnswerCost, and old getTierFromLiquidity(contract, liquidity) functions.\n\nFrontend (web) changes:\n10) Answers panel cost display:\n- web/components/answers/create-answer-panel.tsx: Replace getTieredAnswerCost/marketTier usage with getAnswerCostFromLiquidity(contract.totalLiquidity, contract.answers.length) when displaying add-answer cost.\n\n11) Bet panel quick-add sizing:\n- web/components/bet/bet-panel.tsx: Replace marketTier resolution with liquidityTier index using getTierFromLiquidity(contract.totalLiquidity). Set quickAddButtonSize to 'small' when liquidityTier === 0, or when cpmm-multi-1 and liquidityTier === 1 and !shouldAnswersSumToOne, mirroring previous logic but using numeric tiers.\n\n12) Remove upgrade-tier UI:\n- Delete web/components/contract/upgrade-tier-button.tsx and any references to it.\n\n13) New contract form and cost section:\n- web/components/new-contract/contract-params-form.tsx:\n  - Remove MarketTierType state and persistence; introduce liquidityTier: number state defaulting to liquidityTiers[0].\n  - Compute ante with getAnte(outcomeType, numAnswers, liquidityTier). Validate ante <= balance and other existing validations.\n  - Pass liquidityTier (not marketTier) in create request body; adjust button label cost to display ante.\n  - Update props passed to CostSection to use liquidityTier and setLiquidityTier, and pass numAnswers so it can compute cost.\n- web/components/new-contract/cost-section.tsx:\n  - Remove tier icons/components and MarketTierType types.\n  - Accept props: liquidityTier: number, setLiquidityTier(tier: number), outcomeType, numAnswers.\n  - Compute ante via getAnte(outcomeType, numAnswers, liquidityTier).\n  - Render selectable liquidity options using liquidityTiers; highlight current selection; display amount = liquidityTier numeric value for each option.\n  - Show AddFundsModal when ante > balance.\n\n14) Search UI and filters:\n- web/components/search.tsx: Remove market tier query param (MARKET_TIER_KEY) wiring, default values, and passing in fetch calls.\n- web/components/search/contract-filters.tsx and web/components/search/filter-pills.tsx: Remove tier filter UI and logic (TierDropdownPill, toggleTier, DEFAULT_TIER, related imports and pills). Ensure remaining filters (sort, for you, sweepstakes, etc.) function unchanged.\n\n15) Liquidity tooltip:\n- web/components/tiers/liquidity-tooltip.tsx: Remove MarketTierType imports and TierIcon/getPresentedTierName exports; keep tooltip focused on liquidity amount and explanatory text.\n\n16) Amount input adjustments:\n- web/components/widgets/amount-input.tsx: Replace marketTier?: MarketTierType prop with liquidityTier?: number. Adjust smallAmounts condition to use liquidityTier === 0.\n\n17) Admin sports market creation:\n- web/lib/admin/create-sports-markets.ts: Import liquidityTiers and include liquidityTier: liquidityTiers[1] in create calls so sports markets default to the second numeric tier.\n\nData and cleanup:\n18) Remove any database references to contracts.tier in search/filters; do not rely on a stored marketTier field in contract data. Leave existing stored marketTier values unused.\n\n19) Ensure type and schema updates compile across packages; update imports accordingly. Remove dead imports (MarketTierType, TierParamsType, tiers, getTieredCost, getTieredAnswerCost) wherever referenced.\n\nAcceptance criteria:\n- Creating a market requires liquidityTier and computes ante/total cost without using discrete tiers; form shows numeric liquidity options and correctly enforces balance.\n- Adding/removing liquidity no longer updates any marketTier on the contract.\n- Creating answers shows add-answer cost based on current liquidity/answers, not tiers.\n- Search and site activity endpoints and UI no longer accept or display tier filters; results remain correct without tier-based filtering.\n- Admin sports market creator sets liquidityTier and succeeds.\n- Code compiles with no references to MarketTierType, TierParamsType, tiers constant, getTieredCost, or getTieredAnswerCost in live code.\n- Obsolete scripts and UI components related to tiers are removed.",
      "prompt": "Migrate the app away from discrete market tiers (play/plus/premium/crystal) to numeric liquidity tiers and liquidity-derived costs. Update the market creation flow to accept a numeric liquidityTier and compute the ante and total cost from it. Remove all tier-based filtering and UI from search and site activity. Adjust answer-creation cost to depend on current market liquidity and number of answers. Remove any code that updates or depends on a marketTier field when liquidity changes. Replace tier selection UI with simple numeric liquidity choices, ensure validation uses the new ante, and keep existing behavior for sweepstakes and other filters unchanged. Remove obsolete scripts and components tied to tiers. The final system should compile and run with no references to the old tier enums or tier-based cost helpers.",
      "supplementalFiles": [
        "web/public/custom-components/tiers.tsx",
        "web/components/new-contract/create-contract-types.tsx"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/add-liquidity.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/add-liquidity.ts\n===================================================================\n--- backend/api/src/add-liquidity.ts\t262f7eb (parent)\n+++ backend/api/src/add-liquidity.ts\t13133e3 (commit)\n@@ -6,9 +6,8 @@\n import { getContract, getUser } from 'shared/utils'\n import { onCreateLiquidityProvision } from './on-update-liquidity-provision'\n import { insertLiquidity } from 'shared/supabase/liquidity'\n import { convertLiquidity } from 'common/supabase/liquidity'\n-import { getTierFromLiquidity } from 'common/tier'\n import { FieldVal } from 'shared/supabase/utils'\n import { updateContract } from 'shared/supabase/contracts'\n \n export const addLiquidity: APIHandler<\n@@ -67,12 +66,8 @@\n \n     await updateContract(tx, contractId, {\n       subsidyPool: FieldVal.increment(subsidyAmount),\n       totalLiquidity: FieldVal.increment(subsidyAmount),\n-      marketTier: getTierFromLiquidity(\n-        contract,\n-        contract.totalLiquidity + subsidyAmount\n-      ),\n     })\n \n     return {\n       result: liquidity,\n"
        },
        {
          "path": "backend/api/src/create-answer-cpmm.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/create-answer-cpmm.ts\n===================================================================\n--- backend/api/src/create-answer-cpmm.ts\t262f7eb (parent)\n+++ backend/api/src/create-answer-cpmm.ts\t13133e3 (commit)\n@@ -35,9 +35,9 @@\n   insertAnswer,\n   updateAnswer,\n   updateAnswers,\n } from 'shared/supabase/answers'\n-import { getTieredAnswerCost, getTierFromLiquidity } from 'common/tier'\n+import { getAnswerCostFromLiquidity } from 'common/tier'\n import { updateContract } from 'shared/supabase/contracts'\n import { FieldVal } from 'shared/supabase/utils'\n import { runTransactionWithRetries } from 'shared/transact-with-retries'\n import { Bet, getNewBetId, LimitBet, maker } from 'common/bet'\n@@ -104,10 +104,11 @@\n   creatorId: string\n ) => {\n   const { shouldAnswersSumToOne } = contract\n \n-  const answerCost = getTieredAnswerCost(\n-    getTierFromLiquidity(contract, contract.totalLiquidity)\n+  const answerCost = getAnswerCostFromLiquidity(\n+    contract.totalLiquidity,\n+    contract.answers.length\n   )\n \n   const { newAnswer, user } = await runTransactionWithRetries(\n     async (pgTrans) => {\n"
        },
        {
          "path": "backend/api/src/create-market.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/create-market.ts\n===================================================================\n--- backend/api/src/create-market.ts\t262f7eb (parent)\n+++ backend/api/src/create-market.ts\t13133e3 (commit)\n@@ -57,9 +57,8 @@\n import { generateAntes } from 'shared/create-contract-helpers'\n import { betsQueue } from 'shared/helpers/fn-queue'\n import { convertUser } from 'common/supabase/users'\n import { camelCase, first } from 'lodash'\n-import { getTieredCost } from 'common/tier'\n \n type Body = ValidatedAPIParams<'market'>\n \n export const createMarket: APIHandler<'market'> = async (body, auth) => {\n@@ -118,16 +117,16 @@\n     shouldAnswersSumToOne,\n     totalBounty,\n     isAutoBounty,\n     visibility,\n-    marketTier,\n     idempotencyKey,\n     sportsStartTimestamp,\n     sportsEventId,\n     sportsLeague,\n     answerShortTexts,\n     answerImageUrls,\n     takerAPIOrdersDisabled,\n+    liquidityTier,\n   } = validateMarketBody(body)\n \n   const userId = auth.uid\n \n@@ -135,13 +134,15 @@\n \n   const hasOtherAnswer = addAnswersMode !== 'DISABLED' && shouldAnswersSumToOne\n   const numAnswers = (answers?.length ?? 0) + (hasOtherAnswer ? 1 : 0)\n \n-  const unmodifiedAnte =\n-    (totalBounty ?? getAnte(outcomeType, numAnswers)) + (extraLiquidity ?? 0)\n+  const ante =\n+    outcomeType === 'BOUNTIED_QUESTION' && totalBounty\n+      ? totalBounty\n+      : getAnte(outcomeType, numAnswers, liquidityTier)\n+  const totalMarketCost = ante + (extraLiquidity ?? 0)\n+  if (ante < 1) throw new APIError(400, 'Ante must be at least 1')\n \n-  if (unmodifiedAnte < 1) throw new APIError(400, 'Ante must be at least 1')\n-\n   const closeTime = await getCloseTimestamp(\n     closeTimeRaw,\n     question,\n     outcomeType,\n@@ -150,16 +151,8 @@\n \n   if (closeTime && closeTime < Date.now())\n     throw new APIError(400, 'Question must close in the future')\n \n-  const totalMarketCost = marketTier\n-    ? getTieredCost(unmodifiedAnte, marketTier, outcomeType)\n-    : unmodifiedAnte\n-  const ante =\n-    outcomeType === 'MULTIPLE_CHOICE' && !shouldAnswersSumToOne\n-      ? totalMarketCost\n-      : Math.min(unmodifiedAnte, totalMarketCost)\n-\n   const duplicateSubmissionUrl = await getDuplicateSubmissionUrl(\n     idempotencyKey,\n     pg\n   )\n@@ -218,9 +211,8 @@\n           answerImageUrls,\n           addAnswersMode,\n           shouldAnswersSumToOne,\n           isAutoBounty,\n-          marketTier,\n           token: 'MANA',\n           sportsStartTimestamp,\n           sportsEventId,\n           sportsLeague,\n@@ -330,9 +322,10 @@\n     groupIds,\n     visibility = 'public',\n     isTwitchContract,\n     utcOffset,\n-    marketTier,\n+    extraLiquidity,\n+    liquidityTier,\n     idempotencyKey,\n     sportsStartTimestamp,\n     sportsEventId,\n     sportsLeague,\n@@ -354,15 +347,14 @@\n     answerImageUrls: string[] | undefined,\n     addAnswersMode: add_answers_mode | undefined,\n     shouldAnswersSumToOne: boolean | undefined,\n     totalBounty: number | undefined,\n-    isAutoBounty: boolean | undefined,\n-    extraLiquidity: number | undefined\n+    isAutoBounty: boolean | undefined\n \n   if (outcomeType === 'PSEUDO_NUMERIC') {\n     const parsed = validateMarketType(outcomeType, createNumericSchema, body)\n \n-    ;({ min, max, isLogScale, extraLiquidity } = parsed)\n+    ;({ min, max, isLogScale } = parsed)\n     const { initialValue } = parsed\n \n     if (max - min <= 0.01)\n       throw new APIError(400, 'Max must be greater than min by more than 0.01')\n@@ -385,9 +377,9 @@\n \n   if (outcomeType === 'BINARY') {\n     const parsed = validateMarketType(outcomeType, createBinarySchema, body)\n \n-    ;({ initialProb, extraLiquidity } = parsed)\n+    ;({ initialProb } = parsed)\n   }\n   if (outcomeType === 'NUMBER') {\n     if (!MULTI_NUMERIC_CREATION_ENABLED)\n       throw new APIError(\n@@ -420,9 +412,8 @@\n       answerShortTexts,\n       answerImageUrls,\n       addAnswersMode,\n       shouldAnswersSumToOne,\n-      extraLiquidity,\n     } = validateMarketType(outcomeType, createMultiSchema, body))\n     if (answers.length < 2 && addAnswersMode === 'DISABLED')\n       throw new APIError(\n         400,\n@@ -463,9 +454,9 @@\n     addAnswersMode,\n     shouldAnswersSumToOne,\n     totalBounty,\n     isAutoBounty,\n-    marketTier,\n+    liquidityTier,\n     idempotencyKey,\n     sportsStartTimestamp,\n     sportsEventId,\n     sportsLeague,\n"
        },
        {
          "path": "backend/api/src/get-site-activity.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/get-site-activity.ts\n===================================================================\n--- backend/api/src/get-site-activity.ts\t262f7eb (parent)\n+++ backend/api/src/get-site-activity.ts\t13133e3 (commit)\n@@ -10,9 +10,14 @@\n // todo: personalization based on followed users & topics\n export const getSiteActivity: APIHandler<'get-site-activity'> = async (\n   props\n ) => {\n-  const { limit, offset = 0, blockedGroupSlugs = [], blockedContractIds = [] } = props\n+  const {\n+    limit,\n+    offset = 0,\n+    blockedGroupSlugs = [],\n+    blockedContractIds = [],\n+  } = props\n   log('getSiteActivity called', { limit })\n \n   const blockedUserIds = [\n     'FDWTsTHFytZz96xmcKzf7S5asYL2', // yunabot (does a lot of manual trades)\n@@ -67,9 +72,8 @@\n       ),\n       pg.manyOrNone(\n         `select * from contracts\n        where visibility = 'public'\n-       and tier != 'play'\n        and creator_id != all($1)\n        and id != all($2)\n        and not exists (\n          select 1 from group_contracts gc\n"
        },
        {
          "path": "backend/api/src/remove-liquidity.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/remove-liquidity.ts\n===================================================================\n--- backend/api/src/remove-liquidity.ts\t262f7eb (parent)\n+++ backend/api/src/remove-liquidity.ts\t13133e3 (commit)\n@@ -1,6 +1,5 @@\n import { removeCpmmLiquidity } from 'common/calculate-cpmm'\n-import { getTierFromLiquidity } from 'common/tier'\n import { formatMoneyWithDecimals } from 'common/util/format'\n import { runTransactionWithRetries } from 'shared/transact-with-retries'\n import { updateContract } from 'shared/supabase/contracts'\n import { FieldVal } from 'shared/supabase/utils'\n@@ -66,12 +65,8 @@\n \n     await updateContract(pgTrans, contractId, {\n       subsidyPool: FieldVal.increment(-takeFromPending),\n       totalLiquidity: FieldVal.increment(-totalAmount),\n-      marketTier: getTierFromLiquidity(\n-        contract,\n-        contract.totalLiquidity - totalAmount\n-      ),\n     })\n \n     await runTxnInBetQueue(pgTrans, {\n       fromType: 'CONTRACT',\n"
        },
        {
          "path": "backend/api/src/search-contracts.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/search-contracts.ts\n===================================================================\n--- backend/api/src/search-contracts.ts\t262f7eb (parent)\n+++ backend/api/src/search-contracts.ts\t13133e3 (commit)\n@@ -13,9 +13,8 @@\n import { convertContract } from 'common/supabase/contracts'\n import { log } from 'shared/utils'\n import { toLiteMarket } from 'common/api/market-types'\n import { searchProps } from 'common/api/market-search-types'\n-import { TierParamsType } from 'common/tier'\n \n export const searchMarketsLite: APIHandler<'search-markets'> = async (\n   props,\n   auth\n@@ -44,9 +43,8 @@\n     limit,\n     topicSlug: possibleTopicSlug,\n     forYou,\n     creatorId,\n-    marketTier,\n     token,\n     gids: groupIds,\n   } = props\n   const isPrizeMarket =\n@@ -81,9 +79,8 @@\n           limit,\n           offset,\n           sort,\n           isPrizeMarket,\n-          marketTier as TierParamsType,\n           token,\n           undefined,\n           creatorId\n         ),\n@@ -99,9 +96,8 @@\n         offset,\n         sort,\n         isPrizeMarket,\n         token,\n-        marketTier: marketTier as TierParamsType,\n       })\n       return await pg.map(forYouSql, [term], (r) => convertContract(r))\n     }\n   } else if (isRecent && !term && userId) {\n@@ -136,9 +132,8 @@\n           searchType,\n           isPrizeMarket,\n           token,\n           groupIds,\n-          marketTier: marketTier as TierParamsType,\n         })\n       )\n       .join(';')\n \n"
        },
        {
          "path": "backend/scripts/decrease-deposits-for-created-answers.ts",
          "status": "deleted",
          "diff": "Index: backend/scripts/decrease-deposits-for-created-answers.ts\n===================================================================\n--- backend/scripts/decrease-deposits-for-created-answers.ts\t262f7eb (parent)\n+++ backend/scripts/decrease-deposits-for-created-answers.ts\t13133e3 (commit)\n@@ -1,32 +0,0 @@\n-import { FieldValue } from 'firebase-admin/firestore'\n-import { runScript } from './run-script'\n-\n-import { getTieredAnswerCost } from 'common/tier'\n-\n-if (require.main === module) {\n-  runScript(async ({ pg, firestore }) => {\n-    const createdAnswers = await pg.manyOrNone(`\n-      select answers.* from answers\n-      join contracts on answers.contract_id = contracts.id\n-      where answers.created_time > (contracts.created_time + interval '5 seconds')\n-    `)\n-\n-    console.log('createdAnswers', createdAnswers)\n-\n-    const answerCost = getTieredAnswerCost(undefined)\n-    for (const answer of createdAnswers) {\n-      console.log(\n-        'decrease deposits for user',\n-        answer.user_id,\n-        'by',\n-        answerCost\n-      )\n-      await firestore\n-        .collection('users')\n-        .doc(answer.user_id)\n-        .update({\n-          totalDeposits: FieldValue.increment(-answerCost),\n-        })\n-    }\n-  })\n-}\n"
        },
        {
          "path": "backend/scripts/shift-tiers/backfill-tier-column.sql",
          "status": "deleted",
          "diff": "Index: backend/scripts/shift-tiers/backfill-tier-column.sql\n===================================================================\n--- backend/scripts/shift-tiers/backfill-tier-column.sql\t262f7eb (parent)\n+++ backend/scripts/shift-tiers/backfill-tier-column.sql\t13133e3 (commit)\n@@ -1,53 +0,0 @@\n--- Create a function to update contracts in batches\n-drop function if exists update_contract_tiers_efficient (batch_size integer, start_time timestamp);\n-\n-create\n-or replace function update_contract_tiers_efficient (batch_size integer, start_time timestamp) returns table (\n-  updated_count integer,\n-  last_updated_time timestamp\n-) as $$\n-DECLARE\n-  batch_updated INTEGER;\n-  last_updated_timestamp TIMESTAMP;\n-BEGIN\n-  WITH to_update AS (\n-    SELECT \n-      id, \n-      created_time,\n-      get_tier_from_liquidity_efficient(\n-        outcome_type, \n-        CASE WHEN data ? 'answers' THEN jsonb_array_length(data->'answers') ELSE NULL END,\n-        COALESCE((data->>'totalLiquidity')::NUMERIC, 0)\n-      ) AS new_tier\n-    FROM contracts\n-    -- WHERE created_time > start_time\n-    WHERE token = 'CASH'    -- Added condition\n-    AND tier IS NULL      -- Added condition\n-    AND (data->>'totalLiquidity' IS NOT NULL)\n-    ORDER BY created_time\n-    LIMIT batch_size\n-  )\n-  UPDATE contracts c\n-  SET data = c.data || jsonb_build_object('marketTier', tu.new_tier)\n-  FROM to_update tu\n-  WHERE c.id = tu.id\n-  AND (c.tier IS DISTINCT FROM tu.new_tier OR c.tier IS NULL);\n-\n-  GET DIAGNOSTICS batch_updated = ROW_COUNT;\n-  \n-  IF batch_updated > 0 THEN\n-    SELECT created_time INTO last_updated_timestamp\n-    FROM contracts\n-    WHERE created_time > start_time\n-    ORDER BY created_time\n-    LIMIT 1 OFFSET (batch_size - 1);\n-  ELSE\n-    last_updated_timestamp := start_time;\n-  END IF;\n-\n-  RETURN QUERY SELECT batch_updated, last_updated_timestamp;\n-END;\n-$$ language plpgsql;\n-\n--- Commit the transaction to save the functions\n-commit;\n"
        },
        {
          "path": "backend/scripts/shift-tiers/get-tier-from-liquidity-function.sql",
          "status": "deleted",
          "diff": "Index: backend/scripts/shift-tiers/get-tier-from-liquidity-function.sql\n===================================================================\n--- backend/scripts/shift-tiers/get-tier-from-liquidity-function.sql\t262f7eb (parent)\n+++ backend/scripts/shift-tiers/get-tier-from-liquidity-function.sql\t13133e3 (commit)\n@@ -1,48 +0,0 @@\n--- Create a more efficient function to get the tier from liquidity\n-create\n-or replace function get_tier_from_liquidity_efficient (\n-  outcome_type text,\n-  num_answers integer,\n-  liquidity numeric\n-) returns text as $$\n-DECLARE\n-  ante NUMERIC;\n-  tier_liquidity NUMERIC;\n-  fixed_ante CONSTANT NUMERIC := 1000;\n-  multiple_choice_minimum_cost CONSTANT NUMERIC := 1000;\n-BEGIN\n-  IF outcome_type IN ('POLL', 'BOUNTIED_QUESTION') THEN\n-    RETURN NULL;\n-  END IF;\n-\n-  ante := CASE outcome_type\n-    WHEN 'BINARY' THEN fixed_ante\n-    WHEN 'MULTIPLE_CHOICE' THEN GREATEST(fixed_ante / 10 * COALESCE(num_answers, 0), multiple_choice_minimum_cost)\n-    WHEN 'FREE_RESPONSE' THEN fixed_ante / 10\n-    WHEN 'PSEUDO_NUMERIC' THEN fixed_ante * 2.5\n-    WHEN 'STONK' THEN fixed_ante\n-    WHEN 'NUMBER' THEN fixed_ante * 10\n-    ELSE fixed_ante\n-  END;\n-\n-  -- Special handling for NUMBER type\n-IF outcome_type = 'NUMBER' THEN\n-  IF liquidity >= (ante * 10) THEN \n-    RETURN 'crystal';\n-  ELSIF liquidity >= ante THEN \n-    RETURN 'premium';\n-  ELSIF liquidity >= (ante / 10) THEN \n-    RETURN 'plus';\n-  ELSE \n-    RETURN 'play';\n-  END IF;\n-END IF;\n-\n-  -- For other types\n-  IF liquidity >= ante * 100 THEN RETURN 'crystal';\n-  ELSIF liquidity >= ante * 10 THEN RETURN 'premium';\n-  ELSIF liquidity >= ante  THEN RETURN 'plus';\n-  ELSE RETURN 'play';\n-  END IF;\n-END;\n-$$ language plpgsql immutable;\n"
        },
        {
          "path": "backend/shared/src/supabase/search-contracts.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/supabase/search-contracts.ts\n===================================================================\n--- backend/shared/src/supabase/search-contracts.ts\t262f7eb (parent)\n+++ backend/shared/src/supabase/search-contracts.ts\t13133e3 (commit)\n@@ -23,9 +23,8 @@\n } from 'shared/topic-interests'\n import { contractColumnsToSelect, log } from 'shared/utils'\n import { PrivateUser } from 'common/user'\n import { GROUP_SCORE_PRIOR } from 'common/feed'\n-import { MarketTierType, TierParamsType, tiers } from 'common/tier'\n import { tsToMillis } from 'common/supabase/utils'\n \n const DEFAULT_THRESHOLD = 1000\n type TokenInputType = 'CASH' | 'MANA' | 'ALL' | 'CASH_AND_MANA'\n@@ -40,9 +39,8 @@\n   offset: number\n   sort: 'score' | 'freshness-score'\n   isPrizeMarket: boolean\n   token: TokenInputType\n-  marketTier: TierParamsType\n   privateUser?: PrivateUser\n   threshold?: number\n }) {\n   const {\n@@ -51,9 +49,8 @@\n     limit,\n     offset,\n     sort,\n     isPrizeMarket,\n-    marketTier,\n     privateUser,\n     threshold = DEFAULT_THRESHOLD,\n     token,\n   } = items\n@@ -89,9 +86,8 @@\n       limit,\n       offset,\n       sort,\n       isPrizeMarket,\n-      marketTier,\n       token,\n       privateUser\n     )\n   }\n@@ -127,9 +123,8 @@\n         contractType,\n         uid: userId,\n         hideStonks: true,\n         isPrizeMarket,\n-        marketTier,\n         token,\n       }),\n       offset <= threshold / 2 &&\n         sort === 'score' &&\n@@ -165,9 +160,8 @@\n   limit: number,\n   offset: number,\n   sort: 'score' | 'freshness-score',\n   isPrizeMarket: boolean,\n-  marketTier: TierParamsType,\n   token: TokenInputType,\n   privateUser?: PrivateUser,\n   creatorId?: string\n ) => {\n@@ -181,9 +175,8 @@\n       contractType,\n       uid: userId,\n       hideStonks: true,\n       isPrizeMarket,\n-      marketTier,\n       token,\n       creatorId,\n     }),\n     privateUserBlocksSql(privateUser),\n@@ -210,9 +203,8 @@\n   uid?: string\n   isForYou?: boolean\n   searchType: SearchTypes\n   isPrizeMarket?: boolean\n-  marketTier: TierParamsType\n   token: TokenInputType\n   groupIds?: string\n }) {\n   const {\n@@ -316,9 +308,8 @@\n   hideStonks?: boolean\n   hideLove?: boolean\n   isPrizeMarket?: boolean\n   token: TokenInputType\n-  marketTier: TierParamsType\n }) {\n   const {\n     filter,\n     sort,\n@@ -327,9 +318,8 @@\n     uid,\n     hideStonks,\n     hideLove,\n     isPrizeMarket,\n-    marketTier,\n     token,\n   } = args\n   type FilterSQL = Record<string, string>\n   const filterSQL: FilterSQL = {\n@@ -372,19 +362,8 @@\n       : token === 'CASH_AND_MANA'\n       ? `data->>'siblingContractId' is not null`\n       : ''\n \n-  const tierFilters = tiers\n-    .map((tier: MarketTierType, index) =>\n-      marketTier[index] === '1' ? `tier = '${tier}'` : ''\n-    )\n-    .filter(Boolean)\n-\n-  const combinedTierFilter =\n-    tierFilters.length > 1\n-      ? `(${tierFilters.join(' OR ')})`\n-      : tierFilters[0] ?? ''\n-\n   return [\n     where(filterSQL[filter]),\n     where(stonkFilter),\n     where(loveFilter, [[PROD_MANIFOLD_LOVE_GROUP_SLUG]]),\n@@ -394,9 +373,8 @@\n     where(creatorFilter),\n     where(deletedFilter),\n     where(isPrizeMarketFilter),\n     where(tokenFilter),\n-    where(combinedTierFilter),\n   ]\n }\n \n type SortFields = Record<\n"
        },
        {
          "path": "backend/shared/src/topic-interests.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/topic-interests.ts\n===================================================================\n--- backend/shared/src/topic-interests.ts\t262f7eb (parent)\n+++ backend/shared/src/topic-interests.ts\t13133e3 (commit)\n@@ -116,9 +116,8 @@\n   buildArray(\n     where(`contracts.close_time > now()`),\n     where(`contracts.outcome_type != 'STONK'`),\n     where(`contracts.outcome_type != 'BOUNTIED_QUESTION'`),\n-    where(`contracts.tier != 'play'`), // filtering by liquidity takes too long\n     where(`contracts.visibility = 'public'`),\n     where(`contracts.unique_bettor_count > 1`)\n   )\n \n"
        },
        {
          "path": "backend/shared/src/weekly-markets-emails.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/weekly-markets-emails.ts\n===================================================================\n--- backend/shared/src/weekly-markets-emails.ts\t262f7eb (parent)\n+++ backend/shared/src/weekly-markets-emails.ts\t13133e3 (commit)\n@@ -96,9 +96,8 @@\n     limit: limit * 2,\n     offset: 0,\n     sort: 'score',\n     isPrizeMarket: false,\n-    marketTier: '00000',\n     privateUser,\n     token: 'ALL',\n     threshold: 200,\n   })\n"
        },
        {
          "path": "common/src/api/market-search-types.ts",
          "status": "modified",
          "diff": "Index: common/src/api/market-search-types.ts\n===================================================================\n--- common/src/api/market-search-types.ts\t262f7eb (parent)\n+++ common/src/api/market-search-types.ts\t13133e3 (commit)\n@@ -62,12 +62,8 @@\n         z.literal('1'),\n         z.literal('0'),\n       ])\n       .default('0'),\n-    marketTier: z\n-      .string()\n-      .regex(/^[01]{5}$/)\n-      .default('00000'),\n     token: z\n       .union([\n         z.literal('MANA'),\n         z.literal('CASH'),\n"
        },
        {
          "path": "common/src/api/market-types.ts",
          "status": "modified",
          "diff": "Index: common/src/api/market-types.ts\n===================================================================\n--- common/src/api/market-types.ts\t262f7eb (parent)\n+++ common/src/api/market-types.ts\t13133e3 (commit)\n@@ -12,9 +12,8 @@\n import { MINIMUM_BOUNTY } from 'common/economy'\n import { DOMAIN } from 'common/envs/constants'\n import { MAX_ID_LENGTH } from 'common/group'\n import { getMappedValue } from 'common/pseudo-numeric'\n-import { MarketTierType, tiers } from 'common/tier'\n import { removeUndefinedProps } from 'common/util/object'\n import { richTextToString } from 'common/util/parse'\n import { z } from 'zod'\n import { coerceBoolean, contentSchema } from './zod-types'\n@@ -58,9 +57,8 @@\n \n   uniqueBettorCount: number\n   lastUpdatedTime?: number\n   lastBetTime?: number\n-  marketTier?: MarketTierType\n   sportsStartTimestamp?: string\n   sportsEventId?: string\n   sportsLeague?: string\n }\n@@ -120,9 +118,8 @@\n     loverUserId1,\n     loverUserId2,\n     matchCreatorId,\n     isLove,\n-    marketTier,\n     token,\n     siblingContractId,\n   } = contract\n \n@@ -171,9 +168,8 @@\n     lastUpdatedTime,\n     lastBetTime,\n     lastCommentTime,\n     ...numericValues,\n-    marketTier,\n     token,\n     siblingContractId,\n \n     // Manifold love props.\n@@ -262,18 +258,16 @@\n \n export const createBinarySchema = z.object({\n   outcomeType: z.enum(['BINARY', 'STONK']),\n   initialProb: z.number().min(1).max(99).optional(),\n-  extraLiquidity: z.number().min(1).optional(),\n })\n \n export const createNumericSchema = z.object({\n   outcomeType: z.enum(['PSEUDO_NUMERIC']),\n   min: z.number().safe(),\n   max: z.number().safe(),\n   initialValue: z.number().safe(),\n   isLogScale: z.boolean().optional(),\n-  extraLiquidity: z.number().min(1).optional(),\n })\n \n export const createMultiSchema = z.object({\n   outcomeType: z.enum(['MULTIPLE_CHOICE']),\n@@ -289,9 +283,8 @@\n   addAnswersMode: z\n     .enum(['DISABLED', 'ONLY_CREATOR', 'ANYONE'])\n     .default('DISABLED'),\n   shouldAnswersSumToOne: z.boolean().optional(),\n-  extraLiquidity: z.number().min(1).optional(),\n })\n export const createMultiNumericSchema = z.object({\n   outcomeType: z.enum(['NUMBER']),\n   min: z.number().safe(),\n@@ -329,9 +322,10 @@\n     groupIds: z.array(z.string().min(1).max(MAX_ID_LENGTH)).optional(),\n     visibility: z.enum(VISIBILITIES).default('public').optional(),\n     isTwitchContract: z.boolean().optional(),\n     utcOffset: z.number().optional(),\n-    marketTier: z.enum(tiers).optional(),\n+    extraLiquidity: z.number().min(1).optional(),\n+    liquidityTier: z.number().min(0),\n     idempotencyKey: z.string().regex(randomStringRegex).length(10).optional(),\n     sportsStartTimestamp: z.string().optional(),\n     sportsEventId: z.string().optional(),\n     sportsLeague: z.string().optional(),\n"
        },
        {
          "path": "common/src/contract.ts",
          "status": "modified",
          "diff": "Index: common/src/contract.ts\n===================================================================\n--- common/src/contract.ts\t262f7eb (parent)\n+++ common/src/contract.ts\t13133e3 (commit)\n@@ -10,9 +10,8 @@\n import { CASH_SUFFIX, ENV_CONFIG } from './envs/constants'\n import { Fees } from './fees'\n import { PollOption } from './poll-option'\n import { formatMoney, formatPercent } from './util/format'\n-import { MarketTierType } from './tier'\n \n /************************************************\n \n supabase status: columns exist for\n@@ -91,10 +90,8 @@\n   isRanked?: boolean\n \n   gptCommentSummary?: string\n \n-  marketTier?: MarketTierType\n-\n   token: ContractToken\n   siblingContractId?: string\n \n   /** @deprecated - no longer used */\n"
        },
        {
          "path": "common/src/economy.ts",
          "status": "modified",
          "diff": "Index: common/src/economy.ts\n===================================================================\n--- common/src/economy.ts\t262f7eb (parent)\n+++ common/src/economy.ts\t13133e3 (commit)\n@@ -1,36 +1,29 @@\n import { OutcomeType } from 'common/contract'\n+import { answerCostTiers, liquidityTiers } from './tier'\n \n export const DEFAULT_CASH_ANTE = 50\n-\n-export const FIXED_ANTE = 1000\n-export const BASE_ANSWER_COST = FIXED_ANTE / 10\n-export const MIN_ANSWER_COST = 25\n-const ANTES = {\n-  BINARY: FIXED_ANTE,\n-  MULTIPLE_CHOICE: BASE_ANSWER_COST, // Amount per answer.\n-  FREE_RESPONSE: BASE_ANSWER_COST, // Amount per answer.\n-  PSEUDO_NUMERIC: FIXED_ANTE * 2.5,\n-  STONK: FIXED_ANTE,\n-  BOUNTIED_QUESTION: 0,\n-  POLL: FIXED_ANTE / 10,\n-  NUMBER: FIXED_ANTE * 10,\n-}\n-\n export const MINIMUM_BOUNTY = 1000\n-export const MULTIPLE_CHOICE_MINIMUM_COST = 1000\n \n export const getAnte = (\n   outcomeType: OutcomeType,\n-  numAnswers: number | undefined\n+  numAnswers: number | undefined,\n+  liquidityTier: number // this could be 100, 1000, 10000, 100000 (aka tiers)\n ) => {\n-  const ante = ANTES[outcomeType as keyof typeof ANTES] ?? FIXED_ANTE\n+  if (outcomeType === 'POLL') {\n+    return 10\n+  }\n \n   if (outcomeType === 'MULTIPLE_CHOICE') {\n-    return Math.max(ante * (numAnswers ?? 0), MULTIPLE_CHOICE_MINIMUM_COST)\n+    const tierIndex =\n+      liquidityTiers.findIndex((tier) => tier >= liquidityTier) ??\n+      liquidityTiers[liquidityTiers.length - 1]\n+    return numAnswers\n+      ? Math.max(numAnswers * answerCostTiers[tierIndex], liquidityTier)\n+      : liquidityTiers[tierIndex]\n   }\n \n-  return ante\n+  return liquidityTier\n }\n \n /* Sweeps bonuses */\n export const KYC_VERIFICATION_BONUS_CASH = 3\n"
        },
        {
          "path": "common/src/new-contract.ts",
          "status": "modified",
          "diff": "Index: common/src/new-contract.ts\n===================================================================\n--- common/src/new-contract.ts\t262f7eb (parent)\n+++ common/src/new-contract.ts\t13133e3 (commit)\n@@ -31,9 +31,8 @@\n     | 'description'\n     | 'closeTime'\n     | 'visibility'\n     | 'isTwitchContract'\n-    | 'marketTier'\n     | 'token'\n     | 'takerAPIOrdersDisabled'\n     | 'siblingContractId'\n     | 'coverImageUrl'\n@@ -83,9 +82,8 @@\n     addAnswersMode,\n     shouldAnswersSumToOne,\n     coverImageUrl,\n     isAutoBounty,\n-    marketTier,\n     token,\n     sportsStartTimestamp,\n     sportsEventId,\n     sportsLeague,\n@@ -160,9 +158,8 @@\n       platformFee: 0,\n     },\n \n     isTwitchContract,\n-    marketTier,\n     token,\n \n     sportsStartTimestamp,\n     sportsEventId,\n"
        },
        {
          "path": "common/src/tier.ts",
          "status": "modified",
          "diff": "Index: common/src/tier.ts\n===================================================================\n--- common/src/tier.ts\t262f7eb (parent)\n+++ common/src/tier.ts\t13133e3 (commit)\n@@ -1,74 +1,17 @@\n-import {\n-  CREATEABLE_NON_PREDICTIVE_OUTCOME_TYPES,\n-  MarketContract,\n-  OutcomeType,\n-} from './contract'\n-import { BASE_ANSWER_COST, getAnte, MIN_ANSWER_COST } from './economy'\n+export const liquidityTiers = [100, 1_000, 10_000, 100_000] as const\n+export const answerCostTiers = [25, 100, 1000, 10000] as const\n \n-// Array of tiers in order\n-export const tiers = ['play', 'plus', 'premium', 'crystal'] as const\n-\n export type BinaryDigit = '0' | '1'\n \n-export type TierParamsType =\n-  `${BinaryDigit}${BinaryDigit}${BinaryDigit}${BinaryDigit}${BinaryDigit}`\n-\n-// Derive the MarketTierType from the array\n-export type MarketTierType = (typeof tiers)[number]\n-\n-export const getTieredAnswerCost = (marketTier: MarketTierType | undefined) => {\n-  return marketTier\n-    ? Math.max(\n-        BASE_ANSWER_COST * 10 ** (tiers.indexOf(marketTier) - 1),\n-        MIN_ANSWER_COST\n-      )\n-    : BASE_ANSWER_COST\n+export function getTierFromLiquidity(liquidity: number): number {\n+  return liquidityTiers.findIndex((tier) => tier >= liquidity)\n }\n \n-export const getTieredCost = (\n-  baseCost: number,\n-  tier: MarketTierType | undefined,\n-  outcomeType: OutcomeType\n-) => {\n-  if (CREATEABLE_NON_PREDICTIVE_OUTCOME_TYPES.includes(outcomeType)) {\n-    return baseCost\n-  }\n-\n-  const tieredCost = tier\n-    ? baseCost * 10 ** (tiers.indexOf(tier) - 1)\n-    : baseCost\n-\n-  if (outcomeType == 'NUMBER' && tier != 'play') {\n-    return tieredCost / 10\n-  }\n-\n-  return tieredCost\n+export function getAnswerCostFromLiquidity(\n+  liquidity: number,\n+  numAnswers: number\n+): number {\n+  return answerCostTiers[\n+    liquidityTiers.findIndex((tier) => tier >= liquidity / numAnswers)\n+  ]\n }\n-\n-// For multi & mumeric markets this can only get the current tier, not back-calculate\n-export function getTierFromLiquidity(\n-  contract: MarketContract,\n-  liquidity: number\n-): MarketTierType {\n-  const { outcomeType } = contract\n-\n-  let numAnswers = undefined\n-  if ('answers' in contract) {\n-    numAnswers = contract.answers.length\n-  }\n-\n-  const ante = getAnte(outcomeType, numAnswers)\n-\n-  // Iterate through the tiers from highest to lowest\n-  for (let i = tiers.length - 1; i >= 0; i--) {\n-    const tier = tiers[i]\n-    const tierLiquidity = getTieredCost(ante, tier, outcomeType)\n-\n-    // Return the first tier where the liquidity is greater or equal to the tier's requirement\n-    if (liquidity >= tierLiquidity) {\n-      return tier as MarketTierType\n-    }\n-  }\n-  // Default to the lowest tier if none of the conditions are met\n-  return 'play'\n-}\n"
        },
        {
          "path": "web/components/answers/create-answer-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/answers/create-answer-panel.tsx\n===================================================================\n--- web/components/answers/create-answer-panel.tsx\t262f7eb (parent)\n+++ web/components/answers/create-answer-panel.tsx\t13133e3 (commit)\n@@ -1,9 +1,9 @@\n import { ChevronDownIcon, XCircleIcon } from '@heroicons/react/solid'\n import clsx from 'clsx'\n import { MultiSort } from 'common/answer'\n import { MultiContract, SORTS } from 'common/contract'\n-import { getTieredAnswerCost, getTierFromLiquidity } from 'common/tier'\n+import { getAnswerCostFromLiquidity } from 'common/tier'\n import { useLayoutEffect, useRef, useState } from 'react'\n import { FaSearch, FaSearchPlus } from 'react-icons/fa'\n import { api } from 'web/lib/api/api'\n import { withTracking } from 'web/lib/service/analytics'\n@@ -142,14 +142,11 @@\n                 >\n                   <span className=\"font-semibold\">Add</span>\n                   <span className=\"text-ink-200 dark:text-ink-800 ml-1\">\n                     <MoneyDisplay\n-                      amount={getTieredAnswerCost(\n-                        contract.marketTier ??\n-                          getTierFromLiquidity(\n-                            contract,\n-                            contract.totalLiquidity\n-                          )\n+                      amount={getAnswerCostFromLiquidity(\n+                        contract.totalLiquidity,\n+                        contract.answers.length\n                       )}\n                       isCashContract={isCashContract}\n                     />\n                   </span>\n"
        },
        {
          "path": "web/components/bet/bet-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/bet/bet-panel.tsx\n===================================================================\n--- web/components/bet/bet-panel.tsx\t262f7eb (parent)\n+++ web/components/bet/bet-panel.tsx\t13133e3 (commit)\n@@ -236,11 +236,9 @@\n   } = props\n \n   const user = useUser()\n   const privateUser = usePrivateUser()\n-  const marketTier =\n-    contract.marketTier ??\n-    getTierFromLiquidity(contract, contract.totalLiquidity)\n+  const liquidityTier = getTierFromLiquidity(contract.totalLiquidity)\n \n   const { unfilledBets: allUnfilledBets, balanceByUserId } =\n     useUnfilledBetsAndBalanceByUserId(\n       contract.id,\n@@ -264,11 +262,11 @@\n       : undefined\n   const isCashContract = contract.token === 'CASH'\n \n   const quickAddButtonSize =\n-    marketTier === 'play' ||\n+    liquidityTier === 0 ||\n     (contract.mechanism === 'cpmm-multi-1' &&\n-      contract.marketTier === 'plus' &&\n+      liquidityTier === 1 &&\n       !contract.shouldAnswersSumToOne)\n       ? 'small'\n       : undefined\n \n"
        },
        {
          "path": "web/components/contract/upgrade-tier-button.tsx",
          "status": "deleted",
          "diff": "Index: web/components/contract/upgrade-tier-button.tsx\n===================================================================\n--- web/components/contract/upgrade-tier-button.tsx\t262f7eb (parent)\n+++ web/components/contract/upgrade-tier-button.tsx\t13133e3 (commit)\n@@ -1,260 +0,0 @@\n-import clsx from 'clsx'\n-import { CreateableOutcomeType, MarketContract } from 'common/contract'\n-import {\n-  MarketTierType,\n-  getTierFromLiquidity,\n-  tiers,\n-  getTieredCost,\n-} from 'common/tier'\n-import { ReactNode, useState } from 'react'\n-import { CrystalTier } from 'web/public/custom-components/tiers'\n-import { Button } from '../buttons/button'\n-import { Col } from '../layout/col'\n-import { Modal } from '../layout/modal'\n-import { Title } from '../widgets/title'\n-import { AddLiquidityControl } from './liquidity-modal'\n-import { getAnte } from 'common/economy'\n-import { TokenNumber } from '../widgets/token-number'\n-import { TierIcon, getPresentedTierName } from '../tiers/liquidity-tooltip'\n-import { api } from 'web/lib/api/api'\n-import { useUser } from 'web/hooks/use-user'\n-import { ENV_CONFIG } from 'common/envs/constants'\n-import { AddFundsModal } from '../add-funds-modal'\n-import { track } from 'web/lib/service/analytics'\n-import toast from 'react-hot-toast'\n-\n-export function UpgradeTierButton(props: {\n-  contract: MarketContract\n-  className?: string\n-}) {\n-  const { contract, className } = props\n-  const [open, setOpen] = useState(false)\n-\n-  const disabled =\n-    contract.isResolved ||\n-    (contract.closeTime ?? Infinity) < Date.now() ||\n-    contract.visibility !== 'public'\n-\n-  if (disabled) return <></>\n-\n-  const alreadyHighestTier =\n-    contract.marketTier === 'crystal' ||\n-    getTierFromLiquidity(contract, contract.totalLiquidity) === 'crystal'\n-\n-  return (\n-    <Button\n-      onClick={() => setOpen(true)}\n-      size=\"lg\"\n-      color=\"indigo-outline\"\n-      className={clsx(className, 'group')}\n-    >\n-      <CrystalTier className=\"mr-2 h-5 w-5\" />\n-      {alreadyHighestTier ? 'Add liquidity' : 'Upgrade'}\n-      <AddLiquidityDialogue\n-        contract={contract}\n-        isOpen={open}\n-        setOpen={setOpen}\n-      />\n-    </Button>\n-  )\n-}\n-\n-export function AddLiquidityDialogue(props: {\n-  contract: MarketContract\n-  isOpen: boolean\n-  setOpen: (open: boolean) => void\n-}) {\n-  const { contract, isOpen, setOpen } = props\n-  const { outcomeType } = contract\n-\n-  let numAnswers = undefined\n-  if ('answers' in contract) {\n-    numAnswers = contract.answers.length\n-  }\n-  const ante = getAnte(outcomeType, numAnswers)\n-\n-  const currentTier =\n-    contract.marketTier ??\n-    getTierFromLiquidity(contract, contract.totalLiquidity)\n-  const currentTierIndex = tiers.indexOf(currentTier)\n-  const alreadyHighestTier = currentTier === 'crystal'\n-\n-  const [amount, setAmount] = useState<number | undefined>(\n-    alreadyHighestTier\n-      ? 1000\n-      : getTieredCost(ante, tiers[currentTierIndex + 1], outcomeType) -\n-          contract.totalLiquidity\n-  )\n-\n-  return (\n-    <Modal open={isOpen} setOpen={setOpen} size=\"sm\">\n-      <Col className=\"bg-canvas-0 gap-2.5  rounded p-4 pb-8 sm:gap-4\">\n-        <Title className=\"!mb-2\">\n-          {alreadyHighestTier ? 'Add liquidity' : 'Upgrade Tier'}\n-        </Title>\n-        {alreadyHighestTier ? (\n-          <AddLiquidityControl\n-            contract={contract}\n-            amount={amount}\n-            setAmount={setAmount}\n-          />\n-        ) : (\n-          <UpgradeTierContent\n-            currentTierIndex={currentTierIndex}\n-            contract={contract}\n-            ante={ante}\n-            amount={amount}\n-            setAmount={setAmount}\n-            setOpen={setOpen}\n-          />\n-        )}\n-      </Col>\n-    </Modal>\n-  )\n-}\n-\n-function UpgradeTierContent(props: {\n-  currentTierIndex: number\n-  contract: MarketContract\n-  ante: number\n-  amount: number | undefined\n-  setAmount: (amount: number | undefined) => void\n-  setOpen: (open: boolean) => void\n-}) {\n-  const { currentTierIndex, contract, ante, amount, setAmount, setOpen } = props\n-  const { outcomeType, id: contractId, slug } = contract\n-  const totalOptions = tiers.length - 1 - currentTierIndex\n-\n-  const [error, setError] = useState<string | undefined>(undefined)\n-  const [isLoading, setIsLoading] = useState(false)\n-\n-  const submit = async () => {\n-    if (!amount) return\n-\n-    setIsLoading(true)\n-\n-    try {\n-      await api('market/:contractId/add-liquidity', {\n-        amount,\n-        contractId,\n-      })\n-      setError(undefined)\n-      track('upgrade market', { amount, contractId, slug })\n-      setOpen(false)\n-      toast('Your market has been upgraded!', {\n-        icon: '🚀',\n-      })\n-    } catch (e) {\n-      setError('Server error')\n-    } finally {\n-      setIsLoading(false)\n-    }\n-  }\n-\n-  const user = useUser()\n-  const [fundsModalOpen, setFundsModalOpen] = useState(false)\n-\n-  const notEnoughFunds = !!user && !!amount && user.balance < amount\n-\n-  return (\n-    <>\n-      <div\n-        className={clsx(\n-          'w-full gap-2',\n-          totalOptions > 2 ? 'grid grid-cols-2' : 'flex flex-row'\n-        )}\n-      >\n-        {tiers.slice(currentTierIndex + 1).map((tier) => (\n-          <UpgradeTier\n-            key={tier}\n-            contract={contract}\n-            baseCost={ante}\n-            icon={<TierIcon tier={tier} />}\n-            tier={tier}\n-            outcomeType={outcomeType}\n-            currentAmount={amount}\n-            onClick={(upgradeCost) => setAmount(upgradeCost)}\n-          />\n-        ))}\n-      </div>\n-      <Button\n-        disabled={isLoading || !!error || !amount || notEnoughFunds}\n-        onClick={submit}\n-        loading={isLoading}\n-      >\n-        Upgrade{' '}\n-        {amount &&\n-          `to ${getTierFromLiquidity(\n-            contract,\n-            amount + contract.totalLiquidity\n-          )}`}\n-      </Button>\n-      {notEnoughFunds && (\n-        <div className=\"mb-2 mr-auto mt-2 self-center whitespace-nowrap text-xs font-medium tracking-wide\">\n-          <span className=\"text-scarlet-500 mr-2\">Insufficient balance</span>\n-          <Button\n-            size=\"xs\"\n-            color=\"green\"\n-            onClick={() => setFundsModalOpen(true)}\n-          >\n-            Get {ENV_CONFIG.moneyMoniker}\n-          </Button>\n-          <AddFundsModal open={fundsModalOpen} setOpen={setFundsModalOpen} />\n-        </div>\n-      )}\n-    </>\n-  )\n-}\n-\n-function UpgradeTier(props: {\n-  contract: MarketContract\n-  baseCost: number\n-  icon: ReactNode\n-  tier: MarketTierType\n-  outcomeType: CreateableOutcomeType\n-  onClick: (upgradeCost: number) => void\n-  currentAmount?: number\n-}) {\n-  const {\n-    contract,\n-    baseCost,\n-    icon,\n-    tier,\n-    outcomeType,\n-    onClick,\n-    currentAmount,\n-  } = props\n-\n-  const additionalAmount =\n-    getTieredCost(baseCost, tier, outcomeType) - contract.totalLiquidity\n-  return (\n-    <Col\n-      className={clsx(\n-        currentAmount == additionalAmount\n-          ? tier == 'play'\n-            ? 'outline-ink-500'\n-            : tier == 'plus'\n-            ? 'outline-blue-500'\n-            : tier == 'premium'\n-            ? 'outline-purple-400'\n-            : 'outline-pink-500'\n-          : tier == 'play'\n-          ? 'hover:outline-ink-500/50 opacity-50 outline-transparent'\n-          : tier == 'plus'\n-          ? 'opacity-50 outline-transparent hover:outline-purple-500/50'\n-          : tier == 'premium'\n-          ? 'opacity-50 outline-transparent hover:outline-fuchsia-400/50'\n-          : 'opacity-50 outline-transparent hover:outline-pink-500/50',\n-        'bg-canvas-50 w-full cursor-pointer select-none items-center rounded px-4 py-2 outline transition-colors'\n-      )}\n-      onClick={() => onClick(additionalAmount)}\n-    >\n-      <div className=\"text-4xl sm:text-5xl\">{icon}</div>\n-      <div className=\"text-ink-600\">{getPresentedTierName(tier)}</div>\n-      <TokenNumber\n-        className=\"text-xl font-semibold\"\n-        amount={additionalAmount}\n-      />\n-    </Col>\n-  )\n-}\n"
        },
        {
          "path": "web/components/new-contract/contract-params-form.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/contract-params-form.tsx\n===================================================================\n--- web/components/new-contract/contract-params-form.tsx\t262f7eb (parent)\n+++ web/components/new-contract/contract-params-form.tsx\t13133e3 (commit)\n@@ -5,9 +5,8 @@\n \n import {\n   add_answers_mode,\n   Contract,\n-  CREATEABLE_NON_PREDICTIVE_OUTCOME_TYPES,\n   CreateableOutcomeType,\n   MAX_DESCRIPTION_LENGTH,\n   MAX_QUESTION_LENGTH,\n   MULTI_NUMERIC_BUCKETS_MAX,\n@@ -65,29 +64,25 @@\n import { PseudoNumericRangeSection } from 'web/components/new-contract/pseudo-numeric-range-section'\n import { SimilarContractsSection } from 'web/components/new-contract/similar-contracts-section'\n import { MultiNumericRangeSection } from 'web/components/new-contract/multi-numeric-range-section'\n import { getMultiNumericAnswerBucketRangeNames } from 'common/multi-numeric'\n-import { getTieredCost, MarketTierType } from 'common/tier'\n import { randomString } from 'common/util/random'\n import { formatWithToken } from 'common/util/format'\n import { BiUndo } from 'react-icons/bi'\n+import { liquidityTiers } from 'common/tier'\n \n export function ContractParamsForm(props: {\n   creator: User\n   outcomeType: CreateableOutcomeType\n   params?: Partial<NewQuestionParams>\n }) {\n   const { creator, params, outcomeType } = props\n-  const DEFAULT_TIER = CREATEABLE_NON_PREDICTIVE_OUTCOME_TYPES.includes(\n-    outcomeType\n+\n+  const [liquidityTier, setLiquidityTier] = usePersistentLocalState<number>(\n+    liquidityTiers[0],\n+    'liquidity-tier'\n   )\n-    ? undefined\n-    : 'play'\n \n-  const [marketTier, setMarketTier] = usePersistentLocalState<\n-    MarketTierType | undefined\n-  >(DEFAULT_TIER, 'market-tier')\n-\n   const paramsKey =\n     (params?.q ?? '') +\n     (params?.groupSlugs?.join('') ?? '') +\n     (params?.groupIds?.join('') ?? '')\n@@ -232,10 +227,8 @@\n   const dismissedSimilarContractsKey = 'dismissed-similar-contracts'\n   const [dismissedSimilarContractTitles, setDismissedSimilarContractTitles] =\n     usePersistentInMemoryState<string[]>([], dismissedSimilarContractsKey)\n \n-  const ante = getAnte(outcomeType, numAnswers)\n-\n   const timeInMs = params?.closeTime ? Number(params.closeTime) : undefined\n   const initDate = (timeInMs ? dayjs(timeInMs) : dayjs().add(7, 'day')).format(\n     'YYYY-MM-DD'\n   )\n@@ -271,13 +264,8 @@\n   )\n \n   const { balance } = creator\n \n-  const anteOrBounty =\n-    outcomeType === 'BOUNTIED_QUESTION'\n-      ? bountyAmount ?? defaultBountyAmount\n-      : ante\n-\n   const closeTime = closeDate\n     ? dayjs(`${closeDate}T${closeHoursMinutes}`).valueOf()\n     : undefined\n \n@@ -326,20 +314,17 @@\n     // closeTime must be in the future\n     !shouldHaveCloseDate || (closeTime ?? Infinity) > Date.now()\n \n   const isValidTopics = selectedGroups.length <= MAX_GROUPS_PER_MARKET\n-\n+  const ante = getAnte(outcomeType, numAnswers, liquidityTier)\n   const numberOfBuckets = getMultiNumericAnswerBucketRangeNames(\n     min ?? 0,\n     max ?? 0,\n     precision && precision > 0 ? precision : 1\n   ).length\n   const isValid =\n     isValidQuestion &&\n-    ante !== undefined &&\n-    ante !== null &&\n-    // Disabled while it doesn't account for play tier (ante is 10x actual play cost)\n-    // ante <= balance &&\n+    ante <= balance &&\n     isValidDate &&\n     isValidTopics &&\n     (outcomeType !== 'PSEUDO_NUMERIC' ||\n       (min !== undefined &&\n@@ -452,9 +437,9 @@\n         totalBounty: bountyAmount,\n         isAutoBounty:\n           outcomeType === 'BOUNTIED_QUESTION' ? isAutoBounty : undefined,\n         precision,\n-        marketTier,\n+        liquidityTier,\n         idempotencyKey,\n         sportsStartTimestamp: params?.sportsStartTimestamp,\n         sportsEventId: params?.sportsEventId,\n         sportsLeague: params?.sportsLeague,\n@@ -748,12 +733,12 @@\n         />\n       </Row>\n       <CostSection\n         balance={balance}\n-        baseCost={anteOrBounty}\n+        numAnswers={numAnswers}\n         outcomeType={outcomeType}\n-        marketTier={marketTier}\n-        setMarketTier={setMarketTier}\n+        liquidityTier={liquidityTier}\n+        setLiquidityTier={setLiquidityTier}\n       />\n       {errorText && <span className={'text-error'}>{errorText}</span>}\n       <Button\n         className=\"w-full\"\n@@ -772,9 +757,9 @@\n         }}\n       >\n         {submitState === 'EDITING'\n           ? `Create question for ${formatWithToken({\n-              amount: getTieredCost(anteOrBounty, marketTier, outcomeType),\n+              amount: ante,\n               short: true,\n               token: 'M$',\n             })}`\n           : submitState === 'LOADING'\n"
        },
        {
          "path": "web/components/new-contract/cost-section.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/cost-section.tsx\n===================================================================\n--- web/components/new-contract/cost-section.tsx\t262f7eb (parent)\n+++ web/components/new-contract/cost-section.tsx\t13133e3 (commit)\n@@ -1,70 +1,32 @@\n import {\n   CREATEABLE_NON_PREDICTIVE_OUTCOME_TYPES,\n   CreateableOutcomeType,\n } from 'common/contract'\n-import { ReactNode, useState } from 'react'\n+import { useState } from 'react'\n import { Col } from 'web/components/layout/col'\n \n import clsx from 'clsx'\n import { ENV_CONFIG } from 'common/envs/constants'\n import { AddFundsModal } from 'web/components/add-funds-modal'\n import { Button } from 'web/components/buttons/button'\n-import {\n-  CrystalTier,\n-  PlayTier,\n-  PlusTier,\n-  PremiumTier,\n-} from 'web/public/custom-components/tiers'\n+\n import { TokenNumber } from '../widgets/token-number'\n-import { getTieredCost, MarketTierType } from 'common/tier'\n-import { getPresentedTierName } from '../tiers/liquidity-tooltip'\n-import { ManaCoin } from 'web/public/custom-components/manaCoin'\n-import { getContractTypeFromValue } from './create-contract-types'\n-import { InfoTooltip } from '../widgets/info-tooltip'\n-import { capitalize } from 'lodash'\n+import { liquidityTiers } from 'common/tier'\n+import { getAnte } from 'common/economy'\n \n-type TIER_TYPE = { name: MarketTierType; icon: ReactNode }\n-\n-export const TIERS: TIER_TYPE[] = [\n-  { name: 'play', icon: <PlayTier /> },\n-  {\n-    name: 'plus',\n-    icon: <PlusTier />,\n-  },\n-  {\n-    name: 'premium',\n-    icon: <PremiumTier />,\n-  },\n-  {\n-    name: 'crystal',\n-    icon: <CrystalTier />,\n-  },\n-] as const\n-\n-const TIER_EXCLUSIONS: Partial<\n-  Record<CreateableOutcomeType, MarketTierType[]>\n-> = {\n-  NUMBER: ['play'],\n-}\n-\n-const isTierDisabled = (\n-  outcomeType: CreateableOutcomeType,\n-  tier: MarketTierType\n-) => {\n-  return TIER_EXCLUSIONS[outcomeType]?.includes(tier)\n-}\n-\n export const CostSection = (props: {\n   balance: number\n   outcomeType: CreateableOutcomeType\n-  baseCost: number\n-  marketTier: MarketTierType | undefined\n-  setMarketTier: (tier: MarketTierType) => void\n+  liquidityTier: number\n+  setLiquidityTier: (tier: number) => void\n+  numAnswers: number | undefined\n }) => {\n-  const { balance, outcomeType, baseCost, marketTier, setMarketTier } = props\n+  const { balance, outcomeType, liquidityTier, setLiquidityTier, numAnswers } =\n+    props\n+  const ante = getAnte(outcomeType, numAnswers, liquidityTier)\n+\n   const [fundsModalOpen, setFundsModalOpen] = useState(false)\n-  const currentCost = getTieredCost(baseCost, marketTier, outcomeType)\n   return (\n     <Col className=\"items-start px-1\">\n       <label className=\"mb-1 gap-2\">\n         <span>\n@@ -74,15 +36,13 @@\n         </span>\n       </label>\n \n       <PriceSection\n-        baseCost={baseCost}\n-        outcomeType={outcomeType}\n-        currentTier={marketTier}\n-        setMarketTier={setMarketTier}\n+        liquidityTier={liquidityTier}\n+        setLiquidityTier={setLiquidityTier}\n       />\n \n-      {currentCost > balance && (\n+      {ante > balance && (\n         <div className=\"mb-2 mr-auto mt-2 self-center whitespace-nowrap text-xs font-medium tracking-wide\">\n           <span className=\"text-scarlet-500 mr-2\">Insufficient balance</span>\n           <Button\n             size=\"xs\"\n@@ -98,120 +58,73 @@\n   )\n }\n \n function PriceSection(props: {\n-  baseCost: number\n-  outcomeType: CreateableOutcomeType\n-  currentTier: MarketTierType | undefined\n-  setMarketTier: (tier: MarketTierType) => void\n+  liquidityTier: number\n+  setLiquidityTier: (tier: number) => void\n }) {\n-  const { baseCost, outcomeType, currentTier, setMarketTier } = props\n+  const { liquidityTier, setLiquidityTier } = props\n \n-  if (!currentTier) {\n-    return <TokenNumber amount={getTieredCost(baseCost, 'play', outcomeType)} />\n-  }\n   return (\n     <Col className=\"w-full gap-2\">\n       <div className=\"text-ink-600 text-sm\">\n         More liquidity attracts more traders but has a higher cost.\n       </div>\n       <div className=\"grid w-full grid-cols-2 gap-2 sm:grid-cols-4\">\n-        {TIERS.map((tier: TIER_TYPE) => {\n-          return (\n-            <Tier\n-              key={tier.name}\n-              baseCost={baseCost}\n-              tier={tier.name}\n-              outcomeType={outcomeType}\n-              currentTier={currentTier}\n-              setMarketTier={setMarketTier}\n-              isTierDisabled={isTierDisabled(outcomeType, tier.name)}\n-            />\n-          )\n-        })}\n+        {liquidityTiers.map((tier) => (\n+          <Tier\n+            key={tier}\n+            currentTier={liquidityTier}\n+            liquidityTier={tier}\n+            setLiquidityTier={setLiquidityTier}\n+          />\n+        ))}\n       </div>\n     </Col>\n   )\n }\n \n function Tier(props: {\n-  baseCost: number\n-  tier: MarketTierType\n-  outcomeType: CreateableOutcomeType\n-  currentTier: MarketTierType\n-  setMarketTier: (tier: MarketTierType) => void\n+  currentTier: number\n+  liquidityTier: number\n+  setLiquidityTier: (tier: number) => void\n   isTierDisabled?: boolean\n }) {\n-  const {\n-    baseCost,\n-    tier,\n-    outcomeType,\n-    currentTier,\n-    setMarketTier,\n-    isTierDisabled,\n-  } = props\n+  const { currentTier, liquidityTier, setLiquidityTier, isTierDisabled } = props\n \n-  const questionType = capitalize(getContractTypeFromValue(outcomeType, 'name'))\n-  const tierName = getPresentedTierName(tier)\n+  const tierIndex = liquidityTiers.findIndex((tier) => tier === liquidityTier)\n \n-  if (isTierDisabled) {\n-    return (\n-      <div\n-        className={clsx(\n-          'bg-canvas-50 w-full select-none items-baseline rounded py-2 pl-2 pr-4 transition-colors',\n-          'flex flex-row justify-start gap-3 sm:flex-col sm:items-center sm:justify-between sm:gap-0'\n-        )}\n-      >\n-        <div className=\"text-ink-500 flex flex-col items-center gap-1 text-sm font-bold sm:flex-row sm:items-start\">\n-          <div>Disabled</div>\n-          <InfoTooltip\n-            text={`The ${questionType} question type does not work with the ${tierName} tier because it requires more liquidity.`}\n-          />\n-        </div>\n-        <Col className=\"sm:items-center\">\n-          <div className=\"text-ink-400\">{tierName}</div>\n-          <div\n-            className=\"text-xl opacity-50\"\n-            style={{ filter: 'saturate(0%)' }}\n-          >\n-            <ManaCoin />\n-          </div>\n-        </Col>\n-      </div>\n-    )\n-  }\n-\n   return (\n     <div\n       className={clsx(\n-        currentTier == tier\n-          ? tier == 'play'\n+        currentTier == liquidityTier\n+          ? tierIndex == 0\n             ? 'outline-ink-500'\n-            : tier == 'plus'\n+            : tierIndex == 1\n             ? 'outline-blue-500'\n-            : tier == 'premium'\n+            : tierIndex == 2\n             ? 'outline-purple-400'\n             : 'outline-pink-500'\n-          : tier == 'play'\n+          : tierIndex == 0\n           ? 'hover:outline-ink-500/50 opacity-50 outline-transparent'\n-          : tier == 'plus'\n+          : tierIndex == 1\n           ? 'opacity-50 outline-transparent hover:outline-purple-500/50'\n-          : tier == 'premium'\n+          : tierIndex == 2\n           ? 'opacity-50 outline-transparent hover:outline-fuchsia-400/50'\n           : 'opacity-50 outline-transparent hover:outline-pink-500/50',\n         'bg-canvas-50 cursor-pointer ',\n         'flex w-full select-none flex-row items-center gap-2 rounded px-4 py-2 outline transition-colors sm:flex-col sm:gap-0'\n       )}\n       onClick={() => {\n         if (!isTierDisabled) {\n-          setMarketTier(tier)\n+          setLiquidityTier(liquidityTier)\n         }\n       }}\n     >\n       <Col className=\"sm:items-center\">\n         <TokenNumber\n           className=\"text-xl font-semibold\"\n-          amount={getTieredCost(baseCost, tier, outcomeType)}\n+          amount={liquidityTier}\n           numberType=\"short\"\n         />\n       </Col>\n     </div>\n"
        },
        {
          "path": "web/components/search.tsx",
          "status": "modified",
          "diff": "Index: web/components/search.tsx\n===================================================================\n--- web/components/search.tsx\t262f7eb (parent)\n+++ web/components/search.tsx\t13133e3 (commit)\n@@ -29,9 +29,9 @@\n import { ContractFilters } from './search/contract-filters'\n import { UserResults } from './search/user-results'\n import { BrowseTopicPills } from './topics/browse-topic-pills'\n import { LoadMoreUntilNotVisible } from 'web/components/widgets/visibility-observer'\n-import { BinaryDigit, TierParamsType } from 'common/tier'\n+import { BinaryDigit } from 'common/tier'\n import { useIsMobile } from 'web/hooks/use-is-mobile'\n import { Spacer } from './layout/spacer'\n import { useSweepstakes } from './sweepstakes-provider'\n import { FilterPill } from './search/filter-pills'\n@@ -140,9 +140,8 @@\n   [CONTRACT_TYPE_KEY]: ContractTypeType\n   [SEARCH_TYPE_KEY]: SearchType\n   [PRIZE_MARKET_KEY]: BinaryDigit\n   [FOR_YOU_KEY]: BinaryDigit\n-  [MARKET_TIER_KEY]: TierParamsType\n   [TOPIC_FILTER_KEY]: string\n   [SWEEPIES_KEY]: '0' | '1' | '2'\n   [GROUP_IDS_KEY]: string\n }\n@@ -599,9 +598,8 @@\n         f: filter,\n         ct: contractType,\n         p: isPrizeMarketString,\n         fy: forYou,\n-        mt: marketTier,\n         tf: topicSlug,\n         sw: sweepState,\n         gids,\n       } = searchParams\n@@ -631,9 +629,8 @@\n               limit: CONTRACTS_PER_SEARCH_PAGE,\n               topicSlug: topicSlug !== '' ? topicSlug : undefined,\n               creatorId: additionalFilter?.creatorId,\n               isPrizeMarket: isPrizeMarketString,\n-              marketTier,\n               forYou,\n               token:\n                 sweepState === '2'\n                   ? 'ALL'\n@@ -742,9 +739,8 @@\n   defaultPrizeMarket?: '1' | '0'\n   defaultSweepies?: '2' | '1' | '0'\n   defaultForYou?: '1' | '0'\n   useUrlParams?: boolean\n-  defaultMarketTier?: TierParamsType\n   defaultTopicFilter?: string\n }) => {\n   const {\n     persistPrefix,\n@@ -754,9 +750,8 @@\n     defaultSearchType,\n     useUrlParams,\n     defaultPrizeMarket,\n     defaultForYou,\n-    defaultMarketTier,\n     defaultTopicFilter,\n     defaultSweepies,\n   } = props\n \n@@ -767,9 +762,8 @@\n     [CONTRACT_TYPE_KEY]: defaultContractType ?? 'ALL',\n     [SEARCH_TYPE_KEY]: defaultSearchType,\n     [PRIZE_MARKET_KEY]: defaultPrizeMarket ?? '0',\n     [FOR_YOU_KEY]: defaultForYou ?? '0',\n-    [MARKET_TIER_KEY]: defaultMarketTier ?? DEFAULT_TIER,\n     [TOPIC_FILTER_KEY]: defaultTopicFilter ?? '',\n     [SWEEPIES_KEY]: defaultSweepies ?? '0',\n     [GROUP_IDS_KEY]: '',\n   }\n"
        },
        {
          "path": "web/components/search/contract-filters.tsx",
          "status": "modified",
          "diff": "Index: web/components/search/contract-filters.tsx\n===================================================================\n--- web/components/search/contract-filters.tsx\t262f7eb (parent)\n+++ web/components/search/contract-filters.tsx\t13133e3 (commit)\n@@ -2,20 +2,15 @@\n import { track } from 'web/lib/service/analytics'\n import { Col } from '../layout/col'\n import { getLabelFromValue } from './search-dropdown-helpers'\n \n-import { MarketTierType, TierParamsType, tiers } from 'common/tier'\n import { useState } from 'react'\n import { FaSortAmountDownAlt } from 'react-icons/fa'\n import { FaFileContract, FaFilter, FaSliders } from 'react-icons/fa6'\n import { IconButton } from 'web/components/buttons/button'\n import { Carousel } from 'web/components/widgets/carousel'\n import { SweepiesCoin } from 'web/public/custom-components/sweepiesCoin'\n-import {\n-  CrystalTier,\n-  PlusTier,\n-  PremiumTier,\n-} from 'web/public/custom-components/tiers'\n+\n import { MODAL_CLASS, Modal } from '../layout/modal'\n import { Row } from '../layout/row'\n import {\n   BOUNTY_MARKET_SORTS,\n@@ -27,9 +22,8 @@\n   DEFAULT_FILTER,\n   DEFAULT_FILTERS,\n   DEFAULT_SORT,\n   DEFAULT_SORTS,\n-  DEFAULT_TIER,\n   FILTERS,\n   FOR_YOU_KEY,\n   Filter,\n   GROUP_IDS_KEY,\n@@ -48,9 +42,8 @@\n   AdditionalFilterPill,\n   FilterDropdownPill,\n   FilterPill,\n   minimalistIndigoSelectedClass,\n-  TierDropdownPill,\n   unselectedClass,\n } from './filter-pills'\n import { useUser } from 'web/hooks/use-user'\n \n@@ -63,15 +56,9 @@\n }) {\n   const { className, params, updateParams, hideSweepsToggle, topicSlug } = props\n   const user = useUser()\n \n-  const {\n-    s: sort,\n-    f: filter,\n-    ct: contractType,\n-    mt: currentTiers,\n-    sw: isSweepiesString,\n-  } = params\n+  const { s: sort, f: filter, ct: contractType, sw: isSweepiesString } = params\n   const isSweeps = isSweepiesString === '1'\n   const { setPrefersPlay } = useSweepstakes()\n \n   const selectFilter = (selection: Filter) => {\n@@ -135,17 +122,8 @@\n     contractType !== DEFAULT_CONTRACT_TYPE\n \n   const forYou = params[FOR_YOU_KEY] === '1' && !params[GROUP_IDS_KEY]\n \n-  const toggleTier = (tier: MarketTierType) => {\n-    const tierIndex = tiers.indexOf(tier)\n-    if (tierIndex >= 0 && tierIndex < currentTiers.length) {\n-      const tiersArray = currentTiers.split('')\n-      tiersArray[tierIndex] = tiersArray[tierIndex] === '0' ? '1' : '0'\n-      updateParams({ mt: tiersArray.join('') as TierParamsType })\n-    }\n-  }\n-\n   return (\n     <Col className={clsx('mb-1 mt-2 items-stretch gap-1 ', className)}>\n       <Carousel fadeEdges labelsParentClassName=\"gap-1 items-center\">\n         {isSweeps && !hideSweepsToggle && (\n@@ -247,32 +225,8 @@\n           >\n             For you\n           </FilterPill>\n         )}\n-        {!hideFilter && currentTiers !== DEFAULT_TIER && (\n-          <AdditionalFilterPill\n-            type=\"filter\"\n-            onXClick={() =>\n-              updateParams({ mt: DEFAULT_TIER as TierParamsType })\n-            }\n-          >\n-            <Row className=\"items-center py-[3px]\">\n-              {currentTiers.split('').map((tier, index) => {\n-                if (tier === '1') {\n-                  if (tiers[index] == 'plus') {\n-                    return <PlusTier key={index} />\n-                  }\n-                  if (tiers[index] == 'premium') {\n-                    return <PremiumTier key={index} />\n-                  }\n-                  if (tiers[index] == 'crystal') {\n-                    return <CrystalTier key={index} />\n-                  }\n-                }\n-              })}\n-            </Row>\n-          </AdditionalFilterPill>\n-        )}\n         {nonDefaultSort && (\n           <AdditionalFilterPill\n             type=\"sort\"\n             onXClick={() => selectSort(DEFAULT_SORT)}\n@@ -330,9 +284,8 @@\n         selectFilter={selectFilter}\n         selectSort={selectSort}\n         selectContractType={selectContractType}\n         toggleSweepies={toggleSweepies}\n-        toggleTier={toggleTier}\n         hideFilter={hideFilter}\n       />\n     </Col>\n   )\n@@ -345,9 +298,8 @@\n   selectFilter: (selection: Filter) => void\n   selectSort: (selection: Sort) => void\n   selectContractType: (selection: ContractTypeType) => void\n   toggleSweepies: () => void\n-  toggleTier: (tier: MarketTierType) => void\n   hideFilter: boolean\n }) {\n   const {\n     open,\n@@ -356,18 +308,11 @@\n     selectFilter,\n     selectContractType,\n     selectSort,\n     toggleSweepies,\n-    toggleTier,\n     hideFilter,\n   } = props\n-  const {\n-    s: sort,\n-    f: filter,\n-    ct: contractType,\n-    sw: isSweepiesString,\n-    mt: currentTiers,\n-  } = params\n+  const { s: sort, f: filter, ct: contractType, sw: isSweepiesString } = params\n \n   const sortItems =\n     contractType == 'BOUNTIED_QUESTION'\n       ? BOUNTY_MARKET_SORTS\n@@ -398,12 +343,8 @@\n                   />\n                   Sweepstakes\n                 </Row>\n               </FilterPill>\n-              <TierDropdownPill\n-                toggleTier={toggleTier}\n-                currentTiers={currentTiers}\n-              />\n               {!hideFilter &&\n                 FILTERS.map(({ label: filterLabel, value: filterValue }) => (\n                   <FilterPill\n                     key={filterValue}\n"
        },
        {
          "path": "web/components/search/filter-pills.tsx",
          "status": "modified",
          "diff": "Index: web/components/search/filter-pills.tsx\n===================================================================\n--- web/components/search/filter-pills.tsx\t262f7eb (parent)\n+++ web/components/search/filter-pills.tsx\t13133e3 (commit)\n@@ -1,15 +1,9 @@\n import { ChevronDownIcon, XCircleIcon } from '@heroicons/react/solid'\n import clsx from 'clsx'\n-import { MarketTierType, TierParamsType, tiers } from 'common/tier'\n import { ReactNode } from 'react'\n-import {\n-  CrystalTier,\n-  PlusTier,\n-  PremiumTier,\n-} from 'web/public/custom-components/tiers'\n+\n import { Row } from '../layout/row'\n-import CheckedDropdownMenu from '../widgets/checked-dropdown'\n import {\n   FILTERS,\n   FOR_YOU_KEY,\n   Filter,\n@@ -90,81 +84,8 @@\n     </Row>\n   )\n }\n \n-export function TierDropdownPill(props: {\n-  toggleTier: (tier: MarketTierType) => void\n-  currentTiers: TierParamsType\n-}) {\n-  const { toggleTier, currentTiers } = props\n-  return (\n-    <CheckedDropdownMenu\n-      withinOverflowContainer\n-      items={[\n-        {\n-          name: 'Crystal',\n-          content: (\n-            <Row className=\"items-center text-sm\">\n-              <CrystalTier />\n-              <div className=\"bg-gradient-to-r from-pink-700 to-pink-500 bg-clip-text text-transparent dark:from-pink-400 dark:to-pink-300\">\n-                Crystal\n-              </div>\n-            </Row>\n-          ),\n-          onToggle: () => toggleTier('crystal'),\n-          checked: currentTiers[tiers.indexOf('crystal')] == '1',\n-        },\n-        {\n-          name: 'Premium',\n-          content: (\n-            <Row className=\"items-center text-sm text-purple-600 dark:text-purple-400\">\n-              <PremiumTier />\n-              Premium\n-            </Row>\n-          ),\n-          onToggle: () => toggleTier('premium'),\n-          checked: currentTiers[tiers.indexOf('premium')] == '1',\n-        },\n-        {\n-          name: 'Plus',\n-          content: (\n-            <Row className=\"items-center text-sm font-semibold text-blue-600 dark:text-blue-500\">\n-              <PlusTier />\n-              Plus\n-            </Row>\n-          ),\n-          onToggle: () => toggleTier('plus'),\n-          checked: currentTiers[tiers.indexOf('plus')] == '1',\n-        },\n-      ]}\n-      buttonContent={(open) => (\n-        <DropdownPill\n-          open={open}\n-          color={currentTiers.includes('1') ? 'indigo' : 'light-gray'}\n-        >\n-          <Row className=\"h-5 items-center\">\n-            {currentTiers === '00000'\n-              ? 'Tiers'\n-              : currentTiers.split('').map((tier, index) => {\n-                  if (tier === '1') {\n-                    if (tiers[index] == 'plus') {\n-                      return <PlusTier key={index} />\n-                    }\n-                    if (tiers[index] == 'premium') {\n-                      return <PremiumTier key={index} />\n-                    }\n-                    if (tiers[index] == 'crystal') {\n-                      return <CrystalTier key={index} />\n-                    }\n-                  }\n-                })}\n-          </Row>\n-        </DropdownPill>\n-      )}\n-    />\n-  )\n-}\n-\n export function FilterDropdownPill(props: {\n   selectFilter: (selection: Filter) => void\n   currentFilter: Filter\n }) {\n"
        },
        {
          "path": "web/components/tiers/liquidity-tooltip.tsx",
          "status": "modified",
          "diff": "Index: web/components/tiers/liquidity-tooltip.tsx\n===================================================================\n--- web/components/tiers/liquidity-tooltip.tsx\t262f7eb (parent)\n+++ web/components/tiers/liquidity-tooltip.tsx\t13133e3 (commit)\n@@ -1,16 +1,9 @@\n import { Placement } from '@floating-ui/react'\n import clsx from 'clsx'\n import { Contract } from 'common/contract'\n-import { MarketTierType } from 'common/tier'\n import { formatWithToken, shortFormatNumber } from 'common/util/format'\n-import { capitalize } from 'lodash'\n-import {\n-  CrystalTier,\n-  PlayTier,\n-  PlusTier,\n-  PremiumTier,\n-} from 'web/public/custom-components/tiers'\n+\n import { Tooltip } from '../widgets/tooltip'\n import { GiWaterDrop } from 'react-icons/gi'\n \n export function LiquidityTooltip(props: {\n@@ -41,30 +34,4 @@\n       {shortFormatNumber(amount)}\n     </Tooltip>\n   )\n }\n-\n-export function getPresentedTierName(tier: MarketTierType) {\n-  if (tier == 'play') {\n-    return 'Basic'\n-  }\n-\n-  return capitalize(tier)\n-}\n-\n-export function TierIcon(props: { tier: MarketTierType; className?: string }) {\n-  const { tier, className } = props\n-  if (tier == 'play') {\n-    return <PlayTier className={className} />\n-  }\n-\n-  if (tier == 'plus') {\n-    return <PlusTier className={className} />\n-  }\n-  if (tier == 'premium') {\n-    return <PremiumTier className={className} />\n-  }\n-  if (tier == 'crystal') {\n-    return <CrystalTier className={className} />\n-  }\n-  return <></>\n-}\n"
        },
        {
          "path": "web/components/widgets/amount-input.tsx",
          "status": "modified",
          "diff": "Index: web/components/widgets/amount-input.tsx\n===================================================================\n--- web/components/widgets/amount-input.tsx\t262f7eb (parent)\n+++ web/components/widgets/amount-input.tsx\t13133e3 (commit)\n@@ -5,9 +5,8 @@\n   PHONE_VERIFICATION_BONUS,\n   SWEEPS_MIN_BET,\n } from 'common/economy'\n import { ENV_CONFIG } from 'common/envs/constants'\n-import { MarketTierType } from 'common/tier'\n import { humanish, User } from 'common/user'\n import {\n   formatMoney,\n   formatWithToken,\n@@ -161,17 +160,17 @@\n   disregardUserBalance?: boolean\n   quickButtonAmountSize?: 'large' | 'small'\n   disableQuickButtons?: boolean\n   token?: InputTokenType\n-  marketTier?: MarketTierType | undefined\n+  liquidityTier?: number | undefined\n   sliderColor?: keyof typeof sliderColors\n }) {\n   const {\n     amount,\n     onChange,\n     error,\n     setError,\n-    marketTier,\n+    liquidityTier,\n     disabled,\n     binaryOutcome,\n     showBalance,\n     showSlider,\n@@ -297,9 +296,9 @@\n             amount={amount}\n             onAmountChange={onChange}\n             binaryOutcome={binaryOutcome}\n             disabled={disabled}\n-            smallAmounts={!hasLotsOfMoney || marketTier === 'play'}\n+            smallAmounts={!hasLotsOfMoney || liquidityTier === 0}\n             token={token}\n             sliderColor={sliderColor}\n           />\n         )}\n"
        },
        {
          "path": "web/lib/admin/create-sports-markets.ts",
          "status": "modified",
          "diff": "Index: web/lib/admin/create-sports-markets.ts\n===================================================================\n--- web/lib/admin/create-sports-markets.ts\t262f7eb (parent)\n+++ web/lib/admin/create-sports-markets.ts\t13133e3 (commit)\n@@ -2,8 +2,9 @@\n import { SportsGames } from 'common/sports-info'\n import { buildArray } from 'common/util/array'\n import { APIParams } from 'common/api/schema'\n import { ENV } from 'common/envs/constants'\n+import { liquidityTiers } from 'common/tier'\n \n export const handleCreateSportsMarkets = async (\n   setIsLoading: (loading: boolean) => void,\n   setIsFinished: (finished: boolean) => void\n@@ -83,8 +84,9 @@\n         answers,\n         answerShortTexts,\n         answerImageUrls,\n         visibility: 'public',\n+        liquidityTier: liquidityTiers[1],\n         addAnswersMode: 'DISABLED',\n         shouldAnswersSumToOne: true,\n         sportsStartTimestamp: sportsGames.strTimestamp,\n         sportsEventId: sportsGames.idEvent,\n"
        }
      ]
    },
    {
      "id": "implement-market-boosts",
      "sha": "cd6dd8c2753747eff4395814f38c3f6253577006",
      "parentSha": "3db506179f5ce88d0865f7a4d83b465313f19d76",
      "spec": "Implement a paid, schedulable 24-hour homepage boost system for markets (\"boosts\") that affects ranking and UI indicators while active.\n\nDatabase\n- Add a new table: backend/supabase/contract_boosts.sql\n  - Columns: id (bigint identity PK), contract_id (FK to contracts.id), user_id (FK to users.id), start_time (timestamptz), end_time (timestamptz).\n  - Indexes: (contract_id, start_time, end_time) and (user_id).\n  - Enable RLS.\n- Modify backend/supabase/contracts.sql to add a new column to contracts:\n  - boosted boolean default false not null.\n  - Stop deriving popularity_score from data in the trigger (do not set from JSON).\n\nCommon types and schema\n- Update common/src/supabase/schema.ts to include contract_boosts (Row/Insert/Update/Relationships) and add boosted to contracts Row/Insert/Update types.\n- Update common/src/supabase/contracts.ts convertContract() to map the native boosted column into the Contract shape (default to false if null).\n- In common/src/contract.ts, augment Contract with a boosted: boolean (maintained via native column). Export nativeContractColumnsArray listing all DB-native columns (snake_case) that are stored in contracts outside of the JSON data field.\n- Add BOOST_COST_MANA = 10000 to common/src/economy.ts.\n\nShared utilities and refactor\n- In backend/shared/src/utils.ts define:\n  - contractColumnsToSelect as a comma-joined list of the DB-native columns from nativeContractColumnsArray.\n  - prefixedContractColumnsToSelect as the same list prefixed with c. for SQL joins.\n- In backend/shared/src/supabase/contracts.ts:\n  - updateContract(pg, id, update) should reject attempts to modify native DB columns (throw an error if keys overlap nativeContractColumnsArray).\n  - Add updateContractNativeColumns(pg, contractId, updated) to update native columns (using update(), not updateData()), convert the result, and broadcast changes (with camelCased keys) via websockets.\n\nContract creation\n- In backend/api/src/create-market.ts:\n  - Derive the set of camelCase keys for nativeContractColumnsArray.\n  - Exclude those keys from the serialized JSON data blob.\n  - Insert into contracts specifying: id, data, and all native columns in the same order as contractColumnsToSelect. Ensure parameter binding matches the exact native column order.\n\nBoost purchase API\n- Define a new authed POST API route 'purchase-contract-boost' in common/src/api/schema.ts with props { contractId: string, startTime: number (ms) } and returns { success: boolean }.\n- Implement backend/api/src/purchase-contract-boost.ts:\n  - Validate the contract exists and is visible.\n  - Enforce constraints for the selected start time:\n    - No existing boost for the same contract overlaps that start time.\n    - A global limit of MAX_ACTIVE_BOOSTS = 5 overlapping boosts for that instant.\n    - Violations return HTTP 400 with descriptive messages.\n  - Within a DB transaction:\n    - Insert a new contract_boosts row with (contract_id, user_id, start_time, end_time = start + 24h).\n    - Charge the user M$ via runTxnInBetQueue with category CONTRACT_BOOST_PURCHASE, sending funds to the house bank account (prod vs dev IDs), embedding { contractId, boostId } in txn data.\n  - If the selected startTime is now or earlier, immediately set contracts.boosted = true and increase importance_score by +0.25 using updateContractNativeColumns.\n- Register the handler in backend/api/src/routes.ts.\n\nImportance score integration\n- In backend/shared/src/importance-score.ts:\n  - Use prefixedContractColumnsToSelect for contract selection and convert to Contract objects as usual.\n  - Query currently active boosts (start_time <= now < end_time) and compute a per-contract isBoosted flag.\n  - Pass isBoosted into the computeContractScores function.\n  - Add a +0.25 boostScore component to the raw importance score when isBoosted is true.\n  - When persisting updated contracts via bulk update, include boosted and the new scores (importance_score, freshness_score, daily_score) but only for valid numeric values.\n  - Include Boost in the diagnostics output of score breakdowns for logging/inspection.\n\nFrontend\n- Add a boost purchase UX:\n  - Component to trigger boost: For eligible markets (public, not closed/resolved), display a button labeled \"Boost market\" with a rocket icon; disable if contract.boosted is true; otherwise open a modal.\n  - Modal flow: Explain the 24-hour boost, show or pick a start date (default now; cannot be in the past), show price as a TokenNumber using BOOST_COST_MANA, and handle insufficient balance by prompting AddFundsModal. On confirm, call api('purchase-contract-boost') and surface a success or error toast. Close on success.\n- Indicate boosted state in tables and lists:\n  - Add a \"Boosted\" column displaying an icon when contract.boosted is true.\n- Replace TierTooltip with a simplified LiquidityTooltip wherever tier badges were displayed (contract summary, feed card fallback, search list): show a droplet icon with the formatted liquidity amount; remove tier name badges.\n- Update the contract page and share panels to include the boost CTA for both creators and non-creators in appropriate positions without breaking existing layout.\n\nWebsocket updates\n- Ensure updates to native contract columns (including boosted and scores) trigger broadcastUpdatedContract so clients receive real-time updates.\n\nAcceptance criteria\n- Purchasing a boost creates a contract_boosts row, charges exactly M$ 10,000 to the house account, and immediately toggles boosted to true and adds +0.25 to importance when the start time is now (or earlier); future boosts do not set boosted until active.\n- Enforce at most 5 simultaneous boosts for any moment, and prevent the same contract from having overlapping boosts; return clear 400 errors on violations.\n- The importance-score job applies boostScore while active and persists boosted + scores. When a boost window ends, boosted returns to false and the boost component is no longer applied.\n- New contract creation inserts native columns separately from the JSON data with correct ordering and values.\n- UI shows the boost action only when eligible, handles insufficient balance, displays success/error toasts, renders boosted indicators in tables, and shows a liquidity tooltip where tiers used to be.\n- API schema and typings are consistent across client/server for the new endpoint and transaction category.",
      "prompt": "Add a paid 24-hour homepage boost feature for markets. Users should be able to purchase a boost for a specific market to raise its homepage prominence for a day starting now or on a chosen future date. Limit the number of overlapping boosts and prevent overlapping boosts for the same market. Charge the buyer in M$ and record the purchase. While a boost is active, the market should receive a fixed increase in its ranking score and display a boosted indicator in lists. When the boost ends, the boost effect should stop. Update the UI to let users initiate a boost via a modal, pick a start date, see the price, handle insufficient balance, and show success or error messages. Replace the previous tier badge visuals with a simple liquidity tooltip wherever they appeared. Ensure new markets write native contract fields to dedicated DB columns and restrict JSON-based updates from modifying those native fields. Keep API typings, scoring integration, database schema, and websocket broadcasting consistent with existing conventions.",
      "supplementalFiles": [
        "backend/shared/src/txn/run-txn.ts",
        "backend/shared/src/supabase/utils.ts",
        "backend/shared/src/supabase/init.ts",
        "backend/shared/src/websockets/helpers.ts",
        "common/src/supabase/utils.ts",
        "common/src/util/time.ts",
        "web/lib/api/api.ts",
        "web/components/buttons/button.tsx",
        "web/components/layout/modal.tsx",
        "web/components/layout/col.tsx",
        "web/components/layout/row.tsx",
        "web/components/widgets/input.tsx",
        "web/components/widgets/token-number.tsx",
        "web/components/widgets/tooltip.tsx",
        "web/public/custom-components/tiers.tsx"
      ],
      "fileDiffs": [
        {
          "path": "backend/api/src/create-market.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/create-market.ts\n===================================================================\n--- backend/api/src/create-market.ts\t3db5061 (parent)\n+++ backend/api/src/create-market.ts\tcd6dd8c (commit)\n@@ -9,13 +9,15 @@\n   toLiteMarket,\n } from 'common/api/market-types'\n import { ValidatedAPIParams } from 'common/api/schema'\n import {\n+  Contract,\n   MULTI_NUMERIC_CREATION_ENABLED,\n   NO_CLOSE_TIME_TYPES,\n   OutcomeType,\n   add_answers_mode,\n   contractUrl,\n+  nativeContractColumnsArray,\n } from 'common/contract'\n import { getAnte } from 'common/economy'\n import { MAX_GROUPS_PER_MARKET } from 'common/group'\n import { getMultiNumericAnswerBucketRangeNames } from 'common/multi-numeric'\n@@ -40,9 +42,9 @@\n import {\n   addGroupToContract,\n   canUserAddGroupToMarket,\n } from 'shared/update-group-contracts-internal'\n-import { htmlToRichText, log } from 'shared/utils'\n+import { contractColumnsToSelect, htmlToRichText, log } from 'shared/utils'\n import {\n   broadcastNewAnswer,\n   broadcastNewContract,\n } from 'shared/websockets/helpers'\n@@ -54,9 +56,9 @@\n import { convertAnswer } from 'common/supabase/contracts'\n import { generateAntes } from 'shared/create-contract-helpers'\n import { betsQueue } from 'shared/helpers/fn-queue'\n import { convertUser } from 'common/supabase/users'\n-import { first } from 'lodash'\n+import { camelCase, first } from 'lodash'\n import { getTieredCost } from 'common/tier'\n \n type Body = ValidatedAPIParams<'market'>\n \n@@ -224,16 +226,25 @@\n           sportsLeague,\n           takerAPIOrdersDisabled,\n         })\n       )\n+      const nativeKeys = nativeContractColumnsArray.map(camelCase)\n+      const nativeValues = nativeKeys\n+        .filter((col) => col in contract)\n+        .map((col) => contract[col as keyof Contract])\n \n+      const contractDataToInsert = Object.fromEntries(\n+        Object.entries(contract).filter(([key]) => !nativeKeys.includes(key))\n+      )\n       const insertAnswersQuery =\n         contract.mechanism === 'cpmm-multi-1'\n           ? bulkInsertQuery('answers', contract.answers.map(answerToRow), true)\n           : 'select 1 where false'\n       const contractQuery = pgp.as.format(\n-        `insert into contracts (id, data, token) values ($1, $2, $3);`,\n-        [contract.id, JSON.stringify(contract), contract.token]\n+        `insert into contracts \n+        (id, ${contractColumnsToSelect})\n+         values ($1, $2, ${nativeValues.map((_, i) => `$${i + 3}`)});`,\n+        [contract.id, JSON.stringify(contractDataToInsert), ...nativeValues]\n       )\n       const result = await tx.multi(\n         `${contractQuery};\n        ${insertAnswersQuery};`\n"
        },
        {
          "path": "backend/api/src/purchase-contract-boost.ts",
          "status": "added",
          "diff": "Index: backend/api/src/purchase-contract-boost.ts\n===================================================================\n--- backend/api/src/purchase-contract-boost.ts\t3db5061 (parent)\n+++ backend/api/src/purchase-contract-boost.ts\tcd6dd8c (commit)\n@@ -0,0 +1,87 @@\n+import { APIError, APIHandler } from './helpers/endpoint'\n+import { createSupabaseDirectClient } from 'shared/supabase/init'\n+import { DAY_MS } from 'common/util/time'\n+import {\n+  DEV_HOUSE_LIQUIDITY_PROVIDER_ID,\n+  HOUSE_LIQUIDITY_PROVIDER_ID,\n+} from 'common/antes'\n+import { getContract, isProd } from 'shared/utils'\n+import { runTxnInBetQueue, TxnData } from 'shared/txn/run-txn'\n+import { ContractBoostPurchaseTxn } from 'common/txn'\n+import { Row } from 'common/supabase/utils'\n+import { BOOST_COST_MANA } from 'common/economy'\n+import { updateContractNativeColumns } from 'shared/supabase/contracts'\n+\n+const MAX_ACTIVE_BOOSTS = 5\n+\n+export const purchaseContractBoost: APIHandler<\n+  'purchase-contract-boost'\n+> = async (props, auth) => {\n+  const { contractId, startTime } = props\n+  const userId = auth.uid\n+\n+  const pg = createSupabaseDirectClient()\n+\n+  // Check if contract exists and user can see it\n+  const contract = await getContract(pg, contractId)\n+  if (!contract) {\n+    throw new APIError(404, 'Contract not found')\n+  }\n+\n+  // Check if there's already an active boost\n+  const activeBoost = await pg.manyOrNone<Row<'contract_boosts'>>(\n+    `select * from contract_boosts \n+     where millis_to_ts($1) between start_time and end_time`,\n+    [startTime]\n+  )\n+  if (activeBoost.some((b) => b.contract_id === contractId)) {\n+    throw new APIError(\n+      400,\n+      'Contract already has an active boost for that time'\n+    )\n+  }\n+  if (activeBoost.length >= MAX_ACTIVE_BOOSTS) {\n+    throw new APIError(\n+      400,\n+      'That time period has the maximum number of boosts. Please select a different time.'\n+    )\n+  }\n+\n+  // Start transaction\n+  await pg.tx(async (tx) => {\n+    const boost = await tx.one(\n+      `insert into contract_boosts (contract_id, user_id, start_time, end_time)\n+       values ($1, $2, millis_to_ts($3), millis_to_ts($4))\n+       returning *`,\n+      [contractId, userId, startTime, startTime + DAY_MS]\n+    )\n+\n+    // Charge mana\n+    const txnData: TxnData = {\n+      category: 'CONTRACT_BOOST_PURCHASE',\n+      fromType: 'USER',\n+      toType: 'BANK',\n+      token: 'M$',\n+      data: { contractId, boostId: boost.id },\n+      amount: BOOST_COST_MANA,\n+      fromId: userId,\n+      toId: isProd()\n+        ? HOUSE_LIQUIDITY_PROVIDER_ID\n+        : DEV_HOUSE_LIQUIDITY_PROVIDER_ID,\n+    } as ContractBoostPurchaseTxn\n+\n+    await runTxnInBetQueue(tx, txnData)\n+  })\n+\n+  return {\n+    result: { success: true },\n+    continue: async () => {\n+      if (startTime <= Date.now()) {\n+        await updateContractNativeColumns(pg, contractId, {\n+          boosted: true,\n+          importance_score: contract.importanceScore + 0.25,\n+        })\n+      }\n+    },\n+  }\n+}\n"
        },
        {
          "path": "backend/api/src/routes.ts",
          "status": "modified",
          "diff": "Index: backend/api/src/routes.ts\n===================================================================\n--- backend/api/src/routes.ts\t3db5061 (parent)\n+++ backend/api/src/routes.ts\tcd6dd8c (commit)\n@@ -161,8 +161,9 @@\n import {\n   getContractOptionVoters,\n   getContractVoters,\n } from './get-contract-voters'\n+import { purchaseContractBoost } from './purchase-contract-boost'\n // we define the handlers in this object in order to typecheck that every API has a handler\n export const handlers: { [k in APIPath]: APIHandler<k> } = {\n   'refresh-all-clients': refreshAllClients,\n   bet: placeBet,\n@@ -339,5 +340,6 @@\n   'comment-reactions': getReactions,\n   'mark-all-notifications-new': markallnotificationsnew,\n   'get-contract-voters': getContractVoters,\n   'get-contract-option-voters': getContractOptionVoters,\n+  'purchase-contract-boost': purchaseContractBoost,\n }\n"
        },
        {
          "path": "backend/shared/src/importance-score.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/importance-score.ts\n===================================================================\n--- backend/shared/src/importance-score.ts\t3db5061 (parent)\n+++ backend/shared/src/importance-score.ts\tcd6dd8c (commit)\n@@ -9,9 +9,9 @@\n   MONTH_MS,\n   WEEK_MS,\n   YEAR_MS,\n } from 'common/util/time'\n-import { log } from 'shared/utils'\n+import { log, prefixedContractColumnsToSelect } from 'shared/utils'\n import {\n   BountiedQuestionContract,\n   Contract,\n   isMarketRanked,\n@@ -22,8 +22,9 @@\n \n import { BOT_USERNAMES } from 'common/envs/constants'\n import { bulkUpdate } from 'shared/supabase/utils'\n import { convertContract } from 'common/supabase/contracts'\n+import { Row } from 'common/supabase/utils'\n \n export const IMPORTANCE_MINUTE_INTERVAL = 2\n export const MIN_IMPORTANCE_SCORE = 0.1\n \n@@ -37,17 +38,12 @@\n   const hourAgo = now - HOUR_MS\n   const dayAgo = now - DAY_MS\n   const weekAgo = now - 7 * DAY_MS\n   const select = (whereClause: string) => `\n-    select c.data,\n-           conversion_score,\n-           importance_score,\n-           freshness_score,\n-           view_count,\n-           daily_score,\n+    select ${prefixedContractColumnsToSelect}\n            case when count(a.prob) > 0 then json_agg(a.prob) end as answer_probs\n     from contracts c\n-           left join answers a on c.id = a.contract_id\n+    left join answers a on c.id = a.contract_id\n     ${whereClause}\n     group by c.id\n        `\n   const convertRow = (row: any) => {\n@@ -106,13 +102,17 @@\n   const thisWeekTradersByContract = {\n     ...(await getContractTraders(pg, weekAgo, contractIds)),\n     ...(await getContractVoters(pg, weekAgo, contractIds)),\n   }\n+  const activeBoosts = await pg.manyOrNone<Row<'contract_boosts'>>(\n+    `select * from contract_boosts where start_time <= now() and end_time > now()`\n+  )\n \n   const contractsWithUpdates: Contract[] = []\n   const marketComponents: Record<string, any>[] = []\n \n   for (const contract of contracts) {\n+    const boosted = activeBoosts.some((b) => b.contract_id === contract.id)\n     const {\n       importanceScore,\n       freshnessScore,\n       dailyScore,\n@@ -124,9 +124,10 @@\n       todayLikesByContract[contract.id] ?? 0,\n       thisWeekLikesByContract[contract.id] ?? 0,\n       todayTradersByContract[contract.id] ?? 0,\n       hourAgoTradersByContract[contract.id] ?? 0,\n-      thisWeekTradersByContract[contract.id] ?? 0\n+      thisWeekTradersByContract[contract.id] ?? 0,\n+      boosted\n     )\n \n     if (isNaN(dailyScore)) {\n       log.error('NaN daily score for contract ' + contract.id)\n@@ -143,13 +144,15 @@\n     if (\n       rescoreAll ||\n       !floatingEqual(importanceScore, contract.importanceScore, epsilon) ||\n       !floatingEqual(freshnessScore, contract.freshnessScore, epsilon) ||\n-      !floatingEqual(dailyScore, contract.dailyScore, epsilon)\n+      !floatingEqual(dailyScore, contract.dailyScore, epsilon) ||\n+      boosted !== contract.boosted\n     ) {\n       contract.importanceScore = importanceScore\n       contract.freshnessScore = freshnessScore\n       contract.dailyScore = dailyScore\n+      contract.boosted = boosted\n       contractsWithUpdates.push(contract)\n       marketComponents.push(rawMarketImportanceBreakdown)\n     }\n   }\n@@ -183,8 +186,9 @@\n         Closing: breakdown.closingSoonnnessComponent?.toFixed(2) || '',\n         Comments: breakdown.commentScore?.toFixed(2) || '',\n         Week: breakdown.thisWeekScoreComponent?.toFixed(2) || '',\n         Ranked: breakdown.rankedScore?.toFixed(2) || '',\n+        Boost: breakdown.boostScore?.toFixed(2) || '',\n       }\n     })\n \n     console.table(topContracts)\n@@ -244,14 +248,22 @@\n     await bulkUpdate(\n       pg,\n       'contracts',\n       ['id'],\n-      contractsWithUpdates.map((contract) => ({\n-        id: contract.id,\n-        importance_score: contract.importanceScore,\n-        freshness_score: contract.freshnessScore,\n-        daily_score: contract.dailyScore,\n-      }))\n+      contractsWithUpdates\n+        .filter(\n+          (c) =>\n+            !isNaN(c.importanceScore) &&\n+            !isNaN(c.freshnessScore) &&\n+            !isNaN(c.dailyScore)\n+        )\n+        .map((contract) => ({\n+          id: contract.id,\n+          boosted: contract.boosted,\n+          importance_score: contract.importanceScore,\n+          freshness_score: contract.freshnessScore,\n+          daily_score: contract.dailyScore,\n+        }))\n     )\n   }\n }\n \n@@ -310,14 +322,13 @@\n   likesToday: number,\n   likesWeek: number,\n   tradersToday: number,\n   traderHour: number,\n-  tradersWeek: number\n+  tradersWeek: number,\n+  isBoosted: boolean\n ) => {\n   const todayScore = likesToday + tradersToday\n   const thisWeekScore = likesWeek + tradersWeek\n-  const thisWeekScoreWeight = thisWeekScore / 10\n-  const popularityScore = todayScore + thisWeekScoreWeight\n   const wasCreatedToday = contract.createdTime > now - DAY_MS\n \n   const { createdTime, closeTime, isResolved, outcomeType } = contract\n   const commentScore = commentsToday\n@@ -366,17 +377,18 @@\n   const closingSoonnnessComponent = closingSoonnness\n   const commentScoreComponent = commentScore * 2\n   const thisWeekScoreComponent = normalize(thisWeekScore, 1000)\n   const rankedScore = isMarketRanked(contract) ? 0 : -1\n-\n+  const boostScore = isBoosted ? 0.25 : 0\n   const computedRawMarketImportance =\n     volume24HoursComponent +\n     traderHourComponent +\n     todayScoreComponent +\n     closingSoonnnessComponent +\n     commentScoreComponent +\n     thisWeekScoreComponent +\n-    rankedScore\n+    rankedScore +\n+    boostScore\n \n   const newnessComponent = newness\n   const rawPollImportance =\n     2 * normalize(traderHour, 20) +\n@@ -415,8 +427,9 @@\n     closingSoonnnessComponent,\n     commentScore: commentScoreComponent,\n     thisWeekScoreComponent,\n     rankedScore,\n+    boostScore,\n     // Freshness components\n     freshVolume24h,\n     freshTodayScore,\n     freshLastUpdated,\n@@ -431,9 +444,8 @@\n \n   return {\n     todayScore,\n     thisWeekScore,\n-    popularityScore: popularityScore >= 1 ? popularityScore : 0,\n     freshnessScore,\n     dailyScore,\n     importanceScore,\n     logOddsChange,\n"
        },
        {
          "path": "backend/shared/src/supabase/contracts.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/supabase/contracts.ts\n===================================================================\n--- backend/shared/src/supabase/contracts.ts\t3db5061 (parent)\n+++ backend/shared/src/supabase/contracts.ts\tcd6dd8c (commit)\n@@ -1,15 +1,15 @@\n import { SupabaseDirectClient } from 'shared/supabase/init'\n-import { Contract } from 'common/contract'\n+import { Contract, nativeContractColumnsArray } from 'common/contract'\n import { isAdminId } from 'common/envs/constants'\n import { convertContract } from 'common/supabase/contracts'\n import { generateEmbeddings } from 'shared/helpers/openai-utils'\n import { APIError } from 'common/api/utils'\n import { broadcastUpdatedContract } from 'shared/websockets/helpers'\n-import { updateData, DataUpdate } from './utils'\n-import { mapValues, uniq } from 'lodash'\n+import { updateData, DataUpdate, update } from './utils'\n+import { camelCase, mapValues, uniq } from 'lodash'\n import { contractColumnsToSelect, log } from 'shared/utils'\n-\n+import { Tables } from 'common/supabase/utils'\n // used for API to allow slug as param\n export const getContractIdFromSlug = async (\n   pg: SupabaseDirectClient,\n   slug?: string\n@@ -191,10 +191,14 @@\n \n export const updateContract = async (\n   pg: SupabaseDirectClient,\n   contractId: string,\n+  // TODO: can't figure out how to exclude native columns from DataUpdate\n   update: DataUpdate<'contracts'>\n ) => {\n+  if (Object.keys(update).some((k) => nativeContractColumnsArray.includes(k))) {\n+    throw new APIError(500, 'Cannot update native columns via data update')\n+  }\n   const fullUpdate = { ...update, id: contractId }\n   const newContract = convertContract(\n     await updateData(pg, 'contracts', 'id', fullUpdate)\n   )\n@@ -205,4 +209,21 @@\n   ) as any\n   broadcastUpdatedContract(newContract.visibility, updatedValues)\n   return newContract\n }\n+\n+export const updateContractNativeColumns = async (\n+  pg: SupabaseDirectClient,\n+  contractId: string,\n+  updated: Tables['contracts']['Update']\n+) => {\n+  const fullUpdate = { ...updated, id: contractId }\n+  const newContract = convertContract(\n+    await update(pg, 'contracts', 'id', fullUpdate)\n+  )\n+  log('updated contract native columns', updated)\n+  const updatedValues = Object.fromEntries(\n+    Object.entries(fullUpdate).map(([k, v]) => [camelCase(k), v])\n+  ) as Partial<Contract> & { id: string }\n+  broadcastUpdatedContract(newContract.visibility, updatedValues)\n+  return newContract\n+}\n"
        },
        {
          "path": "backend/shared/src/utils.ts",
          "status": "modified",
          "diff": "Index: backend/shared/src/utils.ts\n===================================================================\n--- backend/shared/src/utils.ts\t3db5061 (parent)\n+++ backend/shared/src/utils.ts\tcd6dd8c (commit)\n@@ -1,7 +1,12 @@\n import { generateJSON } from '@tiptap/html'\n import { APIError, getCloudRunServiceUrl } from 'common/api/utils'\n-import { Contract, contractPath, MarketContract } from 'common/contract'\n+import {\n+  Contract,\n+  nativeContractColumnsArray,\n+  contractPath,\n+  MarketContract,\n+} from 'common/contract'\n import { PrivateUser } from 'common/user'\n import { extensions } from 'common/util/parse'\n import * as admin from 'firebase-admin'\n import { first, uniq } from 'lodash'\n@@ -111,11 +116,11 @@\n   } else {\n     return admin.app().options.projectId === 'mantic-markets'\n   }\n }\n-export const contractColumnsToSelect = `data,importance_score,freshness_score,conversion_score,view_count,token`\n-export const prefixedContractColumnsToSelect = contractColumnsToSelect\n-  .split(',')\n+\n+export const contractColumnsToSelect = nativeContractColumnsArray.join(',')\n+export const prefixedContractColumnsToSelect = nativeContractColumnsArray\n   .map((col) => `c.${col}`)\n   .join(',')\n \n export const getContract = async (\n"
        },
        {
          "path": "backend/supabase/contract_boosts.sql",
          "status": "added",
          "diff": "Index: backend/supabase/contract_boosts.sql\n===================================================================\n--- backend/supabase/contract_boosts.sql\t3db5061 (parent)\n+++ backend/supabase/contract_boosts.sql\tcd6dd8c (commit)\n@@ -0,0 +1,16 @@\n+create table if not exists\n+  contract_boosts (\n+    id bigint generated always as identity primary key,\n+    contract_id text not null references contracts (id),\n+    user_id text not null references users (id),\n+    start_time timestamptz not null,\n+    end_time timestamptz not null\n+  );\n+\n+-- Indexes\n+create index if not exists contract_boosts_contract_id_idx on contract_boosts (contract_id, start_time, end_time);\n+\n+create index if not exists contract_boosts_user_id_idx on contract_boosts (user_id);\n+\n+-- Row Level Security\n+alter table contract_boosts enable row level security;\n"
        },
        {
          "path": "backend/supabase/contracts.sql",
          "status": "modified",
          "diff": "Index: backend/supabase/contracts.sql\n===================================================================\n--- backend/supabase/contracts.sql\t3db5061 (parent)\n+++ backend/supabase/contracts.sql\tcd6dd8c (commit)\n@@ -48,9 +48,10 @@\n       )\n     ),\n     unique_bettor_count bigint default 0 not null,\n     view_count bigint default 0 not null,\n-    visibility text\n+    visibility text,\n+    boosted boolean default false not null\n   );\n \n -- Triggers\n create trigger contract_populate before insert\n@@ -90,9 +91,8 @@\n     end;\n   new.resolution_probability := ((new.data) ->> 'resolutionProbability')::numeric;\n   new.resolution := (new.data) ->> 'resolution';\n   new.is_spice_payout := coalesce(((new.data) ->> 'isSpicePayout')::boolean, false);\n-  new.popularity_score := coalesce(((new.data) ->> 'popularityScore')::numeric, 0);\n   new.deleted := coalesce(((new.data) ->> 'deleted')::boolean, false);\n   new.group_slugs := case\n       when new.data ? 'groupSlugs' then jsonb_array_to_text_array((new.data) -> 'groupSlugs')\n       else null\n"
        },
        {
          "path": "common/src/api/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/api/schema.ts\n===================================================================\n--- common/src/api/schema.ts\t3db5061 (parent)\n+++ common/src/api/schema.ts\tcd6dd8c (commit)\n@@ -2159,8 +2159,20 @@\n     authed: false,\n     props: z.object({ contractId: z.string(), optionId: z.string() }),\n     returns: [] as DisplayUser[],\n   },\n+  'purchase-contract-boost': {\n+    method: 'POST',\n+    visibility: 'public',\n+    authed: true,\n+    props: z\n+      .object({\n+        contractId: z.string(),\n+        startTime: z.number().positive().finite().safe(),\n+      })\n+      .strict(),\n+    returns: {} as { success: boolean },\n+  },\n } as const)\n \n export type APIPath = keyof typeof API\n export type APISchema<N extends APIPath> = (typeof API)[N]\n"
        },
        {
          "path": "common/src/contract.ts",
          "status": "modified",
          "diff": "Index: common/src/contract.ts\n===================================================================\n--- common/src/contract.ts\t3db5061 (parent)\n+++ common/src/contract.ts\tcd6dd8c (commit)\n@@ -96,8 +96,9 @@\n \n   token: ContractToken\n   siblingContractId?: string\n \n+  /** @deprecated - no longer used */\n   takerAPIOrdersDisabled?: boolean\n \n   // Manifold.love\n   loverUserId1?: string // The user id's of the pair of lovers referenced in the question.\n@@ -120,8 +121,10 @@\n   /** @deprecated - not deprecated, only updated in native column though*/\n   conversionScore: number\n   /** @deprecated - not deprecated, only updated in native column though*/\n   viewCount: number\n+  /** @deprecated - not deprecated, only updated in native column though*/\n+  boosted: boolean\n   /** @deprecated - not up-to-date */\n   likedByUserCount?: number\n } & T\n \n@@ -536,4 +539,16 @@\n   reasoning?: string\n   addAnswersMode?: add_answers_mode\n   promptVersion: number\n }\n+\n+export const nativeContractColumnsArray = [\n+  'data',\n+  'importance_score',\n+  'freshness_score',\n+  'conversion_score',\n+  'view_count',\n+  'token',\n+  'boosted',\n+  'daily_score',\n+  'popularity_score',\n+]\n"
        },
        {
          "path": "common/src/economy.ts",
          "status": "modified",
          "diff": "Index: common/src/economy.ts\n===================================================================\n--- common/src/economy.ts\t3db5061 (parent)\n+++ common/src/economy.ts\tcd6dd8c (commit)\n@@ -153,4 +153,5 @@\n \n export const SWEEPS_MIN_BET = 1\n export const MANA_MIN_BET = 1\n export const PROFIT_FEE_FRACTION = 0.1\n+export const BOOST_COST_MANA = 10000\n"
        },
        {
          "path": "common/src/new-contract.ts",
          "status": "modified",
          "diff": "Index: common/src/new-contract.ts\n===================================================================\n--- common/src/new-contract.ts\t3db5061 (parent)\n+++ common/src/new-contract.ts\tcd6dd8c (commit)\n@@ -169,8 +169,9 @@\n     sportsLeague,\n \n     takerAPIOrdersDisabled,\n     siblingContractId,\n+    boosted: false,\n   })\n   if (visibility === 'unlisted') {\n     contract.unlistedById = creator.id\n   }\n"
        },
        {
          "path": "common/src/supabase/contracts.ts",
          "status": "modified",
          "diff": "Index: common/src/supabase/contracts.ts\n===================================================================\n--- common/src/supabase/contracts.ts\t3db5061 (parent)\n+++ common/src/supabase/contracts.ts\tcd6dd8c (commit)\n@@ -135,8 +135,9 @@\n   view_count?: number | null\n   conversion_score?: number | null\n   freshness_score?: number | null\n   daily_score?: number | null\n+  boosted?: boolean | null\n   token?: string\n }) =>\n   removeUndefinedProps({\n     ...(c.data as T),\n@@ -146,8 +147,9 @@\n     freshnessScore: c.freshness_score,\n     viewCount: Number(c.view_count),\n     dailyScore: c.daily_score,\n     token: c.token,\n+    boosted: c.boosted ?? false,\n   } as T)\n \n export const followContract = async (\n   db: SupabaseClient,\n"
        },
        {
          "path": "common/src/supabase/schema.ts",
          "status": "modified",
          "diff": "Index: common/src/supabase/schema.ts\n===================================================================\n--- common/src/supabase/schema.ts\t3db5061 (parent)\n+++ common/src/supabase/schema.ts\tcd6dd8c (commit)\n@@ -263,8 +263,54 @@\n           user_id?: string\n         }\n         Relationships: []\n       }\n+      contract_boosts: {\n+        Row: {\n+          contract_id: string\n+          end_time: string\n+          id: number\n+          start_time: string\n+          user_id: string\n+        }\n+        Insert: {\n+          contract_id: string\n+          end_time: string\n+          id?: never\n+          start_time: string\n+          user_id: string\n+        }\n+        Update: {\n+          contract_id?: string\n+          end_time?: string\n+          id?: never\n+          start_time?: string\n+          user_id?: string\n+        }\n+        Relationships: [\n+          {\n+            foreignKeyName: 'contract_boosts_contract_id_fkey'\n+            columns: ['contract_id']\n+            isOneToOne: false\n+            referencedRelation: 'contracts'\n+            referencedColumns: ['id']\n+          },\n+          {\n+            foreignKeyName: 'contract_boosts_user_id_fkey'\n+            columns: ['user_id']\n+            isOneToOne: false\n+            referencedRelation: 'user_referrals_profit'\n+            referencedColumns: ['id']\n+          },\n+          {\n+            foreignKeyName: 'contract_boosts_user_id_fkey'\n+            columns: ['user_id']\n+            isOneToOne: false\n+            referencedRelation: 'users'\n+            referencedColumns: ['id']\n+          }\n+        ]\n+      }\n       contract_comment_edits: {\n         Row: {\n           comment_id: string\n           contract_id: string\n@@ -443,8 +489,9 @@\n           token: string\n           unique_bettor_count: number\n           view_count: number\n           visibility: string | null\n+          boosted: boolean | null\n         }\n         Insert: {\n           close_time?: string | null\n           conversion_score?: number\n@@ -476,8 +523,9 @@\n           token?: string\n           unique_bettor_count?: number\n           view_count?: number\n           visibility?: string | null\n+          boosted?: boolean | null\n         }\n         Update: {\n           close_time?: string | null\n           conversion_score?: number\n@@ -509,8 +557,9 @@\n           token?: string\n           unique_bettor_count?: number\n           view_count?: number\n           visibility?: string | null\n+          boosted?: boolean | null\n         }\n         Relationships: []\n       }\n       creator_portfolio_history: {\n"
        },
        {
          "path": "common/src/txn.ts",
          "status": "modified",
          "diff": "Index: common/src/txn.ts\n===================================================================\n--- common/src/txn.ts\t3db5061 (parent)\n+++ common/src/txn.ts\tcd6dd8c (commit)\n@@ -59,8 +59,9 @@\n   | CashOutPending\n   | KycBonus\n   | ProfitFee\n   | UndoResolutionFee\n+  | ContractBoostPurchase\n \n export type AnyTxnCategory = AnyTxnType['category']\n \n export type SourceType = 'USER' | 'CONTRACT' | 'CHARITY' | 'BANK' | 'AD'\n@@ -588,8 +589,19 @@\n     updateType: string\n   }\n }\n \n+type ContractBoostPurchase = {\n+  category: 'CONTRACT_BOOST_PURCHASE'\n+  fromType: 'USER'\n+  toType: 'BANK'\n+  token: 'M$'\n+  data: {\n+    contractId: string\n+    boostId: string\n+  }\n+}\n+\n export type AddSubsidyTxn = Txn & AddSubsidy\n export type RemoveSubsidyTxn = Txn & RemoveSubsidy\n export type DonationTxn = Txn & Donation\n export type TipTxn = Txn & Tip\n@@ -643,4 +655,5 @@\n export type CashOutPendingTxn = Txn & CashOutPending\n export type ProfitFeeTxn = Txn & ProfitFee\n export type UndoResolutionFeeTxn = Txn & UndoResolutionFee\n export type AdminRewardTxn = Txn & AdminReward\n+export type ContractBoostPurchaseTxn = Txn & ContractBoostPurchase\n"
        },
        {
          "path": "web/components/contract/add-boost-button.tsx",
          "status": "added",
          "diff": "Index: web/components/contract/add-boost-button.tsx\n===================================================================\n--- web/components/contract/add-boost-button.tsx\t3db5061 (parent)\n+++ web/components/contract/add-boost-button.tsx\tcd6dd8c (commit)\n@@ -0,0 +1,157 @@\n+import { useState } from 'react'\n+import { Button } from '../buttons/button'\n+import { Modal } from '../layout/modal'\n+import { Col } from '../layout/col'\n+import { Row } from '../layout/row'\n+import { Contract } from 'common/contract'\n+import { useUser } from 'web/hooks/use-user'\n+import { api } from 'web/lib/api/api'\n+import { TokenNumber } from '../widgets/token-number'\n+import { AddFundsModal } from '../add-funds-modal'\n+import toast from 'react-hot-toast'\n+import { BsRocketTakeoff } from 'react-icons/bs'\n+import { BOOST_COST_MANA } from 'common/economy'\n+import dayjs from 'dayjs'\n+import { Input } from '../widgets/input'\n+import { HOUR_MS } from 'common/util/time'\n+\n+export function AddBoostButton(props: {\n+  contract: Contract\n+  className?: string\n+}) {\n+  const { contract, className } = props\n+  const [open, setOpen] = useState(false)\n+  const user = useUser()\n+\n+  if (!user) return null\n+\n+  const disabled =\n+    contract.isResolved ||\n+    (contract.closeTime ?? Infinity) < Date.now() ||\n+    contract.visibility !== 'public'\n+\n+  if (disabled) return null\n+\n+  return (\n+    <>\n+      <Button\n+        onClick={() => setOpen(true)}\n+        color=\"gradient-pink\"\n+        size=\"sm\"\n+        className={className}\n+        data-boost-button\n+        disabled={contract.boosted}\n+      >\n+        <BsRocketTakeoff className=\"mr-1 h-5 w-5\" />\n+        {contract.boosted ? 'Market boosted' : 'Boost market'}\n+      </Button>\n+\n+      <BoostPurchaseModal open={open} setOpen={setOpen} contract={contract} />\n+    </>\n+  )\n+}\n+\n+function BoostPurchaseModal(props: {\n+  open: boolean\n+  setOpen: (open: boolean) => void\n+  contract: Contract\n+}) {\n+  const { open, setOpen, contract } = props\n+  const [loading, setLoading] = useState(false)\n+  const [fundsModalOpen, setFundsModalOpen] = useState(false)\n+  const now = Date.now()\n+  const [startTime, setStartTime] = useState(now)\n+  const user = useUser()\n+\n+  if (!user) return null\n+\n+  const notEnoughFunds = (user.balance ?? 0) < BOOST_COST_MANA\n+\n+  const purchaseBoost = async () => {\n+    setLoading(true)\n+    try {\n+      await api('purchase-contract-boost', {\n+        contractId: contract.id,\n+        startTime,\n+      })\n+      toast.success(\n+        'Market boosted! It will be featured on the homepage for 24 hours.'\n+      )\n+      setOpen(false)\n+    } catch (e) {\n+      console.error(e)\n+      toast.error(e instanceof Error ? e.message : 'Error purchasing boost')\n+    }\n+    setLoading(false)\n+  }\n+\n+  return (\n+    <>\n+      <Modal open={open} setOpen={setOpen} size=\"sm\">\n+        <Col className=\"bg-canvas-0 gap-4 rounded-lg p-6\">\n+          <Row className=\"items-center gap-2 text-xl font-semibold\">\n+            <BsRocketTakeoff className=\"h-6 w-6\" />\n+            Boost this market\n+          </Row>\n+\n+          <div className=\"text-ink-600\">\n+            Boost this market's visibility on the homepage{' '}\n+            {Math.abs(startTime - now) < HOUR_MS\n+              ? 'for the next 24 hours'\n+              : `from ${dayjs(startTime).format('MMM D')} to ${dayjs(startTime)\n+                  .add(24, 'hours')\n+                  .format('MMM D')}`}\n+          </div>\n+\n+          <Row className=\"items-center gap-2\">\n+            <Button\n+              color=\"indigo\"\n+              onClick={purchaseBoost}\n+              loading={loading}\n+              disabled={notEnoughFunds}\n+              className=\"w-full\"\n+            >\n+              Purchase boost for{' '}\n+              <TokenNumber className=\"mx-1\" amount={BOOST_COST_MANA} />\n+            </Button>\n+          </Row>\n+          <Row className=\"items-center gap-2\">\n+            <div className=\"text-ink-600\">Start time:</div>\n+            <Input\n+              type={'date'}\n+              className=\"dark:date-range-input-white\"\n+              onClick={(e) => e.stopPropagation()}\n+              onChange={(e) => {\n+                const start = dayjs(e.target.value).startOf('day').valueOf()\n+                if (start < Date.now()) {\n+                  setStartTime(Date.now())\n+                } else {\n+                  setStartTime(start)\n+                }\n+              }}\n+              min={dayjs().format('YYYY-MM-DD')}\n+              max=\"3000-12-31\"\n+              disabled={loading}\n+              value={dayjs(startTime).format('YYYY-MM-DD')}\n+            />\n+          </Row>\n+\n+          {notEnoughFunds && (\n+            <div className=\"text-ink-600 flex items-center gap-2 text-sm\">\n+              <span className=\"text-error\">Insufficient balance</span>\n+              <Button\n+                size=\"xs\"\n+                color=\"gradient-pink\"\n+                onClick={() => setFundsModalOpen(true)}\n+              >\n+                Get mana\n+              </Button>\n+            </div>\n+          )}\n+        </Col>\n+      </Modal>\n+\n+      <AddFundsModal open={fundsModalOpen} setOpen={setFundsModalOpen} />\n+    </>\n+  )\n+}\n"
        },
        {
          "path": "web/components/contract/boost-column.tsx",
          "status": "added",
          "diff": "Index: web/components/contract/boost-column.tsx\n===================================================================\n--- web/components/contract/boost-column.tsx\t3db5061 (parent)\n+++ web/components/contract/boost-column.tsx\tcd6dd8c (commit)\n@@ -0,0 +1,24 @@\n+import { Tooltip } from '../widgets/tooltip'\n+import clsx from 'clsx'\n+import { PlusTier } from 'web/public/custom-components/tiers'\n+import { Placement } from '@floating-ui/react'\n+export function BoostedTooltip(props: {\n+  boosted: boolean\n+  placement?: Placement\n+  className?: string\n+  iconClassName?: string\n+}) {\n+  const { boosted, placement = 'top', className, iconClassName } = props\n+\n+  return (\n+    <Tooltip\n+      text={boosted ? `Boosted market` : ''}\n+      placement={placement}\n+      noTap\n+      className={clsx('flex flex-row items-center gap-0.5', className)}\n+      tooltipClassName=\"z-40\"\n+    >\n+      {boosted ? <PlusTier className={iconClassName} /> : null}\n+    </Tooltip>\n+  )\n+}\n"
        },
        {
          "path": "web/components/contract/contract-page.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-page.tsx\n===================================================================\n--- web/components/contract/contract-page.tsx\t3db5061 (parent)\n+++ web/components/contract/contract-page.tsx\tcd6dd8c (commit)\n@@ -32,9 +32,8 @@\n import {\n   ContractOverview,\n   getShouldHideGraph,\n } from 'web/components/contract/contract-overview'\n-import ContractSharePanel from 'web/components/contract/contract-share-panel'\n import { ContractTabs } from 'web/components/contract/contract-tabs'\n import { VisibilityIcon } from 'web/components/contract/contracts-table'\n import { DangerZone } from 'web/components/contract/danger-zone'\n import { EditableQuestionTitle } from 'web/components/contract/editable-question-title'\n@@ -76,8 +75,9 @@\n import { useRouter } from 'next/router'\n import { precacheAnswers } from 'web/hooks/use-answers'\n import { useIsPageVisible } from 'web/hooks/use-page-visible'\n import { api } from 'web/lib/api/api'\n+import ContractSharePanel from './contract-share-panel'\n \n export function ContractPageContent(props: ContractParams) {\n   const {\n     comments,\n@@ -416,8 +416,9 @@\n                 chartAnnotations={chartAnnotations}\n                 hideGraph={hideGraph}\n                 setHideGraph={setHideGraph}\n               />\n+\n               {!tradingAllowed(liveContract) && (\n                 <UserBetsSummary\n                   className=\"border-ink-200 !mb-2 \"\n                   contract={liveContract}\n@@ -473,14 +474,30 @@\n               setShowReview={setShowReview}\n               userHasBet={!!myContractMetrics}\n               hasReviewed={!!userHasReviewed}\n             />\n+            {!!user && isCreator && (\n+              <ContractSharePanel\n+                isClosed={isClosed}\n+                isCreator={isCreator}\n+                showResolver={showResolver}\n+                contract={liveContract}\n+              />\n+            )}\n             <ContractDescription\n               contractId={props.contract.id}\n               creatorId={props.contract.creatorId}\n               isSweeps={isCashContract}\n               description={description}\n             />\n+            {!!user && !isCreator && (\n+              <ContractSharePanel\n+                isClosed={isClosed}\n+                isCreator={isCreator}\n+                showResolver={showResolver}\n+                contract={liveContract}\n+              />\n+            )}\n             <Row className=\"items-center gap-2\">\n               <MarketTopics\n                 contract={props.contract}\n                 dashboards={dashboards}\n@@ -490,17 +507,8 @@\n             </Row>\n \n             <Row className=\"my-2 flex-wrap items-center justify-between gap-y-2\"></Row>\n             {!user && <SidebarSignUpButton className=\"mb-4 flex md:hidden\" />}\n-            {!!user && (\n-              <ContractSharePanel\n-                isClosed={isClosed}\n-                isCreator={isCreator}\n-                showResolver={showResolver}\n-                // TODO: upgrade tier\n-                contract={liveContract}\n-              />\n-            )}\n \n             {isResolved && resolution !== 'CANCEL' && (\n               <>\n                 <ContractLeaderboard\n"
        },
        {
          "path": "web/components/contract/contract-summary-stats.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-summary-stats.tsx\n===================================================================\n--- web/components/contract/contract-summary-stats.tsx\t3db5061 (parent)\n+++ web/components/contract/contract-summary-stats.tsx\tcd6dd8c (commit)\n@@ -3,9 +3,9 @@\n import { formatWithToken, shortFormatNumber } from 'common/util/format'\n import { Row } from 'web/components/layout/row'\n import { isBlocked, usePrivateUser, useUser } from 'web/hooks/use-user'\n import { MoneyDisplay } from '../bet/money-display'\n-import { TierTooltip } from '../tiers/tier-tooltip'\n+import { LiquidityTooltip } from '../tiers/liquidity-tooltip'\n import { Tooltip } from '../widgets/tooltip'\n import { BountyLeft } from './bountied-question'\n import { CloseOrResolveTime } from './contract-details'\n import { ReactButton } from './react-button'\n@@ -25,9 +25,9 @@\n     financeContract: contract,\n     editable,\n     isCashContract,\n   } = props\n-  const { outcomeType, marketTier } = contract\n+  const { outcomeType } = contract\n   const privateUser = usePrivateUser()\n   const user = useUser()\n \n   return (\n@@ -39,9 +39,8 @@\n           inEmbed={true}\n         />\n       ) : (\n         <Row className=\"ml-auto gap-4\">\n-          {marketTier && <TierTooltip tier={marketTier} contract={contract} />}\n           {!isBlocked(privateUser, contract.creatorId) && (\n             <ReactButton\n               user={user}\n               size={'2xs'}\n@@ -61,9 +60,9 @@\n           >\n             <UserIcon className=\"text-ink-500 h-4 w-4\" />\n             <div>{shortFormatNumber(contract.uniqueBettorCount ?? 0)}</div>\n           </Tooltip>\n-\n+          <LiquidityTooltip contract={contract} iconClassName=\"text-ink-500\" />\n           {!!contract.volume && (\n             <Tooltip\n               text={`Trading volume: ${formatWithToken({\n                 amount: contract.volume,\n"
        },
        {
          "path": "web/components/contract/contract-table-col-formats.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contract-table-col-formats.tsx\n===================================================================\n--- web/components/contract/contract-table-col-formats.tsx\t3db5061 (parent)\n+++ web/components/contract/contract-table-col-formats.tsx\tcd6dd8c (commit)\n@@ -2,13 +2,13 @@\n import { Contract } from 'common/contract'\n import { useNumContractComments } from 'web/hooks/use-comments'\n import { shortenNumber } from 'common/util/formatNumber'\n import { Row } from '../layout/row'\n-import { TierTooltip } from '../tiers/tier-tooltip'\n import { Action } from './contract-table-action'\n import { ContractStatusLabel } from './contracts-table'\n import { useHasContractMetrics } from 'web/hooks/use-saved-contract-metrics'\n import { Tooltip } from '../widgets/tooltip'\n+import { BoostedTooltip } from './boost-column'\n \n export type ColumnFormat = {\n   header: string\n   content: (props: { contract: Contract }) => JSX.Element\n@@ -68,19 +68,36 @@\n   },\n   width: 'w-[80px]',\n }\n \n-export const tierColumn = {\n-  header: 'Tier',\n+// export const tierColumn = {\n+//   header: 'Tier',\n+//   content: (props: { contract: Contract }) => {\n+//     const { contract } = props\n+//     const marketTier = contract.marketTier\n+//     return (\n+//       <TierTooltip\n+//         placement={'top'}\n+//         tier={marketTier!}\n+//         contract={contract}\n+//         noTitle\n+//         className=\"relative mr-0.5 inline-flex h-[1em] w-[1.1em] items-baseline\"\n+//         iconClassName=\"absolute inset-0 top-[0.2em]\"\n+//       />\n+//     )\n+//   },\n+//   width: 'w-8',\n+// }\n+\n+export const boostedColumn = {\n+  header: 'Boosted',\n   content: (props: { contract: Contract }) => {\n     const { contract } = props\n-    const marketTier = contract.marketTier\n     return (\n-      <TierTooltip\n+      <BoostedTooltip\n+        boosted={contract.boosted}\n         placement={'top'}\n-        tier={marketTier!}\n-        contract={contract}\n-        noTitle\n+        // noTitle\n         className=\"relative mr-0.5 inline-flex h-[1em] w-[1.1em] items-baseline\"\n         iconClassName=\"absolute inset-0 top-[0.2em]\"\n       />\n     )\n"
        },
        {
          "path": "web/components/contract/contracts-table.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/contracts-table.tsx\n===================================================================\n--- web/components/contract/contracts-table.tsx\t3db5061 (parent)\n+++ web/components/contract/contracts-table.tsx\tcd6dd8c (commit)\n@@ -22,9 +22,9 @@\n   actionColumn,\n   probColumn,\n   traderColumn,\n   ColumnFormat,\n-  tierColumn,\n+  boostedColumn,\n } from './contract-table-col-formats'\n import { UserHovercard } from '../user/user-hovercard'\n import { getFormattedExpectedValue } from 'common/multi-numeric'\n import { removeEmojis } from 'common/util/string'\n@@ -43,9 +43,9 @@\n   const {\n     contracts,\n     onContractClick,\n     highlightContractIds,\n-    columns = [traderColumn, tierColumn, probColumn, actionColumn],\n+    columns = [boostedColumn, traderColumn, probColumn, actionColumn],\n     hideAvatar,\n   } = props\n \n   const user = useUser()\n"
        },
        {
          "path": "web/components/contract/creator-share-panel.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/creator-share-panel.tsx\n===================================================================\n--- web/components/contract/creator-share-panel.tsx\t3db5061 (parent)\n+++ web/components/contract/creator-share-panel.tsx\tcd6dd8c (commit)\n@@ -10,12 +10,12 @@\n import { TweetButton } from '../buttons/tweet-button'\n import { Row } from '../layout/row'\n import { GradientContainer } from '../widgets/gradient-container'\n import { AddBountyButton, CancelBountyButton } from './bountied-question'\n-import { UpgradeTierButton } from './upgrade-tier-button'\n import { useNativeInfo } from 'web/components/native-message-provider'\n import { formatMoney } from 'common/util/format'\n import { UNIQUE_BETTOR_BONUS_AMOUNT } from 'common/economy'\n+import { AddBoostButton } from './add-boost-button'\n \n export function CreatorSharePanel(props: { contract: Contract }) {\n   const { contract } = props\n   return (\n@@ -23,12 +23,9 @@\n       <div className=\"mb-2 flex flex-wrap gap-2\">\n         {contract.outcomeType == 'BOUNTIED_QUESTION' && (\n           <AddBountyButton contract={contract} />\n         )}\n-        {(contract.mechanism == 'cpmm-1' ||\n-          contract.mechanism == 'cpmm-multi-1') && (\n-          <UpgradeTierButton contract={contract} />\n-        )}\n+        <AddBoostButton contract={contract} />\n         <ShareLinkButton contract={contract} />\n         <TweetButton\n           tweetText={'I created a question. ' + getShareUrl(contract)}\n           className=\"hidden sm:flex\"\n@@ -40,9 +37,9 @@\n \n       {contract.outcomeType !== 'POLL' &&\n         contract.outcomeType !== 'BOUNTIED_QUESTION' && (\n           <div className=\"text-ink-500 text-base\">\n-            Earn {formatMoney(UNIQUE_BETTOR_BONUS_AMOUNT)} for each trader.\n+            Earn {formatMoney(UNIQUE_BETTOR_BONUS_AMOUNT)} for each new trader.\n           </div>\n         )}\n     </GradientContainer>\n   )\n@@ -55,8 +52,9 @@\n     <Row className=\"my-4 flex-wrap gap-4\">\n       {contract.outcomeType == 'BOUNTIED_QUESTION' && (\n         <AddBountyButton contract={contract} />\n       )}\n+      <AddBoostButton contract={contract} />\n       <ShareLinkButton contract={contract} />\n       <TweetButton\n         tweetText={getShareUrl(contract)}\n         className=\"hidden sm:flex\"\n"
        },
        {
          "path": "web/components/contract/feed-contract-card.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/feed-contract-card.tsx\n===================================================================\n--- web/components/contract/feed-contract-card.tsx\t3db5061 (parent)\n+++ web/components/contract/feed-contract-card.tsx\tcd6dd8c (commit)\n@@ -39,9 +39,9 @@\n import FeedContractCardDescription from '../feed/feed-contract-card-description'\n import { Col } from '../layout/col'\n import { Row } from '../layout/row'\n import { PollPanel } from '../poll/poll-panel'\n-import { TierTooltip } from '../tiers/tier-tooltip'\n+import { LiquidityTooltip } from '../tiers/liquidity-tooltip'\n import { UserHovercard } from '../user/user-hovercard'\n import { ClickFrame } from '../widgets/click-frame'\n import { ReactButton } from './react-button'\n import { TradesButton } from './trades-button'\n@@ -89,9 +89,8 @@\n     creatorUsername,\n     creatorAvatarUrl,\n     outcomeType,\n     mechanism,\n-    marketTier,\n   } = contract\n \n   const isBinaryMc = isBinaryMulti(contract)\n   const isBinaryCpmm = outcomeType === 'BINARY' && mechanism === 'cpmm-1'\n@@ -211,18 +210,16 @@\n               >\n                 <SweepiesCoin className=\"-mt-0.5\" /> {capitalize(SWEEPIES_NAME)}{' '}\n               </span>\n             )}\n-            {marketTier ? (\n-              <TierTooltip tier={marketTier} contract={contract} />\n-            ) : feedReason ? (\n+            {feedReason ? (\n               <CardReason\n                 reason={feedReason as any}\n                 probChange={probChange}\n                 since={startTime}\n               />\n             ) : (\n-              <></>\n+              <LiquidityTooltip contract={contract} />\n             )}\n             {hide && (\n               <FeedDropdown\n                 contract={contract}\n"
        },
        {
          "path": "web/components/contract/upgrade-tier-button.tsx",
          "status": "modified",
          "diff": "Index: web/components/contract/upgrade-tier-button.tsx\n===================================================================\n--- web/components/contract/upgrade-tier-button.tsx\t3db5061 (parent)\n+++ web/components/contract/upgrade-tier-button.tsx\tcd6dd8c (commit)\n@@ -14,9 +14,9 @@\n import { Title } from '../widgets/title'\n import { AddLiquidityControl } from './liquidity-modal'\n import { getAnte } from 'common/economy'\n import { TokenNumber } from '../widgets/token-number'\n-import { TierIcon, getPresentedTierName } from '../tiers/tier-tooltip'\n+import { TierIcon, getPresentedTierName } from '../tiers/liquidity-tooltip'\n import { api } from 'web/lib/api/api'\n import { useUser } from 'web/hooks/use-user'\n import { ENV_CONFIG } from 'common/envs/constants'\n import { AddFundsModal } from '../add-funds-modal'\n"
        },
        {
          "path": "web/components/new-contract/cost-section.tsx",
          "status": "modified",
          "diff": "Index: web/components/new-contract/cost-section.tsx\n===================================================================\n--- web/components/new-contract/cost-section.tsx\t3db5061 (parent)\n+++ web/components/new-contract/cost-section.tsx\tcd6dd8c (commit)\n@@ -16,9 +16,9 @@\n   PremiumTier,\n } from 'web/public/custom-components/tiers'\n import { TokenNumber } from '../widgets/token-number'\n import { getTieredCost, MarketTierType } from 'common/tier'\n-import { getPresentedTierName } from '../tiers/tier-tooltip'\n+import { getPresentedTierName } from '../tiers/liquidity-tooltip'\n import { ManaCoin } from 'web/public/custom-components/manaCoin'\n import { getContractTypeFromValue } from './create-contract-types'\n import { InfoTooltip } from '../widgets/info-tooltip'\n import { capitalize } from 'lodash'\n"
        },
        {
          "path": "web/components/search.tsx",
          "status": "modified",
          "diff": "Index: web/components/search.tsx\n===================================================================\n--- web/components/search.tsx\t3db5061 (parent)\n+++ web/components/search.tsx\tcd6dd8c (commit)\n@@ -20,8 +20,9 @@\n import { api, searchGroups } from 'web/lib/api/api'\n import { searchUsers } from 'web/lib/supabase/users'\n import {\n   actionColumn,\n+  boostedColumn,\n   probColumn,\n   traderColumn,\n } from './contract/contract-table-col-formats'\n import { ContractsTable, LoadingContractRow } from './contract/contracts-table'\n@@ -483,9 +484,9 @@\n             contracts={contracts}\n             onContractClick={onContractClick}\n             highlightContractIds={highlightContractIds}\n             columns={buildArray([\n-              // tierColumn,\n+              boostedColumn,\n               traderColumn,\n               probColumn,\n               !hideActions && actionColumn,\n             ])}\n"
        },
        {
          "path": "web/components/tiers/liquidity-tooltip.tsx",
          "status": "renamed",
          "oldPath": "web/components/tiers/tier-tooltip.tsx",
          "diff": "===================================================================\n--- web/components/tiers/tier-tooltip.tsx\t3db5061 (parent)\n+++ web/components/tiers/liquidity-tooltip.tsx\tcd6dd8c (commit)\n@@ -1,67 +1,45 @@\n import { Placement } from '@floating-ui/react'\n import clsx from 'clsx'\n import { Contract } from 'common/contract'\n import { MarketTierType } from 'common/tier'\n-import { formatWithToken } from 'common/util/format'\n+import { formatWithToken, shortFormatNumber } from 'common/util/format'\n import { capitalize } from 'lodash'\n import {\n   CrystalTier,\n   PlayTier,\n   PlusTier,\n   PremiumTier,\n } from 'web/public/custom-components/tiers'\n import { Tooltip } from '../widgets/tooltip'\n+import { GiWaterDrop } from 'react-icons/gi'\n \n-export function TierTooltip(props: {\n-  tier: MarketTierType\n+export function LiquidityTooltip(props: {\n   contract: Contract\n   className?: string\n-  noTitle?: boolean\n   placement?: Placement\n   iconClassName?: string\n }) {\n-  const {\n-    tier,\n-    contract,\n-    className,\n-    noTitle,\n-    placement = 'bottom',\n-    iconClassName,\n-  } = props\n+  const { contract, className, placement = 'bottom', iconClassName } = props\n   const { mechanism } = contract\n \n   const isCashContract = contract.token === 'CASH'\n \n   if (mechanism !== 'cpmm-multi-1' && mechanism !== 'cpmm-1') return <></>\n-\n+  const amount = contract.totalLiquidity\n   return (\n     <Tooltip\n       text={`${formatWithToken({\n-        amount: contract.totalLiquidity,\n+        amount,\n         token: isCashContract ? 'CASH' : 'M$',\n       })} in liquidity subsidies`}\n       placement={placement}\n       noTap\n       className={clsx('flex flex-row items-center gap-0.5', className)}\n       tooltipClassName=\"z-40\"\n     >\n-      <TierIcon tier={tier} className={iconClassName} />\n-      {!noTitle && (\n-        <div\n-          className={clsx(\n-            tier == 'plus'\n-              ? 'font-semibold text-blue-600 dark:text-blue-500'\n-              : tier == 'premium'\n-              ? 'font-semibold text-purple-500 dark:text-purple-400'\n-              : tier == 'crystal'\n-              ? 'bg-gradient-to-r from-pink-700 to-pink-500 bg-clip-text font-semibold text-transparent dark:from-pink-400 dark:to-pink-300'\n-              : ''\n-          )}\n-        >\n-          {getPresentedTierName(tier)}\n-        </div>\n-      )}\n+      <GiWaterDrop className={iconClassName} />\n+      {shortFormatNumber(amount)}\n     </Tooltip>\n   )\n }\n \n"
        }
      ]
    }
  ]
}
